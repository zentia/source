\doxysection{observer\+\_\+proxy.\+h}
\hypertarget{observer__proxy_8h_source}{}\label{observer__proxy_8h_source}\index{external/taskflow/3rd-\/party/tbb/src/tbb/observer\_proxy.h@{external/taskflow/3rd-\/party/tbb/src/tbb/observer\_proxy.h}}
\mbox{\hyperlink{observer__proxy_8h}{浏览该文件的文档.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{/*}}
\DoxyCodeLine{00002\ \textcolor{comment}{\ \ \ \ Copyright\ (c)\ 2005-\/2020\ Intel\ Corporation}}
\DoxyCodeLine{00003\ \textcolor{comment}{}}
\DoxyCodeLine{00004\ \textcolor{comment}{\ \ \ \ Licensed\ under\ the\ Apache\ License,\ Version\ 2.0\ (the\ "{}License"{});}}
\DoxyCodeLine{00005\ \textcolor{comment}{\ \ \ \ you\ may\ not\ use\ this\ file\ except\ in\ compliance\ with\ the\ License.}}
\DoxyCodeLine{00006\ \textcolor{comment}{\ \ \ \ You\ may\ obtain\ a\ copy\ of\ the\ License\ at}}
\DoxyCodeLine{00007\ \textcolor{comment}{}}
\DoxyCodeLine{00008\ \textcolor{comment}{\ \ \ \ \ \ \ \ http://www.apache.org/licenses/LICENSE-\/2.0}}
\DoxyCodeLine{00009\ \textcolor{comment}{}}
\DoxyCodeLine{00010\ \textcolor{comment}{\ \ \ \ Unless\ required\ by\ applicable\ law\ or\ agreed\ to\ in\ writing,\ software}}
\DoxyCodeLine{00011\ \textcolor{comment}{\ \ \ \ distributed\ under\ the\ License\ is\ distributed\ on\ an\ "{}AS\ IS"{}\ BASIS,}}
\DoxyCodeLine{00012\ \textcolor{comment}{\ \ \ \ WITHOUT\ WARRANTIES\ OR\ CONDITIONS\ OF\ ANY\ KIND,\ either\ express\ or\ implied.}}
\DoxyCodeLine{00013\ \textcolor{comment}{\ \ \ \ See\ the\ License\ for\ the\ specific\ language\ governing\ permissions\ and}}
\DoxyCodeLine{00014\ \textcolor{comment}{\ \ \ \ limitations\ under\ the\ License.}}
\DoxyCodeLine{00015\ \textcolor{comment}{*/}}
\DoxyCodeLine{00016\ }
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#ifndef\ \_TBB\_observer\_proxy\_H}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#define\ \_TBB\_observer\_proxy\_H}}
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#if\ \_\_TBB\_SCHEDULER\_OBSERVER}}
\DoxyCodeLine{00021\ }
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{scheduler__common_8h}{scheduler\_common.h}}"{}}\ \textcolor{comment}{//\ to\ include\ task.h}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{task__scheduler__observer_8h}{tbb/task\_scheduler\_observer.h}}"{}}}
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{spin__rw__mutex_8h}{tbb/spin\_rw\_mutex.h}}"{}}}
\DoxyCodeLine{00025\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{aligned__space_8h}{tbb/aligned\_space.h}}"{}}}
\DoxyCodeLine{00026\ }
\DoxyCodeLine{00027\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespacetbb}{tbb}}\ \{}
\DoxyCodeLine{00028\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespacetbb_1_1internal}{internal}}\ \{}
\DoxyCodeLine{00029\ }
\DoxyCodeLine{00030\ \textcolor{keyword}{class\ }observer\_list\ \{}
\DoxyCodeLine{00031\ \ \ \ \ \textcolor{keyword}{friend}\ \textcolor{keyword}{class\ }arena;}
\DoxyCodeLine{00032\ }
\DoxyCodeLine{00033\ \ \ \ \ \textcolor{comment}{//\ Mutex\ is\ wrapped\ with\ aligned\_space\ to\ shut\ up\ warnings\ when\ its\ destructor}}
\DoxyCodeLine{00034\ \ \ \ \ \textcolor{comment}{//\ is\ called\ while\ threads\ are\ still\ using\ it.}}
\DoxyCodeLine{00035\ \ \ \ \ \textcolor{keyword}{typedef}\ aligned\_space<spin\_rw\_mutex>\ \ my\_mutex\_type;}
\DoxyCodeLine{00036\ }
\DoxyCodeLine{00038\ \ \ \ \ observer\_proxy*\ my\_head;}
\DoxyCodeLine{00039\ }
\DoxyCodeLine{00041\ \ \ \ \ observer\_proxy*\ my\_tail;}
\DoxyCodeLine{00042\ }
\DoxyCodeLine{00044\ \ \ \ \ my\_mutex\_type\ \mbox{\hyperlink{dining__philosophers_8cpp_a526734cdc85a5961b2721d20b0357d43}{my\_mutex}};}
\DoxyCodeLine{00045\ }
\DoxyCodeLine{00047\ \ \ \ \ arena*\ my\_arena;}
\DoxyCodeLine{00048\ }
\DoxyCodeLine{00050\ }
\DoxyCodeLine{00051\ \ \ \ \ \textcolor{keyword}{inline}\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ remove\_ref\_fast(\ observer\_proxy*\&\ \mbox{\hyperlink{main-override_8cpp_a117104b82864d3b23ec174af6d392709}{p}}\ );}
\DoxyCodeLine{00052\ }
\DoxyCodeLine{00054\ \ \ \ \ \textcolor{keywordtype}{void}\ do\_notify\_entry\_observers(\ observer\_proxy*\&\ last,\ \textcolor{keywordtype}{bool}\ worker\ );}
\DoxyCodeLine{00055\ }
\DoxyCodeLine{00057\ \ \ \ \ \textcolor{keywordtype}{void}\ do\_notify\_exit\_observers(\ observer\_proxy*\ last,\ \textcolor{keywordtype}{bool}\ worker\ );}
\DoxyCodeLine{00058\ }
\DoxyCodeLine{00059\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00060\ \ \ \ \ observer\_list\ ()\ :\ my\_head(\mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}}),\ my\_tail(\mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}})\ \{\}}
\DoxyCodeLine{00061\ }
\DoxyCodeLine{00063\ }
\DoxyCodeLine{00064\ \ \ \ \ \textcolor{keywordtype}{void}\ clear\ ();}
\DoxyCodeLine{00065\ }
\DoxyCodeLine{00067\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{_sparse_matrix__coeffs_8cpp_ab35a6a022462a2c6584f51173eb05af6}{insert}}\ (\ observer\_proxy*\ \mbox{\hyperlink{main-override_8cpp_a117104b82864d3b23ec174af6d392709}{p}}\ );}
\DoxyCodeLine{00068\ }
\DoxyCodeLine{00070\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{namespaceeastl_a1b3d2af5677205f2e7f9c0ddd434396a}{remove}}\ (\ observer\_proxy*\ \mbox{\hyperlink{main-override_8cpp_a117104b82864d3b23ec174af6d392709}{p}}\ );}
\DoxyCodeLine{00071\ }
\DoxyCodeLine{00073\ }
\DoxyCodeLine{00074\ \ \ \ \ \textcolor{keywordtype}{void}\ remove\_ref(\ observer\_proxy*\ \mbox{\hyperlink{main-override_8cpp_a117104b82864d3b23ec174af6d392709}{p}}\ );}
\DoxyCodeLine{00075\ }
\DoxyCodeLine{00077\ \ \ \ \ \textcolor{keyword}{typedef}\ spin\_rw\_mutex::scoped\_lock\ scoped\_lock;}
\DoxyCodeLine{00078\ }
\DoxyCodeLine{00080\ \ \ \ \ \mbox{\hyperlink{namespacetbb_a6cc3d02744cab8ac389919806d47e417}{spin\_rw\_mutex}}\&\ \mbox{\hyperlink{harness__graph_8h_a7066db3b13dac6171efe89e7c49eb0d0}{mutex}}\ ()\ \{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{dining__philosophers_8cpp_a526734cdc85a5961b2721d20b0357d43}{my\_mutex}}.begin()[0];\ \}}
\DoxyCodeLine{00081\ }
\DoxyCodeLine{00082\ \ \ \ \ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{namespacectll_afaf902ffaf3fd6dc870d0f2070795039}{empty}}\ ()\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ my\_head\ ==\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}};\ \}}
\DoxyCodeLine{00083\ }
\DoxyCodeLine{00085\ }
\DoxyCodeLine{00087\ \ \ \ \ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{void}\ notify\_entry\_observers(\ observer\_proxy*\&\ last,\ \textcolor{keywordtype}{bool}\ worker\ );}
\DoxyCodeLine{00088\ }
\DoxyCodeLine{00090\ \ \ \ \ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{void}\ notify\_exit\_observers(\ observer\_proxy*\&\ last,\ \textcolor{keywordtype}{bool}\ worker\ );}
\DoxyCodeLine{00091\ \};\ \textcolor{comment}{//\ class\ observer\_list}}
\DoxyCodeLine{00092\ }
\DoxyCodeLine{00094\ }
\DoxyCodeLine{00097\ \textcolor{keyword}{class\ }observer\_proxy\ \{}
\DoxyCodeLine{00098\ \ \ \ \ \textcolor{keyword}{friend}\ \textcolor{keyword}{class\ }task\_scheduler\_observer\_v3;}
\DoxyCodeLine{00099\ \ \ \ \ \textcolor{keyword}{friend}\ \textcolor{keyword}{class\ }observer\_list;}
\DoxyCodeLine{00101\ }
\DoxyCodeLine{00104\ \ \ \ \ \mbox{\hyperlink{sugar_8h_a48f1c51623545bd4f58fbab2fa6091d0}{atomic<int>}}\ my\_ref\_count;}
\DoxyCodeLine{00106\ \ \ \ \ observer\_list*\ my\_list;}
\DoxyCodeLine{00108\ }
\DoxyCodeLine{00109\ \ \ \ \ observer\_proxy*\ my\_next;}
\DoxyCodeLine{00111\ }
\DoxyCodeLine{00112\ \ \ \ \ observer\_proxy*\ my\_prev;}
\DoxyCodeLine{00114\ \ \ \ \ task\_scheduler\_observer\_v3*\ my\_observer;}
\DoxyCodeLine{00116\ \ \ \ \ \textcolor{keywordtype}{char}\ my\_version;}
\DoxyCodeLine{00117\ }
\DoxyCodeLine{00118\ \textcolor{preprocessor}{\#if\ \_\_TBB\_ARENA\_OBSERVER}}
\DoxyCodeLine{00119\ \ \ \ \ interface6::task\_scheduler\_observer*\ get\_v6\_observer();}
\DoxyCodeLine{00120\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00121\ \textcolor{preprocessor}{\#if\ \_\_TBB\_ARENA\_OBSERVER}}
\DoxyCodeLine{00122\ \ \ \ \ \textcolor{keywordtype}{bool}\ is\_global();\ \textcolor{comment}{//TODO:\ move\ them\ back\ inline\ when\ un-\/CPF'ing}}
\DoxyCodeLine{00123\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00124\ }
\DoxyCodeLine{00126\ \ \ \ \ observer\_proxy(\ task\_scheduler\_observer\_v3\&\ );}
\DoxyCodeLine{00127\ }
\DoxyCodeLine{00128\ \textcolor{preprocessor}{\#if\ TBB\_USE\_ASSERT}}
\DoxyCodeLine{00129\ \ \ \ \ \string~observer\_proxy();}
\DoxyCodeLine{00130\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{/*\ TBB\_USE\_ASSERT\ */}\textcolor{preprocessor}{}}
\DoxyCodeLine{00131\ }
\DoxyCodeLine{00133\ \ \ \ \ observer\_proxy\&\ operator\ =\ (\ \textcolor{keyword}{const}\ observer\_proxy\&\ );}
\DoxyCodeLine{00134\ \};\ \textcolor{comment}{//\ class\ observer\_proxy}}
\DoxyCodeLine{00135\ }
\DoxyCodeLine{00136\ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{void}\ observer\_list::remove\_ref\_fast(\ observer\_proxy*\&\ \mbox{\hyperlink{main-override_8cpp_a117104b82864d3b23ec174af6d392709}{p}}\ )\ \{}
\DoxyCodeLine{00137\ \ \ \ \ \textcolor{keywordflow}{if}(\ \mbox{\hyperlink{main-override_8cpp_a117104b82864d3b23ec174af6d392709}{p}}-\/>my\_observer\ )\ \{}
\DoxyCodeLine{00138\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Can\ decrement\ refcount\ quickly,\ as\ it\ cannot\ drop\ to\ zero\ while\ under\ the\ lock.}}
\DoxyCodeLine{00139\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{offscreen_8c_a4788d82c901b9367dd5c0daff8a7616b}{r}}\ =\ -\/-\/\mbox{\hyperlink{main-override_8cpp_a117104b82864d3b23ec174af6d392709}{p}}-\/>my\_ref\_count;}
\DoxyCodeLine{00140\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{tbb__stddef_8h_a643ae54febb34aa0f2543aa5385a606f}{\_\_TBB\_ASSERT\_EX}}(\ \mbox{\hyperlink{offscreen_8c_a4788d82c901b9367dd5c0daff8a7616b}{r}},\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}}\ );}
\DoxyCodeLine{00141\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{main-override_8cpp_a117104b82864d3b23ec174af6d392709}{p}}\ =\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}};}
\DoxyCodeLine{00142\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00143\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Use\ slow\ form\ of\ refcount\ decrementing,\ after\ the\ lock\ is\ released.}}
\DoxyCodeLine{00144\ \ \ \ \ \}}
\DoxyCodeLine{00145\ \}}
\DoxyCodeLine{00146\ }
\DoxyCodeLine{00147\ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{void}\ observer\_list::notify\_entry\_observers(\ observer\_proxy*\&\ \mbox{\hyperlink{namespacetbb_1_1internal_a18405c9631e7064d3af5662f30a84dd2}{last}},\ \textcolor{keywordtype}{bool}\ worker\ )\ \{}
\DoxyCodeLine{00148\ \ \ \ \ \textcolor{keywordflow}{if}\ (\ \mbox{\hyperlink{namespacetbb_1_1internal_a18405c9631e7064d3af5662f30a84dd2}{last}}\ ==\ my\_tail\ )}
\DoxyCodeLine{00149\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00150\ \ \ \ \ do\_notify\_entry\_observers(\ \mbox{\hyperlink{namespacetbb_1_1internal_a18405c9631e7064d3af5662f30a84dd2}{last}},\ worker\ );}
\DoxyCodeLine{00151\ \}}
\DoxyCodeLine{00152\ }
\DoxyCodeLine{00153\ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{void}\ observer\_list::notify\_exit\_observers(\ observer\_proxy*\&\ \mbox{\hyperlink{namespacetbb_1_1internal_a18405c9631e7064d3af5662f30a84dd2}{last}},\ \textcolor{keywordtype}{bool}\ worker\ )\ \{}
\DoxyCodeLine{00154\ \ \ \ \ \textcolor{keywordflow}{if}\ (\ !\mbox{\hyperlink{namespacetbb_1_1internal_a18405c9631e7064d3af5662f30a84dd2}{last}}\ )}
\DoxyCodeLine{00155\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00156\ \ \ \ \ \mbox{\hyperlink{tbb__stddef_8h_a7b58d28a34a1717e2ddb591f00658b10}{\_\_TBB\_ASSERT}}(is\_alive((uintptr\_t)\mbox{\hyperlink{namespacetbb_1_1internal_a18405c9631e7064d3af5662f30a84dd2}{last}}),\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}});}
\DoxyCodeLine{00157\ \ \ \ \ do\_notify\_exit\_observers(\ \mbox{\hyperlink{namespacetbb_1_1internal_a18405c9631e7064d3af5662f30a84dd2}{last}},\ worker\ );}
\DoxyCodeLine{00158\ \ \ \ \ \mbox{\hyperlink{tbb__stddef_8h_a7b58d28a34a1717e2ddb591f00658b10}{\_\_TBB\_ASSERT}}(\mbox{\hyperlink{namespacetbb_1_1internal_a18405c9631e7064d3af5662f30a84dd2}{last}},\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}});}
\DoxyCodeLine{00159\ \ \ \ \ \mbox{\hyperlink{scheduler__common_8h_afd76b58919b61d3e37baa46d5299c6e7}{poison\_value}}(\mbox{\hyperlink{namespacetbb_1_1internal_a18405c9631e7064d3af5662f30a84dd2}{last}});}
\DoxyCodeLine{00160\ \}}
\DoxyCodeLine{00161\ }
\DoxyCodeLine{00162\ \textcolor{keyword}{extern}\ padded<observer\_list>\ the\_global\_observer\_list;}
\DoxyCodeLine{00163\ }
\DoxyCodeLine{00164\ \}\ \textcolor{comment}{//\ namespace\ internal}}
\DoxyCodeLine{00165\ \}\ \textcolor{comment}{//\ namespace\ tbb}}
\DoxyCodeLine{00166\ }
\DoxyCodeLine{00167\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{/*\ \_\_TBB\_SCHEDULER\_OBSERVER\ */}\textcolor{preprocessor}{}}
\DoxyCodeLine{00168\ }
\DoxyCodeLine{00169\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{/*\ \_TBB\_observer\_proxy\_H\ */}\textcolor{preprocessor}{}}

\end{DoxyCode}
