\doxysection{eastl\+::internal\+::function\+\_\+base\+\_\+detail\texorpdfstring{$<$}{<} SIZE\+\_\+\+IN\+\_\+\+BYTES \texorpdfstring{$>$}{>}\+::function\+\_\+manager\texorpdfstring{$<$}{<} Functor, is\+Copyable, R, Args \texorpdfstring{$>$}{>} 模板类 参考}
\hypertarget{classeastl_1_1internal_1_1function__base__detail_1_1function__manager}{}\label{classeastl_1_1internal_1_1function__base__detail_1_1function__manager}\index{eastl::internal::function\_base\_detail$<$ SIZE\_IN\_BYTES $>$::function\_manager$<$ Functor, isCopyable, R, Args $>$@{eastl::internal::function\_base\_detail$<$ SIZE\_IN\_BYTES $>$::function\_manager$<$ Functor, isCopyable, R, Args $>$}}


{\ttfamily \#include $<$function\+\_\+detail.\+h$>$}



类 eastl\+::internal\+::function\+\_\+base\+\_\+detail\texorpdfstring{$<$}{<} SIZE\+\_\+\+IN\+\_\+\+BYTES \texorpdfstring{$>$}{>}\+::function\+\_\+manager\texorpdfstring{$<$}{<} Functor, is\+Copyable, R, Args \texorpdfstring{$>$}{>} 继承关系图\+:
% FIG 0


eastl\+::internal\+::function\+\_\+base\+\_\+detail\texorpdfstring{$<$}{<} SIZE\+\_\+\+IN\+\_\+\+BYTES \texorpdfstring{$>$}{>}\+::function\+\_\+manager\texorpdfstring{$<$}{<} Functor, is\+Copyable, R, Args \texorpdfstring{$>$}{>} 的协作图\+:
% FIG 1
\doxysubsubsection*{Public 类型}
\begin{DoxyCompactItemize}
\item 
using \mbox{\hyperlink{classeastl_1_1internal_1_1function__base__detail_1_1function__manager_acc0d2cd2f72c5216cbb563fd76471e6d}{Base}} = \mbox{\hyperlink{classeastl_1_1internal_1_1function__base__detail_1_1function__manager__base}{function\+\_\+manager\+\_\+base}}$<$Functor, is\+Copyable$>$
\end{DoxyCompactItemize}
\doxysubsubsection*{静态 Public 成员函数}
\begin{DoxyCompactItemize}
\item 
static R \mbox{\hyperlink{classeastl_1_1internal_1_1function__base__detail_1_1function__manager_a29db99a882a598023fc86dc6feaf0595}{Invoker}} (Args... args, const \mbox{\hyperlink{classeastl_1_1internal_1_1function__base__detail_a71ec1546c2028f70828b7578d9fb79d9}{Functor\+Storage\+Type}} \&functor)
\end{DoxyCompactItemize}
\doxysubsection*{静态 Public 成员函数 继承自 \mbox{\hyperlink{classeastl_1_1internal_1_1function__base__detail_1_1function__manager__base}{eastl\+::internal\+::function\+\_\+base\+\_\+detail$<$ SIZE\+\_\+\+IN\+\_\+\+BYTES $>$\+::function\+\_\+manager\+\_\+base$<$ Functor, is\+Copyable, typename $>$}}}
\begin{DoxyCompactItemize}
\item 
static Functor \texorpdfstring{$\ast$}{*} \mbox{\hyperlink{classeastl_1_1internal_1_1function__base__detail_1_1function__manager__base_aca433c83a28d4cfea93a3e15ac135ed9}{Get\+Functor\+Ptr}} (const \mbox{\hyperlink{classeastl_1_1internal_1_1function__base__detail_a71ec1546c2028f70828b7578d9fb79d9}{Functor\+Storage\+Type}} \&storage) \mbox{\hyperlink{config_8h_a9f2560a8b4ca5ee60cc60934601d3bef}{EA\+\_\+\+NOEXCEPT}}
\item 
{\footnotesize template$<$typename T$>$ }\\static \mbox{\hyperlink{mimalloc_8h_a9d6d8aef94ac19034a5f163606f84830}{void}} \mbox{\hyperlink{classeastl_1_1internal_1_1function__base__detail_1_1function__manager__base_a086b2a39c633cd013605e77a29379b96}{Create\+Functor}} (\mbox{\hyperlink{classeastl_1_1internal_1_1function__base__detail_a71ec1546c2028f70828b7578d9fb79d9}{Functor\+Storage\+Type}} \&storage, T \&\&functor)
\item 
static \mbox{\hyperlink{mimalloc_8h_a9d6d8aef94ac19034a5f163606f84830}{void}} \mbox{\hyperlink{classeastl_1_1internal_1_1function__base__detail_1_1function__manager__base_a1c9401daeaa5f9b1bef2ad0feecd2b2a}{Destruct\+Functor}} (\mbox{\hyperlink{classeastl_1_1internal_1_1function__base__detail_a71ec1546c2028f70828b7578d9fb79d9}{Functor\+Storage\+Type}} \&storage)
\item 
static \mbox{\hyperlink{mimalloc_8h_a9d6d8aef94ac19034a5f163606f84830}{void}} \mbox{\hyperlink{classeastl_1_1internal_1_1function__base__detail_1_1function__manager__base_a2f189dc1f5359c53c1bf123c50006802}{Copy\+Functor}} (\mbox{\hyperlink{classeastl_1_1internal_1_1function__base__detail_a71ec1546c2028f70828b7578d9fb79d9}{Functor\+Storage\+Type}} \&to, const \mbox{\hyperlink{classeastl_1_1internal_1_1function__base__detail_a71ec1546c2028f70828b7578d9fb79d9}{Functor\+Storage\+Type}} \&from)
\item 
static \mbox{\hyperlink{mimalloc_8h_a9d6d8aef94ac19034a5f163606f84830}{void}} \mbox{\hyperlink{classeastl_1_1internal_1_1function__base__detail_1_1function__manager__base_a9729b96f719d52883fa21cec1f7729d4}{Move\+Functor}} (\mbox{\hyperlink{classeastl_1_1internal_1_1function__base__detail_a71ec1546c2028f70828b7578d9fb79d9}{Functor\+Storage\+Type}} \&to, \mbox{\hyperlink{classeastl_1_1internal_1_1function__base__detail_a71ec1546c2028f70828b7578d9fb79d9}{Functor\+Storage\+Type}} \&from) \mbox{\hyperlink{config_8h_a9f2560a8b4ca5ee60cc60934601d3bef}{EA\+\_\+\+NOEXCEPT}}
\item 
static \mbox{\hyperlink{mimalloc_8h_a9d6d8aef94ac19034a5f163606f84830}{void}} \texorpdfstring{$\ast$}{*} \mbox{\hyperlink{classeastl_1_1internal_1_1function__base__detail_1_1function__manager__base_add08b582b014e40725410cae4267922a}{Manager}} (\mbox{\hyperlink{mimalloc_8h_a9d6d8aef94ac19034a5f163606f84830}{void}} \texorpdfstring{$\ast$}{*}to, \mbox{\hyperlink{mimalloc_8h_a9d6d8aef94ac19034a5f163606f84830}{void}} \texorpdfstring{$\ast$}{*}from, typename \mbox{\hyperlink{classeastl_1_1internal_1_1function__base__detail_a421a1a6aed8df1ba8b0c63cc437594b7}{function\+\_\+base\+\_\+detail\+::\+Manager\+Operations}} ops) \mbox{\hyperlink{config_8h_a9f2560a8b4ca5ee60cc60934601d3bef}{EA\+\_\+\+NOEXCEPT}}
\end{DoxyCompactItemize}


\doxysubsection{成员类型定义说明}
\Hypertarget{classeastl_1_1internal_1_1function__base__detail_1_1function__manager_acc0d2cd2f72c5216cbb563fd76471e6d}\index{eastl::internal::function\_base\_detail$<$ SIZE\_IN\_BYTES $>$::function\_manager$<$ Functor, isCopyable, R, Args $>$@{eastl::internal::function\_base\_detail$<$ SIZE\_IN\_BYTES $>$::function\_manager$<$ Functor, isCopyable, R, Args $>$}!Base@{Base}}
\index{Base@{Base}!eastl::internal::function\_base\_detail$<$ SIZE\_IN\_BYTES $>$::function\_manager$<$ Functor, isCopyable, R, Args $>$@{eastl::internal::function\_base\_detail$<$ SIZE\_IN\_BYTES $>$::function\_manager$<$ Functor, isCopyable, R, Args $>$}}
\doxysubsubsection{\texorpdfstring{Base}{Base}}
{\footnotesize\ttfamily \label{classeastl_1_1internal_1_1function__base__detail_1_1function__manager_acc0d2cd2f72c5216cbb563fd76471e6d} 
template$<$\mbox{\hyperlink{sugar_8h_ae88a82478e3818cade3f598c25437904}{int}} SIZE\+\_\+\+IN\+\_\+\+BYTES$>$ \\
template$<$typename Functor, \mbox{\hyperlink{sugar_8h_abb452686968e48b67397da5f97445f5b}{bool}} is\+Copyable, typename R, typename... Args$>$ \\
using \mbox{\hyperlink{classeastl_1_1internal_1_1function__base__detail}{eastl\+::internal\+::function\+\_\+base\+\_\+detail}}$<$ SIZE\+\_\+\+IN\+\_\+\+BYTES $>$\+::function\+\_\+manager$<$ Functor, is\+Copyable, R, Args $>$\+::\+Base = \mbox{\hyperlink{classeastl_1_1internal_1_1function__base__detail_1_1function__manager__base}{function\+\_\+manager\+\_\+base}}$<$Functor, is\+Copyable$>$}



\doxysubsection{成员函数说明}
\Hypertarget{classeastl_1_1internal_1_1function__base__detail_1_1function__manager_a29db99a882a598023fc86dc6feaf0595}\index{eastl::internal::function\_base\_detail$<$ SIZE\_IN\_BYTES $>$::function\_manager$<$ Functor, isCopyable, R, Args $>$@{eastl::internal::function\_base\_detail$<$ SIZE\_IN\_BYTES $>$::function\_manager$<$ Functor, isCopyable, R, Args $>$}!Invoker@{Invoker}}
\index{Invoker@{Invoker}!eastl::internal::function\_base\_detail$<$ SIZE\_IN\_BYTES $>$::function\_manager$<$ Functor, isCopyable, R, Args $>$@{eastl::internal::function\_base\_detail$<$ SIZE\_IN\_BYTES $>$::function\_manager$<$ Functor, isCopyable, R, Args $>$}}
\doxysubsubsection{\texorpdfstring{Invoker()}{Invoker()}}
{\footnotesize\ttfamily \label{classeastl_1_1internal_1_1function__base__detail_1_1function__manager_a29db99a882a598023fc86dc6feaf0595} 
template$<$\mbox{\hyperlink{sugar_8h_ae88a82478e3818cade3f598c25437904}{int}} SIZE\+\_\+\+IN\+\_\+\+BYTES$>$ \\
template$<$typename Functor, \mbox{\hyperlink{sugar_8h_abb452686968e48b67397da5f97445f5b}{bool}} is\+Copyable, typename R, typename... Args$>$ \\
static R \mbox{\hyperlink{classeastl_1_1internal_1_1function__base__detail}{eastl\+::internal\+::function\+\_\+base\+\_\+detail}}$<$ SIZE\+\_\+\+IN\+\_\+\+BYTES $>$\+::function\+\_\+manager$<$ Functor, is\+Copyable, R, Args $>$\+::\+Invoker (\begin{DoxyParamCaption}\item[{Args...}]{args}{, }\item[{const \mbox{\hyperlink{classeastl_1_1internal_1_1function__base__detail_a71ec1546c2028f70828b7578d9fb79d9}{Functor\+Storage\+Type}} \&}]{functor}{}\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [inline]}, {\ttfamily [static]}}

NOTE\+:

The order of arguments here is vital to the call optimization. Let\textquotesingle{}s dig into why and look at some asm. We have two invoker signatures to consider\+: R Invoker(const Functor\+Storage\+Type\& functor, Args... args) R \doxylink{classeastl_1_1internal_1_1function__base__detail_1_1function__manager_a29db99a882a598023fc86dc6feaf0595}{Invoker(\+Args... args, const Functor\+Storage\+Type\& functor)}

Assume we are using the Windows x64 Calling Convention where the first 4 arguments are passed into RCX, RDX, R8, R9. This optimization works for any Calling Convention, we are just using Windows x64 for this example.

Given the following member function\+: void Test\+Member\+Func(int a, int b) RCX == this RDX == a R8 == b

All three arguments to the function including the hidden this pointer, which in C++ is always the first argument are passed into the first three registers. The function call chain for eastl\+::function$<$$>$() is as follows\+: operator ()(this, Args... args) -\/\texorpdfstring{$>$}{>} Invoker(Args... args, this-\/\texorpdfstring{$>$}{>}m\+Storage) -\/\texorpdfstring{$>$}{>} Stored\+Function(\+Args... arg)

Let\textquotesingle{}s look at what is happening at the asm level with the different Invoker function signatures and why.

You will notice that operator ()() and \doxylink{classeastl_1_1internal_1_1function__base__detail_1_1function__manager_a29db99a882a598023fc86dc6feaf0595}{Invoker()} have the arguments reversed. operator ()() just directly calls to \doxylink{classeastl_1_1internal_1_1function__base__detail_1_1function__manager_a29db99a882a598023fc86dc6feaf0595}{Invoker()}, it is a tail call, so we force inline the call operator to ensure we directly call to the \doxylink{classeastl_1_1internal_1_1function__base__detail_1_1function__manager_a29db99a882a598023fc86dc6feaf0595}{Invoker()}. Most compilers always inline it anyways by default; have been instances where it doesn\textquotesingle{}t even though the asm ends up being cheaper. call -\/\texorpdfstring{$>$}{>} call -\/\texorpdfstring{$>$}{>} call versus call -\/\texorpdfstring{$>$}{>} call

\doxylink{classeastl_1_1function}{eastl\+::function$<$int(int, int)$>$} = Function\+Pointer

Assume we have the above \doxylink{classeastl_1_1function}{eastl\+::function} object that holds a pointer to a function as the internal callable.

Invoker(this-\/\texorpdfstring{$>$}{>}m\+Storage, Args... args) is called with the follow arguments in registers\+: RCX = this \texorpdfstring{$\vert$}{|} RDX = a \texorpdfstring{$\vert$}{|} R8 = b

Inside \doxylink{classeastl_1_1internal_1_1function__base__detail_1_1function__manager_a29db99a882a598023fc86dc6feaf0595}{Invoker()} we use RCX to deference into the \doxylink{classeastl_1_1function}{eastl\+::function} object and get the function pointer to call. This function to call has signature Func(int, int) and thus requires its arguments in registers RCX and RDX. The compiler must shift all the arguments towards the left. The full asm looks something as follows.

Calling Invoker\+: Inside Invoker\+:

mov rcx, this mov rax, \mbox{[}rcx\mbox{]} mov rdx, a mov rcx, rdx mov r8, b mov rdx, r8 call \mbox{[}rcx + offset to Invoker\mbox{]} jmp \mbox{[}rax\mbox{]}

Notice how the compiler shifts all the arguments before calling the callable and also we only use the this pointer to access the internal storage inside the \doxylink{classeastl_1_1function}{eastl\+::function} object.

Invoker(Args... args, this-\/\texorpdfstring{$>$}{>}m\+Storage) is called with the following arguments in registers\+: RCX = a \texorpdfstring{$\vert$}{|} RDX = b \texorpdfstring{$\vert$}{|} R8 = this

You can see we no longer have to shift the arguments down when going to call the internal stored callable.

Calling Invoker\+: Inside Invoker\+:

mov rcx, a mov rax, \mbox{[}r8\mbox{]} mov rdx, b jmp \mbox{[}rax\mbox{]} mov r8, this call \mbox{[}r8 + offset to Invoker\mbox{]}

The generated asm does a straight tail jmp to the loaded function pointer. The arguments are already in the correct registers.

For Functors or Lambdas with no captures, this gives us another free register to use to pass arguments since the this is at the end, it can be passed onto the stack if we run out of registers. Since the callable has no captures; inside the \doxylink{classeastl_1_1internal_1_1function__base__detail_1_1function__manager_a29db99a882a598023fc86dc6feaf0595}{Invoker()}, we won\textquotesingle{}t ever need to touch this thus we can just call the operator ()() or let the compiler inline it.

For a callable with captures there is no perf hit since the callable in the common case is inlined and the pointer to the callable buffer is passed in a register which the compiler can use to access the captures.

For \doxylink{classeastl_1_1function}{eastl\+::function$<$void(const T\&, int, int)$>$} that a holds a pointer to member function. The this pointers is implicitly the first argument in the argument list, const T\&, and the member function pointer will be called on that object. This prevents any argument shifting since the this for the member function pointer is already in RCX.

This is why having this at the end of the argument list is important for generating efficient \doxylink{classeastl_1_1internal_1_1function__base__detail_1_1function__manager_a29db99a882a598023fc86dc6feaf0595}{Invoker()} thunks. 函数调用图\+:
% FIG 2


该类的文档由以下文件生成\+:\begin{DoxyCompactItemize}
\item 
runtime/\+EASTL/include/\+EASTL/internal/\mbox{\hyperlink{function__detail_8h}{function\+\_\+detail.\+h}}\end{DoxyCompactItemize}
