\doxysection{arena.\+h}
\hypertarget{arena_8h_source}{}\label{arena_8h_source}\index{external/taskflow/3rd-\/party/tbb/src/tbb/arena.h@{external/taskflow/3rd-\/party/tbb/src/tbb/arena.h}}
\mbox{\hyperlink{arena_8h}{浏览该文件的文档.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{/*}}
\DoxyCodeLine{00002\ \textcolor{comment}{\ \ \ \ Copyright\ (c)\ 2005-\/2020\ Intel\ Corporation}}
\DoxyCodeLine{00003\ \textcolor{comment}{}}
\DoxyCodeLine{00004\ \textcolor{comment}{\ \ \ \ Licensed\ under\ the\ Apache\ License,\ Version\ 2.0\ (the\ "{}License"{});}}
\DoxyCodeLine{00005\ \textcolor{comment}{\ \ \ \ you\ may\ not\ use\ this\ file\ except\ in\ compliance\ with\ the\ License.}}
\DoxyCodeLine{00006\ \textcolor{comment}{\ \ \ \ You\ may\ obtain\ a\ copy\ of\ the\ License\ at}}
\DoxyCodeLine{00007\ \textcolor{comment}{}}
\DoxyCodeLine{00008\ \textcolor{comment}{\ \ \ \ \ \ \ \ http://www.apache.org/licenses/LICENSE-\/2.0}}
\DoxyCodeLine{00009\ \textcolor{comment}{}}
\DoxyCodeLine{00010\ \textcolor{comment}{\ \ \ \ Unless\ required\ by\ applicable\ law\ or\ agreed\ to\ in\ writing,\ software}}
\DoxyCodeLine{00011\ \textcolor{comment}{\ \ \ \ distributed\ under\ the\ License\ is\ distributed\ on\ an\ "{}AS\ IS"{}\ BASIS,}}
\DoxyCodeLine{00012\ \textcolor{comment}{\ \ \ \ WITHOUT\ WARRANTIES\ OR\ CONDITIONS\ OF\ ANY\ KIND,\ either\ express\ or\ implied.}}
\DoxyCodeLine{00013\ \textcolor{comment}{\ \ \ \ See\ the\ License\ for\ the\ specific\ language\ governing\ permissions\ and}}
\DoxyCodeLine{00014\ \textcolor{comment}{\ \ \ \ limitations\ under\ the\ License.}}
\DoxyCodeLine{00015\ \textcolor{comment}{*/}}
\DoxyCodeLine{00016\ }
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#ifndef\ \_TBB\_arena\_H}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#define\ \_TBB\_arena\_H}}
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{tbb__stddef_8h}{tbb/tbb\_stddef.h}}"{}}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{external_2taskflow_23rd-party_2tbb_2include_2tbb_2atomic_8h}{tbb/atomic.h}}"{}}}
\DoxyCodeLine{00022\ }
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{tbb__machine_8h}{tbb/tbb\_machine.h}}"{}}}
\DoxyCodeLine{00024\ }
\DoxyCodeLine{00025\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{scheduler__common_8h}{scheduler\_common.h}}"{}}}
\DoxyCodeLine{00026\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{external_2taskflow_23rd-party_2tbb_2src_2tbb_2intrusive__list_8h}{intrusive\_list.h}}"{}}}
\DoxyCodeLine{00027\ \textcolor{preprocessor}{\#if\ \_\_TBB\_PREVIEW\_CRITICAL\_TASKS\ \&\&\ \_\_TBB\_CPF\_BUILD}}
\DoxyCodeLine{00028\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{task__stream__extended_8h}{task\_stream\_extended.h}}"{}}}
\DoxyCodeLine{00029\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00030\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{task__stream_8h}{task\_stream.h}}"{}}}
\DoxyCodeLine{00031\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00032\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{rml__tbb_8h}{../rml/include/rml\_tbb.h}}"{}}}
\DoxyCodeLine{00033\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{mailbox_8h}{mailbox.h}}"{}}}
\DoxyCodeLine{00034\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{observer__proxy_8h}{observer\_proxy.h}}"{}}}
\DoxyCodeLine{00035\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{market_8h}{market.h}}"{}}}
\DoxyCodeLine{00036\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{governor_8h}{governor.h}}"{}}}
\DoxyCodeLine{00037\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{concurrent__monitor_8h}{concurrent\_monitor.h}}"{}}}
\DoxyCodeLine{00038\ }
\DoxyCodeLine{00039\ \textcolor{preprocessor}{\#if\ \_\_TBB\_PREVIEW\_RESUMABLE\_TASKS}}
\DoxyCodeLine{00040\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{external_2taskflow_23rd-party_2tbb_2include_2tbb_2spin__mutex_8h}{tbb/spin\_mutex.h}}"{}}}
\DoxyCodeLine{00041\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00042\ }
\DoxyCodeLine{00043\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespacetbb}{tbb}}\ \{}
\DoxyCodeLine{00044\ }
\DoxyCodeLine{00045\ \textcolor{keyword}{class\ }task\_group\_context;}
\DoxyCodeLine{00046\ \textcolor{keyword}{class\ }allocate\_root\_with\_context\_proxy;}
\DoxyCodeLine{00047\ }
\DoxyCodeLine{00048\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespacetbb_1_1internal}{internal}}\ \{}
\DoxyCodeLine{00049\ }
\DoxyCodeLine{00050\ \textcolor{preprocessor}{\#if\ \_\_TBB\_NUMA\_SUPPORT}}
\DoxyCodeLine{00051\ \textcolor{keyword}{class\ }numa\_binding\_observer;}
\DoxyCodeLine{00052\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{/*\_\_TBB\_NUMA\_SUPPORT*/}\textcolor{preprocessor}{}}
\DoxyCodeLine{00053\ }
\DoxyCodeLine{00054\ \textcolor{preprocessor}{\#if\ \_\_TBB\_PREVIEW\_RESUMABLE\_TASKS}}
\DoxyCodeLine{00056\ \textcolor{keyword}{class\ }arena\_co\_cache\ \{}
\DoxyCodeLine{00058\ \ \ \ \ generic\_scheduler**\ my\_co\_scheduler\_cache;}
\DoxyCodeLine{00060\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ my\_head;}
\DoxyCodeLine{00062\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ my\_max\_index;}
\DoxyCodeLine{00064\ \ \ \ \ tbb::spin\_mutex\ my\_co\_cache\_mutex;}
\DoxyCodeLine{00065\ }
\DoxyCodeLine{00066\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ next\_index()\ \{}
\DoxyCodeLine{00067\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ (\ my\_head\ ==\ my\_max\_index\ )\ ?\ 0\ :\ my\_head\ +\ 1;}
\DoxyCodeLine{00068\ \ \ \ \ \}}
\DoxyCodeLine{00069\ }
\DoxyCodeLine{00070\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ prev\_index()\ \{}
\DoxyCodeLine{00071\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ (\ my\_head\ ==\ 0\ )\ ?\ my\_max\_index\ :\ my\_head\ -\/\ 1;}
\DoxyCodeLine{00072\ \ \ \ \ \}}
\DoxyCodeLine{00073\ }
\DoxyCodeLine{00074\ \ \ \ \ \textcolor{keywordtype}{bool}\ internal\_empty()\ \{}
\DoxyCodeLine{00075\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ my\_co\_scheduler\_cache[prev\_index()]\ ==\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}};}
\DoxyCodeLine{00076\ \ \ \ \ \}}
\DoxyCodeLine{00077\ }
\DoxyCodeLine{00078\ \ \ \ \ \textcolor{keywordtype}{void}\ internal\_scheduler\_cleanup(generic\_scheduler*\ to\_cleanup)\ \{}
\DoxyCodeLine{00079\ \ \ \ \ \ \ \ \ to\_cleanup-\/>my\_arena\_slot\ =\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}};}
\DoxyCodeLine{00080\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Needed\ by\ cleanup\_worker\ function,\ as\ well\ as\ arena\ slot\ clearing}}
\DoxyCodeLine{00081\ \ \ \ \ \ \ \ \ governor::assume\_scheduler(to\_cleanup);}
\DoxyCodeLine{00082\ \ \ \ \ \ \ \ \ generic\_scheduler::cleanup\_worker(to\_cleanup,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00083\ \ \ \ \ \}}
\DoxyCodeLine{00084\ }
\DoxyCodeLine{00085\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00086\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{boing_8c_a2858154e2009b0e6e616f313177762bc}{init}}(\textcolor{keywordtype}{unsigned}\ cache\_capacity)\ \{}
\DoxyCodeLine{00087\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ alloc\_size\ =\ cache\_capacity\ *\ \textcolor{keyword}{sizeof}(generic\_scheduler*);}
\DoxyCodeLine{00088\ \ \ \ \ \ \ \ \ my\_co\_scheduler\_cache\ =\ (generic\_scheduler**)\mbox{\hyperlink{namespacetbb_1_1internal_a395611542e21705f49de2a06e2c88f59}{NFS\_Allocate}}(1,\ alloc\_size,\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}});}
\DoxyCodeLine{00089\ \ \ \ \ \ \ \ \ memset(\ my\_co\_scheduler\_cache,\ 0,\ alloc\_size\ );}
\DoxyCodeLine{00090\ \ \ \ \ \ \ \ \ my\_head\ =\ 0;}
\DoxyCodeLine{00091\ \ \ \ \ \ \ \ \ my\_max\_index\ =\ cache\_capacity\ -\/\ 1;}
\DoxyCodeLine{00092\ \ \ \ \ \}}
\DoxyCodeLine{00093\ }
\DoxyCodeLine{00094\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{namespacerpr_afeefd6887181195472822223c4dc3c1d}{cleanup}}()\ \{}
\DoxyCodeLine{00095\ \ \ \ \ \ \ \ \ generic\_scheduler*\ current\ =\ governor::local\_scheduler\_if\_initialized();}
\DoxyCodeLine{00096\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (generic\_scheduler*\ to\_cleanup\ =\ \mbox{\hyperlink{namespacesource__runtime_1_1vector_a9e32bbc347aee976ae2e2853e4ba98af}{pop}}())\ \{}
\DoxyCodeLine{00097\ \ \ \ \ \ \ \ \ \ \ \ \ internal\_scheduler\_cleanup(to\_cleanup);}
\DoxyCodeLine{00098\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00099\ \ \ \ \ \ \ \ \ governor::assume\_scheduler(current);}
\DoxyCodeLine{00100\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacetbb_1_1internal_abd3fdd42ea716867fc95116354481b4e}{NFS\_Free}}(my\_co\_scheduler\_cache);}
\DoxyCodeLine{00101\ \ \ \ \ \}}
\DoxyCodeLine{00102\ }
\DoxyCodeLine{00105\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{test__concurrent__queue_8cpp_a262227aa72b9cc1db7b9a80d7f295211}{push}}(generic\_scheduler*\ \mbox{\hyperlink{main-override_8cpp_a1384e7608274313a9433fa573868557b}{s}})\ \{}
\DoxyCodeLine{00106\ \ \ \ \ \ \ \ \ generic\_scheduler*\ to\_cleanup\ =\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}};}
\DoxyCodeLine{00107\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00108\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classtbb_1_1spin__mutex_afcf922650b2fd9d76b7b939d8511bbd8}{tbb::spin\_mutex::scoped\_lock}}\ \mbox{\hyperlink{ittnotify__static_8h_a46e8be2e3aadb2f6ee62e762a36b9243}{lock}}(my\_co\_cache\_mutex);}
\DoxyCodeLine{00109\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Check\ if\ we\ are\ replacing\ some\ existing\ buffer\ entrance}}
\DoxyCodeLine{00110\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (my\_co\_scheduler\_cache[my\_head]\ !=\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}})\ \{}
\DoxyCodeLine{00111\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ to\_cleanup\ =\ my\_co\_scheduler\_cache[my\_head];}
\DoxyCodeLine{00112\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00113\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Store\ the\ cached\ value}}
\DoxyCodeLine{00114\ \ \ \ \ \ \ \ \ \ \ \ \ my\_co\_scheduler\_cache[my\_head]\ =\ \mbox{\hyperlink{main-override_8cpp_a1384e7608274313a9433fa573868557b}{s}};}
\DoxyCodeLine{00115\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Move\ head\ index\ to\ the\ next\ slot}}
\DoxyCodeLine{00116\ \ \ \ \ \ \ \ \ \ \ \ \ my\_head\ =\ next\_index();}
\DoxyCodeLine{00117\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00118\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Cleanup\ replaced\ buffer\ if\ any}}
\DoxyCodeLine{00119\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (to\_cleanup)\ \{}
\DoxyCodeLine{00120\ \ \ \ \ \ \ \ \ \ \ \ \ generic\_scheduler*\ current\ =\ governor::local\_scheduler\_if\_initialized();}
\DoxyCodeLine{00121\ \ \ \ \ \ \ \ \ \ \ \ \ internal\_scheduler\_cleanup(to\_cleanup);}
\DoxyCodeLine{00122\ \ \ \ \ \ \ \ \ \ \ \ \ governor::assume\_scheduler(current);}
\DoxyCodeLine{00123\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00124\ \ \ \ \ \}}
\DoxyCodeLine{00125\ }
\DoxyCodeLine{00127\ \ \ \ \ generic\_scheduler*\ \mbox{\hyperlink{namespacesource__runtime_1_1vector_a9e32bbc347aee976ae2e2853e4ba98af}{pop}}()\ \{}
\DoxyCodeLine{00128\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classtbb_1_1spin__mutex_afcf922650b2fd9d76b7b939d8511bbd8}{tbb::spin\_mutex::scoped\_lock}}\ \mbox{\hyperlink{ittnotify__static_8h_a46e8be2e3aadb2f6ee62e762a36b9243}{lock}}(my\_co\_cache\_mutex);}
\DoxyCodeLine{00129\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ No\ cached\ coroutine}}
\DoxyCodeLine{00130\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (internal\_empty())\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}};}
\DoxyCodeLine{00131\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Move\ head\ index\ to\ the\ currently\ available\ value}}
\DoxyCodeLine{00132\ \ \ \ \ \ \ \ \ my\_head\ =\ prev\_index();}
\DoxyCodeLine{00133\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Retrieve\ the\ value\ from\ the\ buffer}}
\DoxyCodeLine{00134\ \ \ \ \ \ \ \ \ generic\_scheduler*\ to\_return\ =\ my\_co\_scheduler\_cache[my\_head];}
\DoxyCodeLine{00135\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Clear\ the\ previous\ entrance\ value}}
\DoxyCodeLine{00136\ \ \ \ \ \ \ \ \ my\_co\_scheduler\_cache[my\_head]\ =\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}};}
\DoxyCodeLine{00137\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ to\_return;}
\DoxyCodeLine{00138\ \ \ \ \ \}}
\DoxyCodeLine{00139\ \};}
\DoxyCodeLine{00140\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ \_\_TBB\_PREVIEW\_RESUMABLE\_TASKS}}
\DoxyCodeLine{00141\ }
\DoxyCodeLine{00143\ }
\DoxyCodeLine{00145\ \textcolor{keyword}{struct\ }\mbox{\hyperlink{structtbb_1_1internal_1_1arena__base}{arena\_base}}\ :\ padded<intrusive\_list\_node>\ \{}
\DoxyCodeLine{00147\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \mbox{\hyperlink{structtbb_1_1internal_1_1arena__base_a5db92c4ad3061c5cf83425507ed9446e}{my\_num\_workers\_allotted}};\ \ \ \textcolor{comment}{//\ heavy\ use\ in\ stealing\ loop}}
\DoxyCodeLine{00148\ }
\DoxyCodeLine{00150\ }
\DoxyCodeLine{00153\ \ \ \ \ \mbox{\hyperlink{sugar_8h_a48f1c51623545bd4f58fbab2fa6091d0}{atomic<unsigned>}}\ \mbox{\hyperlink{structtbb_1_1internal_1_1arena__base_afda80ce7337049bd96b883cef6e8483e}{my\_references}};\ \ \ \ \ \textcolor{comment}{//\ heavy\ use\ in\ stealing\ loop}}
\DoxyCodeLine{00154\ }
\DoxyCodeLine{00155\ \textcolor{preprocessor}{\#if\ \_\_TBB\_TASK\_PRIORITY}}
\DoxyCodeLine{00157\ \ \ \ \ \textcolor{keyword}{volatile}\ intptr\_t\ my\_top\_priority;\ \ \textcolor{comment}{//\ heavy\ use\ in\ stealing\ loop}}
\DoxyCodeLine{00158\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{/*\ !\_\_TBB\_TASK\_PRIORITY\ */}\textcolor{preprocessor}{}}
\DoxyCodeLine{00159\ }
\DoxyCodeLine{00161\ \ \ \ \ \mbox{\hyperlink{sugar_8h_a48f1c51623545bd4f58fbab2fa6091d0}{atomic<unsigned>}}\ \mbox{\hyperlink{structtbb_1_1internal_1_1arena__base_a0184ffea730d663e63f0f60946422da2}{my\_limit}};\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ heavy\ use\ in\ stealing\ loop}}
\DoxyCodeLine{00162\ }
\DoxyCodeLine{00164\ }
\DoxyCodeLine{00169\ \textcolor{preprocessor}{\#if\ \_\_TBB\_PREVIEW\_CRITICAL\_TASKS\ \&\&\ \_\_TBB\_CPF\_BUILD}}
\DoxyCodeLine{00170\ \ \ \ \ \mbox{\hyperlink{classtbb_1_1internal_1_1task__stream}{task\_stream<num\_priority\_levels,\ front\_accessor>}}\ \mbox{\hyperlink{structtbb_1_1internal_1_1arena__base_a3a649af3dbb87630125abd16d767eb77}{my\_task\_stream}};\ \textcolor{comment}{//\ heavy\ use\ in\ stealing\ loop}}
\DoxyCodeLine{00171\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00172\ \ \ \ \ \mbox{\hyperlink{classtbb_1_1internal_1_1task__stream}{task\_stream<num\_priority\_levels>}}\ \mbox{\hyperlink{structtbb_1_1internal_1_1arena__base_a3a649af3dbb87630125abd16d767eb77}{my\_task\_stream}};\ \textcolor{comment}{//\ heavy\ use\ in\ stealing\ loop}}
\DoxyCodeLine{00173\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00174\ }
\DoxyCodeLine{00175\ \textcolor{preprocessor}{\#if\ \_\_TBB\_PREVIEW\_CRITICAL\_TASKS}}
\DoxyCodeLine{00177\ }
\DoxyCodeLine{00180\ \ \ \ \ \textcolor{comment}{//\ used\ on\ the\ hot\ path\ of\ the\ task\ dispatch\ loop}}
\DoxyCodeLine{00181\ \ \ \ \ \mbox{\hyperlink{classtbb_1_1internal_1_1task__stream}{task\_stream<1,\ back\_nonnull\_accessor>}}\ my\_critical\_task\_stream;}
\DoxyCodeLine{00182\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00183\ }
\DoxyCodeLine{00185\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \mbox{\hyperlink{structtbb_1_1internal_1_1arena__base_a87fa3017fe36fc2d82a59af27dbd80c2}{my\_max\_num\_workers}};}
\DoxyCodeLine{00186\ }
\DoxyCodeLine{00188\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{structtbb_1_1internal_1_1arena__base_a8e346bbed329804473efe0f8080c9e8b}{my\_num\_workers\_requested}};}
\DoxyCodeLine{00189\ }
\DoxyCodeLine{00191\ }
\DoxyCodeLine{00195\ \ \ \ \ tbb::atomic<uintptr\_t>\ \mbox{\hyperlink{structtbb_1_1internal_1_1arena__base_a4a62e36b7d674c0023897118be16498d}{my\_pool\_state}};}
\DoxyCodeLine{00196\ }
\DoxyCodeLine{00197\ \textcolor{preprocessor}{\#if\ \_\_TBB\_ARENA\_OBSERVER}}
\DoxyCodeLine{00199\ \ \ \ \ observer\_list\ my\_observers;}
\DoxyCodeLine{00200\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00201\ }
\DoxyCodeLine{00202\ \textcolor{preprocessor}{\#if\ \_\_TBB\_NUMA\_SUPPORT}}
\DoxyCodeLine{00204\ \ \ \ \ numa\_binding\_observer*\ my\_numa\_binding\_observer;}
\DoxyCodeLine{00205\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{/*\_\_TBB\_NUMA\_SUPPORT*/}\textcolor{preprocessor}{}}
\DoxyCodeLine{00206\ }
\DoxyCodeLine{00207\ \textcolor{preprocessor}{\#if\ \_\_TBB\_TASK\_PRIORITY}}
\DoxyCodeLine{00209\ \ \ \ \ intptr\_t\ my\_bottom\_priority;}
\DoxyCodeLine{00210\ }
\DoxyCodeLine{00212\ }
\DoxyCodeLine{00214\ \ \ \ \ uintptr\_t\ my\_reload\_epoch;}
\DoxyCodeLine{00215\ }
\DoxyCodeLine{00217\ \ \ \ \ task*\ my\_orphaned\_tasks;}
\DoxyCodeLine{00218\ }
\DoxyCodeLine{00220\ \ \ \ \ tbb::atomic<uintptr\_t>\ my\_abandonment\_epoch;}
\DoxyCodeLine{00221\ }
\DoxyCodeLine{00223\ }
\DoxyCodeLine{00226\ \ \ \ \ tbb::atomic<intptr\_t>\ my\_skipped\_fifo\_priority;}
\DoxyCodeLine{00227\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{/*\ !\_\_TBB\_TASK\_PRIORITY\ */}\textcolor{preprocessor}{}}
\DoxyCodeLine{00228\ }
\DoxyCodeLine{00229\ \ \ \ \ \textcolor{comment}{//\ Below\ are\ rarely\ modified\ members}}
\DoxyCodeLine{00230\ }
\DoxyCodeLine{00232\ \ \ \ \ \mbox{\hyperlink{classtbb_1_1internal_1_1market}{market}}*\ \mbox{\hyperlink{structtbb_1_1internal_1_1arena__base_a9571049272687e3f4d113809f0a62080}{my\_market}};}
\DoxyCodeLine{00233\ }
\DoxyCodeLine{00235\ \ \ \ \ uintptr\_t\ \mbox{\hyperlink{structtbb_1_1internal_1_1arena__base_a296eec178d5cc622a8fa921d188dbc4f}{my\_aba\_epoch}};}
\DoxyCodeLine{00236\ }
\DoxyCodeLine{00237\ \textcolor{preprocessor}{\#if\ !\_\_TBB\_FP\_CONTEXT}}
\DoxyCodeLine{00239\ \ \ \ \ \mbox{\hyperlink{classtbb_1_1internal_1_1cpu__ctl__env}{cpu\_ctl\_env}}\ \mbox{\hyperlink{structtbb_1_1internal_1_1arena__base_ad3bceeb970e25673b1a1e60b67078062}{my\_cpu\_ctl\_env}};}
\DoxyCodeLine{00240\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00241\ }
\DoxyCodeLine{00242\ \textcolor{preprocessor}{\#if\ \_\_TBB\_TASK\_GROUP\_CONTEXT}}
\DoxyCodeLine{00244\ }
\DoxyCodeLine{00246\ \ \ \ \ task\_group\_context*\ my\_default\_ctx;}
\DoxyCodeLine{00247\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{/*\ \_\_TBB\_TASK\_GROUP\_CONTEXT\ */}\textcolor{preprocessor}{}}
\DoxyCodeLine{00248\ }
\DoxyCodeLine{00250\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \mbox{\hyperlink{structtbb_1_1internal_1_1arena__base_a7770213e3c679d92756b791cccb84e35}{my\_num\_slots}};}
\DoxyCodeLine{00251\ }
\DoxyCodeLine{00253\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \mbox{\hyperlink{structtbb_1_1internal_1_1arena__base_a206a08226cb9da9d777fd433789ff933}{my\_num\_reserved\_slots}};}
\DoxyCodeLine{00254\ }
\DoxyCodeLine{00255\ \textcolor{preprocessor}{\#if\ \_\_TBB\_ENQUEUE\_ENFORCED\_CONCURRENCY}}
\DoxyCodeLine{00256\ \ \ \ \ \textcolor{comment}{//\ arena\ needs\ an\ extra\ worker\ despite\ the\ arena\ limit}}
\DoxyCodeLine{00257\ \ \ \ \ \textcolor{keywordtype}{bool}\ my\_local\_concurrency\_mode;}
\DoxyCodeLine{00258\ \ \ \ \ \textcolor{comment}{//\ arena\ needs\ an\ extra\ worker\ despite\ a\ global\ limit}}
\DoxyCodeLine{00259\ \ \ \ \ \textcolor{keywordtype}{bool}\ my\_global\_concurrency\_mode;}
\DoxyCodeLine{00260\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{/*\ \_\_TBB\_ENQUEUE\_ENFORCED\_CONCURRENCY\ */}\textcolor{preprocessor}{}}
\DoxyCodeLine{00261\ }
\DoxyCodeLine{00263\ \ \ \ \ \mbox{\hyperlink{classtbb_1_1internal_1_1concurrent__monitor}{concurrent\_monitor}}\ \mbox{\hyperlink{structtbb_1_1internal_1_1arena__base_a3877c52df25164ba94f721a5661738b1}{my\_exit\_monitors}};}
\DoxyCodeLine{00264\ }
\DoxyCodeLine{00265\ \textcolor{preprocessor}{\#if\ \_\_TBB\_PREVIEW\_RESUMABLE\_TASKS}}
\DoxyCodeLine{00267\ \ \ \ \ arena\_co\_cache\ my\_co\_cache;}
\DoxyCodeLine{00268\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00269\ }
\DoxyCodeLine{00270\ \textcolor{preprocessor}{\#if\ TBB\_USE\_ASSERT}}
\DoxyCodeLine{00272\ \ \ \ \ uintptr\_t\ my\_guard;}
\DoxyCodeLine{00273\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{/*\ TBB\_USE\_ASSERT\ */}\textcolor{preprocessor}{}}
\DoxyCodeLine{00274\ \};\ \textcolor{comment}{//\ struct\ arena\_base}}
\DoxyCodeLine{00275\ }
\DoxyCodeLine{00276\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classtbb_1_1internal_1_1arena_ad3b28deb1fcb30cb533ea7b655819d6b}{arena}}:\ \textcolor{keyword}{public}\ padded<arena\_base>}
\DoxyCodeLine{00277\ \{}
\DoxyCodeLine{00279\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_a33644ebee7b2f7b472fc6fdca10eff2b}{restore\_priority\_if\_need}}();}
\DoxyCodeLine{00280\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00281\ \ \ \ \ \textcolor{keyword}{typedef}\ padded<arena\_base>\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_acd0c8a22c63cd214ec4e713f4254ce8e}{base\_type}};}
\DoxyCodeLine{00282\ }
\DoxyCodeLine{00284\ \ \ \ \ \textcolor{keyword}{enum}\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_a2380e7751924d1199ffab7b2ee29ddee}{new\_work\_type}}\ \{}
\DoxyCodeLine{00285\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_a2380e7751924d1199ffab7b2ee29ddeea2109ea81736367212fa797959b4b4381}{work\_spawned}},}
\DoxyCodeLine{00286\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_a2380e7751924d1199ffab7b2ee29ddeeac92fe41bfa3a02ea67d83232c9f88b90}{wakeup}},}
\DoxyCodeLine{00287\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_a2380e7751924d1199ffab7b2ee29ddeea49e498ff35aa2bbce4de87dfd7faab04}{work\_enqueued}}}
\DoxyCodeLine{00288\ \ \ \ \ \};}
\DoxyCodeLine{00289\ }
\DoxyCodeLine{00291\ \ \ \ \ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_ad3b28deb1fcb30cb533ea7b655819d6b}{arena}}\ (\ \mbox{\hyperlink{classtbb_1_1internal_1_1market}{market}}\&,\ \textcolor{keywordtype}{unsigned}\ max\_num\_workers,\ \textcolor{keywordtype}{unsigned}\ num\_reserved\_slots\ );}
\DoxyCodeLine{00292\ }
\DoxyCodeLine{00294\ \ \ \ \ \textcolor{keyword}{static}\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena}{arena}}\&\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_ad42305a844f6c9dc93b6d1c8c0302238}{allocate\_arena}}(\ \mbox{\hyperlink{classtbb_1_1internal_1_1market}{market}}\&,\ \textcolor{keywordtype}{unsigned}\ num\_slots,\ \textcolor{keywordtype}{unsigned}\ num\_reserved\_slots\ );}
\DoxyCodeLine{00295\ }
\DoxyCodeLine{00296\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{int}\ \textcolor{keywordtype}{unsigned}\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_a315d666efe28ecd0fb6aa70f2da0eb37}{num\_arena\_slots}}\ (\ \textcolor{keywordtype}{unsigned}\ num\_slots\ )\ \{}
\DoxyCodeLine{00297\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{datatypes_8h_affe776513b24d84b39af8ab0930fef7f}{max}}(2u,\ num\_slots);}
\DoxyCodeLine{00298\ \ \ \ \ \}}
\DoxyCodeLine{00299\ }
\DoxyCodeLine{00300\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_a88bd4bed45e6ca7bcba05e568717be3b}{allocation\_size}}\ (\ \textcolor{keywordtype}{unsigned}\ num\_slots\ )\ \{}
\DoxyCodeLine{00301\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{classtbb_1_1internal_1_1arena_acd0c8a22c63cd214ec4e713f4254ce8e}{base\_type}})\ +\ num\_slots\ *\ (\textcolor{keyword}{sizeof}(\mbox{\hyperlink{classtbb_1_1internal_1_1mail__outbox}{mail\_outbox}})\ +\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{structtbb_1_1internal_1_1arena__slot}{arena\_slot}}));}
\DoxyCodeLine{00302\ \ \ \ \ \}}
\DoxyCodeLine{00303\ }
\DoxyCodeLine{00305\ \ \ \ \ \mbox{\hyperlink{classtbb_1_1internal_1_1mail__outbox}{mail\_outbox}}\&\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_aa0c057046899d3ab934c8aaf66b92673}{mailbox}}(\ \mbox{\hyperlink{namespacetbb_1_1internal_a3e3837fb3ca7bbf4cf4752c58cbed886}{affinity\_id}}\ \textcolor{keywordtype}{id}\ )\ \{}
\DoxyCodeLine{00306\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{tbb__stddef_8h_a7b58d28a34a1717e2ddb591f00658b10}{\_\_TBB\_ASSERT}}(\ 0<\textcolor{keywordtype}{id},\ \textcolor{stringliteral}{"{}affinity\ id\ must\ be\ positive\ integer"{}}\ );}
\DoxyCodeLine{00307\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{tbb__stddef_8h_a7b58d28a34a1717e2ddb591f00658b10}{\_\_TBB\_ASSERT}}(\ \textcolor{keywordtype}{id}\ <=\ my\_num\_slots,\ \textcolor{stringliteral}{"{}affinity\ id\ out\ of\ bounds"{}}\ );}
\DoxyCodeLine{00308\ }
\DoxyCodeLine{00309\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ ((\mbox{\hyperlink{classtbb_1_1internal_1_1mail__outbox}{mail\_outbox}}*)\textcolor{keyword}{this})[-\/(\mbox{\hyperlink{sugar_8h_ae4f82344f573c70aa1066a2394bba345}{int}})\textcolor{keywordtype}{id}];}
\DoxyCodeLine{00310\ \ \ \ \ \}}
\DoxyCodeLine{00311\ }
\DoxyCodeLine{00313\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_a3de7953b535cd3180e421ddb49eb5a50}{free\_arena}}\ ();}
\DoxyCodeLine{00314\ }
\DoxyCodeLine{00315\ \ \ \ \ \textcolor{keyword}{typedef}\ uintptr\_t\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_ab857c6609471eb555d295529945bc738}{pool\_state\_t}};}
\DoxyCodeLine{00316\ }
\DoxyCodeLine{00318\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_ab857c6609471eb555d295529945bc738}{pool\_state\_t}}\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_a06d6b9eb47d6cf8a95f468f410e6769c}{SNAPSHOT\_EMPTY}}\ =\ 0;}
\DoxyCodeLine{00319\ }
\DoxyCodeLine{00321\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_ab857c6609471eb555d295529945bc738}{pool\_state\_t}}\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_a5388bc046062943dcca75cdfeedc1cad}{SNAPSHOT\_FULL}}\ =\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_ab857c6609471eb555d295529945bc738}{pool\_state\_t}}(-\/1);}
\DoxyCodeLine{00322\ }
\DoxyCodeLine{00324\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{unsigned}\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_a3cfbb5823b437dabaaaf99f1bba615be}{ref\_external\_bits}}\ =\ 12;\ \textcolor{comment}{//\ up\ to\ 4095\ external\ and\ 1M\ workers}}
\DoxyCodeLine{00325\ }
\DoxyCodeLine{00327\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{unsigned}\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_a0b9c64f0781f7c6337bc109d9867829a}{ref\_external}}\ =\ 1;}
\DoxyCodeLine{00328\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{unsigned}\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_af7e9255877d3efd5966031efe1fe3edf}{ref\_worker}}\ \ \ =\ 1<<\mbox{\hyperlink{classtbb_1_1internal_1_1arena_a3cfbb5823b437dabaaaf99f1bba615be}{ref\_external\_bits}};}
\DoxyCodeLine{00329\ }
\DoxyCodeLine{00331\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_a3402230064cf16a79b9b2e9874df4d6f}{is\_busy\_or\_empty}}(\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_ab857c6609471eb555d295529945bc738}{pool\_state\_t}}\ \mbox{\hyperlink{main-override_8cpp_a1384e7608274313a9433fa573868557b}{s}}\ )\ \{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{main-override_8cpp_a1384e7608274313a9433fa573868557b}{s}}\ <\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_a5388bc046062943dcca75cdfeedc1cad}{SNAPSHOT\_FULL}};\ \}}
\DoxyCodeLine{00332\ }
\DoxyCodeLine{00334\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_a1aa6d247ff51a1ee9ada4197fdf3abdb}{num\_workers\_active}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00335\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ my\_references\ >>\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_a3cfbb5823b437dabaaaf99f1bba615be}{ref\_external\_bits}};}
\DoxyCodeLine{00336\ \ \ \ \ \}}
\DoxyCodeLine{00337\ }
\DoxyCodeLine{00339\ \ \ \ \ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_a62798c142914ef1e42d6a2b2c7eed643}{is\_recall\_requested}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00340\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_a1aa6d247ff51a1ee9ada4197fdf3abdb}{num\_workers\_active}}()\ >\ my\_num\_workers\_allotted;}
\DoxyCodeLine{00341\ \ \ \ \ \}}
\DoxyCodeLine{00342\ }
\DoxyCodeLine{00344\ \ \ \ \ \textcolor{keyword}{template}<arena::new\_work\_type\ work\_type>\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_a7153d90d34c57f57a5a44495a0c6c30d}{advertise\_new\_work}}();}
\DoxyCodeLine{00345\ }
\DoxyCodeLine{00347\ }
\DoxyCodeLine{00348\ \ \ \ \ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_a9f25e058648c12ff7a0093b30fd79351}{is\_out\_of\_work}}();}
\DoxyCodeLine{00349\ }
\DoxyCodeLine{00351\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_a8b6f5b56aed218f491d9c4f9b4a0bcf6}{enqueue\_task}}(\ task\&,\ intptr\_t,\ \mbox{\hyperlink{classtbb_1_1internal_1_1_fast_random}{FastRandom}}\ \&\ );}
\DoxyCodeLine{00352\ }
\DoxyCodeLine{00354\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_aa5f5c1e842ab59a4e4f127f013578882}{process}}(\ \mbox{\hyperlink{classtbb_1_1internal_1_1generic__scheduler}{generic\_scheduler}}\&\ );}
\DoxyCodeLine{00355\ }
\DoxyCodeLine{00357\ \ \ \ \ \textcolor{keyword}{template}<\textcolor{keywordtype}{unsigned}\ ref\_param>}
\DoxyCodeLine{00358\ \ \ \ \ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_a6bc30944090909d219ac8b95cadc0439}{on\_thread\_leaving}}\ (\ );}
\DoxyCodeLine{00359\ }
\DoxyCodeLine{00360\ \textcolor{preprocessor}{\#if\ \_\_TBB\_STATISTICS}}
\DoxyCodeLine{00362\ \ \ \ \ \textcolor{keywordtype}{void}\ dump\_arena\_statistics\ ();}
\DoxyCodeLine{00363\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{/*\ \_\_TBB\_STATISTICS\ */}\textcolor{preprocessor}{}}
\DoxyCodeLine{00364\ }
\DoxyCodeLine{00365\ \textcolor{preprocessor}{\#if\ \_\_TBB\_TASK\_PRIORITY}}
\DoxyCodeLine{00367\ }
\DoxyCodeLine{00368\ \ \ \ \ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{bool}\ may\_have\_tasks\ (\ \mbox{\hyperlink{classtbb_1_1internal_1_1generic__scheduler}{generic\_scheduler}}*,\ \textcolor{keywordtype}{bool}\&\ tasks\_present,\ \textcolor{keywordtype}{bool}\&\ dequeuing\_possible\ );}
\DoxyCodeLine{00369\ }
\DoxyCodeLine{00371\ \ \ \ \ \textcolor{keywordtype}{void}\ orphan\_offloaded\_tasks\ (\ \mbox{\hyperlink{classtbb_1_1internal_1_1generic__scheduler}{generic\_scheduler}}\&\ \mbox{\hyperlink{main-override_8cpp_a1384e7608274313a9433fa573868557b}{s}}\ );}
\DoxyCodeLine{00372\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{/*\ \_\_TBB\_TASK\_PRIORITY\ */}\textcolor{preprocessor}{}}
\DoxyCodeLine{00373\ }
\DoxyCodeLine{00374\ \textcolor{preprocessor}{\#if\ \_\_TBB\_COUNT\_TASK\_NODES}}
\DoxyCodeLine{00376\ \ \ \ \ intptr\_t\ workers\_task\_node\_count();}
\DoxyCodeLine{00377\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00378\ }
\DoxyCodeLine{00380\ \ \ \ \ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_af08a4622c323ad8863e0008af620b28c}{has\_enqueued\_tasks}}();}
\DoxyCodeLine{00381\ }
\DoxyCodeLine{00382\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_a9ece68a6099229bd2c152b7421851671}{out\_of\_arena}}\ =\ \string~size\_t(0);}
\DoxyCodeLine{00384\ \ \ \ \ \textcolor{keyword}{template}\ <\textcolor{keywordtype}{bool}\ as\_worker>}
\DoxyCodeLine{00385\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_af5ba2478b86e7618cdd0cedfb473121a}{occupy\_free\_slot}}(\ \mbox{\hyperlink{classtbb_1_1internal_1_1generic__scheduler}{generic\_scheduler}}\&\ \mbox{\hyperlink{main-override_8cpp_a1384e7608274313a9433fa573868557b}{s}}\ );}
\DoxyCodeLine{00387\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_a74271175755dfa2e746c23a34e0e42ac}{occupy\_free\_slot\_in\_range}}(\ \mbox{\hyperlink{classtbb_1_1internal_1_1generic__scheduler}{generic\_scheduler}}\&\ \mbox{\hyperlink{main-override_8cpp_a1384e7608274313a9433fa573868557b}{s}},\ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{blas__interface_8hh_a17ae1b83727db4230c8df98b4ee953fc}{lower}},\ \textcolor{keywordtype}{size\_t}\ upper\ );}
\DoxyCodeLine{00388\ }
\DoxyCodeLine{00390\ \ \ \ \ \mbox{\hyperlink{structtbb_1_1internal_1_1arena__slot}{arena\_slot}}\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_a388cbceb772b63b69ee84d775b210504}{my\_slots}}[1];}
\DoxyCodeLine{00391\ \};\ \textcolor{comment}{//\ class\ arena}}
\DoxyCodeLine{00392\ }
\DoxyCodeLine{00393\ \textcolor{keyword}{template}<\textcolor{keywordtype}{unsigned}\ ref\_param>}
\DoxyCodeLine{00394\ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_a6bc30944090909d219ac8b95cadc0439}{arena::on\_thread\_leaving}}\ (\ )\ \{}
\DoxyCodeLine{00395\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00396\ \ \ \ \ \textcolor{comment}{//\ Implementation\ of\ arena\ destruction\ synchronization\ logic\ contained\ various}}
\DoxyCodeLine{00397\ \ \ \ \ \textcolor{comment}{//\ bugs/flaws\ at\ the\ different\ stages\ of\ its\ evolution,\ so\ below\ is\ a\ detailed}}
\DoxyCodeLine{00398\ \ \ \ \ \textcolor{comment}{//\ description\ of\ the\ issues\ taken\ into\ consideration\ in\ the\ framework\ of\ the}}
\DoxyCodeLine{00399\ \ \ \ \ \textcolor{comment}{//\ current\ design.}}
\DoxyCodeLine{00400\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00401\ \ \ \ \ \textcolor{comment}{//\ In\ case\ of\ using\ fire-\/and-\/forget\ tasks\ (scheduled\ via\ task::enqueue())}}
\DoxyCodeLine{00402\ \ \ \ \ \textcolor{comment}{//\ master\ thread\ is\ allowed\ to\ leave\ its\ arena\ before\ all\ its\ work\ is\ executed,}}
\DoxyCodeLine{00403\ \ \ \ \ \textcolor{comment}{//\ and\ market\ may\ temporarily\ revoke\ all\ workers\ from\ this\ arena.\ Since\ revoked}}
\DoxyCodeLine{00404\ \ \ \ \ \textcolor{comment}{//\ workers\ never\ attempt\ to\ reset\ arena\ state\ to\ EMPTY\ and\ cancel\ its\ request}}
\DoxyCodeLine{00405\ \ \ \ \ \textcolor{comment}{//\ to\ RML\ for\ threads,\ the\ arena\ object\ is\ destroyed\ only\ when\ both\ the\ last}}
\DoxyCodeLine{00406\ \ \ \ \ \textcolor{comment}{//\ thread\ is\ leaving\ it\ and\ arena's\ state\ is\ EMPTY\ (that\ is\ its\ master\ thread}}
\DoxyCodeLine{00407\ \ \ \ \ \textcolor{comment}{//\ left\ and\ it\ does\ not\ contain\ any\ work).}}
\DoxyCodeLine{00408\ \ \ \ \ \textcolor{comment}{//\ Thus\ resetting\ arena\ to\ EMPTY\ state\ (as\ earlier\ TBB\ versions\ did)\ should\ not}}
\DoxyCodeLine{00409\ \ \ \ \ \textcolor{comment}{//\ be\ done\ here\ (or\ anywhere\ else\ in\ the\ master\ thread\ to\ that\ matter);\ doing\ so}}
\DoxyCodeLine{00410\ \ \ \ \ \textcolor{comment}{//\ can\ result\ either\ in\ arena's\ premature\ destruction\ (at\ least\ without}}
\DoxyCodeLine{00411\ \ \ \ \ \textcolor{comment}{//\ additional\ costly\ checks\ in\ workers)\ or\ in\ unnecessary\ arena\ state\ changes}}
\DoxyCodeLine{00412\ \ \ \ \ \textcolor{comment}{//\ (and\ ensuing\ workers\ migration).}}
\DoxyCodeLine{00413\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00414\ \ \ \ \ \textcolor{comment}{//\ A\ worker\ that\ checks\ for\ work\ presence\ and\ transitions\ arena\ to\ the\ EMPTY}}
\DoxyCodeLine{00415\ \ \ \ \ \textcolor{comment}{//\ state\ (in\ snapshot\ taking\ procedure\ arena::is\_out\_of\_work())\ updates}}
\DoxyCodeLine{00416\ \ \ \ \ \textcolor{comment}{//\ arena::my\_pool\_state\ first\ and\ only\ then\ arena::my\_num\_workers\_requested.}}
\DoxyCodeLine{00417\ \ \ \ \ \textcolor{comment}{//\ So\ the\ check\ for\ work\ absence\ must\ be\ done\ against\ the\ latter\ field.}}
\DoxyCodeLine{00418\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00419\ \ \ \ \ \textcolor{comment}{//\ In\ a\ time\ window\ between\ decrementing\ the\ active\ threads\ count\ and\ checking}}
\DoxyCodeLine{00420\ \ \ \ \ \textcolor{comment}{//\ if\ there\ is\ an\ outstanding\ request\ for\ workers.\ New\ worker\ thread\ may\ arrive,}}
\DoxyCodeLine{00421\ \ \ \ \ \textcolor{comment}{//\ finish\ remaining\ work,\ set\ arena\ state\ to\ empty,\ and\ leave\ decrementing\ its}}
\DoxyCodeLine{00422\ \ \ \ \ \textcolor{comment}{//\ refcount\ and\ destroying.\ Then\ the\ current\ thread\ will\ destroy\ the\ arena}}
\DoxyCodeLine{00423\ \ \ \ \ \textcolor{comment}{//\ the\ second\ time.\ To\ preclude\ it\ a\ local\ copy\ of\ the\ outstanding\ request}}
\DoxyCodeLine{00424\ \ \ \ \ \textcolor{comment}{//\ value\ can\ be\ stored\ before\ decrementing\ active\ threads\ count.}}
\DoxyCodeLine{00425\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00426\ \ \ \ \ \textcolor{comment}{//\ But\ this\ technique\ may\ cause\ two\ other\ problem.\ When\ the\ stored\ request\ is}}
\DoxyCodeLine{00427\ \ \ \ \ \textcolor{comment}{//\ zero,\ it\ is\ possible\ that\ arena\ still\ has\ threads\ and\ they\ can\ generate\ new}}
\DoxyCodeLine{00428\ \ \ \ \ \textcolor{comment}{//\ tasks\ and\ thus\ re-\/establish\ non-\/zero\ requests.\ Then\ all\ the\ threads\ can\ be}}
\DoxyCodeLine{00429\ \ \ \ \ \textcolor{comment}{//\ revoked\ (as\ described\ above)\ leaving\ this\ thread\ the\ last\ one,\ and\ causing}}
\DoxyCodeLine{00430\ \ \ \ \ \textcolor{comment}{//\ it\ to\ destroy\ non-\/empty\ arena.}}
\DoxyCodeLine{00431\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00432\ \ \ \ \ \textcolor{comment}{//\ The\ other\ problem\ takes\ place\ when\ the\ stored\ request\ is\ non-\/zero.\ Another}}
\DoxyCodeLine{00433\ \ \ \ \ \textcolor{comment}{//\ thread\ may\ complete\ the\ work,\ set\ arena\ state\ to\ empty,\ and\ leave\ without}}
\DoxyCodeLine{00434\ \ \ \ \ \textcolor{comment}{//\ arena\ destruction\ before\ this\ thread\ decrements\ the\ refcount.\ This\ thread}}
\DoxyCodeLine{00435\ \ \ \ \ \textcolor{comment}{//\ cannot\ destroy\ the\ arena\ either.\ Thus\ the\ arena\ may\ be\ "{}orphaned"{}.}}
\DoxyCodeLine{00436\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00437\ \ \ \ \ \textcolor{comment}{//\ In\ both\ cases\ we\ cannot\ dereference\ arena\ pointer\ after\ the\ refcount\ is}}
\DoxyCodeLine{00438\ \ \ \ \ \textcolor{comment}{//\ decremented,\ as\ our\ arena\ may\ already\ be\ destroyed.}}
\DoxyCodeLine{00439\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00440\ \ \ \ \ \textcolor{comment}{//\ If\ this\ is\ the\ master\ thread,\ the\ market\ is\ protected\ by\ refcount\ to\ it.}}
\DoxyCodeLine{00441\ \ \ \ \ \textcolor{comment}{//\ In\ case\ of\ workers\ market's\ liveness\ is\ ensured\ by\ the\ RML\ connection}}
\DoxyCodeLine{00442\ \ \ \ \ \textcolor{comment}{//\ rundown\ protocol,\ according\ to\ which\ the\ client\ (i.e.\ the\ market)\ lives}}
\DoxyCodeLine{00443\ \ \ \ \ \textcolor{comment}{//\ until\ RML\ server\ notifies\ it\ about\ connection\ termination,\ and\ this}}
\DoxyCodeLine{00444\ \ \ \ \ \textcolor{comment}{//\ notification\ is\ fired\ only\ after\ all\ workers\ return\ into\ RML.}}
\DoxyCodeLine{00445\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00446\ \ \ \ \ \textcolor{comment}{//\ Thus\ if\ we\ decremented\ refcount\ to\ zero\ we\ ask\ the\ market\ to\ check\ arena}}
\DoxyCodeLine{00447\ \ \ \ \ \textcolor{comment}{//\ state\ (including\ the\ fact\ if\ it\ is\ alive)\ under\ the\ lock.}}
\DoxyCodeLine{00448\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00449\ \ \ \ \ uintptr\_t\ aba\_epoch\ =\ my\_aba\_epoch;}
\DoxyCodeLine{00450\ \ \ \ \ \mbox{\hyperlink{classtbb_1_1internal_1_1market}{market}}*\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}\ =\ my\_market;}
\DoxyCodeLine{00451\ \ \ \ \ \mbox{\hyperlink{tbb__stddef_8h_a7b58d28a34a1717e2ddb591f00658b10}{\_\_TBB\_ASSERT}}(my\_references\ >=\ ref\_param,\ \textcolor{stringliteral}{"{}broken\ arena\ reference\ counter"{}});}
\DoxyCodeLine{00452\ \textcolor{preprocessor}{\#if\ \_\_TBB\_STATISTICS\_EARLY\_DUMP}}
\DoxyCodeLine{00453\ \ \ \ \ \textcolor{comment}{//\ While\ still\ holding\ a\ reference\ to\ the\ arena,\ compute\ how\ many\ external\ references\ are\ left.}}
\DoxyCodeLine{00454\ \ \ \ \ \textcolor{comment}{//\ If\ just\ one,\ dump\ statistics.}}
\DoxyCodeLine{00455\ \ \ \ \ \textcolor{keywordflow}{if}\ (\ modulo\_power\_of\_two(my\_references,\mbox{\hyperlink{classtbb_1_1internal_1_1arena_af7e9255877d3efd5966031efe1fe3edf}{ref\_worker}})==ref\_param\ )\ \textcolor{comment}{//\ may\ only\ be\ true\ with\ ref\_external}}
\DoxyCodeLine{00456\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{tbb__statistics_8h_a08f1e46bb511c63da3ce07aa9c897bc4}{GATHER\_STATISTIC}}(\ dump\_arena\_statistics()\ );}
\DoxyCodeLine{00457\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00458\ \textcolor{preprocessor}{\#if\ \_\_TBB\_ENQUEUE\_ENFORCED\_CONCURRENCY}}
\DoxyCodeLine{00459\ \ \ \ \ \textcolor{comment}{//\ When\ there\ is\ no\ workers\ someone\ must\ free\ arena,\ as}}
\DoxyCodeLine{00460\ \ \ \ \ \textcolor{comment}{//\ without\ workers,\ no\ one\ calls\ is\_out\_of\_work().}}
\DoxyCodeLine{00461\ \ \ \ \ \textcolor{comment}{//\ Skip\ workerless\ arenas\ because\ they\ have\ no\ demand\ for\ workers.}}
\DoxyCodeLine{00462\ \ \ \ \ \textcolor{comment}{//\ TODO:\ consider\ more\ strict\ conditions\ for\ the\ cleanup,}}
\DoxyCodeLine{00463\ \ \ \ \ \textcolor{comment}{//\ because\ it\ can\ create\ the\ demand\ of\ workers,}}
\DoxyCodeLine{00464\ \ \ \ \ \textcolor{comment}{//\ but\ the\ arena\ can\ be\ already\ empty\ (and\ so\ ready\ for\ destroying)}}
\DoxyCodeLine{00465\ \ \ \ \ \textcolor{comment}{//\ TODO:\ Fix\ the\ race:\ while\ we\ check\ soft\ limit\ and\ it\ might\ be\ changed.}}
\DoxyCodeLine{00466\ \ \ \ \ \textcolor{keywordflow}{if}(\ ref\_param==\mbox{\hyperlink{classtbb_1_1internal_1_1arena_a0b9c64f0781f7c6337bc109d9867829a}{ref\_external}}\ \&\&\ my\_num\_slots\ !=\ my\_num\_reserved\_slots}
\DoxyCodeLine{00467\ \ \ \ \ \ \ \ \ \&\&\ 0\ ==\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}-\/>my\_num\_workers\_soft\_limit\ \&\&\ !my\_global\_concurrency\_mode\ )\ \{}
\DoxyCodeLine{00468\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ is\_out\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00469\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}=0;\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}<\mbox{\hyperlink{namespacetbb_1_1internal_ae1dadab9152ec72bebfb2827c03846e6}{num\_priority\_levels}};\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}++)\ \{}
\DoxyCodeLine{00470\ \ \ \ \ \ \ \ \ \ \ \ \ is\_out\ =\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_a9f25e058648c12ff7a0093b30fd79351}{is\_out\_of\_work}}();}
\DoxyCodeLine{00471\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (is\_out)}
\DoxyCodeLine{00472\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00473\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00474\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ We\ expect,\ that\ in\ worst\ case\ it's\ enough\ to\ have\ num\_priority\_levels-\/1}}
\DoxyCodeLine{00475\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ calls\ to\ restore\ priorities\ and\ yet\ another\ is\_out\_of\_work()\ to\ conform}}
\DoxyCodeLine{00476\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ that\ no\ work\ was\ found.\ But\ as\ market::set\_active\_num\_workers()\ can\ be\ called}}
\DoxyCodeLine{00477\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ concurrently,\ can't\ guarantee\ last\ is\_out\_of\_work()\ return\ true.}}
\DoxyCodeLine{00478\ \ \ \ \ \}}
\DoxyCodeLine{00479\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00480\ \ \ \ \ \textcolor{keywordflow}{if}\ (\ (my\_references\ -\/=\ ref\_param\ )\ ==\ 0\ )}
\DoxyCodeLine{00481\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}-\/>try\_destroy\_arena(\ \textcolor{keyword}{this},\ aba\_epoch\ );}
\DoxyCodeLine{00482\ \}}
\DoxyCodeLine{00483\ }
\DoxyCodeLine{00484\ \textcolor{keyword}{template}<arena::new\_work\_type\ work\_type>\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_a7153d90d34c57f57a5a44495a0c6c30d}{arena::advertise\_new\_work}}()\ \{}
\DoxyCodeLine{00485\ \ \ \ \ \textcolor{keywordflow}{if}(\ work\_type\ ==\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_a2380e7751924d1199ffab7b2ee29ddeea49e498ff35aa2bbce4de87dfd7faab04}{work\_enqueued}}\ )\ \{}
\DoxyCodeLine{00486\ \textcolor{preprocessor}{\#if\ \_\_TBB\_ENQUEUE\_ENFORCED\_CONCURRENCY}}
\DoxyCodeLine{00487\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\ \mbox{\hyperlink{namespacetbb_1_1internal_a958f482f9d5f3476ca70610af5336040}{as\_atomic}}(my\_market-\/>my\_num\_workers\_soft\_limit)\ ==\ 0\ \&\&\ \mbox{\hyperlink{namespacetbb_1_1internal_a958f482f9d5f3476ca70610af5336040}{as\_atomic}}(my\_global\_concurrency\_mode)\ ==\ \textcolor{keyword}{false}\ )}
\DoxyCodeLine{00488\ \ \ \ \ \ \ \ \ \ \ \ \ my\_market-\/>enable\_mandatory\_concurrency(\textcolor{keyword}{this});}
\DoxyCodeLine{00489\ }
\DoxyCodeLine{00490\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\ my\_max\_num\_workers\ ==\ 0\ \&\&\ my\_num\_reserved\_slots\ ==\ 1\ )\ \{}
\DoxyCodeLine{00491\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{tbb__stddef_8h_a7b58d28a34a1717e2ddb591f00658b10}{\_\_TBB\_ASSERT}}(!my\_local\_concurrency\_mode,\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}});}
\DoxyCodeLine{00492\ \ \ \ \ \ \ \ \ \ \ \ \ my\_local\_concurrency\_mode\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00493\ \ \ \ \ \ \ \ \ \ \ \ \ my\_pool\_state\ =\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_a5388bc046062943dcca75cdfeedc1cad}{SNAPSHOT\_FULL}};}
\DoxyCodeLine{00494\ \ \ \ \ \ \ \ \ \ \ \ \ my\_max\_num\_workers\ =\ 1;}
\DoxyCodeLine{00495\ \ \ \ \ \ \ \ \ \ \ \ \ my\_market-\/>adjust\_demand(*\textcolor{keyword}{this},\ my\_max\_num\_workers);}
\DoxyCodeLine{00496\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00497\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00498\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{/*\ \_\_TBB\_ENQUEUE\_ENFORCED\_CONCURRENCY\ */}\textcolor{preprocessor}{}}
\DoxyCodeLine{00499\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Local\ memory\ fence\ here\ and\ below\ is\ required\ to\ avoid\ missed\ wakeups;\ see\ the\ comment\ below.}}
\DoxyCodeLine{00500\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Starvation\ resistant\ tasks\ require\ concurrency,\ so\ missed\ wakeups\ are\ unacceptable.}}
\DoxyCodeLine{00501\ \ \ \ \ \ \ \ \ atomic\_fence();}
\DoxyCodeLine{00502\ \ \ \ \ \}}
\DoxyCodeLine{00503\ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}(\ work\_type\ ==\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_a2380e7751924d1199ffab7b2ee29ddeeac92fe41bfa3a02ea67d83232c9f88b90}{wakeup}}\ )\ \{}
\DoxyCodeLine{00504\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{tbb__stddef_8h_a7b58d28a34a1717e2ddb591f00658b10}{\_\_TBB\_ASSERT}}(my\_max\_num\_workers!=0,\ \textcolor{stringliteral}{"{}Unexpected\ worker\ wakeup\ request"{}});}
\DoxyCodeLine{00505\ \ \ \ \ \ \ \ \ atomic\_fence();}
\DoxyCodeLine{00506\ \ \ \ \ \}}
\DoxyCodeLine{00507\ \ \ \ \ \textcolor{comment}{//\ Double-\/check\ idiom\ that,\ in\ case\ of\ spawning,\ is\ deliberately\ sloppy\ about\ memory\ fences.}}
\DoxyCodeLine{00508\ \ \ \ \ \textcolor{comment}{//\ Technically,\ to\ avoid\ missed\ wakeups,\ there\ should\ be\ a\ full\ memory\ fence\ between\ the\ point\ we}}
\DoxyCodeLine{00509\ \ \ \ \ \textcolor{comment}{//\ released\ the\ task\ pool\ (i.e.\ spawned\ task)\ and\ read\ the\ arena's\ state.\ \ However,\ adding\ such\ a}}
\DoxyCodeLine{00510\ \ \ \ \ \textcolor{comment}{//\ fence\ might\ hurt\ overall\ performance\ more\ than\ it\ helps,\ because\ the\ fence\ would\ be\ executed}}
\DoxyCodeLine{00511\ \ \ \ \ \textcolor{comment}{//\ on\ every\ task\ pool\ release,\ even\ when\ stealing\ does\ not\ occur.\ \ Since\ TBB\ allows\ parallelism,}}
\DoxyCodeLine{00512\ \ \ \ \ \textcolor{comment}{//\ but\ never\ promises\ parallelism,\ the\ missed\ wakeup\ is\ not\ a\ correctness\ problem.}}
\DoxyCodeLine{00513\ \ \ \ \ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_ab857c6609471eb555d295529945bc738}{pool\_state\_t}}\ snapshot\ =\ my\_pool\_state;}
\DoxyCodeLine{00514\ \ \ \ \ \textcolor{keywordflow}{if}(\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_a3402230064cf16a79b9b2e9874df4d6f}{is\_busy\_or\_empty}}(snapshot)\ )\ \{}
\DoxyCodeLine{00515\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Attempt\ to\ mark\ as\ full.\ \ The\ compare\_and\_swap\ below\ is\ a\ little\ unusual\ because\ the}}
\DoxyCodeLine{00516\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ result\ is\ compared\ to\ a\ value\ that\ can\ be\ different\ than\ the\ comparand\ argument.}}
\DoxyCodeLine{00517\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(\ my\_pool\_state.compare\_and\_swap(\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_a5388bc046062943dcca75cdfeedc1cad}{SNAPSHOT\_FULL}},\ snapshot\ )==\mbox{\hyperlink{classtbb_1_1internal_1_1arena_a06d6b9eb47d6cf8a95f468f410e6769c}{SNAPSHOT\_EMPTY}}\ )\ \{}
\DoxyCodeLine{00518\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(\ snapshot!=\mbox{\hyperlink{classtbb_1_1internal_1_1arena_a06d6b9eb47d6cf8a95f468f410e6769c}{SNAPSHOT\_EMPTY}}\ )\ \{}
\DoxyCodeLine{00519\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ This\ thread\ read\ "{}busy"{}\ into\ snapshot,\ and\ then\ another\ thread\ transitioned}}
\DoxyCodeLine{00520\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ my\_pool\_state\ to\ "{}empty"{}\ in\ the\ meantime,\ which\ caused\ the\ compare\_and\_swap\ above}}
\DoxyCodeLine{00521\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ to\ fail.\ \ Attempt\ to\ transition\ my\_pool\_state\ from\ "{}empty"{}\ to\ "{}full"{}.}}
\DoxyCodeLine{00522\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(\ my\_pool\_state.compare\_and\_swap(\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_a5388bc046062943dcca75cdfeedc1cad}{SNAPSHOT\_FULL}},\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_a06d6b9eb47d6cf8a95f468f410e6769c}{SNAPSHOT\_EMPTY}}\ )!=\mbox{\hyperlink{classtbb_1_1internal_1_1arena_a06d6b9eb47d6cf8a95f468f410e6769c}{SNAPSHOT\_EMPTY}}\ )\ \{}
\DoxyCodeLine{00523\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Some\ other\ thread\ transitioned\ my\_pool\_state\ from\ "{}empty"{},\ and\ hence\ became}}
\DoxyCodeLine{00524\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ responsible\ for\ waking\ up\ workers.}}
\DoxyCodeLine{00525\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00526\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00527\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00528\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ This\ thread\ transitioned\ pool\ from\ empty\ to\ full\ state,\ and\ thus\ is\ responsible\ for}}
\DoxyCodeLine{00529\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ telling\ the\ market\ that\ there\ is\ work\ to\ do.}}
\DoxyCodeLine{00530\ \textcolor{preprocessor}{\#if\ \_\_TBB\_ENQUEUE\_ENFORCED\_CONCURRENCY}}
\DoxyCodeLine{00531\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(\ work\_type\ ==\ \mbox{\hyperlink{classtbb_1_1internal_1_1arena_a2380e7751924d1199ffab7b2ee29ddeea2109ea81736367212fa797959b4b4381}{work\_spawned}}\ )\ \{}
\DoxyCodeLine{00532\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(\ my\_local\_concurrency\_mode\ )\ \{}
\DoxyCodeLine{00533\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{tbb__stddef_8h_a7b58d28a34a1717e2ddb591f00658b10}{\_\_TBB\_ASSERT}}(my\_max\_num\_workers==1,\ \textcolor{stringliteral}{"{}"{}});}
\DoxyCodeLine{00534\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{tbb__stddef_8h_a7b58d28a34a1717e2ddb591f00658b10}{\_\_TBB\_ASSERT}}(!\mbox{\hyperlink{classtbb_1_1internal_1_1governor_a3ee947910b77e9ab2f3c02f0d2d63c32}{governor::local\_scheduler}}()-\/>is\_worker(),\ \textcolor{stringliteral}{"{}"{}});}
\DoxyCodeLine{00535\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ There\ was\ deliberate\ oversubscription\ on\ 1\ core\ for\ sake\ of\ starvation-\/resistant\ tasks.}}
\DoxyCodeLine{00536\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Now\ a\ single\ active\ thread\ (must\ be\ the\ master)\ supposedly\ starts\ a\ new\ parallel\ region}}
\DoxyCodeLine{00537\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ with\ relaxed\ sequential\ semantics,\ and\ oversubscription\ should\ be\ avoided.}}
\DoxyCodeLine{00538\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Demand\ for\ workers\ has\ been\ decreased\ to\ 0\ during\ SNAPSHOT\_EMPTY,\ so\ just\ keep\ it.}}
\DoxyCodeLine{00539\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ my\_max\_num\_workers\ =\ 0;}
\DoxyCodeLine{00540\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ my\_local\_concurrency\_mode\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00541\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00542\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00543\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\ \mbox{\hyperlink{namespacetbb_1_1internal_a958f482f9d5f3476ca70610af5336040}{as\_atomic}}(my\_global\_concurrency\_mode)\ ==\ \textcolor{keyword}{true}\ )}
\DoxyCodeLine{00544\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ my\_market-\/>mandatory\_concurrency\_disable(\ \textcolor{keyword}{this}\ );}
\DoxyCodeLine{00545\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00546\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{/*\ \_\_TBB\_ENQUEUE\_ENFORCED\_CONCURRENCY\ */}\textcolor{preprocessor}{}}
\DoxyCodeLine{00547\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ TODO:\ investigate\ adjusting\ of\ arena's\ demand\ by\ a\ single\ worker.}}
\DoxyCodeLine{00548\ \ \ \ \ \ \ \ \ \ \ \ \ my\_market-\/>adjust\_demand(\ *\textcolor{keyword}{this},\ my\_max\_num\_workers\ );}
\DoxyCodeLine{00549\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00550\ \ \ \ \ \}}
\DoxyCodeLine{00551\ \}}
\DoxyCodeLine{00552\ }
\DoxyCodeLine{00553\ \}\ \textcolor{comment}{//\ namespace\ internal}}
\DoxyCodeLine{00554\ \}\ \textcolor{comment}{//\ namespace\ tbb}}
\DoxyCodeLine{00555\ }
\DoxyCodeLine{00556\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{/*\ \_TBB\_arena\_H\ */}\textcolor{preprocessor}{}}

\end{DoxyCode}
