\doxysection{Tensor\+Contraction\+Thread\+Pool.\+h}
\hypertarget{_tensor_contraction_thread_pool_8h_source}{}\label{_tensor_contraction_thread_pool_8h_source}\index{external/taskflow/3rd-\/party/eigen-\/3.3.7/unsupported/Eigen/CXX11/src/Tensor/TensorContractionThreadPool.h@{external/taskflow/3rd-\/party/eigen-\/3.3.7/unsupported/Eigen/CXX11/src/Tensor/TensorContractionThreadPool.h}}
\mbox{\hyperlink{_tensor_contraction_thread_pool_8h}{浏览该文件的文档.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{//\ This\ file\ is\ part\ of\ Eigen,\ a\ lightweight\ C++\ template\ library}}
\DoxyCodeLine{00002\ \textcolor{comment}{//\ for\ linear\ algebra.}}
\DoxyCodeLine{00003\ \textcolor{comment}{//}}
\DoxyCodeLine{00004\ \textcolor{comment}{//\ Copyright\ (C)\ 2014\ Benoit\ Steiner\ <benoit.steiner.goog@gmail.com>}}
\DoxyCodeLine{00005\ \textcolor{comment}{//}}
\DoxyCodeLine{00006\ \textcolor{comment}{//\ This\ Source\ Code\ Form\ is\ subject\ to\ the\ terms\ of\ the\ Mozilla}}
\DoxyCodeLine{00007\ \textcolor{comment}{//\ Public\ License\ v.\ 2.0.\ If\ a\ copy\ of\ the\ MPL\ was\ not\ distributed}}
\DoxyCodeLine{00008\ \textcolor{comment}{//\ with\ this\ file,\ You\ can\ obtain\ one\ at\ http://mozilla.org/MPL/2.0/.}}
\DoxyCodeLine{00009\ }
\DoxyCodeLine{00010\ \textcolor{preprocessor}{\#ifndef\ EIGEN\_CXX11\_TENSOR\_TENSOR\_CONTRACTION\_THREAD\_POOL\_H}}
\DoxyCodeLine{00011\ \textcolor{preprocessor}{\#define\ EIGEN\_CXX11\_TENSOR\_TENSOR\_CONTRACTION\_THREAD\_POOL\_H}}
\DoxyCodeLine{00012\ }
\DoxyCodeLine{00013\ \textcolor{comment}{//\ evaluator\ for\ thread\ pool\ device}}
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#ifdef\ EIGEN\_USE\_THREADS}}
\DoxyCodeLine{00015\ }
\DoxyCodeLine{00016\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespace_eigen}{Eigen}}\ \{}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#ifdef\ EIGEN\_USE\_SIMPLE\_THREAD\_POOL}}
\DoxyCodeLine{00019\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespace_eigen_1_1internal}{internal}}\ \{}
\DoxyCodeLine{00020\ }
\DoxyCodeLine{00021\ \textcolor{keyword}{template}<\textcolor{keyword}{typename}\ LhsScalar,\ \textcolor{keyword}{typename}\ LhsMapper,\ \textcolor{keyword}{typename}\ Index>}
\DoxyCodeLine{00022\ \textcolor{keyword}{struct\ }packLhsArg\ \{}
\DoxyCodeLine{00023\ \ \ LhsScalar*\ blockA;}
\DoxyCodeLine{00024\ \ \ \textcolor{keyword}{const}\ LhsMapper\&\ lhs;}
\DoxyCodeLine{00025\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ m\_start;}
\DoxyCodeLine{00026\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ k\_start;}
\DoxyCodeLine{00027\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ mc;}
\DoxyCodeLine{00028\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ kc;}
\DoxyCodeLine{00029\ \};}
\DoxyCodeLine{00030\ }
\DoxyCodeLine{00031\ \textcolor{keyword}{template}<\textcolor{keyword}{typename}\ LhsScalar,\ \textcolor{keyword}{typename}\ RhsScalar,\ \textcolor{keyword}{typename}\ RhsMapper,\ \textcolor{keyword}{typename}\ OutputMapper,\ \textcolor{keyword}{typename}\ Index>}
\DoxyCodeLine{00032\ \textcolor{keyword}{struct\ }packRhsAndKernelArg\ \{}
\DoxyCodeLine{00033\ \ \ \textcolor{keyword}{const}\ MaxSizeVector<LhsScalar*>*\ blockAs;}
\DoxyCodeLine{00034\ \ \ RhsScalar*\ blockB;}
\DoxyCodeLine{00035\ \ \ \textcolor{keyword}{const}\ RhsMapper\&\ \mbox{\hyperlink{poisson_8cpp_a38c677f5cc4e47bc7505aef707c1bb83}{rhs}};}
\DoxyCodeLine{00036\ \ \ OutputMapper\&\ \mbox{\hyperlink{benchmarks_2scan_2scan_8hpp_a8390452002ecc7a0dadc5ae0dccc9b6c}{output}};}
\DoxyCodeLine{00037\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}};}
\DoxyCodeLine{00038\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ k;}
\DoxyCodeLine{00039\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}};}
\DoxyCodeLine{00040\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ mc;}
\DoxyCodeLine{00041\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ kc;}
\DoxyCodeLine{00042\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ nc;}
\DoxyCodeLine{00043\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ num\_threads;}
\DoxyCodeLine{00044\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ num\_blockAs;}
\DoxyCodeLine{00045\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ max\_m;}
\DoxyCodeLine{00046\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ k\_block\_idx;}
\DoxyCodeLine{00047\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ m\_block\_idx;}
\DoxyCodeLine{00048\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ n\_block\_idx;}
\DoxyCodeLine{00049\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ m\_blocks;}
\DoxyCodeLine{00050\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ n\_blocks;}
\DoxyCodeLine{00051\ \ \ MaxSizeVector<Notification*>*\ kernel\_notifications;}
\DoxyCodeLine{00052\ \ \ \textcolor{keyword}{const}\ MaxSizeVector<Notification*>*\ lhs\_notifications;}
\DoxyCodeLine{00053\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{bool}\ need\_to\_pack;}
\DoxyCodeLine{00054\ \};}
\DoxyCodeLine{00055\ }
\DoxyCodeLine{00056\ \}\ \ \textcolor{comment}{//\ end\ namespace\ internal}}
\DoxyCodeLine{00057\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ EIGEN\_USE\_SIMPLE\_THREAD\_POOL}}
\DoxyCodeLine{00058\ }
\DoxyCodeLine{00059\ \textcolor{keyword}{template}<\textcolor{keyword}{typename}\ Indices,\ \textcolor{keyword}{typename}\ LeftArgType,\ \textcolor{keyword}{typename}\ RightArgType>}
\DoxyCodeLine{00060\ \textcolor{keyword}{struct\ }\mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator}{TensorEvaluator}}<const\ \mbox{\hyperlink{class_eigen_1_1_tensor_contraction_op}{TensorContractionOp}}<Indices,\ LeftArgType,\ RightArgType>,\ ThreadPoolDevice>\ :}
\DoxyCodeLine{00061\ \ \ \ \ \textcolor{keyword}{public}\ \mbox{\hyperlink{struct_eigen_1_1_tensor_contraction_evaluator_base}{TensorContractionEvaluatorBase}}<TensorEvaluator<const\ TensorContractionOp<Indices,\ LeftArgType,\ RightArgType>,\ ThreadPoolDevice>\ >\ \{}
\DoxyCodeLine{00062\ }
\DoxyCodeLine{00063\ \ \ \textcolor{keyword}{typedef}\ ThreadPoolDevice\ Device;}
\DoxyCodeLine{00064\ }
\DoxyCodeLine{00065\ \ \ \textcolor{keyword}{typedef}\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a43bea98dc719e3b6ac73ab2df0291455}{TensorEvaluator<const\ TensorContractionOp<Indices,\ LeftArgType,\ RightArgType>}},\ Device>\ Self;}
\DoxyCodeLine{00066\ \ \ \textcolor{keyword}{typedef}\ TensorContractionEvaluatorBase<Self>\ Base;}
\DoxyCodeLine{00067\ }
\DoxyCodeLine{00068\ \ \ \textcolor{keyword}{typedef}\ TensorContractionOp<Indices,\ LeftArgType,\ RightArgType>\ XprType;}
\DoxyCodeLine{00069\ \ \ \textcolor{keyword}{typedef}\ \textcolor{keyword}{typename}\ \mbox{\hyperlink{struct_eigen_1_1internal_1_1remove__const_afe3dbb0bdee2ec8eed4416723d75bc90}{internal::remove\_const<typename\ XprType::Scalar>::type}}\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a163cadb184cc08462355caf1031115a4}{Scalar}};}
\DoxyCodeLine{00070\ \ \ \textcolor{keyword}{typedef}\ \textcolor{keyword}{typename}\ XprType::Index\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}};}
\DoxyCodeLine{00071\ \ \ \textcolor{keyword}{typedef}\ \textcolor{keyword}{typename}\ XprType::CoeffReturnType\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a664eb29b0c38061939b400fbc551c580}{CoeffReturnType}};}
\DoxyCodeLine{00072\ \ \ \textcolor{keyword}{typedef}\ \textcolor{keyword}{typename}\ \mbox{\hyperlink{struct_eigen_1_1_packet_type_a3408a66e0894db9cb51e39dbf4fe9f0f}{PacketType<CoeffReturnType,\ Device>::type}}\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a5ffb21f50e4fbd0d4d9cef40e148cc5e}{PacketReturnType}};}
\DoxyCodeLine{00073\ }
\DoxyCodeLine{00074\ \ \ \textcolor{keyword}{enum}\ \{}
\DoxyCodeLine{00075\ \ \ \ \ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a505fb36fcf4b16dcedf95e9d8e4d4ac2aaea01fe7598d6c1941853b693ec9f162}{Layout}}\ =\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a43bea98dc719e3b6ac73ab2df0291455}{TensorEvaluator<LeftArgType,\ Device>::Layout}},}
\DoxyCodeLine{00076\ \ \ \};}
\DoxyCodeLine{00077\ }
\DoxyCodeLine{00078\ \ \ \textcolor{comment}{//\ Most\ of\ the\ code\ is\ assuming\ that\ both\ input\ tensors\ are\ ColMajor.\ If\ the}}
\DoxyCodeLine{00079\ \ \ \textcolor{comment}{//\ inputs\ are\ RowMajor,\ we\ will\ "{}cheat"{}\ by\ swapping\ the\ LHS\ and\ RHS:}}
\DoxyCodeLine{00080\ \ \ \textcolor{comment}{//\ If\ we\ want\ to\ compute\ A\ *\ B\ =\ C,\ where\ A\ is\ LHS\ and\ B\ is\ RHS,\ the\ code}}
\DoxyCodeLine{00081\ \ \ \textcolor{comment}{//\ will\ pretend\ B\ is\ LHS\ and\ A\ is\ RHS.}}
\DoxyCodeLine{00082\ \ \ \textcolor{keyword}{typedef}\ \textcolor{keyword}{typename}\ internal::conditional<}
\DoxyCodeLine{00083\ \ \ \ \ \textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{int}\textcolor{keyword}{>}(\mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a505fb36fcf4b16dcedf95e9d8e4d4ac2aaea01fe7598d6c1941853b693ec9f162}{Layout}})\ ==\ \textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{int}\textcolor{keyword}{>}(\mbox{\hyperlink{group__enums_ggaacded1a18ae58b0f554751f6cdf9eb13a0103672ae41005ab03b4176c765afd62}{ColMajor}}),\ LeftArgType,\ RightArgType>\mbox{\hyperlink{imgui__impl__opengl3__loader_8h_ae8396ff85d63082521e3324820df1009}{::type}}\ EvalLeftArgType;}
\DoxyCodeLine{00084\ \ \ \textcolor{keyword}{typedef}\ \textcolor{keyword}{typename}\ internal::conditional<}
\DoxyCodeLine{00085\ \ \ \ \ \textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{int}\textcolor{keyword}{>}(\mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a505fb36fcf4b16dcedf95e9d8e4d4ac2aaea01fe7598d6c1941853b693ec9f162}{Layout}})\ ==\ \textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{int}\textcolor{keyword}{>}(\mbox{\hyperlink{group__enums_ggaacded1a18ae58b0f554751f6cdf9eb13a0103672ae41005ab03b4176c765afd62}{ColMajor}}),\ RightArgType,\ LeftArgType>\mbox{\hyperlink{imgui__impl__opengl3__loader_8h_ae8396ff85d63082521e3324820df1009}{::type}}\ EvalRightArgType;}
\DoxyCodeLine{00086\ }
\DoxyCodeLine{00087\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ LDims\ =}
\DoxyCodeLine{00088\ \ \ \ \ \ \ internal::array\_size<typename\ TensorEvaluator<EvalLeftArgType,\ Device>::Dimensions>\mbox{\hyperlink{imgui__impl__opengl3__loader_8h_abe8e049f756b5ba547bda825af81b645}{::value}};}
\DoxyCodeLine{00089\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ RDims\ =}
\DoxyCodeLine{00090\ \ \ \ \ \ \ internal::array\_size<typename\ TensorEvaluator<EvalRightArgType,\ Device>::Dimensions>\mbox{\hyperlink{imgui__impl__opengl3__loader_8h_abe8e049f756b5ba547bda825af81b645}{::value}};}
\DoxyCodeLine{00091\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ ContractDims\ =\ internal::array\_size<Indices>::value;}
\DoxyCodeLine{00092\ }
\DoxyCodeLine{00093\ \ \ \textcolor{keyword}{typedef}\ \mbox{\hyperlink{sugar_8h_af6228a2253f88b2affbe0c54d8b5b321}{array<Index,\ LDims>}}\ left\_dim\_mapper\_t;}
\DoxyCodeLine{00094\ \ \ \textcolor{keyword}{typedef}\ \mbox{\hyperlink{sugar_8h_af6228a2253f88b2affbe0c54d8b5b321}{array<Index,\ RDims>}}\ right\_dim\_mapper\_t;}
\DoxyCodeLine{00095\ }
\DoxyCodeLine{00096\ \ \ \textcolor{keyword}{typedef}\ array<Index,\ ContractDims>\ contract\_t;}
\DoxyCodeLine{00097\ \ \ \textcolor{keyword}{typedef}\ \mbox{\hyperlink{sugar_8h_af6228a2253f88b2affbe0c54d8b5b321}{array}}<\mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}},\ LDims\ -\/\ ContractDims>\ left\_nocontract\_t;}
\DoxyCodeLine{00098\ \ \ \textcolor{keyword}{typedef}\ \mbox{\hyperlink{sugar_8h_af6228a2253f88b2affbe0c54d8b5b321}{array}}<\mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}},\ RDims\ -\/\ ContractDims>\ right\_nocontract\_t;}
\DoxyCodeLine{00099\ }
\DoxyCodeLine{00100\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ NumDims\ =\ LDims\ +\ RDims\ -\/\ 2\ *\ ContractDims;}
\DoxyCodeLine{00101\ }
\DoxyCodeLine{00102\ \ \ \textcolor{keyword}{typedef}\ DSizes<Index,\ NumDims>\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_ac4139a59583bb1e6385d3a0195548b6b}{Dimensions}};}
\DoxyCodeLine{00103\ }
\DoxyCodeLine{00104\ \ \ \textcolor{comment}{//\ typedefs\ needed\ in\ evalTo}}
\DoxyCodeLine{00105\ \ \ \textcolor{keyword}{typedef}\ \textcolor{keyword}{typename}\ \mbox{\hyperlink{struct_eigen_1_1internal_1_1remove__const_afe3dbb0bdee2ec8eed4416723d75bc90}{internal::remove\_const<typename\ EvalLeftArgType::Scalar>::type}}\ LhsScalar;}
\DoxyCodeLine{00106\ \ \ \textcolor{keyword}{typedef}\ \textcolor{keyword}{typename}\ \mbox{\hyperlink{struct_eigen_1_1internal_1_1remove__const_afe3dbb0bdee2ec8eed4416723d75bc90}{internal::remove\_const<typename\ EvalRightArgType::Scalar>::type}}\ RhsScalar;}
\DoxyCodeLine{00107\ \ \ \textcolor{keyword}{typedef}\ \textcolor{keyword}{typename}\ internal::gebp\_traits<LhsScalar,\ RhsScalar>\ Traits;}
\DoxyCodeLine{00108\ }
\DoxyCodeLine{00109\ \ \ \textcolor{keyword}{typedef}\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a43bea98dc719e3b6ac73ab2df0291455}{TensorEvaluator<EvalLeftArgType,\ Device>}}\ LeftEvaluator;}
\DoxyCodeLine{00110\ \ \ \textcolor{keyword}{typedef}\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a43bea98dc719e3b6ac73ab2df0291455}{TensorEvaluator<EvalRightArgType,\ Device>}}\ RightEvaluator;}
\DoxyCodeLine{00111\ }
\DoxyCodeLine{00112\ \ \ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a43bea98dc719e3b6ac73ab2df0291455}{TensorEvaluator}}(\textcolor{keyword}{const}\ XprType\&\ op,\ \textcolor{keyword}{const}\ Device\&\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_aa1eb26b743a6cafedceb567036276d4e}{device}})\ :}
\DoxyCodeLine{00113\ \ \ \ \ \ \ Base(op,\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_aa1eb26b743a6cafedceb567036276d4e}{device}})\ \{\}}
\DoxyCodeLine{00114\ }
\DoxyCodeLine{00115\ \textcolor{preprocessor}{\#ifndef\ EIGEN\_USE\_SIMPLE\_THREAD\_POOL}}
\DoxyCodeLine{00116\ \ \ \textcolor{keyword}{template}\ <\textcolor{keywordtype}{bool}\ lhs\_inner\_dim\_contiguous,\ \textcolor{keywordtype}{bool}\ rhs\_inner\_dim\_contiguous,}
\DoxyCodeLine{00117\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ rhs\_inner\_dim\_reordered,\ \textcolor{keywordtype}{int}\ Alignment>}
\DoxyCodeLine{00118\ \ \ \textcolor{keywordtype}{void}\ evalProduct(\mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a163cadb184cc08462355caf1031115a4}{Scalar}}*\ \mbox{\hyperlink{sugar_8h_aaadc06b5dac8070de2c8677210967bdb}{buffer}})\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00119\ \ \ \ \ \textcolor{keyword}{typedef}\ internal::TensorContractionInputMapper<}
\DoxyCodeLine{00120\ \ \ \ \ \ \ \ \ LhsScalar,\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}},\ \mbox{\hyperlink{namespace_eigen_1_1internal_a091d923f61a5d455b1573e17b015adf9a1a7f4ccbeaf23168b50a83680f8f35fb}{internal::Lhs}},\ LeftEvaluator,\ left\_nocontract\_t,}
\DoxyCodeLine{00121\ \ \ \ \ \ \ \ \ contract\_t,\ \mbox{\hyperlink{struct_eigen_1_1internal_1_1packet__traits_a1a7c1c7a8ae861f1a84a32c3982b8fe0a60adf1b5b0dbd4b0ae81fe0b70b9d9eb}{internal::packet\_traits<LhsScalar>::size}},}
\DoxyCodeLine{00122\ \ \ \ \ \ \ \ \ lhs\_inner\_dim\_contiguous,\ \textcolor{keyword}{false},\ \mbox{\hyperlink{group__enums_gga45fe06e29902b7a2773de05ba27b47a1a4e19dd09d5ff42295ba1d72d12a46686}{Unaligned}}>}
\DoxyCodeLine{00123\ \ \ \ \ \ \ \ \ LhsMapper;}
\DoxyCodeLine{00124\ \ \ \ \ \textcolor{keyword}{typedef}\ internal::TensorContractionInputMapper<}
\DoxyCodeLine{00125\ \ \ \ \ \ \ \ \ RhsScalar,\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}},\ \mbox{\hyperlink{namespace_eigen_1_1internal_a091d923f61a5d455b1573e17b015adf9a6c8de80f9984c6a6da22b7c288fee57d}{internal::Rhs}},\ RightEvaluator,\ right\_nocontract\_t,}
\DoxyCodeLine{00126\ \ \ \ \ \ \ \ \ contract\_t,\ \mbox{\hyperlink{struct_eigen_1_1internal_1_1packet__traits_a1a7c1c7a8ae861f1a84a32c3982b8fe0a60adf1b5b0dbd4b0ae81fe0b70b9d9eb}{internal::packet\_traits<RhsScalar>::size}},}
\DoxyCodeLine{00127\ \ \ \ \ \ \ \ \ rhs\_inner\_dim\_contiguous,\ rhs\_inner\_dim\_reordered,\ \mbox{\hyperlink{group__enums_gga45fe06e29902b7a2773de05ba27b47a1a4e19dd09d5ff42295ba1d72d12a46686}{Unaligned}}>}
\DoxyCodeLine{00128\ \ \ \ \ \ \ \ \ RhsMapper;}
\DoxyCodeLine{00129\ \ \ \ \ \textcolor{keyword}{typedef}\ internal::blas\_data\_mapper<Scalar,\ Index,\ ColMajor>\ OutputMapper;}
\DoxyCodeLine{00130\ \ \ \ \ \textcolor{keyword}{typedef}\ internal::gemm\_pack\_lhs<LhsScalar,\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}},}
\DoxyCodeLine{00131\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{typename}\ LhsMapper::SubMapper,\ Traits::mr,}
\DoxyCodeLine{00132\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Traits::LhsProgress,\ \mbox{\hyperlink{group__enums_ggaacded1a18ae58b0f554751f6cdf9eb13a0103672ae41005ab03b4176c765afd62}{ColMajor}}>}
\DoxyCodeLine{00133\ \ \ \ \ \ \ \ \ LhsPacker;}
\DoxyCodeLine{00134\ \ \ \ \ \textcolor{keyword}{typedef}\ internal::gemm\_pack\_rhs<}
\DoxyCodeLine{00135\ \ \ \ \ \ \ \ \ RhsScalar,\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}},\ \textcolor{keyword}{typename}\ RhsMapper::SubMapper,\ Traits::nr,\ \mbox{\hyperlink{group__enums_ggaacded1a18ae58b0f554751f6cdf9eb13a0103672ae41005ab03b4176c765afd62}{ColMajor}}>}
\DoxyCodeLine{00136\ \ \ \ \ \ \ \ \ RhsPacker;}
\DoxyCodeLine{00137\ \ \ \ \ \textcolor{keyword}{typedef}\ internal::gebp\_kernel<LhsScalar,\ RhsScalar,\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}},\ OutputMapper,}
\DoxyCodeLine{00138\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Traits::mr,\ Traits::nr,\ \textcolor{keyword}{false},\ \textcolor{keyword}{false}>}
\DoxyCodeLine{00139\ \ \ \ \ \ \ \ \ GebpKernel;}
\DoxyCodeLine{00140\ }
\DoxyCodeLine{00141\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}\ =\ this-\/>m\_i\_size;}
\DoxyCodeLine{00142\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}}\ =\ this-\/>m\_j\_size;}
\DoxyCodeLine{00143\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ k\ =\ this-\/>m\_k\_size;}
\DoxyCodeLine{00144\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}\ ==\ 0\ ||\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}}\ ==\ 0\ ||\ k\ ==\ 0)\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00145\ }
\DoxyCodeLine{00146\ \ \ \ \ \textcolor{comment}{//\ Compute\ a\ set\ of\ algorithm\ parameters:}}
\DoxyCodeLine{00147\ \ \ \ \ \textcolor{comment}{//\ -\/\ kernel\ block\ sizes\ (bm,\ bn,\ bk)}}
\DoxyCodeLine{00148\ \ \ \ \ \textcolor{comment}{//\ -\/\ task\ grain\ sizes\ (number\ of\ kernels\ executed\ per\ task:\ gm,\ gn)}}
\DoxyCodeLine{00149\ \ \ \ \ \textcolor{comment}{//\ -\/\ number\ of\ threads}}
\DoxyCodeLine{00150\ \ \ \ \ \textcolor{comment}{//\ -\/\ sharding\ by\ row/column}}
\DoxyCodeLine{00151\ \ \ \ \ \textcolor{comment}{//\ -\/\ parallel\ packing\ or\ first\ lhs\ then\ rhs}}
\DoxyCodeLine{00152\ \ \ \ \ \textcolor{comment}{//\ and\ some\ derived\ parameters:}}
\DoxyCodeLine{00153\ \ \ \ \ \textcolor{comment}{//\ -\/\ number\ of\ tasks\ (nm,\ nn,\ nk)}}
\DoxyCodeLine{00154\ \ \ \ \ \textcolor{comment}{//\ -\/\ number\ of\ kernels\ (nm0,\ nn0)}}
\DoxyCodeLine{00155\ \ \ \ \ \textcolor{comment}{//\ Unfortunately,\ all\ these\ parameters\ are\ tightly\ interdependent.}}
\DoxyCodeLine{00156\ \ \ \ \ \textcolor{comment}{//\ So\ in\ some\ cases\ we\ first\ compute\ approximate\ values,\ then\ compute\ other}}
\DoxyCodeLine{00157\ \ \ \ \ \textcolor{comment}{//\ values\ based\ on\ these\ approximations\ and\ then\ refine\ the\ approximations.}}
\DoxyCodeLine{00158\ }
\DoxyCodeLine{00159\ \ \ \ \ \textcolor{comment}{//\ There\ are\ lots\ of\ heuristics\ here.\ There\ is\ some\ reasoning\ behind\ them,}}
\DoxyCodeLine{00160\ \ \ \ \ \textcolor{comment}{//\ but\ ultimately\ they\ are\ just\ tuned\ on\ contraction\ benchmarks\ for}}
\DoxyCodeLine{00161\ \ \ \ \ \textcolor{comment}{//\ different\ input\ configurations,\ thread\ counts\ and\ instruction\ sets.}}
\DoxyCodeLine{00162\ \ \ \ \ \textcolor{comment}{//\ So\ feel\ free\ to\ question\ any\ of\ them.}}
\DoxyCodeLine{00163\ }
\DoxyCodeLine{00164\ \ \ \ \ \textcolor{comment}{//\ Compute\ whether\ we\ want\ to\ shard\ by\ row\ or\ by\ column.}}
\DoxyCodeLine{00165\ \ \ \ \ \textcolor{comment}{//\ This\ is\ a\ first\ approximation,\ it\ will\ be\ refined\ later.\ Since\ we\ don't}}
\DoxyCodeLine{00166\ \ \ \ \ \textcolor{comment}{//\ know\ number\ of\ threads\ yet\ we\ use\ 2,\ because\ what's\ we\ are\ most}}
\DoxyCodeLine{00167\ \ \ \ \ \textcolor{comment}{//\ interested\ in\ at\ this\ point\ is\ whether\ it\ makes\ sense\ to\ use}}
\DoxyCodeLine{00168\ \ \ \ \ \textcolor{comment}{//\ parallelization\ at\ all\ or\ not.}}
\DoxyCodeLine{00169\ \ \ \ \ \textcolor{keywordtype}{bool}\ shard\_by\_col\ =\ shardByCol(\mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}},\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}},\ 2);}
\DoxyCodeLine{00170\ }
\DoxyCodeLine{00171\ \ \ \ \ \textcolor{comment}{//\ First\ approximation\ of\ kernel\ blocking\ sizes.}}
\DoxyCodeLine{00172\ \ \ \ \ \textcolor{comment}{//\ Again,\ we\ don't\ know\ number\ of\ threads\ yet,\ so\ we\ use\ 2.}}
\DoxyCodeLine{00173\ \ \ \ \ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ bm,\ bn,\ bk;}
\DoxyCodeLine{00174\ \ \ \ \ \textcolor{keywordflow}{if}\ (shard\_by\_col)\ \{}
\DoxyCodeLine{00175\ \ \ \ \ \ \ internal::TensorContractionBlocking<LhsMapper,\ RhsMapper,\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}},}
\DoxyCodeLine{00176\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_eigen_1_1internal_adfbb8be5aab34f3d52a1c4a8d7ba85b1a4880b90fa231e2d819d4e8303c09ccdc}{internal::ShardByCol}}>}
\DoxyCodeLine{00177\ \ \ \ \ \ \ \ \ \ \ blocking(k,\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}},\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}},\ 2);}
\DoxyCodeLine{00178\ \ \ \ \ \ \ bm\ =\ blocking.mc();}
\DoxyCodeLine{00179\ \ \ \ \ \ \ bn\ =\ blocking.nc();}
\DoxyCodeLine{00180\ \ \ \ \ \ \ bk\ =\ blocking.kc();}
\DoxyCodeLine{00181\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00182\ \ \ \ \ \ \ internal::TensorContractionBlocking<LhsMapper,\ RhsMapper,\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}},}
\DoxyCodeLine{00183\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_eigen_1_1internal_adfbb8be5aab34f3d52a1c4a8d7ba85b1af9cde5417288c6e829f4d62a2033f93a}{internal::ShardByRow}}>}
\DoxyCodeLine{00184\ \ \ \ \ \ \ \ \ \ \ blocking(k,\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}},\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}},\ 2);}
\DoxyCodeLine{00185\ \ \ \ \ \ \ bm\ =\ blocking.mc();}
\DoxyCodeLine{00186\ \ \ \ \ \ \ bn\ =\ blocking.nc();}
\DoxyCodeLine{00187\ \ \ \ \ \ \ bk\ =\ blocking.kc();}
\DoxyCodeLine{00188\ \ \ \ \ \}}
\DoxyCodeLine{00189\ }
\DoxyCodeLine{00190\ \ \ \ \ \textcolor{comment}{//\ Compute\ optimal\ number\ of\ threads.}}
\DoxyCodeLine{00191\ \ \ \ \ \textcolor{comment}{//\ Note:\ we\ use\ bk\ instead\ of\ k\ here\ because\ we\ are\ interested\ in\ amount\ of}}
\DoxyCodeLine{00192\ \ \ \ \ \textcolor{comment}{//\ \_parallelizable\_\ computations,\ and\ computations\ are\ not\ parallelizable}}
\DoxyCodeLine{00193\ \ \ \ \ \textcolor{comment}{//\ across\ k\ dimension.}}
\DoxyCodeLine{00194\ \ \ \ \ \textcolor{keyword}{const}\ TensorOpCost\ cost\ =}
\DoxyCodeLine{00195\ \ \ \ \ \ \ \ \ contractionCost(\mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}},\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}},\ bm,\ bn,\ bk,\ shard\_by\_col,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00196\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_threads\ =\ \mbox{\hyperlink{class_eigen_1_1_tensor_cost_model_a718b68d6a884d2c862b5dc3c4c3f5ab4}{TensorCostModel<ThreadPoolDevice>::numThreads}}(}
\DoxyCodeLine{00197\ \ \ \ \ \ \ \ \ \textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{double}\textcolor{keyword}{>}(\mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}})\ *\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}},\ cost,\ this-\/>\mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a13eb5009d2c2e60155de55e7c3d2bd6f}{m\_device}}.numThreads());}
\DoxyCodeLine{00198\ }
\DoxyCodeLine{00199\ \ \ \ \ \textcolor{comment}{//\ TODO(dvyukov):\ this\ is\ a\ stop-\/gap\ to\ prevent\ regressions\ while\ the\ cost}}
\DoxyCodeLine{00200\ \ \ \ \ \textcolor{comment}{//\ model\ is\ not\ tuned.\ Remove\ this\ when\ the\ cost\ model\ is\ tuned.}}
\DoxyCodeLine{00201\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}}\ ==\ 1)\ num\_threads\ =\ 1;}
\DoxyCodeLine{00202\ }
\DoxyCodeLine{00203\ \ \ \ \ \textcolor{keywordflow}{if}\ (num\_threads\ ==\ 1)\ \{}
\DoxyCodeLine{00204\ \ \ \ \ \ \ \textcolor{comment}{//\ The\ single-\/threaded\ algorithm\ should\ be\ faster\ in\ this\ case.}}
\DoxyCodeLine{00205\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}}\ ==\ 1)}
\DoxyCodeLine{00206\ \ \ \ \ \ \ \ \ this-\/>\textcolor{keyword}{template}\ evalGemv<lhs\_inner\_dim\_contiguous,}
\DoxyCodeLine{00207\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ rhs\_inner\_dim\_contiguous,}
\DoxyCodeLine{00208\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ rhs\_inner\_dim\_reordered,\ Alignment>(\mbox{\hyperlink{sugar_8h_aaadc06b5dac8070de2c8677210967bdb}{buffer}});}
\DoxyCodeLine{00209\ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{00210\ \ \ \ \ \ \ \ \ this-\/>\textcolor{keyword}{template}\ evalGemm<lhs\_inner\_dim\_contiguous,}
\DoxyCodeLine{00211\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ rhs\_inner\_dim\_contiguous,}
\DoxyCodeLine{00212\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ rhs\_inner\_dim\_reordered,\ Alignment>(\mbox{\hyperlink{sugar_8h_aaadc06b5dac8070de2c8677210967bdb}{buffer}});}
\DoxyCodeLine{00213\ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00214\ \ \ \ \ \}}
\DoxyCodeLine{00215\ }
\DoxyCodeLine{00216\ \ \ \ \ \textcolor{comment}{//\ Now\ that\ we\ know\ number\ of\ threads,\ recalculate\ sharding\ and\ blocking.}}
\DoxyCodeLine{00217\ \ \ \ \ shard\_by\_col\ =\ shardByCol(\mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}},\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}},\ num\_threads);}
\DoxyCodeLine{00218\ \ \ \ \ \textcolor{keywordflow}{if}\ (shard\_by\_col)\ \{}
\DoxyCodeLine{00219\ \ \ \ \ \ \ internal::TensorContractionBlocking<LhsMapper,\ RhsMapper,\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}},}
\DoxyCodeLine{00220\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_eigen_1_1internal_adfbb8be5aab34f3d52a1c4a8d7ba85b1a4880b90fa231e2d819d4e8303c09ccdc}{internal::ShardByCol}}>}
\DoxyCodeLine{00221\ \ \ \ \ \ \ \ \ \ \ blocking(k,\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}},\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}},\ num\_threads);}
\DoxyCodeLine{00222\ \ \ \ \ \ \ bm\ =\ blocking.mc();}
\DoxyCodeLine{00223\ \ \ \ \ \ \ bn\ =\ blocking.nc();}
\DoxyCodeLine{00224\ \ \ \ \ \ \ bk\ =\ blocking.kc();}
\DoxyCodeLine{00225\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00226\ \ \ \ \ \ \ internal::TensorContractionBlocking<LhsMapper,\ RhsMapper,\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}},}
\DoxyCodeLine{00227\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_eigen_1_1internal_adfbb8be5aab34f3d52a1c4a8d7ba85b1af9cde5417288c6e829f4d62a2033f93a}{internal::ShardByRow}}>}
\DoxyCodeLine{00228\ \ \ \ \ \ \ \ \ \ \ blocking(k,\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}},\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}},\ num\_threads);}
\DoxyCodeLine{00229\ \ \ \ \ \ \ bm\ =\ blocking.mc();}
\DoxyCodeLine{00230\ \ \ \ \ \ \ bn\ =\ blocking.nc();}
\DoxyCodeLine{00231\ \ \ \ \ \ \ bk\ =\ blocking.kc();}
\DoxyCodeLine{00232\ \ \ \ \ \}}
\DoxyCodeLine{00233\ }
\DoxyCodeLine{00234\ \ \ \ \ \textcolor{comment}{//\ Number\ of\ kernels\ for\ each\ dimension.}}
\DoxyCodeLine{00235\ \ \ \ \ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ nm0\ =\ \mbox{\hyperlink{namespace_eigen_a13ec9832931270b80961236d30f6d2e3}{divup}}(\mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}},\ bm);}
\DoxyCodeLine{00236\ \ \ \ \ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ nn0\ =\ \mbox{\hyperlink{namespace_eigen_a13ec9832931270b80961236d30f6d2e3}{divup}}(\mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}},\ bn);}
\DoxyCodeLine{00237\ \ \ \ \ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ nk\ =\ \mbox{\hyperlink{namespace_eigen_a13ec9832931270b80961236d30f6d2e3}{divup}}(k,\ bk);}
\DoxyCodeLine{00238\ }
\DoxyCodeLine{00239\ \ \ \ \ \textcolor{comment}{//\ Calculate\ task\ grain\ size\ (number\ of\ kernels\ executed\ per\ task).}}
\DoxyCodeLine{00240\ \ \ \ \ \textcolor{comment}{//\ This\ task\ size\ coarsening\ serves\ two\ purposes:}}
\DoxyCodeLine{00241\ \ \ \ \ \textcolor{comment}{//\ 1.\ It\ reduces\ per-\/task\ overheads\ including\ synchronization\ overheads.}}
\DoxyCodeLine{00242\ \ \ \ \ \textcolor{comment}{//\ 2.\ It\ allows\ to\ use\ caches\ better\ (reuse\ the\ same\ packed\ rhs\ in\ several}}
\DoxyCodeLine{00243\ \ \ \ \ \textcolor{comment}{//\ consecutive\ kernels).}}
\DoxyCodeLine{00244\ \ \ \ \ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ gm\ =\ 1;}
\DoxyCodeLine{00245\ \ \ \ \ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ gn\ =\ 1;}
\DoxyCodeLine{00246\ \ \ \ \ \textcolor{comment}{//\ If\ we\ are\ sharding\ by\ column,\ then\ we\ prefer\ to\ reduce\ rows\ first.}}
\DoxyCodeLine{00247\ \ \ \ \ \textcolor{keywordflow}{if}\ (shard\_by\_col)\ \{}
\DoxyCodeLine{00248\ \ \ \ \ \ \ gm\ =\ coarsenM(\mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}},\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}},\ bm,\ bn,\ bk,\ gn,\ num\_threads,\ shard\_by\_col);}
\DoxyCodeLine{00249\ \ \ \ \ \ \ gn\ =\ coarsenN(\mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}},\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}},\ bm,\ bn,\ bk,\ gm,\ num\_threads,\ shard\_by\_col);}
\DoxyCodeLine{00250\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00251\ \ \ \ \ \ \ gn\ =\ coarsenN(\mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}},\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}},\ bm,\ bn,\ bk,\ gm,\ num\_threads,\ shard\_by\_col);}
\DoxyCodeLine{00252\ \ \ \ \ \ \ gm\ =\ coarsenM(\mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}},\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}},\ bm,\ bn,\ bk,\ gn,\ num\_threads,\ shard\_by\_col);}
\DoxyCodeLine{00253\ \ \ \ \ \}}
\DoxyCodeLine{00254\ \ \ \ \ \textcolor{comment}{//\ Number\ of\ tasks\ in\ each\ dimension.}}
\DoxyCodeLine{00255\ \ \ \ \ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ nm\ =\ \mbox{\hyperlink{namespace_eigen_a13ec9832931270b80961236d30f6d2e3}{divup}}(nm0,\ gm);}
\DoxyCodeLine{00256\ \ \ \ \ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ nn\ =\ \mbox{\hyperlink{namespace_eigen_a13ec9832931270b80961236d30f6d2e3}{divup}}(nn0,\ gn);}
\DoxyCodeLine{00257\ }
\DoxyCodeLine{00258\ \ \ \ \ \textcolor{comment}{//\ Last\ by\ not\ least,\ decide\ whether\ we\ want\ to\ issue\ both\ lhs\ and\ rhs}}
\DoxyCodeLine{00259\ \ \ \ \ \textcolor{comment}{//\ packing\ in\ parallel;\ or\ issue\ lhs\ packing\ first,\ and\ then\ issue\ rhs}}
\DoxyCodeLine{00260\ \ \ \ \ \textcolor{comment}{//\ packing\ when\ lhs\ packing\ completes\ (for\ !shard\_by\_col\ lhs\ and\ rhs\ are}}
\DoxyCodeLine{00261\ \ \ \ \ \textcolor{comment}{//\ swapped).\ Parallel\ packing\ allows\ more\ parallelism\ (for\ both\ packing\ and}}
\DoxyCodeLine{00262\ \ \ \ \ \textcolor{comment}{//\ kernels),\ while\ sequential\ packing\ provides\ better\ locality\ (once}}
\DoxyCodeLine{00263\ \ \ \ \ \textcolor{comment}{//\ a\ thread\ finishes\ rhs\ packing\ it\ proceed\ to\ kernels\ with\ that\ rhs).}}
\DoxyCodeLine{00264\ \ \ \ \ \textcolor{comment}{//\ First,\ we\ are\ interested\ in\ parallel\ packing\ if\ there\ are\ few\ tasks.}}
\DoxyCodeLine{00265\ \ \ \ \ \textcolor{keywordtype}{bool}\ parallel\_pack\ =\ num\_threads\ >=\ nm\ *\ nn;}
\DoxyCodeLine{00266\ \ \ \ \ \textcolor{comment}{//\ Also\ do\ parallel\ packing\ if\ all\ data\ fits\ into\ L2\$.}}
\DoxyCodeLine{00267\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}\ *\ bk\ *\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}(\textcolor{keyword}{sizeof}(LhsScalar))\ +\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}}\ *\ bk\ *\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}(\textcolor{keyword}{sizeof}(RhsScalar))\ <=}
\DoxyCodeLine{00268\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_eigen_a2cfc0330ba567d63a496be1cac8427ae}{l2CacheSize}}()\ *\ num\_threads)}
\DoxyCodeLine{00269\ \ \ \ \ \ \ parallel\_pack\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00270\ \ \ \ \ \textcolor{comment}{//\ But\ don't\ do\ it\ if\ we\ will\ use\ each\ rhs\ only\ once.\ Locality\ seems\ to\ be}}
\DoxyCodeLine{00271\ \ \ \ \ \textcolor{comment}{//\ more\ important\ in\ this\ case.}}
\DoxyCodeLine{00272\ \ \ \ \ \textcolor{keywordflow}{if}\ ((shard\_by\_col\ ?\ nm\ :\ nn)\ ==\ 1)\ parallel\_pack\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00273\ }
\DoxyCodeLine{00274\ \ \ \ \ LhsMapper\ lhs(this-\/>m\_leftImpl,\ this-\/>m\_left\_nocontract\_strides,}
\DoxyCodeLine{00275\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ this-\/>m\_i\_strides,\ this-\/>m\_left\_contracting\_strides,}
\DoxyCodeLine{00276\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ this-\/>m\_k\_strides);}
\DoxyCodeLine{00277\ }
\DoxyCodeLine{00278\ \ \ \ \ RhsMapper\ \mbox{\hyperlink{poisson_8cpp_a38c677f5cc4e47bc7505aef707c1bb83}{rhs}}(this-\/>m\_rightImpl,\ this-\/>m\_right\_nocontract\_strides,}
\DoxyCodeLine{00279\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ this-\/>m\_j\_strides,\ this-\/>m\_right\_contracting\_strides,}
\DoxyCodeLine{00280\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ this-\/>m\_k\_strides);}
\DoxyCodeLine{00281\ }
\DoxyCodeLine{00282\ \ \ \ \ Context<LhsPacker,\ RhsPacker,\ GebpKernel,\ LhsMapper,\ RhsMapper,}
\DoxyCodeLine{00283\ \ \ \ \ \ \ \ \ \ \ \ \ OutputMapper>(this-\/>\mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a13eb5009d2c2e60155de55e7c3d2bd6f}{m\_device}},\ num\_threads,\ lhs,\ \mbox{\hyperlink{poisson_8cpp_a38c677f5cc4e47bc7505aef707c1bb83}{rhs}},\ \mbox{\hyperlink{sugar_8h_aaadc06b5dac8070de2c8677210967bdb}{buffer}},\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}},\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}},}
\DoxyCodeLine{00284\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ k,\ bm,\ bn,\ bk,\ nm,\ nn,\ nk,\ gm,\ gn,\ nm0,\ nn0,}
\DoxyCodeLine{00285\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ shard\_by\_col,\ parallel\_pack)}
\DoxyCodeLine{00286\ \ \ \ \ \ \ \ \ .\mbox{\hyperlink{poisson_8cpp_ae12af222b820baf64e953be588c5bbbe}{run}}();}
\DoxyCodeLine{00287\ \ \ \}}
\DoxyCodeLine{00288\ }
\DoxyCodeLine{00289\ \ \ \textcolor{comment}{//\ Context\ coordinates\ a\ single\ parallel\ gemm\ operation.}}
\DoxyCodeLine{00290\ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ LhsPacker,\ \textcolor{keyword}{typename}\ RhsPacker,\ \textcolor{keyword}{typename}\ GebpKernel,}
\DoxyCodeLine{00291\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{typename}\ LhsMapper,\ \textcolor{keyword}{typename}\ RhsMapper,\ \textcolor{keyword}{typename}\ OutputMapper>}
\DoxyCodeLine{00292\ \ \ \textcolor{keyword}{class\ }Context\ \{}
\DoxyCodeLine{00293\ \ \ \ \textcolor{keyword}{public}:}
\DoxyCodeLine{00294\ \ \ \ \ Context(\textcolor{keyword}{const}\ Device\&\ device,\ \textcolor{keywordtype}{int}\ num\_threads,\ LhsMapper\&\ lhs,}
\DoxyCodeLine{00295\ \ \ \ \ \ \ \ \ \ \ \ \ RhsMapper\&\ \mbox{\hyperlink{poisson_8cpp_a38c677f5cc4e47bc7505aef707c1bb83}{rhs}},\ \mbox{\hyperlink{bench__gemm_8cpp_a052eb942d12b6404aade6fae4b075fb9}{Scalar}}*\ \mbox{\hyperlink{sugar_8h_aaadc06b5dac8070de2c8677210967bdb}{buffer}},\ Index\ tm,\ Index\ tn,\ Index\ tk,\ Index\ bm,}
\DoxyCodeLine{00296\ \ \ \ \ \ \ \ \ \ \ \ \ Index\ bn,\ Index\ bk,\ Index\ nm,\ Index\ nn,\ Index\ nk,\ Index\ gm,}
\DoxyCodeLine{00297\ \ \ \ \ \ \ \ \ \ \ \ \ Index\ gn,\ Index\ nm0,\ Index\ nn0,\ \textcolor{keywordtype}{bool}\ shard\_by\_col,}
\DoxyCodeLine{00298\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ parallel\_pack)}
\DoxyCodeLine{00299\ \ \ \ \ \ \ \ \ :\ device\_(device),}
\DoxyCodeLine{00300\ \ \ \ \ \ \ \ \ \ \ lhs\_(lhs),}
\DoxyCodeLine{00301\ \ \ \ \ \ \ \ \ \ \ rhs\_(\mbox{\hyperlink{poisson_8cpp_a38c677f5cc4e47bc7505aef707c1bb83}{rhs}}),}
\DoxyCodeLine{00302\ \ \ \ \ \ \ \ \ \ \ buffer\_(\mbox{\hyperlink{sugar_8h_aaadc06b5dac8070de2c8677210967bdb}{buffer}}),}
\DoxyCodeLine{00303\ \ \ \ \ \ \ \ \ \ \ output\_(\mbox{\hyperlink{sugar_8h_aaadc06b5dac8070de2c8677210967bdb}{buffer}},\ tm),}
\DoxyCodeLine{00304\ \ \ \ \ \ \ \ \ \ \ num\_threads\_(num\_threads),}
\DoxyCodeLine{00305\ \ \ \ \ \ \ \ \ \ \ shard\_by\_col\_(shard\_by\_col),}
\DoxyCodeLine{00306\ \ \ \ \ \ \ \ \ \ \ parallel\_pack\_(parallel\_pack),}
\DoxyCodeLine{00307\ \ \ \ \ \ \ \ \ \ \ m\_(tm),}
\DoxyCodeLine{00308\ \ \ \ \ \ \ \ \ \ \ n\_(tn),}
\DoxyCodeLine{00309\ \ \ \ \ \ \ \ \ \ \ k\_(tk),}
\DoxyCodeLine{00310\ \ \ \ \ \ \ \ \ \ \ bm\_(bm),}
\DoxyCodeLine{00311\ \ \ \ \ \ \ \ \ \ \ bn\_(bn),}
\DoxyCodeLine{00312\ \ \ \ \ \ \ \ \ \ \ bk\_(bk),}
\DoxyCodeLine{00313\ \ \ \ \ \ \ \ \ \ \ nm\_(nm),}
\DoxyCodeLine{00314\ \ \ \ \ \ \ \ \ \ \ nn\_(nn),}
\DoxyCodeLine{00315\ \ \ \ \ \ \ \ \ \ \ nk\_(nk),}
\DoxyCodeLine{00316\ \ \ \ \ \ \ \ \ \ \ gm\_(gm),}
\DoxyCodeLine{00317\ \ \ \ \ \ \ \ \ \ \ gn\_(gn),}
\DoxyCodeLine{00318\ \ \ \ \ \ \ \ \ \ \ nm0\_(nm0),}
\DoxyCodeLine{00319\ \ \ \ \ \ \ \ \ \ \ nn0\_(nn0)}
\DoxyCodeLine{00320\ \ \ \{}
\DoxyCodeLine{00321\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (Index\ \mbox{\hyperlink{offscreen_8c_a5fd331c99e778f04762be6d8173eb4d2}{x}}\ =\ 0;\ \mbox{\hyperlink{offscreen_8c_a5fd331c99e778f04762be6d8173eb4d2}{x}}\ <\ \mbox{\hyperlink{_direction_wise__hnormalized_8cpp_a98fb883180cbb2e5412955dfd6edb605}{P}};\ \mbox{\hyperlink{offscreen_8c_a5fd331c99e778f04762be6d8173eb4d2}{x}}++)\ \{}
\DoxyCodeLine{00322\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Normal\ number\ of\ notifications\ for\ k\ slice\ switch\ is}}
\DoxyCodeLine{00323\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ nm\_\ +\ nn\_\ +\ nm\_\ *\ nn\_.\ However,\ first\ P\ -\/\ 1\ slices\ will\ receive\ only}}
\DoxyCodeLine{00324\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ nm\_\ +\ nn\_\ notifications,\ because\ they\ will\ not\ receive\ notifications}}
\DoxyCodeLine{00325\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ from\ preceding\ kernels.}}
\DoxyCodeLine{00326\ \ \ \ \ \ \ \ \ state\_switch\_[\mbox{\hyperlink{offscreen_8c_a5fd331c99e778f04762be6d8173eb4d2}{x}}]\ =}
\DoxyCodeLine{00327\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{offscreen_8c_a5fd331c99e778f04762be6d8173eb4d2}{x}}\ ==\ 0}
\DoxyCodeLine{00328\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ?\ 1}
\DoxyCodeLine{00329\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ :\ (parallel\_pack\_\ ?\ nn\_\ +\ nm\_\ :\ (shard\_by\_col\_\ ?\ nn\_\ :\ nm\_))\ +}
\DoxyCodeLine{00330\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (\mbox{\hyperlink{offscreen_8c_a5fd331c99e778f04762be6d8173eb4d2}{x}}\ ==\ P\ -\/\ 1\ ?\ nm\_\ *\ nn\_\ :\ 0);}
\DoxyCodeLine{00331\ \ \ \ \ \ \ \ \ state\_packing\_ready\_[\mbox{\hyperlink{offscreen_8c_a5fd331c99e778f04762be6d8173eb4d2}{x}}]\ =}
\DoxyCodeLine{00332\ \ \ \ \ \ \ \ \ \ \ \ \ parallel\_pack\_\ ?\ 0\ :\ (shard\_by\_col\_\ ?\ nm\_\ :\ nn\_);}
\DoxyCodeLine{00333\ \ \ \ \ \ \ \ \ state\_kernel\_[\mbox{\hyperlink{offscreen_8c_a5fd331c99e778f04762be6d8173eb4d2}{x}}]\ =\ \textcolor{keyword}{new}\ std::atomic<uint8\_t>*[nm\_];}
\DoxyCodeLine{00334\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (Index\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}\ =\ 0;\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}\ <\ nm\_;\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}++)\ \{}
\DoxyCodeLine{00335\ \ \ \ \ \ \ \ \ \ \ state\_kernel\_[\mbox{\hyperlink{offscreen_8c_a5fd331c99e778f04762be6d8173eb4d2}{x}}][\mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}]\ =\ \textcolor{keyword}{new}\ std::atomic<uint8\_t>[nn\_];}
\DoxyCodeLine{00336\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Kernels\ generally\ receive\ 3\ notifications\ (previous\ kernel\ +\ 2}}
\DoxyCodeLine{00337\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ packing),\ but\ the\ first\ slice\ won't\ get\ notifications\ from\ previous}}
\DoxyCodeLine{00338\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ kernels.}}
\DoxyCodeLine{00339\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (Index\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}}\ =\ 0;\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}}\ <\ nn\_;\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}}++)}
\DoxyCodeLine{00340\ \ \ \ \ \ \ \ \ \ \ \ \ state\_kernel\_[\mbox{\hyperlink{offscreen_8c_a5fd331c99e778f04762be6d8173eb4d2}{x}}][\mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}][\mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}}].\mbox{\hyperlink{namespacetbb_a219b97248f55c909aa3d84e43934b105}{store}}(}
\DoxyCodeLine{00341\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (\mbox{\hyperlink{offscreen_8c_a5fd331c99e778f04762be6d8173eb4d2}{x}}\ ==\ 0\ ?\ 0\ :\ 1)\ +\ (parallel\_pack\_\ ?\ 2\ :\ 1),}
\DoxyCodeLine{00342\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::memory\_order\_relaxed);}
\DoxyCodeLine{00343\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00344\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00345\ }
\DoxyCodeLine{00346\ \ \ \ \ \ \ \textcolor{comment}{//\ Allocate\ memory\ for\ packed\ rhs/lhs\ matrices.}}
\DoxyCodeLine{00347\ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{runtime_2spdlog_2include_2spdlog_2fmt_2bundled_2base_8h_a6c52c4bac77f6744fdc338766e9e8a6f}{align}}\ =\ numext::maxi(\mbox{\hyperlink{eigen-3_83_87_2_eigen_2src_2_core_2util_2_macros_8h_aabf37293a258a90b1aa96a5d5ec04bfb}{EIGEN\_MAX\_ALIGN\_BYTES}},\ 1);}
\DoxyCodeLine{00348\ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ lhs\_size\ =}
\DoxyCodeLine{00349\ \ \ \ \ \ \ \ \ \ \ divup<size\_t>(bm\_\ *\ bk\_\ *\ \textcolor{keyword}{sizeof}(LhsScalar),\ \mbox{\hyperlink{runtime_2spdlog_2include_2spdlog_2fmt_2bundled_2base_8h_a6c52c4bac77f6744fdc338766e9e8a6f}{align}})\ *\ \mbox{\hyperlink{runtime_2spdlog_2include_2spdlog_2fmt_2bundled_2base_8h_a6c52c4bac77f6744fdc338766e9e8a6f}{align}};}
\DoxyCodeLine{00350\ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ rhs\_size\ =}
\DoxyCodeLine{00351\ \ \ \ \ \ \ \ \ \ \ divup<size\_t>(bn\_\ *\ bk\_\ *\ \textcolor{keyword}{sizeof}(RhsScalar),\ \mbox{\hyperlink{runtime_2spdlog_2include_2spdlog_2fmt_2bundled_2base_8h_a6c52c4bac77f6744fdc338766e9e8a6f}{align}})\ *\ \mbox{\hyperlink{runtime_2spdlog_2include_2spdlog_2fmt_2bundled_2base_8h_a6c52c4bac77f6744fdc338766e9e8a6f}{align}};}
\DoxyCodeLine{00352\ \ \ \ \ \ \ packed\_mem\_\ =\ \textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{char}*\textcolor{keyword}{>}(internal::aligned\_malloc(}
\DoxyCodeLine{00353\ \ \ \ \ \ \ \ \ \ \ (nm0\_\ *\ lhs\_size\ +\ nn0\_\ *\ rhs\_size)\ *\ \mbox{\hyperlink{namespacestd_ac7b9885417769949d76890454b6d072e}{std::min<size\_t>}}(nk\_,\ P\ -\/\ 1)));}
\DoxyCodeLine{00354\ \ \ \ \ \ \ \textcolor{keywordtype}{char}*\ mem\ =\ \textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{char}*\textcolor{keyword}{>}(packed\_mem\_);}
\DoxyCodeLine{00355\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (Index\ \mbox{\hyperlink{offscreen_8c_a5fd331c99e778f04762be6d8173eb4d2}{x}}\ =\ 0;\ \mbox{\hyperlink{offscreen_8c_a5fd331c99e778f04762be6d8173eb4d2}{x\ <\ numext::mini<Index>}}(nk\_,\ P\ -\/\ 1);\ \mbox{\hyperlink{offscreen_8c_a5fd331c99e778f04762be6d8173eb4d2}{x}}++)\ \{}
\DoxyCodeLine{00356\ \ \ \ \ \ \ \ \ packed\_lhs\_[\mbox{\hyperlink{offscreen_8c_a5fd331c99e778f04762be6d8173eb4d2}{x}}].resize(nm0\_);}
\DoxyCodeLine{00357\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (Index\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}\ =\ 0;\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}\ <\ nm0\_;\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}++)\ \{}
\DoxyCodeLine{00358\ \ \ \ \ \ \ \ \ \ \ packed\_lhs\_[\mbox{\hyperlink{offscreen_8c_a5fd331c99e778f04762be6d8173eb4d2}{x}}][\mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}]\ =\ \textcolor{keyword}{reinterpret\_cast<}LhsScalar*\textcolor{keyword}{>}(mem);}
\DoxyCodeLine{00359\ \ \ \ \ \ \ \ \ \ \ mem\ +=\ lhs\_size;}
\DoxyCodeLine{00360\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00361\ \ \ \ \ \ \ \ \ packed\_rhs\_[\mbox{\hyperlink{offscreen_8c_a5fd331c99e778f04762be6d8173eb4d2}{x}}].resize(nn0\_);}
\DoxyCodeLine{00362\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (Index\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}}\ =\ 0;\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}}\ <\ nn0\_;\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}}++)\ \{}
\DoxyCodeLine{00363\ \ \ \ \ \ \ \ \ \ \ packed\_rhs\_[\mbox{\hyperlink{offscreen_8c_a5fd331c99e778f04762be6d8173eb4d2}{x}}][\mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}}]\ =\ \textcolor{keyword}{reinterpret\_cast<}RhsScalar*\textcolor{keyword}{>}(mem);}
\DoxyCodeLine{00364\ \ \ \ \ \ \ \ \ \ \ mem\ +=\ rhs\_size;}
\DoxyCodeLine{00365\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00366\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00367\ \ \ \ \ \}}
\DoxyCodeLine{00368\ }
\DoxyCodeLine{00369\ \ \ \ \ \string~Context()\ \{}
\DoxyCodeLine{00370\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (Index\ \mbox{\hyperlink{offscreen_8c_a5fd331c99e778f04762be6d8173eb4d2}{x}}\ =\ 0;\ \mbox{\hyperlink{offscreen_8c_a5fd331c99e778f04762be6d8173eb4d2}{x}}\ <\ \mbox{\hyperlink{_direction_wise__hnormalized_8cpp_a98fb883180cbb2e5412955dfd6edb605}{P}};\ \mbox{\hyperlink{offscreen_8c_a5fd331c99e778f04762be6d8173eb4d2}{x}}++)\ \{}
\DoxyCodeLine{00371\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (Index\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}\ =\ 0;\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}\ <\ nm\_;\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}++)\ \textcolor{keyword}{delete}[]\ state\_kernel\_[\mbox{\hyperlink{offscreen_8c_a5fd331c99e778f04762be6d8173eb4d2}{x}}][\mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}];}
\DoxyCodeLine{00372\ \ \ \ \ \ \ \ \ \textcolor{keyword}{delete}[]\ state\_kernel\_[\mbox{\hyperlink{offscreen_8c_a5fd331c99e778f04762be6d8173eb4d2}{x}}];}
\DoxyCodeLine{00373\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00374\ \ \ \ \ \ \ internal::aligned\_free(packed\_mem\_);}
\DoxyCodeLine{00375\ \ \ \ \ \}}
\DoxyCodeLine{00376\ }
\DoxyCodeLine{00377\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{poisson_8cpp_ae12af222b820baf64e953be588c5bbbe}{run}}()\ \{}
\DoxyCodeLine{00378\ \ \ \ \ \ \ \textcolor{comment}{//\ Kick\ off\ packing\ of\ the\ first\ slice.}}
\DoxyCodeLine{00379\ \ \ \ \ \ \ signal\_switch(0,\ 1);}
\DoxyCodeLine{00380\ \ \ \ \ \ \ \textcolor{comment}{//\ Wait\ for\ overall\ completion.}}
\DoxyCodeLine{00381\ \ \ \ \ \ \ \textcolor{comment}{//\ TODO(dvyukov):\ this\ wait\ can\ lead\ to\ deadlock.}}
\DoxyCodeLine{00382\ \ \ \ \ \ \ \textcolor{comment}{//\ If\ nthreads\ contractions\ are\ concurrently\ submitted\ from\ worker}}
\DoxyCodeLine{00383\ \ \ \ \ \ \ \textcolor{comment}{//\ threads,\ this\ wait\ will\ block\ all\ worker\ threads\ and\ the\ system\ will}}
\DoxyCodeLine{00384\ \ \ \ \ \ \ \textcolor{comment}{//\ deadlock.}}
\DoxyCodeLine{00385\ \ \ \ \ \ \ done\_.Wait();}
\DoxyCodeLine{00386\ \ \ \ \ \}}
\DoxyCodeLine{00387\ }
\DoxyCodeLine{00388\ \ \ \ \textcolor{keyword}{private}:}
\DoxyCodeLine{00389\ \ \ \ \ Notification\ done\_;}
\DoxyCodeLine{00390\ \ \ \ \ \textcolor{keyword}{const}\ Device\&\ device\_;}
\DoxyCodeLine{00391\ \ \ \ \ LhsMapper\&\ lhs\_;}
\DoxyCodeLine{00392\ \ \ \ \ RhsMapper\&\ rhs\_;}
\DoxyCodeLine{00393\ \ \ \ \ \mbox{\hyperlink{bench__gemm_8cpp_a052eb942d12b6404aade6fae4b075fb9}{Scalar}}*\ \textcolor{keyword}{const}\ buffer\_;}
\DoxyCodeLine{00394\ \ \ \ \ OutputMapper\ output\_;}
\DoxyCodeLine{00395\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ num\_threads\_;}
\DoxyCodeLine{00396\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{bool}\ shard\_by\_col\_;}
\DoxyCodeLine{00397\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{bool}\ parallel\_pack\_;}
\DoxyCodeLine{00398\ \ \ \ \ \textcolor{comment}{//\ Matrix\ sizes.}}
\DoxyCodeLine{00399\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ m\_;}
\DoxyCodeLine{00400\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ n\_;}
\DoxyCodeLine{00401\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ k\_;}
\DoxyCodeLine{00402\ \ \ \ \ \textcolor{comment}{//\ Block\ sizes.}}
\DoxyCodeLine{00403\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ bm\_;}
\DoxyCodeLine{00404\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ bn\_;}
\DoxyCodeLine{00405\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ bk\_;}
\DoxyCodeLine{00406\ \ \ \ \ \textcolor{comment}{//\ Number\ of\ tasks.}}
\DoxyCodeLine{00407\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ nm\_;}
\DoxyCodeLine{00408\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ nn\_;}
\DoxyCodeLine{00409\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ nk\_;}
\DoxyCodeLine{00410\ \ \ \ \ \textcolor{comment}{//\ Task\ grain\ sizes\ (number\ of\ kernels\ executed\ per\ task).}}
\DoxyCodeLine{00411\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ gm\_;}
\DoxyCodeLine{00412\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ gn\_;}
\DoxyCodeLine{00413\ \ \ \ \ \textcolor{comment}{//\ Number\ of\ blocks\ (this\ is\ different\ from\ ni\_/nn\_\ because\ of\ task\ size}}
\DoxyCodeLine{00414\ \ \ \ \ \textcolor{comment}{//\ coarsening).}}
\DoxyCodeLine{00415\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ nm0\_;}
\DoxyCodeLine{00416\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ nn0\_;}
\DoxyCodeLine{00417\ }
\DoxyCodeLine{00418\ \ \ \ \ \textcolor{comment}{//\ Parallelization\ strategy.}}
\DoxyCodeLine{00419\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00420\ \ \ \ \ \textcolor{comment}{//\ Blocks\ related\ to\ the\ same\ k\ block\ can\ run\ in\ parallel\ because\ they\ write}}
\DoxyCodeLine{00421\ \ \ \ \ \textcolor{comment}{//\ to\ different\ output\ blocks.\ So\ we\ parallelize\ within\ k\ slices,\ this}}
\DoxyCodeLine{00422\ \ \ \ \ \textcolor{comment}{//\ gives\ us\ parallelism\ level\ of\ m\ x\ n.\ Before\ we\ can\ start\ any\ kernels}}
\DoxyCodeLine{00423\ \ \ \ \ \textcolor{comment}{//\ related\ to\ k-\/th\ slice,\ we\ need\ to\ issue\ m\ lhs\ packing\ tasks\ and\ n\ rhs}}
\DoxyCodeLine{00424\ \ \ \ \ \textcolor{comment}{//\ packing\ tasks.}}
\DoxyCodeLine{00425\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00426\ \ \ \ \ \textcolor{comment}{//\ However,\ there\ is\ a\ bottleneck\ when\ we\ are\ finishing\ kernels\ for\ k-\/th}}
\DoxyCodeLine{00427\ \ \ \ \ \textcolor{comment}{//\ slice\ (at\ the\ very\ end\ there\ is\ only\ 1\ runnable\ kernel).\ To\ mitigate\ this}}
\DoxyCodeLine{00428\ \ \ \ \ \textcolor{comment}{//\ bottleneck\ we\ allow\ kernels\ from\ k-\/th\ and\ k+1-\/th\ slices\ to\ run\ in}}
\DoxyCodeLine{00429\ \ \ \ \ \textcolor{comment}{//\ parallel.\ Note\ that\ (m,\ n,\ k)\ and\ (m,\ n,\ k+1)\ kernels\ write\ to\ the\ same}}
\DoxyCodeLine{00430\ \ \ \ \ \textcolor{comment}{//\ output\ block,\ so\ they\ must\ not\ run\ in\ parallel.}}
\DoxyCodeLine{00431\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00432\ \ \ \ \ \textcolor{comment}{//\ This\ gives\ us\ the\ following\ dependency\ graph.}}
\DoxyCodeLine{00433\ \ \ \ \ \textcolor{comment}{//\ On\ each\ k\ slice\ we\ have\ m\ x\ n\ kernel\ tasks,\ m\ lhs\ paking\ tasks\ and\ n\ rhs}}
\DoxyCodeLine{00434\ \ \ \ \ \textcolor{comment}{//\ packing\ tasks.}}
\DoxyCodeLine{00435\ \ \ \ \ \textcolor{comment}{//\ Kernel\ (m,\ n,\ k)\ can\ start\ when:}}
\DoxyCodeLine{00436\ \ \ \ \ \textcolor{comment}{//\ \ -\/\ kernel\ (m,\ n,\ k-\/1)\ has\ finished}}
\DoxyCodeLine{00437\ \ \ \ \ \textcolor{comment}{//\ \ -\/\ lhs\ packing\ (m,\ k)\ has\ finished}}
\DoxyCodeLine{00438\ \ \ \ \ \textcolor{comment}{//\ \ -\/\ rhs\ packing\ (n,\ k)\ has\ finished}}
\DoxyCodeLine{00439\ \ \ \ \ \textcolor{comment}{//\ Lhs/rhs\ packing\ can\ start\ when:}}
\DoxyCodeLine{00440\ \ \ \ \ \textcolor{comment}{//\ \ -\/\ all\ k-\/1\ packing\ has\ finished\ (artificially\ imposed\ to\ limit\ amount\ of}}
\DoxyCodeLine{00441\ \ \ \ \ \textcolor{comment}{//\ \ parallel\ packing)}}
\DoxyCodeLine{00442\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00443\ \ \ \ \ \textcolor{comment}{//\ On\ top\ of\ that\ we\ limit\ runnable\ tasks\ to\ two\ consecutive\ k\ slices.}}
\DoxyCodeLine{00444\ \ \ \ \ \textcolor{comment}{//\ This\ is\ done\ to\ limit\ amount\ of\ memory\ we\ need\ for\ packed\ lhs/rhs}}
\DoxyCodeLine{00445\ \ \ \ \ \textcolor{comment}{//\ (for\ each\ k\ slice\ we\ need\ m*bk\ +\ n*bk\ memory\ in\ packed\_lhs\_/packed\_rhs\_).}}
\DoxyCodeLine{00446\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00447\ \ \ \ \ \textcolor{comment}{//\ state\_switch\_\ tracks\ when\ we\ are\ ready\ to\ switch\ to\ the\ next\ k\ slice.}}
\DoxyCodeLine{00448\ \ \ \ \ \textcolor{comment}{//\ state\_kernel\_[m][n]\ tracks\ when\ we\ are\ ready\ to\ kick\ off\ kernel\ (m,\ n).}}
\DoxyCodeLine{00449\ \ \ \ \ \textcolor{comment}{//\ These\ variable\ are\ rolling\ over\ 3\ consecutive\ k\ slices:\ first\ two\ we\ are}}
\DoxyCodeLine{00450\ \ \ \ \ \textcolor{comment}{//\ actively\ executing\ +\ one\ to\ track\ completion\ of\ kernels\ in\ the\ second}}
\DoxyCodeLine{00451\ \ \ \ \ \textcolor{comment}{//\ slice.}}
\DoxyCodeLine{00452\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ \mbox{\hyperlink{_direction_wise__hnormalized_8cpp_a98fb883180cbb2e5412955dfd6edb605}{P}}\ =\ 3;}
\DoxyCodeLine{00453\ \ \ \ \ \textcolor{keywordtype}{void}*\ packed\_mem\_;}
\DoxyCodeLine{00454\ \ \ \ \ std::vector<LhsScalar*>\ packed\_lhs\_[\mbox{\hyperlink{_direction_wise__hnormalized_8cpp_a98fb883180cbb2e5412955dfd6edb605}{P}}\ -\/\ 1];}
\DoxyCodeLine{00455\ \ \ \ \ std::vector<RhsScalar*>\ packed\_rhs\_[\mbox{\hyperlink{_direction_wise__hnormalized_8cpp_a98fb883180cbb2e5412955dfd6edb605}{P}}\ -\/\ 1];}
\DoxyCodeLine{00456\ \ \ \ \ std::atomic<uint8\_t>**\ state\_kernel\_[\mbox{\hyperlink{_direction_wise__hnormalized_8cpp_a98fb883180cbb2e5412955dfd6edb605}{P}}];}
\DoxyCodeLine{00457\ \ \ \ \ \textcolor{comment}{//\ state\_switch\_\ is\ frequently\ modified\ by\ worker\ threads,\ while\ other}}
\DoxyCodeLine{00458\ \ \ \ \ \textcolor{comment}{//\ fields\ are\ read-\/only\ after\ constructor.\ Let's\ move\ it\ to\ a\ separate\ cache}}
\DoxyCodeLine{00459\ \ \ \ \ \textcolor{comment}{//\ line\ to\ reduce\ cache-\/coherency\ traffic.}}
\DoxyCodeLine{00460\ \ \ \ \ \textcolor{keywordtype}{char}\ pad\_[128];}
\DoxyCodeLine{00461\ \ \ \ \ std::atomic<Index>\ state\_packing\_ready\_[\mbox{\hyperlink{_direction_wise__hnormalized_8cpp_a98fb883180cbb2e5412955dfd6edb605}{P}}];}
\DoxyCodeLine{00462\ \ \ \ \ std::atomic<Index>\ state\_switch\_[\mbox{\hyperlink{_direction_wise__hnormalized_8cpp_a98fb883180cbb2e5412955dfd6edb605}{P}}];}
\DoxyCodeLine{00463\ }
\DoxyCodeLine{00464\ \ \ \ \ \textcolor{keywordtype}{void}\ pack\_lhs(Index\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}},\ Index\ k)\ \{}
\DoxyCodeLine{00465\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ mend\ =\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}\ *\ gm\_\ +\ gm(\mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}});}
\DoxyCodeLine{00466\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (Index\ \mbox{\hyperlink{_i_o_format_8cpp_ade6f22163da3c189aade978b48a8bb74}{m1}}\ =\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}\ *\ gm\_;\ \mbox{\hyperlink{_i_o_format_8cpp_ade6f22163da3c189aade978b48a8bb74}{m1}}\ <\ mend;\ \mbox{\hyperlink{_i_o_format_8cpp_ade6f22163da3c189aade978b48a8bb74}{m1}}++)}
\DoxyCodeLine{00467\ \ \ \ \ \ \ \ \ LhsPacker()(packed\_lhs\_[k\ \%\ (\mbox{\hyperlink{_direction_wise__hnormalized_8cpp_a98fb883180cbb2e5412955dfd6edb605}{P}}\ -\/\ 1)][\mbox{\hyperlink{_i_o_format_8cpp_ade6f22163da3c189aade978b48a8bb74}{m1}}],}
\DoxyCodeLine{00468\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ lhs\_.getSubMapper(\mbox{\hyperlink{_i_o_format_8cpp_ade6f22163da3c189aade978b48a8bb74}{m1}}\ *\ bm\_,\ k\ *\ bk\_),\ bk(k),\ bm(\mbox{\hyperlink{_i_o_format_8cpp_ade6f22163da3c189aade978b48a8bb74}{m1}}));}
\DoxyCodeLine{00469\ }
\DoxyCodeLine{00470\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!parallel\_pack\_\ \&\&\ shard\_by\_col\_)\ \{}
\DoxyCodeLine{00471\ \ \ \ \ \ \ \ \ signal\_packing(k);}
\DoxyCodeLine{00472\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00473\ \ \ \ \ \ \ \ \ signal\_switch(k\ +\ 1);}
\DoxyCodeLine{00474\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (Index\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}}\ =\ nn\_\ -\/\ 1;\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}}\ >=\ 0;\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}}-\/-\/)\ signal\_kernel(\mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}},\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}},\ k,\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}}\ ==\ 0);}
\DoxyCodeLine{00475\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00476\ \ \ \ \ \}}
\DoxyCodeLine{00477\ }
\DoxyCodeLine{00478\ \ \ \ \ \textcolor{keywordtype}{void}\ pack\_rhs(Index\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}},\ Index\ k)\ \{}
\DoxyCodeLine{00479\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ nend\ =\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}}\ *\ gn\_\ +\ gn(\mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}});}
\DoxyCodeLine{00480\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (Index\ n1\ =\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}}\ *\ gn\_;\ n1\ <\ nend;\ n1++)\ \{}
\DoxyCodeLine{00481\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (k\ ==\ 0)\ \{}
\DoxyCodeLine{00482\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Zero\ the\ output\ memory\ in\ parallel.}}
\DoxyCodeLine{00483\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ On\ 10000x2x10000\ mm\ zeroing\ can\ easily\ take\ half\ of\ time.}}
\DoxyCodeLine{00484\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Zero\ (bn\ x\ m)\ row.\ Safe\ to\ do\ here\ because\ all\ kernels\ that\ will}}
\DoxyCodeLine{00485\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ write\ to\ this\ memory\ depend\ on\ completion\ of\ this\ task.}}
\DoxyCodeLine{00486\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Note:\ don't\ call\ device\_.memset()\ here.\ device\_.memset()\ blocks\ on}}
\DoxyCodeLine{00487\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ thread\ pool\ worker\ thread,\ which\ can\ lead\ to\ underutilization\ and}}
\DoxyCodeLine{00488\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ deadlocks.}}
\DoxyCodeLine{00489\ \ \ \ \ \ \ \ \ \ \ memset(buffer\_\ +\ n1\ *\ bn\_\ *\ m\_,\ 0,\ bn(n1)\ *\ m\_\ *\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{bench__gemm_8cpp_a052eb942d12b6404aade6fae4b075fb9}{Scalar}}));}
\DoxyCodeLine{00490\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00491\ \ \ \ \ \ \ \ \ RhsPacker()(packed\_rhs\_[k\ \%\ (\mbox{\hyperlink{_direction_wise__hnormalized_8cpp_a98fb883180cbb2e5412955dfd6edb605}{P}}\ -\/\ 1)][n1],}
\DoxyCodeLine{00492\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ rhs\_.getSubMapper(k\ *\ bk\_,\ n1\ *\ bn\_),\ bk(k),\ bn(n1));}
\DoxyCodeLine{00493\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00494\ }
\DoxyCodeLine{00495\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (parallel\_pack\_\ ||\ shard\_by\_col\_)\ \{}
\DoxyCodeLine{00496\ \ \ \ \ \ \ \ \ signal\_switch(k\ +\ 1);}
\DoxyCodeLine{00497\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (Index\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}\ =\ nm\_\ -\/\ 1;\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}\ >=\ 0;\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}-\/-\/)\ signal\_kernel(\mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}},\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}},\ k,\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}\ ==\ 0);}
\DoxyCodeLine{00498\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00499\ \ \ \ \ \ \ \ \ signal\_packing(k);}
\DoxyCodeLine{00500\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00501\ \ \ \ \ \}}
\DoxyCodeLine{00502\ }
\DoxyCodeLine{00503\ \ \ \ \ \textcolor{keywordtype}{void}\ kernel(Index\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}},\ Index\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}},\ Index\ k)\ \{}
\DoxyCodeLine{00504\ \ \ \ \ \ \ \textcolor{comment}{//\ Note:\ order\ of\ iteration\ matters\ here.\ Iteration\ over\ m\ is\ innermost}}
\DoxyCodeLine{00505\ \ \ \ \ \ \ \textcolor{comment}{//\ because\ we\ want\ to\ reuse\ the\ same\ packed\ rhs\ in\ consequetive\ tasks}}
\DoxyCodeLine{00506\ \ \ \ \ \ \ \textcolor{comment}{//\ (rhs\ fits\ into\ L2\$\ while\ lhs\ only\ into\ L3\$).}}
\DoxyCodeLine{00507\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ nend\ =\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}}\ *\ gn\_\ +\ gn(\mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}});}
\DoxyCodeLine{00508\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ mend\ =\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}\ *\ gm\_\ +\ gm(\mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}});}
\DoxyCodeLine{00509\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (shard\_by\_col\_)\ \{}
\DoxyCodeLine{00510\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (Index\ n1\ =\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}}\ *\ gn\_;\ n1\ <\ nend;\ n1++)\ \{}
\DoxyCodeLine{00511\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (Index\ \mbox{\hyperlink{_i_o_format_8cpp_ade6f22163da3c189aade978b48a8bb74}{m1}}\ =\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}\ *\ gm\_;\ \mbox{\hyperlink{_i_o_format_8cpp_ade6f22163da3c189aade978b48a8bb74}{m1}}\ <\ mend;\ \mbox{\hyperlink{_i_o_format_8cpp_ade6f22163da3c189aade978b48a8bb74}{m1}}++)}
\DoxyCodeLine{00512\ \ \ \ \ \ \ \ \ \ \ \ \ GebpKernel()(output\_.getSubMapper(\mbox{\hyperlink{_i_o_format_8cpp_ade6f22163da3c189aade978b48a8bb74}{m1}}\ *\ bm\_,\ n1\ *\ bn\_),}
\DoxyCodeLine{00513\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ packed\_lhs\_[k\ \%\ (P\ -\/\ 1)][\mbox{\hyperlink{_i_o_format_8cpp_ade6f22163da3c189aade978b48a8bb74}{m1}}],}
\DoxyCodeLine{00514\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ packed\_rhs\_[k\ \%\ (P\ -\/\ 1)][n1],\ bm(\mbox{\hyperlink{_i_o_format_8cpp_ade6f22163da3c189aade978b48a8bb74}{m1}}),\ bk(k),\ bn(n1),}
\DoxyCodeLine{00515\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{bench__gemm_8cpp_a052eb942d12b6404aade6fae4b075fb9}{Scalar}}(1),\ -\/1,\ -\/1,\ 0,\ 0);}
\DoxyCodeLine{00516\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00517\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00518\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (Index\ \mbox{\hyperlink{_i_o_format_8cpp_ade6f22163da3c189aade978b48a8bb74}{m1}}\ =\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}\ *\ gm\_;\ \mbox{\hyperlink{_i_o_format_8cpp_ade6f22163da3c189aade978b48a8bb74}{m1}}\ <\ mend;\ \mbox{\hyperlink{_i_o_format_8cpp_ade6f22163da3c189aade978b48a8bb74}{m1}}++)}
\DoxyCodeLine{00519\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (Index\ n1\ =\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}}\ *\ gn\_;\ n1\ <\ nend;\ n1++)\ \{}
\DoxyCodeLine{00520\ \ \ \ \ \ \ \ \ \ \ \ \ GebpKernel()(output\_.getSubMapper(\mbox{\hyperlink{_i_o_format_8cpp_ade6f22163da3c189aade978b48a8bb74}{m1}}\ *\ bm\_,\ n1\ *\ bn\_),}
\DoxyCodeLine{00521\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ packed\_lhs\_[k\ \%\ (P\ -\/\ 1)][\mbox{\hyperlink{_i_o_format_8cpp_ade6f22163da3c189aade978b48a8bb74}{m1}}],}
\DoxyCodeLine{00522\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ packed\_rhs\_[k\ \%\ (P\ -\/\ 1)][n1],\ bm(\mbox{\hyperlink{_i_o_format_8cpp_ade6f22163da3c189aade978b48a8bb74}{m1}}),\ bk(k),\ bn(n1),}
\DoxyCodeLine{00523\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{bench__gemm_8cpp_a052eb942d12b6404aade6fae4b075fb9}{Scalar}}(1),\ -\/1,\ -\/1,\ 0,\ 0);}
\DoxyCodeLine{00524\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00525\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00526\ \ \ \ \ \ \ signal\_kernel(\mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}},\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}},\ k\ +\ 1,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00527\ \ \ \ \ \ \ signal\_switch(k\ +\ 2);}
\DoxyCodeLine{00528\ \ \ \ \ \}}
\DoxyCodeLine{00529\ }
\DoxyCodeLine{00530\ \ \ \ \ \textcolor{keywordtype}{void}\ signal\_packing(Index\ k)\ \{}
\DoxyCodeLine{00531\ \ \ \ \ \ \ \mbox{\hyperlink{eigen-3_83_87_2_eigen_2src_2_core_2util_2_macros_8h_acaa7ba89800cfe18d5fd6eed620aea9c}{eigen\_assert}}(!parallel\_pack\_);}
\DoxyCodeLine{00532\ \ \ \ \ \ \ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ \mbox{\hyperlink{main-override_8cpp_a1384e7608274313a9433fa573868557b}{s}}\ =\ state\_packing\_ready\_[k\ \%\ \mbox{\hyperlink{_direction_wise__hnormalized_8cpp_a98fb883180cbb2e5412955dfd6edb605}{P}}].fetch\_sub(1);}
\DoxyCodeLine{00533\ \ \ \ \ \ \ \mbox{\hyperlink{eigen-3_83_87_2_eigen_2src_2_core_2util_2_macros_8h_acaa7ba89800cfe18d5fd6eed620aea9c}{eigen\_assert}}(\mbox{\hyperlink{main-override_8cpp_a1384e7608274313a9433fa573868557b}{s}}\ >\ 0);}
\DoxyCodeLine{00534\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{main-override_8cpp_a1384e7608274313a9433fa573868557b}{s}}\ !=\ 1)\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00535\ \ \ \ \ \ \ state\_packing\_ready\_[k\ \%\ \mbox{\hyperlink{_direction_wise__hnormalized_8cpp_a98fb883180cbb2e5412955dfd6edb605}{P}}]\ =\ shard\_by\_col\_\ ?\ nm\_\ :\ nn\_;}
\DoxyCodeLine{00536\ \ \ \ \ \ \ enqueue\_packing(k,\ shard\_by\_col\_);}
\DoxyCodeLine{00537\ \ \ \ \ \}}
\DoxyCodeLine{00538\ }
\DoxyCodeLine{00539\ \ \ \ \ \textcolor{keywordtype}{void}\ signal\_kernel(Index\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}},\ Index\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}},\ Index\ k,\ \textcolor{keywordtype}{bool}\ sync)\ \{}
\DoxyCodeLine{00540\ \ \ \ \ \ \ std::atomic<uint8\_t>*\ \mbox{\hyperlink{namespacedetail_ac742e301ae0a908dc31e49ac3a31fcc5}{state}}\ =\ \&state\_kernel\_[k\ \%\ \mbox{\hyperlink{_direction_wise__hnormalized_8cpp_a98fb883180cbb2e5412955dfd6edb605}{P}}][\mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}][\mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}}];}
\DoxyCodeLine{00541\ \ \ \ \ \ \ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ \mbox{\hyperlink{main-override_8cpp_a1384e7608274313a9433fa573868557b}{s}}\ =\ \mbox{\hyperlink{namespacedetail_ac742e301ae0a908dc31e49ac3a31fcc5}{state}}-\/>load();}
\DoxyCodeLine{00542\ \ \ \ \ \ \ \mbox{\hyperlink{eigen-3_83_87_2_eigen_2src_2_core_2util_2_macros_8h_acaa7ba89800cfe18d5fd6eed620aea9c}{eigen\_assert}}(\mbox{\hyperlink{main-override_8cpp_a1384e7608274313a9433fa573868557b}{s}}\ >\ 0);}
\DoxyCodeLine{00543\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{main-override_8cpp_a1384e7608274313a9433fa573868557b}{s}}\ !=\ 1\ \&\&\ \mbox{\hyperlink{namespacedetail_ac742e301ae0a908dc31e49ac3a31fcc5}{state}}-\/>fetch\_sub(1)\ !=\ 1)\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00544\ \ \ \ \ \ \ \mbox{\hyperlink{namespacedetail_ac742e301ae0a908dc31e49ac3a31fcc5}{state}}-\/>store(parallel\_pack\_\ ?\ 3\ :\ 2,\ std::memory\_order\_relaxed);}
\DoxyCodeLine{00545\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (sync)}
\DoxyCodeLine{00546\ \ \ \ \ \ \ \ \ kernel(\mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}},\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}},\ k);}
\DoxyCodeLine{00547\ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{00548\ \ \ \ \ \ \ \ \ device\_.enqueueNoNotification([=]()\ \{\ kernel(\mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}},\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}},\ k);\ \});}
\DoxyCodeLine{00549\ \ \ \ \ \}}
\DoxyCodeLine{00550\ }
\DoxyCodeLine{00551\ \ \ \ \ \textcolor{keywordtype}{void}\ signal\_switch(Index\ k,\ Index\ \mbox{\hyperlink{_cwise__arg_8cpp_a49bb5a0db288a22a099643d44c5abbd6}{v}}\ =\ 1)\ \{}
\DoxyCodeLine{00552\ \ \ \ \ \ \ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ \mbox{\hyperlink{main-override_8cpp_a1384e7608274313a9433fa573868557b}{s}}\ =\ state\_switch\_[k\ \%\ \mbox{\hyperlink{_direction_wise__hnormalized_8cpp_a98fb883180cbb2e5412955dfd6edb605}{P}}].fetch\_sub(\mbox{\hyperlink{_cwise__arg_8cpp_a49bb5a0db288a22a099643d44c5abbd6}{v}});}
\DoxyCodeLine{00553\ \ \ \ \ \ \ \mbox{\hyperlink{eigen-3_83_87_2_eigen_2src_2_core_2util_2_macros_8h_acaa7ba89800cfe18d5fd6eed620aea9c}{eigen\_assert}}(\mbox{\hyperlink{main-override_8cpp_a1384e7608274313a9433fa573868557b}{s}}\ >=\ \mbox{\hyperlink{_cwise__arg_8cpp_a49bb5a0db288a22a099643d44c5abbd6}{v}});}
\DoxyCodeLine{00554\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{main-override_8cpp_a1384e7608274313a9433fa573868557b}{s}}\ !=\ \mbox{\hyperlink{_cwise__arg_8cpp_a49bb5a0db288a22a099643d44c5abbd6}{v}})\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00555\ }
\DoxyCodeLine{00556\ \ \ \ \ \ \ \textcolor{comment}{//\ Ready\ to\ switch\ to\ the\ next\ k\ slice.}}
\DoxyCodeLine{00557\ \ \ \ \ \ \ \textcolor{comment}{//\ Reset\ counter\ for\ the\ next\ iteration.}}
\DoxyCodeLine{00558\ \ \ \ \ \ \ state\_switch\_[k\ \%\ \mbox{\hyperlink{_direction_wise__hnormalized_8cpp_a98fb883180cbb2e5412955dfd6edb605}{P}}]\ =}
\DoxyCodeLine{00559\ \ \ \ \ \ \ \ \ \ \ (parallel\_pack\_\ ?\ nm\_\ +\ nn\_\ :\ (shard\_by\_col\_\ ?\ nn\_\ :\ nm\_))\ +}
\DoxyCodeLine{00560\ \ \ \ \ \ \ \ \ \ \ nm\_\ *\ nn\_;}
\DoxyCodeLine{00561\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (k\ <\ nk\_)\ \{}
\DoxyCodeLine{00562\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Issue\ lhs/rhs\ packing.\ Their\ completion\ will\ in\ turn\ kick\ off}}
\DoxyCodeLine{00563\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ kernels.}}
\DoxyCodeLine{00564\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (parallel\_pack\_)\ \{}
\DoxyCodeLine{00565\ \ \ \ \ \ \ \ \ \ \ enqueue\_packing(k,\ !shard\_by\_col\_);}
\DoxyCodeLine{00566\ \ \ \ \ \ \ \ \ \ \ enqueue\_packing(k,\ shard\_by\_col\_);}
\DoxyCodeLine{00567\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (shard\_by\_col\_)\ \{}
\DoxyCodeLine{00568\ \ \ \ \ \ \ \ \ \ \ enqueue\_packing(k,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00569\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00570\ \ \ \ \ \ \ \ \ \ \ enqueue\_packing(k,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00571\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00572\ }
\DoxyCodeLine{00573\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Termination\ handling.}}
\DoxyCodeLine{00574\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Because\ kernel\ completion\ signals\ k\ +\ 2\ switch,\ we\ need\ to\ finish\ nk}}
\DoxyCodeLine{00575\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ +\ 2\ slices\ without\ issuing\ any\ tasks\ on\ nk\ +\ 1\ slice.\ So\ here\ we}}
\DoxyCodeLine{00576\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ pretend\ that\ all\ nk\ +\ 1\ packing\ tasks\ just\ finish\ instantly;\ so\ that}}
\DoxyCodeLine{00577\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ nk\ +\ 2\ switch\ only\ waits\ for\ completion\ of\ nk\ kernels.}}
\DoxyCodeLine{00578\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (k\ ==\ nk\_)\ \{}
\DoxyCodeLine{00579\ \ \ \ \ \ \ \ \ signal\_switch(k\ +\ 1,}
\DoxyCodeLine{00580\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ parallel\_pack\_\ ?\ nm\_\ +\ nn\_\ :\ (shard\_by\_col\_\ ?\ nn\_\ :\ nm\_));}
\DoxyCodeLine{00581\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00582\ \ \ \ \ \ \ \ \ done\_.Notify();}
\DoxyCodeLine{00583\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00584\ \ \ \ \ \}}
\DoxyCodeLine{00585\ }
\DoxyCodeLine{00586\ \ \ \ \ \textcolor{comment}{//\ Enqueue\ all\ rhs/lhs\ packing\ for\ k-\/th\ slice.}}
\DoxyCodeLine{00587\ \ \ \ \ \textcolor{keywordtype}{void}\ enqueue\_packing(Index\ k,\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{poisson_8cpp_a38c677f5cc4e47bc7505aef707c1bb83}{rhs}})\ \{}
\DoxyCodeLine{00588\ \ \ \ \ \ \ enqueue\_packing\_helper(0,\ \mbox{\hyperlink{poisson_8cpp_a38c677f5cc4e47bc7505aef707c1bb83}{rhs}}\ ?\ nn\_\ :\ nm\_,\ k,\ \mbox{\hyperlink{poisson_8cpp_a38c677f5cc4e47bc7505aef707c1bb83}{rhs}});}
\DoxyCodeLine{00589\ \ \ \ \ \}}
\DoxyCodeLine{00590\ }
\DoxyCodeLine{00591\ \ \ \ \ \textcolor{keywordtype}{void}\ enqueue\_packing\_helper(Index\ \mbox{\hyperlink{cpq__pdes_8cpp_a455a4d1d80a69762a133ad026f1cba43}{start}},\ Index\ \mbox{\hyperlink{ittnotify__static_8h_a30bf4ccd4623b7a8276bbc7f99e491c7}{end}},\ Index\ k,\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{poisson_8cpp_a38c677f5cc4e47bc7505aef707c1bb83}{rhs}})\ \{}
\DoxyCodeLine{00592\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{ittnotify__static_8h_a30bf4ccd4623b7a8276bbc7f99e491c7}{end}}\ -\/\ \mbox{\hyperlink{cpq__pdes_8cpp_a455a4d1d80a69762a133ad026f1cba43}{start}}\ ==\ 1)\ \{}
\DoxyCodeLine{00593\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{poisson_8cpp_a38c677f5cc4e47bc7505aef707c1bb83}{rhs}})}
\DoxyCodeLine{00594\ \ \ \ \ \ \ \ \ \ \ pack\_rhs(\mbox{\hyperlink{cpq__pdes_8cpp_a455a4d1d80a69762a133ad026f1cba43}{start}},\ k);}
\DoxyCodeLine{00595\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{00596\ \ \ \ \ \ \ \ \ \ \ pack\_lhs(\mbox{\hyperlink{cpq__pdes_8cpp_a455a4d1d80a69762a133ad026f1cba43}{start}},\ k);}
\DoxyCodeLine{00597\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00598\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ mid\ =\ (\mbox{\hyperlink{cpq__pdes_8cpp_a455a4d1d80a69762a133ad026f1cba43}{start}}\ +\ \mbox{\hyperlink{ittnotify__static_8h_a30bf4ccd4623b7a8276bbc7f99e491c7}{end}})\ /\ 2;}
\DoxyCodeLine{00599\ \ \ \ \ \ \ \ \ device\_.enqueueNoNotification(}
\DoxyCodeLine{00600\ \ \ \ \ \ \ \ \ \ \ \ \ [=]()\ \{\ enqueue\_packing\_helper(mid,\ \mbox{\hyperlink{ittnotify__static_8h_a30bf4ccd4623b7a8276bbc7f99e491c7}{end}},\ k,\ \mbox{\hyperlink{poisson_8cpp_a38c677f5cc4e47bc7505aef707c1bb83}{rhs}});\ \});}
\DoxyCodeLine{00601\ \ \ \ \ \ \ \ \ device\_.enqueueNoNotification(}
\DoxyCodeLine{00602\ \ \ \ \ \ \ \ \ \ \ \ \ [=]()\ \{\ enqueue\_packing\_helper(\mbox{\hyperlink{cpq__pdes_8cpp_a455a4d1d80a69762a133ad026f1cba43}{start}},\ mid,\ k,\ \mbox{\hyperlink{poisson_8cpp_a38c677f5cc4e47bc7505aef707c1bb83}{rhs}});\ \});}
\DoxyCodeLine{00603\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00604\ \ \ \ \ \}}
\DoxyCodeLine{00605\ }
\DoxyCodeLine{00606\ \ \ \ \ \textcolor{comment}{//\ Block\ sizes\ with\ accounting\ for\ potentially\ incomplete\ last\ block.}}
\DoxyCodeLine{00607\ \ \ \ \ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ bm(Index\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}})\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}\ +\ 1\ <\ nm0\_\ ?\ bm\_\ :\ m\_\ +\ bm\_\ -\/\ bm\_\ *\ nm0\_;\ \}}
\DoxyCodeLine{00608\ \ \ \ \ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ bn(Index\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}})\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}}\ +\ 1\ <\ nn0\_\ ?\ bn\_\ :\ n\_\ +\ bn\_\ -\/\ bn\_\ *\ nn0\_;\ \}}
\DoxyCodeLine{00609\ \ \ \ \ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ bk(Index\ k)\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ k\ +\ 1\ <\ nk\_\ ?\ bk\_\ :\ k\_\ +\ bk\_\ -\/\ bk\_\ *\ nk\_;\ \}}
\DoxyCodeLine{00610\ \ \ \ \ \textcolor{comment}{//\ Task\ grain\ sizes\ accounting\ for\ potentially\ incomplete\ last\ task.}}
\DoxyCodeLine{00611\ \ \ \ \ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ gm(Index\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}})\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}\ +\ 1\ <\ nm\_\ ?\ gm\_\ :\ nm0\_\ +\ gm\_\ -\/\ gm\_\ *\ nm\_;\ \}}
\DoxyCodeLine{00612\ \ \ \ \ \mbox{\hyperlink{namespace_eigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ gn(Index\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}})\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}}\ +\ 1\ <\ nn\_\ ?\ gn\_\ :\ nn0\_\ +\ gn\_\ -\/\ gn\_\ *\ nn\_;\ \}}
\DoxyCodeLine{00613\ }
\DoxyCodeLine{00614\ \ \ \ \ Context(\textcolor{keyword}{const}\ Context\&)\ =\ \textcolor{keyword}{delete};}
\DoxyCodeLine{00615\ \ \ \ \ \textcolor{keywordtype}{void}\ operator=(\textcolor{keyword}{const}\ Context\&)\ =\ \textcolor{keyword}{delete};}
\DoxyCodeLine{00616\ \ \ \};}
\DoxyCodeLine{00617\ }
\DoxyCodeLine{00618\ \ \ \textcolor{comment}{//\ Decide\ whether\ we\ want\ to\ shard\ m\ x\ n\ contraction\ by\ columns\ or\ by\ rows.}}
\DoxyCodeLine{00619\ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{bool}\ shardByCol(\mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}},\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}},\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ num\_threads)\ \{}
\DoxyCodeLine{00620\ \ \ \ \ \textcolor{comment}{//\ Note:\ we\ are\ comparing\ both\ n\ and\ m\ against\ Traits::nr,\ it\ is\ not}}
\DoxyCodeLine{00621\ \ \ \ \ \textcolor{comment}{//\ a\ mistake.\ We\ are\ trying\ to\ figure\ out\ how\ both\ n\ and\ m\ will\ fit\ into}}
\DoxyCodeLine{00622\ \ \ \ \ \textcolor{comment}{//\ the\ main\ sharding\ dimension.}}
\DoxyCodeLine{00623\ }
\DoxyCodeLine{00624\ \ \ \ \ \textcolor{comment}{//\ Sharding\ by\ column\ is\ the\ default}}
\DoxyCodeLine{00625\ \ \ \ \ \textcolor{comment}{//\ ...\ unless\ there\ is\ enough\ data\ for\ vectorization\ over\ rows}}
\DoxyCodeLine{00626\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}\ /\ num\_threads\ >=\ Traits::nr\ \&\&}
\DoxyCodeLine{00627\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ and\ not\ enough\ data\ for\ vectorization\ over\ columns}}
\DoxyCodeLine{00628\ \ \ \ \ \ \ \ \ (\mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}}\ /\ num\_threads\ <\ Traits::nr\ ||}
\DoxyCodeLine{00629\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ ...\ or\ barely\ enough\ data\ for\ vectorization\ over\ columns,}}
\DoxyCodeLine{00630\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ but\ it\ is\ not\ evenly\ dividable\ across\ threads}}
\DoxyCodeLine{00631\ \ \ \ \ \ \ \ \ \ (\mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}}\ /\ num\_threads\ <\ 4\ *\ Traits::nr\ \&\&}
\DoxyCodeLine{00632\ \ \ \ \ \ \ \ \ \ \ (\mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}}\ \%\ (num\_threads\ *\ Traits::nr))\ !=\ 0\ \&\&}
\DoxyCodeLine{00633\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ ...\ and\ it\ is\ evenly\ dividable\ across\ threads\ for\ rows}}
\DoxyCodeLine{00634\ \ \ \ \ \ \ \ \ \ \ ((\mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}\ \%\ (num\_threads\ *\ Traits::nr))\ ==\ 0\ ||}
\DoxyCodeLine{00635\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ ..\ or\ it\ is\ not\ evenly\ dividable\ for\ both\ dimensions\ but}}
\DoxyCodeLine{00636\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ there\ is\ much\ more\ data\ over\ rows\ so\ that\ corner\ effects\ are}}
\DoxyCodeLine{00637\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ mitigated.}}
\DoxyCodeLine{00638\ \ \ \ \ \ \ \ \ \ \ \ (\mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}\ /\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}}\ >=\ 6)))))}
\DoxyCodeLine{00639\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00640\ \ \ \ \ \textcolor{comment}{//\ Wait,\ or\ if\ matrices\ are\ just\ substantially\ prolonged\ over\ the\ other}}
\DoxyCodeLine{00641\ \ \ \ \ \textcolor{comment}{//\ dimension.}}
\DoxyCodeLine{00642\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}}\ /\ num\_threads\ <\ 16\ *\ Traits::nr\ \&\&\ m\ >\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}}\ *\ 32)\ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00643\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00644\ \ \ \}}
\DoxyCodeLine{00645\ }
\DoxyCodeLine{00646\ \ \ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ coarsenM(\mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}},\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}},\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ bm,\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ bn,\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ bk,\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ gn,}
\DoxyCodeLine{00647\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ num\_threads,\ \textcolor{keywordtype}{bool}\ shard\_by\_col)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00648\ \ \ \ \ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ gm\ =\ 1;}
\DoxyCodeLine{00649\ \ \ \ \ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ gm1\ =\ 1;}
\DoxyCodeLine{00650\ \ \ \ \ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ nm0\ =\ \mbox{\hyperlink{namespace_eigen_a13ec9832931270b80961236d30f6d2e3}{divup}}(\mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}},\ bm);}
\DoxyCodeLine{00651\ \ \ \ \ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ nm1\ =\ nm0;}
\DoxyCodeLine{00652\ \ \ \ \ \textcolor{keywordflow}{for}\ (;;)\ \{}
\DoxyCodeLine{00653\ \ \ \ \ \ \ \textcolor{comment}{//\ Find\ the\ next\ candidate\ for\ m\ grain\ size.\ It\ needs\ to\ result\ in}}
\DoxyCodeLine{00654\ \ \ \ \ \ \ \textcolor{comment}{//\ different\ number\ of\ blocks.\ E.g.\ if\ we\ have\ 10\ kernels,\ we\ want\ to\ try}}
\DoxyCodeLine{00655\ \ \ \ \ \ \ \textcolor{comment}{//\ 5\ and\ 10,\ but\ not\ 6,\ 7,\ 8\ and\ 9.}}
\DoxyCodeLine{00656\ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (gm1\ <=\ nm0\ \&\&\ nm1\ ==\ \mbox{\hyperlink{namespace_eigen_a13ec9832931270b80961236d30f6d2e3}{divup}}(nm0,\ gm1))\ gm1++;}
\DoxyCodeLine{00657\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (gm1\ >\ nm0)\ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00658\ \ \ \ \ \ \ \textcolor{comment}{//\ Check\ the\ candidate.}}
\DoxyCodeLine{00659\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{_partial_redux__count_8cpp_acbe60897559b79afc28b79b0687b5f29}{res}}\ =\ checkGrain(\mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}},\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}},\ bm,\ bn,\ bk,\ gm1,\ gn,\ gm,\ gn,\ num\_threads,}
\DoxyCodeLine{00660\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ shard\_by\_col);}
\DoxyCodeLine{00661\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{_partial_redux__count_8cpp_acbe60897559b79afc28b79b0687b5f29}{res}}\ <\ 0)\ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00662\ \ \ \ \ \ \ nm1\ =\ \mbox{\hyperlink{namespace_eigen_a13ec9832931270b80961236d30f6d2e3}{divup}}(nm0,\ gm1);}
\DoxyCodeLine{00663\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{_partial_redux__count_8cpp_acbe60897559b79afc28b79b0687b5f29}{res}}\ ==\ 0)\ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00664\ \ \ \ \ \ \ \textcolor{comment}{//\ Commit\ new\ grain\ size.}}
\DoxyCodeLine{00665\ \ \ \ \ \ \ gm\ =\ gm1;}
\DoxyCodeLine{00666\ \ \ \ \ \}}
\DoxyCodeLine{00667\ \ \ \ \ \textcolor{keywordflow}{return}\ gm;}
\DoxyCodeLine{00668\ \ \ \}}
\DoxyCodeLine{00669\ }
\DoxyCodeLine{00670\ \ \ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ coarsenN(\mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}},\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}},\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ bm,\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ bn,\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ bk,\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ gm,}
\DoxyCodeLine{00671\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ num\_threads,\ \textcolor{keywordtype}{bool}\ shard\_by\_col)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00672\ \ \ \ \ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ gn\ =\ 1;}
\DoxyCodeLine{00673\ \ \ \ \ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ gn1\ =\ 1;}
\DoxyCodeLine{00674\ \ \ \ \ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ nn0\ =\ \mbox{\hyperlink{namespace_eigen_a13ec9832931270b80961236d30f6d2e3}{divup}}(\mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}},\ bn);}
\DoxyCodeLine{00675\ \ \ \ \ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ nn1\ =\ nn0;}
\DoxyCodeLine{00676\ \ \ \ \ \textcolor{keywordflow}{for}\ (;;)\ \{}
\DoxyCodeLine{00677\ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (gn1\ <=\ nn0\ \&\&\ nn1\ ==\ \mbox{\hyperlink{namespace_eigen_a13ec9832931270b80961236d30f6d2e3}{divup}}(nn0,\ gn1))\ gn1++;}
\DoxyCodeLine{00678\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (gn1\ >\ nn0)\ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00679\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{_partial_redux__count_8cpp_acbe60897559b79afc28b79b0687b5f29}{res}}\ =\ checkGrain(\mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}},\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}},\ bm,\ bn,\ bk,\ gm,\ gn1,\ gm,\ gn,\ num\_threads,}
\DoxyCodeLine{00680\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ shard\_by\_col);}
\DoxyCodeLine{00681\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{_partial_redux__count_8cpp_acbe60897559b79afc28b79b0687b5f29}{res}}\ <\ 0)\ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00682\ \ \ \ \ \ \ nn1\ =\ \mbox{\hyperlink{namespace_eigen_a13ec9832931270b80961236d30f6d2e3}{divup}}(nn0,\ gn1);}
\DoxyCodeLine{00683\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{_partial_redux__count_8cpp_acbe60897559b79afc28b79b0687b5f29}{res}}\ ==\ 0)\ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00684\ \ \ \ \ \ \ gn\ =\ gn1;}
\DoxyCodeLine{00685\ \ \ \ \ \}}
\DoxyCodeLine{00686\ \ \ \ \ \textcolor{keywordflow}{return}\ gn;}
\DoxyCodeLine{00687\ \ \ \}}
\DoxyCodeLine{00688\ }
\DoxyCodeLine{00689\ \ \ \textcolor{comment}{//\ checkGrain\ checks\ whether\ grain\ (gm,\ gn)\ is\ suitable\ and\ is\ better\ than}}
\DoxyCodeLine{00690\ \ \ \textcolor{comment}{//\ (oldgm,\ oldgn).}}
\DoxyCodeLine{00691\ \ \ \textcolor{keywordtype}{int}\ checkGrain(\mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}},\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}},\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ bm,\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ bn,\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ bk,\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ gm,}
\DoxyCodeLine{00692\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ gn,\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ oldgm,\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ oldgn,\ \textcolor{keywordtype}{int}\ num\_threads,}
\DoxyCodeLine{00693\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ shard\_by\_col)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00694\ \ \ \ \ \textcolor{keyword}{const}\ TensorOpCost\ cost\ =}
\DoxyCodeLine{00695\ \ \ \ \ \ \ \ \ contractionCost(bm\ *\ gm,\ bn\ *\ gn,\ bm,\ bn,\ bk,\ shard\_by\_col,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00696\ \ \ \ \ \textcolor{keywordtype}{double}\ taskSize\ =\ \mbox{\hyperlink{class_eigen_1_1_tensor_cost_model_aaae32b6af60750622e87ac1f34766c1b}{TensorCostModel<ThreadPoolDevice>::taskSize}}(}
\DoxyCodeLine{00697\ \ \ \ \ \ \ \ \ \textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{double}\textcolor{keyword}{>}(bm)\ *\ gm\ *\ bn\ *\ gn,\ cost);}
\DoxyCodeLine{00698\ \ \ \ \ \textcolor{comment}{//\ If\ the\ task\ is\ too\ small,\ then\ we\ agree\ on\ it\ regardless\ of\ anything}}
\DoxyCodeLine{00699\ \ \ \ \ \textcolor{comment}{//\ else.\ Otherwise\ synchronization\ overheads\ will\ dominate.}}
\DoxyCodeLine{00700\ \ \ \ \ \textcolor{keywordflow}{if}\ (taskSize\ <\ 1)\ \textcolor{keywordflow}{return}\ 1;}
\DoxyCodeLine{00701\ \ \ \ \ \textcolor{comment}{//\ If\ it\ is\ too\ large,\ then\ we\ reject\ it\ and\ all\ larger\ tasks.}}
\DoxyCodeLine{00702\ \ \ \ \ \textcolor{keywordflow}{if}\ (taskSize\ >\ 2)\ \textcolor{keywordflow}{return}\ -\/1;}
\DoxyCodeLine{00703\ \ \ \ \ \textcolor{comment}{//\ Now\ we\ are\ in\ presumably\ good\ task\ size\ range.}}
\DoxyCodeLine{00704\ \ \ \ \ \textcolor{comment}{//\ The\ main\ deciding\ factor\ here\ is\ parallelism.\ Consider\ that\ we\ have\ 12}}
\DoxyCodeLine{00705\ \ \ \ \ \textcolor{comment}{//\ kernels\ and\ 4\ threads.\ Grains\ of\ 2,\ 3\ and\ 4\ all\ yield\ good\ task\ sizes.}}
\DoxyCodeLine{00706\ \ \ \ \ \textcolor{comment}{//\ But\ 2/4\ yield\ 6/3\ tasks,\ which\ gives\ us\ parallelism\ of\ 0.75\ (at\ most\ 3/4}}
\DoxyCodeLine{00707\ \ \ \ \ \textcolor{comment}{//\ of\ cores\ will\ be\ busy).\ While\ grain\ size\ 3\ gives\ us\ 4\ tasks,\ which\ gives}}
\DoxyCodeLine{00708\ \ \ \ \ \textcolor{comment}{//\ us\ parallelism\ of\ 1\ (we\ can\ load\ all\ cores).}}
\DoxyCodeLine{00709\ \ \ \ \ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ nm0\ =\ \mbox{\hyperlink{namespace_eigen_a13ec9832931270b80961236d30f6d2e3}{divup}}(\mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}},\ bm);}
\DoxyCodeLine{00710\ \ \ \ \ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ nn0\ =\ \mbox{\hyperlink{namespace_eigen_a13ec9832931270b80961236d30f6d2e3}{divup}}(\mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}},\ bn);}
\DoxyCodeLine{00711\ \ \ \ \ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ new\_tasks\ =\ \mbox{\hyperlink{namespace_eigen_a13ec9832931270b80961236d30f6d2e3}{divup}}(nm0,\ gm)\ *\ \mbox{\hyperlink{namespace_eigen_a13ec9832931270b80961236d30f6d2e3}{divup}}(nn0,\ gn);}
\DoxyCodeLine{00712\ \ \ \ \ \textcolor{keywordtype}{double}\ new\_parallelism\ =\ \textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{double}\textcolor{keyword}{>}(new\_tasks)\ /}
\DoxyCodeLine{00713\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (\mbox{\hyperlink{namespace_eigen_a13ec9832931270b80961236d30f6d2e3}{divup<int>}}(new\_tasks,\ num\_threads)\ *\ num\_threads);}
\DoxyCodeLine{00714\ \ \ \ \ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ old\_tasks\ =\ \mbox{\hyperlink{namespace_eigen_a13ec9832931270b80961236d30f6d2e3}{divup}}(nm0,\ oldgm)\ *\ \mbox{\hyperlink{namespace_eigen_a13ec9832931270b80961236d30f6d2e3}{divup}}(nn0,\ oldgn);}
\DoxyCodeLine{00715\ \ \ \ \ \textcolor{keywordtype}{double}\ old\_parallelism\ =\ \textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{double}\textcolor{keyword}{>}(old\_tasks)\ /}
\DoxyCodeLine{00716\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (\mbox{\hyperlink{namespace_eigen_a13ec9832931270b80961236d30f6d2e3}{divup<int>}}(old\_tasks,\ num\_threads)\ *\ num\_threads);}
\DoxyCodeLine{00717\ \ \ \ \ \textcolor{keywordflow}{if}\ (new\_parallelism\ >\ old\_parallelism\ ||\ new\_parallelism\ ==\ 1)\ \textcolor{keywordflow}{return}\ 1;}
\DoxyCodeLine{00718\ \ \ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00719\ \ \ \}}
\DoxyCodeLine{00720\ }
\DoxyCodeLine{00721\ \textcolor{preprocessor}{\#else\ \ }\textcolor{comment}{//\ EIGEN\_USE\_SIMPLE\_THREAD\_POOL}}
\DoxyCodeLine{00722\ }
\DoxyCodeLine{00723\ \ \ \textcolor{keyword}{template}\ <\textcolor{keywordtype}{bool}\ lhs\_inner\_dim\_contiguous,\ \textcolor{keywordtype}{bool}\ rhs\_inner\_dim\_contiguous,\ \textcolor{keywordtype}{bool}\ rhs\_inner\_dim\_reordered,\ \textcolor{keywordtype}{int}\ Alignment>}
\DoxyCodeLine{00724\ \ \ \textcolor{keywordtype}{void}\ evalProduct(\mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a163cadb184cc08462355caf1031115a4}{Scalar}}*\ \mbox{\hyperlink{sugar_8h_aaadc06b5dac8070de2c8677210967bdb}{buffer}})\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00725\ \ \ \ \ \textcolor{keywordflow}{if}\ (this-\/>m\_j\_size\ ==\ 1)\ \{}
\DoxyCodeLine{00726\ \ \ \ \ \ \ this-\/>\textcolor{keyword}{template}\ evalGemv<lhs\_inner\_dim\_contiguous,\ rhs\_inner\_dim\_contiguous,\ rhs\_inner\_dim\_reordered,\ Alignment>(\mbox{\hyperlink{sugar_8h_aaadc06b5dac8070de2c8677210967bdb}{buffer}});}
\DoxyCodeLine{00727\ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00728\ \ \ \ \ \}}
\DoxyCodeLine{00729\ }
\DoxyCodeLine{00730\ \ \ \ \ evalGemm<lhs\_inner\_dim\_contiguous,\ rhs\_inner\_dim\_contiguous,\ rhs\_inner\_dim\_reordered,\ Alignment>(\mbox{\hyperlink{sugar_8h_aaadc06b5dac8070de2c8677210967bdb}{buffer}});}
\DoxyCodeLine{00731\ \ \ \}}
\DoxyCodeLine{00732\ }
\DoxyCodeLine{00733\ \ \ \textcolor{keyword}{template}\ <\textcolor{keywordtype}{bool}\ lhs\_inner\_dim\_contiguous,\ \textcolor{keywordtype}{bool}\ rhs\_inner\_dim\_contiguous,\ \textcolor{keywordtype}{bool}\ rhs\_inner\_dim\_reordered,\ \textcolor{keywordtype}{int}\ Alignment>}
\DoxyCodeLine{00734\ \ \ \textcolor{keywordtype}{void}\ evalGemm(\mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a163cadb184cc08462355caf1031115a4}{Scalar}}*\ \mbox{\hyperlink{sugar_8h_aaadc06b5dac8070de2c8677210967bdb}{buffer}})\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00735\ \ \ \ \ \textcolor{comment}{//\ columns\ in\ left\ side,\ rows\ in\ right\ side}}
\DoxyCodeLine{00736\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ k\ =\ this-\/>m\_k\_size;}
\DoxyCodeLine{00737\ }
\DoxyCodeLine{00738\ \ \ \ \ \textcolor{comment}{//\ rows\ in\ left\ side}}
\DoxyCodeLine{00739\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}\ =\ this-\/>m\_i\_size;}
\DoxyCodeLine{00740\ }
\DoxyCodeLine{00741\ \ \ \ \ \textcolor{comment}{//\ columns\ in\ right\ side}}
\DoxyCodeLine{00742\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}}\ =\ this-\/>m\_j\_size;}
\DoxyCodeLine{00743\ }
\DoxyCodeLine{00744\ \ \ \ \ \textcolor{comment}{//\ zero\ out\ the\ result\ buffer\ (which\ must\ be\ of\ size\ at\ least\ m\ *\ n\ *\ sizeof(Scalar)}}
\DoxyCodeLine{00745\ \ \ \ \ this-\/>\mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a13eb5009d2c2e60155de55e7c3d2bd6f}{m\_device}}.memset(\mbox{\hyperlink{sugar_8h_aaadc06b5dac8070de2c8677210967bdb}{buffer}},\ 0,\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}\ *\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}}\ *\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a163cadb184cc08462355caf1031115a4}{Scalar}}));}
\DoxyCodeLine{00746\ }
\DoxyCodeLine{00747\ }
\DoxyCodeLine{00748\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ lhs\_packet\_size\ =\ \mbox{\hyperlink{struct_eigen_1_1internal_1_1unpacket__traits_a5493b6385ef3a8958b09c00eed0ec26ba63cc10676eb13001d700f7bc4336f6ee}{internal::unpacket\_traits<typename\ LeftEvaluator::PacketReturnType>::size}};}
\DoxyCodeLine{00749\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ rhs\_packet\_size\ =\ \mbox{\hyperlink{struct_eigen_1_1internal_1_1unpacket__traits_a5493b6385ef3a8958b09c00eed0ec26ba63cc10676eb13001d700f7bc4336f6ee}{internal::unpacket\_traits<typename\ RightEvaluator::PacketReturnType>::size}};}
\DoxyCodeLine{00750\ }
\DoxyCodeLine{00751\ \ \ \ \ \textcolor{keyword}{typedef}\ internal::TensorContractionInputMapper<LhsScalar,\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}},\ \mbox{\hyperlink{namespace_eigen_1_1internal_a091d923f61a5d455b1573e17b015adf9a1a7f4ccbeaf23168b50a83680f8f35fb}{internal::Lhs}},}
\DoxyCodeLine{00752\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ LeftEvaluator,\ left\_nocontract\_t,}
\DoxyCodeLine{00753\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ contract\_t,\ lhs\_packet\_size,}
\DoxyCodeLine{00754\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ lhs\_inner\_dim\_contiguous,}
\DoxyCodeLine{00755\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{false},\ \mbox{\hyperlink{group__enums_gga45fe06e29902b7a2773de05ba27b47a1a4e19dd09d5ff42295ba1d72d12a46686}{Unaligned}}>\ LhsMapper;}
\DoxyCodeLine{00756\ }
\DoxyCodeLine{00757\ \ \ \ \ \textcolor{keyword}{typedef}\ internal::TensorContractionInputMapper<RhsScalar,\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}},\ \mbox{\hyperlink{namespace_eigen_1_1internal_a091d923f61a5d455b1573e17b015adf9a6c8de80f9984c6a6da22b7c288fee57d}{internal::Rhs}},}
\DoxyCodeLine{00758\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ RightEvaluator,\ right\_nocontract\_t,}
\DoxyCodeLine{00759\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ contract\_t,\ rhs\_packet\_size,}
\DoxyCodeLine{00760\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ rhs\_inner\_dim\_contiguous,}
\DoxyCodeLine{00761\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ rhs\_inner\_dim\_reordered,\ \mbox{\hyperlink{group__enums_gga45fe06e29902b7a2773de05ba27b47a1a4e19dd09d5ff42295ba1d72d12a46686}{Unaligned}}>\ RhsMapper;}
\DoxyCodeLine{00762\ }
\DoxyCodeLine{00763\ \ \ \ \ \textcolor{keyword}{typedef}\ internal::blas\_data\_mapper<Scalar,\ Index,\ ColMajor>\ OutputMapper;}
\DoxyCodeLine{00764\ }
\DoxyCodeLine{00765\ \ \ \ \ \textcolor{comment}{//\ TODO:\ packing\ could\ be\ faster\ sometimes\ if\ we\ supported\ row\ major\ tensor\ mappers}}
\DoxyCodeLine{00766\ \ \ \ \ \textcolor{keyword}{typedef}\ internal::gemm\_pack\_lhs<LhsScalar,\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}},\ \textcolor{keyword}{typename}\ LhsMapper::SubMapper,\ Traits::mr,}
\DoxyCodeLine{00767\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Traits::LhsProgress,\ \mbox{\hyperlink{group__enums_ggaacded1a18ae58b0f554751f6cdf9eb13a0103672ae41005ab03b4176c765afd62}{ColMajor}}>\ LhsPacker;}
\DoxyCodeLine{00768\ \ \ \ \ \textcolor{keyword}{typedef}\ internal::gemm\_pack\_rhs<RhsScalar,\ Index,\ typename\ RhsMapper::SubMapper,\ Traits::nr,\ ColMajor>\ RhsPacker;}
\DoxyCodeLine{00769\ }
\DoxyCodeLine{00770\ \ \ \ \ \textcolor{comment}{//\ TODO:\ replace\ false,\ false\ with\ conjugate\ values?}}
\DoxyCodeLine{00771\ \ \ \ \ \textcolor{keyword}{typedef}\ internal::gebp\_kernel<LhsScalar,\ RhsScalar,\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}},\ OutputMapper,}
\DoxyCodeLine{00772\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Traits::mr,\ Traits::nr,\ \textcolor{keyword}{false},\ \textcolor{keyword}{false}>\ GebpKernel;}
\DoxyCodeLine{00773\ }
\DoxyCodeLine{00774\ \ \ \ \ \textcolor{keyword}{typedef}\ internal::packLhsArg<LhsScalar,\ LhsMapper,\ Index>\ packLArg;}
\DoxyCodeLine{00775\ \ \ \ \ \textcolor{keyword}{typedef}\ internal::packRhsAndKernelArg<LhsScalar,\ RhsScalar,\ RhsMapper,\ OutputMapper,\ Index>\ packRKArg;}
\DoxyCodeLine{00776\ }
\DoxyCodeLine{00777\ \ \ \ \ \textcolor{comment}{//\ initialize\ data\ mappers}}
\DoxyCodeLine{00778\ \ \ \ \ LhsMapper\ lhs(this-\/>m\_leftImpl,\ this-\/>m\_left\_nocontract\_strides,\ this-\/>m\_i\_strides,}
\DoxyCodeLine{00779\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ this-\/>m\_left\_contracting\_strides,\ this-\/>m\_k\_strides);}
\DoxyCodeLine{00780\ }
\DoxyCodeLine{00781\ \ \ \ \ RhsMapper\ \mbox{\hyperlink{poisson_8cpp_a38c677f5cc4e47bc7505aef707c1bb83}{rhs}}(this-\/>m\_rightImpl,\ this-\/>m\_right\_nocontract\_strides,\ this-\/>m\_j\_strides,}
\DoxyCodeLine{00782\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ this-\/>m\_right\_contracting\_strides,\ this-\/>m\_k\_strides);}
\DoxyCodeLine{00783\ }
\DoxyCodeLine{00784\ \ \ \ \ OutputMapper\ \mbox{\hyperlink{benchmarks_2scan_2scan_8hpp_a8390452002ecc7a0dadc5ae0dccc9b6c}{output}}(\mbox{\hyperlink{sugar_8h_aaadc06b5dac8070de2c8677210967bdb}{buffer}},\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}});}
\DoxyCodeLine{00785\ }
\DoxyCodeLine{00786\ \ \ \ \ \textcolor{comment}{//\ compute\ block\ sizes\ (which\ depend\ on\ number\ of\ threads)}}
\DoxyCodeLine{00787\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ num\_threads\ =\ this-\/>\mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a13eb5009d2c2e60155de55e7c3d2bd6f}{m\_device}}.numThreads();}
\DoxyCodeLine{00788\ \ \ \ \ internal::TensorContractionBlocking<LhsMapper,\ RhsMapper,\ Index,\ internal::ShardByCol>\ blocking(k,\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}},\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}},\ num\_threads);}
\DoxyCodeLine{00789\ \ \ \ \ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ mc\ =\ blocking.mc();}
\DoxyCodeLine{00790\ \ \ \ \ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ nc\ =\ blocking.nc();}
\DoxyCodeLine{00791\ \ \ \ \ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ kc\ =\ blocking.kc();}
\DoxyCodeLine{00792\ \ \ \ \ \mbox{\hyperlink{eigen-3_83_87_2_eigen_2src_2_core_2util_2_macros_8h_acaa7ba89800cfe18d5fd6eed620aea9c}{eigen\_assert}}(mc\ <=\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}});}
\DoxyCodeLine{00793\ \ \ \ \ \mbox{\hyperlink{eigen-3_83_87_2_eigen_2src_2_core_2util_2_macros_8h_acaa7ba89800cfe18d5fd6eed620aea9c}{eigen\_assert}}(nc\ <=\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}});}
\DoxyCodeLine{00794\ \ \ \ \ \mbox{\hyperlink{eigen-3_83_87_2_eigen_2src_2_core_2util_2_macros_8h_acaa7ba89800cfe18d5fd6eed620aea9c}{eigen\_assert}}(kc\ <=\ k);}
\DoxyCodeLine{00795\ }
\DoxyCodeLine{00796\ \textcolor{preprocessor}{\#define\ CEIL\_DIV(a,\ b)\ (((a)\ +\ (b)\ -\/\ 1)\ /\ (b))}}
\DoxyCodeLine{00797\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ k\_blocks\ =\ CEIL\_DIV(k,\ kc);}
\DoxyCodeLine{00798\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ n\_blocks\ =\ CEIL\_DIV(\mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}},\ nc);}
\DoxyCodeLine{00799\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ m\_blocks\ =\ CEIL\_DIV(\mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}},\ mc);}
\DoxyCodeLine{00800\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ sizeA\ =\ mc\ *\ kc;}
\DoxyCodeLine{00801\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ sizeB\ =\ kc\ *\ nc;}
\DoxyCodeLine{00802\ }
\DoxyCodeLine{00803\ \ \ \ \ \textcolor{comment}{/*\ \ \ \ cout\ <<\ "{}m:\ "{}\ <<\ m\ <<\ "{}\ n:\ "{}\ <<\ n\ <<\ "{}\ k:\ "{}\ <<\ k\ <<\ endl;}}
\DoxyCodeLine{00804\ \textcolor{comment}{\ \ \ \ cout\ <<\ "{}mc:\ "{}\ <<\ mc\ <<\ "{}\ nc:\ "{}\ <<\ nc\ <<\ "{}\ kc:\ "{}\ <<\ kc\ <<\ endl;}}
\DoxyCodeLine{00805\ \textcolor{comment}{\ \ \ \ cout\ <<\ "{}m\_blocks:\ "{}\ <<\ m\_blocks\ <<\ "{}\ n\_blocks:\ "{}\ <<\ n\_blocks\ <<\ "{}\ k\_blocks:\ "{}\ <<\ k\_blocks\ <<\ endl;}}
\DoxyCodeLine{00806\ \textcolor{comment}{\ \ \ \ cout\ <<\ "{}num\ threads:\ "{}\ <<\ num\_threads\ <<\ endl;}}
\DoxyCodeLine{00807\ \textcolor{comment}{\ \ \ \ */}}
\DoxyCodeLine{00808\ }
\DoxyCodeLine{00809\ \ \ \ \ \textcolor{comment}{//\ note:\ m\_device.allocate\ should\ return\ 16\ byte\ aligned\ pointers,\ but\ if\ blockA\ and\ blockB}}
\DoxyCodeLine{00810\ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ \ \ aren't\ 16\ byte\ aligned\ segfaults\ will\ happen\ due\ to\ SIMD\ instructions}}
\DoxyCodeLine{00811\ \ \ \ \ \textcolor{comment}{//\ note:\ You\ can\ get\ away\ with\ allocating\ just\ a\ single\ blockA\ and\ offsets\ and\ meet\ the}}
\DoxyCodeLine{00812\ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ \ \ the\ alignment\ requirements\ with\ the\ assumption\ that}}
\DoxyCodeLine{00813\ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ \ \ (Traits::mr\ *\ sizeof(ResScalar))\ \%\ 16\ ==\ 0}}
\DoxyCodeLine{00814\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ numBlockAs\ =\ \mbox{\hyperlink{namespace_eigen_1_1numext_ab3b30bf0bcfa1ad91dbec75fabb3bea0}{numext::mini}}(num\_threads,\ m\_blocks);}
\DoxyCodeLine{00815\ \ \ \ \ MaxSizeVector<LhsScalar\ *>\ blockAs(num\_threads);}
\DoxyCodeLine{00816\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}\ =\ 0;\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}\ <\ num\_threads;\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}++)\ \{}
\DoxyCodeLine{00817\ \ \ \ \ \ \ blockAs.push\_back(\textcolor{keyword}{static\_cast<}LhsScalar\ *\textcolor{keyword}{>}(this-\/>\mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a13eb5009d2c2e60155de55e7c3d2bd6f}{m\_device}}.allocate(sizeA\ *\ \textcolor{keyword}{sizeof}(LhsScalar))));}
\DoxyCodeLine{00818\ \ \ \ \ \}}
\DoxyCodeLine{00819\ }
\DoxyCodeLine{00820\ \ \ \ \ \textcolor{comment}{//\ To\ circumvent\ alignment\ issues,\ I'm\ just\ going\ to\ separately\ allocate\ the\ memory\ for\ each\ thread}}
\DoxyCodeLine{00821\ \ \ \ \ \textcolor{comment}{//\ TODO:\ is\ this\ too\ much\ memory\ to\ allocate?\ This\ simplifies\ coding\ a\ lot,\ but\ is\ wasteful.}}
\DoxyCodeLine{00822\ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ \ \ Other\ options:\ (1)\ reuse\ memory\ when\ a\ thread\ finishes.\ con:\ tricky}}
\DoxyCodeLine{00823\ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (2)\ allocate\ block\ B\ memory\ in\ each\ thread.\ con:\ overhead}}
\DoxyCodeLine{00824\ \ \ \ \ MaxSizeVector<RhsScalar\ *>\ blockBs(n\_blocks);}
\DoxyCodeLine{00825\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}\ =\ 0;\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}\ <\ n\_blocks;\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}++)\ \{}
\DoxyCodeLine{00826\ \ \ \ \ \ \ blockBs.push\_back(\textcolor{keyword}{static\_cast<}RhsScalar\ *\textcolor{keyword}{>}(this-\/>\mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a13eb5009d2c2e60155de55e7c3d2bd6f}{m\_device}}.allocate(sizeB\ *\ \textcolor{keyword}{sizeof}(RhsScalar))));}
\DoxyCodeLine{00827\ \ \ \ \ \}}
\DoxyCodeLine{00828\ }
\DoxyCodeLine{00829\ \ \ \ \ \textcolor{comment}{//\ lhs\_notifications\ starts\ with\ all\ null\ Notifications}}
\DoxyCodeLine{00830\ \ \ \ \ MaxSizeVector<Notification*>\ lhs\_notifications(num\_threads,\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00831\ }
\DoxyCodeLine{00832\ \ \ \ \ \textcolor{comment}{//\ this\ should\ really\ be\ numBlockAs\ *\ n\_blocks;}}
\DoxyCodeLine{00833\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ num\_kernel\_notifications\ =\ num\_threads\ *\ n\_blocks;}
\DoxyCodeLine{00834\ \ \ \ \ MaxSizeVector<Notification*>\ kernel\_notifications(num\_kernel\_notifications,}
\DoxyCodeLine{00835\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00836\ }
\DoxyCodeLine{00837\ \ \ \ \ \textcolor{keywordflow}{for}\ (\mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ k\_block\_idx\ =\ 0;\ k\_block\_idx\ <\ k\_blocks;\ k\_block\_idx++)\ \{}
\DoxyCodeLine{00838\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ k\_start\ =\ k\_block\_idx\ *\ kc;}
\DoxyCodeLine{00839\ \ \ \ \ \ \ \textcolor{comment}{//\ make\ sure\ we\ don't\ overshoot\ right\ edge\ of\ left\ matrix}}
\DoxyCodeLine{00840\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ actual\_kc\ =\ \mbox{\hyperlink{namespace_eigen_1_1numext_ab3b30bf0bcfa1ad91dbec75fabb3bea0}{numext::mini}}(k\_start\ +\ kc,\ k)\ -\/\ k\_start;}
\DoxyCodeLine{00841\ }
\DoxyCodeLine{00842\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ m\_block\_idx\ =\ 0;\ m\_block\_idx\ <\ m\_blocks;\ m\_block\_idx\ +=\ numBlockAs)\ \{}
\DoxyCodeLine{00843\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ num\_blocks\ =\ \mbox{\hyperlink{namespace_eigen_1_1numext_ab3b30bf0bcfa1ad91dbec75fabb3bea0}{numext::mini}}(m\_blocks-\/m\_block\_idx,\ numBlockAs);}
\DoxyCodeLine{00844\ }
\DoxyCodeLine{00845\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ mt\_block\_idx\ =\ m\_block\_idx;\ mt\_block\_idx\ <\ m\_block\_idx+num\_blocks;\ mt\_block\_idx++)\ \{}
\DoxyCodeLine{00846\ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ m\_start\ =\ mt\_block\_idx\ *\ mc;}
\DoxyCodeLine{00847\ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ actual\_mc\ =\ \mbox{\hyperlink{namespace_eigen_1_1numext_ab3b30bf0bcfa1ad91dbec75fabb3bea0}{numext::mini}}(m\_start\ +\ mc,\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}})\ -\/\ m\_start;}
\DoxyCodeLine{00848\ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{eigen-3_83_87_2_eigen_2src_2_core_2util_2_macros_8h_acaa7ba89800cfe18d5fd6eed620aea9c}{eigen\_assert}}(actual\_mc\ >\ 0);}
\DoxyCodeLine{00849\ }
\DoxyCodeLine{00850\ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ blockAId\ =\ (k\_block\_idx\ *\ m\_blocks\ +\ mt\_block\_idx)\ \%\ num\_threads;}
\DoxyCodeLine{00851\ }
\DoxyCodeLine{00852\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}\ =\ 0;\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}\ <\ n\_blocks;\ ++\mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}})\ \{}
\DoxyCodeLine{00853\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ notification\_id\ =\ (blockAId\ *\ n\_blocks\ +\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}});}
\DoxyCodeLine{00854\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Wait\ for\ any\ current\ kernels\ using\ this\ slot\ to\ complete}}
\DoxyCodeLine{00855\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ before\ using\ it.}}
\DoxyCodeLine{00856\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (kernel\_notifications[notification\_id])\ \{}
\DoxyCodeLine{00857\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ wait\_until\_ready(kernel\_notifications[notification\_id]);}
\DoxyCodeLine{00858\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{delete}\ kernel\_notifications[notification\_id];}
\DoxyCodeLine{00859\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00860\ \ \ \ \ \ \ \ \ \ \ \ \ kernel\_notifications[notification\_id]\ =\ \textcolor{keyword}{new}\ Notification();}
\DoxyCodeLine{00861\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00862\ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ packLArg\ \mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}}\ =\ \{}
\DoxyCodeLine{00863\ \ \ \ \ \ \ \ \ \ \ \ \ blockAs[blockAId],\ \textcolor{comment}{//\ blockA}}
\DoxyCodeLine{00864\ \ \ \ \ \ \ \ \ \ \ \ \ lhs,\ \ \ \ \ \ \ \ \textcolor{comment}{//\ lhs}}
\DoxyCodeLine{00865\ \ \ \ \ \ \ \ \ \ \ \ \ m\_start,\ \ \ \ \textcolor{comment}{//\ m}}
\DoxyCodeLine{00866\ \ \ \ \ \ \ \ \ \ \ \ \ k\_start,\ \ \ \ \textcolor{comment}{//\ k}}
\DoxyCodeLine{00867\ \ \ \ \ \ \ \ \ \ \ \ \ actual\_mc,\ \ \textcolor{comment}{//\ mc}}
\DoxyCodeLine{00868\ \ \ \ \ \ \ \ \ \ \ \ \ actual\_kc,\ \ \textcolor{comment}{//\ kc}}
\DoxyCodeLine{00869\ \ \ \ \ \ \ \ \ \ \ \};}
\DoxyCodeLine{00870\ }
\DoxyCodeLine{00871\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Delete\ any\ existing\ notification\ since\ we\ may\ be}}
\DoxyCodeLine{00872\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ replacing\ it.\ \ The\ algorithm\ should\ ensure\ that\ there\ are}}
\DoxyCodeLine{00873\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ no\ existing\ waiters\ on\ this\ notification.}}
\DoxyCodeLine{00874\ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{delete}\ lhs\_notifications[blockAId];}
\DoxyCodeLine{00875\ \ \ \ \ \ \ \ \ \ \ lhs\_notifications[blockAId]\ =}
\DoxyCodeLine{00876\ \ \ \ \ \ \ \ \ \ \ this-\/>\mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a13eb5009d2c2e60155de55e7c3d2bd6f}{m\_device}}.enqueue(\&Self::packLhs<packLArg,\ LhsPacker>,\ \mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}});}
\DoxyCodeLine{00877\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00878\ }
\DoxyCodeLine{00879\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ now\ start\ kernels.}}
\DoxyCodeLine{00880\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ m\_base\_start\ =\ m\_block\_idx\ *\ mc;}
\DoxyCodeLine{00881\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{bool}\ need\_to\_pack\ =\ m\_block\_idx\ ==\ 0;}
\DoxyCodeLine{00882\ }
\DoxyCodeLine{00883\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ n\_block\_idx\ =\ 0;\ n\_block\_idx\ <\ n\_blocks;\ n\_block\_idx++)\ \{}
\DoxyCodeLine{00884\ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ n\_start\ =\ n\_block\_idx\ *\ nc;}
\DoxyCodeLine{00885\ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ actual\_nc\ =\ \mbox{\hyperlink{namespace_eigen_1_1numext_ab3b30bf0bcfa1ad91dbec75fabb3bea0}{numext::mini}}(n\_start\ +\ nc,\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}})\ -\/\ n\_start;}
\DoxyCodeLine{00886\ }
\DoxyCodeLine{00887\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ first\ make\ sure\ the\ previous\ kernels\ are\ all\ done\ before\ overwriting\ rhs.\ Also\ wait\ if}}
\DoxyCodeLine{00888\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ we're\ going\ to\ start\ new\ k.\ In\ both\ cases\ need\_to\_pack\ is\ true.}}
\DoxyCodeLine{00889\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (need\_to\_pack)\ \{}
\DoxyCodeLine{00890\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}\ =\ num\_blocks;\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}\ <\ num\_threads;\ ++\mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}})\ \{}
\DoxyCodeLine{00891\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ blockAId\ =\ (k\_block\_idx\ *\ m\_blocks\ +\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}\ +\ m\_block\_idx)\ \%\ num\_threads;}
\DoxyCodeLine{00892\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ future\_id\ =\ (blockAId\ *\ n\_blocks\ +\ n\_block\_idx);}
\DoxyCodeLine{00893\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ wait\_until\_ready(kernel\_notifications[future\_id]);}
\DoxyCodeLine{00894\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00895\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00896\ }
\DoxyCodeLine{00897\ \ \ \ \ \ \ \ \ \ \ packRKArg\ \mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}}\ =\ \{}
\DoxyCodeLine{00898\ \ \ \ \ \ \ \ \ \ \ \ \ \&blockAs,\ \textcolor{comment}{//\ blockA}}
\DoxyCodeLine{00899\ \ \ \ \ \ \ \ \ \ \ \ \ blockBs[n\_block\_idx],\ \textcolor{comment}{//\ blockB}}
\DoxyCodeLine{00900\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{poisson_8cpp_a38c677f5cc4e47bc7505aef707c1bb83}{rhs}},\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ rhs}}
\DoxyCodeLine{00901\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{benchmarks_2scan_2scan_8hpp_a8390452002ecc7a0dadc5ae0dccc9b6c}{output}},\ \ \ \ \ \ \ \textcolor{comment}{//\ output}}
\DoxyCodeLine{00902\ \ \ \ \ \ \ \ \ \ \ \ \ m\_base\_start,\ \textcolor{comment}{//\ m}}
\DoxyCodeLine{00903\ \ \ \ \ \ \ \ \ \ \ \ \ k\_start,\ \ \ \ \ \ \textcolor{comment}{//\ k}}
\DoxyCodeLine{00904\ \ \ \ \ \ \ \ \ \ \ \ \ n\_start,\ \ \ \ \ \ \textcolor{comment}{//\ n}}
\DoxyCodeLine{00905\ \ \ \ \ \ \ \ \ \ \ \ \ mc,\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ mc}}
\DoxyCodeLine{00906\ \ \ \ \ \ \ \ \ \ \ \ \ actual\_kc,\ \ \ \ \textcolor{comment}{//\ kc}}
\DoxyCodeLine{00907\ \ \ \ \ \ \ \ \ \ \ \ \ actual\_nc,\ \ \ \ \textcolor{comment}{//\ nc}}
\DoxyCodeLine{00908\ \ \ \ \ \ \ \ \ \ \ \ \ num\_threads,}
\DoxyCodeLine{00909\ \ \ \ \ \ \ \ \ \ \ \ \ numBlockAs,}
\DoxyCodeLine{00910\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}},}
\DoxyCodeLine{00911\ \ \ \ \ \ \ \ \ \ \ \ \ k\_block\_idx,}
\DoxyCodeLine{00912\ \ \ \ \ \ \ \ \ \ \ \ \ m\_block\_idx,}
\DoxyCodeLine{00913\ \ \ \ \ \ \ \ \ \ \ \ \ n\_block\_idx,\ \textcolor{comment}{//\ n\_block\_idx}}
\DoxyCodeLine{00914\ \ \ \ \ \ \ \ \ \ \ \ \ m\_blocks,\ \textcolor{comment}{//\ m\_blocks}}
\DoxyCodeLine{00915\ \ \ \ \ \ \ \ \ \ \ \ \ n\_blocks,\ \textcolor{comment}{//\ n\_blocks}}
\DoxyCodeLine{00916\ \ \ \ \ \ \ \ \ \ \ \ \ \&kernel\_notifications,\ \textcolor{comment}{//\ kernel\ notifications}}
\DoxyCodeLine{00917\ \ \ \ \ \ \ \ \ \ \ \ \ \&lhs\_notifications,\ \ \ \ \textcolor{comment}{//\ lhs\ notifications}}
\DoxyCodeLine{00918\ \ \ \ \ \ \ \ \ \ \ \ \ need\_to\_pack,\ \textcolor{comment}{//\ need\_to\_pack}}
\DoxyCodeLine{00919\ \ \ \ \ \ \ \ \ \ \ \};}
\DoxyCodeLine{00920\ }
\DoxyCodeLine{00921\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ We\ asynchronously\ kick\ off\ this\ function,\ which\ ends\ up}}
\DoxyCodeLine{00922\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ notifying\ the\ appropriate\ kernel\_notifications\ objects,}}
\DoxyCodeLine{00923\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ which\ this\ thread\ waits\ on\ before\ exiting.}}
\DoxyCodeLine{00924\ \ \ \ \ \ \ \ \ \ \ this-\/>\mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a13eb5009d2c2e60155de55e7c3d2bd6f}{m\_device}}.enqueueNoNotification(\&Self::packRhsAndKernel<packRKArg,\ RhsPacker,\ GebpKernel>,\ \mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}});}
\DoxyCodeLine{00925\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00926\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00927\ \ \ \ \ \}}
\DoxyCodeLine{00928\ }
\DoxyCodeLine{00929\ \ \ \ \ \textcolor{comment}{//\ Make\ sure\ all\ the\ kernels\ are\ done.}}
\DoxyCodeLine{00930\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}\ =\ 0;\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}\ <\ kernel\_notifications.size();\ ++\mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}})\ \{}
\DoxyCodeLine{00931\ \ \ \ \ \ \ wait\_until\_ready(kernel\_notifications[\mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}]);}
\DoxyCodeLine{00932\ \ \ \ \ \ \ \textcolor{keyword}{delete}\ kernel\_notifications[\mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}];}
\DoxyCodeLine{00933\ \ \ \ \ \}}
\DoxyCodeLine{00934\ }
\DoxyCodeLine{00935\ \ \ \ \ \textcolor{comment}{//\ No\ need\ to\ wait\ for\ lhs\ notifications\ since\ they\ should\ have}}
\DoxyCodeLine{00936\ \ \ \ \ \textcolor{comment}{//\ already\ been\ waited\ on.\ \ Just\ clean\ them\ up.}}
\DoxyCodeLine{00937\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}\ =\ 0;\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}\ <\ lhs\_notifications.size();\ ++\mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}})\ \{}
\DoxyCodeLine{00938\ \ \ \ \ \ \ \textcolor{keyword}{delete}\ lhs\_notifications[\mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}];}
\DoxyCodeLine{00939\ \ \ \ \ \}}
\DoxyCodeLine{00940\ }
\DoxyCodeLine{00941\ \ \ \ \ \textcolor{comment}{//\ deallocate\ all\ of\ the\ memory\ for\ both\ A\ and\ B's}}
\DoxyCodeLine{00942\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}\ =\ 0;\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}\ <\ blockAs.size();\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}++)\ \{}
\DoxyCodeLine{00943\ \ \ \ \ \ \ this-\/>\mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a13eb5009d2c2e60155de55e7c3d2bd6f}{m\_device}}.deallocate(blockAs[\mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}]);}
\DoxyCodeLine{00944\ \ \ \ \ \}}
\DoxyCodeLine{00945\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}\ =\ 0;\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}\ <\ blockBs.size();\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}++)\ \{}
\DoxyCodeLine{00946\ \ \ \ \ \ \ this-\/>\mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a13eb5009d2c2e60155de55e7c3d2bd6f}{m\_device}}.deallocate(blockBs[\mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}]);}
\DoxyCodeLine{00947\ \ \ \ \ \}}
\DoxyCodeLine{00948\ }
\DoxyCodeLine{00949\ \textcolor{preprocessor}{\#undef\ CEIL\_DIV}}
\DoxyCodeLine{00950\ \ \ \}}
\DoxyCodeLine{00951\ }
\DoxyCodeLine{00952\ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00953\ \textcolor{comment}{\ \ \ *\ Packs\ a\ LHS\ block\ of\ size\ (mt,\ kc)\ starting\ at\ lhs(m,\ k).\ Before\ packing}}
\DoxyCodeLine{00954\ \textcolor{comment}{\ \ \ *\ the\ LHS\ block,\ check\ that\ all\ of\ the\ kernels\ that\ worked\ on\ the\ same}}
\DoxyCodeLine{00955\ \textcolor{comment}{\ \ \ *\ mt\_block\_idx\ in\ the\ previous\ m\_block\ are\ done.}}
\DoxyCodeLine{00956\ \textcolor{comment}{\ \ \ */}}
\DoxyCodeLine{00957\ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ packLArg,\ \textcolor{keyword}{typename}\ LhsPacker>}
\DoxyCodeLine{00958\ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ packLhs(\textcolor{keyword}{const}\ packLArg\ \mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}})\ \{}
\DoxyCodeLine{00959\ \ \ \ \ \textcolor{comment}{//\ perform\ actual\ packing}}
\DoxyCodeLine{00960\ \ \ \ \ LhsPacker\ pack\_lhs;}
\DoxyCodeLine{00961\ \ \ \ \ pack\_lhs(\mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}}.blockA,\ \mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}}.lhs.getSubMapper(\mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}}.m\_start,\ \mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}}.k\_start),\ \mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}}.kc,\ \mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}}.mc);}
\DoxyCodeLine{00962\ \ \ \}}
\DoxyCodeLine{00963\ }
\DoxyCodeLine{00964\ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{00965\ \textcolor{comment}{\ \ \ *\ Packs\ a\ RHS\ block\ of\ size\ (kc,\ nc)\ starting\ at\ (k,\ n)\ after\ checking\ that}}
\DoxyCodeLine{00966\ \textcolor{comment}{\ \ \ *\ all\ kernels\ in\ the\ previous\ block\ are\ done.}}
\DoxyCodeLine{00967\ \textcolor{comment}{\ \ \ *\ Then\ for\ each\ LHS\ future,\ we\ wait\ on\ the\ future\ and\ then\ call\ GEBP}}
\DoxyCodeLine{00968\ \textcolor{comment}{\ \ \ *\ on\ the\ area\ packed\ by\ the\ future\ (which\ starts\ at}}
\DoxyCodeLine{00969\ \textcolor{comment}{\ \ \ *\ blockA\ +\ future\_idx\ *\ mt\ *\ kc)\ on\ the\ LHS\ and\ with\ the\ full\ packed}}
\DoxyCodeLine{00970\ \textcolor{comment}{\ \ \ *\ RHS\ block.}}
\DoxyCodeLine{00971\ \textcolor{comment}{\ \ \ *\ The\ output\ of\ this\ GEBP\ is\ written\ to\ output(m\ +\ i\ *\ mt,\ n).}}
\DoxyCodeLine{00972\ \textcolor{comment}{\ \ \ */}}
\DoxyCodeLine{00973\ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ packRKArg,\ \textcolor{keyword}{typename}\ RhsPacker,\ \textcolor{keyword}{typename}\ GebpKernel>}
\DoxyCodeLine{00974\ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ packRhsAndKernel(packRKArg\ \mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}})\ \{}
\DoxyCodeLine{00975\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}}.need\_to\_pack)\ \{}
\DoxyCodeLine{00976\ \ \ \ \ \ \ RhsPacker\ pack\_rhs;}
\DoxyCodeLine{00977\ \ \ \ \ \ \ pack\_rhs(\mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}}.blockB,\ \mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}}.rhs.getSubMapper(\mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}}.k,\ \mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}}.n),\ \mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}}.kc,\ \mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}}.nc);}
\DoxyCodeLine{00978\ \ \ \ \ \}}
\DoxyCodeLine{00979\ }
\DoxyCodeLine{00980\ \ \ \ \ GebpKernel\ gebp;}
\DoxyCodeLine{00981\ \ \ \ \ \textcolor{keywordflow}{for}\ (\mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ mt\_block\_idx\ =\ 0;\ mt\_block\_idx\ <\ \mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}}.num\_blockAs;\ mt\_block\_idx++)\ \{}
\DoxyCodeLine{00982\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ m\_base\_start\ =\ \mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}}.m\ +\ \mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}}.mc*mt\_block\_idx;}
\DoxyCodeLine{00983\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (m\_base\_start\ <\ \mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}}.max\_m)\ \{}
\DoxyCodeLine{00984\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ blockAId\ =\ (\mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}}.k\_block\_idx\ *\ \mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}}.m\_blocks\ +\ mt\_block\_idx\ +\ \mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}}.m\_block\_idx)\ \%\ \mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}}.num\_threads;}
\DoxyCodeLine{00985\ \ \ \ \ \ \ \ \ wait\_until\_ready((*\mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}}.lhs\_notifications)[blockAId]);}
\DoxyCodeLine{00986\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ actual\_mc\ =\ \mbox{\hyperlink{namespace_eigen_1_1numext_ab3b30bf0bcfa1ad91dbec75fabb3bea0}{numext::mini}}(m\_base\_start\ +\ \mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}}.mc,\ \mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}}.max\_m)\ -\/\ m\_base\_start;}
\DoxyCodeLine{00987\ \ \ \ \ \ \ \ \ gebp(\mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}}.output.getSubMapper(m\_base\_start,\ \mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}}.n),}
\DoxyCodeLine{00988\ \ \ \ \ \ \ \ \ \ \ \ \ \ (*\mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}}.blockAs)[blockAId],\ \mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}}.blockB,}
\DoxyCodeLine{00989\ \ \ \ \ \ \ \ \ \ \ \ \ \ actual\_mc,\ \mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}}.kc,\ \mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}}.nc,\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a163cadb184cc08462355caf1031115a4}{Scalar}}(1),\ -\/1,\ -\/1,\ 0,\ 0);}
\DoxyCodeLine{00990\ }
\DoxyCodeLine{00991\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Notify\ that\ the\ kernel\ is\ done.}}
\DoxyCodeLine{00992\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ set\_idx\ =\ blockAId\ *\ \mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}}.n\_blocks\ +\ \mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}}.n\_block\_idx;}
\DoxyCodeLine{00993\ \ \ \ \ \ \ \ \ (*\mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}}.kernel\_notifications)[set\_idx]-\/>Notify();}
\DoxyCodeLine{00994\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00995\ \ \ \ \ \}}
\DoxyCodeLine{00996\ \ \ \}}
\DoxyCodeLine{00997\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ EIGEN\_USE\_SIMPLE\_THREAD\_POOL}}
\DoxyCodeLine{00998\ }
\DoxyCodeLine{00999\ \ \ TensorOpCost\ contractionCost(\mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}},\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}},\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ bm,\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ bn,\ \mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a932b320bc0d4f0c027d28f6f9918bbc6}{Index}}\ bk,}
\DoxyCodeLine{01000\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ shard\_by\_col,\ \textcolor{keywordtype}{bool}\ prepacked)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{01001\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ packed\_size\ =\ \mbox{\hyperlink{namespacestd_ac7b9885417769949d76890454b6d072e}{std::min<int>}}(\mbox{\hyperlink{struct_eigen_1_1internal_1_1packet__traits_a1a7c1c7a8ae861f1a84a32c3982b8fe0a60adf1b5b0dbd4b0ae81fe0b70b9d9eb}{PacketType<LhsScalar,\ Device>::size}},}
\DoxyCodeLine{01002\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{struct_eigen_1_1internal_1_1packet__traits_a1a7c1c7a8ae861f1a84a32c3982b8fe0a60adf1b5b0dbd4b0ae81fe0b70b9d9eb}{PacketType<RhsScalar,\ Device>::size}});}
\DoxyCodeLine{01003\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ output\_packet\_size\ =\ \mbox{\hyperlink{struct_eigen_1_1internal_1_1unpacket__traits_a5493b6385ef3a8958b09c00eed0ec26ba63cc10676eb13001d700f7bc4336f6ee}{internal::unpacket\_traits<PacketReturnType>::size}};}
\DoxyCodeLine{01004\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{double}\ kd\ =\ \textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{double}\textcolor{keyword}{>}(bk);}
\DoxyCodeLine{01005\ \ \ \ \ \textcolor{comment}{//\ Peak\ VFMA\ bandwidth\ is\ 0.5.\ However\ if\ we\ have\ not\ enough\ data\ for}}
\DoxyCodeLine{01006\ \ \ \ \ \textcolor{comment}{//\ vectorization\ bandwidth\ drops.\ The\ 4.0\ and\ 2.0\ bandwidth\ is\ determined}}
\DoxyCodeLine{01007\ \ \ \ \ \textcolor{comment}{//\ experimentally.}}
\DoxyCodeLine{01008\ \ \ \ \ \textcolor{keywordtype}{double}\ computeBandwidth\ =\ bk\ ==\ 1\ ?\ 4.0\ :}
\DoxyCodeLine{01009\ \ \ \ \ \ \ \ \ \ \ (shard\_by\_col\ ?\ bn\ :\ bm)\ <\ Traits::nr\ ||}
\DoxyCodeLine{01010\ \ \ \ \ \ \ \ \ \ \ (shard\_by\_col\ ?\ bm\ :\ bn)\ <\ Traits::mr\ ?\ 2.0\ :\ 0.5;}
\DoxyCodeLine{01011\ \textcolor{preprocessor}{\#ifndef\ EIGEN\_VECTORIZE\_FMA}}
\DoxyCodeLine{01012\ \ \ \ \ \textcolor{comment}{//\ Bandwidth\ of\ all\ of\ VFMA/MULPS/ADDPS\ is\ 0.5\ on\ latest\ Intel\ processors.}}
\DoxyCodeLine{01013\ \ \ \ \ \textcolor{comment}{//\ However\ for\ MULPS/ADDPS\ we\ have\ dependent\ sequence\ of\ 2\ such\ instructions,}}
\DoxyCodeLine{01014\ \ \ \ \ \textcolor{comment}{//\ so\ overall\ bandwidth\ is\ 1.0.}}
\DoxyCodeLine{01015\ \ \ \ \ \textcolor{keywordflow}{if}\ (computeBandwidth\ ==\ 0.5)\ computeBandwidth\ =\ 1.0;}
\DoxyCodeLine{01016\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{01017\ \ \ \ \ \textcolor{comment}{//\ Computations.}}
\DoxyCodeLine{01018\ \ \ \ \ TensorOpCost\ cost\ =\ TensorOpCost(0,\ 0,\ kd\ *\ computeBandwidth,\ \textcolor{keyword}{true},\ packed\_size);}
\DoxyCodeLine{01019\ \ \ \ \ \textcolor{comment}{//\ Output\ stores.}}
\DoxyCodeLine{01020\ \ \ \ \ cost\ +=\ TensorOpCost(0,\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{struct_eigen_1_1_tensor_evaluator_a664eb29b0c38061939b400fbc551c580}{CoeffReturnType}}),\ 0,\ \textcolor{keyword}{true},\ output\_packet\_size);}
\DoxyCodeLine{01021\ \ \ \ \ \textcolor{keywordflow}{if}\ (prepacked)\ \{}
\DoxyCodeLine{01022\ \ \ \ \ \ \ \textcolor{comment}{//\ Packing\ and\ kernels\ are\ executed\ in\ different\ tasks.\ When\ we\ calculate}}
\DoxyCodeLine{01023\ \ \ \ \ \ \ \textcolor{comment}{//\ task\ grain\ size\ we\ look\ only\ at\ kernel\ cost\ assuming\ that\ kernel}}
\DoxyCodeLine{01024\ \ \ \ \ \ \ \textcolor{comment}{//\ is\ more\ expensive\ than\ packing.}}
\DoxyCodeLine{01025\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ cost;}
\DoxyCodeLine{01026\ \ \ \ \ \}}
\DoxyCodeLine{01027\ \ \ \ \ \textcolor{comment}{//\ Lhs/rhs\ loads\ +\ computations.}}
\DoxyCodeLine{01028\ \ \ \ \ TensorOpCost\ lhsCost\ =\ this-\/>m\_leftImpl.costPerCoeff(\textcolor{keyword}{true})\ *\ (kd\ /\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}});}
\DoxyCodeLine{01029\ \ \ \ \ TensorOpCost\ rhsCost\ =\ this-\/>m\_rightImpl.costPerCoeff(\textcolor{keyword}{true})\ *\ (kd\ /\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}});}
\DoxyCodeLine{01030\ \ \ \ \ \textcolor{comment}{//\ Lhs\ packing\ memory\ cost\ does\ not\ contribute\ considerably\ to\ overall}}
\DoxyCodeLine{01031\ \ \ \ \ \textcolor{comment}{//\ execution\ time\ because\ lhs\ is\ prefetched\ early\ and\ accessed\ sequentially.}}
\DoxyCodeLine{01032\ \ \ \ \ \textcolor{keywordflow}{if}\ (shard\_by\_col)}
\DoxyCodeLine{01033\ \ \ \ \ \ \ lhsCost.dropMemoryCost();}
\DoxyCodeLine{01034\ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{01035\ \ \ \ \ \ \ rhsCost.dropMemoryCost();}
\DoxyCodeLine{01036\ \ \ \ \ \textcolor{keywordflow}{return}\ cost\ +\ lhsCost\ +\ rhsCost;}
\DoxyCodeLine{01037\ \ \ \}}
\DoxyCodeLine{01038\ \};}
\DoxyCodeLine{01039\ }
\DoxyCodeLine{01040\ \}\ \textcolor{comment}{//\ end\ namespace\ Eigen}}
\DoxyCodeLine{01041\ }
\DoxyCodeLine{01042\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ EIGEN\_USE\_THREADS}}
\DoxyCodeLine{01043\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ EIGEN\_CXX11\_TENSOR\_TENSOR\_CONTRACTION\_THREAD\_POOL\_H}}

\end{DoxyCode}
