\doxysection{tbb\+\_\+misc\+\_\+ex.\+cpp}
\hypertarget{tbb__misc__ex_8cpp_source}{}\label{tbb__misc__ex_8cpp_source}\index{external/taskflow/3rd-\/party/tbb/src/tbb/tbb\_misc\_ex.cpp@{external/taskflow/3rd-\/party/tbb/src/tbb/tbb\_misc\_ex.cpp}}
\mbox{\hyperlink{tbb__misc__ex_8cpp}{浏览该文件的文档.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{/*}}
\DoxyCodeLine{00002\ \textcolor{comment}{\ \ \ \ Copyright\ (c)\ 2005-\/2020\ Intel\ Corporation}}
\DoxyCodeLine{00003\ \textcolor{comment}{}}
\DoxyCodeLine{00004\ \textcolor{comment}{\ \ \ \ Licensed\ under\ the\ Apache\ License,\ Version\ 2.0\ (the\ "{}License"{});}}
\DoxyCodeLine{00005\ \textcolor{comment}{\ \ \ \ you\ may\ not\ use\ this\ file\ except\ in\ compliance\ with\ the\ License.}}
\DoxyCodeLine{00006\ \textcolor{comment}{\ \ \ \ You\ may\ obtain\ a\ copy\ of\ the\ License\ at}}
\DoxyCodeLine{00007\ \textcolor{comment}{}}
\DoxyCodeLine{00008\ \textcolor{comment}{\ \ \ \ \ \ \ \ http://www.apache.org/licenses/LICENSE-\/2.0}}
\DoxyCodeLine{00009\ \textcolor{comment}{}}
\DoxyCodeLine{00010\ \textcolor{comment}{\ \ \ \ Unless\ required\ by\ applicable\ law\ or\ agreed\ to\ in\ writing,\ software}}
\DoxyCodeLine{00011\ \textcolor{comment}{\ \ \ \ distributed\ under\ the\ License\ is\ distributed\ on\ an\ "{}AS\ IS"{}\ BASIS,}}
\DoxyCodeLine{00012\ \textcolor{comment}{\ \ \ \ WITHOUT\ WARRANTIES\ OR\ CONDITIONS\ OF\ ANY\ KIND,\ either\ express\ or\ implied.}}
\DoxyCodeLine{00013\ \textcolor{comment}{\ \ \ \ See\ the\ License\ for\ the\ specific\ language\ governing\ permissions\ and}}
\DoxyCodeLine{00014\ \textcolor{comment}{\ \ \ \ limitations\ under\ the\ License.}}
\DoxyCodeLine{00015\ \textcolor{comment}{*/}}
\DoxyCodeLine{00016\ }
\DoxyCodeLine{00017\ \textcolor{comment}{//\ Source\ file\ for\ miscellaneous\ entities\ that\ are\ infrequently\ referenced\ by}}
\DoxyCodeLine{00018\ \textcolor{comment}{//\ an\ executing\ program,\ and\ implementation\ of\ which\ requires\ dynamic\ linking.}}
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{tbb__misc_8h}{tbb\_misc.h}}"{}}}
\DoxyCodeLine{00021\ }
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#if\ !defined(\_\_TBB\_HardwareConcurrency)}}
\DoxyCodeLine{00023\ }
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{dynamic__link_8h}{dynamic\_link.h}}"{}}}
\DoxyCodeLine{00025\ \textcolor{preprocessor}{\#include\ <stdio.h>}}
\DoxyCodeLine{00026\ \textcolor{preprocessor}{\#include\ <limits.h>}}
\DoxyCodeLine{00027\ }
\DoxyCodeLine{00028\ \textcolor{preprocessor}{\#if\ \_WIN32||\_WIN64}}
\DoxyCodeLine{00029\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{windows__api_8h}{tbb/machine/windows\_api.h}}"{}}}
\DoxyCodeLine{00030\ \textcolor{preprocessor}{\#if\ \_\_TBB\_WIN8UI\_SUPPORT}}
\DoxyCodeLine{00031\ \textcolor{preprocessor}{\#include\ <thread>}}
\DoxyCodeLine{00032\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00033\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00034\ \textcolor{preprocessor}{\#include\ <unistd.h>}}
\DoxyCodeLine{00035\ \textcolor{preprocessor}{\#if\ \_\_linux\_\_}}
\DoxyCodeLine{00036\ \textcolor{preprocessor}{\#include\ <sys/sysinfo.h>}}
\DoxyCodeLine{00037\ \textcolor{preprocessor}{\#include\ <\mbox{\hyperlink{string_8h}{string.h}}>}}
\DoxyCodeLine{00038\ \textcolor{preprocessor}{\#include\ <sched.h>}}
\DoxyCodeLine{00039\ \textcolor{preprocessor}{\#include\ <errno.h>}}
\DoxyCodeLine{00040\ \textcolor{preprocessor}{\#elif\ \_\_sun}}
\DoxyCodeLine{00041\ \textcolor{preprocessor}{\#include\ <sys/sysinfo.h>}}
\DoxyCodeLine{00042\ \textcolor{preprocessor}{\#elif\ \_\_FreeBSD\_\_}}
\DoxyCodeLine{00043\ \textcolor{preprocessor}{\#include\ <errno.h>}}
\DoxyCodeLine{00044\ \textcolor{preprocessor}{\#include\ <\mbox{\hyperlink{string_8h}{string.h}}>}}
\DoxyCodeLine{00045\ \textcolor{preprocessor}{\#include\ <sys/param.h>}\ \ \textcolor{comment}{//\ Required\ by\ <sys/cpuset.h>}}
\DoxyCodeLine{00046\ \textcolor{preprocessor}{\#include\ <sys/cpuset.h>}}
\DoxyCodeLine{00047\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00048\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00049\ }
\DoxyCodeLine{00050\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespacetbb}{tbb}}\ \{}
\DoxyCodeLine{00051\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespacetbb_1_1internal}{internal}}\ \{}
\DoxyCodeLine{00052\ }
\DoxyCodeLine{00053\ \textcolor{preprocessor}{\#if\ \_\_TBB\_USE\_OS\_AFFINITY\_SYSCALL}}
\DoxyCodeLine{00054\ }
\DoxyCodeLine{00055\ \textcolor{preprocessor}{\#if\ \_\_linux\_\_}}
\DoxyCodeLine{00056\ \textcolor{comment}{//\ Handlers\ for\ interoperation\ with\ libiomp}}
\DoxyCodeLine{00057\ \textcolor{keyword}{static}\ \mbox{\hyperlink{sugar_8h_ae4f82344f573c70aa1066a2394bba345}{int}}\ (*libiomp\_try\_restoring\_original\_mask)();}
\DoxyCodeLine{00058\ \textcolor{comment}{//\ Table\ for\ mapping\ to\ libiomp\ entry\ points}}
\DoxyCodeLine{00059\ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ dynamic\_link\_descriptor\ iompLinkTable[]\ =\ \{}
\DoxyCodeLine{00060\ \ \ \ \ \mbox{\hyperlink{dynamic__link_8h_aa9ada19acd6191dacb9d26c361f8ae52}{DLD\_NOWEAK}}(\ kmp\_set\_thread\_affinity\_mask\_initial,\ libiomp\_try\_restoring\_original\_mask\ )}
\DoxyCodeLine{00061\ \};}
\DoxyCodeLine{00062\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00063\ }
\DoxyCodeLine{00064\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ set\_thread\_affinity\_mask(\ \textcolor{keywordtype}{size\_t}\ maskSize,\ \textcolor{keyword}{const}\ basic\_mask\_t*\ threadMask\ )\ \{}
\DoxyCodeLine{00065\ \textcolor{preprocessor}{\#if\ \_\_linux\_\_}}
\DoxyCodeLine{00066\ \ \ \ \ \textcolor{keywordflow}{if}(\ sched\_setaffinity(\ 0,\ maskSize,\ threadMask\ )\ )}
\DoxyCodeLine{00067\ \textcolor{preprocessor}{\#else\ }\textcolor{comment}{/*\ FreeBSD\ */}\textcolor{preprocessor}{}}
\DoxyCodeLine{00068\ \ \ \ \ \textcolor{keywordflow}{if}(\ cpuset\_setaffinity(\ CPU\_LEVEL\_WHICH,\ CPU\_WHICH\_TID,\ -\/1,\ maskSize,\ threadMask\ )\ )}
\DoxyCodeLine{00069\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00070\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{test__concurrent__hash__map_8cpp_a7de19b53af11a9175c96b42320b1d082}{runtime\_warning}}(\ \textcolor{stringliteral}{"{}setaffinity\ syscall\ failed"{}}\ );}
\DoxyCodeLine{00071\ \}}
\DoxyCodeLine{00072\ }
\DoxyCodeLine{00073\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ get\_thread\_affinity\_mask(\ \textcolor{keywordtype}{size\_t}\ maskSize,\ basic\_mask\_t*\ threadMask\ )\ \{}
\DoxyCodeLine{00074\ \textcolor{preprocessor}{\#if\ \_\_linux\_\_}}
\DoxyCodeLine{00075\ \ \ \ \ \textcolor{keywordflow}{if}(\ sched\_getaffinity(\ 0,\ maskSize,\ threadMask\ )\ )}
\DoxyCodeLine{00076\ \textcolor{preprocessor}{\#else\ }\textcolor{comment}{/*\ FreeBSD\ */}\textcolor{preprocessor}{}}
\DoxyCodeLine{00077\ \ \ \ \ \textcolor{keywordflow}{if}(\ cpuset\_getaffinity(\ CPU\_LEVEL\_WHICH,\ CPU\_WHICH\_TID,\ -\/1,\ maskSize,\ threadMask\ )\ )}
\DoxyCodeLine{00078\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00079\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{test__concurrent__hash__map_8cpp_a7de19b53af11a9175c96b42320b1d082}{runtime\_warning}}(\ \textcolor{stringliteral}{"{}getaffinity\ syscall\ failed"{}}\ );}
\DoxyCodeLine{00080\ \}}
\DoxyCodeLine{00081\ }
\DoxyCodeLine{00082\ \textcolor{keyword}{static}\ basic\_mask\_t*\ process\_mask;}
\DoxyCodeLine{00083\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{int}\ num\_masks;}
\DoxyCodeLine{00084\ }
\DoxyCodeLine{00085\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{namespacetbb_1_1internal_a609698c4765948334772520edc6fc688}{destroy\_process\_mask}}()\ \{}
\DoxyCodeLine{00086\ \ \ \ \ \textcolor{keywordflow}{if}(\ process\_mask\ )\ \{}
\DoxyCodeLine{00087\ \ \ \ \ \ \ \ \ \textcolor{keyword}{delete}\ []\ process\_mask;}
\DoxyCodeLine{00088\ \ \ \ \ \}}
\DoxyCodeLine{00089\ \}}
\DoxyCodeLine{00090\ }
\DoxyCodeLine{00091\ \textcolor{preprocessor}{\#define\ curMaskSize\ sizeof(basic\_mask\_t)\ *\ num\_masks}}
\DoxyCodeLine{00092\ affinity\_helper::\string~affinity\_helper()\ \{}
\DoxyCodeLine{00093\ \ \ \ \ \textcolor{keywordflow}{if}(\ threadMask\ )\ \{}
\DoxyCodeLine{00094\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(\ is\_changed\ )\ \{}
\DoxyCodeLine{00095\ \ \ \ \ \ \ \ \ \ \ \ \ set\_thread\_affinity\_mask(\ curMaskSize,\ threadMask\ );}
\DoxyCodeLine{00096\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00097\ \ \ \ \ \ \ \ \ \textcolor{keyword}{delete}\ []\ threadMask;}
\DoxyCodeLine{00098\ \ \ \ \ \}}
\DoxyCodeLine{00099\ \}}
\DoxyCodeLine{00100\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classtbb_1_1internal_1_1affinity__helper_a11acc19303b90ef5c4ee72c4a536ad98}{affinity\_helper::protect\_affinity\_mask}}(\ \textcolor{keywordtype}{bool}\ restore\_process\_mask\ )\ \{}
\DoxyCodeLine{00101\ \ \ \ \ \textcolor{keywordflow}{if}(\ threadMask\ ==\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}}\ \&\&\ num\_masks\ )\ \{\ \textcolor{comment}{//\ TODO:\ assert\ num\_masks\ validity?}}
\DoxyCodeLine{00102\ \ \ \ \ \ \ \ \ threadMask\ =\ \textcolor{keyword}{new}\ basic\_mask\_t\ [num\_masks];}
\DoxyCodeLine{00103\ \ \ \ \ \ \ \ \ memset(\ threadMask,\ 0,\ curMaskSize\ );}
\DoxyCodeLine{00104\ \ \ \ \ \ \ \ \ get\_thread\_affinity\_mask(\ curMaskSize,\ threadMask\ );}
\DoxyCodeLine{00105\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(\ restore\_process\_mask\ )\ \{}
\DoxyCodeLine{00106\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{tbb__stddef_8h_a7b58d28a34a1717e2ddb591f00658b10}{\_\_TBB\_ASSERT}}(\ process\_mask,\ \textcolor{stringliteral}{"{}A\ process\ mask\ is\ requested\ but\ not\ yet\ stored"{}}\ );}
\DoxyCodeLine{00107\ \ \ \ \ \ \ \ \ \ \ \ \ is\_changed\ =\ memcmp(\ process\_mask,\ threadMask,\ curMaskSize\ );}
\DoxyCodeLine{00108\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(\ is\_changed\ )}
\DoxyCodeLine{00109\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ set\_thread\_affinity\_mask(\ curMaskSize,\ process\_mask\ );}
\DoxyCodeLine{00110\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00111\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Assume\ that\ the\ mask\ will\ be\ changed\ by\ the\ caller.}}
\DoxyCodeLine{00112\ \ \ \ \ \ \ \ \ \ \ \ \ is\_changed\ =\ 1;}
\DoxyCodeLine{00113\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00114\ \ \ \ \ \}}
\DoxyCodeLine{00115\ \}}
\DoxyCodeLine{00116\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classtbb_1_1internal_1_1affinity__helper_a141d9ea305788e721d0e7d1b201320f6}{affinity\_helper::dismiss}}()\ \{}
\DoxyCodeLine{00117\ \ \ \ \ \textcolor{keywordflow}{if}(\ threadMask\ )\ \{}
\DoxyCodeLine{00118\ \ \ \ \ \ \ \ \ \textcolor{keyword}{delete}\ []\ threadMask;}
\DoxyCodeLine{00119\ \ \ \ \ \ \ \ \ threadMask\ =\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}};}
\DoxyCodeLine{00120\ \ \ \ \ \}}
\DoxyCodeLine{00121\ \ \ \ \ is\_changed\ =\ 0;}
\DoxyCodeLine{00122\ \}}
\DoxyCodeLine{00123\ \textcolor{preprocessor}{\#undef\ curMaskSize}}
\DoxyCodeLine{00124\ }
\DoxyCodeLine{00125\ \textcolor{keyword}{static}\ \mbox{\hyperlink{sugar_8h_a48f1c51623545bd4f58fbab2fa6091d0}{atomic<do\_once\_state>}}\ hardware\_concurrency\_info;}
\DoxyCodeLine{00126\ }
\DoxyCodeLine{00127\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{int}\ theNumProcs;}
\DoxyCodeLine{00128\ }
\DoxyCodeLine{00129\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ initialize\_hardware\_concurrency\_info\ ()\ \{}
\DoxyCodeLine{00130\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{namespacespdlog_1_1level_a335eabf5eff13482903eb26be08f3861a4d723e295b98a75c1263d85fc165045f}{err}};}
\DoxyCodeLine{00131\ \ \ \ \ \textcolor{keywordtype}{int}\ availableProcs\ =\ 0;}
\DoxyCodeLine{00132\ \ \ \ \ \textcolor{keywordtype}{int}\ numMasks\ =\ 1;}
\DoxyCodeLine{00133\ \textcolor{preprocessor}{\#if\ \_\_linux\_\_}}
\DoxyCodeLine{00134\ \textcolor{preprocessor}{\#if\ \_\_TBB\_MAIN\_THREAD\_AFFINITY\_BROKEN}}
\DoxyCodeLine{00135\ \ \ \ \ \textcolor{keywordtype}{int}\ maxProcs\ =\ INT\_MAX;\ \textcolor{comment}{//\ To\ check\ the\ entire\ mask.}}
\DoxyCodeLine{00136\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{namespacespdlog_1_1details_1_1os_adbde86613bd4e98205cffb43184df625}{pid}}\ =\ 0;\ \textcolor{comment}{//\ Get\ the\ mask\ of\ the\ calling\ thread.}}
\DoxyCodeLine{00137\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00138\ \ \ \ \ \textcolor{keywordtype}{int}\ maxProcs\ =\ sysconf(\_SC\_NPROCESSORS\_ONLN);}
\DoxyCodeLine{00139\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{namespacespdlog_1_1details_1_1os_adbde86613bd4e98205cffb43184df625}{pid}}\ =\ getpid();}
\DoxyCodeLine{00140\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00141\ \textcolor{preprocessor}{\#else\ }\textcolor{comment}{/*\ FreeBSD\ >=\ 7.1\ */}\textcolor{preprocessor}{}}
\DoxyCodeLine{00142\ \ \ \ \ \textcolor{keywordtype}{int}\ maxProcs\ =\ sysconf(\_SC\_NPROCESSORS\_ONLN);}
\DoxyCodeLine{00143\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00144\ \ \ \ \ basic\_mask\_t*\ processMask;}
\DoxyCodeLine{00145\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ BasicMaskSize\ =\ \ \textcolor{keyword}{sizeof}(basic\_mask\_t);}
\DoxyCodeLine{00146\ \ \ \ \ \textcolor{keywordflow}{for}\ (;;)\ \{}
\DoxyCodeLine{00147\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ curMaskSize\ =\ BasicMaskSize\ *\ numMasks;}
\DoxyCodeLine{00148\ \ \ \ \ \ \ \ \ processMask\ =\ \textcolor{keyword}{new}\ basic\_mask\_t[numMasks];}
\DoxyCodeLine{00149\ \ \ \ \ \ \ \ \ memset(\ processMask,\ 0,\ curMaskSize\ );}
\DoxyCodeLine{00150\ \textcolor{preprocessor}{\#if\ \_\_linux\_\_}}
\DoxyCodeLine{00151\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacespdlog_1_1level_a335eabf5eff13482903eb26be08f3861a4d723e295b98a75c1263d85fc165045f}{err}}\ =\ sched\_getaffinity(\ pid,\ curMaskSize,\ processMask\ );}
\DoxyCodeLine{00152\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\ !err\ ||\ errno\ !=\ \mbox{\hyperlink{runtime_2_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2types_8h_a2d1678d5a7cc8ce499643f3b8957def4}{EINVAL}}\ ||\ curMaskSize\ *\ CHAR\_BIT\ >=\ 256\ *\ 1024\ )}
\DoxyCodeLine{00153\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00154\ \textcolor{preprocessor}{\#else\ }\textcolor{comment}{/*\ FreeBSD\ >=\ 7.1\ */}\textcolor{preprocessor}{}}
\DoxyCodeLine{00155\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ CPU\_LEVEL\_WHICH\ -\/\ anonymous\ (current)\ mask,\ CPU\_LEVEL\_CPUSET\ -\/\ assigned\ mask}}
\DoxyCodeLine{00156\ \textcolor{preprocessor}{\#if\ \_\_TBB\_MAIN\_THREAD\_AFFINITY\_BROKEN}}
\DoxyCodeLine{00157\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacespdlog_1_1level_a335eabf5eff13482903eb26be08f3861a4d723e295b98a75c1263d85fc165045f}{err}}\ =\ cpuset\_getaffinity(\ CPU\_LEVEL\_WHICH,\ CPU\_WHICH\_TID,\ -\/1,\ curMaskSize,\ processMask\ );}
\DoxyCodeLine{00158\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00159\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacespdlog_1_1level_a335eabf5eff13482903eb26be08f3861a4d723e295b98a75c1263d85fc165045f}{err}}\ =\ cpuset\_getaffinity(\ CPU\_LEVEL\_WHICH,\ CPU\_WHICH\_PID,\ -\/1,\ curMaskSize,\ processMask\ );}
\DoxyCodeLine{00160\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00161\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\ !err\ ||\ errno\ !=\ ERANGE\ ||\ curMaskSize\ *\ CHAR\_BIT\ >=\ 16\ *\ 1024\ )}
\DoxyCodeLine{00162\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00163\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{/*\ FreeBSD\ >=\ 7.1\ */}\textcolor{preprocessor}{}}
\DoxyCodeLine{00164\ \ \ \ \ \ \ \ \ \textcolor{keyword}{delete}[]\ processMask;}
\DoxyCodeLine{00165\ \ \ \ \ \ \ \ \ numMasks\ <<=\ 1;}
\DoxyCodeLine{00166\ \ \ \ \ \}}
\DoxyCodeLine{00167\ \ \ \ \ \textcolor{keywordflow}{if}\ (\ !err\ )\ \{}
\DoxyCodeLine{00168\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ We\ have\ found\ the\ mask\ size\ and\ captured\ the\ process\ affinity\ mask\ into\ processMask.}}
\DoxyCodeLine{00169\ \ \ \ \ \ \ \ \ num\_masks\ =\ numMasks;\ \textcolor{comment}{//\ do\ here\ because\ it's\ needed\ for\ affinity\_helper\ to\ work}}
\DoxyCodeLine{00170\ \textcolor{preprocessor}{\#if\ \_\_linux\_\_}}
\DoxyCodeLine{00171\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ For\ better\ coexistence\ with\ libiomp\ which\ might\ have\ changed\ the\ mask\ already,}}
\DoxyCodeLine{00172\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ check\ for\ its\ presence\ and\ ask\ it\ to\ restore\ the\ mask.}}
\DoxyCodeLine{00173\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{dynamic__link_8h_a36d1edf80a31c32c95dfa6c191b3d2dc}{dynamic\_link\_handle}}\ libhandle;}
\DoxyCodeLine{00174\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\ \mbox{\hyperlink{dynamic__link_8cpp_aca8bbbbc28690d986ae2636bae2754f7}{dynamic\_link}}(\ \textcolor{stringliteral}{"{}libiomp5.so"{}},\ iompLinkTable,\ 1,\ \&libhandle,\ \mbox{\hyperlink{dynamic__link_8h_a4b4049ae5ac2e79f005302a820133ae7}{DYNAMIC\_LINK\_GLOBAL}}\ )\ )\ \{}
\DoxyCodeLine{00175\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ We\ have\ found\ the\ symbol\ provided\ by\ libiomp5\ for\ restoring\ original\ thread\ affinity.}}
\DoxyCodeLine{00176\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classtbb_1_1internal_1_1affinity__helper}{affinity\_helper}}\ affhelp;}
\DoxyCodeLine{00177\ \ \ \ \ \ \ \ \ \ \ \ \ affhelp.\mbox{\hyperlink{classtbb_1_1internal_1_1affinity__helper_a11acc19303b90ef5c4ee72c4a536ad98}{protect\_affinity\_mask}}(\ \textcolor{comment}{/*restore\_process\_mask=*/}\textcolor{keyword}{false}\ );}
\DoxyCodeLine{00178\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\ libiomp\_try\_restoring\_original\_mask()==0\ )\ \{}
\DoxyCodeLine{00179\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Now\ we\ have\ the\ right\ mask\ to\ capture,\ restored\ by\ libiomp.}}
\DoxyCodeLine{00180\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ curMaskSize\ =\ BasicMaskSize\ *\ numMasks;}
\DoxyCodeLine{00181\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ memset(\ processMask,\ 0,\ curMaskSize\ );}
\DoxyCodeLine{00182\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ get\_thread\_affinity\_mask(\ curMaskSize,\ processMask\ );}
\DoxyCodeLine{00183\ \ \ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}}
\DoxyCodeLine{00184\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ affhelp.dismiss();\ \ \textcolor{comment}{//\ thread\ mask\ has\ not\ changed}}
\DoxyCodeLine{00185\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{dynamic__link_8cpp_a25fd917902eaf363a17de44aead45093}{dynamic\_unlink}}(\ libhandle\ );}
\DoxyCodeLine{00186\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Destructor\ of\ affinity\_helper\ restores\ the\ thread\ mask\ (unless\ dismissed).}}
\DoxyCodeLine{00187\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00188\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00189\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}\ =\ 0;\ availableProcs\ <\ maxProcs\ \&\&\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}\ <\ numMasks;\ ++\mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}\ )\ \{}
\DoxyCodeLine{00190\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}\ =\ 0;\ (availableProcs\ <\ maxProcs)\ \&\&\ (\mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}\ <\ BasicMaskSize\ *\ CHAR\_BIT);\ ++\mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}\ )\ \{}
\DoxyCodeLine{00191\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\ CPU\_ISSET(\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}},\ processMask\ +\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}\ )\ )}
\DoxyCodeLine{00192\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ++availableProcs;}
\DoxyCodeLine{00193\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00194\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00195\ \ \ \ \ \ \ \ \ process\_mask\ =\ processMask;}
\DoxyCodeLine{00196\ \ \ \ \ \}}
\DoxyCodeLine{00197\ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00198\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Failed\ to\ get\ the\ process\ affinity\ mask;\ assume\ the\ whole\ machine\ can\ be\ used.}}
\DoxyCodeLine{00199\ \ \ \ \ \ \ \ \ availableProcs\ =\ (maxProcs\ ==\ INT\_MAX)\ ?\ sysconf(\_SC\_NPROCESSORS\_ONLN)\ :\ maxProcs;}
\DoxyCodeLine{00200\ \ \ \ \ \ \ \ \ \textcolor{keyword}{delete}[]\ processMask;}
\DoxyCodeLine{00201\ \ \ \ \ \}}
\DoxyCodeLine{00202\ \ \ \ \ theNumProcs\ =\ availableProcs\ >\ 0\ ?\ availableProcs\ :\ 1;\ \textcolor{comment}{//\ Fail\ safety\ strap}}
\DoxyCodeLine{00203\ \ \ \ \ \mbox{\hyperlink{tbb__stddef_8h_a7b58d28a34a1717e2ddb591f00658b10}{\_\_TBB\_ASSERT}}(\ theNumProcs\ <=\ sysconf(\_SC\_NPROCESSORS\_ONLN),\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}}\ );}
\DoxyCodeLine{00204\ \}}
\DoxyCodeLine{00205\ }
\DoxyCodeLine{00206\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{namespacetbb_1_1internal_a5f583dafcd8d7ffeb10905c4eb509cd9}{AvailableHwConcurrency}}()\ \{}
\DoxyCodeLine{00207\ \ \ \ \ \mbox{\hyperlink{namespacetbb_1_1internal_a1082394ca8392ef2aa6795b57a756fa5}{atomic\_do\_once}}(\ \&initialize\_hardware\_concurrency\_info,\ hardware\_concurrency\_info\ );}
\DoxyCodeLine{00208\ \ \ \ \ \textcolor{keywordflow}{return}\ theNumProcs;}
\DoxyCodeLine{00209\ \}}
\DoxyCodeLine{00210\ }
\DoxyCodeLine{00211\ \textcolor{comment}{/*\ End\ of\ \_\_TBB\_USE\_OS\_AFFINITY\_SYSCALL\ implementation\ */}}
\DoxyCodeLine{00212\ \textcolor{preprocessor}{\#elif\ \_\_ANDROID\_\_}}
\DoxyCodeLine{00213\ }
\DoxyCodeLine{00214\ \textcolor{comment}{//\ Work-\/around\ for\ Android\ that\ reads\ the\ correct\ number\ of\ available\ CPUs\ since\ system\ calls\ are\ unreliable.}}
\DoxyCodeLine{00215\ \textcolor{comment}{//\ Format\ of\ "{}present"{}\ file\ is:\ ([<int>-\/<int>|<int>],)+}}
\DoxyCodeLine{00216\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{namespacetbb_1_1internal_a5f583dafcd8d7ffeb10905c4eb509cd9}{AvailableHwConcurrency}}()\ \{}
\DoxyCodeLine{00217\ \ \ \ \ FILE\ *\mbox{\hyperlink{namespacedetail_a0b8d4b72c2682a8a63f46bd95074a6b5}{fp}}\ =\ fopen(\textcolor{stringliteral}{"{}/sys/devices/system/cpu/present"{}},\ \textcolor{stringliteral}{"{}r"{}});}
\DoxyCodeLine{00218\ \ \ \ \ \textcolor{keywordflow}{if}\ (fp\ ==\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}})\ \textcolor{keywordflow}{return}\ 1;}
\DoxyCodeLine{00219\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_args,\ \mbox{\hyperlink{blas__interface_8hh_a17ae1b83727db4230c8df98b4ee953fc}{lower}},\ upper,\ num\_cpus=0;}
\DoxyCodeLine{00220\ \ \ \ \ \textcolor{keywordflow}{while}\ ((num\_args\ =\ fscanf(fp,\ \textcolor{stringliteral}{"{}\%u-\/\%u"{}},\ \&\mbox{\hyperlink{blas__interface_8hh_a17ae1b83727db4230c8df98b4ee953fc}{lower}},\ \&upper))\ !=\ EOF)\ \{}
\DoxyCodeLine{00221\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{switch}(num\_args)\ \{}
\DoxyCodeLine{00222\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ 2:\ num\_cpus\ +=\ upper\ -\/\ \mbox{\hyperlink{blas__interface_8hh_a17ae1b83727db4230c8df98b4ee953fc}{lower}}\ +\ 1;\ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00223\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ 1:\ num\_cpus\ +=\ 1;\ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00224\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00225\ \ \ \ \ \ \ \ \ fscanf(fp,\ \textcolor{stringliteral}{"{},"{}});}
\DoxyCodeLine{00226\ \ \ \ \ \}}
\DoxyCodeLine{00227\ \ \ \ \ \textcolor{keywordflow}{return}\ (num\_cpus\ >\ 0)\ ?\ num\_cpus\ :\ 1;}
\DoxyCodeLine{00228\ \}}
\DoxyCodeLine{00229\ }
\DoxyCodeLine{00230\ \textcolor{preprocessor}{\#elif\ defined(\_SC\_NPROCESSORS\_ONLN)}}
\DoxyCodeLine{00231\ }
\DoxyCodeLine{00232\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{namespacetbb_1_1internal_a5f583dafcd8d7ffeb10905c4eb509cd9}{AvailableHwConcurrency}}()\ \{}
\DoxyCodeLine{00233\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}}\ =\ sysconf(\_SC\_NPROCESSORS\_ONLN);}
\DoxyCodeLine{00234\ \ \ \ \ \textcolor{keywordflow}{return}\ (\mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}}\ >\ 0)\ ?\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}}\ :\ 1;}
\DoxyCodeLine{00235\ \}}
\DoxyCodeLine{00236\ }
\DoxyCodeLine{00237\ \textcolor{preprocessor}{\#elif\ \_WIN32||\_WIN64}}
\DoxyCodeLine{00238\ }
\DoxyCodeLine{00239\ \textcolor{keyword}{static}\ \mbox{\hyperlink{sugar_8h_a48f1c51623545bd4f58fbab2fa6091d0}{atomic<do\_once\_state>}}\ hardware\_concurrency\_info;}
\DoxyCodeLine{00240\ }
\DoxyCodeLine{00241\ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ WORD\ TBB\_ALL\_PROCESSOR\_GROUPS\ =\ 0xffff;}
\DoxyCodeLine{00242\ }
\DoxyCodeLine{00243\ \textcolor{comment}{//\ Statically\ allocate\ an\ array\ for\ processor\ group\ information.}}
\DoxyCodeLine{00244\ \textcolor{comment}{//\ Windows\ 7\ supports\ maximum\ 4\ groups,\ but\ let's\ look\ ahead\ a\ little.}}
\DoxyCodeLine{00245\ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ WORD\ MaxProcessorGroups\ =\ 64;}
\DoxyCodeLine{00246\ }
\DoxyCodeLine{00247\ \textcolor{keyword}{struct\ }ProcessorGroupInfo\ \{}
\DoxyCodeLine{00248\ \ \ \ \ DWORD\_PTR\ \ \ \mbox{\hyperlink{ittnotify__static_8h_a2dea65f740c088e6408d62d6a9500c9e}{mask}};\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00249\ \ \ \ \ \textcolor{keywordtype}{int}\ \ \ \ \ \ \ \ \ numProcs;\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00250\ \ \ \ \ \textcolor{keywordtype}{int}\ \ \ \ \ \ \ \ \ numProcsRunningTotal;\ \ \ }
\DoxyCodeLine{00251\ }
\DoxyCodeLine{00253\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{int}\ NumGroups;}
\DoxyCodeLine{00254\ }
\DoxyCodeLine{00256\ }
\DoxyCodeLine{00262\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{int}\ HoleIndex;}
\DoxyCodeLine{00263\ \};}
\DoxyCodeLine{00264\ }
\DoxyCodeLine{00265\ \textcolor{keywordtype}{int}\ ProcessorGroupInfo::NumGroups\ =\ 1;}
\DoxyCodeLine{00266\ \textcolor{keywordtype}{int}\ ProcessorGroupInfo::HoleIndex\ =\ 0;}
\DoxyCodeLine{00267\ }
\DoxyCodeLine{00268\ ProcessorGroupInfo\ theProcessorGroups[MaxProcessorGroups];}
\DoxyCodeLine{00269\ }
\DoxyCodeLine{00270\ \textcolor{keyword}{struct\ }TBB\_GROUP\_AFFINITY\ \{}
\DoxyCodeLine{00271\ \ \ \ \ DWORD\_PTR\ Mask;}
\DoxyCodeLine{00272\ \ \ \ \ WORD\ \ \ Group;}
\DoxyCodeLine{00273\ \ \ \ \ WORD\ \ \ Reserved[3];}
\DoxyCodeLine{00274\ \};}
\DoxyCodeLine{00275\ }
\DoxyCodeLine{00276\ \textcolor{keyword}{static}\ \mbox{\hyperlink{test__malloc__compliance_8cpp_ad342ac907eb044443153a22f964bf0af}{DWORD}}\ (WINAPI\ *TBB\_GetActiveProcessorCount)(\ WORD\ groupIndex\ )\ =\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}};}
\DoxyCodeLine{00277\ \textcolor{keyword}{static}\ WORD\ (WINAPI\ *TBB\_GetActiveProcessorGroupCount)()\ =\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}};}
\DoxyCodeLine{00278\ \textcolor{keyword}{static}\ BOOL\ (WINAPI\ *TBB\_SetThreadGroupAffinity)(\ HANDLE\ hThread,}
\DoxyCodeLine{00279\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ TBB\_GROUP\_AFFINITY*\ newAff,\ TBB\_GROUP\_AFFINITY\ *prevAff\ );}
\DoxyCodeLine{00280\ \textcolor{keyword}{static}\ BOOL\ (WINAPI\ *TBB\_GetThreadGroupAffinity)(\ HANDLE\ hThread,\ TBB\_GROUP\_AFFINITY*\ );}
\DoxyCodeLine{00281\ }
\DoxyCodeLine{00282\ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ dynamic\_link\_descriptor\ ProcessorGroupsApiLinkTable[]\ =\ \{}
\DoxyCodeLine{00283\ \ \ \ \ \ \ \mbox{\hyperlink{dynamic__link_8h_a936c2724b498e02f80811f92ee06255a}{DLD}}(GetActiveProcessorCount,\ TBB\_GetActiveProcessorCount)}
\DoxyCodeLine{00284\ \ \ \ \ ,\ \mbox{\hyperlink{dynamic__link_8h_a936c2724b498e02f80811f92ee06255a}{DLD}}(GetActiveProcessorGroupCount,\ TBB\_GetActiveProcessorGroupCount)}
\DoxyCodeLine{00285\ \ \ \ \ ,\ \mbox{\hyperlink{dynamic__link_8h_a936c2724b498e02f80811f92ee06255a}{DLD}}(SetThreadGroupAffinity,\ TBB\_SetThreadGroupAffinity)}
\DoxyCodeLine{00286\ \ \ \ \ ,\ \mbox{\hyperlink{dynamic__link_8h_a936c2724b498e02f80811f92ee06255a}{DLD}}(GetThreadGroupAffinity,\ TBB\_GetThreadGroupAffinity)}
\DoxyCodeLine{00287\ \};}
\DoxyCodeLine{00288\ }
\DoxyCodeLine{00289\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ initialize\_hardware\_concurrency\_info\ ()\ \{}
\DoxyCodeLine{00290\ \textcolor{preprocessor}{\#if\ \_\_TBB\_WIN8UI\_SUPPORT}}
\DoxyCodeLine{00291\ \ \ \ \ \textcolor{comment}{//\ For\ these\ applications\ processor\ groups\ info\ is\ unavailable}}
\DoxyCodeLine{00292\ \ \ \ \ \textcolor{comment}{//\ Setting\ up\ a\ number\ of\ processors\ for\ one\ processor\ group}}
\DoxyCodeLine{00293\ \ \ \ \ theProcessorGroups[0].numProcs\ =\ theProcessorGroups[0].numProcsRunningTotal\ =\ std::thread::hardware\_concurrency();}
\DoxyCodeLine{00294\ \textcolor{preprocessor}{\#else\ }\textcolor{comment}{/*\ \_\_TBB\_WIN8UI\_SUPPORT\ */}\textcolor{preprocessor}{}}
\DoxyCodeLine{00295\ \ \ \ \ \mbox{\hyperlink{dynamic__link_8cpp_aca8bbbbc28690d986ae2636bae2754f7}{dynamic\_link}}(\ \textcolor{stringliteral}{"{}Kernel32.dll"{}},\ ProcessorGroupsApiLinkTable,}
\DoxyCodeLine{00296\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{sizeof}(ProcessorGroupsApiLinkTable)/\textcolor{keyword}{sizeof}(dynamic\_link\_descriptor)\ );}
\DoxyCodeLine{00297\ \ \ \ \ SYSTEM\_INFO\ si;}
\DoxyCodeLine{00298\ \ \ \ \ GetNativeSystemInfo(\&si);}
\DoxyCodeLine{00299\ \ \ \ \ DWORD\_PTR\ pam,\ sam,\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}\ =\ 1;}
\DoxyCodeLine{00300\ \ \ \ \ GetProcessAffinityMask(\ GetCurrentProcess(),\ \&pam,\ \&sam\ );}
\DoxyCodeLine{00301\ \ \ \ \ \textcolor{keywordtype}{int}\ nproc\ =\ 0;}
\DoxyCodeLine{00302\ \ \ \ \ \textcolor{keywordflow}{for}\ (\ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}\ =\ 0;\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}\ <\ \textcolor{keyword}{sizeof}(DWORD\_PTR)\ *\ CHAR\_BIT;\ ++\mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}},\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}\ <<=\ 1\ )\ \{}
\DoxyCodeLine{00303\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\ pam\ \&\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}\ )}
\DoxyCodeLine{00304\ \ \ \ \ \ \ \ \ \ \ \ \ ++nproc;}
\DoxyCodeLine{00305\ \ \ \ \ \}}
\DoxyCodeLine{00306\ \ \ \ \ \mbox{\hyperlink{tbb__stddef_8h_a7b58d28a34a1717e2ddb591f00658b10}{\_\_TBB\_ASSERT}}(\ nproc\ <=\ (\textcolor{keywordtype}{int})si.dwNumberOfProcessors,\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}}\ );}
\DoxyCodeLine{00307\ \ \ \ \ \textcolor{comment}{//\ By\ default\ setting\ up\ a\ number\ of\ processors\ for\ one\ processor\ group}}
\DoxyCodeLine{00308\ \ \ \ \ theProcessorGroups[0].numProcs\ =\ theProcessorGroups[0].numProcsRunningTotal\ =\ nproc;}
\DoxyCodeLine{00309\ \ \ \ \ \textcolor{comment}{//\ Setting\ up\ processor\ groups\ in\ case\ the\ process\ does\ not\ restrict\ affinity\ mask\ and\ more\ than\ one\ processor\ group\ is\ present}}
\DoxyCodeLine{00310\ \ \ \ \ \textcolor{keywordflow}{if}\ (\ nproc\ ==\ (\textcolor{keywordtype}{int})si.dwNumberOfProcessors\ \&\&\ TBB\_GetActiveProcessorCount\ )\ \{}
\DoxyCodeLine{00311\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ The\ process\ does\ not\ have\ restricting\ affinity\ mask\ and\ multiple\ processor\ groups\ are\ possible}}
\DoxyCodeLine{00312\ \ \ \ \ \ \ \ \ ProcessorGroupInfo::NumGroups\ =\ (\mbox{\hyperlink{sugar_8h_ae4f82344f573c70aa1066a2394bba345}{int}})TBB\_GetActiveProcessorGroupCount();}
\DoxyCodeLine{00313\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{tbb__stddef_8h_a7b58d28a34a1717e2ddb591f00658b10}{\_\_TBB\_ASSERT}}(\ ProcessorGroupInfo::NumGroups\ <=\ MaxProcessorGroups,\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}}\ );}
\DoxyCodeLine{00314\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Fail\ safety\ bootstrap.\ Release\ versions\ will\ limit\ available\ concurrency}}
\DoxyCodeLine{00315\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ level,\ while\ debug\ ones\ would\ assert.}}
\DoxyCodeLine{00316\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\ ProcessorGroupInfo::NumGroups\ >\ MaxProcessorGroups\ )}
\DoxyCodeLine{00317\ \ \ \ \ \ \ \ \ \ \ \ \ ProcessorGroupInfo::NumGroups\ =\ MaxProcessorGroups;}
\DoxyCodeLine{00318\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\ ProcessorGroupInfo::NumGroups\ >\ 1\ )\ \{}
\DoxyCodeLine{00319\ \ \ \ \ \ \ \ \ \ \ \ \ TBB\_GROUP\_AFFINITY\ ga;}
\DoxyCodeLine{00320\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\ TBB\_GetThreadGroupAffinity(\ GetCurrentThread(),\ \&ga\ )\ )}
\DoxyCodeLine{00321\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ProcessorGroupInfo::HoleIndex\ =\ ga.Group;}
\DoxyCodeLine{00322\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ nprocs\ =\ 0;}
\DoxyCodeLine{00323\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\ WORD\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}\ =\ 0;\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}\ <\ ProcessorGroupInfo::NumGroups;\ ++\mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}\ )\ \{}
\DoxyCodeLine{00324\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ProcessorGroupInfo\ \ \&pgi\ =\ theProcessorGroups[\mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}];}
\DoxyCodeLine{00325\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pgi.numProcs\ =\ (\mbox{\hyperlink{sugar_8h_ae4f82344f573c70aa1066a2394bba345}{int}})TBB\_GetActiveProcessorCount(\mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}});}
\DoxyCodeLine{00326\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{tbb__stddef_8h_a7b58d28a34a1717e2ddb591f00658b10}{\_\_TBB\_ASSERT}}(\ pgi.numProcs\ <=\ (\textcolor{keywordtype}{int})\textcolor{keyword}{sizeof}(DWORD\_PTR)\ *\ CHAR\_BIT,\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}}\ );}
\DoxyCodeLine{00327\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pgi.mask\ =\ pgi.numProcs\ ==\ \textcolor{keyword}{sizeof}(DWORD\_PTR)\ *\ CHAR\_BIT\ ?\ \string~(DWORD\_PTR)0\ :\ (DWORD\_PTR(1)\ <<\ pgi.numProcs)\ -\/\ 1;}
\DoxyCodeLine{00328\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pgi.numProcsRunningTotal\ =\ nprocs\ +=\ pgi.numProcs;}
\DoxyCodeLine{00329\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00330\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{tbb__stddef_8h_a7b58d28a34a1717e2ddb591f00658b10}{\_\_TBB\_ASSERT}}(\ nprocs\ ==\ (\textcolor{keywordtype}{int})TBB\_GetActiveProcessorCount(\ TBB\_ALL\_PROCESSOR\_GROUPS\ ),\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}}\ );}
\DoxyCodeLine{00331\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00332\ \ \ \ \ \}}
\DoxyCodeLine{00333\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{/*\ \_\_TBB\_WIN8UI\_SUPPORT\ */}\textcolor{preprocessor}{}}
\DoxyCodeLine{00334\ }
\DoxyCodeLine{00335\ \ \ \ \ \mbox{\hyperlink{namespacetbb_1_1internal_a89891ef24359a1304be463a41071684c}{PrintExtraVersionInfo}}(\textcolor{stringliteral}{"{}Processor\ groups"{}},\ \textcolor{stringliteral}{"{}\%d"{}},\ ProcessorGroupInfo::NumGroups);}
\DoxyCodeLine{00336\ \ \ \ \ \textcolor{keywordflow}{if}\ (ProcessorGroupInfo::NumGroups>1)}
\DoxyCodeLine{00337\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}=0;\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}<ProcessorGroupInfo::NumGroups;\ ++\mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}})}
\DoxyCodeLine{00338\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacetbb_1_1internal_a89891ef24359a1304be463a41071684c}{PrintExtraVersionInfo}}(\ \textcolor{stringliteral}{"{}-\/-\/-\/-\/-\/\ Group"{}},\ \textcolor{stringliteral}{"{}\%d:\ size\ \%d"{}},\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}},\ theProcessorGroups[\mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}].numProcs);}
\DoxyCodeLine{00339\ \}}
\DoxyCodeLine{00340\ }
\DoxyCodeLine{00341\ \textcolor{keywordtype}{int}\ NumberOfProcessorGroups()\ \{}
\DoxyCodeLine{00342\ \ \ \ \ \mbox{\hyperlink{tbb__stddef_8h_a7b58d28a34a1717e2ddb591f00658b10}{\_\_TBB\_ASSERT}}(\ hardware\_concurrency\_info\ ==\ \mbox{\hyperlink{namespacetbb_1_1internal_ada4c143a836d8c23081ece16659831dca0874a1dac891b5747d56df95f1076763}{initialization\_complete}},\ \textcolor{stringliteral}{"{}NumberOfProcessorGroups\ is\ used\ before\ AvailableHwConcurrency"{}}\ );}
\DoxyCodeLine{00343\ \ \ \ \ \textcolor{keywordflow}{return}\ ProcessorGroupInfo::NumGroups;}
\DoxyCodeLine{00344\ \}}
\DoxyCodeLine{00345\ }
\DoxyCodeLine{00346\ \textcolor{comment}{//\ Offset\ for\ the\ slot\ reserved\ for\ the\ first\ master\ thread}}
\DoxyCodeLine{00347\ \textcolor{preprocessor}{\#define\ HoleAdjusted(procIdx,\ grpIdx)\ (procIdx\ +\ (holeIdx\ <=\ grpIdx))}}
\DoxyCodeLine{00348\ }
\DoxyCodeLine{00349\ \textcolor{keywordtype}{int}\ FindProcessorGroupIndex\ (\ \textcolor{keywordtype}{int}\ procIdx\ )\ \{}
\DoxyCodeLine{00350\ \ \ \ \ \textcolor{comment}{//\ In\ case\ of\ oversubscription\ spread\ extra\ workers\ in\ a\ round\ robin\ manner}}
\DoxyCodeLine{00351\ \ \ \ \ \textcolor{keywordtype}{int}\ holeIdx;}
\DoxyCodeLine{00352\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ numProcs\ =\ theProcessorGroups[ProcessorGroupInfo::NumGroups\ -\/\ 1].numProcsRunningTotal;}
\DoxyCodeLine{00353\ \ \ \ \ \textcolor{keywordflow}{if}\ (\ procIdx\ >=\ numProcs\ -\/\ 1\ )\ \{}
\DoxyCodeLine{00354\ \ \ \ \ \ \ \ \ holeIdx\ =\ INT\_MAX;}
\DoxyCodeLine{00355\ \ \ \ \ \ \ \ \ procIdx\ =\ (procIdx\ -\/\ numProcs\ +\ 1)\ \%\ numProcs;}
\DoxyCodeLine{00356\ \ \ \ \ \}}
\DoxyCodeLine{00357\ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{00358\ \ \ \ \ \ \ \ \ holeIdx\ =\ ProcessorGroupInfo::HoleIndex;}
\DoxyCodeLine{00359\ \ \ \ \ \mbox{\hyperlink{tbb__stddef_8h_a7b58d28a34a1717e2ddb591f00658b10}{\_\_TBB\_ASSERT}}(\ hardware\_concurrency\_info\ ==\ \mbox{\hyperlink{namespacetbb_1_1internal_ada4c143a836d8c23081ece16659831dca0874a1dac891b5747d56df95f1076763}{initialization\_complete}},\ \textcolor{stringliteral}{"{}FindProcessorGroupIndex\ is\ used\ before\ AvailableHwConcurrency"{}}\ );}
\DoxyCodeLine{00360\ \ \ \ \ \textcolor{comment}{//\ Approximate\ the\ likely\ group\ index\ assuming\ all\ groups\ are\ of\ the\ same\ size}}
\DoxyCodeLine{00361\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}\ =\ procIdx\ /\ theProcessorGroups[0].numProcs;}
\DoxyCodeLine{00362\ \ \ \ \ \textcolor{comment}{//\ Make\ sure\ the\ approximation\ is\ a\ valid\ group\ index}}
\DoxyCodeLine{00363\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}\ >=\ ProcessorGroupInfo::NumGroups)\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}\ =\ ProcessorGroupInfo::NumGroups-\/1;}
\DoxyCodeLine{00364\ \ \ \ \ \textcolor{comment}{//\ Now\ adjust\ the\ approximation\ up\ or\ down}}
\DoxyCodeLine{00365\ \ \ \ \ \textcolor{keywordflow}{if}\ (\ theProcessorGroups[\mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}].numProcsRunningTotal\ >\ HoleAdjusted(procIdx,\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}})\ )\ \{}
\DoxyCodeLine{00366\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (\ theProcessorGroups[\mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}].numProcsRunningTotal\ -\/\ theProcessorGroups[\mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}].numProcs\ >\ HoleAdjusted(procIdx,\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}})\ )\ \{}
\DoxyCodeLine{00367\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{tbb__stddef_8h_a7b58d28a34a1717e2ddb591f00658b10}{\_\_TBB\_ASSERT}}(\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}\ >\ 0,\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}}\ );}
\DoxyCodeLine{00368\ \ \ \ \ \ \ \ \ \ \ \ \ -\/-\/\mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}};}
\DoxyCodeLine{00369\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00370\ \ \ \ \ \}}
\DoxyCodeLine{00371\ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00372\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{do}\ \{}
\DoxyCodeLine{00373\ \ \ \ \ \ \ \ \ \ \ \ \ ++\mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}};}
\DoxyCodeLine{00374\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{while}\ (\ theProcessorGroups[\mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}].numProcsRunningTotal\ <=\ HoleAdjusted(procIdx,\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}})\ );}
\DoxyCodeLine{00375\ \ \ \ \ \}}
\DoxyCodeLine{00376\ \ \ \ \ \mbox{\hyperlink{tbb__stddef_8h_a7b58d28a34a1717e2ddb591f00658b10}{\_\_TBB\_ASSERT}}(\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}\ <\ ProcessorGroupInfo::NumGroups,\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}}\ );}
\DoxyCodeLine{00377\ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}};}
\DoxyCodeLine{00378\ \}}
\DoxyCodeLine{00379\ }
\DoxyCodeLine{00380\ \textcolor{keywordtype}{void}\ MoveThreadIntoProcessorGroup(\ \textcolor{keywordtype}{void}*\ hThread,\ \textcolor{keywordtype}{int}\ groupIndex\ )\ \{}
\DoxyCodeLine{00381\ \ \ \ \ \mbox{\hyperlink{tbb__stddef_8h_a7b58d28a34a1717e2ddb591f00658b10}{\_\_TBB\_ASSERT}}(\ hardware\_concurrency\_info\ ==\ \mbox{\hyperlink{namespacetbb_1_1internal_ada4c143a836d8c23081ece16659831dca0874a1dac891b5747d56df95f1076763}{initialization\_complete}},\ \textcolor{stringliteral}{"{}MoveThreadIntoProcessorGroup\ is\ used\ before\ AvailableHwConcurrency"{}}\ );}
\DoxyCodeLine{00382\ \ \ \ \ \textcolor{keywordflow}{if}\ (\ !TBB\_SetThreadGroupAffinity\ )}
\DoxyCodeLine{00383\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00384\ \ \ \ \ TBB\_GROUP\_AFFINITY\ ga\ =\ \{\ theProcessorGroups[groupIndex].mask,\ (WORD)groupIndex,\ \{0,0,0\}\ \};}
\DoxyCodeLine{00385\ \ \ \ \ TBB\_SetThreadGroupAffinity(\ hThread,\ \&ga,\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}}\ );}
\DoxyCodeLine{00386\ \}}
\DoxyCodeLine{00387\ }
\DoxyCodeLine{00388\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{namespacetbb_1_1internal_a5f583dafcd8d7ffeb10905c4eb509cd9}{AvailableHwConcurrency}}()\ \{}
\DoxyCodeLine{00389\ \ \ \ \ \mbox{\hyperlink{namespacetbb_1_1internal_a1082394ca8392ef2aa6795b57a756fa5}{atomic\_do\_once}}(\ \&initialize\_hardware\_concurrency\_info,\ hardware\_concurrency\_info\ );}
\DoxyCodeLine{00390\ \ \ \ \ \textcolor{keywordflow}{return}\ theProcessorGroups[ProcessorGroupInfo::NumGroups\ -\/\ 1].numProcsRunningTotal;}
\DoxyCodeLine{00391\ \}}
\DoxyCodeLine{00392\ }
\DoxyCodeLine{00393\ \textcolor{comment}{/*\ End\ of\ \_WIN32||\_WIN64\ implementation\ */}}
\DoxyCodeLine{00394\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00395\ \textcolor{preprocessor}{\ \ \ \ \#error\ AvailableHwConcurrency\ is\ not\ implemented\ for\ this\ OS}}
\DoxyCodeLine{00396\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00397\ }
\DoxyCodeLine{00398\ \}\ \textcolor{comment}{//\ namespace\ internal}}
\DoxyCodeLine{00399\ \}\ \textcolor{comment}{//\ namespace\ tbb}}
\DoxyCodeLine{00400\ }
\DoxyCodeLine{00401\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{/*\ !\_\_TBB\_HardwareConcurrency\ */}\textcolor{preprocessor}{}}

\end{DoxyCode}
