\doxysection{gcc\+\_\+ia32\+\_\+common.\+h}
\hypertarget{gcc__ia32__common_8h_source}{}\label{gcc__ia32__common_8h_source}\index{external/taskflow/3rd-\/party/tbb/include/tbb/machine/gcc\_ia32\_common.h@{external/taskflow/3rd-\/party/tbb/include/tbb/machine/gcc\_ia32\_common.h}}
\mbox{\hyperlink{gcc__ia32__common_8h}{浏览该文件的文档.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{/*}}
\DoxyCodeLine{00002\ \textcolor{comment}{\ \ \ \ Copyright\ (c)\ 2005-\/2020\ Intel\ Corporation}}
\DoxyCodeLine{00003\ \textcolor{comment}{}}
\DoxyCodeLine{00004\ \textcolor{comment}{\ \ \ \ Licensed\ under\ the\ Apache\ License,\ Version\ 2.0\ (the\ "{}License"{});}}
\DoxyCodeLine{00005\ \textcolor{comment}{\ \ \ \ you\ may\ not\ use\ this\ file\ except\ in\ compliance\ with\ the\ License.}}
\DoxyCodeLine{00006\ \textcolor{comment}{\ \ \ \ You\ may\ obtain\ a\ copy\ of\ the\ License\ at}}
\DoxyCodeLine{00007\ \textcolor{comment}{}}
\DoxyCodeLine{00008\ \textcolor{comment}{\ \ \ \ \ \ \ \ http://www.apache.org/licenses/LICENSE-\/2.0}}
\DoxyCodeLine{00009\ \textcolor{comment}{}}
\DoxyCodeLine{00010\ \textcolor{comment}{\ \ \ \ Unless\ required\ by\ applicable\ law\ or\ agreed\ to\ in\ writing,\ software}}
\DoxyCodeLine{00011\ \textcolor{comment}{\ \ \ \ distributed\ under\ the\ License\ is\ distributed\ on\ an\ "{}AS\ IS"{}\ BASIS,}}
\DoxyCodeLine{00012\ \textcolor{comment}{\ \ \ \ WITHOUT\ WARRANTIES\ OR\ CONDITIONS\ OF\ ANY\ KIND,\ either\ express\ or\ implied.}}
\DoxyCodeLine{00013\ \textcolor{comment}{\ \ \ \ See\ the\ License\ for\ the\ specific\ language\ governing\ permissions\ and}}
\DoxyCodeLine{00014\ \textcolor{comment}{\ \ \ \ limitations\ under\ the\ License.}}
\DoxyCodeLine{00015\ \textcolor{comment}{*/}}
\DoxyCodeLine{00016\ }
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#ifndef\ \_\_TBB\_machine\_gcc\_ia32\_common\_H}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#define\ \_\_TBB\_machine\_gcc\_ia32\_common\_H}}
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#ifndef\ \_\_TBB\_Log2}}
\DoxyCodeLine{00021\ \textcolor{comment}{//TODO:\ Add\ a\ higher-\/level\ function,\ e.g.\ tbb::internal::log2(),\ into\ tbb\_stddef.h,\ which}}
\DoxyCodeLine{00022\ \textcolor{comment}{//uses\ \_\_TBB\_Log2\ and\ contains\ the\ assert\ and\ remove\ the\ assert\ from\ here\ and\ all\ other}}
\DoxyCodeLine{00023\ \textcolor{comment}{//platform-\/specific\ headers.}}
\DoxyCodeLine{00024\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T>}
\DoxyCodeLine{00025\ \textcolor{keyword}{static}\ \textcolor{keyword}{inline}\ intptr\_t\ \mbox{\hyperlink{gcc__ia32__common_8h_a9ff0bd4a57f68ccfa46f59326e4f0d94}{\_\_TBB\_machine\_lg}}(\ \mbox{\hyperlink{test__overwrite__node_8cpp_a0acb682b8260ab1c60b918599864e2e5}{T}}\ \mbox{\hyperlink{offscreen_8c_a5fd331c99e778f04762be6d8173eb4d2}{x}}\ )\ \{}
\DoxyCodeLine{00026\ \ \ \ \ \mbox{\hyperlink{tbb__stddef_8h_a7b58d28a34a1717e2ddb591f00658b10}{\_\_TBB\_ASSERT}}(\mbox{\hyperlink{offscreen_8c_a5fd331c99e778f04762be6d8173eb4d2}{x}}>0,\ \textcolor{stringliteral}{"{}The\ logarithm\ of\ a\ non-\/positive\ value\ is\ undefined."{}});}
\DoxyCodeLine{00027\ \ \ \ \ uintptr\_t\ \mbox{\hyperlink{tut__arithmetic__redux__minmax_8cpp_a39513f0f8d942bf9ef17b2e87ac6d34e}{j}},\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}\ =\ \mbox{\hyperlink{offscreen_8c_a5fd331c99e778f04762be6d8173eb4d2}{x}};}
\DoxyCodeLine{00028\ \ \ \ \ \_\_asm\_\_(\textcolor{stringliteral}{"{}bsr\ \%1,\%0"{}}\ :\ \textcolor{stringliteral}{"{}=r"{}}(\mbox{\hyperlink{tut__arithmetic__redux__minmax_8cpp_a39513f0f8d942bf9ef17b2e87ac6d34e}{j}})\ :\ \textcolor{stringliteral}{"{}r"{}}(\mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}));}
\DoxyCodeLine{00029\ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{tut__arithmetic__redux__minmax_8cpp_a39513f0f8d942bf9ef17b2e87ac6d34e}{j}};}
\DoxyCodeLine{00030\ \}}
\DoxyCodeLine{00031\ \textcolor{preprocessor}{\#define\ \_\_TBB\_Log2(V)\ \ \_\_TBB\_machine\_lg(V)}}
\DoxyCodeLine{00032\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{/*\ !\_\_TBB\_Log2\ */}\textcolor{preprocessor}{}}
\DoxyCodeLine{00033\ }
\DoxyCodeLine{00034\ \textcolor{preprocessor}{\#ifndef\ \_\_TBB\_Pause}}
\DoxyCodeLine{00035\ \textcolor{comment}{//TODO:\ check\ if\ raising\ a\ ratio\ of\ pause\ instructions\ to\ loop\ control\ instructions}}
\DoxyCodeLine{00036\ \textcolor{comment}{//(via\ e.g.\ loop\ unrolling)\ gives\ any\ benefit\ for\ HT.\ \ E.g,\ the\ current\ implementation}}
\DoxyCodeLine{00037\ \textcolor{comment}{//does\ about\ 2\ CPU-\/consuming\ instructions\ for\ every\ pause\ instruction.\ \ Perhaps\ for}}
\DoxyCodeLine{00038\ \textcolor{comment}{//high\ pause\ counts\ it\ should\ use\ an\ unrolled\ loop\ to\ raise\ the\ ratio,\ and\ thus\ free}}
\DoxyCodeLine{00039\ \textcolor{comment}{//up\ more\ integer\ cycles\ for\ the\ other\ hyperthread.\ \ On\ the\ other\ hand,\ if\ the\ loop\ is}}
\DoxyCodeLine{00040\ \textcolor{comment}{//unrolled\ too\ far,\ it\ won't\ fit\ in\ the\ core's\ loop\ cache,\ and\ thus\ take\ away}}
\DoxyCodeLine{00041\ \textcolor{comment}{//instruction\ decode\ slots\ from\ the\ other\ hyperthread.}}
\DoxyCodeLine{00042\ }
\DoxyCodeLine{00043\ \textcolor{comment}{//TODO:\ check\ if\ use\ of\ gcc\ \_\_builtin\_ia32\_pause\ intrinsic\ gives\ a\ "{}some\ how"{}\ better\ performing\ code}}
\DoxyCodeLine{00044\ \textcolor{keyword}{static}\ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{gcc__ia32__common_8h_a0391a8931a4bc841afeb167736ef5430}{\_\_TBB\_machine\_pause}}(\ \mbox{\hyperlink{eabase_8h_ab1967d8591af1a4e48c37fd2b0f184d0}{int32\_t}}\ delay\ )\ \{}
\DoxyCodeLine{00045\ \ \ \ \ \textcolor{keywordflow}{for}\ (\mbox{\hyperlink{eabase_8h_ab1967d8591af1a4e48c37fd2b0f184d0}{int32\_t}}\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}\ =\ 0;\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}\ <\ delay;\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}++)\ \{}
\DoxyCodeLine{00046\ \ \ \ \ \ \ \ \_\_asm\_\_\ \_\_volatile\_\_(\textcolor{stringliteral}{"{}pause;"{}});}
\DoxyCodeLine{00047\ \ \ \ \ \}}
\DoxyCodeLine{00048\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00049\ \}}
\DoxyCodeLine{00050\ \textcolor{preprocessor}{\#define\ \_\_TBB\_Pause(V)\ \_\_TBB\_machine\_pause(V)}}
\DoxyCodeLine{00051\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{/*\ !\_\_TBB\_Pause\ */}\textcolor{preprocessor}{}}
\DoxyCodeLine{00052\ }
\DoxyCodeLine{00053\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespacetbb}{tbb}}\ \{\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespaceinternal}{internal}}\ \{\ \textcolor{keyword}{typedef}\ \mbox{\hyperlink{eabase_8h_aaa5d1cd013383c889537491c3cfd9aad}{uint64\_t}}\ \mbox{\hyperlink{namespacetbb_1_1internal_ae337512716848c8145c750713519a3c8}{machine\_tsc\_t}};\ \}\ \}}
\DoxyCodeLine{00054\ \textcolor{keyword}{static}\ \textcolor{keyword}{inline}\ \mbox{\hyperlink{namespacetbb_1_1internal_ae337512716848c8145c750713519a3c8}{tbb::internal::machine\_tsc\_t}}\ \mbox{\hyperlink{gcc__ia32__common_8h_a9b1629c8ee357509917aa684fe561947}{\_\_TBB\_machine\_time\_stamp}}()\ \{}
\DoxyCodeLine{00055\ \textcolor{preprocessor}{\#if\ \_\_INTEL\_COMPILER}}
\DoxyCodeLine{00056\ \ \ \ \ \textcolor{keywordflow}{return}\ \_rdtsc();}
\DoxyCodeLine{00057\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00058\ \ \ \ \ \mbox{\hyperlink{eabase_8h_a435d1572bf3f880d55459d9805097f62}{tbb::internal::uint32\_t}}\ hi,\ lo;}
\DoxyCodeLine{00059\ \ \ \ \ \_\_asm\_\_\ \_\_volatile\_\_(\textcolor{stringliteral}{"{}rdtsc"{}}\ :\ \textcolor{stringliteral}{"{}=d"{}}(hi),\ \textcolor{stringliteral}{"{}=a"{}}(lo));}
\DoxyCodeLine{00060\ \ \ \ \ \textcolor{keywordflow}{return}\ (\mbox{\hyperlink{namespacetbb_1_1internal_ae337512716848c8145c750713519a3c8}{tbb::internal::machine\_tsc\_t}}(\ hi\ )\ <<\ 32)\ |\ lo;}
\DoxyCodeLine{00061\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00062\ \}}
\DoxyCodeLine{00063\ \textcolor{preprocessor}{\#define\ \_\_TBB\_time\_stamp()\ \_\_TBB\_machine\_time\_stamp()}}
\DoxyCodeLine{00064\ }
\DoxyCodeLine{00065\ \textcolor{comment}{//\ API\ to\ retrieve/update\ FPU\ control\ setting}}
\DoxyCodeLine{00066\ \textcolor{preprocessor}{\#ifndef\ \_\_TBB\_CPU\_CTL\_ENV\_PRESENT}}
\DoxyCodeLine{00067\ \textcolor{preprocessor}{\#define\ \_\_TBB\_CPU\_CTL\_ENV\_PRESENT\ 1}}
\DoxyCodeLine{00068\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespacetbb}{tbb}}\ \{}
\DoxyCodeLine{00069\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespaceinternal}{internal}}\ \{}
\DoxyCodeLine{00070\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classtbb_1_1internal_1_1cpu__ctl__env_a452a6e875eee2da7d30520a1816104ad}{cpu\_ctl\_env}}\ \{}
\DoxyCodeLine{00071\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00072\ \ \ \ \ \textcolor{keywordtype}{int}\ \ \ \ \ \mbox{\hyperlink{classtbb_1_1internal_1_1cpu__ctl__env_a48ca737907803058091b6c147954e2ab}{mxcsr}};}
\DoxyCodeLine{00073\ \ \ \ \ \textcolor{keywordtype}{short}\ \ \ \mbox{\hyperlink{classtbb_1_1internal_1_1cpu__ctl__env_a713d27adbc89232f955282bfd16d8535}{x87cw}};}
\DoxyCodeLine{00074\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classtbb_1_1internal_1_1cpu__ctl__env_a67c792746625e916a82e42c5a05c92e4}{MXCSR\_CONTROL\_MASK}}\ =\ \string~0x3f;\ \textcolor{comment}{/*\ all\ except\ last\ six\ status\ bits\ */}}
\DoxyCodeLine{00075\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00076\ \ \ \ \ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classtbb_1_1internal_1_1cpu__ctl__env_af50bf6d6c3e61363598d42ce31a62fe0}{operator!=}}(\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classtbb_1_1internal_1_1cpu__ctl__env_a452a6e875eee2da7d30520a1816104ad}{cpu\_ctl\_env}}\&\ ctl\ )\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classtbb_1_1internal_1_1cpu__ctl__env_a48ca737907803058091b6c147954e2ab}{mxcsr}}\ !=\ ctl.\mbox{\hyperlink{classtbb_1_1internal_1_1cpu__ctl__env_a48ca737907803058091b6c147954e2ab}{mxcsr}}\ ||\ \mbox{\hyperlink{classtbb_1_1internal_1_1cpu__ctl__env_a713d27adbc89232f955282bfd16d8535}{x87cw}}\ !=\ ctl.\mbox{\hyperlink{classtbb_1_1internal_1_1cpu__ctl__env_a713d27adbc89232f955282bfd16d8535}{x87cw}};\ \}}
\DoxyCodeLine{00077\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classtbb_1_1internal_1_1cpu__ctl__env_aaa8736f85328446abb0d9b75a031a12d}{get\_env}}()\ \{}
\DoxyCodeLine{00078\ \textcolor{preprocessor}{\ \ \ \ \#if\ \_\_TBB\_ICC\_12\_0\_INL\_ASM\_FSTCW\_BROKEN}}
\DoxyCodeLine{00079\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classtbb_1_1internal_1_1cpu__ctl__env_a452a6e875eee2da7d30520a1816104ad}{cpu\_ctl\_env}}\ loc\_ctl;}
\DoxyCodeLine{00080\ \ \ \ \ \ \ \ \ \_\_asm\_\_\ \_\_volatile\_\_\ (}
\DoxyCodeLine{00081\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}stmxcsr\ \%0\(\backslash\)n\(\backslash\)t"{}}}
\DoxyCodeLine{00082\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}fstcw\ \%1"{}}}
\DoxyCodeLine{00083\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ :\ \textcolor{stringliteral}{"{}=m"{}}(loc\_ctl.\mbox{\hyperlink{classtbb_1_1internal_1_1cpu__ctl__env_a48ca737907803058091b6c147954e2ab}{mxcsr}}),\ \textcolor{stringliteral}{"{}=m"{}}(loc\_ctl.\mbox{\hyperlink{classtbb_1_1internal_1_1cpu__ctl__env_a713d27adbc89232f955282bfd16d8535}{x87cw}})}
\DoxyCodeLine{00084\ \ \ \ \ \ \ \ \ );}
\DoxyCodeLine{00085\ \ \ \ \ \ \ \ \ *\textcolor{keyword}{this}\ =\ loc\_ctl;}
\DoxyCodeLine{00086\ \textcolor{preprocessor}{\ \ \ \ \#else}}
\DoxyCodeLine{00087\ \ \ \ \ \ \ \ \ \_\_asm\_\_\ \_\_volatile\_\_\ (}
\DoxyCodeLine{00088\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}stmxcsr\ \%0\(\backslash\)n\(\backslash\)t"{}}}
\DoxyCodeLine{00089\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}fstcw\ \%1"{}}}
\DoxyCodeLine{00090\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ :\ \textcolor{stringliteral}{"{}=m"{}}(\mbox{\hyperlink{classtbb_1_1internal_1_1cpu__ctl__env_a48ca737907803058091b6c147954e2ab}{mxcsr}}),\ \textcolor{stringliteral}{"{}=m"{}}(\mbox{\hyperlink{classtbb_1_1internal_1_1cpu__ctl__env_a713d27adbc89232f955282bfd16d8535}{x87cw}})}
\DoxyCodeLine{00091\ \ \ \ \ \ \ \ \ );}
\DoxyCodeLine{00092\ \textcolor{preprocessor}{\ \ \ \ \#endif}}
\DoxyCodeLine{00093\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classtbb_1_1internal_1_1cpu__ctl__env_a48ca737907803058091b6c147954e2ab}{mxcsr}}\ \&=\ \mbox{\hyperlink{classtbb_1_1internal_1_1cpu__ctl__env_a67c792746625e916a82e42c5a05c92e4}{MXCSR\_CONTROL\_MASK}};}
\DoxyCodeLine{00094\ \ \ \ \ \}}
\DoxyCodeLine{00095\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classtbb_1_1internal_1_1cpu__ctl__env_a2bef00abf4938dd9ba05d6d7b29551cb}{set\_env}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00096\ \ \ \ \ \ \ \ \ \_\_asm\_\_\ \_\_volatile\_\_\ (}
\DoxyCodeLine{00097\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}ldmxcsr\ \%0\(\backslash\)n\(\backslash\)t"{}}}
\DoxyCodeLine{00098\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}fldcw\ \%1"{}}}
\DoxyCodeLine{00099\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ :\ :\ \textcolor{stringliteral}{"{}m"{}}(\mbox{\hyperlink{classtbb_1_1internal_1_1cpu__ctl__env_a48ca737907803058091b6c147954e2ab}{mxcsr}}),\ \textcolor{stringliteral}{"{}m"{}}(\mbox{\hyperlink{classtbb_1_1internal_1_1cpu__ctl__env_a713d27adbc89232f955282bfd16d8535}{x87cw}})}
\DoxyCodeLine{00100\ \ \ \ \ \ \ \ \ );}
\DoxyCodeLine{00101\ \ \ \ \ \}}
\DoxyCodeLine{00102\ \};}
\DoxyCodeLine{00103\ \}\ \textcolor{comment}{//\ namespace\ internal}}
\DoxyCodeLine{00104\ \}\ \textcolor{comment}{//\ namespace\ tbb}}
\DoxyCodeLine{00105\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{/*\ !\_\_TBB\_CPU\_CTL\_ENV\_PRESENT\ */}\textcolor{preprocessor}{}}
\DoxyCodeLine{00106\ }
\DoxyCodeLine{00107\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{gcc__itsx_8h}{gcc\_itsx.h}}"{}}}
\DoxyCodeLine{00108\ }
\DoxyCodeLine{00109\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{/*\ \_\_TBB\_machine\_gcc\_ia32\_common\_H\ */}\textcolor{preprocessor}{}}

\end{DoxyCode}
