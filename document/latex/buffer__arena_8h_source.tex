\doxysection{buffer\+\_\+arena.\+h}
\hypertarget{buffer__arena_8h_source}{}\label{buffer__arena_8h_source}\index{runtime/runtime/buffer\_arena.h@{runtime/runtime/buffer\_arena.h}}
\mbox{\hyperlink{buffer__arena_8h}{浏览该文件的文档.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{preprocessor}{\#pragma\ once}}
\DoxyCodeLine{00002\ }
\DoxyCodeLine{00003\ \textcolor{preprocessor}{\#include\ <luisa/runtime/buffer.h>}}
\DoxyCodeLine{00004\ \textcolor{preprocessor}{\#include\ <luisa/runtime/device.h>}}
\DoxyCodeLine{00005\ }
\DoxyCodeLine{00006\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespaceluisa_1_1compute}{luisa::compute}}\ \{}
\DoxyCodeLine{00007\ }
\DoxyCodeLine{00008\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classluisa_1_1compute_1_1_buffer_arena_aeea7f5ef242664eacc07a9a72f84e533}{BufferArena}}\ \{}
\DoxyCodeLine{00009\ }
\DoxyCodeLine{00010\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00011\ \ \ \ \ std::mutex\ \mbox{\hyperlink{classluisa_1_1compute_1_1_buffer_arena_ac6b914b72b382228768945ddeea42e57}{\_mutex}};}
\DoxyCodeLine{00012\ \ \ \ \ \mbox{\hyperlink{classluisa_1_1compute_1_1_device}{Device}}\ \&\mbox{\hyperlink{classluisa_1_1compute_1_1_buffer_arena_a747768e2b377d8c2c778799220fcb15e}{\_device}};}
\DoxyCodeLine{00013\ \ \ \ \ luisa::vector<luisa::unique\_ptr<Resource>>\ \mbox{\hyperlink{classluisa_1_1compute_1_1_buffer_arena_ae5b96899e8a0531096a2b22d4f0b3181}{\_buffers}};}
\DoxyCodeLine{00014\ \ \ \ \ luisa::optional<BufferView<float4>>\ \mbox{\hyperlink{classluisa_1_1compute_1_1_buffer_arena_a057c7f622d84af10a8c89b2e443e74a2}{\_current\_buffer}};}
\DoxyCodeLine{00015\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{classluisa_1_1compute_1_1_buffer_arena_a6ceed67d3933fb7032104a9696245863}{\_capacity}};}
\DoxyCodeLine{00016\ }
\DoxyCodeLine{00017\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00018\ \ \ \ \ \textcolor{keyword}{explicit}\ \mbox{\hyperlink{classluisa_1_1compute_1_1_buffer_arena_aeea7f5ef242664eacc07a9a72f84e533}{BufferArena}}(\mbox{\hyperlink{classluisa_1_1compute_1_1_device}{Device}}\ \&device,\ \textcolor{keywordtype}{size\_t}\ capacity\ =\ 4\_M)\ noexcept}
\DoxyCodeLine{00019\ \ \ \ \ \ \ \ \ :\ \mbox{\hyperlink{classluisa_1_1compute_1_1_buffer_arena_a747768e2b377d8c2c778799220fcb15e}{\_device}}\{device\},\ \_capacity\{std::max(\mbox{\hyperlink{namespaceluisa_a126aec1ef45bd8dd50e8b1a00a9e5cb0}{next\_pow2}}(capacity),\ 64\_k)\ /\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{sugar_8h_ada97ec01294ee3122f2f2c8f4058db0c}{float4}})\}\ \{\}}
\DoxyCodeLine{00020\ \ \ \ \ \textcolor{comment}{//\ Allocate\ sub\ buffer\ by\ stack-\/allocator}}
\DoxyCodeLine{00021\ \ \ \ \ \textcolor{keyword}{template}<\textcolor{keyword}{typename}\ T>}
\DoxyCodeLine{00022\ \ \ \ \ [[nodiscard]]\ \mbox{\hyperlink{classluisa_1_1compute_1_1_buffer_view}{BufferView<T>}}\ \mbox{\hyperlink{classluisa_1_1compute_1_1_buffer_arena_a0ffb6cd30576370b3bbb3d19218fea61}{allocate}}(\textcolor{keywordtype}{size\_t}\ n)\ \textcolor{keyword}{noexcept}\ \{}
\DoxyCodeLine{00023\ \ \ \ \ \ \ \ \ \textcolor{keyword}{static\_assert}(\textcolor{keyword}{alignof}(T)\ <=\ 16u);}
\DoxyCodeLine{00024\ \ \ \ \ \ \ \ \ std::scoped\_lock\ lock\{\mbox{\hyperlink{classluisa_1_1compute_1_1_buffer_arena_ac6b914b72b382228768945ddeea42e57}{\_mutex}}\};}
\DoxyCodeLine{00025\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ \mbox{\hyperlink{imgui__impl__opengl3__loader_8h_a3d1e3edfcf61ca2d831883e1afbad89e}{size}}\ =\ n\ *\ \textcolor{keyword}{sizeof}(T);}
\DoxyCodeLine{00026\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ n\_elem\ =\ (\mbox{\hyperlink{imgui__impl__opengl3__loader_8h_a3d1e3edfcf61ca2d831883e1afbad89e}{size}}\ +\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{sugar_8h_ada97ec01294ee3122f2f2c8f4058db0c}{float4}})\ -\/\ 1u)\ /\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{sugar_8h_ada97ec01294ee3122f2f2c8f4058db0c}{float4}});}
\DoxyCodeLine{00027\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (n\_elem\ >\ \mbox{\hyperlink{classluisa_1_1compute_1_1_buffer_arena_a6ceed67d3933fb7032104a9696245863}{\_capacity}})\ \{\textcolor{comment}{//\ too\ big,\ will\ not\ use\ the\ arena}}
\DoxyCodeLine{00028\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ \mbox{\hyperlink{sugar_8h_aaadc06b5dac8070de2c8677210967bdb}{buffer}}\ =\ luisa::make\_unique<Buffer<T>>(\mbox{\hyperlink{classluisa_1_1compute_1_1_buffer_arena_a747768e2b377d8c2c778799220fcb15e}{\_device}}.create\_buffer<T>(n));}
\DoxyCodeLine{00029\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ view\ =\ \mbox{\hyperlink{sugar_8h_aaadc06b5dac8070de2c8677210967bdb}{buffer}}-\/>view();}
\DoxyCodeLine{00030\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classluisa_1_1compute_1_1_buffer_arena_ae5b96899e8a0531096a2b22d4f0b3181}{\_buffers}}.emplace\_back(std::move(\mbox{\hyperlink{sugar_8h_aaadc06b5dac8070de2c8677210967bdb}{buffer}}));}
\DoxyCodeLine{00031\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ view;}
\DoxyCodeLine{00032\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00033\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{classluisa_1_1compute_1_1_buffer_arena_a057c7f622d84af10a8c89b2e443e74a2}{\_current\_buffer}}\ ||\ n\_elem\ >\ \mbox{\hyperlink{classluisa_1_1compute_1_1_buffer_arena_a057c7f622d84af10a8c89b2e443e74a2}{\_current\_buffer}}-\/>size())\ \{}
\DoxyCodeLine{00034\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ \mbox{\hyperlink{sugar_8h_aaadc06b5dac8070de2c8677210967bdb}{buffer}}\ =\ luisa::make\_unique<Buffer<float4>>(}
\DoxyCodeLine{00035\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classluisa_1_1compute_1_1_buffer_arena_a747768e2b377d8c2c778799220fcb15e}{\_device}}.create\_buffer<\mbox{\hyperlink{sugar_8h_ada97ec01294ee3122f2f2c8f4058db0c}{float4}}>(\mbox{\hyperlink{classluisa_1_1compute_1_1_buffer_arena_a6ceed67d3933fb7032104a9696245863}{\_capacity}}));}
\DoxyCodeLine{00036\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classluisa_1_1compute_1_1_buffer_arena_a057c7f622d84af10a8c89b2e443e74a2}{\_current\_buffer}}\ =\ \mbox{\hyperlink{sugar_8h_aaadc06b5dac8070de2c8677210967bdb}{buffer}}-\/>view();}
\DoxyCodeLine{00037\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classluisa_1_1compute_1_1_buffer_arena_ae5b96899e8a0531096a2b22d4f0b3181}{\_buffers}}.emplace\_back(std::move(\mbox{\hyperlink{sugar_8h_aaadc06b5dac8070de2c8677210967bdb}{buffer}}));}
\DoxyCodeLine{00038\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00039\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ view\ =\ \mbox{\hyperlink{classluisa_1_1compute_1_1_buffer_arena_a057c7f622d84af10a8c89b2e443e74a2}{\_current\_buffer}}-\/>subview(0u,\ n\_elem);}
\DoxyCodeLine{00040\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classluisa_1_1compute_1_1_buffer_arena_a057c7f622d84af10a8c89b2e443e74a2}{\_current\_buffer}}\ =\ \mbox{\hyperlink{classluisa_1_1compute_1_1_buffer_arena_a057c7f622d84af10a8c89b2e443e74a2}{\_current\_buffer}}-\/>subview(}
\DoxyCodeLine{00041\ \ \ \ \ \ \ \ \ \ \ \ \ n\_elem,\ \mbox{\hyperlink{classluisa_1_1compute_1_1_buffer_arena_a057c7f622d84af10a8c89b2e443e74a2}{\_current\_buffer}}-\/>size()\ -\/\ n\_elem);}
\DoxyCodeLine{00042\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ view.template\ \mbox{\hyperlink{namespaceluisa_1_1compute_1_1dsl_ac984ff86c9f171267d157e6aae573fdd}{as<T>}}().subview(0u,\ n);}
\DoxyCodeLine{00043\ \ \ \ \ \}}
\DoxyCodeLine{00044\ \};}
\DoxyCodeLine{00045\ }
\DoxyCodeLine{00046\ \}\textcolor{comment}{//\ namespace\ luisa::compute}}
\DoxyCodeLine{00047\ }

\end{DoxyCode}
