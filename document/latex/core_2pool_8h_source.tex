\doxysection{pool.\+h}
\hypertarget{core_2pool_8h_source}{}\label{core_2pool_8h_source}\index{runtime/core/pool.h@{runtime/core/pool.h}}
\mbox{\hyperlink{core_2pool_8h}{浏览该文件的文档.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{preprocessor}{\#pragma\ once}}
\DoxyCodeLine{00002\ }
\DoxyCodeLine{00003\ \textcolor{preprocessor}{\#include\ <\mbox{\hyperlink{core_2stl_2vector_8h}{runtime/core/stl/vector.h}}>}}
\DoxyCodeLine{00004\ \textcolor{preprocessor}{\#include\ <\mbox{\hyperlink{core_2stl_2memory_8h}{runtime/core/stl/memory.h}}>}}
\DoxyCodeLine{00005\ \textcolor{preprocessor}{\#include\ <\mbox{\hyperlink{spin__mutex_8h}{runtime/core/spin\_mutex.h}}>}}
\DoxyCodeLine{00006\ \textcolor{preprocessor}{\#include\ <\mbox{\hyperlink{thread__safety_8h}{runtime/core/thread\_safety.h}}>}}
\DoxyCodeLine{00007\ }
\DoxyCodeLine{00008\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespaceluisa}{luisa}}\ \{}
\DoxyCodeLine{00009\ }
\DoxyCodeLine{00010\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespaceluisa_1_1detail}{detail}}\ \{}
\DoxyCodeLine{00011\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{dll__export_8h_a993a305a4a1179e115e5545134448362}{LC\_CORE\_API}}\ \mbox{\hyperlink{namespaceluisa_1_1detail_ae0b064034784d50dacc199a8bd98547f}{memory\_pool\_check\_memory\_leak}}(\textcolor{keywordtype}{size\_t}\ expected,\ \textcolor{keywordtype}{size\_t}\ actual)\ \textcolor{keyword}{noexcept};}
\DoxyCodeLine{00012\ \}\textcolor{comment}{//\ namespace\ detail}}
\DoxyCodeLine{00013\ }
\DoxyCodeLine{00020\ \textcolor{keyword}{template}<\textcolor{keyword}{typename}\ T,\ \textcolor{keywordtype}{bool}\ thread\_safe\ =\ true,\ \textcolor{keywordtype}{bool}\ check\_recycle\ =\ !std::is\_trivially\_destructible\_v<T>>}
\DoxyCodeLine{00021\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classluisa_1_1_pool_a1e22721172be73eebfb9b0ada189433f}{Pool}}\ :\ \textcolor{keyword}{public}\ \mbox{\hyperlink{classluisa_1_1thread__safety}{thread\_safety}}<conditional\_mutex\_t<true,\ luisa::spin\_mutex>>\ \{}
\DoxyCodeLine{00022\ }
\DoxyCodeLine{00023\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00024\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{constexpr}\ \textcolor{keyword}{auto}\ \mbox{\hyperlink{classluisa_1_1_pool_a1bafd70fc99223c956aa160c738b741c}{block\_size}}\ =\ 64u;}
\DoxyCodeLine{00025\ }
\DoxyCodeLine{00026\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00027\ \ \ \ \ luisa::vector<T\ *>\ \mbox{\hyperlink{classluisa_1_1_pool_a39fd43d31d51a67742887ebf945e31b1}{\_blocks}};}
\DoxyCodeLine{00028\ \ \ \ \ luisa::vector<T\ *>\ \mbox{\hyperlink{classluisa_1_1_pool_a66f46fb9d58b15d5eb1d30489c90b30c}{\_available\_objects}};}
\DoxyCodeLine{00029\ }
\DoxyCodeLine{00030\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00031\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classluisa_1_1_pool_aa37ed80dd3a3c3763072158cb471f060}{\_enlarge}}()\ noexcept\ \{}
\DoxyCodeLine{00032\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ \mbox{\hyperlink{imgui__impl__opengl3__loader_8h_a3d1e3edfcf61ca2d831883e1afbad89e}{size}}\ =\ \textcolor{keyword}{sizeof}(T)\ *\ \mbox{\hyperlink{classluisa_1_1_pool_a1bafd70fc99223c956aa160c738b741c}{block\_size}};}
\DoxyCodeLine{00033\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ \mbox{\hyperlink{main-override_8cpp_a117104b82864d3b23ec174af6d392709}{p}}\ =\ \textcolor{keyword}{static\_cast<}T\ *\textcolor{keyword}{>}(\mbox{\hyperlink{namespaceluisa_1_1detail_ae03dfdec276b43e305493a945601127f}{detail::allocator\_allocate}}(\mbox{\hyperlink{imgui__impl__opengl3__loader_8h_a3d1e3edfcf61ca2d831883e1afbad89e}{size}},\ \textcolor{keyword}{alignof}(T)));}
\DoxyCodeLine{00034\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{classluisa_1_1_pool_a39fd43d31d51a67742887ebf945e31b1}{\_blocks}}.empty())\ \{\ \mbox{\hyperlink{classluisa_1_1_pool_a66f46fb9d58b15d5eb1d30489c90b30c}{\_available\_objects}}.reserve(\mbox{\hyperlink{classluisa_1_1_pool_a1bafd70fc99223c956aa160c738b741c}{block\_size}});\ \}}
\DoxyCodeLine{00035\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classluisa_1_1_pool_a39fd43d31d51a67742887ebf945e31b1}{\_blocks}}.emplace\_back(\mbox{\hyperlink{main-override_8cpp_a117104b82864d3b23ec174af6d392709}{p}});}
\DoxyCodeLine{00036\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{main-override_8cpp_a117104b82864d3b23ec174af6d392709}{p}}\ +=\ \mbox{\hyperlink{classluisa_1_1_pool_a1bafd70fc99223c956aa160c738b741c}{block\_size}};}
\DoxyCodeLine{00037\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keyword}{auto}\ i\ =\ 0u;\ i\ <\ \mbox{\hyperlink{classluisa_1_1_pool_a1bafd70fc99223c956aa160c738b741c}{block\_size}};\ i++)\ \{}
\DoxyCodeLine{00038\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classluisa_1_1_pool_a66f46fb9d58b15d5eb1d30489c90b30c}{\_available\_objects}}.emplace\_back(-\/-\/\mbox{\hyperlink{main-override_8cpp_a117104b82864d3b23ec174af6d392709}{p}});}
\DoxyCodeLine{00039\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00040\ \ \ \ \ \}}
\DoxyCodeLine{00041\ }
\DoxyCodeLine{00042\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classluisa_1_1_pool_a614b2e18f193c83c62d5796b756e9285}{\_dispose}}()\ noexcept\ \{}
\DoxyCodeLine{00043\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{classluisa_1_1_pool_a39fd43d31d51a67742887ebf945e31b1}{\_blocks}}.empty())\ \{}
\DoxyCodeLine{00044\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keyword}{constexpr}\ (check\_recycle)\ \{}
\DoxyCodeLine{00045\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespaceluisa_1_1detail_ae0b064034784d50dacc199a8bd98547f}{detail::memory\_pool\_check\_memory\_leak}}(}
\DoxyCodeLine{00046\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classluisa_1_1_pool_a39fd43d31d51a67742887ebf945e31b1}{\_blocks}}.size()\ *\ \mbox{\hyperlink{classluisa_1_1_pool_a1bafd70fc99223c956aa160c738b741c}{block\_size}},}
\DoxyCodeLine{00047\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classluisa_1_1_pool_a66f46fb9d58b15d5eb1d30489c90b30c}{\_available\_objects}}.size());}
\DoxyCodeLine{00048\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00049\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keyword}{auto}\ \mbox{\hyperlink{offscreen_8c_a83fc1af92e29717b4513d121b0c72c7d}{b}}\ :\ \mbox{\hyperlink{classluisa_1_1_pool_a39fd43d31d51a67742887ebf945e31b1}{\_blocks}})\ \{}
\DoxyCodeLine{00050\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespaceluisa_1_1detail_a96b6030cfea3a61879c413d62601aadd}{detail::allocator\_deallocate}}(\mbox{\hyperlink{offscreen_8c_a83fc1af92e29717b4513d121b0c72c7d}{b}},\ \textcolor{keyword}{alignof}(T));}
\DoxyCodeLine{00051\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00052\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classluisa_1_1_pool_a39fd43d31d51a67742887ebf945e31b1}{\_blocks}}.clear();}
\DoxyCodeLine{00053\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00054\ \ \ \ \ \}}
\DoxyCodeLine{00055\ }
\DoxyCodeLine{00056\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00061\ \ \ \ \ \mbox{\hyperlink{classluisa_1_1_pool_a1e22721172be73eebfb9b0ada189433f}{Pool}}()\ noexcept\ =\ \mbox{\hyperlink{sugar_8h_a6face89e97cccad5464dd9bb9c7efd23}{default}};}
\DoxyCodeLine{00062\ \ \ \ \ \mbox{\hyperlink{classluisa_1_1_pool_a1e22721172be73eebfb9b0ada189433f}{Pool}}(\mbox{\hyperlink{classluisa_1_1_pool_a1e22721172be73eebfb9b0ada189433f}{Pool}}\ \&\&rhs)\ noexcept}
\DoxyCodeLine{00063\ \ \ \ \ \ \ \ \ :\ \mbox{\hyperlink{classluisa_1_1_pool_a39fd43d31d51a67742887ebf945e31b1}{\_blocks}}\{std::move(rhs.\_blocks)\},}
\DoxyCodeLine{00064\ \ \ \ \ \ \ \ \ \ \ \_available\_objects\{std::move(rhs.\_available\_objects)\}\ \{}
\DoxyCodeLine{00065\ \ \ \ \ \}}
\DoxyCodeLine{00066\ \ \ \ \ \mbox{\hyperlink{classluisa_1_1_pool_a97cecc0300d785ed4dac3c0bb7c89268}{Pool}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classluisa_1_1_pool_a1e22721172be73eebfb9b0ada189433f}{Pool}}\ \&)\ \textcolor{keyword}{noexcept}\ =\ \textcolor{keyword}{delete};}
\DoxyCodeLine{00067\ }
\DoxyCodeLine{00068\ \ \ \ \ \mbox{\hyperlink{classluisa_1_1_pool_a1e22721172be73eebfb9b0ada189433f}{Pool}}\ \&\mbox{\hyperlink{classluisa_1_1_pool_abdedc35d25aa32148fdb1127710bed00}{operator=}}(\mbox{\hyperlink{classluisa_1_1_pool_a1e22721172be73eebfb9b0ada189433f}{Pool}}\ \&\&rhs)\ \textcolor{keyword}{noexcept}\ \{}
\DoxyCodeLine{00069\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classluisa_1_1_pool_a614b2e18f193c83c62d5796b756e9285}{\_dispose}}();}
\DoxyCodeLine{00070\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classluisa_1_1_pool_a39fd43d31d51a67742887ebf945e31b1}{\_blocks}}\ =\ std::move(rhs.\_blocks);}
\DoxyCodeLine{00071\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classluisa_1_1_pool_a66f46fb9d58b15d5eb1d30489c90b30c}{\_available\_objects}}\ =\ std::move(rhs.\_available\_objects);}
\DoxyCodeLine{00072\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ *\textcolor{keyword}{this};}
\DoxyCodeLine{00073\ \ \ \ \ \}}
\DoxyCodeLine{00074\ \ \ \ \ \mbox{\hyperlink{classluisa_1_1_pool_a1e22721172be73eebfb9b0ada189433f}{Pool}}\ \&\mbox{\hyperlink{classluisa_1_1_pool_a9bd6a9ff23a4d09e57883fe7ba6417d8}{operator=}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classluisa_1_1_pool_a1e22721172be73eebfb9b0ada189433f}{Pool}}\ \&)\ \textcolor{keyword}{noexcept}\ =\ \textcolor{keywordflow}{default};}
\DoxyCodeLine{00075\ }
\DoxyCodeLine{00080\ \ \ \ \ \mbox{\hyperlink{classluisa_1_1_pool_a80bc39429193cde2ac72769899c00155}{\string~Pool}}()\ noexcept\ \{}
\DoxyCodeLine{00081\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classluisa_1_1_pool_a614b2e18f193c83c62d5796b756e9285}{\_dispose}}();}
\DoxyCodeLine{00082\ \ \ \ \ \}}
\DoxyCodeLine{00083\ }
\DoxyCodeLine{00084\ \ \ \ \ [[nodiscard]]\ \textcolor{keyword}{auto}\ \mbox{\hyperlink{classluisa_1_1_pool_a037511833eb5c443b71531bc1b94a419}{allocate}}()\ noexcept\ \{}
\DoxyCodeLine{00085\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classluisa_1_1thread__safety_a7b7a3d302662ef2340722f07a6dac0cc}{with\_lock}}([\textcolor{keyword}{this}]\ \{}
\DoxyCodeLine{00086\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{classluisa_1_1_pool_a66f46fb9d58b15d5eb1d30489c90b30c}{\_available\_objects}}.empty())\ \{\ \mbox{\hyperlink{classluisa_1_1_pool_aa37ed80dd3a3c3763072158cb471f060}{\_enlarge}}();\ \}}
\DoxyCodeLine{00087\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ \mbox{\hyperlink{main-override_8cpp_a117104b82864d3b23ec174af6d392709}{p}}\ =\ \mbox{\hyperlink{classluisa_1_1_pool_a66f46fb9d58b15d5eb1d30489c90b30c}{\_available\_objects}}.back();}
\DoxyCodeLine{00088\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classluisa_1_1_pool_a66f46fb9d58b15d5eb1d30489c90b30c}{\_available\_objects}}.pop\_back();}
\DoxyCodeLine{00089\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{main-override_8cpp_a117104b82864d3b23ec174af6d392709}{p}};}
\DoxyCodeLine{00090\ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{00091\ \ \ \ \ \}}
\DoxyCodeLine{00092\ }
\DoxyCodeLine{00093\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classluisa_1_1_pool_ae95282450d962aab77d1758b640f53ba}{deallocate}}(T\ *\textcolor{keywordtype}{object})\ \textcolor{keyword}{noexcept}\ \{}
\DoxyCodeLine{00094\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classluisa_1_1thread__safety_a7b7a3d302662ef2340722f07a6dac0cc}{with\_lock}}([\textcolor{keyword}{this},\ \textcolor{keywordtype}{object}]\ \{}
\DoxyCodeLine{00095\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classluisa_1_1_pool_a66f46fb9d58b15d5eb1d30489c90b30c}{\_available\_objects}}.emplace\_back(\textcolor{keywordtype}{object});}
\DoxyCodeLine{00096\ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{00097\ \ \ \ \ \}}
\DoxyCodeLine{00098\ }
\DoxyCodeLine{00106\ \ \ \ \ \textcolor{keyword}{template}<\textcolor{keyword}{typename}...\ Args>}
\DoxyCodeLine{00107\ \ \ \ \ \textcolor{keyword}{requires}(\mbox{\hyperlink{namespaceluisa_a42aac091d78b935fc1bbe40618ad4bb8}{luisa::is\_constructible\_v}}<T,\ Args\&\&...>)}
\DoxyCodeLine{00108\ \ \ \ \ [[nodiscard]]\ \textcolor{keyword}{auto}\ \mbox{\hyperlink{classluisa_1_1_pool_a31a82c74a38d31338ac46fac143d0f3d}{create}}(Args\ \&\&...args)\ \textcolor{keyword}{noexcept}\ \{}
\DoxyCodeLine{00109\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ \mbox{\hyperlink{main-override_8cpp_a117104b82864d3b23ec174af6d392709}{p}}\ =\ \mbox{\hyperlink{allocator_8c_a3a4fc1fa103fa3a33fc168de4cd6703e}{allocate}}();}
\DoxyCodeLine{00110\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ std::construct\_at(\mbox{\hyperlink{main-override_8cpp_a117104b82864d3b23ec174af6d392709}{p}},\ std::forward<Args>(args)...);}
\DoxyCodeLine{00111\ \ \ \ \ \}}
\DoxyCodeLine{00112\ }
\DoxyCodeLine{00119\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classluisa_1_1_pool_ab86c2dcb6f4eed9b1ddaf8c65055282e}{destroy}}(T\ *\textcolor{keywordtype}{object})\ \textcolor{keyword}{noexcept}\ \{}
\DoxyCodeLine{00120\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keyword}{constexpr}\ (!std::is\_trivially\_destructible\_v<T>)\ \{\ \textcolor{keywordtype}{object}-\/>\string~T();\ \}}
\DoxyCodeLine{00121\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{allocator_8c_af6d0cf7cc14ac871f484ce755a237a06}{deallocate}}(\textcolor{keywordtype}{object});}
\DoxyCodeLine{00122\ \ \ \ \ \}}
\DoxyCodeLine{00123\ \};}
\DoxyCodeLine{00124\ }
\DoxyCodeLine{00125\ \}\textcolor{comment}{//\ namespace\ luisa}}

\end{DoxyCode}
