\doxysection{runtime/\+EASTL/packages/mimalloc/bin 目录参考}
\hypertarget{dir_163d6e220634c8ea619389189518aef1}{}\label{dir_163d6e220634c8ea619389189518aef1}\index{runtime/EASTL/packages/mimalloc/bin 目录参考@{runtime/EASTL/packages/mimalloc/bin 目录参考}}
bin 的目录依赖关系图
% FIG 0


\doxysubsection{详细描述}
We use a separate redirection DLL to override mimalloc on Windows such that we redirect all malloc/free calls that go through the (dynamic) C runtime allocator, including those from other DLL\textquotesingle{}s or libraries. As it intercepts all allocation calls on a low level, it can be used on large programs that include other 3rd party components. There are four requirements to make the overriding work well\+:


\begin{DoxyEnumerate}
\item Use the C-\/runtime library as a DLL (using the {\ttfamily /\+MD} or {\ttfamily /\+MDd} switch).
\item Link your program explicitly with the {\ttfamily mimalloc.\+dll.\+lib} export library for the {\ttfamily mimalloc.\+dll} -- which contains all mimalloc functionality. To ensure the {\ttfamily mimalloc.\+dll} is actually loaded at run-\/time it is easiest to insert some call to the mimalloc API in the {\ttfamily main} function, like {\ttfamily \doxylink{mimalloc_8h_a906d3e6d7f3e9cf284134c7d23d965e7}{mi\+\_\+version()}} (or use the {\ttfamily /include\+:mi\+\_\+version} switch on the linker, or similarly, {\ttfamily \#pragma comment(linker, "{}/include\+:mi\+\_\+version"{})} in some source file). See the {\ttfamily mimalloc-\/test-\/override} project for an example on how to use this.
\item The {\ttfamily mimalloc-\/redirect.\+dll} must be put in the same folder as the main {\ttfamily mimalloc.\+dll} at runtime (as it is a dependency of that DLL). The redirection DLL ensures that all calls to the C runtime malloc API get redirected to mimalloc functions (which reside in {\ttfamily mimalloc.\+dll}).
\item Ensure the {\ttfamily mimalloc.\+dll} comes as early as possible in the import list of the final executable (so it can intercept all potential allocations). You can use {\ttfamily minject -\/l \texorpdfstring{$<$}{<}exe\texorpdfstring{$>$}{>}} to check this if needed.
\end{DoxyEnumerate}


\begin{DoxyCode}{0}
\DoxyCodeLine{┌──────────────┐\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{│\ Your\ Program\ │\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{└────┬─────────┘\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\ \ \ \ \ │\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\ \ \ \ \ │\ \mbox{\hyperlink{mimalloc_8h_a906d3e6d7f3e9cf284134c7d23d965e7}{mi\_version}}()\ \ ┌───────────────┐\ \ \ \ \ ┌───────────────────────┐}
\DoxyCodeLine{\ \ \ \ \ ├──────────────►│\ mimalloc.dll\ \ ├────►│\ mimalloc-\/redirect.dll\ │}
\DoxyCodeLine{\ \ \ \ \ │\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ └──────┬────────┘\ \ \ \ \ └───────────────────────┘}
\DoxyCodeLine{\ \ \ \ \ │\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ▼\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\ \ \ \ \ │\ \mbox{\hyperlink{mimalloc-override_8h_a99aa8fd9f4831e1b0fa9e1cdcde3e249}{malloc}}()\ etc.\ ┌──────────────┐\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\ \ \ \ \ ├──────────────►│\ ucrtbase.dll\ │\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\ \ \ \ \ │\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ └──────────────┘\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\ \ \ \ \ │\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\ \ \ \ \ │\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\ \ \ \ \ └──────────────►\ ...\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }

\end{DoxyCode}


For best performance on Windows with C++, it is also recommended to also override the {\ttfamily new}/{\ttfamily delete} operations (by including \href{../include/mimalloc-new-delete.h}{\texttt{ {\ttfamily mimalloc-\/new-\/delete.\+h}}} a single(!) source file in your project).

The environment variable {\ttfamily MIMALLOC\+\_\+\+DISABLE\+\_\+\+REDIRECT=1} can be used to disable dynamic overriding at run-\/time. Use {\ttfamily MIMALLOC\+\_\+\+VERBOSE=1} to check if mimalloc was successfully redirected.\hypertarget{readme.md_autotoc_md14}{}\doxysubsubsection{\texorpdfstring{Other Platforms}{Other Platforms}}\label{readme.md_autotoc_md14}
You always link with {\ttfamily mimalloc.\+dll} but for different platforms you may need a specific redirection DLL\+:


\begin{DoxyItemize}
\item {\bfseries{x64}}\+: {\ttfamily mimalloc-\/redirect.\+dll}.
\item {\bfseries{x86}}\+: {\ttfamily mimalloc-\/redirect32.\+dll}. Use for older 32-\/bit Windows programs.
\item {\bfseries{arm64}}\+: {\ttfamily mimalloc-\/redirect-\/arm64.\+dll}. Use for native Windows arm64 programs.
\item {\bfseries{arm64ec}}\+: {\ttfamily mimalloc-\/redirect-\/arm64ec.\+dll}. The \href{https://learn.microsoft.com/en-us/windows/arm/arm64ec}{\texttt{ arm64ec}} ABI is "{}emulation compatible"{} mode on Windows arm64. Unfortunately we cannot run x64 code emulated on Windows arm64 with the x64 mimalloc override directly (since the C runtime always uses {\ttfamily arm64ec}). Instead\+:
\begin{DoxyEnumerate}
\item Build the program as normal for x64 and link as normal with the x64 {\ttfamily mimalloc.\+dll.\+lib} export library.
\item Now separately build {\ttfamily mimalloc.\+dll} in {\ttfamily arm64ec} mode and {\itshape overwrite} your previous (x64) {\ttfamily mimalloc.\+dll} -- the loader can handle the mix of arm64ec and x64 code. Now use {\ttfamily mimalloc-\/redirect-\/arm64ec.\+dll} to match your new arm64ec {\ttfamily mimalloc.\+dll}. The main program stays as is and can be fully x64 or contain more arm64ec modules. At runtime, the arm64ec {\ttfamily mimalloc.\+dll} will run with native arm64 instructions while the rest of the program runs emulated x64.
\end{DoxyEnumerate}
\end{DoxyItemize}\hypertarget{readme.md_autotoc_md15}{}\doxysubsubsection{\texorpdfstring{Minject}{Minject}}\label{readme.md_autotoc_md15}
We cannot always re-\/link an executable with {\ttfamily mimalloc.\+dll}, and similarly, we cannot always ensure that the DLL comes first in the import table of the final executable. In many cases though we can patch existing executables without any recompilation if they are linked with the dynamic C runtime ({\ttfamily ucrtbase.\+dll}) -- just put the {\ttfamily mimalloc.\+dll} into the import table (and put {\ttfamily mimalloc-\/redirect.\+dll} in the same directory) Such patching can be done for example with \href{https://ntcore.com/?page_id=388}{\texttt{ CFF Explorer}}.

The {\ttfamily minject} program can also do this from the command line Use {\ttfamily minject -\/-\/help} for options\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{>\ minject\ -\/-\/help}
\DoxyCodeLine{}
\DoxyCodeLine{minject:}
\DoxyCodeLine{\ \ Injects\ the\ mimalloc\ dll\ into\ the\ import\ table\ of\ a\ 64-\/bit\ executable,}
\DoxyCodeLine{\ \ and/or\ ensures\ that\ it\ comes\ first\ in\ het\ import\ table.}
\DoxyCodeLine{}
\DoxyCodeLine{usage:}
\DoxyCodeLine{\ \ >\ minject\ [options]\ <exe>}
\DoxyCodeLine{}
\DoxyCodeLine{options:}
\DoxyCodeLine{\ \ -\/h\ \ \ -\/-\/help\ \ \ \ \ \ \ \ show\ this\ help}
\DoxyCodeLine{\ \ -\/v\ \ \ -\/-\/verbose\ \ \ \ \ be\ verbose}
\DoxyCodeLine{\ \ -\/l\ \ \ -\/-\/list\ \ \ \ \ \ \ \ only\ list\ imported\ modules}
\DoxyCodeLine{\ \ -\/i\ \ \ -\/-\/inplace\ \ \ \ \ update\ the\ exe\ in-\/place\ (make\ sure\ there\ is\ a\ backup!)}
\DoxyCodeLine{\ \ -\/f\ \ \ -\/-\/force\ \ \ \ \ \ \ always\ overwrite\ without\ prompting}
\DoxyCodeLine{\ \ \ \ \ \ \ -\/-\/postfix=<p>\ use\ <p>\ as\ a\ postfix\ to\ the\ mimalloc\ dll.}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ e.g.\ use\ -\/-\/postfix=debug\ to\ link\ with\ mimalloc-\/debug.dll}
\DoxyCodeLine{}
\DoxyCodeLine{notes:}
\DoxyCodeLine{\ \ Without\ '-\/-\/inplace'\ an\ injected\ <exe>\ is\ generated\ with\ the\ same\ name\ ending\ in\ '-\/mi'.}
\DoxyCodeLine{\ \ Ensure\ 'mimalloc-\/redirect.dll'\ is\ in\ the\ same\ folder\ as\ the\ mimalloc\ dll.}
\DoxyCodeLine{}
\DoxyCodeLine{examples:}
\DoxyCodeLine{\ \ >\ minject\ -\/-\/list\ myprogram.exe}
\DoxyCodeLine{\ \ >\ minject\ -\/-\/force\ -\/-\/inplace\ myprogram.exe}

\end{DoxyCode}


For x86 32-\/bit binaries, use {\ttfamily minject32}, and for arm64 binaries use {\ttfamily minject-\/arm64}. 