\doxysection{cuda\+\_\+common.\+h}
\hypertarget{cuda__common_8h_source}{}\label{cuda__common_8h_source}\index{external/taskflow/3rd-\/party/eigen-\/3.3.7/test/cuda\_common.h@{external/taskflow/3rd-\/party/eigen-\/3.3.7/test/cuda\_common.h}}
\mbox{\hyperlink{cuda__common_8h}{浏览该文件的文档.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ }
\DoxyCodeLine{00002\ \textcolor{preprocessor}{\#ifndef\ EIGEN\_TEST\_CUDA\_COMMON\_H}}
\DoxyCodeLine{00003\ \textcolor{preprocessor}{\#define\ EIGEN\_TEST\_CUDA\_COMMON\_H}}
\DoxyCodeLine{00004\ }
\DoxyCodeLine{00005\ \textcolor{preprocessor}{\#include\ <cuda.h>}}
\DoxyCodeLine{00006\ \textcolor{preprocessor}{\#include\ <cuda\_runtime.h>}}
\DoxyCodeLine{00007\ \textcolor{preprocessor}{\#include\ <cuda\_runtime\_api.h>}}
\DoxyCodeLine{00008\ \textcolor{preprocessor}{\#include\ <iostream>}}
\DoxyCodeLine{00009\ }
\DoxyCodeLine{00010\ \textcolor{preprocessor}{\#ifndef\ \_\_CUDACC\_\_}}
\DoxyCodeLine{00011\ dim3\ \mbox{\hyperlink{cuda__common_8h_a0a680a9519f7aaccce02a4bb4c0a0b52}{threadIdx}},\ \mbox{\hyperlink{cuda__common_8h_a1a2cdcc50d7e1505a058c5832ebe5702}{blockDim}},\ \mbox{\hyperlink{cuda__common_8h_ab30e5f6958c9264d3c5235d463eb2b57}{blockIdx}};}
\DoxyCodeLine{00012\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00013\ }
\DoxyCodeLine{00014\ \textcolor{keyword}{template}<\textcolor{keyword}{typename}\ Kernel,\ \textcolor{keyword}{typename}\ Input,\ \textcolor{keyword}{typename}\ Output>}
\DoxyCodeLine{00015\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{cuda__common_8h_ac6fe3277d974fdfc37105ea2912f1b8b}{run\_on\_cpu}}(\textcolor{keyword}{const}\ Kernel\&\ ker,\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}},\ \textcolor{keyword}{const}\ Input\&\ in,\ Output\&\ out)}
\DoxyCodeLine{00016\ \{}
\DoxyCodeLine{00017\ \ \ \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int}\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}=0;\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}<\mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}};\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}++)}
\DoxyCodeLine{00018\ \ \ \ \ ker(\mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}},\ in.data(),\ out.data());}
\DoxyCodeLine{00019\ \}}
\DoxyCodeLine{00020\ }
\DoxyCodeLine{00021\ }
\DoxyCodeLine{00022\ \textcolor{keyword}{template}<\textcolor{keyword}{typename}\ Kernel,\ \textcolor{keyword}{typename}\ Input,\ \textcolor{keyword}{typename}\ Output>}
\DoxyCodeLine{00023\ \_\_global\_\_}
\DoxyCodeLine{00024\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{cuda__common_8h_a00d8f8a1725eea6813fd39f93d643a1e}{run\_on\_cuda\_meta\_kernel}}(\textcolor{keyword}{const}\ Kernel\ ker,\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}},\ \textcolor{keyword}{const}\ Input*\ in,\ Output*\ out)}
\DoxyCodeLine{00025\ \{}
\DoxyCodeLine{00026\ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}\ =\ \mbox{\hyperlink{cuda__common_8h_a0a680a9519f7aaccce02a4bb4c0a0b52}{threadIdx}}.x\ +\ \mbox{\hyperlink{cuda__common_8h_ab30e5f6958c9264d3c5235d463eb2b57}{blockIdx}}.x*\mbox{\hyperlink{cuda__common_8h_a1a2cdcc50d7e1505a058c5832ebe5702}{blockDim}}.x;}
\DoxyCodeLine{00027\ \ \ \textcolor{keywordflow}{if}(\mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}<\mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}})\ \{}
\DoxyCodeLine{00028\ \ \ \ \ ker(\mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}},\ in,\ out);}
\DoxyCodeLine{00029\ \ \ \}}
\DoxyCodeLine{00030\ \}}
\DoxyCodeLine{00031\ }
\DoxyCodeLine{00032\ }
\DoxyCodeLine{00033\ \textcolor{keyword}{template}<\textcolor{keyword}{typename}\ Kernel,\ \textcolor{keyword}{typename}\ Input,\ \textcolor{keyword}{typename}\ Output>}
\DoxyCodeLine{00034\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{cuda__common_8h_a458905ae10e4d478ee9531fc28e05ade}{run\_on\_cuda}}(\textcolor{keyword}{const}\ Kernel\&\ ker,\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}},\ \textcolor{keyword}{const}\ Input\&\ in,\ Output\&\ out)}
\DoxyCodeLine{00035\ \{}
\DoxyCodeLine{00036\ \ \ \textcolor{keyword}{typename}\ Input::Scalar*\ \ d\_in;}
\DoxyCodeLine{00037\ \ \ \textcolor{keyword}{typename}\ Output::Scalar*\ d\_out;}
\DoxyCodeLine{00038\ \ \ std::ptrdiff\_t\ in\_bytes\ \ =\ in.size()\ \ *\ \textcolor{keyword}{sizeof}(\textcolor{keyword}{typename}\ Input::Scalar);}
\DoxyCodeLine{00039\ \ \ std::ptrdiff\_t\ out\_bytes\ =\ out.size()\ *\ \textcolor{keyword}{sizeof}(\textcolor{keyword}{typename}\ Output::Scalar);}
\DoxyCodeLine{00040\ \ \ }
\DoxyCodeLine{00041\ \ \ cudaMalloc((\textcolor{keywordtype}{void}**)(\&d\_in),\ \ in\_bytes);}
\DoxyCodeLine{00042\ \ \ cudaMalloc((\textcolor{keywordtype}{void}**)(\&d\_out),\ out\_bytes);}
\DoxyCodeLine{00043\ \ \ }
\DoxyCodeLine{00044\ \ \ cudaMemcpy(d\_in,\ \ in.data(),\ \ in\_bytes,\ \ cudaMemcpyHostToDevice);}
\DoxyCodeLine{00045\ \ \ cudaMemcpy(d\_out,\ out.data(),\ out\_bytes,\ cudaMemcpyHostToDevice);}
\DoxyCodeLine{00046\ \ \ }
\DoxyCodeLine{00047\ \ \ \textcolor{comment}{//\ Simple\ and\ non-\/optimal\ 1D\ mapping\ assuming\ n\ is\ not\ too\ large}}
\DoxyCodeLine{00048\ \ \ \textcolor{comment}{//\ That's\ only\ for\ unit\ testing!}}
\DoxyCodeLine{00049\ \ \ dim3\ Blocks(128);}
\DoxyCodeLine{00050\ \ \ dim3\ Grids(\ (\mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}}+\textcolor{keywordtype}{int}(Blocks.x)-\/1)/\textcolor{keywordtype}{int}(Blocks.x)\ );}
\DoxyCodeLine{00051\ }
\DoxyCodeLine{00052\ \ \ cudaThreadSynchronize();}
\DoxyCodeLine{00053\ \ \ \mbox{\hyperlink{cuda__common_8h_a00d8f8a1725eea6813fd39f93d643a1e}{run\_on\_cuda\_meta\_kernel<<<Grids,Blocks>}}>>(ker,\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}},\ d\_in,\ d\_out);}
\DoxyCodeLine{00054\ \ \ cudaThreadSynchronize();}
\DoxyCodeLine{00055\ \ \ }
\DoxyCodeLine{00056\ \ \ \textcolor{comment}{//\ check\ inputs\ have\ not\ been\ modified}}
\DoxyCodeLine{00057\ \ \ cudaMemcpy(\textcolor{keyword}{const\_cast<}typename\ Input::Scalar*\textcolor{keyword}{>}(in.data()),\ \ d\_in,\ \ in\_bytes,\ \ cudaMemcpyDeviceToHost);}
\DoxyCodeLine{00058\ \ \ cudaMemcpy(out.data(),\ d\_out,\ out\_bytes,\ cudaMemcpyDeviceToHost);}
\DoxyCodeLine{00059\ \ \ }
\DoxyCodeLine{00060\ \ \ cudaFree(d\_in);}
\DoxyCodeLine{00061\ \ \ cudaFree(d\_out);}
\DoxyCodeLine{00062\ \}}
\DoxyCodeLine{00063\ }
\DoxyCodeLine{00064\ }
\DoxyCodeLine{00065\ \textcolor{keyword}{template}<\textcolor{keyword}{typename}\ Kernel,\ \textcolor{keyword}{typename}\ Input,\ \textcolor{keyword}{typename}\ Output>}
\DoxyCodeLine{00066\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{cuda__common_8h_a2dc4ebcb4f6037b6045dbdbe0f1f6143}{run\_and\_compare\_to\_cuda}}(\textcolor{keyword}{const}\ Kernel\&\ ker,\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}},\ \textcolor{keyword}{const}\ Input\&\ in,\ Output\&\ out)}
\DoxyCodeLine{00067\ \{}
\DoxyCodeLine{00068\ \ \ Input\ \ in\_ref,\ \ in\_cuda;}
\DoxyCodeLine{00069\ \ \ Output\ out\_ref,\ out\_cuda;}
\DoxyCodeLine{00070\ \textcolor{preprocessor}{\ \ \#ifndef\ \_\_CUDA\_ARCH\_\_}}
\DoxyCodeLine{00071\ \ \ in\_ref\ =\ in\_cuda\ =\ in;}
\DoxyCodeLine{00072\ \ \ out\_ref\ =\ out\_cuda\ =\ out;}
\DoxyCodeLine{00073\ \textcolor{preprocessor}{\ \ \#endif}}
\DoxyCodeLine{00074\ \ \ \mbox{\hyperlink{cuda__common_8h_ac6fe3277d974fdfc37105ea2912f1b8b}{run\_on\_cpu}}\ (ker,\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}},\ in\_ref,\ \ out\_ref);}
\DoxyCodeLine{00075\ \ \ \mbox{\hyperlink{cuda__common_8h_a458905ae10e4d478ee9531fc28e05ade}{run\_on\_cuda}}(ker,\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__simple_8cpp_a5150192f625f4d7970d61169b9567f39}{n}},\ in\_cuda,\ out\_cuda);}
\DoxyCodeLine{00076\ \textcolor{preprocessor}{\ \ \#ifndef\ \_\_CUDA\_ARCH\_\_}}
\DoxyCodeLine{00077\ \ \ \mbox{\hyperlink{integer__types_8cpp_a5bba36711e335d7eb5793360e7d7b100}{VERIFY\_IS\_APPROX}}(in\_ref,\ in\_cuda);}
\DoxyCodeLine{00078\ \ \ \mbox{\hyperlink{integer__types_8cpp_a5bba36711e335d7eb5793360e7d7b100}{VERIFY\_IS\_APPROX}}(out\_ref,\ out\_cuda);}
\DoxyCodeLine{00079\ \textcolor{preprocessor}{\ \ \#endif}}
\DoxyCodeLine{00080\ \}}
\DoxyCodeLine{00081\ }
\DoxyCodeLine{00082\ }
\DoxyCodeLine{00083\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{cuda__common_8h_a8b98641e2f753aba3a18dedd013e67a3}{ei\_test\_init\_cuda}}()}
\DoxyCodeLine{00084\ \{}
\DoxyCodeLine{00085\ \ \ \textcolor{keywordtype}{int}\ device\ =\ 0;}
\DoxyCodeLine{00086\ \ \ cudaDeviceProp\ deviceProp;}
\DoxyCodeLine{00087\ \ \ cudaGetDeviceProperties(\&deviceProp,\ device);}
\DoxyCodeLine{00088\ \ \ std::cout\ <<\ \textcolor{stringliteral}{"{}CUDA\ device\ info:\(\backslash\)n"{}};}
\DoxyCodeLine{00089\ \ \ std::cout\ <<\ \textcolor{stringliteral}{"{}\ \ name:\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ "{}}\ <<\ deviceProp.name\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00090\ \ \ std::cout\ <<\ \textcolor{stringliteral}{"{}\ \ capability:\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ "{}}\ <<\ deviceProp.major\ <<\ \textcolor{stringliteral}{"{}."{}}\ <<\ deviceProp.minor\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00091\ \ \ std::cout\ <<\ \textcolor{stringliteral}{"{}\ \ multiProcessorCount:\ \ \ \ \ \ \ \ \ "{}}\ <<\ deviceProp.multiProcessorCount\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00092\ \ \ std::cout\ <<\ \textcolor{stringliteral}{"{}\ \ maxThreadsPerMultiProcessor:\ "{}}\ <<\ deviceProp.maxThreadsPerMultiProcessor\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00093\ \ \ std::cout\ <<\ \textcolor{stringliteral}{"{}\ \ warpSize:\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ "{}}\ <<\ deviceProp.warpSize\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00094\ \ \ std::cout\ <<\ \textcolor{stringliteral}{"{}\ \ regsPerBlock:\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ "{}}\ <<\ deviceProp.regsPerBlock\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00095\ \ \ std::cout\ <<\ \textcolor{stringliteral}{"{}\ \ concurrentKernels:\ \ \ \ \ \ \ \ \ \ \ "{}}\ <<\ deviceProp.concurrentKernels\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00096\ \ \ std::cout\ <<\ \textcolor{stringliteral}{"{}\ \ clockRate:\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ "{}}\ <<\ deviceProp.clockRate\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00097\ \ \ std::cout\ <<\ \textcolor{stringliteral}{"{}\ \ canMapHostMemory:\ \ \ \ \ \ \ \ \ \ \ \ "{}}\ <<\ deviceProp.canMapHostMemory\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00098\ \ \ std::cout\ <<\ \textcolor{stringliteral}{"{}\ \ computeMode:\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ "{}}\ <<\ deviceProp.computeMode\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00099\ \}}
\DoxyCodeLine{00100\ }
\DoxyCodeLine{00101\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ EIGEN\_TEST\_CUDA\_COMMON\_H}}

\end{DoxyCode}
