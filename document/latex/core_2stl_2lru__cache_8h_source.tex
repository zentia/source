\doxysection{lru\+\_\+cache.\+h}
\hypertarget{core_2stl_2lru__cache_8h_source}{}\label{core_2stl_2lru__cache_8h_source}\index{runtime/core/stl/lru\_cache.h@{runtime/core/stl/lru\_cache.h}}
\mbox{\hyperlink{core_2stl_2lru__cache_8h}{浏览该文件的文档.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{preprocessor}{\#pragma\ once}}
\DoxyCodeLine{00002\ }
\DoxyCodeLine{00003\ \textcolor{preprocessor}{\#include\ <mutex>}}
\DoxyCodeLine{00004\ }
\DoxyCodeLine{00005\ \textcolor{preprocessor}{\#ifdef\ LUISA\_USE\_SYSTEM\_STL}}
\DoxyCodeLine{00006\ \textcolor{preprocessor}{\#include\ <unordered\_map>}}
\DoxyCodeLine{00007\ \textcolor{preprocessor}{\#include\ <list>}}
\DoxyCodeLine{00008\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00009\ \textcolor{preprocessor}{\#include\ <\mbox{\hyperlink{_e_a_s_t_l_2include_2_e_a_s_t_l_2bonus_2lru__cache_8h}{EASTL/bonus/lru\_cache.h}}>}}
\DoxyCodeLine{00010\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00011\ }
\DoxyCodeLine{00012\ \textcolor{preprocessor}{\#include\ <luisa/core/stl/hash\_fwd.h>}}
\DoxyCodeLine{00013\ \textcolor{preprocessor}{\#include\ <luisa/core/stl/memory.h>}}
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ <luisa/core/stl/optional.h>}}
\DoxyCodeLine{00015\ }
\DoxyCodeLine{00016\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespaceluisa}{luisa}}\ \{}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#ifdef\ LUISA\_USE\_SYSTEM\_STL}}
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00020\ \textcolor{keyword}{template}<\textcolor{keyword}{typename}\ Key,\ \textcolor{keyword}{typename}\ Value,\ \textcolor{keyword}{typename}\ Hash\ =\ luisa::hash<Key>>}
\DoxyCodeLine{00021\ \textcolor{keyword}{class\ }\mbox{\hyperlink{namespaceluisa_af7b016ad1e1a192c48b44188369c48f1}{lru\_cache}}\ \{}
\DoxyCodeLine{00022\ }
\DoxyCodeLine{00023\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00024\ \ \ \ \ \textcolor{keyword}{using\ }List\ =\ std::list<Key>;}
\DoxyCodeLine{00025\ \ \ \ \ \textcolor{keyword}{using\ }ListIterator\ =\ \textcolor{keyword}{typename}\ \mbox{\hyperlink{class_list_a52b0ad5061b96766684b0ef65305ae4e}{List::iterator}};}
\DoxyCodeLine{00026\ \ \ \ \ \textcolor{keyword}{struct\ }Node\ \{}
\DoxyCodeLine{00027\ \ \ \ \ \ \ \ \ ListIterator\ it;}
\DoxyCodeLine{00028\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespace_im_gui_a1b3324308e43eeded5c3599fa0f03e85}{Value}}\ \mbox{\hyperlink{imgui__impl__opengl3__loader_8h_a1b2be7bfa84f129a2690a62f3ad82d62}{value}};}
\DoxyCodeLine{00029\ \ \ \ \ \};}
\DoxyCodeLine{00030\ \ \ \ \ \textcolor{keyword}{using\ }Cache\ =\ std::unordered\_map<Key,\ Node,\ Hash>;}
\DoxyCodeLine{00031\ }
\DoxyCodeLine{00032\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00033\ \ \ \ \ Cache\ \_cache;}
\DoxyCodeLine{00034\ \ \ \ \ List\ \_list;}
\DoxyCodeLine{00035\ \ \ \ \ luisa::function<\mbox{\hyperlink{mimalloc_8h_a9d6d8aef94ac19034a5f163606f84830}{void}}(\textcolor{keyword}{const}\ Value\ \&)>\ \_delete\_callback;}
\DoxyCodeLine{00036\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ \_capacity;}
\DoxyCodeLine{00037\ }
\DoxyCodeLine{00038\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00039\ \ \ \ \ \textcolor{keywordtype}{void}\ \_touch(\textcolor{keyword}{const}\ Node\ \&node)\ \textcolor{keyword}{noexcept}\ \{}
\DoxyCodeLine{00040\ \ \ \ \ \ \ \ \ \_list.splice(\_list.\mbox{\hyperlink{class_list_a119aa1ef679745145e3689966dee5dc6}{begin}}(),\ \_list,\ node.it);}
\DoxyCodeLine{00041\ \ \ \ \ \}}
\DoxyCodeLine{00042\ }
\DoxyCodeLine{00043\ \ \ \ \ \textcolor{keywordtype}{void}\ \_make\_space()\ noexcept\ \{}
\DoxyCodeLine{00044\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (\_cache.size()\ >=\ \_capacity)\ \{}
\DoxyCodeLine{00045\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ iter\ =\ \_cache.find(\_list.back());}
\DoxyCodeLine{00046\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_delete\_callback)\ \{\ \_delete\_callback(iter-\/>second.value);\ \}}
\DoxyCodeLine{00047\ \ \ \ \ \ \ \ \ \ \ \ \ \_cache.erase(iter);}
\DoxyCodeLine{00048\ \ \ \ \ \ \ \ \ \ \ \ \ \_list.pop\_back();}
\DoxyCodeLine{00049\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00050\ \ \ \ \ \}}
\DoxyCodeLine{00051\ }
\DoxyCodeLine{00052\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00053\ \ \ \ \ \textcolor{keyword}{explicit}\ \mbox{\hyperlink{namespaceluisa_af7b016ad1e1a192c48b44188369c48f1}{lru\_cache}}(\textcolor{keywordtype}{size\_t}\ capacity)\ noexcept}
\DoxyCodeLine{00054\ \ \ \ \ \ \ \ \ :\ \_capacity\{std::max<size\_t>(capacity,\ 1u)\}\ \{\}}
\DoxyCodeLine{00055\ \ \ \ \ \textcolor{keywordtype}{void}\ setDeleteCallback(luisa::function<\textcolor{keywordtype}{void}(\textcolor{keyword}{const}\ Value\ \&)>\ callback)\ \textcolor{keyword}{noexcept}\ \{}
\DoxyCodeLine{00056\ \ \ \ \ \ \ \ \ \_delete\_callback\ =\ std::move(callback);}
\DoxyCodeLine{00057\ \ \ \ \ \}}
\DoxyCodeLine{00058\ \ \ \ \ [[nodiscard]]\ \textcolor{keyword}{auto}\ at(\textcolor{keyword}{const}\ Key\ \&\mbox{\hyperlink{gears_8c_accd6b5b92b78666e36543412d4ac14cd}{key}})\ \textcolor{keyword}{noexcept}\ -\/>\ luisa::optional<Value>\ \{}
\DoxyCodeLine{00059\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ iter\ =\ \_cache.find(\mbox{\hyperlink{gears_8c_accd6b5b92b78666e36543412d4ac14cd}{key}});}
\DoxyCodeLine{00060\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ iter\ ==\ \_cache.end()\ ?\ luisa::nullopt\ :\ luisa::make\_optional(iter-\/>second.value);}
\DoxyCodeLine{00061\ \ \ \ \ \}}
\DoxyCodeLine{00062\ \ \ \ \ \textcolor{keyword}{auto}\ touch(\textcolor{keyword}{const}\ Key\ \&\mbox{\hyperlink{gears_8c_accd6b5b92b78666e36543412d4ac14cd}{key}})\ \textcolor{keyword}{noexcept}\ -\/>\ \textcolor{keywordtype}{bool}\ \{}
\DoxyCodeLine{00063\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\textcolor{keyword}{auto}\ iter\ =\ \_cache.find(\mbox{\hyperlink{gears_8c_accd6b5b92b78666e36543412d4ac14cd}{key}});\ iter\ !=\ \_cache.end())\ \{}
\DoxyCodeLine{00064\ \ \ \ \ \ \ \ \ \ \ \ \ \_touch(iter-\/>second);}
\DoxyCodeLine{00065\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00066\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00067\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00068\ \ \ \ \ \}}
\DoxyCodeLine{00069\ \ \ \ \ \textcolor{keyword}{template}<\textcolor{keyword}{typename}...\ Args>}
\DoxyCodeLine{00070\ \ \ \ \ \textcolor{keywordtype}{void}\ emplace(\textcolor{keyword}{const}\ Key\ \&\mbox{\hyperlink{gears_8c_accd6b5b92b78666e36543412d4ac14cd}{key}},\ Args\ \&\&...args)\ \textcolor{keyword}{noexcept}\ \{}
\DoxyCodeLine{00071\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\textcolor{keyword}{auto}\ iter\ =\ \_cache.find(\mbox{\hyperlink{gears_8c_accd6b5b92b78666e36543412d4ac14cd}{key}});\ iter\ !=\ \_cache.end())\ \{}
\DoxyCodeLine{00072\ \ \ \ \ \ \ \ \ \ \ \ \ \_touch(iter-\/>second);}
\DoxyCodeLine{00073\ \ \ \ \ \ \ \ \ \ \ \ \ iter-\/>second.value\ =\ \mbox{\hyperlink{namespace_im_gui_a1b3324308e43eeded5c3599fa0f03e85}{Value}}\{std::forward<Args>(args)...\};}
\DoxyCodeLine{00074\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00075\ \ \ \ \ \ \ \ \ \ \ \ \ \_make\_space();}
\DoxyCodeLine{00076\ \ \ \ \ \ \ \ \ \ \ \ \ \_list.push\_front(\mbox{\hyperlink{gears_8c_accd6b5b92b78666e36543412d4ac14cd}{key}});}
\DoxyCodeLine{00077\ \ \ \ \ \ \ \ \ \ \ \ \ \_cache.emplace(\mbox{\hyperlink{gears_8c_accd6b5b92b78666e36543412d4ac14cd}{key}},\ Node\{\_list.\mbox{\hyperlink{class_list_a119aa1ef679745145e3689966dee5dc6}{begin}}(),\ \mbox{\hyperlink{namespace_im_gui_a1b3324308e43eeded5c3599fa0f03e85}{Value}}\{std::forward<Args>(args)...\}\});}
\DoxyCodeLine{00078\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00079\ \ \ \ \ \}}
\DoxyCodeLine{00080\ \};}
\DoxyCodeLine{00081\ }
\DoxyCodeLine{00082\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00083\ \textcolor{keyword}{template}<\textcolor{keyword}{typename}\ Key,\ \textcolor{keyword}{typename}\ Value,\ \textcolor{keyword}{typename}\ Hash\ =\ luisa::hash<Key>>}
\DoxyCodeLine{00084\ \textcolor{keyword}{using\ }\mbox{\hyperlink{namespaceluisa_af7b016ad1e1a192c48b44188369c48f1}{lru\_cache}}\ =\ \mbox{\hyperlink{classeastl_1_1lru__cache}{eastl::lru\_cache}}<}
\DoxyCodeLine{00085\ \ \ \ \ Key,\ Value,}
\DoxyCodeLine{00086\ \ \ \ \ \mbox{\hyperlink{config_8h_a3564b87eb9f54f24c7251e787c936539}{EASTLAllocatorType}},}
\DoxyCodeLine{00087\ \ \ \ \ \mbox{\hyperlink{classeastl_1_1list}{eastl::list<Key,\ EASTLAllocatorType>}},}
\DoxyCodeLine{00088\ \ \ \ \ \mbox{\hyperlink{namespaceeastl_a11dc7c78f1eebafa6b5560699fcb7515}{eastl::unordered\_map}}<}
\DoxyCodeLine{00089\ \ \ \ \ \ \ \ \ Key,}
\DoxyCodeLine{00090\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structeastl_1_1pair}{eastl::pair<Value,\ typename\ eastl::list<Key,\ EASTLAllocatorType>::iterator}}>,}
\DoxyCodeLine{00091\ \ \ \ \ \ \ \ \ luisa::hash<Key>,}
\DoxyCodeLine{00092\ \ \ \ \ \ \ \ \ std::equal\_to<Key>,}
\DoxyCodeLine{00093\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{config_8h_a3564b87eb9f54f24c7251e787c936539}{EASTLAllocatorType}}>>;}
\DoxyCodeLine{00094\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00095\ }
\DoxyCodeLine{00096\ \textcolor{comment}{//\ TODO:\ support\ allocator\ \&\ comparator}}
\DoxyCodeLine{00097\ \textcolor{keyword}{template}<\textcolor{keyword}{typename}\ Key,\ \textcolor{keyword}{typename}\ Value>}
\DoxyCodeLine{00098\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classluisa_1_1_l_r_u_cache_a02502b5c9fa964d82976b541d6fdfa2c}{LRUCache}}\ \{}
\DoxyCodeLine{00099\ }
\DoxyCodeLine{00100\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00101\ \ \ \ \ luisa::lru\_cache<Key,\ Value>\ \mbox{\hyperlink{classluisa_1_1_l_r_u_cache_a63d7208284c4d98218b861bd12345025}{\_cache}};}
\DoxyCodeLine{00102\ \ \ \ \ std::mutex\ \mbox{\hyperlink{classluisa_1_1_l_r_u_cache_ab3a9c677a8082a144af5a26556ed6f0d}{\_mutex}};}
\DoxyCodeLine{00103\ }
\DoxyCodeLine{00104\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00105\ \ \ \ \ \textcolor{keyword}{explicit}\ \mbox{\hyperlink{classluisa_1_1_l_r_u_cache_a02502b5c9fa964d82976b541d6fdfa2c}{LRUCache}}(\textcolor{keywordtype}{size\_t}\ cap)\ noexcept\ :\ \mbox{\hyperlink{classluisa_1_1_l_r_u_cache_a63d7208284c4d98218b861bd12345025}{\_cache}}\{cap\}\ \{\}}
\DoxyCodeLine{00106\ \ \ \ \ \mbox{\hyperlink{classluisa_1_1_l_r_u_cache_ab789007695abb0a7ebff488cd699e765}{LRUCache}}(\mbox{\hyperlink{classluisa_1_1_l_r_u_cache_a02502b5c9fa964d82976b541d6fdfa2c}{LRUCache}}\ \&\&)\ noexcept\ =\ delete;}
\DoxyCodeLine{00107\ \ \ \ \ \mbox{\hyperlink{classluisa_1_1_l_r_u_cache_a02502b5c9fa964d82976b541d6fdfa2c}{LRUCache}}(const\ \mbox{\hyperlink{classluisa_1_1_l_r_u_cache_a02502b5c9fa964d82976b541d6fdfa2c}{LRUCache}}\ \&)\ noexcept\ =\ delete;}
\DoxyCodeLine{00108\ \ \ \ \ \mbox{\hyperlink{classluisa_1_1_l_r_u_cache_a02502b5c9fa964d82976b541d6fdfa2c}{LRUCache}}\ \&operator=(\mbox{\hyperlink{classluisa_1_1_l_r_u_cache_a02502b5c9fa964d82976b541d6fdfa2c}{LRUCache}}\ \&\&)\ noexcept\ =\ delete;}
\DoxyCodeLine{00109\ \ \ \ \ \mbox{\hyperlink{classluisa_1_1_l_r_u_cache_a02502b5c9fa964d82976b541d6fdfa2c}{LRUCache}}\ \&operator=(const\ \mbox{\hyperlink{classluisa_1_1_l_r_u_cache_a02502b5c9fa964d82976b541d6fdfa2c}{LRUCache}}\ \&)\ noexcept\ =\ delete;}
\DoxyCodeLine{00110\ }
\DoxyCodeLine{00111\ \ \ \ \ [[nodiscard]]\ static\ auto\ \mbox{\hyperlink{classluisa_1_1_l_r_u_cache_a38ea205509d85e6337157a5a839aad3a}{create}}(\textcolor{keywordtype}{size\_t}\ capacity)\ noexcept\ \{}
\DoxyCodeLine{00112\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ luisa::make\_unique<LRUCache>(capacity);}
\DoxyCodeLine{00113\ \ \ \ \ \}}
\DoxyCodeLine{00114\ }
\DoxyCodeLine{00115\ \ \ \ \ \textcolor{keyword}{template}<\textcolor{keyword}{typename}\ F>}
\DoxyCodeLine{00116\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classluisa_1_1_l_r_u_cache_ac8453265f6c6427d8c2a1fd4a655944e}{set\_delete\_callback}}(F\ \&\&f)\ \textcolor{keyword}{noexcept}\ \{}
\DoxyCodeLine{00117\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classluisa_1_1_l_r_u_cache_a63d7208284c4d98218b861bd12345025}{\_cache}}.setDeleteCallback(std::forward<F>(f));}
\DoxyCodeLine{00118\ \ \ \ \ \}}
\DoxyCodeLine{00119\ }
\DoxyCodeLine{00120\ \ \ \ \ [[nodiscard]]\ \textcolor{keyword}{auto}\ \mbox{\hyperlink{classluisa_1_1_l_r_u_cache_a0cf258dfde476e47f1ca1b9153bba89a}{fetch}}(\textcolor{keyword}{const}\ Key\ \&\mbox{\hyperlink{gears_8c_accd6b5b92b78666e36543412d4ac14cd}{key}})\ \textcolor{keyword}{noexcept}\ -\/>\ luisa::optional<Value>\ \{}
\DoxyCodeLine{00121\ \ \ \ \ \ \ \ \ std::lock\_guard\ lock\{\mbox{\hyperlink{classluisa_1_1_l_r_u_cache_ab3a9c677a8082a144af5a26556ed6f0d}{\_mutex}}\};}
\DoxyCodeLine{00122\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ \mbox{\hyperlink{imgui__impl__opengl3__loader_8h_a1b2be7bfa84f129a2690a62f3ad82d62}{value}}\ =\ \mbox{\hyperlink{classluisa_1_1_l_r_u_cache_a63d7208284c4d98218b861bd12345025}{\_cache}}.at(\mbox{\hyperlink{gears_8c_accd6b5b92b78666e36543412d4ac14cd}{key}});}
\DoxyCodeLine{00123\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classluisa_1_1_l_r_u_cache_a63d7208284c4d98218b861bd12345025}{\_cache}}.touch(\mbox{\hyperlink{gears_8c_accd6b5b92b78666e36543412d4ac14cd}{key}});}
\DoxyCodeLine{00124\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{imgui__impl__opengl3__loader_8h_a1b2be7bfa84f129a2690a62f3ad82d62}{value}};}
\DoxyCodeLine{00125\ \ \ \ \ \}}
\DoxyCodeLine{00126\ }
\DoxyCodeLine{00127\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classluisa_1_1_l_r_u_cache_a763f25938c11d04c1b8afbb368963253}{update}}(\textcolor{keyword}{const}\ Key\ \&\mbox{\hyperlink{gears_8c_accd6b5b92b78666e36543412d4ac14cd}{key}},\ Value\ \mbox{\hyperlink{imgui__impl__opengl3__loader_8h_a1b2be7bfa84f129a2690a62f3ad82d62}{value}})\ \textcolor{keyword}{noexcept}\ \{}
\DoxyCodeLine{00128\ \ \ \ \ \ \ \ \ std::lock\_guard\ lock\{\mbox{\hyperlink{classluisa_1_1_l_r_u_cache_ab3a9c677a8082a144af5a26556ed6f0d}{\_mutex}}\};}
\DoxyCodeLine{00129\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classluisa_1_1_l_r_u_cache_a63d7208284c4d98218b861bd12345025}{\_cache}}.emplace(\mbox{\hyperlink{gears_8c_accd6b5b92b78666e36543412d4ac14cd}{key}},\ std::move(\mbox{\hyperlink{imgui__impl__opengl3__loader_8h_a1b2be7bfa84f129a2690a62f3ad82d62}{value}}));}
\DoxyCodeLine{00130\ \ \ \ \ \}}
\DoxyCodeLine{00131\ \};}
\DoxyCodeLine{00132\ }
\DoxyCodeLine{00133\ \}\textcolor{comment}{//\ namespace\ luisa}}

\end{DoxyCode}
