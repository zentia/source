\doxysection{Task-\/parallel Pipeline with Token Dependencies}
\hypertarget{_task_parallel_pipeline_with_token_dependencies}{}\label{_task_parallel_pipeline_with_token_dependencies}\index{Task-\/parallel Pipeline with Token Dependencies@{Task-\/parallel Pipeline with Token Dependencies}}
Taskflow pipeline allows you to defer the execution of a token to future tokens. This deferral introduces a dependency from a future token to the current token, particularly suitable for many video encoding applications. We recommend reading \doxylink{TaskParallelPipeline}{Task-\/parallel Pipeline} first before learning this interface.\hypertarget{_task_parallel_pipeline_with_token_dependencies_DeferredPipelineTokenDependencies}{}\doxysubsection{\texorpdfstring{Understand Token Dependencies}{Understand Token Dependencies}}\label{_task_parallel_pipeline_with_token_dependencies_DeferredPipelineTokenDependencies}
Token dependencies establish the order in which data tokens should execute in a task-\/parallel pipeline. When token {\ttfamily t1} completes before {\ttfamily t2} starts, there is a dependency from {\ttfamily t1} to {\ttfamily t2}. We categorize token dependencies into two types\+:
\begin{DoxyItemize}
\item forward token dependencies (FTD)\+: dependencies from earlier to future tokens
\item backward token dependencies (BTD)\+: dependencies from future to earlier tokens The following figure illustrates a sample token dependency diagram and its token execution sequence. Edge pointing from token 2 to 5 is FTD, and those from 8 to 2 and 5 and 9 to 5 are BTDs. Based on the dependencies, the tokens execute in the corresponding execution sequence.
\end{DoxyItemize}

\hypertarget{_task_parallel_pipeline_with_token_dependencies_DeferredPipelineResolveTokenDependencies}{}\doxysubsection{\texorpdfstring{Resolve Token Dependencies}{Resolve Token Dependencies}}\label{_task_parallel_pipeline_with_token_dependencies_DeferredPipelineResolveTokenDependencies}
To resolve the token dependencies, the basic idea is to defer the execution of a token with unresolved dependencies and save the token in a data structure until its dependencies are resolved. To implement the idea, we leverage three data structures, deferred\+\_\+tokens (DT), token\+\_\+dependencies (TD), and ready\+\_\+tokens (RT). DT and TD are associative containers and RT is a queue. DT stores deferred tokens and their dependents by which the deferred tokens are deferred. TD stores a dependent and its related deferred tokens. RT stores the tokens that were deferred tokens and now are ready because their dependencies are resolved. The following image illustrates the usages of the three data structures to resolve the token dependencies and get the corresponding serial execution sequence exemplified in \doxysectlink{_task_parallel_pipeline_with_token_dependencies_DeferredPipelineTokenDependencies}{Understand Token Dependencies}{1}.



The whole process has the following steps\+:


\begin{DoxyEnumerate}
\item Token 1 is not a deferred token and then 1 is finished. Now the execution sequence is \{1\}.
\item Token 2 defers to 8. We insert DT\mbox{[}2\mbox{]}=\{8\} and TD\mbox{[}8\mbox{]}=\{2\}. The black circle 2 in the above image illustrates this step.
\item Token 3 is not a deferred token and then 3 is finished. Now the execution sequence is \{1,3\}.
\item Token 4 is not a deferred token and then 4 is finished. Now the execution sequence is \{1,3,4\}.
\item Token 5 defers to 2 and 7. We insert DT\mbox{[}5\mbox{]}=\{2,7\}, TD\mbox{[}2\mbox{]}=\{5\}, and TD\mbox{[}7\mbox{]}=\{5\}. The black circle 5 in the above image illustrates this step.
\item Token 6 is not a deferred token and then 6 is finished. Now the execution sequence is \{1,3,4,6\}.
\item Token 7 is not a deferred token and then 7 is finished. Now the execution sequence is \{1,3,4,6,7\}. Since TD\mbox{[}7\mbox{]}=\{5\}, we directly remove 7 from DT\mbox{[}5\mbox{]}. The black circle 7 in the above image illustrates this step.
\item Token 8 is not a deferred token and then 8 is finished. Now the execution sequence is \{1,3,4,6,7,8\}. Since TD\mbox{[}8\mbox{]}=\{2\}, we directly remove 8 from DT\mbox{[}2\mbox{]} and find out DT\mbox{[}2\mbox{]} is empty. Now token 2 is no longer a deferred token and we move 2 to RT. The black circle 8 in the above image illustrates this step.
\item RT is not empty and has a token 2. Then we finish running 2. Now the execution sequence is \{1,3,4,6,7,8,2\}. Since TD\mbox{[}2\mbox{]}=\{5\}, we directly remove 2 from DT\mbox{[}5\mbox{]} and find out DT\mbox{[}5\mbox{]} is empty. Now token 5 is no longer a deferred token and we move 5 to RT. The black circle 9 in the above image illustrates this step.
\item RT is not empty and has a token 5. Then we run 5 and find out token 5 defers the second time, defers to 9. We insert DT\mbox{[}5\mbox{]}=\{9\} and TD\mbox{[}9\mbox{]}=\{5\}. The black circle 20 in the above image illustrates this step.
\item Token 9 is not a deferred token and then 9 is finished. Now the execution sequence is \{1,3,4,6,7,8,2,9\}. Since TD\mbox{[}9\mbox{]}=\{5\}, we directly remove 9 from DT\mbox{[}5\mbox{]} and find out DT\mbox{[}5\mbox{]} is empty. Now token 5 is no longer a deferred token and we move 5 to RT. The black circle 11 in the above image illustrates this step.
\item RT is not empty and has a token 5. Then we finish running 5. Now the execution sequence is \{1,3,4,6,7,8,2,9,5\}. The black circle 12 in the above image illustrates this step.
\item Token 10 is not a deferred token and then 10 is finished. Now the execution sequence is \{1,3,4,6,7,8,2,9,5,10\}.
\end{DoxyEnumerate}\hypertarget{_task_parallel_pipeline_with_token_dependencies_DeferredPipelineIncludeHeaderFile}{}\doxysubsection{\texorpdfstring{Include the Header}{Include the Header}}\label{_task_parallel_pipeline_with_token_dependencies_DeferredPipelineIncludeHeaderFile}
You need to include the header file, {\ttfamily taskflow/algorithm/pipeline.hpp}, for implementing deferred pipeline algorithms.


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{preprocessor}{\#include\ <\mbox{\hyperlink{taskflow_2algorithm_2pipeline_8hpp}{taskflow/algorithm/pipeline.hpp}}>}}

\end{DoxyCode}
\hypertarget{_task_parallel_pipeline_with_token_dependencies_CreateADeferredPipelineModuleTask}{}\doxysubsection{\texorpdfstring{Create a Deferred Pipeline Module Task}{Create a Deferred Pipeline Module Task}}\label{_task_parallel_pipeline_with_token_dependencies_CreateADeferredPipelineModuleTask}
To create a deferred pipeline application, there are four steps, one more step than creating a task-\/parallel pipeline (\doxylink{classtf_1_1_pipeline}{tf\+::\+Pipeline})\+:


\begin{DoxyEnumerate}
\item Define the pipeline structure (e.\+g., pipe type, pipe callable, stopping rule, line count)
\item Define the token dependencies {\bfseries{at the first pipe}}
\item Define the data storage and layout, if needed for the application
\item Define the pipeline taskflow graph using composition
\end{DoxyEnumerate}

The following example demonstrates the creation of a deferred pipeline application exemplified in the dependency diagram in \doxysectlink{_task_parallel_pipeline_with_token_dependencies_DeferredPipelineTokenDependencies}{Understand Token Dependencies}{1}. The example creates a deferred pipeline that generates a total of 10 data tokens. The pipeline structure consists of four lines and three stages (all serial types).


\begin{DoxyCode}{0}
\DoxyCodeLine{\ 1:\ \mbox{\hyperlink{classtf_1_1_taskflow}{tf::Taskflow}}\ \mbox{\hyperlink{poisson_8hpp_aa56fe360bb0ae38e0082f49e394ff825}{taskflow}}(\textcolor{stringliteral}{"{}deferred\_pipeline"{}});}
\DoxyCodeLine{\ 2:\ \mbox{\hyperlink{classtf_1_1_executor}{tf::Executor}}\ \mbox{\hyperlink{thread__pool_8cpp_a543e564a8407bbeac15cb2d929fec755}{executor}};}
\DoxyCodeLine{\ 3:}
\DoxyCodeLine{\ 4:\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ num\_lines\ =\ 4;}
\DoxyCodeLine{\ 5:}
\DoxyCodeLine{\ 6:\ \textcolor{comment}{//\ the\ pipeline\ consists\ of\ three\ pipes\ (serial-\/serial-\/serial)}}
\DoxyCodeLine{\ 7:\ \textcolor{comment}{//\ and\ up\ to\ four\ concurrent\ scheduling\ tokens}}
\DoxyCodeLine{\ 8:\ \mbox{\hyperlink{classtf_1_1_pipeline}{tf::Pipeline}}\ pl(num\_lines,}
\DoxyCodeLine{\ 9:\ \ \ \mbox{\hyperlink{classtf_1_1_pipe}{tf::Pipe}}\{\mbox{\hyperlink{namespacetf_abb7a11e41fd457f69e7ff45d4c769564a7b804a28d6154ab8007287532037f1d0}{tf::PipeType::SERIAL}},\ [](\mbox{\hyperlink{classtf_1_1_pipeflow}{tf::Pipeflow}}\&\ pf)\ \{}
\DoxyCodeLine{10:\ \ \ \ \ \ \textcolor{comment}{//\ stop\ at\ 11\ scheduling\ tokens}}
\DoxyCodeLine{11:\ \ \ \ \ \ \textcolor{keywordflow}{if}(pf.token()\ ==\ 11)\ \{}
\DoxyCodeLine{12:\ \ \ \ \ \ \ \ pf.stop();}
\DoxyCodeLine{13:\ \ \ \ \ \ \}}
\DoxyCodeLine{14:\ \ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{15:\ \ \ \ \ \ \ \ \textcolor{comment}{//\ Token\ 5\ is\ deferred}}
\DoxyCodeLine{16:\ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (pf.token()\ ==\ 5)\ \{}
\DoxyCodeLine{17:\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{switch}(pf.num\_deferrals())\ \{}
\DoxyCodeLine{18:\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ 0:}
\DoxyCodeLine{19:\ \ \ \ \ \ \ \ \ \ \ \ \ \ pf.defer(2);}
\DoxyCodeLine{20:\ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}1st-\/time:\ Token\ \%zu\ is\ deferred\ by\ 2\(\backslash\)n"{}},\ pf.token());}
\DoxyCodeLine{21:\ \ \ \ \ \ \ \ \ \ \ \ \ \ pf.defer(7);}
\DoxyCodeLine{22:\ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}1st-\/time:\ Token\ \%zu\ is\ deferred\ by\ 7\(\backslash\)n"{}},\ pf.token());}
\DoxyCodeLine{23:\ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};\ \ }
\DoxyCodeLine{24:\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{25:}
\DoxyCodeLine{26:\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ 1:}
\DoxyCodeLine{27:\ \ \ \ \ \ \ \ \ \ \ \ \ \ pf.defer(9);}
\DoxyCodeLine{28:\ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}2nd-\/time:\ Token\ \%zu\ is\ deferred\ by\ 9\(\backslash\)n"{}},\ pf.token());}
\DoxyCodeLine{29:\ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{30:\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{31:}
\DoxyCodeLine{32:\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ 2:}
\DoxyCodeLine{33:\ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}3rd-\/time:\ Tokens\ 2,\ 7\ and\ 9\ resolved\ dependencies\ \(\backslash\)}}
\DoxyCodeLine{\textcolor{stringliteral}{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ for\ token\ \%zu\(\backslash\)n"{}},\ pf.token());}
\DoxyCodeLine{34:\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{35:\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{36:\ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{37:\ \ \ \ \ \ \ \ \textcolor{comment}{//\ token\ 2\ is\ deferred}}
\DoxyCodeLine{38:\ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (pf.token()\ ==\ 2)\ \{}
\DoxyCodeLine{39:\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{switch}(pf.num\_deferrals())\ \{}
\DoxyCodeLine{40:\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ 0:}
\DoxyCodeLine{41:\ \ \ \ \ \ \ \ \ \ \ \ \ \ pf.defer(8);}
\DoxyCodeLine{42:\ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}1st-\/time:\ Token\ \%zu\ is\ deferred\ by\ 8\(\backslash\)n"{}},\ pf.token());}
\DoxyCodeLine{43:\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{44:\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ 1:}
\DoxyCodeLine{45:\ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}2nd-\/time:\ Token\ 8\ resolved\ dependencies\ for\ token\ \%zu\(\backslash\)n"{}},}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pf.token());}
\DoxyCodeLine{46:\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{47:\ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{48:\ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{49:\ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{50:\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}stage\ 1:\ Non-\/deferred\ token\ \%zu\(\backslash\)n"{}},\ pf.token());}
\DoxyCodeLine{51:\ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{52:\ \ \ \ \ \ \}}
\DoxyCodeLine{53:\ \ \ \ \}\},}
\DoxyCodeLine{54:}
\DoxyCodeLine{55:\ \ \ \ tf::Pipe\{\mbox{\hyperlink{namespacetf_abb7a11e41fd457f69e7ff45d4c769564a7b804a28d6154ab8007287532037f1d0}{tf::PipeType::SERIAL}},\ [](tf::Pipeflow\&\ pf)\ \{}
\DoxyCodeLine{56:\ \ \ \ \ \ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}stage\ 2:\ input\ token\ \%zu\ (deferrals=\%zu)\(\backslash\)n"{}},}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pf.token(),\ pf.num\_deferrals());}
\DoxyCodeLine{57:\ \ \ \ \}\},}
\DoxyCodeLine{58:}
\DoxyCodeLine{59:\ \ \ \ tf::Pipe\{\mbox{\hyperlink{namespacetf_abb7a11e41fd457f69e7ff45d4c769564a7b804a28d6154ab8007287532037f1d0}{tf::PipeType::SERIAL}},\ [](tf::Pipeflow\&\ pf)\ \{}
\DoxyCodeLine{60:\ \ \ \ \ \ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}stage\ 3:\ input\ token\ \%zu\(\backslash\)n"{}},\ pf.token());}
\DoxyCodeLine{61:\ \ \ \ \}\}}
\DoxyCodeLine{62:\ \ );}
\DoxyCodeLine{63:\ \ }
\DoxyCodeLine{64:\ \ tf::Task\ \mbox{\hyperlink{test__partitioner__whitebox_8h_a5c4cf3d37a4eee22275de22cb9619863}{task}}\ =\ \mbox{\hyperlink{poisson_8hpp_aa56fe360bb0ae38e0082f49e394ff825}{taskflow}}.composed\_of(pl);}
\DoxyCodeLine{65:}
\DoxyCodeLine{66:\ \ \textcolor{comment}{//\ run\ the\ pipeline}}
\DoxyCodeLine{67:\ \ \mbox{\hyperlink{thread__pool_8cpp_a543e564a8407bbeac15cb2d929fec755}{executor}}.\mbox{\hyperlink{classtf_1_1_executor_a519777f5783981d534e9e53b99712069}{run}}(\mbox{\hyperlink{poisson_8hpp_aa56fe360bb0ae38e0082f49e394ff825}{taskflow}}).wait();}

\end{DoxyCode}


Debrief\+:

\begin{DoxyItemize}
\item Line 8 defines the number of lines in the pipeline \item Lines 9-\/52 define the first serial pipe, which will stop the pipeline scheduling at the 11th token \item Lines 15-\/30 define the token dependencies for token 5 \item Lines 37-\/48 define the token dependencies for token 2 \item Lines 55-\/57 define the second serial pipe \item Lines 59-\/61 define the third serial pipe \item Line 64 defines the pipeline taskflow graph using composition \item Line 67 executes the taskflow\end{DoxyItemize}
The following is one of the possible outcomes of the example.


\begin{DoxyCode}{0}
\DoxyCodeLine{stage\ 1:\ Non-\/deferred\ token\ 0}
\DoxyCodeLine{stage\ 2:\ input\ token\ 0\ (deferrals=0)}
\DoxyCodeLine{stage\ 3:\ input\ token\ 0}
\DoxyCodeLine{stage\ 1:\ Non-\/deferred\ token\ 1}
\DoxyCodeLine{stage\ 2:\ input\ token\ 1\ (deferrals=0)}
\DoxyCodeLine{stage\ 3:\ input\ token\ 1}
\DoxyCodeLine{1st-\/time:\ Token\ 2\ is\ deferred\ by\ 8}
\DoxyCodeLine{stage\ 1:\ Non-\/deferred\ token\ 3}
\DoxyCodeLine{stage\ 2:\ input\ token\ 3\ (deferrals=0)}
\DoxyCodeLine{stage\ 3:\ input\ token\ 3}
\DoxyCodeLine{stage\ 1:\ Non-\/deferred\ token\ 4}
\DoxyCodeLine{stage\ 2:\ input\ token\ 4\ (deferrals=0)}
\DoxyCodeLine{stage\ 3:\ input\ token\ 4}
\DoxyCodeLine{1st-\/time:\ Token\ 5\ is\ deferred\ by\ 2}
\DoxyCodeLine{1st-\/time:\ Token\ 5\ is\ deferred\ by\ 7}
\DoxyCodeLine{stage\ 1:\ Non-\/deferred\ token\ 6}
\DoxyCodeLine{stage\ 2:\ input\ token\ 6\ (deferrals=0)}
\DoxyCodeLine{stage\ 1:\ Non-\/deferred\ token\ 7}
\DoxyCodeLine{stage\ 2:\ input\ token\ 7\ (deferrals=0)}
\DoxyCodeLine{stage\ 1:\ Non-\/deferred\ token\ 8}
\DoxyCodeLine{stage\ 3:\ input\ token\ 6}
\DoxyCodeLine{stage\ 3:\ input\ token\ 7}
\DoxyCodeLine{stage\ 2:\ input\ token\ 8\ (deferrals=0)}
\DoxyCodeLine{stage\ 3:\ input\ token\ 8}
\DoxyCodeLine{2nd-\/time:\ Token\ 8\ resolved\ dependencies\ for\ token\ 2}
\DoxyCodeLine{stage\ 2:\ input\ token\ 2\ (deferrals=1)}
\DoxyCodeLine{stage\ 3:\ input\ token\ 2}
\DoxyCodeLine{2nd-\/time:\ Token\ 5\ is\ deferred\ by\ 9}
\DoxyCodeLine{stage\ 1:\ Non-\/deferred\ token\ 9}
\DoxyCodeLine{stage\ 2:\ input\ token\ 9\ (deferrals=0)}
\DoxyCodeLine{stage\ 3:\ input\ token\ 9}
\DoxyCodeLine{3rd-\/time:\ Tokens\ 2,\ 7\ and\ 9\ resolved\ dependencies\ for\ token\ 5}
\DoxyCodeLine{stage\ 2:\ input\ token\ 5\ (deferrals=2)}
\DoxyCodeLine{stage\ 3:\ input\ token\ 5}
\DoxyCodeLine{stage\ 1:\ Non-\/deferred\ token\ 10}
\DoxyCodeLine{stage\ 2:\ input\ token\ 10\ (deferrals=0)}
\DoxyCodeLine{stage\ 3:\ input\ token\ 10}

\end{DoxyCode}


\begin{DoxyAttention}{注意}
You can only specify the token dependencies at the first pipe to get the serial execution of tokens.
\end{DoxyAttention}
\hypertarget{_task_parallel_pipeline_with_token_dependencies_CreateADeferredScalablePipelineModuleTask}{}\doxysubsection{\texorpdfstring{Create a Deferred Scalable Pipeline Module Task}{Create a Deferred Scalable Pipeline Module Task}}\label{_task_parallel_pipeline_with_token_dependencies_CreateADeferredScalablePipelineModuleTask}
In addition to task-\/parallel pipeline (\doxylink{classtf_1_1_pipeline}{tf\+::\+Pipeline}), you can specify token dependencies on top of a task-\/parallel scalable pipeline (\doxylink{classtf_1_1_scalable_pipeline}{tf\+::\+Scalable\+Pipeline}). We recommend reading \doxylink{TaskParallelScalablePipeline}{Task-\/parallel Scalable Pipeline} first before learning this interface.

To create a deferred scalable pipeline application, there are four steps, which are identical to the steps described in \doxysectlink{_task_parallel_pipeline_with_token_dependencies_CreateADeferredPipelineModuleTask}{Create a Deferred Pipeline Module Task}{1}. They are\+:


\begin{DoxyEnumerate}
\item Define the pipeline structure (e.\+g., pipe type, pipe callable, stopping rule, line count)
\item Define the token dependencies {\bfseries{at the first pipe}}
\item Define the data storage and layout, if needed for the application
\item Define the pipeline taskflow graph using composition
\end{DoxyEnumerate}

The following code creates a deferred scalable pipeline that uses four parallel lines to schedule tokens through two serial pipes in the given vector, then resetting that pipeline to three serial pipes. The three pipe callables are identical to the pipe callables demonstrated in the code snippet in \doxysectlink{_task_parallel_pipeline_with_token_dependencies_CreateADeferredPipelineModuleTask}{Create a Deferred Pipeline Module Task}{1}. The token dependencies are exemplified in \doxysectlink{_task_parallel_pipeline_with_token_dependencies_DeferredPipelineTokenDependencies}{Understand Token Dependencies}{1}.


\begin{DoxyCode}{0}
\DoxyCodeLine{\ 1:\ \textcolor{comment}{//\ create\ a\ vector\ of\ three\ pipes}}
\DoxyCodeLine{\ 2:\ std::vector<\ \mbox{\hyperlink{classtf_1_1_pipe}{tf::Pipe}}<std::function<\mbox{\hyperlink{ittnotify__static_8h_a61af67d9d838a9497ca5b188dabc1aa0}{void}}(\mbox{\hyperlink{classtf_1_1_pipeflow}{tf::Pipeflow}}\&)>>\ >\ pipes;}
\DoxyCodeLine{\ 3:\ }
\DoxyCodeLine{\ 4:\ \textcolor{comment}{//\ define\ pipe\ callables}}
\DoxyCodeLine{\ 5:\ \textcolor{comment}{//\ first\_pipe\_callable\ is\ same\ as\ lines\ 15-\/53\ in\ the\ above\ code\ snippet\ }}
\DoxyCodeLine{\ 6:\ \textcolor{keyword}{auto}\ first\_pipe\_callable\ =\ [](\mbox{\hyperlink{classtf_1_1_pipeflow}{tf::Pipeflow}}\&\ pf)\ \{}
\DoxyCodeLine{\ 7:\ \ \ \textcolor{comment}{//\ stop\ at\ 11\ scheduling\ tokens}}
\DoxyCodeLine{\ 8:\ \ \ \textcolor{keywordflow}{if}(pf.token()\ ==\ 11)\ \{}
\DoxyCodeLine{\ 9:\ \ \ \ \ pf.stop();}
\DoxyCodeLine{10:\ \ \ \}}
\DoxyCodeLine{11:\ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{12:\ \ \ \ \ \textcolor{comment}{//\ Token\ 5\ is\ deferred}}
\DoxyCodeLine{13:\ \ \ \ \ \textcolor{keywordflow}{if}\ (pf.token()\ ==\ 5)\ \{}
\DoxyCodeLine{14:\ \ \ \ \ \ \ \textcolor{keywordflow}{switch}(pf.num\_deferrals())\ \{}
\DoxyCodeLine{15:\ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ 0:}
\DoxyCodeLine{16:\ \ \ \ \ \ \ \ \ \ pf.defer(2);}
\DoxyCodeLine{17:\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}1st-\/time:\ Token\ \%zu\ is\ deferred\ by\ 2\(\backslash\)n"{}},\ pf.token());}
\DoxyCodeLine{18:\ \ \ \ \ \ \ \ \ \ pf.defer(7);}
\DoxyCodeLine{19:\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}1st-\/time:\ Token\ \%zu\ is\ deferred\ by\ 7\(\backslash\)n"{}},\ pf.token());}
\DoxyCodeLine{20:\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};\ \ }
\DoxyCodeLine{21:\ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{22:}
\DoxyCodeLine{23:\ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ 1:}
\DoxyCodeLine{24:\ \ \ \ \ \ \ \ \ \ pf.defer(9);}
\DoxyCodeLine{25:\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}2nd-\/time:\ Token\ \%zu\ is\ deferred\ by\ 9\(\backslash\)n"{}},\ pf.token());}
\DoxyCodeLine{26:\ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{27:\ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{28:}
\DoxyCodeLine{29:\ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ 2:}
\DoxyCodeLine{30:\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}3rd-\/time:\ Tokens\ 2,\ 7\ and\ 9\ resolved\ dependencies\ for\ token\ \%zu\(\backslash\)n"{}},}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pf.token());}
\DoxyCodeLine{31:\ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{32:\ \ \ \ \ \ \}}
\DoxyCodeLine{33:\ \ \ \ \}}
\DoxyCodeLine{34:\ \ \ \ \textcolor{comment}{//\ token\ 2\ is\ deferred}}
\DoxyCodeLine{35:\ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (pf.token()\ ==\ 2)\ \{}
\DoxyCodeLine{36:\ \ \ \ \ \ \textcolor{keywordflow}{switch}(pf.num\_deferrals())\ \{}
\DoxyCodeLine{37:\ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ 0:}
\DoxyCodeLine{38:\ \ \ \ \ \ \ \ \ \ pf.defer(8);}
\DoxyCodeLine{39:\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}1st-\/time:\ Token\ \%zu\ is\ deferred\ by\ 8\(\backslash\)n"{}},\ pf.token());}
\DoxyCodeLine{40:\ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{41:\ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ 1:}
\DoxyCodeLine{42:\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}2nd-\/time:\ Token\ 8\ resolved\ dependencies\ for\ token\ \%zu\(\backslash\)n"{}},}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pf.token());}
\DoxyCodeLine{43:\ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{44:\ \ \ \ \ \ \}}
\DoxyCodeLine{45:\ \ \ \ \}}
\DoxyCodeLine{46:\ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{47:\ \ \ \ \ \ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}stage\ 1:\ Non-\/deferred\ token\ \%zu\(\backslash\)n"{}},\ pf.token());}
\DoxyCodeLine{48:\ \ \ \ \}}
\DoxyCodeLine{49:\ \};}
\DoxyCodeLine{50:}
\DoxyCodeLine{51:\ \textcolor{comment}{//\ second\_pipe\_callable\ is\ same\ as\ lines\ 55-\/57\ in\ the\ above\ code\ snippet}}
\DoxyCodeLine{52:\ \textcolor{keyword}{auto}\ second\_pipe\_callable\ =\ [](tf::Pipeflow\&\ pf)\{}
\DoxyCodeLine{53:\ \ \ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}stage\ 2:\ input\ token\ \%zu\ (deferrals=\%zu)\(\backslash\)n"{}},}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ pf.token(),\ pf.num\_deferrals());}
\DoxyCodeLine{54:\ \};}
\DoxyCodeLine{55:}
\DoxyCodeLine{56:\ \textcolor{comment}{//\ third\_pipe\_callable\ is\ same\ as\ lines\ 59-\/61\ in\ the\ above\ code\ snippet}}
\DoxyCodeLine{57:\ \textcolor{keyword}{auto}\ third\_pipe\_callable\ =\ [](tf::Pipeflow\&\ pf)\{}
\DoxyCodeLine{58:\ \ \ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}stage\ 3:\ input\ token\ \%zu\(\backslash\)n"{}},\ pf.token());}
\DoxyCodeLine{59:\ \};}
\DoxyCodeLine{60:}
\DoxyCodeLine{61:\ pipes.emplace\_back(\mbox{\hyperlink{namespacetf_abb7a11e41fd457f69e7ff45d4c769564a7b804a28d6154ab8007287532037f1d0}{tf::PipeType::SERIAL}},\ first\_pipe\_callable);}
\DoxyCodeLine{62:\ pipes.emplace\_back(\mbox{\hyperlink{namespacetf_abb7a11e41fd457f69e7ff45d4c769564a7b804a28d6154ab8007287532037f1d0}{tf::PipeType::SERIAL}},\ second\_pipe\_callable);\ }
\DoxyCodeLine{63:}
\DoxyCodeLine{64:\ \textcolor{comment}{//\ create\ a\ pipeline\ of\ four\ parallel\ lines\ based\ on\ the\ given\ vector\ of\ pipes}}
\DoxyCodeLine{65:\ tf::ScalablePipeline\ pl(4,\ pipes.begin(),\ pipes.end());}
\DoxyCodeLine{66:}
\DoxyCodeLine{67:\ tf::Task\ \mbox{\hyperlink{test__partitioner__whitebox_8h_a5c4cf3d37a4eee22275de22cb9619863}{task}}\ =\ \mbox{\hyperlink{poisson_8hpp_aa56fe360bb0ae38e0082f49e394ff825}{taskflow}}.composed\_of(pl);}
\DoxyCodeLine{68:\ }
\DoxyCodeLine{69:\ \textcolor{comment}{//\ run\ the\ pipeline}}
\DoxyCodeLine{70:\ \mbox{\hyperlink{thread__pool_8cpp_a543e564a8407bbeac15cb2d929fec755}{executor}}.\mbox{\hyperlink{classtf_1_1_executor_a519777f5783981d534e9e53b99712069}{run}}(\mbox{\hyperlink{poisson_8hpp_aa56fe360bb0ae38e0082f49e394ff825}{taskflow}}).wait();}
\DoxyCodeLine{71:}
\DoxyCodeLine{72:\ \textcolor{comment}{//\ reset\ the\ pipeline\ to\ a\ new\ range\ of\ three\ pipes\ and\ starts\ from}}
\DoxyCodeLine{73:\ \textcolor{comment}{//\ the\ initial\ state\ (i.e.,\ token\ counts\ from\ zero)}}
\DoxyCodeLine{74:\ pipes.emplace\_back(\mbox{\hyperlink{namespacetf_abb7a11e41fd457f69e7ff45d4c769564a7b804a28d6154ab8007287532037f1d0}{tf::PipeType::SERIAL}},\ third\_pipe\_callable);}
\DoxyCodeLine{75:\ pl.reset(pipes.begin(),\ pipes.end());}
\DoxyCodeLine{76:}
\DoxyCodeLine{77:\ \mbox{\hyperlink{thread__pool_8cpp_a543e564a8407bbeac15cb2d929fec755}{executor}}.\mbox{\hyperlink{classtf_1_1_executor_a519777f5783981d534e9e53b99712069}{run}}(\mbox{\hyperlink{poisson_8hpp_aa56fe360bb0ae38e0082f49e394ff825}{taskflow}}).wait();}

\end{DoxyCode}


Debrief\+:

\begin{DoxyItemize}
\item Lines 2 defines the vector of \doxylink{classtf_1_1_pipe}{tf\+::\+Pipe} type \item Lines 6-\/49 define the first pipe callable \item Lines 52-\/54 define the second pipe callable \item Lines 57-\/59 define the third pipe callable \item Lines 61-\/62 define the vector of two pipe callables \item Line 65 defines the scalable pipeline \item Line 67 defines the pipeline taskflow graph using composition \item Line 70 executes the taskflow for the first run \item Line 74 inserts the third pipe callable in the vector \item Line 75 resets the pipes to three pipe callables \item Line 77 executes the taskflow for the second run\end{DoxyItemize}
\hypertarget{_task_parallel_pipeline_with_token_dependencies_ParalleliDeferredScalablePipelineLearnMore}{}\doxysubsection{\texorpdfstring{Learn More about Taskflow Pipeline}{Learn More about Taskflow Pipeline}}\label{_task_parallel_pipeline_with_token_dependencies_ParalleliDeferredScalablePipelineLearnMore}
Visit the following pages to learn more about pipeline\+:


\begin{DoxyItemize}
\item \doxylink{TaskParallelPipeline}{Task-\/parallel Pipeline}
\item \doxylink{DataParallelPipeline}{Data-\/parallel Pipeline}
\item \doxylink{TaskParallelScalablePipeline}{Task-\/parallel Scalable Pipeline}
\item \doxylink{TextProcessingPipeline}{Text Processing Pipeline}
\item \doxylink{GraphProcessingPipeline}{Graph Processing Pipeline}
\item \doxylink{TaskflowProcessingPipeline}{Taskflow Processing Pipeline} 
\end{DoxyItemize}