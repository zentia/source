\doxysection{Taskflow Processing Pipeline}
\hypertarget{_taskflow_processing_pipeline}{}\label{_taskflow_processing_pipeline}\index{Taskflow Processing Pipeline@{Taskflow Processing Pipeline}}
We study a taskflow processing pipeline that propagates a sequence of tokens through linearly dependent taskflows. The pipeline embeds a taskflow in each pipe to run a parallel algorithm using task graph parallelism.\hypertarget{_taskflow_processing_pipeline_FormulateTheTaskflowProcessingPipelineProblem}{}\doxysubsection{\texorpdfstring{Formulate the Taskflow Processing Pipeline Problem}{Formulate the Taskflow Processing Pipeline Problem}}\label{_taskflow_processing_pipeline_FormulateTheTaskflowProcessingPipelineProblem}
Many complex and irregular pipeline applications require each pipe to run a parallel algorithm using task graph parallelism. We can formulate such applications as scheduling a sequence of tokens through linearly dependent taskflows. The following example illustrates the pipeline propagation of three scheduling tokens through three linearly dependent taskflows\+:

Each pipe (stage) in the pipeline embeds a taskflow to perform a stage-\/specific parallel algorithm on an input scheduling token. Parallelism exhibits both inside and outside the three taskflows, combining both {\itshape task graph parallelism} and {\itshape pipeline parallelism}.\hypertarget{_taskflow_processing_pipeline_CreateATaskflowProcessingPipeline}{}\doxysubsection{\texorpdfstring{Create a Taskflow Processing Pipeline}{Create a Taskflow Processing Pipeline}}\label{_taskflow_processing_pipeline_CreateATaskflowProcessingPipeline}
Using the example from the previous section, we create a pipeline of three {\itshape serial} pipes each running a taskflow on a sequence of five scheduling tokens. The overall implementation is shown below\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{preprocessor}{\#include\ <\mbox{\hyperlink{taskflow_8hpp}{taskflow/taskflow.hpp}}>}}
\DoxyCodeLine{\textcolor{preprocessor}{\#include\ <\mbox{\hyperlink{taskflow_2algorithm_2pipeline_8hpp}{taskflow/algorithm/pipeline.hpp}}>}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{//\ taskflow\ on\ the\ first\ pipe}}
\DoxyCodeLine{\textcolor{keywordtype}{void}\ \mbox{\hyperlink{taskflow__pipeline_8cpp_acc42e60ee4292dfe27643e571a378964}{make\_taskflow1}}(\mbox{\hyperlink{classtf_1_1_taskflow}{tf::Taskflow}}\&\ \mbox{\hyperlink{namespacetf}{tf}})\ \{}
\DoxyCodeLine{\ \ \textcolor{keyword}{auto}\ [A1,\ B1,\ C1,\ D1]\ =\ \mbox{\hyperlink{namespacetf}{tf}}.emplace(}
\DoxyCodeLine{\ \ \ \ []()\{\ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}A1\(\backslash\)n"{}});\ \},}
\DoxyCodeLine{\ \ \ \ []()\{\ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}B1\(\backslash\)n"{}});\ \},}
\DoxyCodeLine{\ \ \ \ []()\{\ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}C1\(\backslash\)n"{}});\ \},}
\DoxyCodeLine{\ \ \ \ []()\{\ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}D1\(\backslash\)n"{}});\ \}}
\DoxyCodeLine{\ \ );}
\DoxyCodeLine{\ \ \mbox{\hyperlink{namespace_p_ad8e5e0856b9136906a0cfc4a369e77ee}{A1}}.precede(B1,\ C1);}
\DoxyCodeLine{\ \ D1.succeed(B1,\ C1);}
\DoxyCodeLine{\}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{//\ taskflow\ on\ the\ second\ pipe}}
\DoxyCodeLine{\textcolor{keywordtype}{void}\ \mbox{\hyperlink{taskflow__pipeline_8cpp_ae0a95f9d5b331c2026cf29a07c5c562e}{make\_taskflow2}}(tf::Taskflow\&\ tf)\ \{}
\DoxyCodeLine{\ \ \textcolor{keyword}{auto}\ [\mbox{\hyperlink{namespace_p_ab8f5d26d05b6c97704c7ab42904df9ea}{A2}},\ \mbox{\hyperlink{namespace_p_a58c370cdedae1bcbf19bcdc9d7a8d583}{B2}},\ C2,\ D2]\ =\ tf.\mbox{\hyperlink{classtf_1_1_flow_builder_a60d7a666cab71ecfa3010b2efb0d6b57}{emplace}}(}
\DoxyCodeLine{\ \ \ \ []()\{\ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}A2\(\backslash\)n"{}});\ \},}
\DoxyCodeLine{\ \ \ \ []()\{\ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}B2\(\backslash\)n"{}});\ \},}
\DoxyCodeLine{\ \ \ \ []()\{\ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}C2\(\backslash\)n"{}});\ \},}
\DoxyCodeLine{\ \ \ \ []()\{\ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}D2\(\backslash\)n"{}});\ \}}
\DoxyCodeLine{\ \ );}
\DoxyCodeLine{\ \ tf.\mbox{\hyperlink{classtf_1_1_flow_builder_a90f3d9b9d6fcf4df8e7d7878dfdd130d}{linearize}}(\{\mbox{\hyperlink{namespace_p_ab8f5d26d05b6c97704c7ab42904df9ea}{A2}},\ \mbox{\hyperlink{namespace_p_a58c370cdedae1bcbf19bcdc9d7a8d583}{B2}},\ C2,\ D2\});}
\DoxyCodeLine{\}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{//\ taskflow\ on\ the\ third\ pipe}}
\DoxyCodeLine{\textcolor{keywordtype}{void}\ \mbox{\hyperlink{taskflow__pipeline_8cpp_a8df847fb2107b06353a3935f8ca7de18}{make\_taskflow3}}(tf::Taskflow\&\ tf)\ \{}
\DoxyCodeLine{\ \ \textcolor{keyword}{auto}\ [\mbox{\hyperlink{namespace_p_a67db0dcc1bea3fa12403c36474c54f69}{A3}},\ \mbox{\hyperlink{namespace_p_ab399e249b5a6d9c560c81efee6ab527a}{B3}},\ C3,\ D3]\ =\ tf.\mbox{\hyperlink{classtf_1_1_flow_builder_a60d7a666cab71ecfa3010b2efb0d6b57}{emplace}}(}
\DoxyCodeLine{\ \ \ \ []()\{\ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}A3\(\backslash\)n"{}});\ \},}
\DoxyCodeLine{\ \ \ \ []()\{\ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}B3\(\backslash\)n"{}});\ \},}
\DoxyCodeLine{\ \ \ \ []()\{\ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}C3\(\backslash\)n"{}});\ \},}
\DoxyCodeLine{\ \ \ \ []()\{\ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}D3\(\backslash\)n"{}});\ \}}
\DoxyCodeLine{\ \ );}
\DoxyCodeLine{\ \ \mbox{\hyperlink{namespace_p_a67db0dcc1bea3fa12403c36474c54f69}{A3}}.precede(B3,\ C3,\ D3);}
\DoxyCodeLine{\}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{keywordtype}{int}\ \mbox{\hyperlink{main-override-static_8c_ae66f6b31b5ad750f1fe042a706a4e3d4}{main}}()\ \{}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ tf::Taskflow\ \mbox{\hyperlink{poisson_8hpp_aa56fe360bb0ae38e0082f49e394ff825}{taskflow}}(\textcolor{stringliteral}{"{}taskflow\ processing\ pipeline"{}});}
\DoxyCodeLine{\ \ tf::Executor\ \mbox{\hyperlink{thread__pool_8cpp_a543e564a8407bbeac15cb2d929fec755}{executor}};}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ num\_lines\ =\ 2;}
\DoxyCodeLine{\ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ num\_pipes\ =\ 3;}
\DoxyCodeLine{\ \ }
\DoxyCodeLine{\ \ \textcolor{comment}{//\ define\ the\ taskflow\ storage}}
\DoxyCodeLine{\ \ \textcolor{comment}{//\ we\ use\ the\ pipe\ dimension\ because\ we\ create\ three\ 'serial'\ pipes}}
\DoxyCodeLine{\ \ std::array<tf::Taskflow,\ num\_pipes>\ taskflows;}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \textcolor{comment}{//\ create\ three\ different\ taskflows\ for\ the\ three\ pipes}}
\DoxyCodeLine{\ \ \mbox{\hyperlink{taskflow__pipeline_8cpp_acc42e60ee4292dfe27643e571a378964}{make\_taskflow1}}(taskflows[0]);}
\DoxyCodeLine{\ \ \mbox{\hyperlink{taskflow__pipeline_8cpp_ae0a95f9d5b331c2026cf29a07c5c562e}{make\_taskflow2}}(taskflows[1]);}
\DoxyCodeLine{\ \ \mbox{\hyperlink{taskflow__pipeline_8cpp_a8df847fb2107b06353a3935f8ca7de18}{make\_taskflow3}}(taskflows[2]);}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \textcolor{comment}{//\ the\ pipeline\ consists\ of\ three\ serial\ pipes}}
\DoxyCodeLine{\ \ \textcolor{comment}{//\ and\ up\ to\ two\ concurrent\ scheduling\ tokens}}
\DoxyCodeLine{\ \ tf::Pipeline\ pl(num\_lines,}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{//\ first\ pipe\ runs\ taskflow1}}
\DoxyCodeLine{\ \ \ \ tf::Pipe\{\mbox{\hyperlink{namespacetf_abb7a11e41fd457f69e7ff45d4c769564a7b804a28d6154ab8007287532037f1d0}{tf::PipeType::SERIAL}},\ [\&](tf::Pipeflow\&\ pf)\ \{}
\DoxyCodeLine{\ \ \ \ \ \ \textcolor{keywordflow}{if}(pf.token()\ ==\ 5)\ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ pf.stop();}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{\ \ \ \ \ \ \}}
\DoxyCodeLine{\ \ \ \ \ \ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}begin\ token\ \%zu\(\backslash\)n"{}},\ pf.token());}
\DoxyCodeLine{\ \ \ \ \ \ \mbox{\hyperlink{thread__pool_8cpp_a543e564a8407bbeac15cb2d929fec755}{executor}}.\mbox{\hyperlink{classtf_1_1_executor_a8fcd9e0557922bb8194999f0cd433ea8}{corun}}(taskflows[pf.pipe()]);}
\DoxyCodeLine{\ \ \ \ \}\},}
\DoxyCodeLine{\ \ \ \ }
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{//\ second\ pipe\ runs\ taskflow2}}
\DoxyCodeLine{\ \ \ \ tf::Pipe\{\mbox{\hyperlink{namespacetf_abb7a11e41fd457f69e7ff45d4c769564a7b804a28d6154ab8007287532037f1d0}{tf::PipeType::SERIAL}},\ [\&](tf::Pipeflow\&\ pf)\ \{}
\DoxyCodeLine{\ \ \ \ \ \ \mbox{\hyperlink{thread__pool_8cpp_a543e564a8407bbeac15cb2d929fec755}{executor}}.\mbox{\hyperlink{classtf_1_1_executor_a8fcd9e0557922bb8194999f0cd433ea8}{corun}}(taskflows[pf.pipe()]);}
\DoxyCodeLine{\ \ \ \ \}\},}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{//\ third\ pipe\ calls\ taskflow3}}
\DoxyCodeLine{\ \ \ \ tf::Pipe\{\mbox{\hyperlink{namespacetf_abb7a11e41fd457f69e7ff45d4c769564a7b804a28d6154ab8007287532037f1d0}{tf::PipeType::SERIAL}},\ [\&](tf::Pipeflow\&\ pf)\ \{}
\DoxyCodeLine{\ \ \ \ \ \ \mbox{\hyperlink{thread__pool_8cpp_a543e564a8407bbeac15cb2d929fec755}{executor}}.\mbox{\hyperlink{classtf_1_1_executor_a8fcd9e0557922bb8194999f0cd433ea8}{corun}}(taskflows[pf.pipe()]);}
\DoxyCodeLine{\ \ \ \ \}\}}
\DoxyCodeLine{\ \ );}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \textcolor{comment}{//\ build\ the\ pipeline\ graph\ using\ composition}}
\DoxyCodeLine{\ \ tf::Task\ \mbox{\hyperlink{boing_8c_a2858154e2009b0e6e616f313177762bc}{init}}\ =\ \mbox{\hyperlink{poisson_8hpp_aa56fe360bb0ae38e0082f49e394ff825}{taskflow}}.emplace([]()\{\ std::cout\ <<\ \textcolor{stringliteral}{"{}ready\(\backslash\)n"{}};\ \})}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ .\mbox{\hyperlink{imgui__impl__opengl3__loader_8h_aab18cfce5ee7c6881ae04f18be70d94a}{name}}(\textcolor{stringliteral}{"{}starting\ pipeline"{}});}
\DoxyCodeLine{\ \ tf::Task\ \mbox{\hyperlink{test__partitioner__whitebox_8h_a5c4cf3d37a4eee22275de22cb9619863}{task}}\ =\ \mbox{\hyperlink{poisson_8hpp_aa56fe360bb0ae38e0082f49e394ff825}{taskflow}}.composed\_of(pl)}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ .name(\textcolor{stringliteral}{"{}pipeline"{}});}
\DoxyCodeLine{\ \ tf::Task\ stop\ =\ \mbox{\hyperlink{poisson_8hpp_aa56fe360bb0ae38e0082f49e394ff825}{taskflow}}.emplace([]()\{\ std::cout\ <<\ \textcolor{stringliteral}{"{}stopped\(\backslash\)n"{}};\ \})}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ .\mbox{\hyperlink{imgui__impl__opengl3__loader_8h_aab18cfce5ee7c6881ae04f18be70d94a}{name}}(\textcolor{stringliteral}{"{}pipeline\ stopped"{}});}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \textcolor{comment}{//\ create\ task\ dependency}}
\DoxyCodeLine{\ \ \mbox{\hyperlink{boing_8c_a2858154e2009b0e6e616f313177762bc}{init}}.precede(\mbox{\hyperlink{test__partitioner__whitebox_8h_a5c4cf3d37a4eee22275de22cb9619863}{task}});}
\DoxyCodeLine{\ \ \mbox{\hyperlink{test__partitioner__whitebox_8h_a5c4cf3d37a4eee22275de22cb9619863}{task}}.precede(stop);}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \textcolor{comment}{//\ dump\ the\ pipeline\ graph\ structure\ (with\ composition)}}
\DoxyCodeLine{\ \ \mbox{\hyperlink{poisson_8hpp_aa56fe360bb0ae38e0082f49e394ff825}{taskflow}}.dump(std::cout);}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \textcolor{comment}{//\ run\ the\ pipeline}}
\DoxyCodeLine{\ \ \mbox{\hyperlink{thread__pool_8cpp_a543e564a8407bbeac15cb2d929fec755}{executor}}.\mbox{\hyperlink{classtf_1_1_executor_a519777f5783981d534e9e53b99712069}{run}}(\mbox{\hyperlink{poisson_8hpp_aa56fe360bb0ae38e0082f49e394ff825}{taskflow}}).wait();}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{\}}

\end{DoxyCode}
\hypertarget{_taskflow_processing_pipeline_TaskflowPipelineDefineTaskflows}{}\doxysubsubsection{\texorpdfstring{Define Taskflows}{Define Taskflows}}\label{_taskflow_processing_pipeline_TaskflowPipelineDefineTaskflows}
First, we define three taskflows for the three pipes in the pipeline\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{comment}{//\ taskflow\ on\ the\ first\ pipe}}
\DoxyCodeLine{\textcolor{keywordtype}{void}\ \mbox{\hyperlink{taskflow__pipeline_8cpp_acc42e60ee4292dfe27643e571a378964}{make\_taskflow1}}(\mbox{\hyperlink{classtf_1_1_taskflow}{tf::Taskflow}}\&\ \mbox{\hyperlink{namespacetf}{tf}})\ \{}
\DoxyCodeLine{\ \ \textcolor{keyword}{auto}\ [A1,\ B1,\ C1,\ D1]\ =\ \mbox{\hyperlink{namespacetf}{tf}}.emplace(}
\DoxyCodeLine{\ \ \ \ []()\{\ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}A1\(\backslash\)n"{}});\ \},}
\DoxyCodeLine{\ \ \ \ []()\{\ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}B1\(\backslash\)n"{}});\ \},}
\DoxyCodeLine{\ \ \ \ []()\{\ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}C1\(\backslash\)n"{}});\ \},}
\DoxyCodeLine{\ \ \ \ []()\{\ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}D1\(\backslash\)n"{}});\ \}}
\DoxyCodeLine{\ \ );}
\DoxyCodeLine{\ \ \mbox{\hyperlink{namespace_p_ad8e5e0856b9136906a0cfc4a369e77ee}{A1}}.precede(B1,\ C1);}
\DoxyCodeLine{\ \ D1.succeed(B1,\ C1);}
\DoxyCodeLine{\}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{//\ taskflow\ on\ the\ second\ pipe}}
\DoxyCodeLine{\textcolor{keywordtype}{void}\ \mbox{\hyperlink{taskflow__pipeline_8cpp_ae0a95f9d5b331c2026cf29a07c5c562e}{make\_taskflow2}}(tf::Taskflow\&\ tf)\ \{}
\DoxyCodeLine{\ \ \textcolor{keyword}{auto}\ [\mbox{\hyperlink{namespace_p_ab8f5d26d05b6c97704c7ab42904df9ea}{A2}},\ \mbox{\hyperlink{namespace_p_a58c370cdedae1bcbf19bcdc9d7a8d583}{B2}},\ C2,\ D2]\ =\ tf.\mbox{\hyperlink{classtf_1_1_flow_builder_a60d7a666cab71ecfa3010b2efb0d6b57}{emplace}}(}
\DoxyCodeLine{\ \ \ \ []()\{\ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}A2\(\backslash\)n"{}});\ \},}
\DoxyCodeLine{\ \ \ \ []()\{\ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}B2\(\backslash\)n"{}});\ \},}
\DoxyCodeLine{\ \ \ \ []()\{\ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}C2\(\backslash\)n"{}});\ \},}
\DoxyCodeLine{\ \ \ \ []()\{\ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}D2\(\backslash\)n"{}});\ \}}
\DoxyCodeLine{\ \ );}
\DoxyCodeLine{\ \ tf.\mbox{\hyperlink{classtf_1_1_flow_builder_a90f3d9b9d6fcf4df8e7d7878dfdd130d}{linearize}}(\{\mbox{\hyperlink{namespace_p_ab8f5d26d05b6c97704c7ab42904df9ea}{A2}},\ \mbox{\hyperlink{namespace_p_a58c370cdedae1bcbf19bcdc9d7a8d583}{B2}},\ C2,\ D2\});}
\DoxyCodeLine{\}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{//\ taskflow\ on\ the\ third\ pipe}}
\DoxyCodeLine{\textcolor{keywordtype}{void}\ \mbox{\hyperlink{taskflow__pipeline_8cpp_a8df847fb2107b06353a3935f8ca7de18}{make\_taskflow3}}(tf::Taskflow\&\ tf)\ \{}
\DoxyCodeLine{\ \ \textcolor{keyword}{auto}\ [\mbox{\hyperlink{namespace_p_a67db0dcc1bea3fa12403c36474c54f69}{A3}},\ \mbox{\hyperlink{namespace_p_ab399e249b5a6d9c560c81efee6ab527a}{B3}},\ C3,\ D3]\ =\ tf.\mbox{\hyperlink{classtf_1_1_flow_builder_a60d7a666cab71ecfa3010b2efb0d6b57}{emplace}}(}
\DoxyCodeLine{\ \ \ \ []()\{\ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}A3\(\backslash\)n"{}});\ \},}
\DoxyCodeLine{\ \ \ \ []()\{\ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}B3\(\backslash\)n"{}});\ \},}
\DoxyCodeLine{\ \ \ \ []()\{\ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}C3\(\backslash\)n"{}});\ \},}
\DoxyCodeLine{\ \ \ \ []()\{\ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}D3\(\backslash\)n"{}});\ \}}
\DoxyCodeLine{\ \ );}
\DoxyCodeLine{\ \ \mbox{\hyperlink{namespace_p_a67db0dcc1bea3fa12403c36474c54f69}{A3}}.precede(B3,\ C3,\ D3);}
\DoxyCodeLine{\}}

\end{DoxyCode}


As each taskflow corresponds to a pipe in the pipeline, we create a linear array to store the three taskflows\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{std::array<tf::Taskflow,\ num\_pipes>\ taskflows;}
\DoxyCodeLine{\mbox{\hyperlink{taskflow__pipeline_8cpp_acc42e60ee4292dfe27643e571a378964}{make\_taskflow1}}(taskflows[0]);}
\DoxyCodeLine{\mbox{\hyperlink{taskflow__pipeline_8cpp_ae0a95f9d5b331c2026cf29a07c5c562e}{make\_taskflow2}}(taskflows[1]);}
\DoxyCodeLine{\mbox{\hyperlink{taskflow__pipeline_8cpp_a8df847fb2107b06353a3935f8ca7de18}{make\_taskflow3}}(taskflows[2]);}

\end{DoxyCode}


Since the three taskflows are linearly dependent, at most one taskflow will run at a pipe. We can store the three taskflows in a linear array of dimension equal to the number of pipes. If there is a parallel pipe, we need to use two-\/dimensional array, as multiple taskflows at a stage can run simultaneously across parallel lines.\hypertarget{_taskflow_processing_pipeline_TaskflowPipelineDefineThePipes}{}\doxysubsubsection{\texorpdfstring{Define the Pipes}{Define the Pipes}}\label{_taskflow_processing_pipeline_TaskflowPipelineDefineThePipes}
The pipe definition is straightforward. Each pipe runs the corresponding taskflow, which can be indexed at {\ttfamily taskflows} with the pipe\textquotesingle{}s identifier, \doxylink{classtf_1_1_pipeflow_a4914c1f381a3016e98285b019cf60d6d}{tf\+::\+Pipeflow\+::pipe()}. The first pipe will cease the pipeline scheduling when it has processed five scheduling tokens\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{comment}{//\ first\ pipe\ runs\ taskflow1}}
\DoxyCodeLine{\mbox{\hyperlink{classtf_1_1_pipe}{tf::Pipe}}\{\mbox{\hyperlink{namespacetf_abb7a11e41fd457f69e7ff45d4c769564a7b804a28d6154ab8007287532037f1d0}{tf::PipeType::SERIAL}},\ [\&](\mbox{\hyperlink{classtf_1_1_pipeflow}{tf::Pipeflow}}\&\ pf)\ \{}
\DoxyCodeLine{\ \ \textcolor{keywordflow}{if}(pf.token()\ ==\ 5)\ \{}
\DoxyCodeLine{\ \ \ \ pf.stop();}
\DoxyCodeLine{\ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{\ \ \}}
\DoxyCodeLine{\ \ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}begin\ token\ \%zu\(\backslash\)n"{}},\ pf.token());}
\DoxyCodeLine{\ \ \mbox{\hyperlink{thread__pool_8cpp_a543e564a8407bbeac15cb2d929fec755}{executor}}.corun(taskflows[pf.pipe()]);}
\DoxyCodeLine{\}\},}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{//\ second\ pipe\ runs\ taskflow2}}
\DoxyCodeLine{tf::Pipe\{\mbox{\hyperlink{namespacetf_abb7a11e41fd457f69e7ff45d4c769564a7b804a28d6154ab8007287532037f1d0}{tf::PipeType::SERIAL}},\ [\&](tf::Pipeflow\&\ pf)\ \{}
\DoxyCodeLine{\ \ \mbox{\hyperlink{thread__pool_8cpp_a543e564a8407bbeac15cb2d929fec755}{executor}}.\mbox{\hyperlink{classtf_1_1_executor_a8fcd9e0557922bb8194999f0cd433ea8}{corun}}(taskflows[pf.pipe()]);}
\DoxyCodeLine{\}\},}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{//\ third\ pipe\ calls\ taskflow3}}
\DoxyCodeLine{tf::Pipe\{\mbox{\hyperlink{namespacetf_abb7a11e41fd457f69e7ff45d4c769564a7b804a28d6154ab8007287532037f1d0}{tf::PipeType::SERIAL}},\ [\&](tf::Pipeflow\&\ pf)\ \{}
\DoxyCodeLine{\ \ \mbox{\hyperlink{thread__pool_8cpp_a543e564a8407bbeac15cb2d929fec755}{executor}}.\mbox{\hyperlink{classtf_1_1_executor_a8fcd9e0557922bb8194999f0cd433ea8}{corun}}(taskflows[pf.pipe()]);}
\DoxyCodeLine{\}\}}

\end{DoxyCode}


At each pipe, we use \doxylink{classtf_1_1_executor_a8fcd9e0557922bb8194999f0cd433ea8}{tf\+::\+Executor\+::corun} to execute the corresponding taskflow and wait until the execution completes. This is important because we want the caller thread, which is the worker that invokes the pipe callable, to not block (i.\+e., {\ttfamily executor.\+run(taskflows\mbox{[}pf.\+pipe()\mbox{]}).wait()}) but participate in the work-\/stealing loop of the scheduler to avoid deadlock.\hypertarget{_taskflow_processing_pipeline_TaskflowPipelineDefineTheTaskGraph}{}\doxysubsubsection{\texorpdfstring{Define the Task Graph}{Define the Task Graph}}\label{_taskflow_processing_pipeline_TaskflowPipelineDefineTheTaskGraph}
To build up the taskflow for the pipeline, we create a module task with the defined pipeline structure and connect it with two tasks that output helper messages before and after the pipeline\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{\mbox{\hyperlink{classtf_1_1_task}{tf::Task}}\ \mbox{\hyperlink{structinit}{init}}\ =\ \mbox{\hyperlink{poisson_8hpp_aa56fe360bb0ae38e0082f49e394ff825}{taskflow}}.emplace([]()\{\ std::cout\ <<\ \textcolor{stringliteral}{"{}ready\(\backslash\)n"{}};\ \})}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ .\mbox{\hyperlink{imgui__impl__opengl3__loader_8h_aab18cfce5ee7c6881ae04f18be70d94a}{name}}(\textcolor{stringliteral}{"{}starting\ pipeline"{}});}
\DoxyCodeLine{\mbox{\hyperlink{classtf_1_1_task}{tf::Task}}\ \mbox{\hyperlink{test__partitioner__whitebox_8h_a5c4cf3d37a4eee22275de22cb9619863}{task}}\ =\ \mbox{\hyperlink{poisson_8hpp_aa56fe360bb0ae38e0082f49e394ff825}{taskflow}}.composed\_of(pl)}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ .name(\textcolor{stringliteral}{"{}pipeline"{}});}
\DoxyCodeLine{\mbox{\hyperlink{classtf_1_1_task}{tf::Task}}\ stop\ =\ \mbox{\hyperlink{poisson_8hpp_aa56fe360bb0ae38e0082f49e394ff825}{taskflow}}.emplace([]()\{\ std::cout\ <<\ \textcolor{stringliteral}{"{}stopped\(\backslash\)n"{}};\ \})}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ .\mbox{\hyperlink{imgui__impl__opengl3__loader_8h_aab18cfce5ee7c6881ae04f18be70d94a}{name}}(\textcolor{stringliteral}{"{}pipeline\ stopped"{}});}
\DoxyCodeLine{\mbox{\hyperlink{boing_8c_a2858154e2009b0e6e616f313177762bc}{init}}.precede(\mbox{\hyperlink{test__partitioner__whitebox_8h_a5c4cf3d37a4eee22275de22cb9619863}{task}});}
\DoxyCodeLine{\mbox{\hyperlink{test__partitioner__whitebox_8h_a5c4cf3d37a4eee22275de22cb9619863}{task}}.precede(stop);}

\end{DoxyCode}
\hypertarget{_taskflow_processing_pipeline_TaskflowPipelineSubmitTheTaskGraph}{}\doxysubsubsection{\texorpdfstring{Submit the Task Graph}{Submit the Task Graph}}\label{_taskflow_processing_pipeline_TaskflowPipelineSubmitTheTaskGraph}
Finally, we submit the taskflow to the execution and run it once\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{\mbox{\hyperlink{thread__pool_8cpp_a543e564a8407bbeac15cb2d929fec755}{executor}}.run(\mbox{\hyperlink{poisson_8hpp_aa56fe360bb0ae38e0082f49e394ff825}{taskflow}}).wait();}

\end{DoxyCode}


One possible output is shown below\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{\{.shell-\/session\}\ }
\DoxyCodeLine{ready}
\DoxyCodeLine{\mbox{\hyperlink{ittnotify__static_8h_a50deeaccd8b2b4be185e1befc7860258}{begin}}\ token\ 0}
\DoxyCodeLine{A1}
\DoxyCodeLine{C1}
\DoxyCodeLine{B1}
\DoxyCodeLine{D1}
\DoxyCodeLine{\mbox{\hyperlink{ittnotify__static_8h_a50deeaccd8b2b4be185e1befc7860258}{begin}}\ token\ 1}
\DoxyCodeLine{A2}
\DoxyCodeLine{B2}
\DoxyCodeLine{A1}
\DoxyCodeLine{C1}
\DoxyCodeLine{B1}
\DoxyCodeLine{D1}
\DoxyCodeLine{C2}
\DoxyCodeLine{D2}
\DoxyCodeLine{A3}
\DoxyCodeLine{D3}
\DoxyCodeLine{C3}
\DoxyCodeLine{B3}
\DoxyCodeLine{\mbox{\hyperlink{ittnotify__static_8h_a50deeaccd8b2b4be185e1befc7860258}{begin}}\ token\ 2}
\DoxyCodeLine{A2}
\DoxyCodeLine{B2}
\DoxyCodeLine{C2}
\DoxyCodeLine{D2}
\DoxyCodeLine{A1}
\DoxyCodeLine{C1}
\DoxyCodeLine{B1}
\DoxyCodeLine{D1}
\DoxyCodeLine{A3}
\DoxyCodeLine{D3}
\DoxyCodeLine{C3}
\DoxyCodeLine{B3}
\DoxyCodeLine{A2}
\DoxyCodeLine{B2}
\DoxyCodeLine{C2}
\DoxyCodeLine{D2}
\DoxyCodeLine{\mbox{\hyperlink{ittnotify__static_8h_a50deeaccd8b2b4be185e1befc7860258}{begin}}\ token\ 3}
\DoxyCodeLine{A3}
\DoxyCodeLine{D3}
\DoxyCodeLine{C3}
\DoxyCodeLine{B3}
\DoxyCodeLine{A1}
\DoxyCodeLine{C1}
\DoxyCodeLine{B1}
\DoxyCodeLine{D1}
\DoxyCodeLine{\mbox{\hyperlink{ittnotify__static_8h_a50deeaccd8b2b4be185e1befc7860258}{begin}}\ token\ 4}
\DoxyCodeLine{A2}
\DoxyCodeLine{A1}
\DoxyCodeLine{C1}
\DoxyCodeLine{B1}
\DoxyCodeLine{D1}
\DoxyCodeLine{B2}
\DoxyCodeLine{C2}
\DoxyCodeLine{D2}
\DoxyCodeLine{A3}
\DoxyCodeLine{D3}
\DoxyCodeLine{C3}
\DoxyCodeLine{B3}
\DoxyCodeLine{A2}
\DoxyCodeLine{B2}
\DoxyCodeLine{C2}
\DoxyCodeLine{D2}
\DoxyCodeLine{A3}
\DoxyCodeLine{D3}
\DoxyCodeLine{C3}
\DoxyCodeLine{B3}
\DoxyCodeLine{stopped}

\end{DoxyCode}
 