\doxysection{ff\+\_\+batchbuffer.\+hpp}
\hypertarget{ff__batchbuffer_8hpp_source}{}\label{ff__batchbuffer_8hpp_source}\index{external/taskflow/3rd-\/party/ff/distributed/ff\_batchbuffer.hpp@{external/taskflow/3rd-\/party/ff/distributed/ff\_batchbuffer.hpp}}
\mbox{\hyperlink{ff__batchbuffer_8hpp}{浏览该文件的文档.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{preprocessor}{\#ifndef\ FF\_BATCHBUFFER\_H}}
\DoxyCodeLine{00002\ \textcolor{preprocessor}{\#define\ FF\_BATCHBUFFER\_H}}
\DoxyCodeLine{00003\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{ff__network_8hpp}{ff\_network.hpp}}"{}}}
\DoxyCodeLine{00004\ \textcolor{preprocessor}{\#include\ <sys/uio.h>}}
\DoxyCodeLine{00005\ \textcolor{keyword}{using\ namespace\ }\mbox{\hyperlink{namespaceff}{ff}};}
\DoxyCodeLine{00006\ }
\DoxyCodeLine{00007\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classff__batch_buffer_a8a24cfbbb3993abfd6ae3ab66d9fb9f2}{ff\_batchBuffer}}\ \{\ \ \ \ }
\DoxyCodeLine{00008\ \ \ \ \ std::function<\mbox{\hyperlink{sugar_8h_abb452686968e48b67397da5f97445f5b}{bool}}(\textcolor{keyword}{struct}\ iovec*,\ \textcolor{keywordtype}{int})>\ \mbox{\hyperlink{classff__batch_buffer_a10f8101e0bcaefec1bb1c93b55d6b81a}{callback}};}
\DoxyCodeLine{00009\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classff__batch_buffer_a1ddbb22b4c557be891641ececa0764a7}{batchSize}};}
\DoxyCodeLine{00010\ \ \ \ \ \textcolor{keyword}{struct\ }iovec\ \mbox{\hyperlink{classff__batch_buffer_a9f568a4694c4a8eae43df6b63f069a5f}{iov}}[UIO\_MAXIOV];}
\DoxyCodeLine{00011\ \ \ \ \ std::vector<std::pair<size\_t*,\ message\_t*>>\ \mbox{\hyperlink{classff__batch_buffer_a27fa6e8d07791acc5a806899694bff19}{toCleanup}};}
\DoxyCodeLine{00012\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00013\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classff__batch_buffer_a9be6b493454fae8da3f2259648778ba7}{size}}\ =\ 0;}
\DoxyCodeLine{00014\ \ \ \ \ \mbox{\hyperlink{ff__network_8hpp_a19a96edeeb9d37072c4ce9f862d19ba8}{ChannelType}}\ \mbox{\hyperlink{classff__batch_buffer_af84ae13dd26b3e2f0ef301020f1c84ab}{ct}};}
\DoxyCodeLine{00015\ \ \ \ \ \mbox{\hyperlink{classff__batch_buffer_a8a24cfbbb3993abfd6ae3ab66d9fb9f2}{ff\_batchBuffer}}()\ \{\}}
\DoxyCodeLine{00016\ \ \ \ \ \mbox{\hyperlink{classff__batch_buffer_a6035796c93f122b582793dfeb228ec8a}{ff\_batchBuffer}}(\textcolor{keywordtype}{int}\ \_size,\ \mbox{\hyperlink{ff__network_8hpp_a19a96edeeb9d37072c4ce9f862d19ba8}{ChannelType}}\ \mbox{\hyperlink{classff__batch_buffer_af84ae13dd26b3e2f0ef301020f1c84ab}{ct}},\ std::function<\textcolor{keywordtype}{bool}(\textcolor{keyword}{struct}\ iovec*,\ \textcolor{keywordtype}{int})>\ cbk)\ :\ \mbox{\hyperlink{classff__batch_buffer_a10f8101e0bcaefec1bb1c93b55d6b81a}{callback}}(cbk),\ \mbox{\hyperlink{classff__batch_buffer_a1ddbb22b4c557be891641ececa0764a7}{batchSize}}(\_size),\ \mbox{\hyperlink{classff__batch_buffer_af84ae13dd26b3e2f0ef301020f1c84ab}{ct}}(\mbox{\hyperlink{classff__batch_buffer_af84ae13dd26b3e2f0ef301020f1c84ab}{ct}})\ \{}
\DoxyCodeLine{00017\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\_size*4+1\ >\ UIO\_MAXIOV)\{}
\DoxyCodeLine{00018\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespaceff_a27d926d29b55e019eba5b70672301d82}{error}}(\textcolor{stringliteral}{"{}Size\ too\ big!\(\backslash\)n"{}});}
\DoxyCodeLine{00019\ \ \ \ \ \ \ \ \ \ \ \ \ abort();}
\DoxyCodeLine{00020\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00021\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classff__batch_buffer_a9f568a4694c4a8eae43df6b63f069a5f}{iov}}[0].iov\_base\ =\ \&(this-\/>size);}
\DoxyCodeLine{00022\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classff__batch_buffer_a9f568a4694c4a8eae43df6b63f069a5f}{iov}}[0].iov\_len\ =\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{sugar_8h_ae4f82344f573c70aa1066a2394bba345}{int}});}
\DoxyCodeLine{00023\ \ \ \ \ \}}
\DoxyCodeLine{00024\ }
\DoxyCodeLine{00025\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classff__batch_buffer_a3592adddab7affde1cbcfc91dcbb60b1}{push}}(\mbox{\hyperlink{structmessage__t}{message\_t}}*\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}})\{}
\DoxyCodeLine{00026\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}-\/>sender\ =\ htonl(\mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}-\/>sender);}
\DoxyCodeLine{00027\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}-\/>chid\ =\ htonl(\mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}-\/>chid);}
\DoxyCodeLine{00028\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}*\ sz\ =\ \textcolor{keyword}{new}\ size\_t(htobe64(\mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}-\/>data.getLen()));}
\DoxyCodeLine{00029\ }
\DoxyCodeLine{00030\ }
\DoxyCodeLine{00031\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ indexBase\ =\ \mbox{\hyperlink{classff__batch_buffer_a9be6b493454fae8da3f2259648778ba7}{size}}\ *\ 4;}
\DoxyCodeLine{00032\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classff__batch_buffer_a9f568a4694c4a8eae43df6b63f069a5f}{iov}}[indexBase+1].iov\_base\ =\ \&\mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}-\/>sender;}
\DoxyCodeLine{00033\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classff__batch_buffer_a9f568a4694c4a8eae43df6b63f069a5f}{iov}}[indexBase+1].iov\_len\ =\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{sugar_8h_ae4f82344f573c70aa1066a2394bba345}{int}});}
\DoxyCodeLine{00034\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classff__batch_buffer_a9f568a4694c4a8eae43df6b63f069a5f}{iov}}[indexBase+2].iov\_base\ =\ \&\mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}-\/>chid;}
\DoxyCodeLine{00035\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classff__batch_buffer_a9f568a4694c4a8eae43df6b63f069a5f}{iov}}[indexBase+2].iov\_len\ =\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{sugar_8h_ae4f82344f573c70aa1066a2394bba345}{int}});}
\DoxyCodeLine{00036\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classff__batch_buffer_a9f568a4694c4a8eae43df6b63f069a5f}{iov}}[indexBase+3].iov\_base\ =\ sz;}
\DoxyCodeLine{00037\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classff__batch_buffer_a9f568a4694c4a8eae43df6b63f069a5f}{iov}}[indexBase+3].iov\_len\ =\ \textcolor{keyword}{sizeof}(size\_t);}
\DoxyCodeLine{00038\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classff__batch_buffer_a9f568a4694c4a8eae43df6b63f069a5f}{iov}}[indexBase+4].iov\_base\ =\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}-\/>data.getPtr();}
\DoxyCodeLine{00039\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classff__batch_buffer_a9f568a4694c4a8eae43df6b63f069a5f}{iov}}[indexBase+4].iov\_len\ =\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}-\/>data.getLen();}
\DoxyCodeLine{00040\ \ \ \ \ }
\DoxyCodeLine{00041\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classff__batch_buffer_a27fa6e8d07791acc5a806899694bff19}{toCleanup}}.push\_back(std::make\_pair(sz,\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}));}
\DoxyCodeLine{00042\ }
\DoxyCodeLine{00043\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (++\mbox{\hyperlink{classff__batch_buffer_a9be6b493454fae8da3f2259648778ba7}{size}}\ ==\ \mbox{\hyperlink{classff__batch_buffer_a1ddbb22b4c557be891641ececa0764a7}{batchSize}})}
\DoxyCodeLine{00044\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ this-\/>\mbox{\hyperlink{classff__batch_buffer_a0f5472982ee8ad06af8649f24dac766a}{flush}}();}
\DoxyCodeLine{00045\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00046\ \ \ \ \ \}}
\DoxyCodeLine{00047\ }
\DoxyCodeLine{00048\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classff__batch_buffer_a7c136c900c4c1ec718608a20bf080ff7}{sendEOS}}()\{}
\DoxyCodeLine{00049\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{classff__batch_buffer_a3592adddab7affde1cbcfc91dcbb60b1}{push}}(\textcolor{keyword}{new}\ \mbox{\hyperlink{structmessage__t}{message\_t}}(0,0))<0)\ \{}
\DoxyCodeLine{00050\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespaceff_a27d926d29b55e019eba5b70672301d82}{error}}(\textcolor{stringliteral}{"{}pushing\ EOS"{}});}
\DoxyCodeLine{00051\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00052\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classff__batch_buffer_a0f5472982ee8ad06af8649f24dac766a}{flush}}();}
\DoxyCodeLine{00053\ \ \ \ \ \}}
\DoxyCodeLine{00054\ }
\DoxyCodeLine{00055\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classff__batch_buffer_a0f5472982ee8ad06af8649f24dac766a}{flush}}()\{}
\DoxyCodeLine{00056\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00057\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{classff__batch_buffer_a9be6b493454fae8da3f2259648778ba7}{size}}\ ==\ 0)\ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00058\ }
\DoxyCodeLine{00059\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ size\_\ =\ \mbox{\hyperlink{classff__batch_buffer_a9be6b493454fae8da3f2259648778ba7}{size}};}
\DoxyCodeLine{00060\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classff__batch_buffer_a9be6b493454fae8da3f2259648778ba7}{size}}\ =\ htonl(\mbox{\hyperlink{classff__batch_buffer_a9be6b493454fae8da3f2259648778ba7}{size}});}
\DoxyCodeLine{00061\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00062\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{classff__batch_buffer_a10f8101e0bcaefec1bb1c93b55d6b81a}{callback}}(\mbox{\hyperlink{classff__batch_buffer_a9f568a4694c4a8eae43df6b63f069a5f}{iov}},\ size\_*4+1))\ \{}
\DoxyCodeLine{00063\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespaceff_a27d926d29b55e019eba5b70672301d82}{error}}(\textcolor{stringliteral}{"{}Callback\ of\ the\ batchbuffer\ got\ something\ wrong!\(\backslash\)n"{}});}
\DoxyCodeLine{00064\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ -\/1;}
\DoxyCodeLine{00065\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00066\ }
\DoxyCodeLine{00067\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (!\mbox{\hyperlink{classff__batch_buffer_a27fa6e8d07791acc5a806899694bff19}{toCleanup}}.empty())\{}
\DoxyCodeLine{00068\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{delete}\ \mbox{\hyperlink{classff__batch_buffer_a27fa6e8d07791acc5a806899694bff19}{toCleanup}}.back().first;}
\DoxyCodeLine{00069\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{delete}\ \mbox{\hyperlink{classff__batch_buffer_a27fa6e8d07791acc5a806899694bff19}{toCleanup}}.back().second;}
\DoxyCodeLine{00070\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classff__batch_buffer_a27fa6e8d07791acc5a806899694bff19}{toCleanup}}.pop\_back();}
\DoxyCodeLine{00071\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00072\ }
\DoxyCodeLine{00073\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classff__batch_buffer_a9be6b493454fae8da3f2259648778ba7}{size}}\ =\ 0;}
\DoxyCodeLine{00074\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00075\ \ \ \ \ \}}
\DoxyCodeLine{00076\ }
\DoxyCodeLine{00077\ \};}
\DoxyCodeLine{00078\ }
\DoxyCodeLine{00079\ \textcolor{preprocessor}{\#endif}}

\end{DoxyCode}
