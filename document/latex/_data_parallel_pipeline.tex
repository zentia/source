\doxysection{Data-\/parallel Pipeline}
\hypertarget{_data_parallel_pipeline}{}\label{_data_parallel_pipeline}\index{Data-\/parallel Pipeline@{Data-\/parallel Pipeline}}
Taskflow provides another variant, \doxylink{classtf_1_1_data_pipeline}{tf\+::\+Data\+Pipeline}, on top of \doxylink{classtf_1_1_pipeline}{tf\+::\+Pipeline} (see \doxylink{TaskParallelPipeline}{Task-\/parallel Pipeline}) to help you implement data-\/parallel pipeline algorithms while leaving data management to Taskflow. We recommend you finishing reading Task\+Parallel\+Pipeline first before learning \doxylink{classtf_1_1_data_pipeline}{tf\+::\+Data\+Pipeline}.\hypertarget{_data_parallel_pipeline_ParallelDataPipelineIncludeHeaderFile}{}\doxysubsection{\texorpdfstring{Include the Header}{Include the Header}}\label{_data_parallel_pipeline_ParallelDataPipelineIncludeHeaderFile}
You need to include the header file, {\ttfamily taskflow/algorithm/data\+\_\+pipeline.hpp}, for implementing data-\/parallel pipeline algorithms.


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{preprocessor}{\#include\ <\mbox{\hyperlink{taskflow_2algorithm_2data__pipeline_8hpp}{taskflow/algorithm/data\_pipeline.hpp}}>}}

\end{DoxyCode}
\hypertarget{_data_parallel_pipeline_CreateADataPipelineModuleTask}{}\doxysubsection{\texorpdfstring{Create a Data Pipeline Module Task}{Create a Data Pipeline Module Task}}\label{_data_parallel_pipeline_CreateADataPipelineModuleTask}
Similar to creating a task-\/parallel pipeline (\doxylink{classtf_1_1_pipeline}{tf\+::\+Pipeline}), there are three steps to create a data-\/parallel pipeline application\+:


\begin{DoxyEnumerate}
\item Define the pipeline structure (e.\+g., pipe type, pipe callable, stopping rule, line count)
\item Define the data storage and layout, if needed for the application
\item Define the pipeline taskflow graph using composition
\end{DoxyEnumerate}

The following example creates a data-\/parallel pipeline that generates a total of five dataflow tokens from {\ttfamily void} to {\ttfamily int} at the first stage, from {\ttfamily int} to {\ttfamily std\+::string} at the second stage, and {\ttfamily std\+::string} to {\ttfamily void} at the final stage. \doxylink{class_data}{Data} storage between stages is automatically managed by \doxylink{classtf_1_1_data_pipeline}{tf\+::\+Data\+Pipeline}.


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{preprocessor}{\#include\ <\mbox{\hyperlink{taskflow_8hpp}{taskflow/taskflow.hpp}}>}}
\DoxyCodeLine{\textcolor{preprocessor}{\#include\ <\mbox{\hyperlink{taskflow_2algorithm_2data__pipeline_8hpp}{taskflow/algorithm/data\_pipeline.hpp}}>}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{keywordtype}{int}\ \mbox{\hyperlink{main-override-static_8c_ae66f6b31b5ad750f1fe042a706a4e3d4}{main}}()\ \{}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \textcolor{comment}{//\ data\ flow\ =>\ void\ -\/>\ int\ -\/>\ std::string\ -\/>\ void\ }}
\DoxyCodeLine{\ \ \mbox{\hyperlink{classtf_1_1_taskflow}{tf::Taskflow}}\ \mbox{\hyperlink{poisson_8hpp_aa56fe360bb0ae38e0082f49e394ff825}{taskflow}}(\textcolor{stringliteral}{"{}pipeline"{}});}
\DoxyCodeLine{\ \ \mbox{\hyperlink{classtf_1_1_executor}{tf::Executor}}\ \mbox{\hyperlink{thread__pool_8cpp_a543e564a8407bbeac15cb2d929fec755}{executor}};}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ num\_lines\ =\ 4;}
\DoxyCodeLine{\ \ }
\DoxyCodeLine{\ \ \textcolor{comment}{//\ create\ a\ pipeline\ graph}}
\DoxyCodeLine{\ \ \mbox{\hyperlink{classtf_1_1_data_pipeline}{tf::DataPipeline}}\ pl(num\_lines,}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{namespacetf_a8975fa5762088789adb0b60f38208309}{tf::make\_data\_pipe<void,\ int>}}(\mbox{\hyperlink{namespacetf_abb7a11e41fd457f69e7ff45d4c769564a7b804a28d6154ab8007287532037f1d0}{tf::PipeType::SERIAL}},\ [\&](\mbox{\hyperlink{classtf_1_1_pipeflow}{tf::Pipeflow}}\&\ pf)\ -\/>\ \textcolor{keywordtype}{int}\{}
\DoxyCodeLine{\ \ \ \ \ \ \textcolor{keywordflow}{if}(pf.\mbox{\hyperlink{classtf_1_1_pipeflow_a295e5d884665c076f4ef5d78139f7c51}{token}}()\ ==\ 5)\ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ pf.\mbox{\hyperlink{classtf_1_1_pipeflow_a830b7f204cb87fff17e8d424918d9453}{stop}}();}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{\ \ \ \ \ \ \}}
\DoxyCodeLine{\ \ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}first\ pipe\ returns\ \%lu\(\backslash\)n"{}},\ pf.\mbox{\hyperlink{classtf_1_1_pipeflow_a295e5d884665c076f4ef5d78139f7c51}{token}}());}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ pf.\mbox{\hyperlink{classtf_1_1_pipeflow_a295e5d884665c076f4ef5d78139f7c51}{token}}();}
\DoxyCodeLine{\ \ \ \ \ \ \}}
\DoxyCodeLine{\ \ \ \ \}),}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{namespacetf_a8975fa5762088789adb0b60f38208309}{tf::make\_data\_pipe<int,\ std::string>}}(\mbox{\hyperlink{namespacetf_abb7a11e41fd457f69e7ff45d4c769564a7b804a28d6154ab8007287532037f1d0}{tf::PipeType::SERIAL}},\ [](\textcolor{keywordtype}{int}\&\ \mbox{\hyperlink{benchmarks_2scan_2scan_8hpp_ab7e6955a695fad0be513586926040b1a}{input}})\ \{}
\DoxyCodeLine{\ \ \ \ \ \ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}second\ pipe\ returns\ a\ string\ of\ \%d\(\backslash\)n"{}},\ \mbox{\hyperlink{benchmarks_2scan_2scan_8hpp_ab7e6955a695fad0be513586926040b1a}{input}}\ +\ 100);}
\DoxyCodeLine{\ \ \ \ \ \ \textcolor{keywordflow}{return}\ std::to\_string(\mbox{\hyperlink{benchmarks_2scan_2scan_8hpp_ab7e6955a695fad0be513586926040b1a}{input}}\ +\ 100);}
\DoxyCodeLine{\ \ \ \ \}),}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{namespacetf_a8975fa5762088789adb0b60f38208309}{tf::make\_data\_pipe<std::string,\ void>}}(\mbox{\hyperlink{namespacetf_abb7a11e41fd457f69e7ff45d4c769564a7b804a28d6154ab8007287532037f1d0}{tf::PipeType::SERIAL}},\ [](std::string\&\ \mbox{\hyperlink{benchmarks_2scan_2scan_8hpp_ab7e6955a695fad0be513586926040b1a}{input}})\ \{}
\DoxyCodeLine{\ \ \ \ \ \ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}third\ pipe\ receives\ the\ input\ string\ \%s\(\backslash\)n"{}},\ \mbox{\hyperlink{benchmarks_2scan_2scan_8hpp_ab7e6955a695fad0be513586926040b1a}{input}}.c\_str());}
\DoxyCodeLine{\ \ \ \ \})}
\DoxyCodeLine{\ \ );}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \textcolor{comment}{//\ build\ the\ pipeline\ graph\ using\ composition}}
\DoxyCodeLine{\ \ \mbox{\hyperlink{poisson_8hpp_aa56fe360bb0ae38e0082f49e394ff825}{taskflow}}.composed\_of(pl).name(\textcolor{stringliteral}{"{}pipeline"{}});}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \textcolor{comment}{//\ dump\ the\ pipeline\ graph\ structure\ (with\ composition)}}
\DoxyCodeLine{\ \ \mbox{\hyperlink{poisson_8hpp_aa56fe360bb0ae38e0082f49e394ff825}{taskflow}}.dump(std::cout);}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \textcolor{comment}{//\ run\ the\ pipeline}}
\DoxyCodeLine{\ \ \mbox{\hyperlink{thread__pool_8cpp_a543e564a8407bbeac15cb2d929fec755}{executor}}.\mbox{\hyperlink{classtf_1_1_executor_a519777f5783981d534e9e53b99712069}{run}}(\mbox{\hyperlink{poisson_8hpp_aa56fe360bb0ae38e0082f49e394ff825}{taskflow}}).wait();}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{\}}

\end{DoxyCode}


The interface of \doxylink{classtf_1_1_data_pipeline}{tf\+::\+Data\+Pipeline} is very similar to \doxylink{classtf_1_1_pipeline}{tf\+::\+Pipeline}, except that the library transparently manages the dataflow between pipes. To create a stage in a data-\/parallel pipeline, you should always use the helper function \doxylink{namespacetf_a8975fa5762088789adb0b60f38208309}{tf\+::make\+\_\+data\+\_\+pipe}\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{\mbox{\hyperlink{namespacetf_a8975fa5762088789adb0b60f38208309}{tf::make\_data\_pipe<int,\ std::string>}}(}
\DoxyCodeLine{\ \ \mbox{\hyperlink{namespacetf_abb7a11e41fd457f69e7ff45d4c769564a7b804a28d6154ab8007287532037f1d0}{tf::PipeType::SERIAL}},\ }
\DoxyCodeLine{\ \ [](\textcolor{keywordtype}{int}\&\ \mbox{\hyperlink{benchmarks_2scan_2scan_8hpp_ab7e6955a695fad0be513586926040b1a}{input}})\ \{\ }
\DoxyCodeLine{\ \ \ \ \textcolor{keywordflow}{return}\ std::to\_string(\mbox{\hyperlink{benchmarks_2scan_2scan_8hpp_ab7e6955a695fad0be513586926040b1a}{input}}\ +\ 100);}
\DoxyCodeLine{\ \ \}}
\DoxyCodeLine{);}

\end{DoxyCode}


The helper function starts with a pair of an input and an output types in its template arguments. Both types will always be decayed to their original form using std\+::decay (e.\+g., {\ttfamily const int\&} becomes {\ttfamily int}) for storage purpose. In terms of function arguments, the first argument specifies the direction of this data pipe, which can be either \doxylink{namespacetf_abb7a11e41fd457f69e7ff45d4c769564a7b804a28d6154ab8007287532037f1d0}{tf\+::\+Pipe\+Type\+::\+SERIAL} or \doxylink{namespacetf_abb7a11e41fd457f69e7ff45d4c769564adf13a99b035d6f0bce4f44ab18eec8eb}{tf\+::\+Pipe\+Type\+::\+PARALLEL}, and the second argument is a callable to invoke by the pipeline scheduler. The callable must take the input data type in its first argument and returns a value of the output data type. Additionally, the callable can take a \doxylink{classtf_1_1_pipeflow}{tf\+::\+Pipeflow} reference in its second argument which allows you to query the runtime information of a stage task, such as its line number and token number.


\begin{DoxyCode}{0}
\DoxyCodeLine{\mbox{\hyperlink{namespacetf_a8975fa5762088789adb0b60f38208309}{tf::make\_data\_pipe<int,\ std::string>}}(}
\DoxyCodeLine{\ \ \mbox{\hyperlink{namespacetf_abb7a11e41fd457f69e7ff45d4c769564a7b804a28d6154ab8007287532037f1d0}{tf::PipeType::SERIAL}},\ }
\DoxyCodeLine{\ \ [](\textcolor{keywordtype}{int}\&\ \mbox{\hyperlink{benchmarks_2scan_2scan_8hpp_ab7e6955a695fad0be513586926040b1a}{input}},\ \mbox{\hyperlink{classtf_1_1_pipeflow}{tf::Pipeflow}}\&\ pf)\ \{}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}token=\%lu,\ line=\%lu\(\backslash\)n"{}},\ pf.\mbox{\hyperlink{classtf_1_1_pipeflow_a295e5d884665c076f4ef5d78139f7c51}{token}}(),\ pf.\mbox{\hyperlink{classtf_1_1_pipeflow_afee054e6a99965d4b3e36ff903227e6c}{line}}());}
\DoxyCodeLine{\ \ \ \ \textcolor{keywordflow}{return}\ std::to\_string(\mbox{\hyperlink{benchmarks_2scan_2scan_8hpp_ab7e6955a695fad0be513586926040b1a}{input}}\ +\ 100);}
\DoxyCodeLine{\ \ \}}
\DoxyCodeLine{)}

\end{DoxyCode}


\begin{DoxyAttention}{注意}
By default, \doxylink{classtf_1_1_data_pipeline}{tf\+::\+Data\+Pipeline} passes the data in reference to your callable at which you can take it in copy or in reference depending on application needs.
\end{DoxyAttention}
For the first pipe, the input type should always be {\ttfamily void} and the callable must take a \doxylink{classtf_1_1_pipeflow}{tf\+::\+Pipeflow} reference in its argument. In this example, we will stop the pipeline when processing five tokens.


\begin{DoxyCode}{0}
\DoxyCodeLine{\mbox{\hyperlink{namespacetf_a8975fa5762088789adb0b60f38208309}{tf::make\_data\_pipe<void,\ int>}}(\mbox{\hyperlink{namespacetf_abb7a11e41fd457f69e7ff45d4c769564a7b804a28d6154ab8007287532037f1d0}{tf::PipeType::SERIAL}},\ [](\mbox{\hyperlink{classtf_1_1_pipeflow}{tf::Pipeflow}}\&\ pf)\ -\/>\ \textcolor{keywordtype}{int}\{}
\DoxyCodeLine{\ \ \textcolor{keywordflow}{if}(pf.\mbox{\hyperlink{classtf_1_1_pipeflow_a295e5d884665c076f4ef5d78139f7c51}{token}}()\ ==\ 5)\ \{}
\DoxyCodeLine{\ \ \ \ pf.\mbox{\hyperlink{classtf_1_1_pipeflow_a830b7f204cb87fff17e8d424918d9453}{stop}}();}
\DoxyCodeLine{\ \ \ \ \textcolor{keywordflow}{return}\ 0;\ \ \ \ \textcolor{comment}{//\ returns\ a\ dummy\ value}}
\DoxyCodeLine{\ \ \}}
\DoxyCodeLine{\ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{\ \ \ \ \textcolor{keywordflow}{return}\ pf.\mbox{\hyperlink{classtf_1_1_pipeflow_a295e5d884665c076f4ef5d78139f7c51}{token}}();}
\DoxyCodeLine{\ \ \}}
\DoxyCodeLine{\}),}

\end{DoxyCode}


Similarly, the output type of the last pipe should be {\ttfamily void} as no more data will go out of the final pipe.


\begin{DoxyCode}{0}
\DoxyCodeLine{\mbox{\hyperlink{namespacetf_a8975fa5762088789adb0b60f38208309}{tf::make\_data\_pipe<std::string,\ void>}}(\mbox{\hyperlink{namespacetf_abb7a11e41fd457f69e7ff45d4c769564a7b804a28d6154ab8007287532037f1d0}{tf::PipeType::SERIAL}},\ [](std::string\&\ \mbox{\hyperlink{benchmarks_2scan_2scan_8hpp_ab7e6955a695fad0be513586926040b1a}{input}})\ \{}
\DoxyCodeLine{\ \ std::cout\ <<\ \mbox{\hyperlink{benchmarks_2scan_2scan_8hpp_ab7e6955a695fad0be513586926040b1a}{input}}\ <<\ std::endl;}
\DoxyCodeLine{\})}

\end{DoxyCode}


Finally, you need to compose the pipeline graph by creating a module task (i.\+e., tf\+::\+Taskflow\+::compoased\+\_\+of).


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{comment}{//\ build\ the\ pipeline\ graph\ using\ composition}}
\DoxyCodeLine{\mbox{\hyperlink{poisson_8hpp_aa56fe360bb0ae38e0082f49e394ff825}{taskflow}}.composed\_of(pl).name(\textcolor{stringliteral}{"{}pipeline"{}});}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{//\ dump\ the\ pipeline\ graph\ structure\ (with\ composition)}}
\DoxyCodeLine{\mbox{\hyperlink{poisson_8hpp_aa56fe360bb0ae38e0082f49e394ff825}{taskflow}}.dump(std::cout);}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{//\ run\ the\ pipeline}}
\DoxyCodeLine{\mbox{\hyperlink{thread__pool_8cpp_a543e564a8407bbeac15cb2d929fec755}{executor}}.run(\mbox{\hyperlink{poisson_8hpp_aa56fe360bb0ae38e0082f49e394ff825}{taskflow}}).wait();}

\end{DoxyCode}
\hypertarget{_data_parallel_pipeline_UnderstandInternalDataStorage}{}\doxysubsection{\texorpdfstring{Understand Internal Data Storage}{Understand Internal Data Storage}}\label{_data_parallel_pipeline_UnderstandInternalDataStorage}
By default, \doxylink{classtf_1_1_data_pipeline}{tf\+::\+Data\+Pipeline} uses @std\+\_\+variant to store a type-\/safe union of all input and output data types extracted from the given data pipes. To avoid false sharing, each line keeps a variant that is aligned with the cacheline size. When invoking a pipe callable, the input data is acquired in reference from the variant using @std\+\_\+variant\+\_\+get. When returning from a pipe callable, the output data is stored back to the variant using assignment operator.\hypertarget{_data_parallel_pipeline_DataParallelPipelineLearnMore}{}\doxysubsection{\texorpdfstring{Learn More about Taskflow Pipeline}{Learn More about Taskflow Pipeline}}\label{_data_parallel_pipeline_DataParallelPipelineLearnMore}
Visit the following pages to learn more about pipeline\+:


\begin{DoxyEnumerate}
\item \doxylink{TaskParallelPipeline}{Task-\/parallel Pipeline}
\item \doxylink{TaskParallelScalablePipeline}{Task-\/parallel Scalable Pipeline}
\item \doxylink{TextProcessingPipeline}{Text Processing Pipeline}
\item \doxylink{GraphProcessingPipeline}{Graph Processing Pipeline}
\item \doxylink{TaskflowProcessingPipeline}{Taskflow Processing Pipeline} 
\end{DoxyEnumerate}