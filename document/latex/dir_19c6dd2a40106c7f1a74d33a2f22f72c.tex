\doxysection{external/reflect-\/cpp/vcpkg/scripts/azure-\/pipelines/osx 目录参考}
\hypertarget{dir_19c6dd2a40106c7f1a74d33a2f22f72c}{}\label{dir_19c6dd2a40106c7f1a74d33a2f22f72c}\index{external/reflect-\/cpp/vcpkg/scripts/azure-\/pipelines/osx 目录参考@{external/reflect-\/cpp/vcpkg/scripts/azure-\/pipelines/osx 目录参考}}
osx 的目录依赖关系图
% FIG 0


\doxysubsection{详细描述}
This is the checklist for what the vcpkg team does when updating the mac\+OS machines in the pool.\hypertarget{README.md_autotoc_md776}{}\doxysubsection{\texorpdfstring{Creating new base images}{Creating new base images}}\label{README.md_autotoc_md776}
\hypertarget{README.md_autotoc_md777}{}\doxysubsubsection{\texorpdfstring{Prerequisites}{Prerequisites}}\label{README.md_autotoc_md777}

\begin{DoxyItemize}
\item[\DoxyUnchecked] \doxylink{bench__gemm_8cpp_addc86e8508f14411ec98f521c520f875}{A} Parallels license for amd64 or \href{https://github.com/s-u/macosvm}{\texttt{ macosvm}} allow-\/listed by mac\+OS for arm64. Note that the directory \textquotesingle{}Parallels\textquotesingle{} is still used when using {\ttfamily macosvm} just so that scripts know where to find the VM and friends.
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] An Xcode installer -\/ you can get this from Apple\textquotesingle{}s developer website, although you\textquotesingle{}ll need to sign in first\+: \href{https://developer.apple.com/downloads}{\texttt{ https\+://developer.\+apple.\+com/downloads}} ~\newline
 If you are doing this from a local macos box, you can skip to the "{}update the macos host"{} step. ~\newline

\end{DoxyItemize}\hypertarget{README.md_autotoc_md778}{}\doxysubsubsection{\texorpdfstring{Instructions (AMD64)}{Instructions (AMD64)}}\label{README.md_autotoc_md778}

\begin{DoxyItemize}
\item[\DoxyUnchecked] Go to \href{https://dev.azure.com/vcpkg/public/_settings/agentqueues}{\texttt{ https\+://dev.\+azure.\+com/vcpkg/public/\+\_\+settings/agentqueues}} , pick the current osx queue, and delete one of the agents that are idle.
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Go to that machine in the KVM. (Passwords are stored as secrets in the CPP\+\_\+\+GITHUB\textbackslash{}vcpkg\textbackslash{}vcpkgmm-\/passwords key vault)
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Open the Parallels Control Center, and delete the active VM.
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Update the macos host
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Update or install parallels
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Download the mac\+OS installer from the app store. See \href{https://support.apple.com/en-us/102662}{\texttt{ https\+://support.\+apple.\+com/en-\/us/102662}} ~\newline
 Note\+: This portion of the instructions is that which breaks most often depending on what Parallels and mac\+OS are doing. You might need to use {\ttfamily softwareupdate -\/-\/fetch-\/full-\/installer -\/-\/full-\/installer-\/version 14.\+5} and point Parallels at that resulting installer in \textquotesingle{}Applications\textquotesingle{} instead.
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] \doxylink{struct_run}{Run} parallels, and select that installer you just downloaded. Name the VM "{}vcpkg-\/osx-\/$<$\+DATE$>$-\/amd64"{}, for example "{}vcpkg-\/osx-\/2024-\/07-\/12-\/amd64"{}.
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] When creating the VM, customize the hardware to the following\+:
\begin{DoxyItemize}
\item 12 processors
\item 24000 MB of memory
\item 350 GB disk
\item Do not share mac camera
\end{DoxyItemize}
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Install Mac\+OS like you would on real hardware.
\begin{DoxyItemize}
\item Apple ID\+: \textquotesingle{}Set Up Later\textquotesingle{} / Skip
\item Account name\+: vcpkg
\item \doxylink{bench__gemm_8cpp_addc86e8508f14411ec98f521c520f875}{A} very similar password \+:)
\item Don\textquotesingle{}t enable Ask Siri
\end{DoxyItemize}
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Install Parallels Tools
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Restart the VM
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Change the desktop background to a solid color
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Enable remote login in System Settings -\/\texorpdfstring{$>$}{>} General -\/\texorpdfstring{$>$}{>} Sharing -\/\texorpdfstring{$>$}{>} Remote Login
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Update the Azure Agent URI in setup-\/box.\+sh to the current version. You can find this by going to the agent pool, selecting "{}\+New agent"{}, picking mac\+OS, and copying the link. For example \href{https://vstsagentpackage.azureedge.net/agent/3.241.0/vsts-agent-osx-x64-3.241.0.tar.gz}{\texttt{ https\+://vstsagentpackage.\+azureedge.\+net/agent/3.\+241.\+0/vsts-\/agent-\/osx-\/x64-\/3.\+241.\+0.\+tar.\+gz}}
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Start the VM. Change the screen resolution to not be teeny weeny eyestrain o vision.
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] In the guest, set the vcpkg user to be able to use sudo without a password\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{printf\ 'vcpkg\(\backslash\)tALL=(ALL)\(\backslash\)tNOPASSWD:\(\backslash\)tALL\(\backslash\)n'\ |\ sudo\ tee\ -\/a\ '/etc/sudoers.d/vcpkg'}
\DoxyCodeLine{sudo\ chmod\ 0440\ '/etc/sudoers.d/vcpkg'}

\end{DoxyCode}

\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Copy setup-\/guest, setup-\/box.\+sh, and the xcode installer renamed to \textquotesingle{}clt.\+dmg\textquotesingle{} to the host, and run setup-\/guest.\+sh. For example\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{scp\ ./setup-\/guest.sh\ vcpkg@MACHINE:/Users/vcpkg}
\DoxyCodeLine{scp\ ./setup-\/box.sh\ vcpkg@MACHINE:/Users/vcpkg}
\DoxyCodeLine{scp\ path/to/console/tools.dmg\ vcpkg@MACHINE:/Users/vcpkg/clt.dmg}
\DoxyCodeLine{ssh\ vcpkg@MACHINE}
\DoxyCodeLine{rm\ \string~/.ssh/known\_hosts}
\DoxyCodeLine{chmod\ +x\ setup-\/guest.sh}
\DoxyCodeLine{./setup-\/guest.sh}
\DoxyCodeLine{rm\ setup-\/guest.sh}
\DoxyCodeLine{rm\ setup-\/box.sh}
\DoxyCodeLine{rm\ clt.dmg}

\end{DoxyCode}

\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] In the guest, check that \textquotesingle{}m4\textquotesingle{} works in the terminal. If it tries to reinstall the command line tools, let it do that. You might need to manually run this workaround from \href{https://developer.apple.com/documentation/xcode-release-notes/xcode-15-release-notes\#Known-Issues}{\texttt{ https\+://developer.\+apple.\+com/documentation/xcode-\/release-\/notes/xcode-\/15-\/release-\/notes\#\+Known-\/\+Issues}} 
\begin{DoxyCode}{0}
\DoxyCodeLine{sudo\ mkdir\ -\/p\ /Library/Developer/CommandLineTools}
\DoxyCodeLine{sudo\ touch\ /Library/Developer/CommandLineTools/.beta}

\end{DoxyCode}

\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Shut down the VM cleanly
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Set the VM \textquotesingle{}Isolated\textquotesingle{}
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] In Parallels control center, right click the VM and select "{}\+Prepare for Transfer"{}
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] In Parallels control center, right click the VM and remove it, but "{}\+Keep Files"{}
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Copy the packaged VM to Azure \doxylink{struct_storage}{Storage}, with something like\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{ssh\ vcpkg@MACHINE}
\DoxyCodeLine{brew\ install\ azcopy}
\DoxyCodeLine{azcopy\ copy\ \string~/Parallels/vcpkg-\/osx-\/2024-\/07-\/12-\/amd64.pvmp\ "{}https://vcpkgimageminting...../pvms?<SAS>"{}}
\DoxyCodeLine{azcopy\ copy\ \string~/Parallels/vcpkg-\/osx-\/2024-\/07-\/12-\/amd64.sha256.txt\ "{}https://vcpkgimageminting...../pvms?<SAS>"{}}

\end{DoxyCode}

\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Go to \href{https://dev.azure.com/vcpkg/public/_settings/agentqueues}{\texttt{ https\+://dev.\+azure.\+com/vcpkg/public/\+\_\+settings/agentqueues}} and create a new self hosted Agent pool named {\ttfamily Pr\+Osx-\/\+YYYY-\/\+MM-\/\+DD} based on the current date. \doxylink{struct_check}{Check} \textquotesingle{}Grant access permission to all pipelines.\textquotesingle{}
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Remove the mac\+OS installer from Applications
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Follow the "{}\+Deploying images"{} steps below for each machine in the fleet.
\end{DoxyItemize}\hypertarget{README.md_autotoc_md779}{}\doxysubsubsection{\texorpdfstring{Instructions (ARM64)}{Instructions (ARM64)}}\label{README.md_autotoc_md779}

\begin{DoxyItemize}
\item[\DoxyUnchecked] Go to \href{https://dev.azure.com/vcpkg/public/_settings/agentqueues}{\texttt{ https\+://dev.\+azure.\+com/vcpkg/public/\+\_\+settings/agentqueues}} , pick the current osx queue, and delete one of the agents that are idle.
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Go to that machine in the KVM. (Passwords are stored as secrets in the CPP\+\_\+\+GITHUB\textbackslash{}vcpkg\textbackslash{}vcpkgmm-\/passwords key vault)
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Update the macos host
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] (Once only) install {\ttfamily macosvm} to {\ttfamily \texorpdfstring{$\sim$}{\string~}} (this tarball is also backed up in our {\ttfamily vcpkg-\/image-\/minting} storage account)\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{curl\ -\/L\ -\/o\ macosvm-\/0.2-\/1-\/arm64-\/darwin21.tar.gz\ https://github.com/s-\/u/macosvm/releases/download/0.2-\/1/macosvm-\/0.2-\/1-\/arm64-\/darwin21.tar.gz}
\DoxyCodeLine{tar\ xvf\ macosvm-\/0.2-\/1-\/arm64-\/darwin21.tar.gz}
\DoxyCodeLine{rm\ macosvm-\/0.2-\/1-\/arm64-\/darwin21.tar.gz}

\end{DoxyCode}

\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Download the matching {\ttfamily .ipsw} for the mac\+OS copy to install. See \href{https://mrmacintosh.com/apple-silicon-m1-full-macos-restore-ipsw-firmware-files-database/}{\texttt{ https\+://mrmacintosh.\+com/apple-\/silicon-\/m1-\/full-\/macos-\/restore-\/ipsw-\/firmware-\/files-\/database/}} ; links there to find the .ipsw. Example\+: \href{https://updates.cdn-apple.com/2024SpringFCS/fullrestores/062-01897/C874907B-9F82-4109-87EB-6B3C9BF1507D/UniversalMac_14.5_23F79_Restore.ipsw}{\texttt{ https\+://updates.\+cdn-\/apple.\+com/2024\+Spring\+FCS/fullrestores/062-\/01897/\+C874907\+B-\/9\+F82-\/4109-\/87\+EB-\/6\+B3\+C9\+BF1507\+D/\+Universal\+Mac\+\_\+14.\+5\+\_\+23\+F79\+\_\+\+Restore.\+ipsw}}
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Determine the VM name using the form "{}vcpkg-\/osx-\/$<$date$>$-\/arm64"{}, for example "{}vcpkg-\/osx-\/2024-\/07-\/12-\/arm64"{}.
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Open a terminal and run the following commands to create the VM with vcpkg-\/osx-\/2024-\/07-\/12-\/arm64 and Universal\+Mac\+\_\+14.\+5\+\_\+23\+F79\+\_\+\+Restore.\+ipsw replaced as appropriate. 
\begin{DoxyCode}{0}
\DoxyCodeLine{mkdir\ -\/p\ \string~/Parallels/vcpkg-\/osx-\/2024-\/07-\/12-\/arm64}
\DoxyCodeLine{cd\ \string~/Parallels/vcpkg-\/osx-\/2024-\/07-\/12-\/arm64}
\DoxyCodeLine{\string~/macosvm\ -\/-\/disk\ disk.img,size=500g\ -\/-\/aux\ aux.img\ -\/c\ 8\ -\/r\ 12g\ -\/-\/restore\ \string~/UniversalMac\_14.5\_23F79\_Restore.ipsw\ ./vm.json}
\DoxyCodeLine{\string~/macosvm\ -\/g\ ./vm.json}

\end{DoxyCode}

\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Follow prompts as you would on real hardware.
\begin{DoxyItemize}
\item Apple ID\+: \textquotesingle{}Set Up Later\textquotesingle{} / Skip
\item Account name\+: vcpkg
\item \doxylink{bench__gemm_8cpp_addc86e8508f14411ec98f521c520f875}{A} very similar password
\item No location services
\item Yes send crash reports
\end{DoxyItemize}
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Set the desktop wallpaper to a fixed color from Settings -\/\texorpdfstring{$>$}{>} Wallpaper . (This makes the KVM a lot easier to use \+:) )
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Enable remote login in the VM\+: Settings -\/\texorpdfstring{$>$}{>} General -\/\texorpdfstring{$>$}{>} Sharing -\/\texorpdfstring{$>$}{>} Remote Login
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Set the vcpkg user to be able to use sudo without a password\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{ssh\ vcpkg@vcpkgs-\/Virtual-\/Machine.local}
\DoxyCodeLine{printf\ 'vcpkg\(\backslash\)tALL=(ALL)\(\backslash\)tNOPASSWD:\(\backslash\)tALL\(\backslash\)n'\ |\ sudo\ tee\ -\/a\ '/etc/sudoers.d/vcpkg'}
\DoxyCodeLine{sudo\ chmod\ 0440\ '/etc/sudoers.d/vcpkg'}
\DoxyCodeLine{exit}

\end{DoxyCode}

\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Update the Azure Agent URI in setup-\/box.\+sh to the current version. You can find this by going to the agent pool, selecting "{}\+New agent"{}, picking mac\+OS, and copying the link. For example \href{https://vstsagentpackage.azureedge.net/agent/3.241.0/vsts-agent-osx-arm64-3.241.0.tar.gz}{\texttt{ https\+://vstsagentpackage.\+azureedge.\+net/agent/3.\+241.\+0/vsts-\/agent-\/osx-\/arm64-\/3.\+241.\+0.\+tar.\+gz}}
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Copy setup-\/box.\+sh and the xcode installer renamed to \textquotesingle{}clt.\+dmg\textquotesingle{} to the host. For example from a dev workstation\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{scp\ ./setup-\/guest.sh\ vcpkg@MACHINE:/Users/vcpkg}
\DoxyCodeLine{scp\ ./setup-\/box.sh\ vcpkg@MACHINE:/Users/vcpkg}
\DoxyCodeLine{scp\ path/to/console/tools.dmg\ vcpkg@MACHINE:/Users/vcpkg/clt.dmg}
\DoxyCodeLine{ssh\ vcpkg@MACHINE}
\DoxyCodeLine{chmod\ +x\ setup-\/guest.sh}
\DoxyCodeLine{rm\ \string~/.ssh/known\_hosts}
\DoxyCodeLine{./setup-\/guest.sh}
\DoxyCodeLine{rm\ setup-\/guest.sh}
\DoxyCodeLine{rm\ setup-\/box.sh}
\DoxyCodeLine{rm\ clt.dmg}

\end{DoxyCode}

\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] In the guest, check that \textquotesingle{}m4\textquotesingle{} works in the terminal. If it tries to reinstall the command line tools, let it do that. You might need to manually run this workaround from \href{https://developer.apple.com/documentation/xcode-release-notes/xcode-15-release-notes\#Known-Issues}{\texttt{ https\+://developer.\+apple.\+com/documentation/xcode-\/release-\/notes/xcode-\/15-\/release-\/notes\#\+Known-\/\+Issues}} 
\begin{DoxyCode}{0}
\DoxyCodeLine{sudo\ mkdir\ -\/p\ /Library/Developer/CommandLineTools}
\DoxyCodeLine{sudo\ touch\ /Library/Developer/CommandLineTools/.beta}

\end{DoxyCode}

\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Shut down the VM cleanly.
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Mint a SAS token to vcpkgimageminting/pvms with read, add, create, write, and list permissions.
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Open a terminal on the host and package the VM into a tarball\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{cd\ \string~/Parallels}
\DoxyCodeLine{aa\ archive\ -\/d\ vcpkg-\/osx-\/<date>-\/arm64\ -\/o\ vcpkg-\/osx-\/<date>-\/arm64.aar\ -\/enable-\/holes}
\DoxyCodeLine{brew\ install\ azcopy}
\DoxyCodeLine{azcopy\ copy\ vcpkg-\/osx-\/<date>-\/arm64.aar\ "{}https://vcpkgimageminting.blob.core.windows.net/pvms?<SAS>"{}}
\DoxyCodeLine{rm\ *.aar}

\end{DoxyCode}

\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Go to \href{https://dev.azure.com/vcpkg/public/_settings/agentqueues}{\texttt{ https\+://dev.\+azure.\+com/vcpkg/public/\+\_\+settings/agentqueues}} and create a new self hosted Agent pool named {\ttfamily Pr\+Osx-\/\+YYYY-\/\+MM-\/\+DD-\/arm64} based on the current date. \doxylink{struct_check}{Check} \textquotesingle{}Grant access permission to all pipelines.\textquotesingle{}
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Follow the "{}\+Deploying images"{} steps below for each machine in the fleet.
\end{DoxyItemize}\hypertarget{README.md_autotoc_md780}{}\doxysubsection{\texorpdfstring{Deploying images}{Deploying images}}\label{README.md_autotoc_md780}
\hypertarget{README.md_autotoc_md781}{}\doxysubsubsection{\texorpdfstring{Running the VM (AMD64)}{Running the VM (AMD64)}}\label{README.md_autotoc_md781}
\doxylink{struct_run}{Run} these steps on each machine to add to the fleet. Skip steps that were done implicitly above if this machine was used to build a box.


\begin{DoxyItemize}
\item[\DoxyUnchecked] If this machine was used before, delete it from the pool of which it is a member from \href{https://dev.azure.com/vcpkg/public/_settings/agentqueues}{\texttt{ https\+://dev.\+azure.\+com/vcpkg/public/\+\_\+settings/agentqueues}}
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Log in to the machine using the KVM.
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] \doxylink{struct_check}{Check} for software updates in mac\+OS system settings
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] \doxylink{struct_check}{Check} for software updates in Parallels\textquotesingle{} UI
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Mint a SAS token URI to the box to use from the Azure portal if you don\textquotesingle{}t already have one, and download the VM. (Recommend running this via SSH from domain joined machine due to containing SAS tokens) 
\begin{DoxyCode}{0}
\DoxyCodeLine{brew\ install\ azcopy}
\DoxyCodeLine{cd\ \string~/Parallels}
\DoxyCodeLine{azcopy\ copy\ "{}https://vcpkgimageminting.blob.core.windows.net/pvms/vcpkg-\/osx-\/<DATE>-\/amd64.pvmp?<SAS>"{}\ .}
\DoxyCodeLine{azcopy\ copy\ "{}https://vcpkgimageminting.blob.core.windows.net/pvms/vcpkg-\/osx-\/<DATE>-\/amd64.sha256.txt?<SAS>"{}\ .}

\end{DoxyCode}

\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Open the .pvmp in Parallels, and unpack it.
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Start the VM
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] grab a PAT if you don\textquotesingle{}t already have one
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Copy the guest deploy script to the host, and run it with a first parameter of your PAT 
\begin{DoxyCode}{0}
\DoxyCodeLine{scp\ ./register-\/guest.sh\ vcpkg@MACHINE:/Users/vcpkg}
\DoxyCodeLine{ssh\ vcpkg@MACHINE}
\DoxyCodeLine{rm\ \string~/.ssh/known\_hosts}
\DoxyCodeLine{chmod\ +x\ /Users/vcpkg/register-\/guest.sh}
\DoxyCodeLine{/Users/vcpkg/register-\/guest.sh\ <PAT>}

\end{DoxyCode}

\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Open a terminal window on the host and run the agent 
\begin{DoxyCode}{0}
\DoxyCodeLine{ssh\ -\/i\ \string~/Parallels/*/id\_guest\ vcpkg@`prlctl\ list\ -\/-\/full\ |\ sed\ -\/nr\ 's/\string^.*running\ *([0-\/9]\{1,3\}\(\backslash\).[0-\/9]\{1,3\}\(\backslash\).[0-\/9]\{1,3\}\(\backslash\).[0-\/9]\{1,3\}).*/\(\backslash\)1/p'`}
\DoxyCodeLine{\string~/myagent/run.sh}

\end{DoxyCode}

\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] \doxylink{struct_check}{Check} that the machine shows up in the pool, and lock the vcpkg user on the host.
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Lock the screen on the host.
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Update the "{}vcpkg Macs"{} spreadsheet line for the machine with the new pool.
\end{DoxyItemize}\hypertarget{README.md_autotoc_md782}{}\doxysubsubsection{\texorpdfstring{Running the VM (ARM64)}{Running the VM (ARM64)}}\label{README.md_autotoc_md782}
\doxylink{struct_run}{Run} these steps on each machine to add to the fleet. Skip steps that were done implicitly above if this machine was used to build a box.


\begin{DoxyItemize}
\item[\DoxyUnchecked] If this machine was used before, delete it from the pool of which it is a member from \href{https://dev.azure.com/vcpkg/public/_settings/agentqueues}{\texttt{ https\+://dev.\+azure.\+com/vcpkg/public/\+\_\+settings/agentqueues}}
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Log in to the machine using the KVM.
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] \doxylink{struct_check}{Check} for software updates in mac\+OS system settings
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] (Once only) install {\ttfamily macosvm} to {\ttfamily \texorpdfstring{$\sim$}{\string~}} (this tarball is also backed up in our {\ttfamily vcpkg-\/image-\/minting} storage account)\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{curl\ -\/L\ -\/o\ macosvm-\/0.2-\/1-\/arm64-\/darwin21.tar.gz\ https://github.com/s-\/u/macosvm/releases/download/0.2-\/1/macosvm-\/0.2-\/1-\/arm64-\/darwin21.tar.gz}
\DoxyCodeLine{tar\ xvf\ macosvm-\/0.2-\/1-\/arm64-\/darwin21.tar.gz}
\DoxyCodeLine{rm\ macosvm-\/0.2-\/1-\/arm64-\/darwin21.tar.gz}

\end{DoxyCode}

\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Skip if this is the image building machine. Mint a SAS token URI to the box to use from the Azure portal if you don\textquotesingle{}t already have one, and download the VM. (Recommend running this via SSH from domain joined machine due to containing SAS tokens) 
\begin{DoxyCode}{0}
\DoxyCodeLine{mkdir\ -\/p\ \string~/Parallels}
\DoxyCodeLine{cd\ \string~/Parallels}
\DoxyCodeLine{azcopy\ copy\ "{}https://vcpkgimageminting.blob.core.windows.net/pvms/vcpkg-\/osx-\/<DATE>-\/arm64.aar?<SAS>"{}\ vcpkg-\/osx-\/<DATE>-\/arm64.aar}
\DoxyCodeLine{aa\ extract\ -\/d\ vcpkg-\/osx-\/<DATE>-\/arm64\ -\/i\ ./vcpkg-\/osx-\/<DATE>-\/arm64.aar\ -\/enable-\/holes}

\end{DoxyCode}

\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Open a separate terminal window on the host and start the VM by running\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{cd\ \string~/Parallels/vcpkg-\/osx-\/<DATE>-\/arm64}
\DoxyCodeLine{\string~/macosvm\ ./vm.json}

\end{DoxyCode}

\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] grab a PAT if you don\textquotesingle{}t already have one
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Copy the guest deploy script to the host, and run it with a first parameter of your PAT. From a developer machine\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{scp\ ./register-\/guest.sh\ vcpkg@MACHINE:/Users/vcpkg}
\DoxyCodeLine{ssh\ vcpkg@MACHINE}
\DoxyCodeLine{rm\ \string~/.ssh/known\_hosts}
\DoxyCodeLine{chmod\ +x\ register-\/guest.sh}
\DoxyCodeLine{./register-\/guest.sh\ <PAT>}
\DoxyCodeLine{rm\ register-\/guest.sh}
\DoxyCodeLine{exit}

\end{DoxyCode}

\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] In the KVM\textquotesingle{}s terminal, relaunch the VM in ephemeral mode with\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{\string~/macosvm\ -\/-\/ephemeral\ ./vm.json}

\end{DoxyCode}

\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Open a terminal window on the host and run the agent 
\begin{DoxyCode}{0}
\DoxyCodeLine{ssh\ -\/i\ \string~/Parallels/*/id\_guest\ vcpkg@vcpkgs-\/Virtual-\/Machine.local}
\DoxyCodeLine{\string~/myagent/run.sh}

\end{DoxyCode}

\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] \doxylink{struct_check}{Check} that the machine shows up in the pool, and lock the vcpkg user on the host.
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Lock the screen on the host.
\end{DoxyItemize}
\begin{DoxyItemize}
\item[\DoxyUnchecked] Update the "{}vcpkg Macs"{} spreadsheet line for the machine with the new pool.
\end{DoxyItemize}\hypertarget{README.md_autotoc_md783}{}\doxysubsection{\texorpdfstring{Getting an Azure Pipelines PAT}{Getting an Azure Pipelines PAT}}\label{README.md_autotoc_md783}
Personal Access Tokens are an important part of this process, and they are fairly easy to generate. On ADO, under the correct project (in vcpkg\textquotesingle{}s case, "{}vcpkg"{}), click on the "{}\+User Settings"{} icon, then go to "{}\+Personal access tokens"{}. It is the icon to the left of your user icon, in the top right corner.

Then, create a new token, give it a name, make sure it expires quickly, and give it a custom defined scope that includes the "{}\+Agent pools\+: Read \& manage"{} permission (you\textquotesingle{}ll need to "{}\+Show all scopes"{} to access this). You can now copy this token and use it to allow machines to join. 