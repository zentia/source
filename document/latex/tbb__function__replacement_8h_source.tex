\doxysection{tbb\+\_\+function\+\_\+replacement.\+h}
\hypertarget{tbb__function__replacement_8h_source}{}\label{tbb__function__replacement_8h_source}\index{external/taskflow/3rd-\/party/tbb/src/tbbmalloc/tbb\_function\_replacement.h@{external/taskflow/3rd-\/party/tbb/src/tbbmalloc/tbb\_function\_replacement.h}}
\mbox{\hyperlink{tbb__function__replacement_8h}{浏览该文件的文档.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{/*}}
\DoxyCodeLine{00002\ \textcolor{comment}{\ \ \ \ Copyright\ (c)\ 2005-\/2020\ Intel\ Corporation}}
\DoxyCodeLine{00003\ \textcolor{comment}{}}
\DoxyCodeLine{00004\ \textcolor{comment}{\ \ \ \ Licensed\ under\ the\ Apache\ License,\ Version\ 2.0\ (the\ "{}License"{});}}
\DoxyCodeLine{00005\ \textcolor{comment}{\ \ \ \ you\ may\ not\ use\ this\ file\ except\ in\ compliance\ with\ the\ License.}}
\DoxyCodeLine{00006\ \textcolor{comment}{\ \ \ \ You\ may\ obtain\ a\ copy\ of\ the\ License\ at}}
\DoxyCodeLine{00007\ \textcolor{comment}{}}
\DoxyCodeLine{00008\ \textcolor{comment}{\ \ \ \ \ \ \ \ http://www.apache.org/licenses/LICENSE-\/2.0}}
\DoxyCodeLine{00009\ \textcolor{comment}{}}
\DoxyCodeLine{00010\ \textcolor{comment}{\ \ \ \ Unless\ required\ by\ applicable\ law\ or\ agreed\ to\ in\ writing,\ software}}
\DoxyCodeLine{00011\ \textcolor{comment}{\ \ \ \ distributed\ under\ the\ License\ is\ distributed\ on\ an\ "{}AS\ IS"{}\ BASIS,}}
\DoxyCodeLine{00012\ \textcolor{comment}{\ \ \ \ WITHOUT\ WARRANTIES\ OR\ CONDITIONS\ OF\ ANY\ KIND,\ either\ express\ or\ implied.}}
\DoxyCodeLine{00013\ \textcolor{comment}{\ \ \ \ See\ the\ License\ for\ the\ specific\ language\ governing\ permissions\ and}}
\DoxyCodeLine{00014\ \textcolor{comment}{\ \ \ \ limitations\ under\ the\ License.}}
\DoxyCodeLine{00015\ \textcolor{comment}{*/}}
\DoxyCodeLine{00016\ }
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#ifndef\ \_\_TBB\_function\_replacement\_H}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#define\ \_\_TBB\_function\_replacement\_H}}
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ <stddef.h>}\ \textcolor{comment}{//for\ ptrdiff\_t}}
\DoxyCodeLine{00021\ \textcolor{keyword}{typedef}\ \textcolor{keyword}{enum}\ \{}
\DoxyCodeLine{00022\ \ \ \ \ \mbox{\hyperlink{tbb__function__replacement_8h_a931934813cdf296e874c9bbd1dc7c7f2a7f5481ca2b19ef5b7a57d1106201408a}{FRR\_OK}},\ \ \ \ \ \textcolor{comment}{/*\ Succeeded\ in\ replacing\ the\ function\ */}}
\DoxyCodeLine{00023\ \ \ \ \ \mbox{\hyperlink{tbb__function__replacement_8h_a931934813cdf296e874c9bbd1dc7c7f2a40ba8f09fd35fc9ec653398a54274ffb}{FRR\_NODLL}},\ \ \textcolor{comment}{/*\ The\ requested\ DLL\ was\ not\ found\ */}}
\DoxyCodeLine{00024\ \ \ \ \ \mbox{\hyperlink{tbb__function__replacement_8h_a931934813cdf296e874c9bbd1dc7c7f2a7811d1445d0e6016a9e50e3b103a47e8}{FRR\_NOFUNC}},\ \textcolor{comment}{/*\ The\ requested\ function\ was\ not\ found\ */}}
\DoxyCodeLine{00025\ \ \ \ \ \mbox{\hyperlink{tbb__function__replacement_8h_a931934813cdf296e874c9bbd1dc7c7f2acbda3f9d0693bb28baedc73f45c75a8e}{FRR\_FAILED}},\ \textcolor{comment}{/*\ The\ function\ replacement\ request\ failed\ */}}
\DoxyCodeLine{00026\ \}\ \mbox{\hyperlink{tbb__function__replacement_8h_a931934813cdf296e874c9bbd1dc7c7f2}{FRR\_TYPE}};}
\DoxyCodeLine{00027\ }
\DoxyCodeLine{00028\ \textcolor{keyword}{typedef}\ \textcolor{keyword}{enum}\ \{}
\DoxyCodeLine{00029\ \ \ \ \ \mbox{\hyperlink{tbb__function__replacement_8h_a681ed1d5e24b912d3b918343737f2e15a669d295e007d8801a5ffcf53bb79eb78}{FRR\_FAIL}},\ \ \ \ \ \textcolor{comment}{/*\ Required\ function\ */}}
\DoxyCodeLine{00030\ \ \ \ \ \mbox{\hyperlink{tbb__function__replacement_8h_a681ed1d5e24b912d3b918343737f2e15a14809afd5a10b63518885760d057c9e8}{FRR\_IGNORE}},\ \ \ \textcolor{comment}{/*\ optional\ function\ */}}
\DoxyCodeLine{00031\ \}\ \mbox{\hyperlink{tbb__function__replacement_8h_a681ed1d5e24b912d3b918343737f2e15}{FRR\_ON\_ERROR}};}
\DoxyCodeLine{00032\ }
\DoxyCodeLine{00033\ \textcolor{keyword}{typedef}\ \mbox{\hyperlink{ittnotify__static_8h_a61af67d9d838a9497ca5b188dabc1aa0}{void}}\ (*\mbox{\hyperlink{tbb__function__replacement_8h_a2fe0f13eee3d78ac9456898f51c7449b}{FUNCPTR}})();}
\DoxyCodeLine{00034\ }
\DoxyCodeLine{00035\ \textcolor{preprocessor}{\#ifndef\ UNICODE}}
\DoxyCodeLine{00036\ \textcolor{preprocessor}{\#define\ ReplaceFunction\ ReplaceFunctionA}}
\DoxyCodeLine{00037\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00038\ \textcolor{preprocessor}{\#define\ ReplaceFunction\ ReplaceFunctionW}}
\DoxyCodeLine{00039\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//UNICODE}}
\DoxyCodeLine{00040\ }
\DoxyCodeLine{00041\ \mbox{\hyperlink{tbb__function__replacement_8h_a931934813cdf296e874c9bbd1dc7c7f2}{FRR\_TYPE}}\ \mbox{\hyperlink{tbb__function__replacement_8h_a83740372a58f206da1713a1e117281d5}{ReplaceFunctionA}}(\textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *dllName,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *funcName,\ \mbox{\hyperlink{tbb__function__replacement_8h_a2fe0f13eee3d78ac9456898f51c7449b}{FUNCPTR}}\ newFunc,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ **\ opcodes,\ \mbox{\hyperlink{tbb__function__replacement_8h_a2fe0f13eee3d78ac9456898f51c7449b}{FUNCPTR}}*\ origFunc=\mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}});}
\DoxyCodeLine{00042\ \mbox{\hyperlink{tbb__function__replacement_8h_a931934813cdf296e874c9bbd1dc7c7f2}{FRR\_TYPE}}\ \mbox{\hyperlink{tbb__function__replacement_8h_a5e94858f22fd286f3fdc2f6269a86cb0}{ReplaceFunctionW}}(\textcolor{keyword}{const}\ \textcolor{keywordtype}{wchar\_t}\ *dllName,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *funcName,\ \mbox{\hyperlink{tbb__function__replacement_8h_a2fe0f13eee3d78ac9456898f51c7449b}{FUNCPTR}}\ newFunc,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ **\ opcodes,\ \mbox{\hyperlink{tbb__function__replacement_8h_a2fe0f13eee3d78ac9456898f51c7449b}{FUNCPTR}}*\ origFunc=\mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}});}
\DoxyCodeLine{00043\ }
\DoxyCodeLine{00044\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{tbb__function__replacement_8h_afdf4f879aaa6f50078f68f38ddb79787}{IsPrologueKnown}}(\textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ dllName,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *funcName,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ **opcodes,\ HMODULE\ module);}
\DoxyCodeLine{00045\ }
\DoxyCodeLine{00046\ \textcolor{comment}{//\ Utilities\ to\ convert\ between\ ADDRESS\ and\ LPVOID}}
\DoxyCodeLine{00047\ \textcolor{keyword}{union\ }\mbox{\hyperlink{union_int2_ptr}{Int2Ptr}}\ \{}
\DoxyCodeLine{00048\ \ \ \ \ UINT\_PTR\ \mbox{\hyperlink{union_int2_ptr_a38a297bfdc9eb43a1b4a6d9f259773a2}{uip}};}
\DoxyCodeLine{00049\ \ \ \ \ \mbox{\hyperlink{dllmain_8cpp_acf9c20c2bdffd2b6a2870e833c78e71f}{LPVOID}}\ \mbox{\hyperlink{union_int2_ptr_a21a036e70565bd0c71f7d74a4588f4bf}{lpv}};}
\DoxyCodeLine{00050\ \};}
\DoxyCodeLine{00051\ }
\DoxyCodeLine{00052\ \textcolor{keyword}{inline}\ UINT\_PTR\ \mbox{\hyperlink{tbb__function__replacement_8h_a2ab2f99e398a3941dc55a7f30fa4260e}{Ptr2Addrint}}(\mbox{\hyperlink{dllmain_8cpp_acf9c20c2bdffd2b6a2870e833c78e71f}{LPVOID}}\ \mbox{\hyperlink{yyjson_8h_a26c622783fa717b24fe0bbd3e060f74a}{ptr}});}
\DoxyCodeLine{00053\ \textcolor{keyword}{inline}\ \mbox{\hyperlink{dllmain_8cpp_acf9c20c2bdffd2b6a2870e833c78e71f}{LPVOID}}\ \mbox{\hyperlink{tbb__function__replacement_8h_a5b2dbe6780d5d5b6ac3e54a194ca74ed}{Addrint2Ptr}}(UINT\_PTR\ \mbox{\hyperlink{yyjson_8h_a26c622783fa717b24fe0bbd3e060f74a}{ptr}});}
\DoxyCodeLine{00054\ }
\DoxyCodeLine{00055\ \textcolor{comment}{//\ The\ size\ of\ a\ trampoline\ region}}
\DoxyCodeLine{00056\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{unsigned}\ \mbox{\hyperlink{tbb__function__replacement_8h_a82a60fe36ebbc44d73608884254f1e28}{MAX\_PROBE\_SIZE}}\ =\ 32;}
\DoxyCodeLine{00057\ }
\DoxyCodeLine{00058\ \textcolor{comment}{//\ The\ size\ of\ a\ jump\ relative\ instruction\ "{}e9\ 00\ 00\ 00\ 00"{}}}
\DoxyCodeLine{00059\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{unsigned}\ \mbox{\hyperlink{tbb__function__replacement_8h_a0d512bb592f165a9125b8af0361e8d06}{SIZE\_OF\_RELJUMP}}\ =\ 5;}
\DoxyCodeLine{00060\ }
\DoxyCodeLine{00061\ \textcolor{comment}{//\ The\ size\ of\ jump\ RIP\ relative\ indirect\ "{}ff\ 25\ 00\ 00\ 00\ 00"{}}}
\DoxyCodeLine{00062\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{unsigned}\ \mbox{\hyperlink{tbb__function__replacement_8h_a2cac255948262c57ec2852f4ce5dad51}{SIZE\_OF\_INDJUMP}}\ =\ 6;}
\DoxyCodeLine{00063\ }
\DoxyCodeLine{00064\ \textcolor{comment}{//\ The\ size\ of\ address\ we\ put\ in\ the\ location\ (in\ Intel64)}}
\DoxyCodeLine{00065\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{unsigned}\ \mbox{\hyperlink{tbb__function__replacement_8h_a2f5fafb320d1f2dd693610c77d5e626f}{SIZE\_OF\_ADDRESS}}\ =\ 8;}
\DoxyCodeLine{00066\ }
\DoxyCodeLine{00067\ \textcolor{comment}{//\ The\ size\ limit\ (in\ bytes)\ for\ an\ opcode\ pattern\ to\ fit\ into\ a\ trampoline}}
\DoxyCodeLine{00068\ \textcolor{comment}{//\ There\ should\ be\ enough\ space\ left\ for\ a\ relative\ jump;\ +1\ is\ for\ the\ extra\ pattern\ byte.}}
\DoxyCodeLine{00069\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{unsigned}\ \mbox{\hyperlink{tbb__function__replacement_8h_a0196ecb573d3ca6a8802323568e18ee2}{MAX\_PATTERN\_SIZE}}\ =\ \mbox{\hyperlink{tbb__function__replacement_8h_a82a60fe36ebbc44d73608884254f1e28}{MAX\_PROBE\_SIZE}}\ -\/\ \mbox{\hyperlink{tbb__function__replacement_8h_a0d512bb592f165a9125b8af0361e8d06}{SIZE\_OF\_RELJUMP}}\ +\ 1;}
\DoxyCodeLine{00070\ }
\DoxyCodeLine{00071\ \textcolor{comment}{//\ The\ max\ distance\ covered\ in\ 32\ bits:\ 2\string^31\ -\/\ 1\ -\/\ C}}
\DoxyCodeLine{00072\ \textcolor{comment}{//\ where\ C\ should\ not\ be\ smaller\ than\ the\ size\ of\ a\ probe.}}
\DoxyCodeLine{00073\ \textcolor{comment}{//\ The\ latter\ is\ important\ to\ correctly\ handle\ "{}backward"{}\ jumps.}}
\DoxyCodeLine{00074\ \textcolor{keyword}{const}\ \_\_int64\ \mbox{\hyperlink{tbb__function__replacement_8h_a22cf38a34483f0fa1a4301ccb38e6b4e}{MAX\_DISTANCE}}\ =\ (((\_\_int64)1\ <<\ 31)\ -\/\ 1)\ -\/\ \mbox{\hyperlink{tbb__function__replacement_8h_a82a60fe36ebbc44d73608884254f1e28}{MAX\_PROBE\_SIZE}};}
\DoxyCodeLine{00075\ }
\DoxyCodeLine{00076\ \textcolor{comment}{//\ The\ maximum\ number\ of\ distinct\ buffers\ in\ memory}}
\DoxyCodeLine{00077\ \textcolor{keyword}{const}\ ptrdiff\_t\ \mbox{\hyperlink{tbb__function__replacement_8h_ae2815648cebaaeaacf55c77eda5a2874}{MAX\_NUM\_BUFFERS}}\ =\ 256;}
\DoxyCodeLine{00078\ }
\DoxyCodeLine{00079\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\_\_TBB\_function\_replacement\_H}}

\end{DoxyCode}
