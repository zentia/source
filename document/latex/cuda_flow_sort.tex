\chapter{Parallel Sort}
\hypertarget{cuda_flow_sort}{}\label{cuda_flow_sort}\index{Parallel Sort@{Parallel Sort}}
cuda\+Flow provides template methods to create parallel sort tasks on a CUDA GPU.\hypertarget{cuda_flow_sort_CUDAParallelSortIncludeTheHeader}{}\doxysection{\texorpdfstring{Include the Header}{Include the Header}}\label{cuda_flow_sort_CUDAParallelSortIncludeTheHeader}
You need to include the header file, {\ttfamily taskflow/cuda/algorithm/sort.hpp}, for creating a parallel-\/sort task.\hypertarget{cuda_flow_sort_cudaFlowSortARangeofItems}{}\doxysection{\texorpdfstring{Sort a Range of Items}{Sort a Range of Items}}\label{cuda_flow_sort_cudaFlowSortARangeofItems}
tf\+::cuda\+Flow\+::sort performs an in-\/place parallel sort over a range of elements specified by {\ttfamily \mbox{[}first, last)} using the given comparator. The following code sorts one million random integers in an increasing order on a GPU.


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{main-override-static_8c_a0240ac851181b84ac374872dc5434ee4}{N}}\ =\ 1000000;}
\DoxyCodeLine{\textcolor{keywordtype}{int}*\ \mbox{\hyperlink{benchmarks_2for__each_2for__each_8hpp_ad86cbaae2e3f21959301250e9f7c2701}{vec}}\ =\ \mbox{\hyperlink{namespacetf_ad289846c38e3f122e1315d906243fc8b}{tf::cuda\_malloc\_shared<int>}}(\mbox{\hyperlink{main-override-static_8c_a0240ac851181b84ac374872dc5434ee4}{N}});\ \ \textcolor{comment}{//\ vector}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{//\ initializes\ the\ data}}
\DoxyCodeLine{\textcolor{keywordflow}{for}(\textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}=0;\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}<\mbox{\hyperlink{main-override-static_8c_a0240ac851181b84ac374872dc5434ee4}{N}};\ \mbox{\hyperlink{benchmarks_2for__each_2for__each_8hpp_ad86cbaae2e3f21959301250e9f7c2701}{vec}}[\mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}++]=rand());}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{//\ create\ a\ cudaFlow\ of\ one\ task\ to\ perform\ parallel\ sort}}
\DoxyCodeLine{\mbox{\hyperlink{classtf_1_1cuda_flow}{tf::cudaFlow}}\ cf;}
\DoxyCodeLine{\mbox{\hyperlink{classtf_1_1cuda_task}{tf::cudaTask}}\ \mbox{\hyperlink{test__partitioner__whitebox_8h_a5c4cf3d37a4eee22275de22cb9619863}{task}}\ =\ cf.sort(}
\DoxyCodeLine{\ \ \mbox{\hyperlink{benchmarks_2for__each_2for__each_8hpp_ad86cbaae2e3f21959301250e9f7c2701}{vec}},\ \mbox{\hyperlink{benchmarks_2for__each_2for__each_8hpp_ad86cbaae2e3f21959301250e9f7c2701}{vec}}\ +\ \mbox{\hyperlink{main-override-static_8c_a0240ac851181b84ac374872dc5434ee4}{N}},\ []\_\_device\_\_(\textcolor{keywordtype}{int}\ \mbox{\hyperlink{_cwise__product_8cpp_ad2cbe4616e813eb9af81732dca777b24}{a}},\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{offscreen_8c_a846c9667e34d56c560bb7f0ac6e173f6}{b}})\ \{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{_cwise__product_8cpp_ad2cbe4616e813eb9af81732dca777b24}{a}}\ <\ \mbox{\hyperlink{offscreen_8c_a846c9667e34d56c560bb7f0ac6e173f6}{b}};\ \}}
\DoxyCodeLine{);}
\DoxyCodeLine{cf.offload();}
\DoxyCodeLine{}
\DoxyCodeLine{assert(std::is\_sorted(\mbox{\hyperlink{benchmarks_2for__each_2for__each_8hpp_ad86cbaae2e3f21959301250e9f7c2701}{vec}},\ \mbox{\hyperlink{benchmarks_2for__each_2for__each_8hpp_ad86cbaae2e3f21959301250e9f7c2701}{vec}}+\mbox{\hyperlink{main-override-static_8c_a0240ac851181b84ac374872dc5434ee4}{N}}));}

\end{DoxyCode}


You can specify a different comparator to tf\+::cuda\+Flow\+::sort to alter the sorting order. For example, the following code sorts one million random integers in an decreasing order on a GPU.


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{main-override-static_8c_a0240ac851181b84ac374872dc5434ee4}{N}}\ =\ 1000000;}
\DoxyCodeLine{\textcolor{keywordtype}{int}*\ \mbox{\hyperlink{benchmarks_2for__each_2for__each_8hpp_ad86cbaae2e3f21959301250e9f7c2701}{vec}}\ =\ \mbox{\hyperlink{namespacetf_ad289846c38e3f122e1315d906243fc8b}{tf::cuda\_malloc\_shared<int>}}(\mbox{\hyperlink{main-override-static_8c_a0240ac851181b84ac374872dc5434ee4}{N}});\ \ \textcolor{comment}{//\ vector}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{//\ initializes\ the\ data}}
\DoxyCodeLine{\textcolor{keywordflow}{for}(\textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}=0;\ \mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}<\mbox{\hyperlink{main-override-static_8c_a0240ac851181b84ac374872dc5434ee4}{N}};\ \mbox{\hyperlink{benchmarks_2for__each_2for__each_8hpp_ad86cbaae2e3f21959301250e9f7c2701}{vec}}[\mbox{\hyperlink{_bi_c_g_s_t_a_b__step__by__step_8cpp_acb559820d9ca11295b4500f179ef6392}{i}}++]=rand());}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{//\ create\ a\ cudaFlow\ of\ one\ task\ to\ perform\ parallel\ sort}}
\DoxyCodeLine{\mbox{\hyperlink{classtf_1_1cuda_flow}{tf::cudaFlow}}\ cf;}
\DoxyCodeLine{\mbox{\hyperlink{classtf_1_1cuda_task}{tf::cudaTask}}\ \mbox{\hyperlink{test__partitioner__whitebox_8h_a5c4cf3d37a4eee22275de22cb9619863}{task}}\ =\ cf.sort(}
\DoxyCodeLine{\ \ \mbox{\hyperlink{benchmarks_2for__each_2for__each_8hpp_ad86cbaae2e3f21959301250e9f7c2701}{vec}},\ \mbox{\hyperlink{benchmarks_2for__each_2for__each_8hpp_ad86cbaae2e3f21959301250e9f7c2701}{vec}}\ +\ \mbox{\hyperlink{main-override-static_8c_a0240ac851181b84ac374872dc5434ee4}{N}},\ []\ \_\_device\_\_\ (\textcolor{keywordtype}{int}\ \mbox{\hyperlink{_cwise__product_8cpp_ad2cbe4616e813eb9af81732dca777b24}{a}},\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{offscreen_8c_a846c9667e34d56c560bb7f0ac6e173f6}{b}})\ \{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{_cwise__product_8cpp_ad2cbe4616e813eb9af81732dca777b24}{a}}\ >\ \mbox{\hyperlink{offscreen_8c_a846c9667e34d56c560bb7f0ac6e173f6}{b}};\ \}}
\DoxyCodeLine{);}
\DoxyCodeLine{cf.offload();}
\DoxyCodeLine{}
\DoxyCodeLine{assert(std::is\_sorted(\mbox{\hyperlink{benchmarks_2for__each_2for__each_8hpp_ad86cbaae2e3f21959301250e9f7c2701}{vec}},\ \mbox{\hyperlink{benchmarks_2for__each_2for__each_8hpp_ad86cbaae2e3f21959301250e9f7c2701}{vec}}+\mbox{\hyperlink{main-override-static_8c_a0240ac851181b84ac374872dc5434ee4}{N}},\ [](\textcolor{keywordtype}{int}\ \mbox{\hyperlink{_cwise__product_8cpp_ad2cbe4616e813eb9af81732dca777b24}{a}},\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{offscreen_8c_a846c9667e34d56c560bb7f0ac6e173f6}{b}})\{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{_cwise__product_8cpp_ad2cbe4616e813eb9af81732dca777b24}{a}}\ >\ \mbox{\hyperlink{offscreen_8c_a846c9667e34d56c560bb7f0ac6e173f6}{b}};\ \}));}

\end{DoxyCode}
\hypertarget{cuda_flow_sort_cudaFlowSortKeyValueItems}{}\doxysection{\texorpdfstring{Sort a Range of Key-\/\+Value Items}{Sort a Range of Key-\/\+Value Items}}\label{cuda_flow_sort_cudaFlowSortKeyValueItems}
tf\+::cuda\+Flow\+::sort\+\_\+by\+\_\+key sorts a range of key-\/value items into ascending key order. If {\ttfamily i} and {\ttfamily j} are any two valid iterators in {\ttfamily \mbox{[}k\+\_\+first, k\+\_\+last)} such that {\ttfamily i} precedes {\ttfamily j}, and {\ttfamily p} and {\ttfamily q} are iterators in {\ttfamily \mbox{[}v\+\_\+first, v\+\_\+first + (k\+\_\+last -\/ k\+\_\+first))} corresponding to {\ttfamily i} and {\ttfamily j} respectively, then {\ttfamily comp(\texorpdfstring{$\ast$}{*}j, \texorpdfstring{$\ast$}{*}i)} evaluates to {\ttfamily false}. The following example sorts a range of items into ascending key order and swaps their corresponding values\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{main-override-static_8c_a0240ac851181b84ac374872dc5434ee4}{N}}\ =\ 4;}
\DoxyCodeLine{\textcolor{keyword}{auto}\ \mbox{\hyperlink{benchmarks_2for__each_2for__each_8hpp_ad86cbaae2e3f21959301250e9f7c2701}{vec}}\ =\ \mbox{\hyperlink{namespacetf_ad289846c38e3f122e1315d906243fc8b}{tf::cuda\_malloc\_shared<int>}}(\mbox{\hyperlink{main-override-static_8c_a0240ac851181b84ac374872dc5434ee4}{N}});\ \ \textcolor{comment}{//\ keys}}
\DoxyCodeLine{\textcolor{keyword}{auto}\ idx\ =\ \mbox{\hyperlink{namespacetf_ad289846c38e3f122e1315d906243fc8b}{tf::cuda\_malloc\_shared<int>}}(\mbox{\hyperlink{main-override-static_8c_a0240ac851181b84ac374872dc5434ee4}{N}});\ \ \textcolor{comment}{//\ values}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{//\ initializes\ the\ data}}
\DoxyCodeLine{\mbox{\hyperlink{benchmarks_2for__each_2for__each_8hpp_ad86cbaae2e3f21959301250e9f7c2701}{vec}}[0]\ =\ 1,\ \mbox{\hyperlink{benchmarks_2for__each_2for__each_8hpp_ad86cbaae2e3f21959301250e9f7c2701}{vec}}[1]\ =\ 4,\ \mbox{\hyperlink{benchmarks_2for__each_2for__each_8hpp_ad86cbaae2e3f21959301250e9f7c2701}{vec}}[2]\ =\ -\/5,\ \mbox{\hyperlink{benchmarks_2for__each_2for__each_8hpp_ad86cbaae2e3f21959301250e9f7c2701}{vec}}[3]\ =\ 2;}
\DoxyCodeLine{idx[0]\ =\ 0,\ idx[1]\ =\ 1,\ idx[2]\ =\ 2,\ \ idx[3]\ =\ 3;}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{//\ sort\ keys\ (vec)\ and\ swap\ their\ corresponding\ values\ (idx)}}
\DoxyCodeLine{\mbox{\hyperlink{classtf_1_1cuda_flow}{tf::cudaFlow}}\ cf;}
\DoxyCodeLine{cf.sort\_by\_key(\mbox{\hyperlink{benchmarks_2for__each_2for__each_8hpp_ad86cbaae2e3f21959301250e9f7c2701}{vec}},\ \mbox{\hyperlink{benchmarks_2for__each_2for__each_8hpp_ad86cbaae2e3f21959301250e9f7c2701}{vec}}+\mbox{\hyperlink{main-override-static_8c_a0240ac851181b84ac374872dc5434ee4}{N}},\ idx,\ []\ \_\_device\_\_\ (\textcolor{keywordtype}{int}\ \mbox{\hyperlink{_cwise__product_8cpp_ad2cbe4616e813eb9af81732dca777b24}{a}},\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{offscreen_8c_a846c9667e34d56c560bb7f0ac6e173f6}{b}})\ \{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{_cwise__product_8cpp_ad2cbe4616e813eb9af81732dca777b24}{a}}\ <\ \mbox{\hyperlink{offscreen_8c_a846c9667e34d56c560bb7f0ac6e173f6}{b}};\ \});}
\DoxyCodeLine{cf.offload();}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{//\ now\ vec\ =\ \{-\/5,\ 1,\ 2,\ 4\}}}
\DoxyCodeLine{\textcolor{comment}{//\ now\ idx\ =\ \{\ 2,\ 0,\ 3,\ 1\}}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{//\ deletes\ the\ memory}}
\DoxyCodeLine{\mbox{\hyperlink{namespacetf_ac7a8fe7456b888d6072ba94783c5003c}{tf::cuda\_free}}(\mbox{\hyperlink{sugar_8h_aaadc06b5dac8070de2c8677210967bdb}{buffer}});}
\DoxyCodeLine{\mbox{\hyperlink{namespacetf_ac7a8fe7456b888d6072ba94783c5003c}{tf::cuda\_free}}(\mbox{\hyperlink{benchmarks_2for__each_2for__each_8hpp_ad86cbaae2e3f21959301250e9f7c2701}{vec}});}
\DoxyCodeLine{\mbox{\hyperlink{namespacetf_ac7a8fe7456b888d6072ba94783c5003c}{tf::cuda\_free}}(idx);}

\end{DoxyCode}


While you can capture the values into the lambda and sort them indirectly using plain tf\+::cuda\+Flow\+::sort, this organization will result in frequent and costly access to the global memory. For example, we can sort {\ttfamily idx} indirectly using the captured keys in {\ttfamily vec\+:} 


\begin{DoxyCode}{0}
\DoxyCodeLine{cf.sort(idx,\ idx+\mbox{\hyperlink{main-override-static_8c_a0240ac851181b84ac374872dc5434ee4}{N}},\ [\mbox{\hyperlink{benchmarks_2for__each_2for__each_8hpp_ad86cbaae2e3f21959301250e9f7c2701}{vec}}]\ \_\_device\_\_\ (\textcolor{keywordtype}{int}\ \mbox{\hyperlink{_cwise__product_8cpp_ad2cbe4616e813eb9af81732dca777b24}{a}},\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{offscreen_8c_a846c9667e34d56c560bb7f0ac6e173f6}{b}})\ \{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{benchmarks_2for__each_2for__each_8hpp_ad86cbaae2e3f21959301250e9f7c2701}{vec}}[\mbox{\hyperlink{_cwise__product_8cpp_ad2cbe4616e813eb9af81732dca777b24}{a}}]\ <\ \mbox{\hyperlink{benchmarks_2for__each_2for__each_8hpp_ad86cbaae2e3f21959301250e9f7c2701}{vec}}[\mbox{\hyperlink{offscreen_8c_a846c9667e34d56c560bb7f0ac6e173f6}{b}}];\ \});}

\end{DoxyCode}


The comparator here will frequently access the global memory of {\ttfamily vec}, resulting in high memory latency. Instead, you should use tf\+::cuda\+Flow\+::sort\+\_\+by\+\_\+key that has been optimized for this purpose.\hypertarget{cuda_flow_sort_cudaFlowSortMiscellaneousItems}{}\doxysection{\texorpdfstring{Miscellaneous Items}{Miscellaneous Items}}\label{cuda_flow_sort_cudaFlowSortMiscellaneousItems}
Parallel sort algorithms are also available in \doxylink{classtf_1_1cuda_flow_capturer}{tf\+::cuda\+Flow\+Capturer} with the same API. 