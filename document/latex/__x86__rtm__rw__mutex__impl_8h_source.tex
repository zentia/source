\doxysection{\+\_\+x86\+\_\+rtm\+\_\+rw\+\_\+mutex\+\_\+impl.\+h}
\hypertarget{__x86__rtm__rw__mutex__impl_8h_source}{}\label{__x86__rtm__rw__mutex__impl_8h_source}\index{external/taskflow/3rd-\/party/tbb/include/tbb/internal/\_x86\_rtm\_rw\_mutex\_impl.h@{external/taskflow/3rd-\/party/tbb/include/tbb/internal/\_x86\_rtm\_rw\_mutex\_impl.h}}
\mbox{\hyperlink{__x86__rtm__rw__mutex__impl_8h}{浏览该文件的文档.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{/*}}
\DoxyCodeLine{00002\ \textcolor{comment}{\ \ \ \ Copyright\ (c)\ 2005-\/2020\ Intel\ Corporation}}
\DoxyCodeLine{00003\ \textcolor{comment}{}}
\DoxyCodeLine{00004\ \textcolor{comment}{\ \ \ \ Licensed\ under\ the\ Apache\ License,\ Version\ 2.0\ (the\ "{}License"{});}}
\DoxyCodeLine{00005\ \textcolor{comment}{\ \ \ \ you\ may\ not\ use\ this\ file\ except\ in\ compliance\ with\ the\ License.}}
\DoxyCodeLine{00006\ \textcolor{comment}{\ \ \ \ You\ may\ obtain\ a\ copy\ of\ the\ License\ at}}
\DoxyCodeLine{00007\ \textcolor{comment}{}}
\DoxyCodeLine{00008\ \textcolor{comment}{\ \ \ \ \ \ \ \ http://www.apache.org/licenses/LICENSE-\/2.0}}
\DoxyCodeLine{00009\ \textcolor{comment}{}}
\DoxyCodeLine{00010\ \textcolor{comment}{\ \ \ \ Unless\ required\ by\ applicable\ law\ or\ agreed\ to\ in\ writing,\ software}}
\DoxyCodeLine{00011\ \textcolor{comment}{\ \ \ \ distributed\ under\ the\ License\ is\ distributed\ on\ an\ "{}AS\ IS"{}\ BASIS,}}
\DoxyCodeLine{00012\ \textcolor{comment}{\ \ \ \ WITHOUT\ WARRANTIES\ OR\ CONDITIONS\ OF\ ANY\ KIND,\ either\ express\ or\ implied.}}
\DoxyCodeLine{00013\ \textcolor{comment}{\ \ \ \ See\ the\ License\ for\ the\ specific\ language\ governing\ permissions\ and}}
\DoxyCodeLine{00014\ \textcolor{comment}{\ \ \ \ limitations\ under\ the\ License.}}
\DoxyCodeLine{00015\ \textcolor{comment}{*/}}
\DoxyCodeLine{00016\ }
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#ifndef\ \_\_TBB\_\_x86\_rtm\_rw\_mutex\_impl\_H}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#define\ \_\_TBB\_\_x86\_rtm\_rw\_mutex\_impl\_H}}
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#ifndef\ \_\_TBB\_spin\_rw\_mutex\_H}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#error\ Do\ not\ \#include\ this\ internal\ file\ directly;\ use\ public\ TBB\ headers\ instead.}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00023\ }
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#if\ \_\_TBB\_TSX\_AVAILABLE}}
\DoxyCodeLine{00025\ }
\DoxyCodeLine{00026\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{tbb__stddef_8h}{../tbb\_stddef.h}}"{}}}
\DoxyCodeLine{00027\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{tbb__machine_8h}{../tbb\_machine.h}}"{}}}
\DoxyCodeLine{00028\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{tbb__profiling_8h}{../tbb\_profiling.h}}"{}}}
\DoxyCodeLine{00029\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{spin__rw__mutex_8h}{../spin\_rw\_mutex.h}}"{}}}
\DoxyCodeLine{00030\ }
\DoxyCodeLine{00031\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespacetbb}{tbb}}\ \{}
\DoxyCodeLine{00032\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespacetbb_1_1interface8}{interface8}}\ \{}
\DoxyCodeLine{00033\ \textcolor{keyword}{namespace\ }internal\ \{}
\DoxyCodeLine{00034\ }
\DoxyCodeLine{00035\ \textcolor{keyword}{enum}\ RTM\_type\ \{}
\DoxyCodeLine{00036\ \ \ \ \ RTM\_not\_in\_mutex,}
\DoxyCodeLine{00037\ \ \ \ \ RTM\_transacting\_reader,}
\DoxyCodeLine{00038\ \ \ \ \ RTM\_transacting\_writer,}
\DoxyCodeLine{00039\ \ \ \ \ RTM\_real\_reader,}
\DoxyCodeLine{00040\ \ \ \ \ RTM\_real\_writer}
\DoxyCodeLine{00041\ \};}
\DoxyCodeLine{00042\ }
\DoxyCodeLine{00043\ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{long}\ speculation\_granularity\ =\ 64;}
\DoxyCodeLine{00044\ }
\DoxyCodeLine{00046\ \textcolor{comment}{//\ \ writer-\/preference}}
\DoxyCodeLine{00048\ \textcolor{keyword}{class\ }x86\_rtm\_rw\_mutex:\ \textcolor{keyword}{private}\ \mbox{\hyperlink{namespacetbb_a6cc3d02744cab8ac389919806d47e417}{spin\_rw\_mutex}}\ \{}
\DoxyCodeLine{00049\ \textcolor{preprocessor}{\#if\ \_\_TBB\_USE\_X86\_RTM\_RW\_MUTEX\ ||\ \_\_TBB\_GCC\_VERSION\ <\ 40000}}
\DoxyCodeLine{00050\ \textcolor{comment}{//\ bug\ in\ gcc\ 3.x.x\ causes\ syntax\ error\ in\ spite\ of\ the\ friend\ declaration\ below.}}
\DoxyCodeLine{00051\ \textcolor{comment}{//\ Make\ the\ scoped\_lock\ public\ in\ that\ case.}}
\DoxyCodeLine{00052\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00053\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00054\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00055\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00056\ \ \ \ \ \textcolor{keyword}{friend}\ \textcolor{keyword}{class\ }interface7::internal::padded\_mutex<x86\_rtm\_rw\_mutex,\mbox{\hyperlink{yyjson_8h_a41f9c5fb8b08eb5dc3edce4dcb37fee7}{true}}>;}
\DoxyCodeLine{00057\ \ \ \ \ \textcolor{keyword}{class\ }scoped\_lock;\ \ \ \textcolor{comment}{//\ should\ be\ private}}
\DoxyCodeLine{00058\ \ \ \ \ \textcolor{keyword}{friend}\ \textcolor{keyword}{class\ }scoped\_lock;}
\DoxyCodeLine{00059\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00061\ }
\DoxyCodeLine{00063\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{tbb__stddef_8h_a7a1df7e6f83415a1624716541dc4b741}{\_\_TBB\_EXPORTED\_METHOD}}\ internal\_construct();}
\DoxyCodeLine{00064\ }
\DoxyCodeLine{00066\ \ \ \ \ \textcolor{comment}{//\ only\_speculate\ ==\ true\ if\ we're\ doing\ a\ try\_lock,\ else\ false.}}
\DoxyCodeLine{00067\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{tbb__stddef_8h_a7a1df7e6f83415a1624716541dc4b741}{\_\_TBB\_EXPORTED\_METHOD}}\ internal\_acquire\_writer(x86\_rtm\_rw\_mutex::scoped\_lock\&,\ \textcolor{keywordtype}{bool}\ only\_speculate=\textcolor{keyword}{false});}
\DoxyCodeLine{00068\ }
\DoxyCodeLine{00070\ \ \ \ \ \textcolor{comment}{//\ only\_speculate\ ==\ true\ if\ we're\ doing\ a\ try\_lock,\ else\ false.}}
\DoxyCodeLine{00071\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{tbb__stddef_8h_a7a1df7e6f83415a1624716541dc4b741}{\_\_TBB\_EXPORTED\_METHOD}}\ internal\_acquire\_reader(x86\_rtm\_rw\_mutex::scoped\_lock\&,\ \textcolor{keywordtype}{bool}\ only\_speculate=\textcolor{keyword}{false});}
\DoxyCodeLine{00072\ }
\DoxyCodeLine{00074\ \ \ \ \ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{tbb__stddef_8h_a7a1df7e6f83415a1624716541dc4b741}{\_\_TBB\_EXPORTED\_METHOD}}\ internal\_upgrade(\ x86\_rtm\_rw\_mutex::scoped\_lock\&\ );}
\DoxyCodeLine{00075\ }
\DoxyCodeLine{00077\ \ \ \ \ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{tbb__stddef_8h_a7a1df7e6f83415a1624716541dc4b741}{\_\_TBB\_EXPORTED\_METHOD}}\ internal\_downgrade(\ x86\_rtm\_rw\_mutex::scoped\_lock\&\ );}
\DoxyCodeLine{00078\ }
\DoxyCodeLine{00080\ \ \ \ \ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{tbb__stddef_8h_a7a1df7e6f83415a1624716541dc4b741}{\_\_TBB\_EXPORTED\_METHOD}}\ internal\_try\_acquire\_writer(\ x86\_rtm\_rw\_mutex::scoped\_lock\&\ );}
\DoxyCodeLine{00081\ }
\DoxyCodeLine{00083\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{tbb__stddef_8h_a7a1df7e6f83415a1624716541dc4b741}{\_\_TBB\_EXPORTED\_METHOD}}\ internal\_release(\ x86\_rtm\_rw\_mutex::scoped\_lock\&\ );}
\DoxyCodeLine{00084\ }
\DoxyCodeLine{00085\ \ \ \ \ \textcolor{keyword}{static}\ x86\_rtm\_rw\_mutex*\ internal\_get\_mutex(\ \textcolor{keyword}{const}\ spin\_rw\_mutex::scoped\_lock\&\ \mbox{\hyperlink{ittnotify__static_8h_a46e8be2e3aadb2f6ee62e762a36b9243}{lock}}\ )}
\DoxyCodeLine{00086\ \ \ \ \ \{}
\DoxyCodeLine{00087\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{static\_cast<}x86\_rtm\_rw\_mutex*\textcolor{keyword}{>}(\ \mbox{\hyperlink{ittnotify__static_8h_a46e8be2e3aadb2f6ee62e762a36b9243}{lock}}.mutex\ );}
\DoxyCodeLine{00088\ \ \ \ \ \}}
\DoxyCodeLine{00089\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ internal\_set\_mutex(\ spin\_rw\_mutex::scoped\_lock\&\ \mbox{\hyperlink{ittnotify__static_8h_a46e8be2e3aadb2f6ee62e762a36b9243}{lock}},\ spin\_rw\_mutex*\ mtx\ )}
\DoxyCodeLine{00090\ \ \ \ \ \{}
\DoxyCodeLine{00091\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{ittnotify__static_8h_a46e8be2e3aadb2f6ee62e762a36b9243}{lock}}.mutex\ =\ mtx;}
\DoxyCodeLine{00092\ \ \ \ \ \}}
\DoxyCodeLine{00094\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00096\ \ \ \ \ x86\_rtm\_rw\_mutex()\ \{}
\DoxyCodeLine{00097\ \ \ \ \ \ \ \ \ w\_flag\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00098\ \textcolor{preprocessor}{\#if\ TBB\_USE\_THREADING\_TOOLS}}
\DoxyCodeLine{00099\ \ \ \ \ \ \ \ \ internal\_construct();}
\DoxyCodeLine{00100\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00101\ \ \ \ \ \}}
\DoxyCodeLine{00102\ }
\DoxyCodeLine{00103\ \textcolor{preprocessor}{\#if\ TBB\_USE\_ASSERT}}
\DoxyCodeLine{00105\ \ \ \ \ \string~x86\_rtm\_rw\_mutex()\ \{\}}
\DoxyCodeLine{00106\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{/*\ TBB\_USE\_ASSERT\ */}\textcolor{preprocessor}{}}
\DoxyCodeLine{00107\ }
\DoxyCodeLine{00108\ \ \ \ \ \textcolor{comment}{//\ Mutex\ traits}}
\DoxyCodeLine{00109\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{bool}\ is\_rw\_mutex\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00110\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{bool}\ is\_recursive\_mutex\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00111\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{bool}\ is\_fair\_mutex\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00112\ }
\DoxyCodeLine{00113\ \textcolor{preprocessor}{\#if\ \_\_TBB\_USE\_X86\_RTM\_RW\_MUTEX\ ||\ \_\_TBB\_GCC\_VERSION\ <\ 40000}}
\DoxyCodeLine{00114\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00115\ \ \ \ \ \textcolor{comment}{//\ by\ default\ we\ will\ not\ provide\ the\ scoped\_lock\ interface.\ \ The\ user}}
\DoxyCodeLine{00116\ \ \ \ \ \textcolor{comment}{//\ should\ use\ the\ padded\ version\ of\ the\ mutex.\ \ scoped\_lock\ is\ used\ in}}
\DoxyCodeLine{00117\ \ \ \ \ \textcolor{comment}{//\ padded\_mutex\ template.}}
\DoxyCodeLine{00118\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00119\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00121\ }
\DoxyCodeLine{00123\ \ \ \ \ \textcolor{comment}{//\ Speculation-\/enabled\ scoped\ lock\ for\ spin\_rw\_mutex}}
\DoxyCodeLine{00124\ \ \ \ \ \textcolor{comment}{//\ The\ idea\ is\ to\ be\ able\ to\ reuse\ the\ acquire/release\ methods\ of\ spin\_rw\_mutex}}
\DoxyCodeLine{00125\ \ \ \ \ \textcolor{comment}{//\ and\ its\ scoped\ lock\ wherever\ possible.\ \ The\ only\ way\ to\ use\ a\ speculative\ lock\ is\ to\ use}}
\DoxyCodeLine{00126\ \ \ \ \ \textcolor{comment}{//\ a\ scoped\_lock.\ (because\ transaction\_state\ must\ be\ local)}}
\DoxyCodeLine{00127\ }
\DoxyCodeLine{00128\ \ \ \ \ \textcolor{keyword}{class\ }scoped\_lock\ :\ tbb::internal::no\_copy\ \{}
\DoxyCodeLine{00129\ \ \ \ \ \ \ \ \ \textcolor{keyword}{friend}\ \textcolor{keyword}{class\ }x86\_rtm\_rw\_mutex;}
\DoxyCodeLine{00130\ \ \ \ \ \ \ \ \ spin\_rw\_mutex::scoped\_lock\ my\_scoped\_lock;}
\DoxyCodeLine{00131\ }
\DoxyCodeLine{00132\ \ \ \ \ \ \ \ \ RTM\_type\ transaction\_state;}
\DoxyCodeLine{00133\ }
\DoxyCodeLine{00134\ \ \ \ \ \textcolor{keyword}{public}:}
\DoxyCodeLine{00136\ }
\DoxyCodeLine{00137\ \ \ \ \ \ \ \ \ scoped\_lock()\ :\ my\_scoped\_lock(),\ transaction\_state(RTM\_not\_in\_mutex)\ \{}
\DoxyCodeLine{00138\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00139\ }
\DoxyCodeLine{00141\ \ \ \ \ \ \ \ \ scoped\_lock(\ x86\_rtm\_rw\_mutex\&\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}},\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{json_2write__and__read_8hpp_a8d72d49ed34d37da786334a55f22b909}{write}}\ =\ \textcolor{keyword}{true}\ )\ :\ my\_scoped\_lock(),}
\DoxyCodeLine{00142\ \ \ \ \ \ \ \ \ \ \ \ \ transaction\_state(RTM\_not\_in\_mutex)\ \{}
\DoxyCodeLine{00143\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacetbb_adb86d08473679d6fe0eabcdc766ffe3aaa92646b4dc7618530d3a9f51dd10a418}{acquire}}(\mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}},\ \mbox{\hyperlink{json_2write__and__read_8hpp_a8d72d49ed34d37da786334a55f22b909}{write}});}
\DoxyCodeLine{00144\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00145\ }
\DoxyCodeLine{00147\ \ \ \ \ \ \ \ \ \string~scoped\_lock()\ \{}
\DoxyCodeLine{00148\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(transaction\_state\ !=\ RTM\_not\_in\_mutex)\ \mbox{\hyperlink{namespacetbb_adb86d08473679d6fe0eabcdc766ffe3aa412563418e657114a102db610f726632}{release}}();}
\DoxyCodeLine{00149\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00150\ }
\DoxyCodeLine{00152\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{namespacetbb_adb86d08473679d6fe0eabcdc766ffe3aaa92646b4dc7618530d3a9f51dd10a418}{acquire}}(\ x86\_rtm\_rw\_mutex\&\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}},\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{json_2write__and__read_8hpp_a8d72d49ed34d37da786334a55f22b909}{write}}\ =\ \textcolor{keyword}{true}\ )\ \{}
\DoxyCodeLine{00153\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(\ \mbox{\hyperlink{json_2write__and__read_8hpp_a8d72d49ed34d37da786334a55f22b909}{write}}\ )\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}.internal\_acquire\_writer(*\textcolor{keyword}{this});}
\DoxyCodeLine{00154\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \ \ \ \ \ \ \ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}.internal\_acquire\_reader(*\textcolor{keyword}{this});}
\DoxyCodeLine{00155\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00156\ }
\DoxyCodeLine{00158\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{namespacetbb_adb86d08473679d6fe0eabcdc766ffe3aa412563418e657114a102db610f726632}{release}}()\ \{}
\DoxyCodeLine{00159\ \ \ \ \ \ \ \ \ \ \ \ \ x86\_rtm\_rw\_mutex*\ \mbox{\hyperlink{harness__graph_8h_a7066db3b13dac6171efe89e7c49eb0d0}{mutex}}\ =\ x86\_rtm\_rw\_mutex::internal\_get\_mutex(my\_scoped\_lock);}
\DoxyCodeLine{00160\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{tbb__stddef_8h_a7b58d28a34a1717e2ddb591f00658b10}{\_\_TBB\_ASSERT}}(\ \mbox{\hyperlink{harness__graph_8h_a7066db3b13dac6171efe89e7c49eb0d0}{mutex}},\ \textcolor{stringliteral}{"{}lock\ is\ not\ acquired"{}}\ );}
\DoxyCodeLine{00161\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{tbb__stddef_8h_a7b58d28a34a1717e2ddb591f00658b10}{\_\_TBB\_ASSERT}}(\ transaction\_state!=RTM\_not\_in\_mutex,\ \textcolor{stringliteral}{"{}lock\ is\ not\ acquired"{}}\ );}
\DoxyCodeLine{00162\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{harness__graph_8h_a7066db3b13dac6171efe89e7c49eb0d0}{mutex}}-\/>internal\_release(*\textcolor{keyword}{this});}
\DoxyCodeLine{00163\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00164\ }
\DoxyCodeLine{00166\ }
\DoxyCodeLine{00167\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ upgrade\_to\_writer()\ \{}
\DoxyCodeLine{00168\ \ \ \ \ \ \ \ \ \ \ \ \ x86\_rtm\_rw\_mutex*\ \mbox{\hyperlink{harness__graph_8h_a7066db3b13dac6171efe89e7c49eb0d0}{mutex}}\ =\ x86\_rtm\_rw\_mutex::internal\_get\_mutex(my\_scoped\_lock);}
\DoxyCodeLine{00169\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{tbb__stddef_8h_a7b58d28a34a1717e2ddb591f00658b10}{\_\_TBB\_ASSERT}}(\ \mbox{\hyperlink{harness__graph_8h_a7066db3b13dac6171efe89e7c49eb0d0}{mutex}},\ \textcolor{stringliteral}{"{}lock\ is\ not\ acquired"{}}\ );}
\DoxyCodeLine{00170\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (transaction\_state\ ==\ RTM\_transacting\_writer\ ||\ transaction\_state\ ==\ RTM\_real\_writer)}
\DoxyCodeLine{00171\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};\ \textcolor{comment}{//\ Already\ a\ writer}}
\DoxyCodeLine{00172\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{harness__graph_8h_a7066db3b13dac6171efe89e7c49eb0d0}{mutex}}-\/>internal\_upgrade(*\textcolor{keyword}{this});}
\DoxyCodeLine{00173\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00174\ }
\DoxyCodeLine{00176\ }
\DoxyCodeLine{00177\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ downgrade\_to\_reader()\ \{}
\DoxyCodeLine{00178\ \ \ \ \ \ \ \ \ \ \ \ \ x86\_rtm\_rw\_mutex*\ \mbox{\hyperlink{harness__graph_8h_a7066db3b13dac6171efe89e7c49eb0d0}{mutex}}\ =\ x86\_rtm\_rw\_mutex::internal\_get\_mutex(my\_scoped\_lock);}
\DoxyCodeLine{00179\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{tbb__stddef_8h_a7b58d28a34a1717e2ddb591f00658b10}{\_\_TBB\_ASSERT}}(\ \mbox{\hyperlink{harness__graph_8h_a7066db3b13dac6171efe89e7c49eb0d0}{mutex}},\ \textcolor{stringliteral}{"{}lock\ is\ not\ acquired"{}}\ );}
\DoxyCodeLine{00180\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (transaction\_state\ ==\ RTM\_transacting\_reader\ ||\ transaction\_state\ ==\ RTM\_real\_reader)}
\DoxyCodeLine{00181\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};\ \textcolor{comment}{//\ Already\ a\ reader}}
\DoxyCodeLine{00182\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{harness__graph_8h_a7066db3b13dac6171efe89e7c49eb0d0}{mutex}}-\/>internal\_downgrade(*\textcolor{keyword}{this});}
\DoxyCodeLine{00183\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00184\ }
\DoxyCodeLine{00186\ }
\DoxyCodeLine{00187\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ try\_acquire(\ x86\_rtm\_rw\_mutex\&\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}},\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{json_2write__and__read_8hpp_a8d72d49ed34d37da786334a55f22b909}{write}}\ =\ \textcolor{keyword}{true}\ )\ \{}
\DoxyCodeLine{00188\ \textcolor{preprocessor}{\#if\ TBB\_USE\_ASSERT}}
\DoxyCodeLine{00189\ \ \ \ \ \ \ \ \ \ \ \ \ x86\_rtm\_rw\_mutex*\ \mbox{\hyperlink{harness__graph_8h_a7066db3b13dac6171efe89e7c49eb0d0}{mutex}}\ =\ x86\_rtm\_rw\_mutex::internal\_get\_mutex(my\_scoped\_lock);}
\DoxyCodeLine{00190\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{tbb__stddef_8h_a7b58d28a34a1717e2ddb591f00658b10}{\_\_TBB\_ASSERT}}(\ !\mbox{\hyperlink{harness__graph_8h_a7066db3b13dac6171efe89e7c49eb0d0}{mutex}},\ \textcolor{stringliteral}{"{}lock\ is\ already\ acquired"{}}\ );}
\DoxyCodeLine{00191\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00192\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ have\ to\ assign\ m\ to\ our\ mutex.}}
\DoxyCodeLine{00193\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ cannot\ set\ the\ mutex,\ because\ try\_acquire\ in\ spin\_rw\_mutex\ depends\ on\ it\ being\ NULL.}}
\DoxyCodeLine{00194\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(\mbox{\hyperlink{json_2write__and__read_8hpp_a8d72d49ed34d37da786334a55f22b909}{write}})\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}.internal\_try\_acquire\_writer(*\textcolor{keyword}{this});}
\DoxyCodeLine{00195\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ speculatively\ acquire\ the\ lock.\ \ If\ this\ fails,\ do\ try\_acquire\ on\ the\ spin\_rw\_mutex.}}
\DoxyCodeLine{00196\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}}.internal\_acquire\_reader(*\textcolor{keyword}{this},\ \textcolor{comment}{/*only\_speculate=*/}\textcolor{keyword}{true});}
\DoxyCodeLine{00197\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(transaction\_state\ ==\ RTM\_transacting\_reader)\ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00198\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(\ my\_scoped\_lock.try\_acquire(\mbox{\hyperlink{_angle_axis__mimic__euler_8cpp_ab3cd915d758008bd19d0f2428fbb354a}{m}},\ \textcolor{keyword}{false}))\ \{}
\DoxyCodeLine{00199\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ transaction\_state\ =\ RTM\_real\_reader;}
\DoxyCodeLine{00200\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00201\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00202\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00203\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00204\ }
\DoxyCodeLine{00205\ \ \ \ \ \ \ \ \ \};\ \ \textcolor{comment}{//\ class\ x86\_rtm\_rw\_mutex::scoped\_lock}}
\DoxyCodeLine{00206\ }
\DoxyCodeLine{00207\ \ \ \ \ \textcolor{comment}{//\ ISO\ C++0x\ compatibility\ methods\ not\ provided\ because\ we\ cannot\ maintain}}
\DoxyCodeLine{00208\ \ \ \ \ \textcolor{comment}{//\ state\ about\ whether\ a\ thread\ is\ in\ a\ transaction.}}
\DoxyCodeLine{00209\ }
\DoxyCodeLine{00210\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00211\ \ \ \ \ \textcolor{keywordtype}{char}\ pad[speculation\_granularity-\/\textcolor{keyword}{sizeof}(\mbox{\hyperlink{namespacetbb_a6cc3d02744cab8ac389919806d47e417}{spin\_rw\_mutex}})];\ \textcolor{comment}{//\ padding}}
\DoxyCodeLine{00212\ }
\DoxyCodeLine{00213\ \ \ \ \ \textcolor{comment}{//\ If\ true,\ writer\ holds\ the\ spin\_rw\_mutex.}}
\DoxyCodeLine{00214\ \ \ \ \ tbb::atomic<bool>\ w\_flag;\ \ \textcolor{comment}{//\ want\ this\ on\ a\ separate\ cache\ line}}
\DoxyCodeLine{00215\ }
\DoxyCodeLine{00216\ \};\ \ \textcolor{comment}{//\ x86\_rtm\_rw\_mutex}}
\DoxyCodeLine{00217\ }
\DoxyCodeLine{00218\ \}\ \ \textcolor{comment}{//\ namespace\ internal}}
\DoxyCodeLine{00219\ \}\ \ \textcolor{comment}{//\ namespace\ interface8}}
\DoxyCodeLine{00220\ \}\ \ \textcolor{comment}{//\ namespace\ tbb}}
\DoxyCodeLine{00221\ }
\DoxyCodeLine{00222\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{/*\ \_\_TBB\_TSX\_AVAILABLE\ */}\textcolor{preprocessor}{}}
\DoxyCodeLine{00223\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{/*\ \_\_TBB\_\_x86\_rtm\_rw\_mutex\_impl\_H\ */}\textcolor{preprocessor}{}}

\end{DoxyCode}
