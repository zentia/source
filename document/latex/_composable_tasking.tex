\doxysection{Composable Tasking}
\hypertarget{_composable_tasking}{}\label{_composable_tasking}\index{Composable Tasking@{Composable Tasking}}
Composition is a key to improve the programmability of a complex workflow. This chapter describes how to create a large parallel graph through composition of modular and reusable blocks that are easier to optimize.\hypertarget{_composable_tasking_ComposeATaskflow}{}\doxysubsection{\texorpdfstring{Compose a Taskflow}{Compose a Taskflow}}\label{_composable_tasking_ComposeATaskflow}
\doxylink{bench__gemm_8cpp_addc86e8508f14411ec98f521c520f875}{A} powerful feature of \doxylink{classtf_1_1_taskflow}{tf\+::\+Taskflow} is its {\itshape composable} interface. You can break down a large parallel workload into smaller pieces each designed to run a specific task dependency graph. This largely facilitates the {\itshape modularity} of writing a parallel task program.


\begin{DoxyCode}{0}
\DoxyCodeLine{\ 1:\ \textcolor{comment}{//\ f1\ has\ three\ independent\ tasks}}
\DoxyCodeLine{\ 2:\ \mbox{\hyperlink{classtf_1_1_taskflow}{tf::Taskflow}}\ \mbox{\hyperlink{parallel__graph__pipeline_8cpp_a20ea9116f00e19915f910ca726f7518f}{f1}};}
\DoxyCodeLine{\ 3:\ \mbox{\hyperlink{parallel__graph__pipeline_8cpp_a20ea9116f00e19915f910ca726f7518f}{f1}}.name(\textcolor{stringliteral}{"{}F1"{}});}
\DoxyCodeLine{\ 4:\ \mbox{\hyperlink{classtf_1_1_task}{tf::Task}}\ f1A\ =\ \mbox{\hyperlink{parallel__graph__pipeline_8cpp_a20ea9116f00e19915f910ca726f7518f}{f1}}.emplace([\&]()\{\ std::cout\ <<\ \textcolor{stringliteral}{"{}F1\ TaskA\(\backslash\)n"{}};\ \});}
\DoxyCodeLine{\ 5:\ \mbox{\hyperlink{classtf_1_1_task}{tf::Task}}\ f1B\ =\ \mbox{\hyperlink{parallel__graph__pipeline_8cpp_a20ea9116f00e19915f910ca726f7518f}{f1}}.emplace([\&]()\{\ std::cout\ <<\ \textcolor{stringliteral}{"{}F1\ TaskB\(\backslash\)n"{}};\ \});}
\DoxyCodeLine{\ 6:\ tf::Task\ f1C\ =\ \mbox{\hyperlink{parallel__graph__pipeline_8cpp_a20ea9116f00e19915f910ca726f7518f}{f1}}.emplace([\&]()\{\ std::cout\ <<\ \textcolor{stringliteral}{"{}F1\ TaskC\(\backslash\)n"{}};\ \});}
\DoxyCodeLine{\ 7:\ }
\DoxyCodeLine{\ 8:\ f1A.\mbox{\hyperlink{classtf_1_1_task_a08ada0425b490997b6ff7f310107e5e3}{name}}(\textcolor{stringliteral}{"{}f1A"{}});}
\DoxyCodeLine{\ 9:\ f1B.\mbox{\hyperlink{classtf_1_1_task_a08ada0425b490997b6ff7f310107e5e3}{name}}(\textcolor{stringliteral}{"{}f1B"{}});}
\DoxyCodeLine{10:\ f1C.\mbox{\hyperlink{classtf_1_1_task_a08ada0425b490997b6ff7f310107e5e3}{name}}(\textcolor{stringliteral}{"{}f1C"{}});}
\DoxyCodeLine{11:\ f1A.\mbox{\hyperlink{classtf_1_1_task_a8c78c453295a553c1c016e4062da8588}{precede}}(f1C);}
\DoxyCodeLine{12:\ f1B.\mbox{\hyperlink{classtf_1_1_task_a8c78c453295a553c1c016e4062da8588}{precede}}(f1C);}
\DoxyCodeLine{13:}
\DoxyCodeLine{14:\ \textcolor{comment}{//\ f2A\ -\/-\/-\/}}
\DoxyCodeLine{15:\ \textcolor{comment}{//\ \ \ \ \ \ \ \ |-\/-\/-\/-\/>\ f2C\ -\/-\/-\/-\/>\ f1\_module\_task\ -\/-\/-\/-\/>\ f2D}}
\DoxyCodeLine{16:\ \textcolor{comment}{//\ f2B\ -\/-\/-\/\ }}
\DoxyCodeLine{17:\ tf::Taskflow\ \mbox{\hyperlink{parallel__graph__pipeline_8cpp_a894124d17350678007462a79ecc7eb36}{f2}};}
\DoxyCodeLine{18:\ \mbox{\hyperlink{parallel__graph__pipeline_8cpp_a894124d17350678007462a79ecc7eb36}{f2}}.\mbox{\hyperlink{classtf_1_1_task_a08ada0425b490997b6ff7f310107e5e3}{name}}(\textcolor{stringliteral}{"{}F2"{}});}
\DoxyCodeLine{19:\ tf::Task\ f2A\ =\ \mbox{\hyperlink{parallel__graph__pipeline_8cpp_a894124d17350678007462a79ecc7eb36}{f2}}.emplace([\&]()\{\ std::cout\ <<\ \textcolor{stringliteral}{"{}\ \ F2\ TaskA\(\backslash\)n"{}};\ \});}
\DoxyCodeLine{20:\ tf::Task\ f2B\ =\ \mbox{\hyperlink{parallel__graph__pipeline_8cpp_a894124d17350678007462a79ecc7eb36}{f2}}.emplace([\&]()\{\ std::cout\ <<\ \textcolor{stringliteral}{"{}\ \ F2\ TaskB\(\backslash\)n"{}};\ \});}
\DoxyCodeLine{21:\ tf::Task\ f2C\ =\ \mbox{\hyperlink{parallel__graph__pipeline_8cpp_a894124d17350678007462a79ecc7eb36}{f2}}.emplace([\&]()\{\ std::cout\ <<\ \textcolor{stringliteral}{"{}\ \ F2\ TaskC\(\backslash\)n"{}};\ \});}
\DoxyCodeLine{22:\ tf::Task\ f2D\ =\ \mbox{\hyperlink{parallel__graph__pipeline_8cpp_a894124d17350678007462a79ecc7eb36}{f2}}.emplace([\&]()\{\ std::cout\ <<\ \textcolor{stringliteral}{"{}\ \ F2\ TaskD\(\backslash\)n"{}};\ \});}
\DoxyCodeLine{23:\ }
\DoxyCodeLine{24:\ f2A.\mbox{\hyperlink{classtf_1_1_task_a08ada0425b490997b6ff7f310107e5e3}{name}}(\textcolor{stringliteral}{"{}f2A"{}});}
\DoxyCodeLine{25:\ f2B.\mbox{\hyperlink{classtf_1_1_task_a08ada0425b490997b6ff7f310107e5e3}{name}}(\textcolor{stringliteral}{"{}f2B"{}});}
\DoxyCodeLine{26:\ f2C.\mbox{\hyperlink{classtf_1_1_task_a08ada0425b490997b6ff7f310107e5e3}{name}}(\textcolor{stringliteral}{"{}f2C"{}});}
\DoxyCodeLine{27:\ f2D.\mbox{\hyperlink{classtf_1_1_task_a08ada0425b490997b6ff7f310107e5e3}{name}}(\textcolor{stringliteral}{"{}f2D"{}});}
\DoxyCodeLine{28:}
\DoxyCodeLine{29:\ f2A.\mbox{\hyperlink{classtf_1_1_task_a8c78c453295a553c1c016e4062da8588}{precede}}(f2C);}
\DoxyCodeLine{30:\ f2B.\mbox{\hyperlink{classtf_1_1_task_a8c78c453295a553c1c016e4062da8588}{precede}}(f2C);}
\DoxyCodeLine{31:}
\DoxyCodeLine{32:\ tf::Task\ f1\_module\_task\ =\ \mbox{\hyperlink{parallel__graph__pipeline_8cpp_a894124d17350678007462a79ecc7eb36}{f2}}.\mbox{\hyperlink{classtf_1_1_task_ab38be520fe700cb4ca1f312308a95585}{composed\_of}}(\mbox{\hyperlink{parallel__graph__pipeline_8cpp_a20ea9116f00e19915f910ca726f7518f}{f1}}).\mbox{\hyperlink{classtf_1_1_task_a08ada0425b490997b6ff7f310107e5e3}{name}}(\textcolor{stringliteral}{"{}module"{}});}
\DoxyCodeLine{33:\ f2C.\mbox{\hyperlink{classtf_1_1_task_a8c78c453295a553c1c016e4062da8588}{precede}}(f1\_module\_task);}
\DoxyCodeLine{34:\ f1\_module\_task.\mbox{\hyperlink{classtf_1_1_task_a8c78c453295a553c1c016e4062da8588}{precede}}(f2D);}
\DoxyCodeLine{35:}
\DoxyCodeLine{36:\ \mbox{\hyperlink{parallel__graph__pipeline_8cpp_a894124d17350678007462a79ecc7eb36}{f2}}.\mbox{\hyperlink{classtf_1_1_task_a3318a49ff9d0a01cd1e8ee675251e3b7}{dump}}(std::cout);}

\end{DoxyCode}


Debrief\+:

\begin{DoxyItemize}
\item Lines 1-\/12 create a taskflow of three tasks f1A, f1B, and f1C with f1A and f1B preceding f1C \item Lines 17-\/30 create a taskflow of four tasks f2A, f2B, f2C, and f2D \item Line 32 creates a module task from taskflow f1 through the method \doxylink{classtf_1_1_flow_builder_ac6f22228d4c2ea2e643c4b0d42c0e92a}{Taskflow\+::composed\+\_\+of} \item Line 33 enforces task f2C to run before the module task \item Line 34 enforces the module task to run before task f2D\end{DoxyItemize}
\hypertarget{_composable_tasking_CreateAModuleTaskFromATaskflow}{}\doxysubsection{\texorpdfstring{Create a Module Task from a Taskflow}{Create a Module Task from a Taskflow}}\label{_composable_tasking_CreateAModuleTaskFromATaskflow}
The task created from \doxylink{classtf_1_1_flow_builder_ac6f22228d4c2ea2e643c4b0d42c0e92a}{Taskflow\+::composed\+\_\+of} is a {\itshape module} task that runs on a pre-\/defined taskflow. \doxylink{bench__gemm_8cpp_addc86e8508f14411ec98f521c520f875}{A} module task does not own the taskflow but maintains a soft mapping to the taskflow. You can create multiple module tasks from the same taskflow but only one module task can run at one time. For example, the following composition is valid. Even though the two module tasks {\ttfamily module1} and {\ttfamily module2} refer to the same taskflow {\ttfamily F1}, the dependency link prevents {\ttfamily F1} from multiple executions at the same time.

However, the following composition is {\itshape invalid}. Both module tasks refer to the same taskflow. They can not run at the same time because they are associated with the same graph.\hypertarget{_composable_tasking_CreateACustomComposableGraph}{}\doxysubsection{\texorpdfstring{Create a Custom Composable Graph}{Create a Custom Composable Graph}}\label{_composable_tasking_CreateACustomComposableGraph}
Taskflow allows you to create a custom graph object that can participate in the scheduling using composition. To become a module task, your class {\ttfamily T} must define the method {\ttfamily T\+::graph()} that returns a reference to the \doxylink{classtf_1_1_graph}{tf\+::\+Graph} object managed by {\ttfamily T}. The following example defines a custom graph object that can be assembled in a taskflow throw composition\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{\ 1:\ \textcolor{keyword}{struct\ }CustomGraph\ \{}
\DoxyCodeLine{\ 2:\ \ \ \mbox{\hyperlink{classtf_1_1_graph}{tf::Graph}}\ graph;}
\DoxyCodeLine{\ 3:\ \ \ CustomGraph()\ \{}
\DoxyCodeLine{\ 4:\ \ \ \ \ \mbox{\hyperlink{classtf_1_1_flow_builder}{tf::FlowBuilder}}\ builder(graph);\ \ \textcolor{comment}{//\ inherit\ all\ task\ builders\ in\ tf::Taskflow}}
\DoxyCodeLine{\ 5:\ \ \ \ \ \mbox{\hyperlink{classtf_1_1_task}{tf::Task}}\ \mbox{\hyperlink{test__partitioner__whitebox_8h_a5c4cf3d37a4eee22275de22cb9619863}{task}}\ =\ builder.emplace([]()\{}
\DoxyCodeLine{\ 6:\ \ \ \ \ \ \ std::cout\ <<\ \textcolor{stringliteral}{"{}a\ task\(\backslash\)n"{}};\ \ \textcolor{comment}{//\ static\ task}}
\DoxyCodeLine{\ 7:\ \ \ \ \ \});}
\DoxyCodeLine{\ 8:\ \ \ \}}
\DoxyCodeLine{\ 9:\ \ \ \textcolor{comment}{//\ returns\ a\ reference\ to\ the\ graph\ for\ taskflow\ composition}}
\DoxyCodeLine{10:\ \ \ Graph\&\ graph()\ \{\ \textcolor{keywordflow}{return}\ graph;\ \}}
\DoxyCodeLine{11:\ \};}
\DoxyCodeLine{12:}
\DoxyCodeLine{13:\ CustomGraph\ obj;}
\DoxyCodeLine{14:\ tf::Task\ \mbox{\hyperlink{external_2taskflow_2sandbox_2jacobi_2main_8cpp_aaa178026ff13e667efcb0104a55252e7}{comp}}\ =\ \mbox{\hyperlink{poisson_8hpp_aa56fe360bb0ae38e0082f49e394ff825}{taskflow}}.composed\_of(obj);}

\end{DoxyCode}


Debrief\+:
\begin{DoxyItemize}
\item Lines 1-\/11 define a custom graph interface to participate in taskflow composition
\item Line 2 defines the graph object using \doxylink{classtf_1_1_graph}{tf\+::\+Graph}
\item Lines 3-\/8 defines the constructor that constructs the task graph using \doxylink{classtf_1_1_flow_builder}{tf\+::\+Flow\+Builder}
\item Line 10 defines the required method for taskflow composition
\item Lines 13-\/14 creates a module task for the declared graph object in the taskflow
\end{DoxyItemize}

The composition method \doxylink{classtf_1_1_flow_builder_ac6f22228d4c2ea2e643c4b0d42c0e92a}{tf\+::\+Taskflow\+::composed\+\_\+of} requires the target to define the {\ttfamily graph()} method that returns a reference to a \doxylink{classtf_1_1_graph}{tf\+::\+Graph} object defined by the target. At runtime, the executor will schedule tasks in that graph using the same work-\/stealing algorithm as other taskflows.

\begin{DoxyAttention}{注意}
Users are responsible for ensuring the given target remains valid throughout its execution. The executor does not assume ownership of the target object. 
\end{DoxyAttention}
