\doxysection{spin\+\_\+mutex.\+h}
\hypertarget{runtime_2core_2spin__mutex_8h_source}{}\label{runtime_2core_2spin__mutex_8h_source}\index{runtime/core/spin\_mutex.h@{runtime/core/spin\_mutex.h}}
\mbox{\hyperlink{runtime_2core_2spin__mutex_8h}{浏览该文件的文档.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{preprocessor}{\#pragma\ once}}
\DoxyCodeLine{00002\ }
\DoxyCodeLine{00003\ \textcolor{preprocessor}{\#include\ <atomic>}}
\DoxyCodeLine{00004\ \textcolor{preprocessor}{\#include\ <thread>}}
\DoxyCodeLine{00005\ }
\DoxyCodeLine{00006\ \textcolor{preprocessor}{\#include\ <\mbox{\hyperlink{intrin_8h}{runtime/core/intrin.h}}>}}
\DoxyCodeLine{00007\ }
\DoxyCodeLine{00008\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespaceluisa}{luisa}}\ \{}
\DoxyCodeLine{00009\ }
\DoxyCodeLine{00010\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classluisa_1_1spin__mutex_a08e0d82af7e797be0c6e655c8af7f964}{spin\_mutex}}\ \{}
\DoxyCodeLine{00011\ }
\DoxyCodeLine{00012\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00013\ \textcolor{preprocessor}{\#if\ \_\_cplusplus\ <\ 202002L}}
\DoxyCodeLine{00014\ \ \ \ \ std::atomic\_flag\ \mbox{\hyperlink{classluisa_1_1spin__mutex_a5fec5667a4165d1d5d23947a1088a44a}{\_flag}}\ =\ ATOMIC\_FLAG\_INIT;}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00016\ \ \ \ \ std::atomic\_flag\ \mbox{\hyperlink{classluisa_1_1spin__mutex_a5fec5667a4165d1d5d23947a1088a44a}{\_flag}};\textcolor{comment}{//\ ATOMIC\_FLAG\_INIT\ is\ not\ needed\ as\ per\ C++20}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00018\ }
\DoxyCodeLine{00019\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00020\ \ \ \ \ \mbox{\hyperlink{classluisa_1_1spin__mutex_a08e0d82af7e797be0c6e655c8af7f964}{spin\_mutex}}()\ noexcept\ =\ \mbox{\hyperlink{sugar_8h_a6face89e97cccad5464dd9bb9c7efd23}{default}};}
\DoxyCodeLine{00021\ }
\DoxyCodeLine{00022\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classluisa_1_1spin__mutex_aeefa600630e53194614266c2ffa4d3e4}{lock}}()\ noexcept\ \{}
\DoxyCodeLine{00023\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (\mbox{\hyperlink{classluisa_1_1spin__mutex_a5fec5667a4165d1d5d23947a1088a44a}{\_flag}}.test\_and\_set(std::memory\_order::acquire))\ \{\textcolor{comment}{//\ acquire\ lock}}
\DoxyCodeLine{00024\ \ \ \ \ \ \ \ \ \ \ \ \ LUISA\_INTRIN\_PAUSE();}
\DoxyCodeLine{00025\ \#ifdef\ \_\_cpp\_lib\_atomic\_flag\_test}
\DoxyCodeLine{00026\ \ \ \ \ \ \ \ \ \ \ \ \ while\ (\_flag.test(std::memory\_order::relaxed))\ \{\textcolor{comment}{//\ test\ lock}}
\DoxyCodeLine{00027\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::this\_thread::yield();}
\DoxyCodeLine{00028\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00029\ \#endif}
\DoxyCodeLine{00030\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00031\ \ \ \ \ \}}
\DoxyCodeLine{00032\ \ \ \ \ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classluisa_1_1spin__mutex_ad4a45eff38f779575d604d2f798801a1}{try\_lock}}()\ noexcept\ \{}
\DoxyCodeLine{00033\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ !\mbox{\hyperlink{classluisa_1_1spin__mutex_a5fec5667a4165d1d5d23947a1088a44a}{\_flag}}.test\_and\_set(std::memory\_order::acquire);}
\DoxyCodeLine{00034\ \ \ \ \ \}}
\DoxyCodeLine{00035\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classluisa_1_1spin__mutex_a6094eafa460621fa94fb7ae5765fabbe}{unlock}}()\ noexcept\ \{}
\DoxyCodeLine{00036\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classluisa_1_1spin__mutex_a5fec5667a4165d1d5d23947a1088a44a}{\_flag}}.clear(std::memory\_order::release);\textcolor{comment}{//\ release\ lock}}
\DoxyCodeLine{00037\ \ \ \ \ \}}
\DoxyCodeLine{00038\ \};}
\DoxyCodeLine{00039\ }
\DoxyCodeLine{00040\ \}\textcolor{comment}{//\ namespace\ luisa}}

\end{DoxyCode}
