\chapter{Compile Taskflow with SYCL}
\hypertarget{_compile_taskflow_with_s_y_c_l}{}\label{_compile_taskflow_with_s_y_c_l}\index{Compile Taskflow with SYCL@{Compile Taskflow with SYCL}}
\hypertarget{_compile_taskflow_with_s_y_c_l_InstallSYCLCompiler}{}\doxysection{\texorpdfstring{Install SYCL Compiler}{Install SYCL Compiler}}\label{_compile_taskflow_with_s_y_c_l_InstallSYCLCompiler}
To compile Taskflow with SYCL code, you need the DPC++ clang compiler, which can be acquired from \href{https://intel.github.io/llvm-docs/GetStartedGuide.html}{\texttt{ Getting Started with one\+API DPC++}}.\hypertarget{_compile_taskflow_with_s_y_c_l_CompileTaskflowWithSYCLDirectly}{}\doxysection{\texorpdfstring{Compile Source Code Directly}{Compile Source Code Directly}}\label{_compile_taskflow_with_s_y_c_l_CompileTaskflowWithSYCLDirectly}
Taskflow\textquotesingle{}s GPU programming interface for SYCL is \doxylink{classtf_1_1sycl_flow}{tf\+::sycl\+Flow}. Consider the following {\ttfamily \doxylink{simple_8cpp}{simple.\+cpp}} program that performs the canonical saxpy (single-\/precision AX + Y) operation on a GPU\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{preprocessor}{\#include\ <\mbox{\hyperlink{taskflow_8hpp}{taskflow/taskflow.hpp}}>}\ \ \textcolor{comment}{//\ core\ taskflow\ routines}}
\DoxyCodeLine{\textcolor{preprocessor}{\#include\ <taskflow/syclflow.hpp>}\ \ \textcolor{comment}{//\ core\ syclflow\ routines}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{keywordtype}{int}\ \mbox{\hyperlink{main-override-static_8c_ae66f6b31b5ad750f1fe042a706a4e3d4}{main}}()\ \{}
\DoxyCodeLine{\ \ }
\DoxyCodeLine{\ \ \mbox{\hyperlink{classtf_1_1_executor}{tf::Executor}}\ \mbox{\hyperlink{thread__pool_8cpp_a543e564a8407bbeac15cb2d929fec755}{executor}};}
\DoxyCodeLine{\ \ \mbox{\hyperlink{classtf_1_1_taskflow}{tf::Taskflow}}\ \mbox{\hyperlink{poisson_8hpp_aa56fe360bb0ae38e0082f49e394ff825}{taskflow}}(\textcolor{stringliteral}{"{}saxpy\ example"{}});}
\DoxyCodeLine{\ \ }
\DoxyCodeLine{\ \ sycl::queue\ \mbox{\hyperlink{namespacequeue}{queue}};}
\DoxyCodeLine{\ \ }
\DoxyCodeLine{\ \ \textcolor{keyword}{auto}\ \mbox{\hyperlink{icosphere_8cpp_a207fd5507206d307cd63f95374fcd00d}{X}}\ =\ sycl::malloc\_shared<float>(\mbox{\hyperlink{main-override-static_8c_a0240ac851181b84ac374872dc5434ee4}{N}},\ \mbox{\hyperlink{namespacequeue}{queue}});}
\DoxyCodeLine{\ \ \textcolor{keyword}{auto}\ Y\ =\ sycl::malloc\_shared<float>(\mbox{\hyperlink{main-override-static_8c_a0240ac851181b84ac374872dc5434ee4}{N}},\ \mbox{\hyperlink{namespacequeue}{queue}});}
\DoxyCodeLine{\ \ }
\DoxyCodeLine{\ \ \mbox{\hyperlink{poisson_8hpp_aa56fe360bb0ae38e0082f49e394ff825}{taskflow}}.emplace\_on([\&](\mbox{\hyperlink{classtf_1_1sycl_flow}{tf::syclFlow}}\&\ sf)\{}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{classtf_1_1sycl_task}{tf::syclTask}}\ fillX\ =\ sf.fill(\mbox{\hyperlink{icosphere_8cpp_a207fd5507206d307cd63f95374fcd00d}{X}},\ 1.0f,\ \mbox{\hyperlink{main-override-static_8c_a0240ac851181b84ac374872dc5434ee4}{N}}).\mbox{\hyperlink{classtf_1_1sycl_task_a738dfa209da08d8783127a5c5654558e}{name}}(\textcolor{stringliteral}{"{}fillX"{}});}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{classtf_1_1sycl_task}{tf::syclTask}}\ fillY\ =\ sf.fill(Y,\ 2.0f,\ \mbox{\hyperlink{main-override-static_8c_a0240ac851181b84ac374872dc5434ee4}{N}}).\mbox{\hyperlink{classtf_1_1sycl_task_a738dfa209da08d8783127a5c5654558e}{name}}(\textcolor{stringliteral}{"{}fillY"{}});}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{classtf_1_1sycl_task}{tf::syclTask}}\ \mbox{\hyperlink{bench_2btl_2libs_2_b_l_a_s_2blas_8h_ad53e5aed16187a6bb50b8aa5f24cca8b}{saxpy}}\ =\ sf.parallel\_for(sycl::range<1>(\mbox{\hyperlink{main-override-static_8c_a0240ac851181b84ac374872dc5434ee4}{N}}),\ }
\DoxyCodeLine{\ \ \ \ \ \ [=]\ (sycl::id<1>\ \textcolor{keywordtype}{id})\ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \mbox{\hyperlink{icosphere_8cpp_a207fd5507206d307cd63f95374fcd00d}{X}}[\mbox{\hyperlink{cocoa__platform_8h_acf00cd75f37488e1d4ac463303ccfec4}{id}}]\ =\ 3.0f\ *\ \mbox{\hyperlink{icosphere_8cpp_a207fd5507206d307cd63f95374fcd00d}{X}}[\mbox{\hyperlink{cocoa__platform_8h_acf00cd75f37488e1d4ac463303ccfec4}{id}}]\ +\ Y[\mbox{\hyperlink{cocoa__platform_8h_acf00cd75f37488e1d4ac463303ccfec4}{id}}];}
\DoxyCodeLine{\ \ \ \ \ \ \}}
\DoxyCodeLine{\ \ \ \ ).\mbox{\hyperlink{imgui__impl__opengl3__loader_8h_aab18cfce5ee7c6881ae04f18be70d94a}{name}}(\textcolor{stringliteral}{"{}saxpy"{}});}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{bench_2btl_2libs_2_b_l_a_s_2blas_8h_ad53e5aed16187a6bb50b8aa5f24cca8b}{saxpy}}.succeed(fillX,\ fillY);}
\DoxyCodeLine{\ \ \},\ \mbox{\hyperlink{namespaceluisa_aa1eb922874c2e5b0b13f4fc9a37747eb}{queue}}).\mbox{\hyperlink{imgui__impl__opengl3__loader_8h_aab18cfce5ee7c6881ae04f18be70d94a}{name}}(\textcolor{stringliteral}{"{}syclFlow"{}});}
\DoxyCodeLine{\ \ }
\DoxyCodeLine{\ \ \mbox{\hyperlink{thread__pool_8cpp_a543e564a8407bbeac15cb2d929fec755}{executor}}.\mbox{\hyperlink{classtf_1_1_executor_a519777f5783981d534e9e53b99712069}{run}}(\mbox{\hyperlink{poisson_8hpp_aa56fe360bb0ae38e0082f49e394ff825}{taskflow}}).wait();}
\DoxyCodeLine{\}}

\end{DoxyCode}


Use DPC++ clang to compile the program with the following options\+:

\begin{DoxyItemize}
\item {\ttfamily -\/fsycl\+:} enable SYCL compilation mode \item {\ttfamily -\/fsycl-\/targets=nvptx64-\/nvidia-\/cuda-\/sycldevice}\+: enable CUDA target \item {\ttfamily -\/fsycl-\/unnamed-\/lambda}\+: enable unnamed SYCL lambda kernel\end{DoxyItemize}

\begin{DoxyCode}{0}
\DoxyCodeLine{\{.shell-\/session\}\ }
\DoxyCodeLine{\string~\$\ clang++\ -\/fsycl\ -\/fsycl-\/unnamed-\/\mbox{\hyperlink{sugar_8h_aa2bc5aa57d417f3226228d9058ab9f20}{lambda}}\ \(\backslash\)}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ -\/fsycl-\/targets=nvptx64-\/nvidia-\/cuda-\/sycldevice\ \(\backslash\)\ \ \#\ \textcolor{keywordflow}{for}\ CUDA\ target}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ -\/I\ \mbox{\hyperlink{ittnotify__static_8h_a7016119bc831a22d1a351d56128518ed}{path}}/to/\mbox{\hyperlink{poisson_8hpp_aa56fe360bb0ae38e0082f49e394ff825}{taskflow}}\ -\/pthread\ -\/\mbox{\hyperlink{namespacestd}{std}}=\mbox{\hyperlink{bench_vec_add_8cpp_a41689956983587b085f9da3e48f31d99}{c}}++17\ simple.cpp\ -\/o\ simple}
\DoxyCodeLine{\string~\$\ ./simple}

\end{DoxyCode}


\begin{DoxyAttention}{注意}
You need to include {\ttfamily taskflow/syclflow.\+hpp} in order to use \doxylink{classtf_1_1sycl_flow}{tf\+::sycl\+Flow}.
\end{DoxyAttention}
\hypertarget{_compile_taskflow_with_s_y_c_l_CompileTaskflowWithSYCLSeparately}{}\doxysection{\texorpdfstring{Compile Source Code Separately}{Compile Source Code Separately}}\label{_compile_taskflow_with_s_y_c_l_CompileTaskflowWithSYCLSeparately}
Large GPU applications often compile a program into separate objects and link them together to form an executable or a library. You can compile your SYCL code into separate object files and link them to form the final executable. Consider the following example that defines two tasks on two different pieces ({\ttfamily main.\+cpp} and {\ttfamily syclflow.\+cpp}) of source code\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{comment}{//\ main.cpp}}
\DoxyCodeLine{\textcolor{preprocessor}{\#include\ <\mbox{\hyperlink{taskflow_8hpp}{taskflow/taskflow.hpp}}>}}
\DoxyCodeLine{}
\DoxyCodeLine{\mbox{\hyperlink{classtf_1_1_task}{tf::Task}}\ make\_syclflow(\mbox{\hyperlink{classtf_1_1_taskflow}{tf::Taskflow}}\&\ \mbox{\hyperlink{poisson_8hpp_aa56fe360bb0ae38e0082f49e394ff825}{taskflow}});\ \ \textcolor{comment}{//\ create\ a\ syclFlow\ task}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{keywordtype}{int}\ \mbox{\hyperlink{main-override-static_8c_ae66f6b31b5ad750f1fe042a706a4e3d4}{main}}()\ \{}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \mbox{\hyperlink{classtf_1_1_executor}{tf::Executor}}\ \mbox{\hyperlink{thread__pool_8cpp_a543e564a8407bbeac15cb2d929fec755}{executor}};}
\DoxyCodeLine{\ \ \mbox{\hyperlink{classtf_1_1_taskflow}{tf::Taskflow}}\ \mbox{\hyperlink{poisson_8hpp_aa56fe360bb0ae38e0082f49e394ff825}{taskflow}};}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \mbox{\hyperlink{classtf_1_1_task}{tf::Task}}\ task1\ =\ \mbox{\hyperlink{poisson_8hpp_aa56fe360bb0ae38e0082f49e394ff825}{taskflow}}.emplace([]()\{\ std::cout\ <<\ \textcolor{stringliteral}{"{}main.cpp!\(\backslash\)n"{}};\ \})}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ .\mbox{\hyperlink{imgui__impl__opengl3__loader_8h_aab18cfce5ee7c6881ae04f18be70d94a}{name}}(\textcolor{stringliteral}{"{}cpu\ task"{}});}
\DoxyCodeLine{\ \ \mbox{\hyperlink{classtf_1_1_task}{tf::Task}}\ task2\ =\ make\_syclflow(\mbox{\hyperlink{poisson_8hpp_aa56fe360bb0ae38e0082f49e394ff825}{taskflow}});}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ task1.\mbox{\hyperlink{classtf_1_1_task_a8c78c453295a553c1c016e4062da8588}{precede}}(task2);}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \mbox{\hyperlink{thread__pool_8cpp_a543e564a8407bbeac15cb2d929fec755}{executor}}.run(\mbox{\hyperlink{poisson_8hpp_aa56fe360bb0ae38e0082f49e394ff825}{taskflow}}).wait();}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{\}}

\end{DoxyCode}



\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{comment}{//\ syclflow.cpp}}
\DoxyCodeLine{\textcolor{preprocessor}{\#include\ <\mbox{\hyperlink{taskflow_8hpp}{taskflow/taskflow.hpp}}>}}
\DoxyCodeLine{\textcolor{preprocessor}{\#include\ <taskflow/syclflow.hpp>}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{keyword}{inline}\ sycl::queue\ \mbox{\hyperlink{namespacequeue}{queue}};\ \ \ \ \textcolor{comment}{//\ create\ a\ global\ sycl\ queue}}
\DoxyCodeLine{}
\DoxyCodeLine{\mbox{\hyperlink{classtf_1_1_task}{tf::Task}}\ make\_syclflow(\mbox{\hyperlink{classtf_1_1_taskflow}{tf::Taskflow}}\&\ \mbox{\hyperlink{poisson_8hpp_aa56fe360bb0ae38e0082f49e394ff825}{taskflow}})\ \{}
\DoxyCodeLine{\ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{poisson_8hpp_aa56fe360bb0ae38e0082f49e394ff825}{taskflow}}.emplace\_on([](\mbox{\hyperlink{classtf_1_1sycl_flow}{tf::syclFlow}}\&\ cf)\{}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{printf_8h_aee3ed3a831f25f07e7be3919fff2203a}{printf}}(\textcolor{stringliteral}{"{}syclflow.cpp!\(\backslash\)n"{}});}
\DoxyCodeLine{\ \ \ \ cf.\mbox{\hyperlink{classtf_1_1sycl_flow_a05ff6f331b6cf48e21ae7f0d6aea9094}{single\_task}}([]()\{\}).\mbox{\hyperlink{imgui__impl__opengl3__loader_8h_aab18cfce5ee7c6881ae04f18be70d94a}{name}}(\textcolor{stringliteral}{"{}kernel"{}});}
\DoxyCodeLine{\ \ \},\ \mbox{\hyperlink{namespaceluisa_aa1eb922874c2e5b0b13f4fc9a37747eb}{queue}}).\mbox{\hyperlink{imgui__impl__opengl3__loader_8h_aab18cfce5ee7c6881ae04f18be70d94a}{name}}(\textcolor{stringliteral}{"{}gpu\ task"{}});}
\DoxyCodeLine{\}}

\end{DoxyCode}


Compile each source to an object using DPC++ clang\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{\{.shell-\/session\}\ }
\DoxyCodeLine{\string~\$\ clang++\ -\/I\ \mbox{\hyperlink{ittnotify__static_8h_a7016119bc831a22d1a351d56128518ed}{path}}/to/\mbox{\hyperlink{poisson_8hpp_aa56fe360bb0ae38e0082f49e394ff825}{taskflow}}/\ -\/pthread\ -\/\mbox{\hyperlink{namespacestd}{std}}=\mbox{\hyperlink{bench_vec_add_8cpp_a41689956983587b085f9da3e48f31d99}{c}}++17\ -\/\mbox{\hyperlink{bench_vec_add_8cpp_a41689956983587b085f9da3e48f31d99}{c}}\ \mbox{\hyperlink{main-override-static_8c_ae66f6b31b5ad750f1fe042a706a4e3d4}{main}}.cpp\ -\/o\ \mbox{\hyperlink{main-override-static_8c_ae66f6b31b5ad750f1fe042a706a4e3d4}{main}}.o}
\DoxyCodeLine{\string~\$\ clang++\ -\/fsycl\ -\/fsycl-\/unnamed-\/\mbox{\hyperlink{sugar_8h_aa2bc5aa57d417f3226228d9058ab9f20}{lambda}}\ \(\backslash\)}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ -\/fsycl-\/targets=nvptx64-\/nvidia-\/cuda-\/sycldevice\ \(\backslash\)}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ -\/I\ \mbox{\hyperlink{ittnotify__static_8h_a7016119bc831a22d1a351d56128518ed}{path}}/to/\mbox{\hyperlink{poisson_8hpp_aa56fe360bb0ae38e0082f49e394ff825}{taskflow}}/\ -\/pthread\ -\/\mbox{\hyperlink{namespacestd}{std}}=\mbox{\hyperlink{bench_vec_add_8cpp_a41689956983587b085f9da3e48f31d99}{c}}++17\ -\/\mbox{\hyperlink{bench_vec_add_8cpp_a41689956983587b085f9da3e48f31d99}{c}}\ syclflow.cpp\ -\/o\ syclflow.o}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{preprocessor}{\#\ now\ we\ have\ the\ two\ compiled\ .o\ objects,\ main.o\ and\ syclflow.o}}
\DoxyCodeLine{\string~\$\ ls}
\DoxyCodeLine{\mbox{\hyperlink{main-override-static_8c_ae66f6b31b5ad750f1fe042a706a4e3d4}{main}}.o\ syclflow.o\ }

\end{DoxyCode}


Next, link the two object files to the final executable\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{\{.shell-\/session\}\ }
\DoxyCodeLine{\string~\$\ clang++\ -\/fsycl\ -\/fsycl-\/unnamed-\/\mbox{\hyperlink{sugar_8h_aa2bc5aa57d417f3226228d9058ab9f20}{lambda}}\ \(\backslash\)}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ -\/fsycl-\/targets=nvptx64-\/nvidia-\/cuda-\/sycldevice\ \(\backslash\)\ \ \#\ \textcolor{keywordflow}{for}\ CUDA\ target}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{main-override-static_8c_ae66f6b31b5ad750f1fe042a706a4e3d4}{main}}.o\ syclflow.o\ -\/pthread\ -\/\mbox{\hyperlink{namespacestd}{std}}=\mbox{\hyperlink{bench_vec_add_8cpp_a41689956983587b085f9da3e48f31d99}{c}}++17\ -\/o\ \mbox{\hyperlink{main-override-static_8c_ae66f6b31b5ad750f1fe042a706a4e3d4}{main}}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{preprocessor}{\#\ run\ the\ main\ program\ }}
\DoxyCodeLine{\string~\$\ ./\mbox{\hyperlink{main-override-static_8c_ae66f6b31b5ad750f1fe042a706a4e3d4}{main}}}
\DoxyCodeLine{\mbox{\hyperlink{main-override-static_8c_ae66f6b31b5ad750f1fe042a706a4e3d4}{main}}.cpp!}
\DoxyCodeLine{syclflow.cpp!}

\end{DoxyCode}
 