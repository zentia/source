\doxysection{page.\+c}
\hypertarget{page_8c_source}{}\label{page_8c_source}\index{runtime/EASTL/packages/mimalloc/src/page.c@{runtime/EASTL/packages/mimalloc/src/page.c}}
\mbox{\hyperlink{page_8c}{浏览该文件的文档.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{/*-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00002\ \textcolor{comment}{Copyright\ (c)\ 2018-\/2024,\ Microsoft\ Research,\ Daan\ Leijen}}
\DoxyCodeLine{00003\ \textcolor{comment}{This\ is\ free\ software;\ you\ can\ redistribute\ it\ and/or\ modify\ it\ under\ the}}
\DoxyCodeLine{00004\ \textcolor{comment}{terms\ of\ the\ MIT\ license.\ A\ copy\ of\ the\ license\ can\ be\ found\ in\ the\ file}}
\DoxyCodeLine{00005\ \textcolor{comment}{"{}LICENSE"{}\ at\ the\ root\ of\ this\ distribution.}}
\DoxyCodeLine{00006\ \textcolor{comment}{-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/*/}}
\DoxyCodeLine{00007\ }
\DoxyCodeLine{00008\ \textcolor{comment}{/*\ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00009\ \textcolor{comment}{\ \ The\ core\ of\ the\ allocator.\ Every\ segment\ contains}}
\DoxyCodeLine{00010\ \textcolor{comment}{\ \ pages\ of\ a\ certain\ block\ size.\ The\ main\ function}}
\DoxyCodeLine{00011\ \textcolor{comment}{\ \ exported\ is\ \`{}mi\_malloc\_generic`.}}
\DoxyCodeLine{00012\ \textcolor{comment}{-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/\ */}}
\DoxyCodeLine{00013\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{mimalloc_8h}{mimalloc.h}}"{}}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h}{mimalloc/internal.h}}"{}}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2atomic_8h}{mimalloc/atomic.h}}"{}}}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ \textcolor{comment}{/*\ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00019\ \textcolor{comment}{\ \ Definition\ of\ page\ queues\ for\ each\ block\ size}}
\DoxyCodeLine{00020\ \textcolor{comment}{-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/\ */}}
\DoxyCodeLine{00021\ }
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#define\ MI\_IN\_PAGE\_C}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{page-queue_8c}{page-\/queue.c}}"{}}}
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#undef\ MI\_IN\_PAGE\_C}}
\DoxyCodeLine{00025\ }
\DoxyCodeLine{00026\ }
\DoxyCodeLine{00027\ \textcolor{comment}{/*\ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00028\ \textcolor{comment}{\ \ Page\ helpers}}
\DoxyCodeLine{00029\ \textcolor{comment}{-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/\ */}}
\DoxyCodeLine{00030\ }
\DoxyCodeLine{00031\ \textcolor{comment}{//\ Index\ a\ block\ in\ a\ page}}
\DoxyCodeLine{00032\ \textcolor{keyword}{static}\ \textcolor{keyword}{inline}\ \mbox{\hyperlink{types_8h_a9a69f9a34bc130b6a51162b980e9c631}{mi\_block\_t}}*\ \mbox{\hyperlink{page_8c_a796cbdf7c3bf7febbda3160b978b4e79}{mi\_page\_block\_at}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{types_8h_a98e3d539b4113aac496ebe3d379ebe5b}{mi\_page\_t}}*\ page,\ \textcolor{keywordtype}{void}*\ page\_start,\ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{sugar_8h_a9766f5ceca5e25981858ec7384456072}{block\_size}},\ \textcolor{keywordtype}{size\_t}\ i)\ \{}
\DoxyCodeLine{00033\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ab7467946e27cd6bb4af911805cc5db26}{MI\_UNUSED}}(page);}
\DoxyCodeLine{00034\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(page\ !=\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}});}
\DoxyCodeLine{00035\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(i\ <=\ page-\/>reserved);}
\DoxyCodeLine{00036\ \ \ \textcolor{keywordflow}{return}\ (\mbox{\hyperlink{types_8h_a9a69f9a34bc130b6a51162b980e9c631}{mi\_block\_t}}*)((\mbox{\hyperlink{eabase_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}}*)page\_start\ +\ (i\ *\ \mbox{\hyperlink{sugar_8h_a9766f5ceca5e25981858ec7384456072}{block\_size}}));}
\DoxyCodeLine{00037\ \}}
\DoxyCodeLine{00038\ }
\DoxyCodeLine{00039\ \textcolor{comment}{//static\ void\ mi\_page\_init(mi\_heap\_t*\ heap,\ mi\_page\_t*\ page,\ size\_t\ size,\ mi\_tld\_t*\ tld);}}
\DoxyCodeLine{00040\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{page_8c_a40c7a483e3c04fdcf8d9a16bc6e6cea5}{mi\_page\_extend\_free}}(\mbox{\hyperlink{group__heap_ga34a47cde5a5b38c29f1aa3c5e76943c2}{mi\_heap\_t}}*\ heap,\ \mbox{\hyperlink{types_8h_a98e3d539b4113aac496ebe3d379ebe5b}{mi\_page\_t}}*\ page);}
\DoxyCodeLine{00041\ }
\DoxyCodeLine{00042\ \textcolor{preprocessor}{\#if\ (MI\_DEBUG>=3)}}
\DoxyCodeLine{00043\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{size\_t}\ mi\_page\_list\_count(\mbox{\hyperlink{types_8h_a98e3d539b4113aac496ebe3d379ebe5b}{mi\_page\_t}}*\ page,\ \mbox{\hyperlink{types_8h_a9a69f9a34bc130b6a51162b980e9c631}{mi\_block\_t}}*\ head)\ \{}
\DoxyCodeLine{00044\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_acd84a462a2045538d19ecc56e6cc29f6}{\_mi\_ptr\_page}}(page)\ ==\ page);}
\DoxyCodeLine{00045\ \ \ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{imgui__impl__opengl3__loader_8h_a619bc20e8198de3bd3f3d7fc34de66b2}{count}}\ =\ 0;}
\DoxyCodeLine{00046\ \ \ \textcolor{keywordflow}{while}\ (head\ !=\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}})\ \{}
\DoxyCodeLine{00047\ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}((\mbox{\hyperlink{eabase_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}}*)head\ -\/\ (\mbox{\hyperlink{eabase_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}}*)page\ >\ (ptrdiff\_t)\mbox{\hyperlink{types_8h_ae58a91cbf52941f7526f2c954d4fcee3}{MI\_LARGE\_PAGE\_SIZE}}\ ||\ page\ ==\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_acd84a462a2045538d19ecc56e6cc29f6}{\_mi\_ptr\_page}}(head));}
\DoxyCodeLine{00048\ \ \ \ \ \mbox{\hyperlink{imgui__impl__opengl3__loader_8h_a619bc20e8198de3bd3f3d7fc34de66b2}{count}}++;}
\DoxyCodeLine{00049\ \ \ \ \ head\ =\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_aaa5daf3a8b3db89666b6861cbb1e2f96}{mi\_block\_next}}(page,\ head);}
\DoxyCodeLine{00050\ \ \ \}}
\DoxyCodeLine{00051\ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{imgui__impl__opengl3__loader_8h_a619bc20e8198de3bd3f3d7fc34de66b2}{count}};}
\DoxyCodeLine{00052\ \}}
\DoxyCodeLine{00053\ }
\DoxyCodeLine{00054\ \textcolor{comment}{/*}}
\DoxyCodeLine{00055\ \textcolor{comment}{//\ Start\ of\ the\ page\ available\ memory}}
\DoxyCodeLine{00056\ \textcolor{comment}{static\ inline\ uint8\_t*\ mi\_page\_area(const\ mi\_page\_t*\ page)\ \{}}
\DoxyCodeLine{00057\ \textcolor{comment}{\ \ return\ \_mi\_page\_start(\_mi\_page\_segment(page),\ page,\ NULL);}}
\DoxyCodeLine{00058\ \textcolor{comment}{\}}}
\DoxyCodeLine{00059\ \textcolor{comment}{*/}}
\DoxyCodeLine{00060\ }
\DoxyCodeLine{00061\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{bool}\ mi\_page\_list\_is\_valid(\mbox{\hyperlink{types_8h_a98e3d539b4113aac496ebe3d379ebe5b}{mi\_page\_t}}*\ page,\ \mbox{\hyperlink{types_8h_a9a69f9a34bc130b6a51162b980e9c631}{mi\_block\_t}}*\ \mbox{\hyperlink{main-override_8cpp_a117104b82864d3b23ec174af6d392709}{p}})\ \{}
\DoxyCodeLine{00062\ \ \ \textcolor{keywordtype}{size\_t}\ psize;}
\DoxyCodeLine{00063\ \ \ \mbox{\hyperlink{eabase_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}}*\ page\_area\ =\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ab02bec7b56343136344cb9441cb889c7}{mi\_page\_area}}(page,\ \&psize);}
\DoxyCodeLine{00064\ \ \ \mbox{\hyperlink{types_8h_a9a69f9a34bc130b6a51162b980e9c631}{mi\_block\_t}}*\ \mbox{\hyperlink{namespacedetail_ac742e301ae0a908dc31e49ac3a31fcc5aea2b2676c28c0db26d39331a336c6b92}{start}}\ =\ (\mbox{\hyperlink{types_8h_a9a69f9a34bc130b6a51162b980e9c631}{mi\_block\_t}}*)page\_area;}
\DoxyCodeLine{00065\ \ \ \mbox{\hyperlink{types_8h_a9a69f9a34bc130b6a51162b980e9c631}{mi\_block\_t}}*\ \mbox{\hyperlink{namespaceeastl_a015a7329c4b84d454b87496532739b69}{end}}\ \ \ =\ (\mbox{\hyperlink{types_8h_a9a69f9a34bc130b6a51162b980e9c631}{mi\_block\_t}}*)(page\_area\ +\ psize);}
\DoxyCodeLine{00066\ \ \ \textcolor{keywordflow}{while}(\mbox{\hyperlink{main-override_8cpp_a117104b82864d3b23ec174af6d392709}{p}}\ !=\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}})\ \{}
\DoxyCodeLine{00067\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{main-override_8cpp_a117104b82864d3b23ec174af6d392709}{p\ <\ start\ ||\ p\ >}}=\ end)\ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00068\ \ \ \ \ \mbox{\hyperlink{main-override_8cpp_a117104b82864d3b23ec174af6d392709}{p}}\ =\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_aaa5daf3a8b3db89666b6861cbb1e2f96}{mi\_block\_next}}(page,\ \mbox{\hyperlink{main-override_8cpp_a117104b82864d3b23ec174af6d392709}{p}});}
\DoxyCodeLine{00069\ \ \ \}}
\DoxyCodeLine{00070\ \textcolor{preprocessor}{\#if\ MI\_DEBUG>3\ }\textcolor{comment}{//\ generally\ too\ expensive\ to\ check\ this}}
\DoxyCodeLine{00071\ \ \ \textcolor{keywordflow}{if}\ (page-\/>\mbox{\hyperlink{structmi__page__s_ad01f597f484f95c73fd5085168e4be34}{free\_is\_zero}})\ \{}
\DoxyCodeLine{00072\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ ubsize\ =\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a432abca03d059a7d40d8d39617afc8f7}{mi\_page\_usable\_block\_size}}(page);}
\DoxyCodeLine{00073\ \ \ \ \ \textcolor{keywordflow}{for}\ (\mbox{\hyperlink{types_8h_a9a69f9a34bc130b6a51162b980e9c631}{mi\_block\_t}}*\ \mbox{\hyperlink{mimalloc_8h_a840cb394e7433c7fe0c4875a3030c955}{block}}\ =\ page-\/>\mbox{\hyperlink{structmi__page__s_ae2d4b1c483d94e3624319bbca00d3da3}{free}};\ \mbox{\hyperlink{mimalloc_8h_a840cb394e7433c7fe0c4875a3030c955}{block}}\ !=\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}};\ \mbox{\hyperlink{mimalloc_8h_a840cb394e7433c7fe0c4875a3030c955}{block}}\ =\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_aaa5daf3a8b3db89666b6861cbb1e2f96}{mi\_block\_next}}(page,\ \mbox{\hyperlink{mimalloc_8h_a840cb394e7433c7fe0c4875a3030c955}{block}}))\ \{}
\DoxyCodeLine{00074\ \ \ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ab812423812d2dd7af864b7e112055d8e}{mi\_assert\_expensive}}(\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a8391ae55dd6885bd38593f740fd349a4}{mi\_mem\_is\_zero}}(\mbox{\hyperlink{mimalloc_8h_a840cb394e7433c7fe0c4875a3030c955}{block}}\ +\ 1,\ ubsize\ -\/\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{types_8h_a9a69f9a34bc130b6a51162b980e9c631}{mi\_block\_t}})));}
\DoxyCodeLine{00075\ \ \ \ \ \}}
\DoxyCodeLine{00076\ \ \ \}}
\DoxyCodeLine{00077\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00078\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00079\ \}}
\DoxyCodeLine{00080\ }
\DoxyCodeLine{00081\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{bool}\ mi\_page\_is\_valid\_init(\mbox{\hyperlink{types_8h_a98e3d539b4113aac496ebe3d379ebe5b}{mi\_page\_t}}*\ page)\ \{}
\DoxyCodeLine{00082\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a6134893990c1f09da2b40092ceecc780}{mi\_page\_block\_size}}(page)\ >\ 0);}
\DoxyCodeLine{00083\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(page-\/>\mbox{\hyperlink{structmi__page__s_ad1194a6cecba67ba2cf1952eb337968c}{used}}\ <=\ page-\/>\mbox{\hyperlink{structmi__page__s_a9ed1099a997d9c4e42b3bbe631705e41}{capacity}});}
\DoxyCodeLine{00084\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(page-\/>\mbox{\hyperlink{structmi__page__s_a9ed1099a997d9c4e42b3bbe631705e41}{capacity}}\ <=\ page-\/>\mbox{\hyperlink{structmi__page__s_acf15d96ab2462c10365859158a84bb72}{reserved}});}
\DoxyCodeLine{00085\ }
\DoxyCodeLine{00086\ \ \ \textcolor{comment}{//\ const\ size\_t\ bsize\ =\ mi\_page\_block\_size(page);}}
\DoxyCodeLine{00087\ \ \ \textcolor{comment}{//\ uint8\_t*\ start\ =\ mi\_page\_start(page);}}
\DoxyCodeLine{00088\ \ \ \textcolor{comment}{//mi\_assert\_internal(start\ +\ page-\/>capacity*page-\/>block\_size\ ==\ page-\/>top);}}
\DoxyCodeLine{00089\ }
\DoxyCodeLine{00090\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(mi\_page\_list\_is\_valid(page,page-\/>\mbox{\hyperlink{structmi__page__s_ae2d4b1c483d94e3624319bbca00d3da3}{free}}));}
\DoxyCodeLine{00091\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(mi\_page\_list\_is\_valid(page,page-\/>\mbox{\hyperlink{structmi__page__s_a9ed7774dcbd4de583d1594d698128830}{local\_free}}));}
\DoxyCodeLine{00092\ }
\DoxyCodeLine{00093\ \textcolor{preprocessor}{\ \ \#if\ MI\_DEBUG>3\ }\textcolor{comment}{//\ generally\ too\ expensive\ to\ check\ this}}
\DoxyCodeLine{00094\ \ \ \textcolor{keywordflow}{if}\ (page-\/>\mbox{\hyperlink{structmi__page__s_ad01f597f484f95c73fd5085168e4be34}{free\_is\_zero}})\ \{}
\DoxyCodeLine{00095\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ ubsize\ =\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a432abca03d059a7d40d8d39617afc8f7}{mi\_page\_usable\_block\_size}}(page);}
\DoxyCodeLine{00096\ \ \ \ \ \textcolor{keywordflow}{for}(\mbox{\hyperlink{types_8h_a9a69f9a34bc130b6a51162b980e9c631}{mi\_block\_t}}*\ \mbox{\hyperlink{mimalloc_8h_a840cb394e7433c7fe0c4875a3030c955}{block}}\ =\ page-\/>\mbox{\hyperlink{structmi__page__s_ae2d4b1c483d94e3624319bbca00d3da3}{free}};\ \mbox{\hyperlink{mimalloc_8h_a840cb394e7433c7fe0c4875a3030c955}{block}}\ !=\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}};\ \mbox{\hyperlink{mimalloc_8h_a840cb394e7433c7fe0c4875a3030c955}{block}}\ =\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_aaa5daf3a8b3db89666b6861cbb1e2f96}{mi\_block\_next}}(page,\mbox{\hyperlink{mimalloc_8h_a840cb394e7433c7fe0c4875a3030c955}{block}}))\ \{}
\DoxyCodeLine{00097\ \ \ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ab812423812d2dd7af864b7e112055d8e}{mi\_assert\_expensive}}(\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a8391ae55dd6885bd38593f740fd349a4}{mi\_mem\_is\_zero}}(\mbox{\hyperlink{mimalloc_8h_a840cb394e7433c7fe0c4875a3030c955}{block}}\ +\ 1,\ ubsize\ -\/\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{types_8h_a9a69f9a34bc130b6a51162b980e9c631}{mi\_block\_t}})));}
\DoxyCodeLine{00098\ \ \ \ \ \}}
\DoxyCodeLine{00099\ \ \ \}}
\DoxyCodeLine{00100\ \textcolor{preprocessor}{\ \ \#endif}}
\DoxyCodeLine{00101\ }
\DoxyCodeLine{00102\ \textcolor{preprocessor}{\ \ \#if\ !MI\_TRACK\_ENABLED\ \&\&\ !MI\_TSAN}}
\DoxyCodeLine{00103\ \ \ \mbox{\hyperlink{types_8h_a9a69f9a34bc130b6a51162b980e9c631}{mi\_block\_t}}*\ tfree\ =\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_aa8e0e6183cf707bee8707e2f5f5e5c3e}{mi\_page\_thread\_free}}(page);}
\DoxyCodeLine{00104\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(mi\_page\_list\_is\_valid(page,\ tfree));}
\DoxyCodeLine{00105\ \ \ \textcolor{comment}{//size\_t\ tfree\_count\ =\ mi\_page\_list\_count(page,\ tfree);}}
\DoxyCodeLine{00106\ \ \ \textcolor{comment}{//mi\_assert\_internal(tfree\_count\ <=\ page-\/>thread\_freed\ +\ 1);}}
\DoxyCodeLine{00107\ \textcolor{preprocessor}{\ \ \#endif}}
\DoxyCodeLine{00108\ }
\DoxyCodeLine{00109\ \ \ \textcolor{keywordtype}{size\_t}\ free\_count\ =\ mi\_page\_list\_count(page,\ page-\/>\mbox{\hyperlink{structmi__page__s_ae2d4b1c483d94e3624319bbca00d3da3}{free}})\ +\ mi\_page\_list\_count(page,\ page-\/>\mbox{\hyperlink{structmi__page__s_a9ed7774dcbd4de583d1594d698128830}{local\_free}});}
\DoxyCodeLine{00110\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(page-\/>\mbox{\hyperlink{structmi__page__s_ad1194a6cecba67ba2cf1952eb337968c}{used}}\ +\ free\_count\ ==\ page-\/>\mbox{\hyperlink{structmi__page__s_a9ed1099a997d9c4e42b3bbe631705e41}{capacity}});}
\DoxyCodeLine{00111\ }
\DoxyCodeLine{00112\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00113\ \}}
\DoxyCodeLine{00114\ }
\DoxyCodeLine{00115\ \textcolor{keyword}{extern}\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{prim_8h_ab5af7a82b82b0b434e115f6c57289ddb}{\_mi\_process\_is\_initialized}};\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ has\ mi\_process\_init\ been\ called?}}
\DoxyCodeLine{00116\ }
\DoxyCodeLine{00117\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_af1d572618734511626662f9f7befb8e9}{\_mi\_page\_is\_valid}}(\mbox{\hyperlink{types_8h_a98e3d539b4113aac496ebe3d379ebe5b}{mi\_page\_t}}*\ page)\ \{}
\DoxyCodeLine{00118\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(mi\_page\_is\_valid\_init(page));}
\DoxyCodeLine{00119\ \textcolor{preprocessor}{\ \ \#if\ MI\_SECURE}}
\DoxyCodeLine{00120\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(page-\/>\mbox{\hyperlink{structmi__page__s_a720620090a6e049d89c015c647900034}{keys}}[0]\ !=\ 0);}
\DoxyCodeLine{00121\ \textcolor{preprocessor}{\ \ \#endif}}
\DoxyCodeLine{00122\ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_aa75f964d916bd58a37861b88491c51fb}{mi\_page\_is\_abandoned}}(page))\ \{}
\DoxyCodeLine{00123\ \ \ \ \ \textcolor{comment}{//mi\_assert\_internal(!\_mi\_process\_is\_initialized);}}
\DoxyCodeLine{00124\ \ \ \ \ \{}
\DoxyCodeLine{00125\ \ \ \ \ \ \ \mbox{\hyperlink{types_8h_a9646624e7de8587984ec8e8cd5c5d780}{mi\_page\_queue\_t}}*\ pq\ =\ \mbox{\hyperlink{page-queue_8c_a59942bb22e34833289b85a5c70d81f97}{mi\_page\_queue\_of}}(page);}
\DoxyCodeLine{00126\ \ \ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(mi\_page\_queue\_contains(pq,\ page));}
\DoxyCodeLine{00127\ \ \ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(pq-\/>\mbox{\hyperlink{structmi__page__queue__s_a650100de75005e34566b2d170db7c0e8}{block\_size}}==\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a6134893990c1f09da2b40092ceecc780}{mi\_page\_block\_size}}(page)\ ||\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_aebe1b18846bd3fc16de5b52cd2250bec}{mi\_page\_is\_huge}}(page)\ ||\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a250f4d0710309fb1cff782cd06644842}{mi\_page\_is\_in\_full}}(page));}
\DoxyCodeLine{00128\ \ \ \ \ \ \ \textcolor{comment}{//\ mi\_assert\_internal(mi\_heap\_contains\_queue(mi\_page\_heap(page),pq));}}
\DoxyCodeLine{00129\ \ \ \ \ \}}
\DoxyCodeLine{00130\ \ \ \}}
\DoxyCodeLine{00131\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00132\ \}}
\DoxyCodeLine{00133\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00134\ }
\DoxyCodeLine{00135\ }
\DoxyCodeLine{00136\ \textcolor{comment}{/*\ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00137\ \textcolor{comment}{\ \ Page\ collect\ the\ \`{}local\_free`\ and\ \`{}thread\_free`\ lists}}
\DoxyCodeLine{00138\ \textcolor{comment}{-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/\ */}}
\DoxyCodeLine{00139\ }
\DoxyCodeLine{00140\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{page_8c_a6ab1a3c44e97e77d8828e78fcee13600}{mi\_page\_thread\_collect\_to\_local}}(\mbox{\hyperlink{types_8h_a98e3d539b4113aac496ebe3d379ebe5b}{mi\_page\_t}}*\ page,\ \mbox{\hyperlink{types_8h_a9a69f9a34bc130b6a51162b980e9c631}{mi\_block\_t}}*\ head)}
\DoxyCodeLine{00141\ \{}
\DoxyCodeLine{00142\ \ \ \textcolor{keywordflow}{if}\ (head\ ==\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}})\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00143\ }
\DoxyCodeLine{00144\ \ \ \textcolor{comment}{//\ find\ the\ last\ block\ in\ the\ list\ -\/-\/\ also\ to\ get\ a\ proper\ use\ count\ (without\ data\ races)}}
\DoxyCodeLine{00145\ \ \ \textcolor{keywordtype}{size\_t}\ max\_count\ =\ page-\/>\mbox{\hyperlink{structmi__page__s_a9ed1099a997d9c4e42b3bbe631705e41}{capacity}};\ \textcolor{comment}{//\ cannot\ collect\ more\ than\ capacity}}
\DoxyCodeLine{00146\ \ \ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{imgui__impl__opengl3__loader_8h_a619bc20e8198de3bd3f3d7fc34de66b2}{count}}\ =\ 1;}
\DoxyCodeLine{00147\ \ \ \mbox{\hyperlink{types_8h_a9a69f9a34bc130b6a51162b980e9c631}{mi\_block\_t}}*\ last\ =\ head;}
\DoxyCodeLine{00148\ \ \ \mbox{\hyperlink{types_8h_a9a69f9a34bc130b6a51162b980e9c631}{mi\_block\_t}}*\ next;}
\DoxyCodeLine{00149\ \ \ \textcolor{keywordflow}{while}\ ((next\ =\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_aaa5daf3a8b3db89666b6861cbb1e2f96}{mi\_block\_next}}(page,\ last))\ !=\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}}\ \&\&\ \mbox{\hyperlink{imgui__impl__opengl3__loader_8h_a619bc20e8198de3bd3f3d7fc34de66b2}{count}}\ <=\ max\_count)\ \{}
\DoxyCodeLine{00150\ \ \ \ \ \mbox{\hyperlink{imgui__impl__opengl3__loader_8h_a619bc20e8198de3bd3f3d7fc34de66b2}{count}}++;}
\DoxyCodeLine{00151\ \ \ \ \ last\ =\ next;}
\DoxyCodeLine{00152\ \ \ \}}
\DoxyCodeLine{00153\ }
\DoxyCodeLine{00154\ \ \ \textcolor{comment}{//\ if\ \`{}count\ >\ max\_count`\ there\ was\ a\ memory\ corruption\ (possibly\ infinite\ list\ due\ to\ double\ multi-\/threaded\ free)}}
\DoxyCodeLine{00155\ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{imgui__impl__opengl3__loader_8h_a619bc20e8198de3bd3f3d7fc34de66b2}{count}}\ >\ max\_count)\ \{}
\DoxyCodeLine{00156\ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2atomic_8h_a2bebc073bcaac71658e57bb260c2e426}{\_mi\_error\_message}}(\mbox{\hyperlink{types_8h_a3f317946e043623f9d6b93dbf60e6316}{EFAULT}},\ \textcolor{stringliteral}{"{}corrupted\ thread-\/free\ list\(\backslash\)n"{}});}
\DoxyCodeLine{00157\ \ \ \ \ \textcolor{keywordflow}{return};\ \textcolor{comment}{//\ the\ thread-\/free\ items\ cannot\ be\ freed}}
\DoxyCodeLine{00158\ \ \ \}}
\DoxyCodeLine{00159\ }
\DoxyCodeLine{00160\ \ \ \textcolor{comment}{//\ and\ append\ the\ current\ local\ free\ list}}
\DoxyCodeLine{00161\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac7b440a922454c163ed1139aac9b946d}{mi\_block\_set\_next}}(page,\ last,\ page-\/>\mbox{\hyperlink{structmi__page__s_a9ed7774dcbd4de583d1594d698128830}{local\_free}});}
\DoxyCodeLine{00162\ \ \ page-\/>\mbox{\hyperlink{structmi__page__s_a9ed7774dcbd4de583d1594d698128830}{local\_free}}\ =\ head;}
\DoxyCodeLine{00163\ }
\DoxyCodeLine{00164\ \ \ \textcolor{comment}{//\ update\ counts\ now}}
\DoxyCodeLine{00165\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(\mbox{\hyperlink{imgui__impl__opengl3__loader_8h_a619bc20e8198de3bd3f3d7fc34de66b2}{count}}\ <=\ \mbox{\hyperlink{eabase_8h_a3ea490c9b3617d4479bd80ef93cd5602}{UINT16\_MAX}});}
\DoxyCodeLine{00166\ \ \ page-\/>\mbox{\hyperlink{structmi__page__s_ad1194a6cecba67ba2cf1952eb337968c}{used}}\ =\ page-\/>\mbox{\hyperlink{structmi__page__s_ad1194a6cecba67ba2cf1952eb337968c}{used}}\ -\/\ (\mbox{\hyperlink{eabase_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t}})\mbox{\hyperlink{imgui__impl__opengl3__loader_8h_a619bc20e8198de3bd3f3d7fc34de66b2}{count}};}
\DoxyCodeLine{00167\ \}}
\DoxyCodeLine{00168\ }
\DoxyCodeLine{00169\ \textcolor{comment}{//\ Collect\ the\ local\ \`{}thread\_free`\ list\ using\ an\ atomic\ exchange.}}
\DoxyCodeLine{00170\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{page_8c_a295cb69a2c761ab5f15f2defe7fb31fe}{mi\_page\_thread\_free\_collect}}(\mbox{\hyperlink{types_8h_a98e3d539b4113aac496ebe3d379ebe5b}{mi\_page\_t}}*\ page)}
\DoxyCodeLine{00171\ \{}
\DoxyCodeLine{00172\ \ \ \textcolor{comment}{//\ atomically\ capture\ the\ thread\ free\ list}}
\DoxyCodeLine{00173\ \ \ \mbox{\hyperlink{types_8h_a9a69f9a34bc130b6a51162b980e9c631}{mi\_block\_t}}*\ head;}
\DoxyCodeLine{00174\ \ \ \mbox{\hyperlink{types_8h_aa9fb16bc3b4469d57c7b2747c6718b15}{mi\_thread\_free\_t}}\ tfreex;}
\DoxyCodeLine{00175\ \ \ \mbox{\hyperlink{types_8h_aa9fb16bc3b4469d57c7b2747c6718b15}{mi\_thread\_free\_t}}\ tfree\ =\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2atomic_8h_ae060cc1d6be8764ac2170e1a0d91dd5e}{mi\_atomic\_load\_relaxed}}(\&page-\/>xthread\_free);}
\DoxyCodeLine{00176\ \ \ \textcolor{keywordflow}{do}\ \{}
\DoxyCodeLine{00177\ \ \ \ \ head\ =\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a68f9b45db9fe19930366d0e473bdf791}{mi\_tf\_block}}(tfree);}
\DoxyCodeLine{00178\ \ \ \ \ \textcolor{keywordflow}{if}\ \mbox{\hyperlink{bits_8h_a7b29eabf31d4ddb28a16267045384e03}{mi\_likely}}(head\ ==\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}})\ \textcolor{keywordflow}{return};\ \textcolor{comment}{//\ return\ if\ the\ list\ is\ empty}}
\DoxyCodeLine{00179\ \ \ \ \ tfreex\ =\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ae5ecd5e45278bd147fbe6720cba0f323}{mi\_tf\_create}}(\mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}},\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_aa501cc20d36064923e3d70c4a08879c4}{mi\_tf\_is\_owned}}(tfree));\ \ \textcolor{comment}{//\ set\ the\ thread\ free\ list\ to\ NULL}}
\DoxyCodeLine{00180\ \ \ \}\ \textcolor{keywordflow}{while}\ (!\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2atomic_8h_a04332d02087d9b0e7ad9197c34358177}{mi\_atomic\_cas\_weak\_acq\_rel}}(\&page-\/>xthread\_free,\ \&tfree,\ tfreex));\ \ \textcolor{comment}{//\ release\ is\ enough?}}
\DoxyCodeLine{00181\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(head\ !=\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}});}
\DoxyCodeLine{00182\ }
\DoxyCodeLine{00183\ \ \ \textcolor{comment}{//\ and\ move\ it\ to\ the\ local\ list}}
\DoxyCodeLine{00184\ \ \ \mbox{\hyperlink{page_8c_a6ab1a3c44e97e77d8828e78fcee13600}{mi\_page\_thread\_collect\_to\_local}}(page,\ head);}
\DoxyCodeLine{00185\ \}}
\DoxyCodeLine{00186\ }
\DoxyCodeLine{00187\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{page_8c_ae2b78e1e45e4ac3db8102e9d333d2972}{\_mi\_page\_free\_collect}}(\mbox{\hyperlink{types_8h_a98e3d539b4113aac496ebe3d379ebe5b}{mi\_page\_t}}*\ page,\ \textcolor{keywordtype}{bool}\ force)\ \{}
\DoxyCodeLine{00188\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(page!=\mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}});}
\DoxyCodeLine{00189\ }
\DoxyCodeLine{00190\ \ \ \textcolor{comment}{//\ collect\ the\ thread\ free\ list}}
\DoxyCodeLine{00191\ \ \ \mbox{\hyperlink{page_8c_a295cb69a2c761ab5f15f2defe7fb31fe}{mi\_page\_thread\_free\_collect}}(page);}
\DoxyCodeLine{00192\ }
\DoxyCodeLine{00193\ \ \ \textcolor{comment}{//\ and\ the\ local\ free\ list}}
\DoxyCodeLine{00194\ \ \ \textcolor{keywordflow}{if}\ (page-\/>\mbox{\hyperlink{structmi__page__s_a9ed7774dcbd4de583d1594d698128830}{local\_free}}\ !=\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}})\ \{}
\DoxyCodeLine{00195\ \ \ \ \ \textcolor{keywordflow}{if}\ \mbox{\hyperlink{bits_8h_a7b29eabf31d4ddb28a16267045384e03}{mi\_likely}}(page-\/>\mbox{\hyperlink{structmi__page__s_ae2d4b1c483d94e3624319bbca00d3da3}{free}}\ ==\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}})\ \{}
\DoxyCodeLine{00196\ \ \ \ \ \ \ \textcolor{comment}{//\ usual\ case}}
\DoxyCodeLine{00197\ \ \ \ \ \ \ page-\/>\mbox{\hyperlink{structmi__page__s_ae2d4b1c483d94e3624319bbca00d3da3}{free}}\ =\ page-\/>\mbox{\hyperlink{structmi__page__s_a9ed7774dcbd4de583d1594d698128830}{local\_free}};}
\DoxyCodeLine{00198\ \ \ \ \ \ \ page-\/>\mbox{\hyperlink{structmi__page__s_a9ed7774dcbd4de583d1594d698128830}{local\_free}}\ =\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}};}
\DoxyCodeLine{00199\ \ \ \ \ \ \ page-\/>\mbox{\hyperlink{structmi__page__s_ad01f597f484f95c73fd5085168e4be34}{free\_is\_zero}}\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00200\ \ \ \ \ \}}
\DoxyCodeLine{00201\ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (force)\ \{}
\DoxyCodeLine{00202\ \ \ \ \ \ \ \textcolor{comment}{//\ append\ -\/-\/\ only\ on\ shutdown\ (force)\ as\ this\ is\ a\ linear\ operation}}
\DoxyCodeLine{00203\ \ \ \ \ \ \ \mbox{\hyperlink{types_8h_a9a69f9a34bc130b6a51162b980e9c631}{mi\_block\_t}}*\ tail\ =\ page-\/>\mbox{\hyperlink{structmi__page__s_a9ed7774dcbd4de583d1594d698128830}{local\_free}};}
\DoxyCodeLine{00204\ \ \ \ \ \ \ \mbox{\hyperlink{types_8h_a9a69f9a34bc130b6a51162b980e9c631}{mi\_block\_t}}*\ next;}
\DoxyCodeLine{00205\ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ ((next\ =\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_aaa5daf3a8b3db89666b6861cbb1e2f96}{mi\_block\_next}}(page,\ tail))\ !=\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}})\ \{}
\DoxyCodeLine{00206\ \ \ \ \ \ \ \ \ tail\ =\ next;}
\DoxyCodeLine{00207\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00208\ \ \ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac7b440a922454c163ed1139aac9b946d}{mi\_block\_set\_next}}(page,\ tail,\ page-\/>\mbox{\hyperlink{structmi__page__s_ae2d4b1c483d94e3624319bbca00d3da3}{free}});}
\DoxyCodeLine{00209\ \ \ \ \ \ \ page-\/>\mbox{\hyperlink{structmi__page__s_ae2d4b1c483d94e3624319bbca00d3da3}{free}}\ =\ page-\/>\mbox{\hyperlink{structmi__page__s_a9ed7774dcbd4de583d1594d698128830}{local\_free}};}
\DoxyCodeLine{00210\ \ \ \ \ \ \ page-\/>\mbox{\hyperlink{structmi__page__s_a9ed7774dcbd4de583d1594d698128830}{local\_free}}\ =\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}};}
\DoxyCodeLine{00211\ \ \ \ \ \ \ page-\/>\mbox{\hyperlink{structmi__page__s_ad01f597f484f95c73fd5085168e4be34}{free\_is\_zero}}\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00212\ \ \ \ \ \}}
\DoxyCodeLine{00213\ \ \ \}}
\DoxyCodeLine{00214\ }
\DoxyCodeLine{00215\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(!force\ ||\ page-\/>\mbox{\hyperlink{structmi__page__s_a9ed7774dcbd4de583d1594d698128830}{local\_free}}\ ==\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}});}
\DoxyCodeLine{00216\ \}}
\DoxyCodeLine{00217\ }
\DoxyCodeLine{00218\ \textcolor{comment}{//\ Collect\ elements\ in\ the\ thread-\/free\ list\ starting\ at\ \`{}head`.\ This\ is\ an\ optimized}}
\DoxyCodeLine{00219\ \textcolor{comment}{//\ version\ of\ \`{}\_mi\_page\_free\_collect`\ to\ be\ used\ from\ \`{}free.c:\_mi\_free\_collect\_mt`\ that\ avoids\ atomic\ access\ to\ \`{}xthread\_free`.}}
\DoxyCodeLine{00220\ \textcolor{comment}{//}}
\DoxyCodeLine{00221\ \textcolor{comment}{//\ \`{}head`\ must\ be\ in\ the\ \`{}xthread\_free`\ list.\ It\ will\ not\ collect\ \`{}head`\ itself}}
\DoxyCodeLine{00222\ \textcolor{comment}{//\ so\ the\ \`{}used`\ count\ is\ not\ fully\ updated\ in\ general.\ However,\ if\ the\ \`{}head`\ is}}
\DoxyCodeLine{00223\ \textcolor{comment}{//\ the\ last\ remaining\ element,\ it\ will\ be\ collected\ and\ the\ used\ count\ will\ become\ \`{}0`\ (so\ \`{}mi\_page\_all\_free`\ becomes\ true).}}
\DoxyCodeLine{00224\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{page_8c_a3b5fe83ce56d2ef2de030cc40f8a1d29}{\_mi\_page\_free\_collect\_partly}}(\mbox{\hyperlink{types_8h_a98e3d539b4113aac496ebe3d379ebe5b}{mi\_page\_t}}*\ page,\ \mbox{\hyperlink{types_8h_a9a69f9a34bc130b6a51162b980e9c631}{mi\_block\_t}}*\ head)\ \{}
\DoxyCodeLine{00225\ \ \ \textcolor{keywordflow}{if}\ (head\ ==\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}})\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00226\ \ \ \mbox{\hyperlink{types_8h_a9a69f9a34bc130b6a51162b980e9c631}{mi\_block\_t}}*\ next\ =\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_aaa5daf3a8b3db89666b6861cbb1e2f96}{mi\_block\_next}}(page,head);\ \ \textcolor{comment}{//\ we\ cannot\ collect\ the\ head\ element\ itself\ as\ \`{}page-\/>thread\_free`\ may\ point\ to\ it\ (and\ we\ want\ to\ avoid\ atomic\ ops)}}
\DoxyCodeLine{00227\ \ \ \textcolor{keywordflow}{if}\ (next\ !=\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}})\ \{}
\DoxyCodeLine{00228\ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac7b440a922454c163ed1139aac9b946d}{mi\_block\_set\_next}}(page,\ head,\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}});}
\DoxyCodeLine{00229\ \ \ \ \ \mbox{\hyperlink{page_8c_a6ab1a3c44e97e77d8828e78fcee13600}{mi\_page\_thread\_collect\_to\_local}}(page,\ next);}
\DoxyCodeLine{00230\ \ \ \ \ \textcolor{keywordflow}{if}\ (page-\/>\mbox{\hyperlink{structmi__page__s_a9ed7774dcbd4de583d1594d698128830}{local\_free}}\ !=\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}}\ \&\&\ page-\/>\mbox{\hyperlink{structmi__page__s_ae2d4b1c483d94e3624319bbca00d3da3}{free}}\ ==\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}})\ \{}
\DoxyCodeLine{00231\ \ \ \ \ \ \ page-\/>\mbox{\hyperlink{structmi__page__s_ae2d4b1c483d94e3624319bbca00d3da3}{free}}\ =\ page-\/>\mbox{\hyperlink{structmi__page__s_a9ed7774dcbd4de583d1594d698128830}{local\_free}};}
\DoxyCodeLine{00232\ \ \ \ \ \ \ page-\/>\mbox{\hyperlink{structmi__page__s_a9ed7774dcbd4de583d1594d698128830}{local\_free}}\ =\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}};}
\DoxyCodeLine{00233\ \ \ \ \ \ \ page-\/>\mbox{\hyperlink{structmi__page__s_ad01f597f484f95c73fd5085168e4be34}{free\_is\_zero}}\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00234\ \ \ \ \ \}}
\DoxyCodeLine{00235\ \ \ \}}
\DoxyCodeLine{00236\ \ \ \textcolor{keywordflow}{if}\ (page-\/>\mbox{\hyperlink{structmi__page__s_ad1194a6cecba67ba2cf1952eb337968c}{used}}\ ==\ 1)\ \{}
\DoxyCodeLine{00237\ \ \ \ \ \textcolor{comment}{//\ all\ elements\ are\ free'd\ since\ we\ skipped\ the\ \`{}head`\ element\ itself}}
\DoxyCodeLine{00238\ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a68f9b45db9fe19930366d0e473bdf791}{mi\_tf\_block}}(\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2atomic_8h_ae060cc1d6be8764ac2170e1a0d91dd5e}{mi\_atomic\_load\_relaxed}}(\&page-\/>xthread\_free))\ ==\ head);}
\DoxyCodeLine{00239\ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_aaa5daf3a8b3db89666b6861cbb1e2f96}{mi\_block\_next}}(page,head)\ ==\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}});}
\DoxyCodeLine{00240\ \ \ \ \ \mbox{\hyperlink{page_8c_ae2b78e1e45e4ac3db8102e9d333d2972}{\_mi\_page\_free\_collect}}(page,\ \textcolor{keyword}{false});\ \ \textcolor{comment}{//\ collect\ the\ final\ element}}
\DoxyCodeLine{00241\ \ \ \}}
\DoxyCodeLine{00242\ \}}
\DoxyCodeLine{00243\ }
\DoxyCodeLine{00244\ }
\DoxyCodeLine{00245\ \textcolor{comment}{/*\ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00246\ \textcolor{comment}{\ \ Page\ fresh\ and\ retire}}
\DoxyCodeLine{00247\ \textcolor{comment}{-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/\ */}}
\DoxyCodeLine{00248\ }
\DoxyCodeLine{00249\ \textcolor{comment}{/*}}
\DoxyCodeLine{00250\ \textcolor{comment}{//\ called\ from\ segments\ when\ reclaiming\ abandoned\ pages}}
\DoxyCodeLine{00251\ \textcolor{comment}{void\ \_mi\_page\_reclaim(mi\_heap\_t*\ heap,\ mi\_page\_t*\ page)\ \{}}
\DoxyCodeLine{00252\ \textcolor{comment}{\ \ //\ mi\_page\_set\_heap(page,\ heap);}}
\DoxyCodeLine{00253\ \textcolor{comment}{\ \ //\ \_mi\_page\_use\_delayed\_free(page,\ MI\_USE\_DELAYED\_FREE,\ true);\ //\ override\ never\ (after\ heap\ is\ set)}}
\DoxyCodeLine{00254\ \textcolor{comment}{\ \ \_mi\_page\_free\_collect(page,\ false);\ //\ ensure\ used\ count\ is\ up\ to\ date}}
\DoxyCodeLine{00255\ \textcolor{comment}{}}
\DoxyCodeLine{00256\ \textcolor{comment}{\ \ mi\_assert\_expensive(mi\_page\_is\_valid\_init(page));}}
\DoxyCodeLine{00257\ \textcolor{comment}{\ \ //\ mi\_assert\_internal(mi\_page\_heap(page)\ ==\ heap);}}
\DoxyCodeLine{00258\ \textcolor{comment}{\ \ //\ mi\_assert\_internal(mi\_page\_thread\_free\_flag(page)\ !=\ MI\_NEVER\_DELAYED\_FREE);}}
\DoxyCodeLine{00259\ \textcolor{comment}{}}
\DoxyCodeLine{00260\ \textcolor{comment}{\ \ //\ TODO:\ push\ on\ full\ queue\ immediately\ if\ it\ is\ full?}}
\DoxyCodeLine{00261\ \textcolor{comment}{\ \ mi\_page\_queue\_t*\ pq\ =\ mi\_heap\_page\_queue\_of(heap,\ page);}}
\DoxyCodeLine{00262\ \textcolor{comment}{\ \ mi\_page\_queue\_push(heap,\ pq,\ page);}}
\DoxyCodeLine{00263\ \textcolor{comment}{\ \ mi\_assert\_expensive(\_mi\_page\_is\_valid(page));}}
\DoxyCodeLine{00264\ \textcolor{comment}{\}}}
\DoxyCodeLine{00265\ \textcolor{comment}{*/}}
\DoxyCodeLine{00266\ }
\DoxyCodeLine{00267\ \textcolor{comment}{//\ called\ from\ \`{}mi\_free`\ on\ a\ reclaim,\ and\ fresh\_alloc\ if\ we\ get\ an\ abandoned\ page}}
\DoxyCodeLine{00268\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{page_8c_ab24ca86854e0fd0c95e516de2fdf3b7c}{\_mi\_heap\_page\_reclaim}}(\mbox{\hyperlink{group__heap_ga34a47cde5a5b38c29f1aa3c5e76943c2}{mi\_heap\_t}}*\ heap,\ \mbox{\hyperlink{types_8h_a98e3d539b4113aac496ebe3d379ebe5b}{mi\_page\_t}}*\ page)}
\DoxyCodeLine{00269\ \{}
\DoxyCodeLine{00270\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ad446ae4d82cbdbd78dfbe46fa2330555}{\_mi\_is\_aligned}}(page,\ \mbox{\hyperlink{types_8h_a8781001af23da7ff83732bc42002f385}{MI\_PAGE\_ALIGN}}));}
\DoxyCodeLine{00271\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_acd84a462a2045538d19ecc56e6cc29f6}{\_mi\_ptr\_page}}(page)==page);}
\DoxyCodeLine{00272\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_af56ec67c6f794de0f36d59a6390ab4c7}{mi\_page\_is\_owned}}(page));}
\DoxyCodeLine{00273\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_aa75f964d916bd58a37861b88491c51fb}{mi\_page\_is\_abandoned}}(page));}
\DoxyCodeLine{00274\ }
\DoxyCodeLine{00275\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a4f0664d2a3d9c81776a0f90311aef474}{mi\_page\_set\_heap}}(page,heap);}
\DoxyCodeLine{00276\ \ \ \mbox{\hyperlink{page_8c_ae2b78e1e45e4ac3db8102e9d333d2972}{\_mi\_page\_free\_collect}}(page,\ \textcolor{keyword}{false});\ \textcolor{comment}{//\ ensure\ used\ count\ is\ up\ to\ date}}
\DoxyCodeLine{00277\ \ \ \mbox{\hyperlink{types_8h_a9646624e7de8587984ec8e8cd5c5d780}{mi\_page\_queue\_t}}*\ pq\ =\ \mbox{\hyperlink{page-queue_8c_aa50524f852ac833fcf366b583c9ebfaa}{mi\_heap\_page\_queue\_of}}(heap,\ page);}
\DoxyCodeLine{00278\ \ \ \mbox{\hyperlink{page-queue_8c_a0d3fb7c2bfbe71e923d25b7fc395e981}{mi\_page\_queue\_push\_at\_end}}(heap,\ pq,\ page);}
\DoxyCodeLine{00279\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ab812423812d2dd7af864b7e112055d8e}{mi\_assert\_expensive}}(\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_af1d572618734511626662f9f7befb8e9}{\_mi\_page\_is\_valid}}(page));}
\DoxyCodeLine{00280\ \}}
\DoxyCodeLine{00281\ }
\DoxyCodeLine{00282\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{page_8c_a5659ebbee47f26d3a49e03e0c5f2da79}{\_mi\_page\_abandon}}(\mbox{\hyperlink{types_8h_a98e3d539b4113aac496ebe3d379ebe5b}{mi\_page\_t}}*\ page,\ \mbox{\hyperlink{types_8h_a9646624e7de8587984ec8e8cd5c5d780}{mi\_page\_queue\_t}}*\ pq)\ \{}
\DoxyCodeLine{00283\ \ \ \mbox{\hyperlink{page_8c_ae2b78e1e45e4ac3db8102e9d333d2972}{\_mi\_page\_free\_collect}}(page,\ \textcolor{keyword}{false});\ \textcolor{comment}{//\ ensure\ used\ count\ is\ up\ to\ date}}
\DoxyCodeLine{00284\ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_adfd6d23350810ca36986ffbc5459c93d}{mi\_page\_all\_free}}(page))\ \{}
\DoxyCodeLine{00285\ \ \ \ \ \mbox{\hyperlink{page_8c_a1c5c78a8becee842d5b9444a2ee67a3b}{\_mi\_page\_free}}(page,\ pq);}
\DoxyCodeLine{00286\ \ \ \}}
\DoxyCodeLine{00287\ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00288\ \ \ \ \ \mbox{\hyperlink{page-queue_8c_a01485cfc5cb05536f09df6d4d386fd28}{mi\_page\_queue\_remove}}(pq,\ page);}
\DoxyCodeLine{00289\ \ \ \ \ \mbox{\hyperlink{group__heap_ga34a47cde5a5b38c29f1aa3c5e76943c2}{mi\_heap\_t}}*\ heap\ =\ page-\/>\mbox{\hyperlink{structmi__page__s_a629f6d941b563c85042782dedf1f6301}{heap}};}
\DoxyCodeLine{00290\ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a4f0664d2a3d9c81776a0f90311aef474}{mi\_page\_set\_heap}}(page,\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}});}
\DoxyCodeLine{00291\ \ \ \ \ page-\/>\mbox{\hyperlink{structmi__page__s_a629f6d941b563c85042782dedf1f6301}{heap}}\ =\ heap;\ \textcolor{comment}{//\ dont\ set\ heap\ to\ NULL\ so\ we\ can\ reclaim\_on\_free\ within\ the\ same\ heap}}
\DoxyCodeLine{00292\ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a94794f8316131a0e247752751f30a059}{\_mi\_arenas\_page\_abandon}}(page,\ heap-\/>\mbox{\hyperlink{structmi__heap__s_a2e524aeb1b30f344a4f0b70e6cf6cb3a}{tld}});}
\DoxyCodeLine{00293\ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a6f7e5b0577ff900eb89e76701c43672f}{\_mi\_arenas\_collect}}(\textcolor{keyword}{false},\ \textcolor{keyword}{false},\ heap-\/>\mbox{\hyperlink{structmi__heap__s_a2e524aeb1b30f344a4f0b70e6cf6cb3a}{tld}});\ \textcolor{comment}{//\ allow\ purging}}
\DoxyCodeLine{00294\ \ \ \}}
\DoxyCodeLine{00295\ \}}
\DoxyCodeLine{00296\ }
\DoxyCodeLine{00297\ }
\DoxyCodeLine{00298\ \textcolor{comment}{//\ allocate\ a\ fresh\ page\ from\ a\ segment}}
\DoxyCodeLine{00299\ \textcolor{keyword}{static}\ \mbox{\hyperlink{types_8h_a98e3d539b4113aac496ebe3d379ebe5b}{mi\_page\_t}}*\ \mbox{\hyperlink{page_8c_afdce56576b07a6f0321c78f9ca906141}{mi\_page\_fresh\_alloc}}(\mbox{\hyperlink{group__heap_ga34a47cde5a5b38c29f1aa3c5e76943c2}{mi\_heap\_t}}*\ heap,\ \mbox{\hyperlink{types_8h_a9646624e7de8587984ec8e8cd5c5d780}{mi\_page\_queue\_t}}*\ pq,\ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{sugar_8h_a9766f5ceca5e25981858ec7384456072}{block\_size}},\ \textcolor{keywordtype}{size\_t}\ page\_alignment)\ \{}
\DoxyCodeLine{00300\ \textcolor{preprocessor}{\ \ \#if\ !MI\_HUGE\_PAGE\_ABANDON}}
\DoxyCodeLine{00301\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(pq\ !=\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}});}
\DoxyCodeLine{00302\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(mi\_heap\_contains\_queue(heap,\ pq));}
\DoxyCodeLine{00303\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(page\_alignment\ >\ 0\ ||\ \mbox{\hyperlink{sugar_8h_a9766f5ceca5e25981858ec7384456072}{block\_size}}\ >\ \mbox{\hyperlink{types_8h_aedfdf546ebfa1e91dcf909b8db7b21dc}{MI\_LARGE\_MAX\_OBJ\_SIZE}}\ ||\ \mbox{\hyperlink{sugar_8h_a9766f5ceca5e25981858ec7384456072}{block\_size}}\ ==\ pq-\/>\mbox{\hyperlink{structmi__page__queue__s_a650100de75005e34566b2d170db7c0e8}{block\_size}});}
\DoxyCodeLine{00304\ \textcolor{preprocessor}{\ \ \#endif}}
\DoxyCodeLine{00305\ \ \ \mbox{\hyperlink{types_8h_a98e3d539b4113aac496ebe3d379ebe5b}{mi\_page\_t}}*\ page\ =\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ad0b4a8850072d9dcd4f84afa9125666d}{\_mi\_arenas\_page\_alloc}}(heap,\ \mbox{\hyperlink{sugar_8h_a9766f5ceca5e25981858ec7384456072}{block\_size}},\ page\_alignment);}
\DoxyCodeLine{00306\ \ \ \textcolor{keywordflow}{if}\ (page\ ==\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}})\ \{}
\DoxyCodeLine{00307\ \ \ \ \ \textcolor{comment}{//\ out-\/of-\/memory}}
\DoxyCodeLine{00308\ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}};}
\DoxyCodeLine{00309\ \ \ \}}
\DoxyCodeLine{00310\ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_aa75f964d916bd58a37861b88491c51fb}{mi\_page\_is\_abandoned}}(page))\ \{}
\DoxyCodeLine{00311\ \ \ \ \ \mbox{\hyperlink{page_8c_ab24ca86854e0fd0c95e516de2fdf3b7c}{\_mi\_heap\_page\_reclaim}}(heap,\ page);}
\DoxyCodeLine{00312\ \ \ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a87596f606325115ec4f43046dfd3d64a}{mi\_page\_immediate\_available}}(page))\ \{}
\DoxyCodeLine{00313\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ad36cb8000f39dcfbc68c9d9b219d0397}{mi\_page\_is\_expandable}}(page))\ \{}
\DoxyCodeLine{00314\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{page_8c_a40c7a483e3c04fdcf8d9a16bc6e6cea5}{mi\_page\_extend\_free}}(heap,\ page);}
\DoxyCodeLine{00315\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00316\ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00317\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_af04c7a87bc1c69ef3e763a580f47a418}{mi\_assert}}(\textcolor{keyword}{false});\ \textcolor{comment}{//\ should\ not\ happen?}}
\DoxyCodeLine{00318\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}};}
\DoxyCodeLine{00319\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00320\ \ \ \ \ \}}
\DoxyCodeLine{00321\ \ \ \}}
\DoxyCodeLine{00322\ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (pq\ !=\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}})\ \{}
\DoxyCodeLine{00323\ \ \ \ \ \mbox{\hyperlink{page-queue_8c_afd208c53e5567aedf31759e91fcaee4c}{mi\_page\_queue\_push}}(heap,\ pq,\ page);}
\DoxyCodeLine{00324\ \ \ \}}
\DoxyCodeLine{00325\ \ \ \mbox{\hyperlink{types_8h_a196bcd7a8496ad2ced97ac89b5739988}{mi\_heap\_stat\_increase}}(heap,\ pages,\ 1);}
\DoxyCodeLine{00326\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(pq!=\mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}}\ ||\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a6134893990c1f09da2b40092ceecc780}{mi\_page\_block\_size}}(page)\ >=\ \mbox{\hyperlink{sugar_8h_a9766f5ceca5e25981858ec7384456072}{block\_size}});}
\DoxyCodeLine{00327\ \ \ \mbox{\hyperlink{types_8h_a196bcd7a8496ad2ced97ac89b5739988}{mi\_heap\_stat\_increase}}(heap,\ page\_bins[\mbox{\hyperlink{page-queue_8c_a9ffcf338faf74ed684dc0859345b4d6e}{mi\_page\_bin}}(page)],\ 1);}
\DoxyCodeLine{00328\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ab812423812d2dd7af864b7e112055d8e}{mi\_assert\_expensive}}(\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_af1d572618734511626662f9f7befb8e9}{\_mi\_page\_is\_valid}}(page));}
\DoxyCodeLine{00329\ \ \ \textcolor{keywordflow}{return}\ page;}
\DoxyCodeLine{00330\ \}}
\DoxyCodeLine{00331\ }
\DoxyCodeLine{00332\ \textcolor{comment}{//\ Get\ a\ fresh\ page\ to\ use}}
\DoxyCodeLine{00333\ \textcolor{keyword}{static}\ \mbox{\hyperlink{types_8h_a98e3d539b4113aac496ebe3d379ebe5b}{mi\_page\_t}}*\ \mbox{\hyperlink{page_8c_aa1a62243576442a73c1e37ff6f3ba5cd}{mi\_page\_fresh}}(\mbox{\hyperlink{group__heap_ga34a47cde5a5b38c29f1aa3c5e76943c2}{mi\_heap\_t}}*\ heap,\ \mbox{\hyperlink{types_8h_a9646624e7de8587984ec8e8cd5c5d780}{mi\_page\_queue\_t}}*\ pq)\ \{}
\DoxyCodeLine{00334\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(mi\_heap\_contains\_queue(heap,\ pq));}
\DoxyCodeLine{00335\ \ \ \mbox{\hyperlink{types_8h_a98e3d539b4113aac496ebe3d379ebe5b}{mi\_page\_t}}*\ page\ =\ \mbox{\hyperlink{page_8c_afdce56576b07a6f0321c78f9ca906141}{mi\_page\_fresh\_alloc}}(heap,\ pq,\ pq-\/>\mbox{\hyperlink{structmi__page__queue__s_a650100de75005e34566b2d170db7c0e8}{block\_size}},\ 0);}
\DoxyCodeLine{00336\ \ \ \textcolor{keywordflow}{if}\ (page==\mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}})\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}};}
\DoxyCodeLine{00337\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(pq-\/>\mbox{\hyperlink{structmi__page__queue__s_a650100de75005e34566b2d170db7c0e8}{block\_size}}==\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a6134893990c1f09da2b40092ceecc780}{mi\_page\_block\_size}}(page));}
\DoxyCodeLine{00338\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(pq==\mbox{\hyperlink{page-queue_8c_aa50524f852ac833fcf366b583c9ebfaa}{mi\_heap\_page\_queue\_of}}(heap,\ page));}
\DoxyCodeLine{00339\ \ \ \textcolor{keywordflow}{return}\ page;}
\DoxyCodeLine{00340\ \}}
\DoxyCodeLine{00341\ }
\DoxyCodeLine{00342\ }
\DoxyCodeLine{00343\ \textcolor{comment}{/*\ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00344\ \textcolor{comment}{\ \ Unfull,\ abandon,\ free\ and\ retire}}
\DoxyCodeLine{00345\ \textcolor{comment}{-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/\ */}}
\DoxyCodeLine{00346\ }
\DoxyCodeLine{00347\ \textcolor{comment}{//\ Move\ a\ page\ from\ the\ full\ list\ back\ to\ a\ regular\ list\ (called\ from\ thread-\/local\ mi\_free)}}
\DoxyCodeLine{00348\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{page_8c_a56fb2dd5b89d7848f041fc2f9ad189a0}{\_mi\_page\_unfull}}(\mbox{\hyperlink{types_8h_a98e3d539b4113aac496ebe3d379ebe5b}{mi\_page\_t}}*\ page)\ \{}
\DoxyCodeLine{00349\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(page\ !=\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}});}
\DoxyCodeLine{00350\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ab812423812d2dd7af864b7e112055d8e}{mi\_assert\_expensive}}(\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_af1d572618734511626662f9f7befb8e9}{\_mi\_page\_is\_valid}}(page));}
\DoxyCodeLine{00351\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a250f4d0710309fb1cff782cd06644842}{mi\_page\_is\_in\_full}}(page));}
\DoxyCodeLine{00352\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(!\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a35ba87308ac94f73791017e50d3ab4c7}{mi\_page\_heap}}(page)-\/>allow\_page\_abandon);}
\DoxyCodeLine{00353\ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a250f4d0710309fb1cff782cd06644842}{mi\_page\_is\_in\_full}}(page))\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00354\ }
\DoxyCodeLine{00355\ \ \ \mbox{\hyperlink{group__heap_ga34a47cde5a5b38c29f1aa3c5e76943c2}{mi\_heap\_t}}*\ heap\ =\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a35ba87308ac94f73791017e50d3ab4c7}{mi\_page\_heap}}(page);}
\DoxyCodeLine{00356\ \ \ \mbox{\hyperlink{types_8h_a9646624e7de8587984ec8e8cd5c5d780}{mi\_page\_queue\_t}}*\ pqfull\ =\ \&heap-\/>\mbox{\hyperlink{structmi__heap__s_a132c64106a2662761ee57ea5dd4a996b}{pages}}[\mbox{\hyperlink{types_8h_ade65859668d2b446caf257fbc8c8d684}{MI\_BIN\_FULL}}];}
\DoxyCodeLine{00357\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a4b587eab21fd150918b1c57244c17d27}{mi\_page\_set\_in\_full}}(page,\ \textcolor{keyword}{false});\ \textcolor{comment}{//\ to\ get\ the\ right\ queue}}
\DoxyCodeLine{00358\ \ \ \mbox{\hyperlink{types_8h_a9646624e7de8587984ec8e8cd5c5d780}{mi\_page\_queue\_t}}*\ pq\ =\ \mbox{\hyperlink{page-queue_8c_aa50524f852ac833fcf366b583c9ebfaa}{mi\_heap\_page\_queue\_of}}(heap,\ page);}
\DoxyCodeLine{00359\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a4b587eab21fd150918b1c57244c17d27}{mi\_page\_set\_in\_full}}(page,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00360\ \ \ \mbox{\hyperlink{page-queue_8c_aa4057c2fc6d8f9e1d6bb30ebbc3123aa}{mi\_page\_queue\_enqueue\_from\_full}}(pq,\ pqfull,\ page);}
\DoxyCodeLine{00361\ \}}
\DoxyCodeLine{00362\ }
\DoxyCodeLine{00363\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{page_8c_afb25978212749e522404ee1f2dd1a6d4}{mi\_page\_to\_full}}(\mbox{\hyperlink{types_8h_a98e3d539b4113aac496ebe3d379ebe5b}{mi\_page\_t}}*\ page,\ \mbox{\hyperlink{types_8h_a9646624e7de8587984ec8e8cd5c5d780}{mi\_page\_queue\_t}}*\ pq)\ \{}
\DoxyCodeLine{00364\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(pq\ ==\ \mbox{\hyperlink{page-queue_8c_a59942bb22e34833289b85a5c70d81f97}{mi\_page\_queue\_of}}(page));}
\DoxyCodeLine{00365\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(!\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a87596f606325115ec4f43046dfd3d64a}{mi\_page\_immediate\_available}}(page));}
\DoxyCodeLine{00366\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(!\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a250f4d0710309fb1cff782cd06644842}{mi\_page\_is\_in\_full}}(page));}
\DoxyCodeLine{00367\ }
\DoxyCodeLine{00368\ \ \ \mbox{\hyperlink{group__heap_ga34a47cde5a5b38c29f1aa3c5e76943c2}{mi\_heap\_t}}*\ heap\ =\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a35ba87308ac94f73791017e50d3ab4c7}{mi\_page\_heap}}(page);}
\DoxyCodeLine{00369\ \ \ \textcolor{keywordflow}{if}\ (heap-\/>\mbox{\hyperlink{structmi__heap__s_a8d500d2e3ccde6de4e60682df8ea58ea}{allow\_page\_abandon}})\ \{}
\DoxyCodeLine{00370\ \ \ \ \ \textcolor{comment}{//\ abandon\ full\ pages\ (this\ is\ the\ usual\ case\ in\ order\ to\ allow\ for\ sharing\ of\ memory\ between\ heaps)}}
\DoxyCodeLine{00371\ \ \ \ \ \mbox{\hyperlink{page_8c_a5659ebbee47f26d3a49e03e0c5f2da79}{\_mi\_page\_abandon}}(page,\ pq);}
\DoxyCodeLine{00372\ \ \ \}}
\DoxyCodeLine{00373\ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a250f4d0710309fb1cff782cd06644842}{mi\_page\_is\_in\_full}}(page))\ \{}
\DoxyCodeLine{00374\ \ \ \ \ \textcolor{comment}{//\ put\ full\ pages\ in\ a\ heap\ local\ queue\ (this\ is\ for\ heaps\ that\ cannot\ abandon,\ for\ example,\ if\ the\ heap\ can\ be\ destroyed)}}
\DoxyCodeLine{00375\ \ \ \ \ \mbox{\hyperlink{page-queue_8c_a78d4c34f8649f1bf65a3719e8861e32f}{mi\_page\_queue\_enqueue\_from}}(\&\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a35ba87308ac94f73791017e50d3ab4c7}{mi\_page\_heap}}(page)-\/>pages[\mbox{\hyperlink{types_8h_ade65859668d2b446caf257fbc8c8d684}{MI\_BIN\_FULL}}],\ pq,\ page);}
\DoxyCodeLine{00376\ \ \ \ \ \mbox{\hyperlink{page_8c_ae2b78e1e45e4ac3db8102e9d333d2972}{\_mi\_page\_free\_collect}}(page,\ \textcolor{keyword}{false});\ \ \textcolor{comment}{//\ try\ to\ collect\ right\ away\ in\ case\ another\ thread\ freed\ just\ before\ MI\_USE\_DELAYED\_FREE\ was\ set}}
\DoxyCodeLine{00377\ \ \ \}}
\DoxyCodeLine{00378\ \}}
\DoxyCodeLine{00379\ }
\DoxyCodeLine{00380\ }
\DoxyCodeLine{00381\ \textcolor{comment}{//\ Free\ a\ page\ with\ no\ more\ free\ blocks}}
\DoxyCodeLine{00382\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{page_8c_a1c5c78a8becee842d5b9444a2ee67a3b}{\_mi\_page\_free}}(\mbox{\hyperlink{types_8h_a98e3d539b4113aac496ebe3d379ebe5b}{mi\_page\_t}}*\ page,\ \mbox{\hyperlink{types_8h_a9646624e7de8587984ec8e8cd5c5d780}{mi\_page\_queue\_t}}*\ pq)\ \{}
\DoxyCodeLine{00383\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(page\ !=\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}});}
\DoxyCodeLine{00384\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ab812423812d2dd7af864b7e112055d8e}{mi\_assert\_expensive}}(\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_af1d572618734511626662f9f7befb8e9}{\_mi\_page\_is\_valid}}(page));}
\DoxyCodeLine{00385\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(pq\ ==\ \mbox{\hyperlink{page-queue_8c_a59942bb22e34833289b85a5c70d81f97}{mi\_page\_queue\_of}}(page));}
\DoxyCodeLine{00386\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_adfd6d23350810ca36986ffbc5459c93d}{mi\_page\_all\_free}}(page));}
\DoxyCodeLine{00387\ \ \ \textcolor{comment}{//\ mi\_assert\_internal(mi\_page\_thread\_free\_flag(page)!=MI\_DELAYED\_FREEING);}}
\DoxyCodeLine{00388\ }
\DoxyCodeLine{00389\ \ \ \textcolor{comment}{//\ no\ more\ aligned\ blocks\ in\ here}}
\DoxyCodeLine{00390\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a41000a967469e2e727f5f8670c8d37e1}{mi\_page\_set\_has\_aligned}}(page,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00391\ }
\DoxyCodeLine{00392\ \ \ \textcolor{comment}{//\ remove\ from\ the\ page\ list}}
\DoxyCodeLine{00393\ \ \ \textcolor{comment}{//\ (no\ need\ to\ do\ \_mi\_heap\_delayed\_free\ first\ as\ all\ blocks\ are\ already\ free)}}
\DoxyCodeLine{00394\ \ \ \mbox{\hyperlink{page-queue_8c_a01485cfc5cb05536f09df6d4d386fd28}{mi\_page\_queue\_remove}}(pq,\ page);}
\DoxyCodeLine{00395\ }
\DoxyCodeLine{00396\ \ \ \textcolor{comment}{//\ and\ free\ it}}
\DoxyCodeLine{00397\ \ \ \mbox{\hyperlink{group__heap_ga34a47cde5a5b38c29f1aa3c5e76943c2}{mi\_heap\_t}}*\ heap\ =\ page-\/>\mbox{\hyperlink{structmi__page__s_a629f6d941b563c85042782dedf1f6301}{heap}};}
\DoxyCodeLine{00398\ \ \ \mbox{\hyperlink{types_8h_a9a929f4920a380a78705a9dc7504945f}{mi\_heap\_stat\_decrease}}(heap,\ page\_bins[\mbox{\hyperlink{page-queue_8c_a9ffcf338faf74ed684dc0859345b4d6e}{mi\_page\_bin}}(page)],\ 1);}
\DoxyCodeLine{00399\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a4f0664d2a3d9c81776a0f90311aef474}{mi\_page\_set\_heap}}(page,\mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}});}
\DoxyCodeLine{00400\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a5c704481ee56f6588f680987f4359d45}{\_mi\_arenas\_page\_free}}(page);}
\DoxyCodeLine{00401\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a6f7e5b0577ff900eb89e76701c43672f}{\_mi\_arenas\_collect}}(\textcolor{keyword}{false},\ \textcolor{keyword}{false},\ heap-\/>\mbox{\hyperlink{structmi__heap__s_a2e524aeb1b30f344a4f0b70e6cf6cb3a}{tld}});\ \ \textcolor{comment}{//\ allow\ purging}}
\DoxyCodeLine{00402\ \}}
\DoxyCodeLine{00403\ }
\DoxyCodeLine{00404\ \textcolor{preprocessor}{\#define\ MI\_MAX\_RETIRE\_SIZE\ \ \ \ MI\_LARGE\_OBJ\_SIZE\_MAX\ \ \ }\textcolor{comment}{//\ should\ be\ less\ than\ size\ for\ MI\_BIN\_HUGE}}
\DoxyCodeLine{00405\ \textcolor{preprocessor}{\#define\ MI\_RETIRE\_CYCLES\ \ \ \ \ \ (16)}}
\DoxyCodeLine{00406\ }
\DoxyCodeLine{00407\ \textcolor{comment}{//\ Retire\ a\ page\ with\ no\ more\ used\ blocks}}
\DoxyCodeLine{00408\ \textcolor{comment}{//\ Important\ to\ not\ retire\ too\ quickly\ though\ as\ new}}
\DoxyCodeLine{00409\ \textcolor{comment}{//\ allocations\ might\ coming.}}
\DoxyCodeLine{00410\ \textcolor{comment}{//\ Note:\ called\ from\ \`{}mi\_free`\ and\ benchmarks\ often}}
\DoxyCodeLine{00411\ \textcolor{comment}{//\ trigger\ this\ due\ to\ freeing\ everything\ and\ then}}
\DoxyCodeLine{00412\ \textcolor{comment}{//\ allocating\ again\ so\ careful\ when\ changing\ this.}}
\DoxyCodeLine{00413\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{page_8c_a54b1e58a3b88604ea8dc4d9220f4c32c}{\_mi\_page\_retire}}(\mbox{\hyperlink{types_8h_a98e3d539b4113aac496ebe3d379ebe5b}{mi\_page\_t}}*\ page)\ \mbox{\hyperlink{mimalloc_8h_a2d1ca113437044da99abaaedd0b36ed8}{mi\_attr\_noexcept}}\ \{}
\DoxyCodeLine{00414\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(page\ !=\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}});}
\DoxyCodeLine{00415\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ab812423812d2dd7af864b7e112055d8e}{mi\_assert\_expensive}}(\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_af1d572618734511626662f9f7befb8e9}{\_mi\_page\_is\_valid}}(page));}
\DoxyCodeLine{00416\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_adfd6d23350810ca36986ffbc5459c93d}{mi\_page\_all\_free}}(page));}
\DoxyCodeLine{00417\ }
\DoxyCodeLine{00418\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a41000a967469e2e727f5f8670c8d37e1}{mi\_page\_set\_has\_aligned}}(page,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00419\ }
\DoxyCodeLine{00420\ \ \ \textcolor{comment}{//\ don't\ retire\ too\ often..}}
\DoxyCodeLine{00421\ \ \ \textcolor{comment}{//\ (or\ we\ end\ up\ retiring\ and\ re-\/allocating\ most\ of\ the\ time)}}
\DoxyCodeLine{00422\ \ \ \textcolor{comment}{//\ NOTE:\ refine\ this\ more:\ we\ should\ not\ retire\ if\ this}}
\DoxyCodeLine{00423\ \ \ \textcolor{comment}{//\ is\ the\ only\ page\ left\ with\ free\ blocks.\ It\ is\ not\ clear}}
\DoxyCodeLine{00424\ \ \ \textcolor{comment}{//\ how\ to\ check\ this\ efficiently\ though...}}
\DoxyCodeLine{00425\ \ \ \textcolor{comment}{//\ for\ now,\ we\ don't\ retire\ if\ it\ is\ the\ only\ page\ left\ of\ this\ size\ class.}}
\DoxyCodeLine{00426\ \ \ \mbox{\hyperlink{types_8h_a9646624e7de8587984ec8e8cd5c5d780}{mi\_page\_queue\_t}}*\ pq\ =\ \mbox{\hyperlink{page-queue_8c_a59942bb22e34833289b85a5c70d81f97}{mi\_page\_queue\_of}}(page);}
\DoxyCodeLine{00427\ \textcolor{preprocessor}{\ \ \#if\ MI\_RETIRE\_CYCLES\ >\ 0}}
\DoxyCodeLine{00428\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ bsize\ =\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a6134893990c1f09da2b40092ceecc780}{mi\_page\_block\_size}}(page);}
\DoxyCodeLine{00429\ \ \ \textcolor{keywordflow}{if}\ \mbox{\hyperlink{bits_8h_a7b29eabf31d4ddb28a16267045384e03}{mi\_likely}}(\ \textcolor{comment}{/*\ bsize\ <\ MI\_MAX\_RETIRE\_SIZE\ \&\&\ */}\ !\mbox{\hyperlink{page-queue_8c_aef6c208d531125d2a6d63e94020b8b89}{mi\_page\_queue\_is\_special}}(pq))\ \{\ \ \textcolor{comment}{//\ not\ full\ or\ huge\ queue?}}
\DoxyCodeLine{00430\ \ \ \ \ \textcolor{keywordflow}{if}\ (pq-\/>\mbox{\hyperlink{structmi__page__queue__s_a92703b3d44e0581c4037345a93081446}{last}}==page\ \&\&\ pq-\/>\mbox{\hyperlink{structmi__page__queue__s_a2ac5077507dc4bf25a1a8df36955469a}{first}}==page)\ \{\ \textcolor{comment}{//\ the\ only\ page\ in\ the\ queue?}}
\DoxyCodeLine{00431\ \ \ \ \ \ \ \mbox{\hyperlink{group__heap_ga34a47cde5a5b38c29f1aa3c5e76943c2}{mi\_heap\_t}}*\ heap\ =\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a35ba87308ac94f73791017e50d3ab4c7}{mi\_page\_heap}}(page);}
\DoxyCodeLine{00432\ \ \ \ \ \ \ \mbox{\hyperlink{types_8h_a94c9eeab401dfcde2f714195fe727540}{mi\_debug\_heap\_stat\_counter\_increase}}(heap,\ pages\_retire,\ 1);}
\DoxyCodeLine{00433\ \ \ \ \ \ \ page-\/>\mbox{\hyperlink{structmi__page__s_a0a5d0c55c032201268976344519a6842}{retire\_expire}}\ =\ (bsize\ <=\ \mbox{\hyperlink{types_8h_a27eff54c93bcddce7c482a8c6b58746d}{MI\_SMALL\_MAX\_OBJ\_SIZE}}\ ?\ \mbox{\hyperlink{page_8c_ac5f284991b73cb3ecc9a7fc7e83fe55c}{MI\_RETIRE\_CYCLES}}\ :\ \mbox{\hyperlink{page_8c_ac5f284991b73cb3ecc9a7fc7e83fe55c}{MI\_RETIRE\_CYCLES}}/4);}
\DoxyCodeLine{00434\ \ \ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(pq\ >=\ heap-\/>\mbox{\hyperlink{structmi__heap__s_a132c64106a2662761ee57ea5dd4a996b}{pages}});}
\DoxyCodeLine{00435\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{imgui__impl__opengl3__loader_8h_ab47dd9958bcadea08866b42bf358e95e}{index}}\ =\ pq\ -\/\ heap-\/>\mbox{\hyperlink{structmi__heap__s_a132c64106a2662761ee57ea5dd4a996b}{pages}};}
\DoxyCodeLine{00436\ \ \ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(\mbox{\hyperlink{imgui__impl__opengl3__loader_8h_ab47dd9958bcadea08866b42bf358e95e}{index}}\ <\ \mbox{\hyperlink{types_8h_ade65859668d2b446caf257fbc8c8d684}{MI\_BIN\_FULL}}\ \&\&\ \mbox{\hyperlink{imgui__impl__opengl3__loader_8h_ab47dd9958bcadea08866b42bf358e95e}{index}}\ <\ \mbox{\hyperlink{mimalloc-stats_8h_a8068f41e171eeed896f5e9981118874b}{MI\_BIN\_HUGE}});}
\DoxyCodeLine{00437\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{imgui__impl__opengl3__loader_8h_ab47dd9958bcadea08866b42bf358e95e}{index\ <\ heap-\/>}}page\_retired\_min)\ heap-\/>\mbox{\hyperlink{structmi__heap__s_a36bccfd0ae24a8358846037cb31f5c08}{page\_retired\_min}}\ =\ \mbox{\hyperlink{imgui__impl__opengl3__loader_8h_ab47dd9958bcadea08866b42bf358e95e}{index}};}
\DoxyCodeLine{00438\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{imgui__impl__opengl3__loader_8h_ab47dd9958bcadea08866b42bf358e95e}{index}}\ >\ heap-\/>\mbox{\hyperlink{structmi__heap__s_abee70406811029ca76f2609160b9c82b}{page\_retired\_max}})\ heap-\/>\mbox{\hyperlink{structmi__heap__s_abee70406811029ca76f2609160b9c82b}{page\_retired\_max}}\ =\ \mbox{\hyperlink{imgui__impl__opengl3__loader_8h_ab47dd9958bcadea08866b42bf358e95e}{index}};}
\DoxyCodeLine{00439\ \ \ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_adfd6d23350810ca36986ffbc5459c93d}{mi\_page\_all\_free}}(page));}
\DoxyCodeLine{00440\ \ \ \ \ \ \ \textcolor{keywordflow}{return};\ \textcolor{comment}{//\ don't\ free\ after\ all}}
\DoxyCodeLine{00441\ \ \ \ \ \}}
\DoxyCodeLine{00442\ \ \ \}}
\DoxyCodeLine{00443\ \textcolor{preprocessor}{\ \ \#endif}}
\DoxyCodeLine{00444\ \ \ \mbox{\hyperlink{page_8c_a1c5c78a8becee842d5b9444a2ee67a3b}{\_mi\_page\_free}}(page,\ pq);}
\DoxyCodeLine{00445\ \}}
\DoxyCodeLine{00446\ }
\DoxyCodeLine{00447\ \textcolor{comment}{//\ free\ retired\ pages:\ we\ don't\ need\ to\ look\ at\ the\ entire\ queues}}
\DoxyCodeLine{00448\ \textcolor{comment}{//\ since\ we\ only\ retire\ pages\ that\ are\ at\ the\ head\ position\ in\ a\ queue.}}
\DoxyCodeLine{00449\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{page_8c_abc5253b4341c8d7eab888068e4f9b951}{\_mi\_heap\_collect\_retired}}(\mbox{\hyperlink{group__heap_ga34a47cde5a5b38c29f1aa3c5e76943c2}{mi\_heap\_t}}*\ heap,\ \textcolor{keywordtype}{bool}\ force)\ \{}
\DoxyCodeLine{00450\ \ \ \textcolor{keywordtype}{size\_t}\ min\ =\ \mbox{\hyperlink{types_8h_ade65859668d2b446caf257fbc8c8d684}{MI\_BIN\_FULL}};}
\DoxyCodeLine{00451\ \ \ \textcolor{keywordtype}{size\_t}\ max\ =\ 0;}
\DoxyCodeLine{00452\ \ \ \textcolor{keywordflow}{for}(\textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{base_8h_adfa139c9a1902753b3696794759b2c48ac1111bd512b29e821b120b86446026b8}{bin}}\ =\ heap-\/>\mbox{\hyperlink{structmi__heap__s_a36bccfd0ae24a8358846037cb31f5c08}{page\_retired\_min}};\ \mbox{\hyperlink{base_8h_adfa139c9a1902753b3696794759b2c48ac1111bd512b29e821b120b86446026b8}{bin\ <=\ heap-\/>}}page\_retired\_max;\ \mbox{\hyperlink{base_8h_adfa139c9a1902753b3696794759b2c48ac1111bd512b29e821b120b86446026b8}{bin}}++)\ \{}
\DoxyCodeLine{00453\ \ \ \ \ \mbox{\hyperlink{types_8h_a9646624e7de8587984ec8e8cd5c5d780}{mi\_page\_queue\_t}}*\ pq\ \ \ =\ \&heap-\/>\mbox{\hyperlink{structmi__heap__s_a132c64106a2662761ee57ea5dd4a996b}{pages}}[\mbox{\hyperlink{base_8h_adfa139c9a1902753b3696794759b2c48ac1111bd512b29e821b120b86446026b8}{bin}}];}
\DoxyCodeLine{00454\ \ \ \ \ \mbox{\hyperlink{types_8h_a98e3d539b4113aac496ebe3d379ebe5b}{mi\_page\_t}}*\ \ \ \ \ \ \ page\ =\ pq-\/>\mbox{\hyperlink{structmi__page__queue__s_a2ac5077507dc4bf25a1a8df36955469a}{first}};}
\DoxyCodeLine{00455\ \ \ \ \ \textcolor{keywordflow}{if}\ (page\ !=\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}}\ \&\&\ page-\/>\mbox{\hyperlink{structmi__page__s_a0a5d0c55c032201268976344519a6842}{retire\_expire}}\ !=\ 0)\ \{}
\DoxyCodeLine{00456\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_adfd6d23350810ca36986ffbc5459c93d}{mi\_page\_all\_free}}(page))\ \{}
\DoxyCodeLine{00457\ \ \ \ \ \ \ \ \ page-\/>\mbox{\hyperlink{structmi__page__s_a0a5d0c55c032201268976344519a6842}{retire\_expire}}-\/-\/;}
\DoxyCodeLine{00458\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (force\ ||\ page-\/>\mbox{\hyperlink{structmi__page__s_a0a5d0c55c032201268976344519a6842}{retire\_expire}}\ ==\ 0)\ \{}
\DoxyCodeLine{00459\ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{page_8c_a1c5c78a8becee842d5b9444a2ee67a3b}{\_mi\_page\_free}}(pq-\/>\mbox{\hyperlink{structmi__page__queue__s_a2ac5077507dc4bf25a1a8df36955469a}{first}},\ pq);}
\DoxyCodeLine{00460\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00461\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00462\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ keep\ retired,\ update\ min/max}}
\DoxyCodeLine{00463\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{base_8h_adfa139c9a1902753b3696794759b2c48ac1111bd512b29e821b120b86446026b8}{bin}}\ <\ min)\ min\ =\ \mbox{\hyperlink{base_8h_adfa139c9a1902753b3696794759b2c48ac1111bd512b29e821b120b86446026b8}{bin}};}
\DoxyCodeLine{00464\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{base_8h_adfa139c9a1902753b3696794759b2c48ac1111bd512b29e821b120b86446026b8}{bin}}\ >\ max)\ max\ =\ \mbox{\hyperlink{base_8h_adfa139c9a1902753b3696794759b2c48ac1111bd512b29e821b120b86446026b8}{bin}};}
\DoxyCodeLine{00465\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00466\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00467\ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00468\ \ \ \ \ \ \ \ \ page-\/>\mbox{\hyperlink{structmi__page__s_a0a5d0c55c032201268976344519a6842}{retire\_expire}}\ =\ 0;}
\DoxyCodeLine{00469\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00470\ \ \ \ \ \}}
\DoxyCodeLine{00471\ \ \ \}}
\DoxyCodeLine{00472\ \ \ heap-\/>\mbox{\hyperlink{structmi__heap__s_a36bccfd0ae24a8358846037cb31f5c08}{page\_retired\_min}}\ =\ min;}
\DoxyCodeLine{00473\ \ \ heap-\/>\mbox{\hyperlink{structmi__heap__s_abee70406811029ca76f2609160b9c82b}{page\_retired\_max}}\ =\ max;}
\DoxyCodeLine{00474\ \}}
\DoxyCodeLine{00475\ }
\DoxyCodeLine{00476\ \textcolor{comment}{/*}}
\DoxyCodeLine{00477\ \textcolor{comment}{static\ void\ mi\_heap\_collect\_full\_pages(mi\_heap\_t*\ heap)\ \{}}
\DoxyCodeLine{00478\ \textcolor{comment}{\ \ //\ note:\ normally\ full\ pages\ get\ immediately\ abandoned\ and\ the\ full\ queue\ is\ always\ empty}}
\DoxyCodeLine{00479\ \textcolor{comment}{\ \ //\ this\ path\ is\ only\ used\ if\ abandoning\ is\ disabled\ due\ to\ a\ destroy-\/able\ heap\ or\ options}}
\DoxyCodeLine{00480\ \textcolor{comment}{\ \ //\ set\ by\ the\ user.}}
\DoxyCodeLine{00481\ \textcolor{comment}{\ \ mi\_page\_queue\_t*\ pq\ =\ \&heap-\/>pages[MI\_BIN\_FULL];}}
\DoxyCodeLine{00482\ \textcolor{comment}{\ \ for\ (mi\_page\_t*\ page\ =\ pq-\/>first;\ page\ !=\ NULL;\ )\ \{}}
\DoxyCodeLine{00483\ \textcolor{comment}{\ \ \ \ mi\_page\_t*\ next\ =\ page-\/>next;\ \ \ \ \ \ \ \ \ //\ get\ next\ in\ case\ we\ free\ the\ page}}
\DoxyCodeLine{00484\ \textcolor{comment}{\ \ \ \ \_mi\_page\_free\_collect(page,\ false);\ \ \ //\ register\ concurrent\ free's}}
\DoxyCodeLine{00485\ \textcolor{comment}{\ \ \ \ //\ no\ longer\ full?}}
\DoxyCodeLine{00486\ \textcolor{comment}{\ \ \ \ if\ (!mi\_page\_is\_full(page))\ \{}}
\DoxyCodeLine{00487\ \textcolor{comment}{\ \ \ \ \ \ if\ (mi\_page\_all\_free(page))\ \{}}
\DoxyCodeLine{00488\ \textcolor{comment}{\ \ \ \ \ \ \ \ \_mi\_page\_free(page,\ pq);}}
\DoxyCodeLine{00489\ \textcolor{comment}{\ \ \ \ \ \ \}}}
\DoxyCodeLine{00490\ \textcolor{comment}{\ \ \ \ \ \ else\ \{}}
\DoxyCodeLine{00491\ \textcolor{comment}{\ \ \ \ \ \ \ \ \_mi\_page\_unfull(page);}}
\DoxyCodeLine{00492\ \textcolor{comment}{\ \ \ \ \ \ \}}}
\DoxyCodeLine{00493\ \textcolor{comment}{\ \ \ \ \}}}
\DoxyCodeLine{00494\ \textcolor{comment}{\ \ \ \ page\ =\ next;}}
\DoxyCodeLine{00495\ \textcolor{comment}{\ \ \}}}
\DoxyCodeLine{00496\ \textcolor{comment}{\}}}
\DoxyCodeLine{00497\ \textcolor{comment}{*/}}
\DoxyCodeLine{00498\ }
\DoxyCodeLine{00499\ }
\DoxyCodeLine{00500\ \textcolor{comment}{/*\ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00501\ \textcolor{comment}{\ \ Initialize\ the\ initial\ free\ list\ in\ a\ page.}}
\DoxyCodeLine{00502\ \textcolor{comment}{\ \ In\ secure\ mode\ we\ initialize\ a\ randomized\ list\ by}}
\DoxyCodeLine{00503\ \textcolor{comment}{\ \ alternating\ between\ slices.}}
\DoxyCodeLine{00504\ \textcolor{comment}{-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/\ */}}
\DoxyCodeLine{00505\ }
\DoxyCodeLine{00506\ \textcolor{preprocessor}{\#define\ MI\_MAX\_SLICE\_SHIFT\ \ (6)\ \ \ }\textcolor{comment}{//\ at\ most\ 64\ slices}}
\DoxyCodeLine{00507\ \textcolor{preprocessor}{\#define\ MI\_MAX\_SLICES\ \ \ \ \ \ \ (1UL\ <<\ MI\_MAX\_SLICE\_SHIFT)}}
\DoxyCodeLine{00508\ \textcolor{preprocessor}{\#define\ MI\_MIN\_SLICES\ \ \ \ \ \ \ (2)}}
\DoxyCodeLine{00509\ }
\DoxyCodeLine{00510\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{page_8c_a4a740b834c5746b0309fece1a0b1d781}{mi\_page\_free\_list\_extend\_secure}}(\mbox{\hyperlink{group__heap_ga34a47cde5a5b38c29f1aa3c5e76943c2}{mi\_heap\_t}}*\ \textcolor{keyword}{const}\ heap,\ \mbox{\hyperlink{types_8h_a98e3d539b4113aac496ebe3d379ebe5b}{mi\_page\_t}}*\ \textcolor{keyword}{const}\ page,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ bsize,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ extend,\ \mbox{\hyperlink{mimalloc-stats_8h_ae899fc419d2db1af97887b3f8c049dc1}{mi\_stats\_t}}*\ \textcolor{keyword}{const}\ stats)\ \{}
\DoxyCodeLine{00511\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ab7467946e27cd6bb4af911805cc5db26}{MI\_UNUSED}}(stats);}
\DoxyCodeLine{00512\ \textcolor{preprocessor}{\ \ \#if\ (MI\_SECURE<3)}}
\DoxyCodeLine{00513\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(page-\/>\mbox{\hyperlink{structmi__page__s_ae2d4b1c483d94e3624319bbca00d3da3}{free}}\ ==\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}});}
\DoxyCodeLine{00514\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(page-\/>\mbox{\hyperlink{structmi__page__s_a9ed7774dcbd4de583d1594d698128830}{local\_free}}\ ==\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}});}
\DoxyCodeLine{00515\ \textcolor{preprocessor}{\ \ \#endif}}
\DoxyCodeLine{00516\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(page-\/>\mbox{\hyperlink{structmi__page__s_a9ed1099a997d9c4e42b3bbe631705e41}{capacity}}\ +\ extend\ <=\ page-\/>reserved);}
\DoxyCodeLine{00517\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(bsize\ ==\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a6134893990c1f09da2b40092ceecc780}{mi\_page\_block\_size}}(page));}
\DoxyCodeLine{00518\ \ \ \textcolor{keywordtype}{void}*\ \textcolor{keyword}{const}\ page\_area\ =\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a95e8b035747d340ad060f5cf0811b7e9}{mi\_page\_start}}(page);}
\DoxyCodeLine{00519\ }
\DoxyCodeLine{00520\ \ \ \textcolor{comment}{//\ initialize\ a\ randomized\ free\ list}}
\DoxyCodeLine{00521\ \ \ \textcolor{comment}{//\ set\ up\ \`{}slice\_count`\ slices\ to\ alternate\ between}}
\DoxyCodeLine{00522\ \ \ \textcolor{keywordtype}{size\_t}\ shift\ =\ \mbox{\hyperlink{page_8c_ac5c13b021d7ecacd6cfc5278e3a2b02a}{MI\_MAX\_SLICE\_SHIFT}};}
\DoxyCodeLine{00523\ \ \ \textcolor{keywordflow}{while}\ ((extend\ >>\ shift)\ ==\ 0)\ \{}
\DoxyCodeLine{00524\ \ \ \ \ shift-\/-\/;}
\DoxyCodeLine{00525\ \ \ \}}
\DoxyCodeLine{00526\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ slice\_count\ =\ (size\_t)1U\ <<\ shift;}
\DoxyCodeLine{00527\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ slice\_extend\ =\ extend\ /\ slice\_count;}
\DoxyCodeLine{00528\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(slice\_extend\ >=\ 1);}
\DoxyCodeLine{00529\ \ \ \mbox{\hyperlink{types_8h_a9a69f9a34bc130b6a51162b980e9c631}{mi\_block\_t}}*\ blocks[\mbox{\hyperlink{page_8c_aca0379f1a38cf7244dec9d39cf2ef673}{MI\_MAX\_SLICES}}];\ \ \ \textcolor{comment}{//\ current\ start\ of\ the\ slice}}
\DoxyCodeLine{00530\ \ \ \textcolor{keywordtype}{size\_t}\ \ \ \ \ \ counts[\mbox{\hyperlink{page_8c_aca0379f1a38cf7244dec9d39cf2ef673}{MI\_MAX\_SLICES}}];\ \ \ \textcolor{comment}{//\ available\ objects\ in\ the\ slice}}
\DoxyCodeLine{00531\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ slice\_count;\ i++)\ \{}
\DoxyCodeLine{00532\ \ \ \ \ blocks[i]\ =\ \mbox{\hyperlink{page_8c_a796cbdf7c3bf7febbda3160b978b4e79}{mi\_page\_block\_at}}(page,\ page\_area,\ bsize,\ page-\/>\mbox{\hyperlink{structmi__page__s_a9ed1099a997d9c4e42b3bbe631705e41}{capacity}}\ +\ i*slice\_extend);}
\DoxyCodeLine{00533\ \ \ \ \ counts[i]\ =\ slice\_extend;}
\DoxyCodeLine{00534\ \ \ \}}
\DoxyCodeLine{00535\ \ \ counts[slice\_count-\/1]\ +=\ (extend\ \%\ slice\_count);\ \ \textcolor{comment}{//\ final\ slice\ holds\ the\ modulus\ too\ (todo:\ distribute\ evenly?)}}
\DoxyCodeLine{00536\ }
\DoxyCodeLine{00537\ \ \ \textcolor{comment}{//\ and\ initialize\ the\ free\ list\ by\ randomly\ threading\ through\ them}}
\DoxyCodeLine{00538\ \ \ \textcolor{comment}{//\ set\ up\ first\ element}}
\DoxyCodeLine{00539\ \ \ \textcolor{keyword}{const}\ uintptr\_t\ \mbox{\hyperlink{offscreen_8c_a4788d82c901b9367dd5c0daff8a7616b}{r}}\ =\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a68ddb5f2c595ea9d4e8d450342b4713c}{\_mi\_heap\_random\_next}}(heap);}
\DoxyCodeLine{00540\ \ \ \textcolor{keywordtype}{size\_t}\ current\ =\ \mbox{\hyperlink{offscreen_8c_a4788d82c901b9367dd5c0daff8a7616b}{r}}\ \%\ slice\_count;}
\DoxyCodeLine{00541\ \ \ counts[current]-\/-\/;}
\DoxyCodeLine{00542\ \ \ \mbox{\hyperlink{types_8h_a9a69f9a34bc130b6a51162b980e9c631}{mi\_block\_t}}*\ \textcolor{keyword}{const}\ free\_start\ =\ blocks[current];}
\DoxyCodeLine{00543\ \ \ \textcolor{comment}{//\ and\ iterate\ through\ the\ rest;\ use\ \`{}random\_shuffle`\ for\ performance}}
\DoxyCodeLine{00544\ \ \ uintptr\_t\ rnd\ =\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_aed665df96f860a0ef89cc82e538df873}{\_mi\_random\_shuffle}}(\mbox{\hyperlink{offscreen_8c_a4788d82c901b9367dd5c0daff8a7616b}{r}}|1);\ \textcolor{comment}{//\ ensure\ not\ 0}}
\DoxyCodeLine{00545\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 1;\ i\ <\ extend;\ i++)\ \{}
\DoxyCodeLine{00546\ \ \ \ \ \textcolor{comment}{//\ call\ random\_shuffle\ only\ every\ INTPTR\_SIZE\ rounds}}
\DoxyCodeLine{00547\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ round\ =\ i\%\mbox{\hyperlink{bits_8h_af8a1f49c3ca95474d8fc5fdb53874026}{MI\_INTPTR\_SIZE}};}
\DoxyCodeLine{00548\ \ \ \ \ \textcolor{keywordflow}{if}\ (round\ ==\ 0)\ rnd\ =\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_aed665df96f860a0ef89cc82e538df873}{\_mi\_random\_shuffle}}(rnd);}
\DoxyCodeLine{00549\ \ \ \ \ \textcolor{comment}{//\ select\ a\ random\ next\ slice\ index}}
\DoxyCodeLine{00550\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ next\ =\ ((rnd\ >>\ 8*round)\ \&\ (slice\_count-\/1));}
\DoxyCodeLine{00551\ \ \ \ \ \textcolor{keywordflow}{while}\ (counts[next]==0)\ \{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ ensure\ it\ still\ has\ space}}
\DoxyCodeLine{00552\ \ \ \ \ \ \ next++;}
\DoxyCodeLine{00553\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (next==slice\_count)\ next\ =\ 0;}
\DoxyCodeLine{00554\ \ \ \ \ \}}
\DoxyCodeLine{00555\ \ \ \ \ \textcolor{comment}{//\ and\ link\ the\ current\ block\ to\ it}}
\DoxyCodeLine{00556\ \ \ \ \ counts[next]-\/-\/;}
\DoxyCodeLine{00557\ \ \ \ \ \mbox{\hyperlink{types_8h_a9a69f9a34bc130b6a51162b980e9c631}{mi\_block\_t}}*\ \textcolor{keyword}{const}\ \mbox{\hyperlink{mimalloc_8h_a840cb394e7433c7fe0c4875a3030c955}{block}}\ =\ blocks[current];}
\DoxyCodeLine{00558\ \ \ \ \ blocks[current]\ =\ (\mbox{\hyperlink{types_8h_a9a69f9a34bc130b6a51162b980e9c631}{mi\_block\_t}}*)((\mbox{\hyperlink{eabase_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}}*)\mbox{\hyperlink{mimalloc_8h_a840cb394e7433c7fe0c4875a3030c955}{block}}\ +\ bsize);\ \ \textcolor{comment}{//\ bump\ to\ the\ following\ block}}
\DoxyCodeLine{00559\ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac7b440a922454c163ed1139aac9b946d}{mi\_block\_set\_next}}(page,\ \mbox{\hyperlink{mimalloc_8h_a840cb394e7433c7fe0c4875a3030c955}{block}},\ blocks[next]);\ \ \ \textcolor{comment}{//\ and\ set\ next;\ note:\ we\ may\ have\ \`{}current\ ==\ next`}}
\DoxyCodeLine{00560\ \ \ \ \ current\ =\ next;}
\DoxyCodeLine{00561\ \ \ \}}
\DoxyCodeLine{00562\ \ \ \textcolor{comment}{//\ prepend\ to\ the\ free\ list\ (usually\ NULL)}}
\DoxyCodeLine{00563\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac7b440a922454c163ed1139aac9b946d}{mi\_block\_set\_next}}(page,\ blocks[current],\ page-\/>\mbox{\hyperlink{structmi__page__s_ae2d4b1c483d94e3624319bbca00d3da3}{free}});\ \ \textcolor{comment}{//\ end\ of\ the\ list}}
\DoxyCodeLine{00564\ \ \ page-\/>\mbox{\hyperlink{structmi__page__s_ae2d4b1c483d94e3624319bbca00d3da3}{free}}\ =\ free\_start;}
\DoxyCodeLine{00565\ \}}
\DoxyCodeLine{00566\ }
\DoxyCodeLine{00567\ \textcolor{keyword}{static}\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a0a63ad6116421ea60eb43806f8881a3b}{mi\_decl\_noinline}}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{page_8c_a9bb87a743570919cc56839f9fc433695}{mi\_page\_free\_list\_extend}}(\ \mbox{\hyperlink{types_8h_a98e3d539b4113aac496ebe3d379ebe5b}{mi\_page\_t}}*\ \textcolor{keyword}{const}\ page,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ bsize,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ extend,\ \mbox{\hyperlink{mimalloc-stats_8h_ae899fc419d2db1af97887b3f8c049dc1}{mi\_stats\_t}}*\ \textcolor{keyword}{const}\ stats)}
\DoxyCodeLine{00568\ \{}
\DoxyCodeLine{00569\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ab7467946e27cd6bb4af911805cc5db26}{MI\_UNUSED}}(stats);}
\DoxyCodeLine{00570\ \textcolor{preprocessor}{\ \ \#if\ (MI\_SECURE<3)}}
\DoxyCodeLine{00571\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(page-\/>\mbox{\hyperlink{structmi__page__s_ae2d4b1c483d94e3624319bbca00d3da3}{free}}\ ==\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}});}
\DoxyCodeLine{00572\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(page-\/>\mbox{\hyperlink{structmi__page__s_a9ed7774dcbd4de583d1594d698128830}{local\_free}}\ ==\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}});}
\DoxyCodeLine{00573\ \textcolor{preprocessor}{\ \ \#endif}}
\DoxyCodeLine{00574\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(page-\/>\mbox{\hyperlink{structmi__page__s_a9ed1099a997d9c4e42b3bbe631705e41}{capacity}}\ +\ extend\ <=\ page-\/>reserved);}
\DoxyCodeLine{00575\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(bsize\ ==\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a6134893990c1f09da2b40092ceecc780}{mi\_page\_block\_size}}(page));}
\DoxyCodeLine{00576\ \ \ \textcolor{keywordtype}{void}*\ \textcolor{keyword}{const}\ page\_area\ =\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a95e8b035747d340ad060f5cf0811b7e9}{mi\_page\_start}}(page);}
\DoxyCodeLine{00577\ }
\DoxyCodeLine{00578\ \ \ \mbox{\hyperlink{types_8h_a9a69f9a34bc130b6a51162b980e9c631}{mi\_block\_t}}*\ \textcolor{keyword}{const}\ start\ =\ \mbox{\hyperlink{page_8c_a796cbdf7c3bf7febbda3160b978b4e79}{mi\_page\_block\_at}}(page,\ page\_area,\ bsize,\ page-\/>\mbox{\hyperlink{structmi__page__s_a9ed1099a997d9c4e42b3bbe631705e41}{capacity}});}
\DoxyCodeLine{00579\ }
\DoxyCodeLine{00580\ \ \ \textcolor{comment}{//\ initialize\ a\ sequential\ free\ list}}
\DoxyCodeLine{00581\ \ \ \mbox{\hyperlink{types_8h_a9a69f9a34bc130b6a51162b980e9c631}{mi\_block\_t}}*\ \textcolor{keyword}{const}\ last\ =\ \mbox{\hyperlink{page_8c_a796cbdf7c3bf7febbda3160b978b4e79}{mi\_page\_block\_at}}(page,\ page\_area,\ bsize,\ page-\/>\mbox{\hyperlink{structmi__page__s_a9ed1099a997d9c4e42b3bbe631705e41}{capacity}}\ +\ extend\ -\/\ 1);}
\DoxyCodeLine{00582\ \ \ \mbox{\hyperlink{types_8h_a9a69f9a34bc130b6a51162b980e9c631}{mi\_block\_t}}*\ \mbox{\hyperlink{mimalloc_8h_a840cb394e7433c7fe0c4875a3030c955}{block}}\ =\ start;}
\DoxyCodeLine{00583\ \ \ \textcolor{keywordflow}{while}(\mbox{\hyperlink{mimalloc_8h_a840cb394e7433c7fe0c4875a3030c955}{block}}\ <=\ last)\ \{}
\DoxyCodeLine{00584\ \ \ \ \ \mbox{\hyperlink{types_8h_a9a69f9a34bc130b6a51162b980e9c631}{mi\_block\_t}}*\ next\ =\ (\mbox{\hyperlink{types_8h_a9a69f9a34bc130b6a51162b980e9c631}{mi\_block\_t}}*)((\mbox{\hyperlink{eabase_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}}*)\mbox{\hyperlink{mimalloc_8h_a840cb394e7433c7fe0c4875a3030c955}{block}}\ +\ bsize);}
\DoxyCodeLine{00585\ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac7b440a922454c163ed1139aac9b946d}{mi\_block\_set\_next}}(page,\mbox{\hyperlink{mimalloc_8h_a840cb394e7433c7fe0c4875a3030c955}{block}},next);}
\DoxyCodeLine{00586\ \ \ \ \ \mbox{\hyperlink{mimalloc_8h_a840cb394e7433c7fe0c4875a3030c955}{block}}\ =\ next;}
\DoxyCodeLine{00587\ \ \ \}}
\DoxyCodeLine{00588\ \ \ \textcolor{comment}{//\ prepend\ to\ free\ list\ (usually\ \`{}NULL`)}}
\DoxyCodeLine{00589\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac7b440a922454c163ed1139aac9b946d}{mi\_block\_set\_next}}(page,\ last,\ page-\/>\mbox{\hyperlink{structmi__page__s_ae2d4b1c483d94e3624319bbca00d3da3}{free}});}
\DoxyCodeLine{00590\ \ \ page-\/>\mbox{\hyperlink{structmi__page__s_ae2d4b1c483d94e3624319bbca00d3da3}{free}}\ =\ start;}
\DoxyCodeLine{00591\ \}}
\DoxyCodeLine{00592\ }
\DoxyCodeLine{00593\ \textcolor{comment}{/*\ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00594\ \textcolor{comment}{\ \ Page\ initialize\ and\ extend\ the\ capacity}}
\DoxyCodeLine{00595\ \textcolor{comment}{-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/\ */}}
\DoxyCodeLine{00596\ }
\DoxyCodeLine{00597\ \textcolor{preprocessor}{\#define\ MI\_MAX\_EXTEND\_SIZE\ \ \ \ (4*1024)\ \ \ \ \ \ }\textcolor{comment}{//\ heuristic,\ one\ OS\ page\ seems\ to\ work\ well.}}
\DoxyCodeLine{00598\ \textcolor{preprocessor}{\#if\ (MI\_SECURE>=3)}}
\DoxyCodeLine{00599\ \textcolor{preprocessor}{\#define\ MI\_MIN\_EXTEND\ \ \ \ \ \ \ \ \ (8*MI\_SECURE)\ }\textcolor{comment}{//\ extend\ at\ least\ by\ this\ many}}
\DoxyCodeLine{00600\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00601\ \textcolor{preprocessor}{\#define\ MI\_MIN\_EXTEND\ \ \ \ \ \ \ \ \ (1)}}
\DoxyCodeLine{00602\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00603\ }
\DoxyCodeLine{00604\ \textcolor{comment}{//\ Extend\ the\ capacity\ (up\ to\ reserved)\ by\ initializing\ a\ free\ list}}
\DoxyCodeLine{00605\ \textcolor{comment}{//\ We\ do\ at\ most\ \`{}MI\_MAX\_EXTEND`\ to\ avoid\ touching\ too\ much\ memory}}
\DoxyCodeLine{00606\ \textcolor{comment}{//\ Note:\ we\ also\ experimented\ with\ "{}bump"{}\ allocation\ on\ the\ first}}
\DoxyCodeLine{00607\ \textcolor{comment}{//\ allocations\ but\ this\ did\ not\ speed\ up\ any\ benchmark\ (due\ to\ an}}
\DoxyCodeLine{00608\ \textcolor{comment}{//\ extra\ test\ in\ malloc?\ or\ cache\ effects?)}}
\DoxyCodeLine{00609\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{page_8c_a40c7a483e3c04fdcf8d9a16bc6e6cea5}{mi\_page\_extend\_free}}(\mbox{\hyperlink{group__heap_ga34a47cde5a5b38c29f1aa3c5e76943c2}{mi\_heap\_t}}*\ heap,\ \mbox{\hyperlink{types_8h_a98e3d539b4113aac496ebe3d379ebe5b}{mi\_page\_t}}*\ page)\ \{}
\DoxyCodeLine{00610\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ab812423812d2dd7af864b7e112055d8e}{mi\_assert\_expensive}}(mi\_page\_is\_valid\_init(page));}
\DoxyCodeLine{00611\ \textcolor{preprocessor}{\ \ \#if\ (MI\_SECURE<3)}}
\DoxyCodeLine{00612\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_af04c7a87bc1c69ef3e763a580f47a418}{mi\_assert}}(page-\/>\mbox{\hyperlink{structmi__page__s_ae2d4b1c483d94e3624319bbca00d3da3}{free}}\ ==\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}});}
\DoxyCodeLine{00613\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_af04c7a87bc1c69ef3e763a580f47a418}{mi\_assert}}(page-\/>\mbox{\hyperlink{structmi__page__s_a9ed7774dcbd4de583d1594d698128830}{local\_free}}\ ==\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}});}
\DoxyCodeLine{00614\ \ \ \textcolor{keywordflow}{if}\ (page-\/>\mbox{\hyperlink{structmi__page__s_ae2d4b1c483d94e3624319bbca00d3da3}{free}}\ !=\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}})\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00615\ \textcolor{preprocessor}{\ \ \#endif}}
\DoxyCodeLine{00616\ \ \ \textcolor{keywordflow}{if}\ (page-\/>\mbox{\hyperlink{structmi__page__s_a9ed1099a997d9c4e42b3bbe631705e41}{capacity}}\ >=\ page-\/>\mbox{\hyperlink{structmi__page__s_acf15d96ab2462c10365859158a84bb72}{reserved}})\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00617\ }
\DoxyCodeLine{00618\ \ \ \textcolor{keywordtype}{size\_t}\ page\_size;}
\DoxyCodeLine{00619\ \ \ \textcolor{comment}{//uint8\_t*\ page\_start\ =}}
\DoxyCodeLine{00620\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ab02bec7b56343136344cb9441cb889c7}{mi\_page\_area}}(page,\ \&page\_size);}
\DoxyCodeLine{00621\ \ \ \mbox{\hyperlink{types_8h_a94c9eeab401dfcde2f714195fe727540}{mi\_debug\_heap\_stat\_counter\_increase}}(heap,\ pages\_extended,\ 1);}
\DoxyCodeLine{00622\ }
\DoxyCodeLine{00623\ \ \ \textcolor{comment}{//\ calculate\ the\ extend\ count}}
\DoxyCodeLine{00624\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ bsize\ =\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a6134893990c1f09da2b40092ceecc780}{mi\_page\_block\_size}}(page);}
\DoxyCodeLine{00625\ \ \ \textcolor{keywordtype}{size\_t}\ extend\ =\ (size\_t)page-\/>\mbox{\hyperlink{structmi__page__s_acf15d96ab2462c10365859158a84bb72}{reserved}}\ -\/\ page-\/>\mbox{\hyperlink{structmi__page__s_a9ed1099a997d9c4e42b3bbe631705e41}{capacity}};}
\DoxyCodeLine{00626\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(extend\ >\ 0);}
\DoxyCodeLine{00627\ }
\DoxyCodeLine{00628\ \ \ \textcolor{keywordtype}{size\_t}\ max\_extend\ =\ (bsize\ >=\ \mbox{\hyperlink{page_8c_ad81c2bb6e504c30d43c26fed64dcb407}{MI\_MAX\_EXTEND\_SIZE}}\ ?\ \mbox{\hyperlink{page_8c_a8c0d7d30012afee6ca9e376670172847}{MI\_MIN\_EXTEND}}\ :\ \mbox{\hyperlink{page_8c_ad81c2bb6e504c30d43c26fed64dcb407}{MI\_MAX\_EXTEND\_SIZE}}/bsize);}
\DoxyCodeLine{00629\ \ \ \textcolor{keywordflow}{if}\ (max\_extend\ <\ \mbox{\hyperlink{page_8c_a8c0d7d30012afee6ca9e376670172847}{MI\_MIN\_EXTEND}})\ \{\ max\_extend\ =\ \mbox{\hyperlink{page_8c_a8c0d7d30012afee6ca9e376670172847}{MI\_MIN\_EXTEND}};\ \}}
\DoxyCodeLine{00630\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(max\_extend\ >\ 0);}
\DoxyCodeLine{00631\ }
\DoxyCodeLine{00632\ \ \ \textcolor{keywordflow}{if}\ (extend\ >\ max\_extend)\ \{}
\DoxyCodeLine{00633\ \ \ \ \ \textcolor{comment}{//\ ensure\ we\ don't\ touch\ memory\ beyond\ the\ page\ to\ reduce\ page\ commit.}}
\DoxyCodeLine{00634\ \ \ \ \ \textcolor{comment}{//\ the\ \`{}lean`\ benchmark\ tests\ this.\ Going\ from\ 1\ to\ 8\ increases\ rss\ by\ 50\%.}}
\DoxyCodeLine{00635\ \ \ \ \ extend\ =\ max\_extend;}
\DoxyCodeLine{00636\ \ \ \}}
\DoxyCodeLine{00637\ }
\DoxyCodeLine{00638\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(extend\ >\ 0\ \&\&\ extend\ +\ page-\/>\mbox{\hyperlink{structmi__page__s_a9ed1099a997d9c4e42b3bbe631705e41}{capacity}}\ <=\ page-\/>\mbox{\hyperlink{structmi__page__s_acf15d96ab2462c10365859158a84bb72}{reserved}});}
\DoxyCodeLine{00639\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(extend\ <\ (1UL<<16));}
\DoxyCodeLine{00640\ }
\DoxyCodeLine{00641\ \ \ \textcolor{comment}{//\ commit\ on\ demand?}}
\DoxyCodeLine{00642\ \ \ \textcolor{keywordflow}{if}\ (page-\/>\mbox{\hyperlink{structmi__page__s_a3a1365636f40fd98ed2a26d16472d8d8}{slice\_committed}}\ >\ 0)\ \{}
\DoxyCodeLine{00643\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ needed\_size\ =\ (page-\/>\mbox{\hyperlink{structmi__page__s_a9ed1099a997d9c4e42b3bbe631705e41}{capacity}}\ +\ extend)*bsize;}
\DoxyCodeLine{00644\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ needed\_commit\ =\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a7f35944d44d8a16365072023dd19e0da}{\_mi\_align\_up}}(\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ad3e5df2ef93d3703a1a70368b1a858d6}{mi\_page\_slice\_offset\_of}}(page,\ needed\_size),\ \mbox{\hyperlink{types_8h_a80b8f4daf40aa2d6f2a5fb3348ac2e6c}{MI\_PAGE\_MIN\_COMMIT\_SIZE}}\ );}
\DoxyCodeLine{00645\ \ \ \ \ \textcolor{keywordflow}{if}\ (needed\_commit\ >\ page-\/>\mbox{\hyperlink{structmi__page__s_a3a1365636f40fd98ed2a26d16472d8d8}{slice\_committed}})\ \{}
\DoxyCodeLine{00646\ \ \ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(((needed\_commit\ -\/\ page-\/>\mbox{\hyperlink{structmi__page__s_a3a1365636f40fd98ed2a26d16472d8d8}{slice\_committed}})\ \%\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a723e4c95209d4c6282b53317473e83d5}{\_mi\_os\_page\_size}}())\ ==\ 0);}
\DoxyCodeLine{00647\ \ \ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a476563a6d982e688c7b3916b60c07b9b}{\_mi\_os\_commit}}(\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a5a6ac89588d92c6b443e78415aac06db}{mi\_page\_slice\_start}}(page)\ +\ page-\/>\mbox{\hyperlink{structmi__page__s_a3a1365636f40fd98ed2a26d16472d8d8}{slice\_committed}},\ needed\_commit\ -\/\ page-\/>\mbox{\hyperlink{structmi__page__s_a3a1365636f40fd98ed2a26d16472d8d8}{slice\_committed}},\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}});}
\DoxyCodeLine{00648\ \ \ \ \ \ \ page-\/>\mbox{\hyperlink{structmi__page__s_a3a1365636f40fd98ed2a26d16472d8d8}{slice\_committed}}\ =\ needed\_commit;}
\DoxyCodeLine{00649\ \ \ \ \ \}}
\DoxyCodeLine{00650\ \ \ \}}
\DoxyCodeLine{00651\ }
\DoxyCodeLine{00652\ \ \ \textcolor{comment}{//\ and\ append\ the\ extend\ the\ free\ list}}
\DoxyCodeLine{00653\ \ \ \textcolor{keywordflow}{if}\ (extend\ <\ \mbox{\hyperlink{page_8c_a5d2310102440404c64d9fc568cb7d63f}{MI\_MIN\_SLICES}}\ ||\ \mbox{\hyperlink{types_8h_a16192d28dac241d44aa4ff272d2a29a5}{MI\_SECURE}}<3)\ \{\ }
\DoxyCodeLine{00654\ \ \ \ \ \mbox{\hyperlink{page_8c_a9bb87a743570919cc56839f9fc433695}{mi\_page\_free\_list\_extend}}(page,\ bsize,\ extend,\ \&heap-\/>\mbox{\hyperlink{structmi__heap__s_a2e524aeb1b30f344a4f0b70e6cf6cb3a}{tld}}-\/>\mbox{\hyperlink{structmi__tld__s_a08407f89848bb130648aed09b0b33948}{stats}}\ );}
\DoxyCodeLine{00655\ \ \ \}}
\DoxyCodeLine{00656\ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00657\ \ \ \ \ \mbox{\hyperlink{page_8c_a4a740b834c5746b0309fece1a0b1d781}{mi\_page\_free\_list\_extend\_secure}}(heap,\ page,\ bsize,\ extend,\ \&heap-\/>\mbox{\hyperlink{structmi__heap__s_a2e524aeb1b30f344a4f0b70e6cf6cb3a}{tld}}-\/>\mbox{\hyperlink{structmi__tld__s_a08407f89848bb130648aed09b0b33948}{stats}});}
\DoxyCodeLine{00658\ \ \ \}}
\DoxyCodeLine{00659\ \ \ \textcolor{comment}{//\ enable\ the\ new\ free\ list}}
\DoxyCodeLine{00660\ \ \ page-\/>\mbox{\hyperlink{structmi__page__s_a9ed1099a997d9c4e42b3bbe631705e41}{capacity}}\ +=\ (\mbox{\hyperlink{eabase_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t}})extend;}
\DoxyCodeLine{00661\ \ \ \mbox{\hyperlink{types_8h_a704d77e6a2c2170f5673ee102f8441fe}{mi\_debug\_heap\_stat\_increase}}(heap,\ page\_committed,\ extend\ *\ bsize);}
\DoxyCodeLine{00662\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ab812423812d2dd7af864b7e112055d8e}{mi\_assert\_expensive}}(mi\_page\_is\_valid\_init(page));}
\DoxyCodeLine{00663\ \}}
\DoxyCodeLine{00664\ }
\DoxyCodeLine{00665\ \textcolor{comment}{//\ Initialize\ a\ fresh\ page\ (that\ is\ already\ partially\ initialized)}}
\DoxyCodeLine{00666\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{page_8c_a93f6b93722ef321c7a3b3f121c1aa3bd}{\_mi\_page\_init}}(\mbox{\hyperlink{group__heap_ga34a47cde5a5b38c29f1aa3c5e76943c2}{mi\_heap\_t}}*\ heap,\ \mbox{\hyperlink{types_8h_a98e3d539b4113aac496ebe3d379ebe5b}{mi\_page\_t}}*\ page)\ \{}
\DoxyCodeLine{00667\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_af04c7a87bc1c69ef3e763a580f47a418}{mi\_assert}}(page\ !=\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}});}
\DoxyCodeLine{00668\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a4f0664d2a3d9c81776a0f90311aef474}{mi\_page\_set\_heap}}(page,\ heap);}
\DoxyCodeLine{00669\ }
\DoxyCodeLine{00670\ \ \ \textcolor{keywordtype}{size\_t}\ page\_size;}
\DoxyCodeLine{00671\ \ \ \mbox{\hyperlink{eabase_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}}*\ page\_start\ =\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ab02bec7b56343136344cb9441cb889c7}{mi\_page\_area}}(page,\ \&page\_size);\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ab7467946e27cd6bb4af911805cc5db26}{MI\_UNUSED}}(page\_start);}
\DoxyCodeLine{00672\ \ \ \mbox{\hyperlink{track_8h_ab1bbf1b6b42034ef12d83ab7f74de620}{mi\_track\_mem\_noaccess}}(page\_start,page\_size);}
\DoxyCodeLine{00673\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(page\_size\ /\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a6134893990c1f09da2b40092ceecc780}{mi\_page\_block\_size}}(page)\ <\ (1L<<16));}
\DoxyCodeLine{00674\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(page-\/>\mbox{\hyperlink{structmi__page__s_acf15d96ab2462c10365859158a84bb72}{reserved}}\ >\ 0);}
\DoxyCodeLine{00675\ \textcolor{preprocessor}{\ \ \#if\ (MI\_PADDING\ ||\ MI\_ENCODE\_FREELIST)}}
\DoxyCodeLine{00676\ \ \ page-\/>\mbox{\hyperlink{structmi__page__s_a720620090a6e049d89c015c647900034}{keys}}[0]\ =\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a68ddb5f2c595ea9d4e8d450342b4713c}{\_mi\_heap\_random\_next}}(heap);}
\DoxyCodeLine{00677\ \ \ page-\/>\mbox{\hyperlink{structmi__page__s_a720620090a6e049d89c015c647900034}{keys}}[1]\ =\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a68ddb5f2c595ea9d4e8d450342b4713c}{\_mi\_heap\_random\_next}}(heap);}
\DoxyCodeLine{00678\ \textcolor{preprocessor}{\ \ \#endif}}
\DoxyCodeLine{00679\ \textcolor{preprocessor}{\ \ \#if\ MI\_DEBUG>2}}
\DoxyCodeLine{00680\ \ \ \textcolor{keywordflow}{if}\ (page-\/>\mbox{\hyperlink{structmi__page__s_a38337bec0f42cdba61acbf5eded5eddb}{memid}}.\mbox{\hyperlink{structmi__memid__s_a6e612a9fceb896ba741a1b171bf81a4d}{initially\_zero}})\ \{}
\DoxyCodeLine{00681\ \ \ \ \ \mbox{\hyperlink{track_8h_a6e155ed879c074c60f2d2656be414b04}{mi\_track\_mem\_defined}}(page-\/>\mbox{\hyperlink{structmi__page__s_ad25899641cb8380f19fba005b05293ea}{page\_start}},\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a0ebedfe1875740753164d3bf0a948d31}{mi\_page\_committed}}(page));}
\DoxyCodeLine{00682\ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ab812423812d2dd7af864b7e112055d8e}{mi\_assert\_expensive}}(\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a8391ae55dd6885bd38593f740fd349a4}{mi\_mem\_is\_zero}}(page\_start,\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a0ebedfe1875740753164d3bf0a948d31}{mi\_page\_committed}}(page)));}
\DoxyCodeLine{00683\ \ \ \}}
\DoxyCodeLine{00684\ \textcolor{preprocessor}{\ \ \#endif}}
\DoxyCodeLine{00685\ }
\DoxyCodeLine{00686\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(page-\/>\mbox{\hyperlink{structmi__page__s_a9ed1099a997d9c4e42b3bbe631705e41}{capacity}}\ ==\ 0);}
\DoxyCodeLine{00687\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(page-\/>\mbox{\hyperlink{structmi__page__s_ae2d4b1c483d94e3624319bbca00d3da3}{free}}\ ==\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}});}
\DoxyCodeLine{00688\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(page-\/>\mbox{\hyperlink{structmi__page__s_ad1194a6cecba67ba2cf1952eb337968c}{used}}\ ==\ 0);}
\DoxyCodeLine{00689\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_af56ec67c6f794de0f36d59a6390ab4c7}{mi\_page\_is\_owned}}(page));}
\DoxyCodeLine{00690\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(page-\/>xthread\_free\ ==\ 1);}
\DoxyCodeLine{00691\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(page-\/>\mbox{\hyperlink{structmi__page__s_a3cb74f9debb9c29f48990a6b39ec4233}{next}}\ ==\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}});}
\DoxyCodeLine{00692\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(page-\/>\mbox{\hyperlink{structmi__page__s_a5d6c37ca83250fdb2b58cb2767cb0f4c}{prev}}\ ==\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}});}
\DoxyCodeLine{00693\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(page-\/>\mbox{\hyperlink{structmi__page__s_a0a5d0c55c032201268976344519a6842}{retire\_expire}}\ ==\ 0);}
\DoxyCodeLine{00694\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(!\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ae0b5641b1e2fabf59c84685e08520852}{mi\_page\_has\_aligned}}(page));}
\DoxyCodeLine{00695\ \textcolor{preprocessor}{\ \ \#if\ (MI\_PADDING\ ||\ MI\_ENCODE\_FREELIST)}}
\DoxyCodeLine{00696\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(page-\/>\mbox{\hyperlink{structmi__page__s_a720620090a6e049d89c015c647900034}{keys}}[0]\ !=\ 0);}
\DoxyCodeLine{00697\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(page-\/>\mbox{\hyperlink{structmi__page__s_a720620090a6e049d89c015c647900034}{keys}}[1]\ !=\ 0);}
\DoxyCodeLine{00698\ \textcolor{preprocessor}{\ \ \#endif}}
\DoxyCodeLine{00699\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(page-\/>\mbox{\hyperlink{structmi__page__s_a1be9844192c793c997a041ccea53e726}{block\_size\_shift}}\ ==\ 0\ ||\ (\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a6134893990c1f09da2b40092ceecc780}{mi\_page\_block\_size}}(page)\ ==\ ((\textcolor{keywordtype}{size\_t})1\ <<\ page-\/>\mbox{\hyperlink{structmi__page__s_a1be9844192c793c997a041ccea53e726}{block\_size\_shift}})));}
\DoxyCodeLine{00700\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ab812423812d2dd7af864b7e112055d8e}{mi\_assert\_expensive}}(mi\_page\_is\_valid\_init(page));}
\DoxyCodeLine{00701\ }
\DoxyCodeLine{00702\ \ \ \textcolor{comment}{//\ initialize\ an\ initial\ free\ list}}
\DoxyCodeLine{00703\ \ \ \mbox{\hyperlink{page_8c_a40c7a483e3c04fdcf8d9a16bc6e6cea5}{mi\_page\_extend\_free}}(heap,page);}
\DoxyCodeLine{00704\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_af04c7a87bc1c69ef3e763a580f47a418}{mi\_assert}}(\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a87596f606325115ec4f43046dfd3d64a}{mi\_page\_immediate\_available}}(page));}
\DoxyCodeLine{00705\ \}}
\DoxyCodeLine{00706\ }
\DoxyCodeLine{00707\ }
\DoxyCodeLine{00708\ \textcolor{comment}{/*\ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00709\ \textcolor{comment}{\ \ Find\ pages\ with\ free\ blocks}}
\DoxyCodeLine{00710\ \textcolor{comment}{-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/*/}}
\DoxyCodeLine{00711\ }
\DoxyCodeLine{00712\ \textcolor{comment}{//\ Find\ a\ page\ with\ free\ blocks\ of\ \`{}page-\/>block\_size`.}}
\DoxyCodeLine{00713\ \textcolor{keyword}{static}\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a0a63ad6116421ea60eb43806f8881a3b}{mi\_decl\_noinline}}\ \mbox{\hyperlink{types_8h_a98e3d539b4113aac496ebe3d379ebe5b}{mi\_page\_t}}*\ \mbox{\hyperlink{page_8c_af92f35c73fe5b4d284e474246c750c49}{mi\_page\_queue\_find\_free\_ex}}(\mbox{\hyperlink{group__heap_ga34a47cde5a5b38c29f1aa3c5e76943c2}{mi\_heap\_t}}*\ heap,\ \mbox{\hyperlink{types_8h_a9646624e7de8587984ec8e8cd5c5d780}{mi\_page\_queue\_t}}*\ pq,\ \textcolor{keywordtype}{bool}\ first\_try)}
\DoxyCodeLine{00714\ \{}
\DoxyCodeLine{00715\ \ \ \textcolor{comment}{//\ search\ through\ the\ pages\ in\ "{}next\ fit"{}\ order}}
\DoxyCodeLine{00716\ \ \ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{imgui__impl__opengl3__loader_8h_a619bc20e8198de3bd3f3d7fc34de66b2}{count}}\ =\ 0;}
\DoxyCodeLine{00717\ \ \ \textcolor{keywordtype}{long}\ candidate\_limit\ =\ 0;\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ we\ reset\ this\ on\ the\ first\ candidate\ to\ limit\ the\ search}}
\DoxyCodeLine{00718\ \ \ \textcolor{keywordtype}{long}\ page\_full\_retain\ =\ (pq-\/>\mbox{\hyperlink{structmi__page__queue__s_a650100de75005e34566b2d170db7c0e8}{block\_size}}\ >\ \mbox{\hyperlink{types_8h_a27eff54c93bcddce7c482a8c6b58746d}{MI\_SMALL\_MAX\_OBJ\_SIZE}}\ ?\ 0\ :\ heap-\/>\mbox{\hyperlink{structmi__heap__s_a3ff36ed80a0b89a0e0e913e57b028cb3}{page\_full\_retain}});\ \textcolor{comment}{//\ only\ retain\ small\ pages}}
\DoxyCodeLine{00719\ \ \ \mbox{\hyperlink{types_8h_a98e3d539b4113aac496ebe3d379ebe5b}{mi\_page\_t}}*\ page\_candidate\ =\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}};\ \ \textcolor{comment}{//\ a\ page\ with\ free\ space}}
\DoxyCodeLine{00720\ \ \ \mbox{\hyperlink{types_8h_a98e3d539b4113aac496ebe3d379ebe5b}{mi\_page\_t}}*\ page\ =\ pq-\/>\mbox{\hyperlink{structmi__page__queue__s_a2ac5077507dc4bf25a1a8df36955469a}{first}};}
\DoxyCodeLine{00721\ }
\DoxyCodeLine{00722\ \ \ \textcolor{keywordflow}{while}\ (page\ !=\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}})}
\DoxyCodeLine{00723\ \ \ \{}
\DoxyCodeLine{00724\ \ \ \ \ \mbox{\hyperlink{types_8h_a98e3d539b4113aac496ebe3d379ebe5b}{mi\_page\_t}}*\ next\ =\ page-\/>\mbox{\hyperlink{structmi__page__s_a3cb74f9debb9c29f48990a6b39ec4233}{next}};\ \textcolor{comment}{//\ remember\ next\ (as\ this\ page\ can\ move\ to\ another\ queue)}}
\DoxyCodeLine{00725\ \ \ \ \ \mbox{\hyperlink{imgui__impl__opengl3__loader_8h_a619bc20e8198de3bd3f3d7fc34de66b2}{count}}++;}
\DoxyCodeLine{00726\ \ \ \ \ candidate\_limit-\/-\/;}
\DoxyCodeLine{00727\ }
\DoxyCodeLine{00728\ \ \ \ \ \textcolor{comment}{//\ search\ up\ to\ N\ pages\ for\ a\ best\ candidate}}
\DoxyCodeLine{00729\ }
\DoxyCodeLine{00730\ \ \ \ \ \textcolor{comment}{//\ is\ the\ local\ free\ list\ non-\/empty?}}
\DoxyCodeLine{00731\ \ \ \ \ \textcolor{keywordtype}{bool}\ immediate\_available\ =\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a87596f606325115ec4f43046dfd3d64a}{mi\_page\_immediate\_available}}(page);}
\DoxyCodeLine{00732\ \ \ \ \ \textcolor{keywordflow}{if}\ (!immediate\_available)\ \{}
\DoxyCodeLine{00733\ \ \ \ \ \ \ \textcolor{comment}{//\ collect\ freed\ blocks\ by\ us\ and\ other\ threads\ to\ we\ get\ a\ proper\ use\ count}}
\DoxyCodeLine{00734\ \ \ \ \ \ \ \mbox{\hyperlink{page_8c_ae2b78e1e45e4ac3db8102e9d333d2972}{\_mi\_page\_free\_collect}}(page,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00735\ \ \ \ \ \ \ immediate\_available\ =\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a87596f606325115ec4f43046dfd3d64a}{mi\_page\_immediate\_available}}(page);}
\DoxyCodeLine{00736\ \ \ \ \ \}}
\DoxyCodeLine{00737\ }
\DoxyCodeLine{00738\ \ \ \ \ \textcolor{comment}{//\ if\ the\ page\ is\ completely\ full,\ move\ it\ to\ the\ \`{}mi\_pages\_full`}}
\DoxyCodeLine{00739\ \ \ \ \ \textcolor{comment}{//\ queue\ so\ we\ don't\ visit\ long-\/lived\ pages\ too\ often.}}
\DoxyCodeLine{00740\ \ \ \ \ \textcolor{keywordflow}{if}\ (!immediate\_available\ \&\&\ !\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ad36cb8000f39dcfbc68c9d9b219d0397}{mi\_page\_is\_expandable}}(page))\ \{}
\DoxyCodeLine{00741\ \ \ \ \ \ \ page\_full\_retain-\/-\/;}
\DoxyCodeLine{00742\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (page\_full\_retain\ <\ 0)\ \{}
\DoxyCodeLine{00743\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(!\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a250f4d0710309fb1cff782cd06644842}{mi\_page\_is\_in\_full}}(page)\ \&\&\ !\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a87596f606325115ec4f43046dfd3d64a}{mi\_page\_immediate\_available}}(page));}
\DoxyCodeLine{00744\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{page_8c_afb25978212749e522404ee1f2dd1a6d4}{mi\_page\_to\_full}}(page,\ pq);}
\DoxyCodeLine{00745\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00746\ \ \ \ \ \}}
\DoxyCodeLine{00747\ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00748\ \ \ \ \ \ \ \textcolor{comment}{//\ the\ page\ has\ free\ space,\ make\ it\ a\ candidate}}
\DoxyCodeLine{00749\ \ \ \ \ \ \ \textcolor{comment}{//\ we\ prefer\ non-\/expandable\ pages\ with\ high\ usage\ as\ candidates\ (to\ reduce\ commit,\ and\ increase\ chances\ of\ free-\/ing\ up\ pages)}}
\DoxyCodeLine{00750\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (page\_candidate\ ==\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}})\ \{}
\DoxyCodeLine{00751\ \ \ \ \ \ \ \ \ page\_candidate\ =\ page;}
\DoxyCodeLine{00752\ \ \ \ \ \ \ \ \ candidate\_limit\ =\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a1d96c2519367ba4bef4505cbd13aaec3}{\_mi\_option\_get\_fast}}(\mbox{\hyperlink{mimalloc_8h_acf0af9f50d2fca76b4e158d611bc930bad13382757101aa4fbc4984fa0f917133}{mi\_option\_page\_max\_candidates}});}
\DoxyCodeLine{00753\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00754\ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_adfd6d23350810ca36986ffbc5459c93d}{mi\_page\_all\_free}}(page\_candidate))\ \{}
\DoxyCodeLine{00755\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{page_8c_a1c5c78a8becee842d5b9444a2ee67a3b}{\_mi\_page\_free}}(page\_candidate,\ pq);}
\DoxyCodeLine{00756\ \ \ \ \ \ \ \ \ page\_candidate\ =\ page;}
\DoxyCodeLine{00757\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00758\ \ \ \ \ \ \ \textcolor{comment}{//\ prefer\ to\ reuse\ fuller\ pages\ (in\ the\ hope\ the\ less\ used\ page\ gets\ freed)}}
\DoxyCodeLine{00759\ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (page-\/>\mbox{\hyperlink{structmi__page__s_ad1194a6cecba67ba2cf1952eb337968c}{used}}\ >=\ page\_candidate-\/>\mbox{\hyperlink{structmi__page__s_ad1194a6cecba67ba2cf1952eb337968c}{used}}\ \&\&\ !\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a45a43866de43bd1090d92b9ebcb39dde}{mi\_page\_is\_mostly\_used}}(page))\ \{\ \textcolor{comment}{//\ \&\&\ !mi\_page\_is\_expandable(page))\ \{}}
\DoxyCodeLine{00760\ \ \ \ \ \ \ \ \ page\_candidate\ =\ page;}
\DoxyCodeLine{00761\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00762\ \ \ \ \ \ \ \textcolor{comment}{//\ if\ we\ find\ a\ non-\/expandable\ candidate,\ or\ searched\ for\ N\ pages,\ return\ with\ the\ best\ candidate}}
\DoxyCodeLine{00763\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (immediate\_available\ ||\ candidate\_limit\ <=\ 0)\ \{}
\DoxyCodeLine{00764\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(page\_candidate!=\mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}});}
\DoxyCodeLine{00765\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00766\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00767\ \ \ \ \ \}}
\DoxyCodeLine{00768\ }
\DoxyCodeLine{00769\ \textcolor{preprocessor}{\ \ \#if\ 0}}
\DoxyCodeLine{00770\ \ \ \ \ \textcolor{comment}{//\ first-\/fit\ algorithm\ without\ candidates}}
\DoxyCodeLine{00771\ \ \ \ \ \textcolor{comment}{//\ If\ the\ page\ contains\ free\ blocks,\ we\ are\ done}}
\DoxyCodeLine{00772\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a87596f606325115ec4f43046dfd3d64a}{mi\_page\_immediate\_available}}(page)\ ||\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ad36cb8000f39dcfbc68c9d9b219d0397}{mi\_page\_is\_expandable}}(page))\ \{}
\DoxyCodeLine{00773\ \ \ \ \ \ \ \textcolor{keywordflow}{break};\ \ \textcolor{comment}{//\ pick\ this\ one}}
\DoxyCodeLine{00774\ \ \ \ \ \}}
\DoxyCodeLine{00775\ }
\DoxyCodeLine{00776\ \ \ \ \ \textcolor{comment}{//\ If\ the\ page\ is\ completely\ full,\ move\ it\ to\ the\ \`{}mi\_pages\_full`}}
\DoxyCodeLine{00777\ \ \ \ \ \textcolor{comment}{//\ queue\ so\ we\ don't\ visit\ long-\/lived\ pages\ too\ often.}}
\DoxyCodeLine{00778\ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(!\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a250f4d0710309fb1cff782cd06644842}{mi\_page\_is\_in\_full}}(page)\ \&\&\ !\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a87596f606325115ec4f43046dfd3d64a}{mi\_page\_immediate\_available}}(page));}
\DoxyCodeLine{00779\ \ \ \ \ \mbox{\hyperlink{page_8c_afb25978212749e522404ee1f2dd1a6d4}{mi\_page\_to\_full}}(page,\ pq);}
\DoxyCodeLine{00780\ \textcolor{preprocessor}{\ \ \#endif}}
\DoxyCodeLine{00781\ }
\DoxyCodeLine{00782\ \ \ \ \ page\ =\ next;}
\DoxyCodeLine{00783\ \ \ \}\ \textcolor{comment}{//\ for\ each\ page}}
\DoxyCodeLine{00784\ }
\DoxyCodeLine{00785\ \ \ \mbox{\hyperlink{types_8h_af1dffe48b7fd5106aa0775775b59a173}{mi\_heap\_stat\_counter\_increase}}(heap,\ page\_searches,\ \mbox{\hyperlink{imgui__impl__opengl3__loader_8h_a619bc20e8198de3bd3f3d7fc34de66b2}{count}});}
\DoxyCodeLine{00786\ }
\DoxyCodeLine{00787\ \ \ \textcolor{comment}{//\ set\ the\ page\ to\ the\ best\ candidate}}
\DoxyCodeLine{00788\ \ \ \textcolor{keywordflow}{if}\ (page\_candidate\ !=\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}})\ \{}
\DoxyCodeLine{00789\ \ \ \ \ page\ =\ page\_candidate;}
\DoxyCodeLine{00790\ \ \ \}}
\DoxyCodeLine{00791\ \ \ \textcolor{keywordflow}{if}\ (page\ !=\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}})\ \{}
\DoxyCodeLine{00792\ \ \ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a87596f606325115ec4f43046dfd3d64a}{mi\_page\_immediate\_available}}(page))\ \{}
\DoxyCodeLine{00793\ \ \ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ad36cb8000f39dcfbc68c9d9b219d0397}{mi\_page\_is\_expandable}}(page));}
\DoxyCodeLine{00794\ \ \ \ \ \ \ \mbox{\hyperlink{page_8c_a40c7a483e3c04fdcf8d9a16bc6e6cea5}{mi\_page\_extend\_free}}(heap,\ page);}
\DoxyCodeLine{00795\ \ \ \ \ \}}
\DoxyCodeLine{00796\ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a87596f606325115ec4f43046dfd3d64a}{mi\_page\_immediate\_available}}(page));}
\DoxyCodeLine{00797\ \ \ \}}
\DoxyCodeLine{00798\ }
\DoxyCodeLine{00799\ \ \ \textcolor{keywordflow}{if}\ (page\ ==\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}})\ \{}
\DoxyCodeLine{00800\ \ \ \ \ \mbox{\hyperlink{page_8c_abc5253b4341c8d7eab888068e4f9b951}{\_mi\_heap\_collect\_retired}}(heap,\ \textcolor{keyword}{false});\ \textcolor{comment}{//\ perhaps\ make\ a\ page\ available}}
\DoxyCodeLine{00801\ \ \ \ \ page\ =\ \mbox{\hyperlink{page_8c_aa1a62243576442a73c1e37ff6f3ba5cd}{mi\_page\_fresh}}(heap,\ pq);}
\DoxyCodeLine{00802\ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(page\ ==\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}}\ ||\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a87596f606325115ec4f43046dfd3d64a}{mi\_page\_immediate\_available}}(page));}
\DoxyCodeLine{00803\ \ \ \ \ \textcolor{keywordflow}{if}\ (page\ ==\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}}\ \&\&\ first\_try)\ \{}
\DoxyCodeLine{00804\ \ \ \ \ \ \ \textcolor{comment}{//\ out-\/of-\/memory\ \_or\_\ an\ abandoned\ page\ with\ free\ blocks\ was\ reclaimed,\ try\ once\ again}}
\DoxyCodeLine{00805\ \ \ \ \ \ \ page\ =\ \mbox{\hyperlink{page_8c_af92f35c73fe5b4d284e474246c750c49}{mi\_page\_queue\_find\_free\_ex}}(heap,\ pq,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00806\ \ \ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(page\ ==\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}}\ ||\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a87596f606325115ec4f43046dfd3d64a}{mi\_page\_immediate\_available}}(page));}
\DoxyCodeLine{00807\ \ \ \ \ \}}
\DoxyCodeLine{00808\ \ \ \}}
\DoxyCodeLine{00809\ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00810\ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(page\ ==\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}}\ ||\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a87596f606325115ec4f43046dfd3d64a}{mi\_page\_immediate\_available}}(page));}
\DoxyCodeLine{00811\ \ \ \ \ \textcolor{comment}{//\ move\ the\ page\ to\ the\ front\ of\ the\ queue}}
\DoxyCodeLine{00812\ \ \ \ \ \mbox{\hyperlink{page-queue_8c_a0874094115fbf07a62af03982e6e9463}{mi\_page\_queue\_move\_to\_front}}(heap,\ pq,\ page);}
\DoxyCodeLine{00813\ \ \ \ \ page-\/>\mbox{\hyperlink{structmi__page__s_a0a5d0c55c032201268976344519a6842}{retire\_expire}}\ =\ 0;}
\DoxyCodeLine{00814\ \ \ \ \ \textcolor{comment}{//\ \_mi\_heap\_collect\_retired(heap,\ false);\ //\ update\ retire\ counts;\ note:\ increases\ rss\ on\ MemoryLoad\ bench\ so\ don't\ do\ this}}
\DoxyCodeLine{00815\ \ \ \}}
\DoxyCodeLine{00816\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(page\ ==\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}}\ ||\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a87596f606325115ec4f43046dfd3d64a}{mi\_page\_immediate\_available}}(page));}
\DoxyCodeLine{00817\ }
\DoxyCodeLine{00818\ }
\DoxyCodeLine{00819\ \ \ \textcolor{keywordflow}{return}\ page;}
\DoxyCodeLine{00820\ \}}
\DoxyCodeLine{00821\ }
\DoxyCodeLine{00822\ }
\DoxyCodeLine{00823\ }
\DoxyCodeLine{00824\ \textcolor{comment}{//\ Find\ a\ page\ with\ free\ blocks\ of\ \`{}size`.}}
\DoxyCodeLine{00825\ \textcolor{keyword}{static}\ \mbox{\hyperlink{types_8h_a98e3d539b4113aac496ebe3d379ebe5b}{mi\_page\_t}}*\ \mbox{\hyperlink{page_8c_acb83ee20964fa6632dd3be64b35a25bb}{mi\_find\_free\_page}}(\mbox{\hyperlink{group__heap_ga34a47cde5a5b38c29f1aa3c5e76943c2}{mi\_heap\_t}}*\ heap,\ \mbox{\hyperlink{types_8h_a9646624e7de8587984ec8e8cd5c5d780}{mi\_page\_queue\_t}}*\ pq)\ \{}
\DoxyCodeLine{00826\ \ \ \textcolor{comment}{//\ mi\_page\_queue\_t*\ pq\ =\ mi\_page\_queue(heap,\ size);}}
\DoxyCodeLine{00827\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(!\mbox{\hyperlink{page-queue_8c_a06408445b78873dce28c5c6e29be9153}{mi\_page\_queue\_is\_huge}}(pq));}
\DoxyCodeLine{00828\ }
\DoxyCodeLine{00829\ \ \ \textcolor{comment}{//\ check\ the\ first\ page:\ we\ even\ do\ this\ with\ candidate\ search\ or\ otherwise\ we\ re-\/search\ every\ time}}
\DoxyCodeLine{00830\ \ \ \mbox{\hyperlink{types_8h_a98e3d539b4113aac496ebe3d379ebe5b}{mi\_page\_t}}*\ page\ =\ pq-\/>\mbox{\hyperlink{structmi__page__queue__s_a2ac5077507dc4bf25a1a8df36955469a}{first}};}
\DoxyCodeLine{00831\ \ \ \textcolor{keywordflow}{if}\ \mbox{\hyperlink{bits_8h_a7b29eabf31d4ddb28a16267045384e03}{mi\_likely}}(page\ !=\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}}\ \&\&\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a87596f606325115ec4f43046dfd3d64a}{mi\_page\_immediate\_available}}(page))\ \{}
\DoxyCodeLine{00832\ \textcolor{preprocessor}{\ \ \ \ \#if\ (MI\_SECURE>=3)\ }\textcolor{comment}{//\ in\ secure\ mode,\ we\ extend\ half\ the\ time\ to\ increase\ randomness}}
\DoxyCodeLine{00833\ \ \ \ \ \textcolor{keywordflow}{if}\ (page-\/>\mbox{\hyperlink{structmi__page__s_a9ed1099a997d9c4e42b3bbe631705e41}{capacity}}\ <\ page-\/>\mbox{\hyperlink{structmi__page__s_acf15d96ab2462c10365859158a84bb72}{reserved}}\ \&\&\ ((\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a68ddb5f2c595ea9d4e8d450342b4713c}{\_mi\_heap\_random\_next}}(heap)\ \&\ 1)\ ==\ 1))\ \{}
\DoxyCodeLine{00834\ \ \ \ \ \ \ \mbox{\hyperlink{page_8c_a40c7a483e3c04fdcf8d9a16bc6e6cea5}{mi\_page\_extend\_free}}(heap,\ page);}
\DoxyCodeLine{00835\ \ \ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a87596f606325115ec4f43046dfd3d64a}{mi\_page\_immediate\_available}}(page));}
\DoxyCodeLine{00836\ \ \ \ \ \}}
\DoxyCodeLine{00837\ \textcolor{preprocessor}{\ \ \ \ \#endif}}
\DoxyCodeLine{00838\ \ \ \ \ page-\/>\mbox{\hyperlink{structmi__page__s_a0a5d0c55c032201268976344519a6842}{retire\_expire}}\ =\ 0;}
\DoxyCodeLine{00839\ \ \ \ \ \textcolor{keywordflow}{return}\ page;\ \textcolor{comment}{//\ fast\ path}}
\DoxyCodeLine{00840\ \ \ \}}
\DoxyCodeLine{00841\ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00842\ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{page_8c_af92f35c73fe5b4d284e474246c750c49}{mi\_page\_queue\_find\_free\_ex}}(heap,\ pq,\ \textcolor{keyword}{true});}
\DoxyCodeLine{00843\ \ \ \}}
\DoxyCodeLine{00844\ \}}
\DoxyCodeLine{00845\ }
\DoxyCodeLine{00846\ }
\DoxyCodeLine{00847\ \textcolor{comment}{/*\ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00848\ \textcolor{comment}{\ \ Users\ can\ register\ a\ deferred\ free\ function\ called}}
\DoxyCodeLine{00849\ \textcolor{comment}{\ \ when\ the\ \`{}free`\ list\ is\ empty.\ Since\ the\ \`{}local\_free`}}
\DoxyCodeLine{00850\ \textcolor{comment}{\ \ is\ separate\ this\ is\ deterministically\ called\ after}}
\DoxyCodeLine{00851\ \textcolor{comment}{\ \ a\ certain\ number\ of\ allocations.}}
\DoxyCodeLine{00852\ \textcolor{comment}{-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/\ */}}
\DoxyCodeLine{00853\ }
\DoxyCodeLine{00854\ \textcolor{keyword}{static}\ \mbox{\hyperlink{group__extended_ga292a45f7dbc7cd23c5352ce1f0002816}{mi\_deferred\_free\_fun}}*\ \textcolor{keyword}{volatile}\ \mbox{\hyperlink{page_8c_ad1a540f25b510d62f9be16198a22dadc}{deferred\_free}}\ =\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}};}
\DoxyCodeLine{00855\ \textcolor{keyword}{static}\ \mbox{\hyperlink{page_8c_a492294368c30a9113c006ebf2a78e62e}{\_Atomic}}(\textcolor{keywordtype}{void}*)\ deferred\_arg;\ \textcolor{comment}{//\ =\ NULL}}
\DoxyCodeLine{00856\ }
\DoxyCodeLine{00857\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_aede81c520000cbb08ad669e096c94d51}{\_mi\_deferred\_free}}(\mbox{\hyperlink{group__heap_ga34a47cde5a5b38c29f1aa3c5e76943c2}{mi\_heap\_t}}*\ heap,\ \textcolor{keywordtype}{bool}\ force)\ \{}
\DoxyCodeLine{00858\ \ \ heap-\/>\mbox{\hyperlink{structmi__heap__s_a2e524aeb1b30f344a4f0b70e6cf6cb3a}{tld}}-\/>\mbox{\hyperlink{structmi__tld__s_a791f263fc6b2e272af2dcaaab8b99f5b}{heartbeat}}++;}
\DoxyCodeLine{00859\ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{page_8c_ad1a540f25b510d62f9be16198a22dadc}{deferred\_free}}\ !=\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}}\ \&\&\ !heap-\/>\mbox{\hyperlink{structmi__heap__s_a2e524aeb1b30f344a4f0b70e6cf6cb3a}{tld}}-\/>\mbox{\hyperlink{structmi__tld__s_a5aad0f33a6a8704dcce59752fa3c2797}{recurse}})\ \{}
\DoxyCodeLine{00860\ \ \ \ \ heap-\/>\mbox{\hyperlink{structmi__heap__s_a2e524aeb1b30f344a4f0b70e6cf6cb3a}{tld}}-\/>\mbox{\hyperlink{structmi__tld__s_a5aad0f33a6a8704dcce59752fa3c2797}{recurse}}\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00861\ \ \ \ \ \mbox{\hyperlink{page_8c_ad1a540f25b510d62f9be16198a22dadc}{deferred\_free}}(force,\ heap-\/>\mbox{\hyperlink{structmi__heap__s_a2e524aeb1b30f344a4f0b70e6cf6cb3a}{tld}}-\/>\mbox{\hyperlink{structmi__tld__s_a791f263fc6b2e272af2dcaaab8b99f5b}{heartbeat}},\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2atomic_8h_a33cea0fb6145ad9a01e74ccbe5ed7e4b}{mi\_atomic\_load\_ptr\_relaxed}}(\textcolor{keywordtype}{void},\&deferred\_arg));}
\DoxyCodeLine{00862\ \ \ \ \ heap-\/>\mbox{\hyperlink{structmi__heap__s_a2e524aeb1b30f344a4f0b70e6cf6cb3a}{tld}}-\/>\mbox{\hyperlink{structmi__tld__s_a5aad0f33a6a8704dcce59752fa3c2797}{recurse}}\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00863\ \ \ \}}
\DoxyCodeLine{00864\ \}}
\DoxyCodeLine{00865\ }
\DoxyCodeLine{00866\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{group__extended_ga3460a6ca91af97be4058f523d3cb8ece}{mi\_register\_deferred\_free}}(\mbox{\hyperlink{group__extended_ga292a45f7dbc7cd23c5352ce1f0002816}{mi\_deferred\_free\_fun}}*\ fn,\ \textcolor{keywordtype}{void}*\ \mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}})\ \mbox{\hyperlink{mimalloc_8h_a2d1ca113437044da99abaaedd0b36ed8}{mi\_attr\_noexcept}}\ \{}
\DoxyCodeLine{00867\ \ \ \mbox{\hyperlink{page_8c_ad1a540f25b510d62f9be16198a22dadc}{deferred\_free}}\ =\ fn;}
\DoxyCodeLine{00868\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2atomic_8h_a53a1e566591961fd9cf3d37f05c2cbb2}{mi\_atomic\_store\_ptr\_release}}(\textcolor{keywordtype}{void},\&deferred\_arg,\ \mbox{\hyperlink{mimalloc_8h_ac9ca0390aa991912667416f6baf99e51}{arg}});}
\DoxyCodeLine{00869\ \}}
\DoxyCodeLine{00870\ }
\DoxyCodeLine{00871\ }
\DoxyCodeLine{00872\ \textcolor{comment}{/*\ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00873\ \textcolor{comment}{\ \ General\ allocation}}
\DoxyCodeLine{00874\ \textcolor{comment}{-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/\ */}}
\DoxyCodeLine{00875\ }
\DoxyCodeLine{00876\ \textcolor{comment}{//\ Huge\ pages\ contain\ just\ one\ block,\ and\ the\ segment\ contains\ just\ that\ page.}}
\DoxyCodeLine{00877\ \textcolor{comment}{//\ Huge\ pages\ are\ also\ use\ if\ the\ requested\ alignment\ is\ very\ large\ (>\ MI\_BLOCK\_ALIGNMENT\_MAX)}}
\DoxyCodeLine{00878\ \textcolor{comment}{//\ so\ their\ size\ is\ not\ always\ \`{}>\ MI\_LARGE\_OBJ\_SIZE\_MAX`.}}
\DoxyCodeLine{00879\ \textcolor{keyword}{static}\ \mbox{\hyperlink{types_8h_a98e3d539b4113aac496ebe3d379ebe5b}{mi\_page\_t}}*\ \mbox{\hyperlink{page_8c_a3d592e833ced8aeb15b5cec83f0b1374}{mi\_huge\_page\_alloc}}(\mbox{\hyperlink{group__heap_ga34a47cde5a5b38c29f1aa3c5e76943c2}{mi\_heap\_t}}*\ heap,\ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{imgui__impl__opengl3__loader_8h_a3d1e3edfcf61ca2d831883e1afbad89e}{size}},\ \textcolor{keywordtype}{size\_t}\ page\_alignment,\ \mbox{\hyperlink{types_8h_a9646624e7de8587984ec8e8cd5c5d780}{mi\_page\_queue\_t}}*\ pq)\ \{}
\DoxyCodeLine{00880\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{sugar_8h_a9766f5ceca5e25981858ec7384456072}{block\_size}}\ =\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_aa30b56bf7b30da1c4f35323cfccce4f1}{\_mi\_os\_good\_alloc\_size}}(\mbox{\hyperlink{imgui__impl__opengl3__loader_8h_a3d1e3edfcf61ca2d831883e1afbad89e}{size}});}
\DoxyCodeLine{00881\ \ \ \textcolor{comment}{//\ mi\_assert\_internal(mi\_bin(block\_size)\ ==\ MI\_BIN\_HUGE\ ||\ page\_alignment\ >\ 0);}}
\DoxyCodeLine{00882\ \textcolor{preprocessor}{\ \ \#if\ MI\_HUGE\_PAGE\_ABANDON}}
\DoxyCodeLine{00883\ \textcolor{preprocessor}{\ \ \#error\ todo.}}
\DoxyCodeLine{00884\ \textcolor{preprocessor}{\ \ \#else}}
\DoxyCodeLine{00885\ \ \ \textcolor{comment}{//\ mi\_page\_queue\_t*\ pq\ =\ mi\_page\_queue(heap,\ MI\_LARGE\_MAX\_OBJ\_SIZE+1);\ \ //\ always\ in\ the\ huge\ queue\ regardless\ of\ the\ block\ size}}
\DoxyCodeLine{00886\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(\mbox{\hyperlink{page-queue_8c_a06408445b78873dce28c5c6e29be9153}{mi\_page\_queue\_is\_huge}}(pq));}
\DoxyCodeLine{00887\ \textcolor{preprocessor}{\ \ \#endif}}
\DoxyCodeLine{00888\ \ \ \mbox{\hyperlink{types_8h_a98e3d539b4113aac496ebe3d379ebe5b}{mi\_page\_t}}*\ page\ =\ \mbox{\hyperlink{page_8c_afdce56576b07a6f0321c78f9ca906141}{mi\_page\_fresh\_alloc}}(heap,\ pq,\ \mbox{\hyperlink{sugar_8h_a9766f5ceca5e25981858ec7384456072}{block\_size}},\ page\_alignment);}
\DoxyCodeLine{00889\ \ \ \textcolor{keywordflow}{if}\ (page\ !=\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}})\ \{}
\DoxyCodeLine{00890\ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a6134893990c1f09da2b40092ceecc780}{mi\_page\_block\_size}}(page)\ >=\ \mbox{\hyperlink{imgui__impl__opengl3__loader_8h_a3d1e3edfcf61ca2d831883e1afbad89e}{size}});}
\DoxyCodeLine{00891\ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a87596f606325115ec4f43046dfd3d64a}{mi\_page\_immediate\_available}}(page));}
\DoxyCodeLine{00892\ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_aebe1b18846bd3fc16de5b52cd2250bec}{mi\_page\_is\_huge}}(page));}
\DoxyCodeLine{00893\ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a1b94ed5207a90334cdecba2006d91038}{mi\_page\_is\_singleton}}(page));}
\DoxyCodeLine{00894\ \textcolor{preprocessor}{\ \ \ \ \#if\ MI\_HUGE\_PAGE\_ABANDON}}
\DoxyCodeLine{00895\ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_aa75f964d916bd58a37861b88491c51fb}{mi\_page\_is\_abandoned}}(page));}
\DoxyCodeLine{00896\ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a4f0664d2a3d9c81776a0f90311aef474}{mi\_page\_set\_heap}}(page,\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}});}
\DoxyCodeLine{00897\ \textcolor{preprocessor}{\ \ \ \ \#endif}}
\DoxyCodeLine{00898\ \ \ \ \ \mbox{\hyperlink{types_8h_a196bcd7a8496ad2ced97ac89b5739988}{mi\_heap\_stat\_increase}}(heap,\ malloc\_huge,\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a6134893990c1f09da2b40092ceecc780}{mi\_page\_block\_size}}(page));}
\DoxyCodeLine{00899\ \ \ \ \ \mbox{\hyperlink{types_8h_af1dffe48b7fd5106aa0775775b59a173}{mi\_heap\_stat\_counter\_increase}}(heap,\ malloc\_huge\_count,\ 1);}
\DoxyCodeLine{00900\ \ \ \}}
\DoxyCodeLine{00901\ \ \ \textcolor{keywordflow}{return}\ page;}
\DoxyCodeLine{00902\ \}}
\DoxyCodeLine{00903\ }
\DoxyCodeLine{00904\ }
\DoxyCodeLine{00905\ \textcolor{comment}{//\ Allocate\ a\ page}}
\DoxyCodeLine{00906\ \textcolor{comment}{//\ Note:\ in\ debug\ mode\ the\ size\ includes\ MI\_PADDING\_SIZE\ and\ might\ have\ overflowed.}}
\DoxyCodeLine{00907\ \textcolor{keyword}{static}\ \mbox{\hyperlink{types_8h_a98e3d539b4113aac496ebe3d379ebe5b}{mi\_page\_t}}*\ \mbox{\hyperlink{page_8c_aeaa06e36da1cb82dbf0f99e7742ecff8}{mi\_find\_page}}(\mbox{\hyperlink{group__heap_ga34a47cde5a5b38c29f1aa3c5e76943c2}{mi\_heap\_t}}*\ heap,\ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{imgui__impl__opengl3__loader_8h_a3d1e3edfcf61ca2d831883e1afbad89e}{size}},\ \textcolor{keywordtype}{size\_t}\ huge\_alignment)\ \mbox{\hyperlink{mimalloc_8h_a2d1ca113437044da99abaaedd0b36ed8}{mi\_attr\_noexcept}}\ \{}
\DoxyCodeLine{00908\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ req\_size\ =\ \mbox{\hyperlink{imgui__impl__opengl3__loader_8h_a3d1e3edfcf61ca2d831883e1afbad89e}{size}}\ -\/\ \mbox{\hyperlink{types_8h_a425481b3d9ef67bde1f23889eb9db684}{MI\_PADDING\_SIZE}};\ \ \textcolor{comment}{//\ correct\ for\ padding\_size\ in\ case\ of\ an\ overflow\ on\ \`{}size`}}
\DoxyCodeLine{00909\ \ \ \textcolor{keywordflow}{if}\ \mbox{\hyperlink{bits_8h_a13767b1803a4c31c40d896e9c08bc8a3}{mi\_unlikely}}(req\_size\ >\ \mbox{\hyperlink{types_8h_a1e8989503ebdb1d6865a46923b23b93a}{MI\_MAX\_ALLOC\_SIZE}})\ \{}
\DoxyCodeLine{00910\ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2atomic_8h_a2bebc073bcaac71658e57bb260c2e426}{\_mi\_error\_message}}(\mbox{\hyperlink{types_8h_a888552a5e3c78b5883904cf5d55244ab}{EOVERFLOW}},\ \textcolor{stringliteral}{"{}allocation\ request\ is\ too\ large\ (\%zu\ bytes)\(\backslash\)n"{}},\ req\_size);}
\DoxyCodeLine{00911\ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}};}
\DoxyCodeLine{00912\ \ \ \}}
\DoxyCodeLine{00913\ \ \ \mbox{\hyperlink{types_8h_a9646624e7de8587984ec8e8cd5c5d780}{mi\_page\_queue\_t}}*\ pq\ =\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a3c9ff51031747112ac3891260143a552}{mi\_page\_queue}}(heap,\ (huge\_alignment\ >\ 0\ ?\ \mbox{\hyperlink{types_8h_aedfdf546ebfa1e91dcf909b8db7b21dc}{MI\_LARGE\_MAX\_OBJ\_SIZE}}+1\ :\ \mbox{\hyperlink{imgui__impl__opengl3__loader_8h_a3d1e3edfcf61ca2d831883e1afbad89e}{size}}));}
\DoxyCodeLine{00914\ \ \ \textcolor{comment}{//\ huge\ allocation?}}
\DoxyCodeLine{00915\ \ \ \textcolor{keywordflow}{if}\ \mbox{\hyperlink{bits_8h_a13767b1803a4c31c40d896e9c08bc8a3}{mi\_unlikely}}(\mbox{\hyperlink{page-queue_8c_a06408445b78873dce28c5c6e29be9153}{mi\_page\_queue\_is\_huge}}(pq)\ ||\ req\_size\ >\ \mbox{\hyperlink{types_8h_a1e8989503ebdb1d6865a46923b23b93a}{MI\_MAX\_ALLOC\_SIZE}})\ \{}
\DoxyCodeLine{00916\ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{page_8c_a3d592e833ced8aeb15b5cec83f0b1374}{mi\_huge\_page\_alloc}}(heap,\mbox{\hyperlink{imgui__impl__opengl3__loader_8h_a3d1e3edfcf61ca2d831883e1afbad89e}{size}},huge\_alignment,pq);}
\DoxyCodeLine{00917\ \ \ \}}
\DoxyCodeLine{00918\ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00919\ \ \ \ \ \textcolor{comment}{//\ otherwise\ find\ a\ page\ with\ free\ blocks\ in\ our\ size\ segregated\ queues}}
\DoxyCodeLine{00920\ \textcolor{preprocessor}{\ \ \ \ \#if\ MI\_PADDING}}
\DoxyCodeLine{00921\ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(\mbox{\hyperlink{imgui__impl__opengl3__loader_8h_a3d1e3edfcf61ca2d831883e1afbad89e}{size}}\ >=\ \mbox{\hyperlink{types_8h_a425481b3d9ef67bde1f23889eb9db684}{MI\_PADDING\_SIZE}});}
\DoxyCodeLine{00922\ \textcolor{preprocessor}{\ \ \ \ \#endif}}
\DoxyCodeLine{00923\ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{page_8c_acb83ee20964fa6632dd3be64b35a25bb}{mi\_find\_free\_page}}(heap,\ pq);}
\DoxyCodeLine{00924\ \ \ \}}
\DoxyCodeLine{00925\ \}}
\DoxyCodeLine{00926\ }
\DoxyCodeLine{00927\ }
\DoxyCodeLine{00928\ \textcolor{comment}{//\ Generic\ allocation\ routine\ if\ the\ fast\ path\ (`alloc.c:mi\_page\_malloc`)\ does\ not\ succeed.}}
\DoxyCodeLine{00929\ \textcolor{comment}{//\ Note:\ in\ debug\ mode\ the\ size\ includes\ MI\_PADDING\_SIZE\ and\ might\ have\ overflowed.}}
\DoxyCodeLine{00930\ \textcolor{comment}{//\ The\ \`{}huge\_alignment`\ is\ normally\ 0\ but\ is\ set\ to\ a\ multiple\ of\ MI\_SLICE\_SIZE\ for}}
\DoxyCodeLine{00931\ \textcolor{comment}{//\ very\ large\ requested\ alignments\ in\ which\ case\ we\ use\ a\ huge\ singleton\ page.}}
\DoxyCodeLine{00932\ \textcolor{keywordtype}{void}*\ \mbox{\hyperlink{page_8c_adcb79462f17b2e37218412f941269aa7}{\_mi\_malloc\_generic}}(\mbox{\hyperlink{group__heap_ga34a47cde5a5b38c29f1aa3c5e76943c2}{mi\_heap\_t}}*\ heap,\ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{imgui__impl__opengl3__loader_8h_a3d1e3edfcf61ca2d831883e1afbad89e}{size}},\ \textcolor{keywordtype}{bool}\ zero,\ \textcolor{keywordtype}{size\_t}\ huge\_alignment)\ \mbox{\hyperlink{mimalloc_8h_a2d1ca113437044da99abaaedd0b36ed8}{mi\_attr\_noexcept}}}
\DoxyCodeLine{00933\ \{}
\DoxyCodeLine{00934\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(heap\ !=\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}});}
\DoxyCodeLine{00935\ }
\DoxyCodeLine{00936\ \ \ \textcolor{comment}{//\ initialize\ if\ necessary}}
\DoxyCodeLine{00937\ \ \ \textcolor{keywordflow}{if}\ \mbox{\hyperlink{bits_8h_a13767b1803a4c31c40d896e9c08bc8a3}{mi\_unlikely}}(!\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a320c7d8a15c57974d3b105558a2a55e6}{mi\_heap\_is\_initialized}}(heap))\ \{}
\DoxyCodeLine{00938\ \ \ \ \ heap\ =\ \mbox{\hyperlink{group__heap_ga14c667a6e2c5d28762d8cb7d4e057909}{mi\_heap\_get\_default}}();\ \textcolor{comment}{//\ calls\ mi\_thread\_init}}
\DoxyCodeLine{00939\ \ \ \ \ \textcolor{keywordflow}{if}\ \mbox{\hyperlink{bits_8h_a13767b1803a4c31c40d896e9c08bc8a3}{mi\_unlikely}}(!\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a320c7d8a15c57974d3b105558a2a55e6}{mi\_heap\_is\_initialized}}(heap))\ \{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}};\ \}}
\DoxyCodeLine{00940\ \ \ \}}
\DoxyCodeLine{00941\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a320c7d8a15c57974d3b105558a2a55e6}{mi\_heap\_is\_initialized}}(heap));}
\DoxyCodeLine{00942\ }
\DoxyCodeLine{00943\ \ \ \textcolor{comment}{//\ do\ administrative\ tasks\ every\ N\ generic\ mallocs}}
\DoxyCodeLine{00944\ \ \ \textcolor{keywordflow}{if}\ \mbox{\hyperlink{bits_8h_a13767b1803a4c31c40d896e9c08bc8a3}{mi\_unlikely}}(++heap-\/>generic\_count\ >=\ 1000)\ \{}
\DoxyCodeLine{00945\ \ \ \ \ heap-\/>generic\_collect\_count\ +=\ heap-\/>generic\_count;}
\DoxyCodeLine{00946\ \ \ \ \ heap-\/>generic\_count\ =\ 0;}
\DoxyCodeLine{00947\ \ \ \ \ \textcolor{comment}{//\ call\ potential\ deferred\ free\ routines}}
\DoxyCodeLine{00948\ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_aede81c520000cbb08ad669e096c94d51}{\_mi\_deferred\_free}}(heap,\ \textcolor{keyword}{false});}
\DoxyCodeLine{00949\ }
\DoxyCodeLine{00950\ \ \ \ \ \textcolor{comment}{//\ collect\ every\ once\ in\ a\ while\ (10000\ by\ default)}}
\DoxyCodeLine{00951\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{long}\ generic\_collect\ =\ \mbox{\hyperlink{group__options_ga96ad9c406338bd314cfe878cfc9bf723}{mi\_option\_get\_clamp}}(\mbox{\hyperlink{mimalloc_8h_acf0af9f50d2fca76b4e158d611bc930ba8b5815a577955fe8125f2b964f41ee7f}{mi\_option\_generic\_collect}},\ 1,\ 1000000L);}
\DoxyCodeLine{00952\ \ \ \ \ \textcolor{keywordflow}{if}\ (heap-\/>generic\_collect\_count\ >=\ generic\_collect)\ \{}
\DoxyCodeLine{00953\ \ \ \ \ \ \ heap-\/>generic\_collect\_count\ =\ 0;}
\DoxyCodeLine{00954\ \ \ \ \ \ \ \mbox{\hyperlink{group__heap_ga7922f7495cde30b1984d0e6072419298}{mi\_heap\_collect}}(heap,\ \textcolor{keyword}{false}\ \textcolor{comment}{/*\ force?\ */});}
\DoxyCodeLine{00955\ \ \ \ \ \}}
\DoxyCodeLine{00956\ \ \ \}}
\DoxyCodeLine{00957\ }
\DoxyCodeLine{00958\ \ \ \textcolor{comment}{//\ find\ (or\ allocate)\ a\ page\ of\ the\ right\ size}}
\DoxyCodeLine{00959\ \ \ \mbox{\hyperlink{types_8h_a98e3d539b4113aac496ebe3d379ebe5b}{mi\_page\_t}}*\ page\ =\ \mbox{\hyperlink{page_8c_aeaa06e36da1cb82dbf0f99e7742ecff8}{mi\_find\_page}}(heap,\ \mbox{\hyperlink{imgui__impl__opengl3__loader_8h_a3d1e3edfcf61ca2d831883e1afbad89e}{size}},\ huge\_alignment);}
\DoxyCodeLine{00960\ \ \ \textcolor{keywordflow}{if}\ \mbox{\hyperlink{bits_8h_a13767b1803a4c31c40d896e9c08bc8a3}{mi\_unlikely}}(page\ ==\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}})\ \{\ \textcolor{comment}{//\ first\ time\ out\ of\ memory,\ try\ to\ collect\ and\ retry\ the\ allocation\ once\ more}}
\DoxyCodeLine{00961\ \ \ \ \ \mbox{\hyperlink{group__heap_ga7922f7495cde30b1984d0e6072419298}{mi\_heap\_collect}}(heap,\ \textcolor{keyword}{true}\ \textcolor{comment}{/*\ force?\ */});}
\DoxyCodeLine{00962\ \ \ \ \ page\ =\ \mbox{\hyperlink{page_8c_aeaa06e36da1cb82dbf0f99e7742ecff8}{mi\_find\_page}}(heap,\ \mbox{\hyperlink{imgui__impl__opengl3__loader_8h_a3d1e3edfcf61ca2d831883e1afbad89e}{size}},\ huge\_alignment);}
\DoxyCodeLine{00963\ \ \ \}}
\DoxyCodeLine{00964\ }
\DoxyCodeLine{00965\ \ \ \textcolor{keywordflow}{if}\ \mbox{\hyperlink{bits_8h_a13767b1803a4c31c40d896e9c08bc8a3}{mi\_unlikely}}(page\ ==\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}})\ \{\ \textcolor{comment}{//\ out\ of\ memory}}
\DoxyCodeLine{00966\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ req\_size\ =\ \mbox{\hyperlink{imgui__impl__opengl3__loader_8h_a3d1e3edfcf61ca2d831883e1afbad89e}{size}}\ -\/\ \mbox{\hyperlink{types_8h_a425481b3d9ef67bde1f23889eb9db684}{MI\_PADDING\_SIZE}};\ \ \textcolor{comment}{//\ correct\ for\ padding\_size\ in\ case\ of\ an\ overflow\ on\ \`{}size`}}
\DoxyCodeLine{00967\ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2atomic_8h_a2bebc073bcaac71658e57bb260c2e426}{\_mi\_error\_message}}(\mbox{\hyperlink{types_8h_a6a05c923dad0c1208043e9c20a58c8e5}{ENOMEM}},\ \textcolor{stringliteral}{"{}unable\ to\ allocate\ memory\ (\%zu\ bytes)\(\backslash\)n"{}},\ req\_size);}
\DoxyCodeLine{00968\ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}};}
\DoxyCodeLine{00969\ \ \ \}}
\DoxyCodeLine{00970\ }
\DoxyCodeLine{00971\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a87596f606325115ec4f43046dfd3d64a}{mi\_page\_immediate\_available}}(page));}
\DoxyCodeLine{00972\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a6134893990c1f09da2b40092ceecc780}{mi\_page\_block\_size}}(page)\ >=\ \mbox{\hyperlink{imgui__impl__opengl3__loader_8h_a3d1e3edfcf61ca2d831883e1afbad89e}{size}});}
\DoxyCodeLine{00973\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ad446ae4d82cbdbd78dfbe46fa2330555}{\_mi\_is\_aligned}}(page,\ \mbox{\hyperlink{types_8h_a8781001af23da7ff83732bc42002f385}{MI\_PAGE\_ALIGN}}));}
\DoxyCodeLine{00974\ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(\mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_acd84a462a2045538d19ecc56e6cc29f6}{\_mi\_ptr\_page}}(page)==page);}
\DoxyCodeLine{00975\ }
\DoxyCodeLine{00976\ \ \ \textcolor{comment}{//\ and\ try\ again,\ this\ time\ succeeding!\ (i.e.\ this\ should\ never\ recurse\ through\ \_mi\_page\_malloc)}}
\DoxyCodeLine{00977\ \ \ \textcolor{keywordtype}{void}*\ \mbox{\hyperlink{main-override_8cpp_a117104b82864d3b23ec174af6d392709}{p}};}
\DoxyCodeLine{00978\ \ \ \textcolor{keywordflow}{if}\ \mbox{\hyperlink{bits_8h_a13767b1803a4c31c40d896e9c08bc8a3}{mi\_unlikely}}(zero\ \&\&\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_aebe1b18846bd3fc16de5b52cd2250bec}{mi\_page\_is\_huge}}(page))\ \{}
\DoxyCodeLine{00979\ \ \ \ \ \textcolor{comment}{//\ note:\ we\ cannot\ call\ \_mi\_page\_malloc\ with\ zeroing\ for\ huge\ blocks;\ we\ zero\ it\ afterwards\ in\ that\ case.}}
\DoxyCodeLine{00980\ \ \ \ \ \mbox{\hyperlink{main-override_8cpp_a117104b82864d3b23ec174af6d392709}{p}}\ =\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a97c32575c2b27f4dc75af2429c45819d}{\_mi\_page\_malloc}}(heap,\ page,\ \mbox{\hyperlink{imgui__impl__opengl3__loader_8h_a3d1e3edfcf61ca2d831883e1afbad89e}{size}});}
\DoxyCodeLine{00981\ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(\mbox{\hyperlink{main-override_8cpp_a117104b82864d3b23ec174af6d392709}{p}}\ !=\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}});}
\DoxyCodeLine{00982\ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_aa1d3beee9d492fc175ac2584e50fd8ea}{\_mi\_memzero\_aligned}}(\mbox{\hyperlink{main-override_8cpp_a117104b82864d3b23ec174af6d392709}{p}},\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_a432abca03d059a7d40d8d39617afc8f7}{mi\_page\_usable\_block\_size}}(page));}
\DoxyCodeLine{00983\ \ \ \}}
\DoxyCodeLine{00984\ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00985\ \ \ \ \ \mbox{\hyperlink{main-override_8cpp_a117104b82864d3b23ec174af6d392709}{p}}\ =\ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_afd278f60e743bee5d9df559422f3455b}{\_mi\_page\_malloc\_zero}}(heap,\ page,\ \mbox{\hyperlink{imgui__impl__opengl3__loader_8h_a3d1e3edfcf61ca2d831883e1afbad89e}{size}},\ zero);}
\DoxyCodeLine{00986\ \ \ \ \ \mbox{\hyperlink{_e_a_s_t_l_2packages_2mimalloc_2include_2mimalloc_2internal_8h_ac4a5dfa05acddb18f9bcc3d1505a5906}{mi\_assert\_internal}}(\mbox{\hyperlink{main-override_8cpp_a117104b82864d3b23ec174af6d392709}{p}}\ !=\ \mbox{\hyperlink{eabase_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}});}
\DoxyCodeLine{00987\ \ \ \}}
\DoxyCodeLine{00988\ \ \ \textcolor{comment}{//\ move\ singleton\ pages\ to\ the\ full\ queue}}
\DoxyCodeLine{00989\ \ \ \textcolor{keywordflow}{if}\ (page-\/>\mbox{\hyperlink{structmi__page__s_acf15d96ab2462c10365859158a84bb72}{reserved}}\ ==\ page-\/>\mbox{\hyperlink{structmi__page__s_ad1194a6cecba67ba2cf1952eb337968c}{used}})\ \{}
\DoxyCodeLine{00990\ \ \ \ \ \mbox{\hyperlink{page_8c_afb25978212749e522404ee1f2dd1a6d4}{mi\_page\_to\_full}}(page,\ \mbox{\hyperlink{page-queue_8c_a59942bb22e34833289b85a5c70d81f97}{mi\_page\_queue\_of}}(page));}
\DoxyCodeLine{00991\ \ \ \}}
\DoxyCodeLine{00992\ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{main-override_8cpp_a117104b82864d3b23ec174af6d392709}{p}};}
\DoxyCodeLine{00993\ \}}

\end{DoxyCode}
