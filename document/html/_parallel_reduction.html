<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>source: Parallel Reduction</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">source
   </div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="搜索" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- 制作者 Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('_parallel_reduction.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">载入中...</div>
<div class="SRStatus" id="Searching">搜索中...</div>
<div class="SRStatus" id="NoMatches">未找到</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Parallel Reduction</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>目录</h3>
<ul>
  <li class="level1">
    <a href="#ParallelReductionInclude">Include the Header</a>
  </li>
  <li class="level1">
    <a href="#A2ParallelReduction">Create a Parallel-Reduction Task</a>
  </li>
  <li class="level1">
    <a href="#ParallelReductionCaptureIteratorsByReference">Capture Iterators by Reference</a>
  </li>
  <li class="level1">
    <a href="#A2ParallelTransformationReduction">Create a Parallel-Transform-Reduction Task</a>
  </li>
  <li class="level1">
    <a href="#ParallelReductionCreateAReduceByIndexTask">Create a Reduce-by-Index Task</a>
  </li>
  <li class="level1">
    <a href="#ParallelReductionConfigureAPartitioner">Configure a Partitioner</a>
  </li>
</ul>
</div>
<div class="textblock"><p>Taskflow provides template function that constructs a task to perform parallel reduction over a range of items.</p>
<h1><a class="anchor" id="ParallelReductionInclude"></a>
Include the Header</h1>
<p>You need to include the header file, <code><a class="el" href="taskflow_2algorithm_2reduce_8hpp.html">taskflow/algorithm/reduce.hpp</a></code>, for creating a parallel-reduction task.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="taskflow_2algorithm_2reduce_8hpp.html">taskflow/algorithm/reduce.hpp</a>&gt;</span></div>
<div class="ttc" id="ataskflow_2algorithm_2reduce_8hpp_html"><div class="ttname"><a href="taskflow_2algorithm_2reduce_8hpp.html">reduce.hpp</a></div></div>
</div><!-- fragment --><h1><a class="anchor" id="A2ParallelReduction"></a>
Create a Parallel-Reduction Task</h1>
<p>The reduction task created by <a class="el" href="classtf_1_1_flow_builder.html#afb24798ebf46e253a40b01bffb1da6a7" title="constructs an STL-styled parallel-reduction task">tf::Taskflow::reduce(B first, E last, T&amp; result, O bop, P part)</a> performs parallel reduction over a range of elements specified by <code>[first, last)</code> using the binary operator <code>bop</code> and stores the reduced result in <code>result</code>. It represents the parallel execution of the following reduction loop:</p>
<div class="fragment"><div class="line"><span class="keywordflow">for</span>(<span class="keyword">auto</span> itr=first; itr&lt;last; itr++) {</div>
<div class="line">  <a class="code hl_typedef" href="imgui__impl__opengl3__loader_8h.html#aa7f56a70231ed8bc64f97aa7c37fcb19">result</a> = bop(<a class="code hl_typedef" href="imgui__impl__opengl3__loader_8h.html#aa7f56a70231ed8bc64f97aa7c37fcb19">result</a>, *itr);</div>
<div class="line">}</div>
<div class="ttc" id="aimgui__impl__opengl3__loader_8h_html_aa7f56a70231ed8bc64f97aa7c37fcb19"><div class="ttname"><a href="imgui__impl__opengl3__loader_8h.html#aa7f56a70231ed8bc64f97aa7c37fcb19">result</a></div><div class="ttdeci">GLuint GLuint64EXT * result</div><div class="ttdef"><b>定义</b> imgui_impl_opengl3_loader.h:446</div></div>
</div><!-- fragment --><p>At runtime, the reduction task spawns a subflow to perform parallel reduction. The reduced result is stored in <code>result</code> that will be captured by reference in the reduction task. It is your responsibility to ensure <code>result</code> remains alive during the parallel execution.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code hl_variable" href="test__parallel__for__each_8cpp.html#a539b07c7f86d3a9854ed81da50a4fb7d">sum</a> = 100;</div>
<div class="line">std::vector&lt;int&gt; <a class="code hl_variable" href="benchmarks_2for__each_2for__each_8hpp.html#ad86cbaae2e3f21959301250e9f7c2701">vec</a> = {1, 2, 3, 4, 5, 6, 7, 8, 9, 10};</div>
<div class="line"> </div>
<div class="line"><a class="code hl_class" href="classtf_1_1_task.html">tf::Task</a> <a class="code hl_define" href="test__partitioner__whitebox_8h.html#a5c4cf3d37a4eee22275de22cb9619863">task</a> = <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.reduce(<a class="code hl_variable" href="benchmarks_2for__each_2for__each_8hpp.html#ad86cbaae2e3f21959301250e9f7c2701">vec</a>.begin(), <a class="code hl_variable" href="benchmarks_2for__each_2for__each_8hpp.html#ad86cbaae2e3f21959301250e9f7c2701">vec</a>.end(), <a class="code hl_variable" href="test__parallel__for__each_8cpp.html#a539b07c7f86d3a9854ed81da50a4fb7d">sum</a>, </div>
<div class="line">  [] (<span class="keywordtype">int</span> l, <span class="keywordtype">int</span> <a class="code hl_variable" href="offscreen_8c.html#a4788d82c901b9367dd5c0daff8a7616b">r</a>) { return l + r; }  <span class="comment">// binary reducer operator</span></div>
<div class="line">);</div>
<div class="line"><a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.run(<a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>).wait();</div>
<div class="line"> </div>
<div class="line">assert(<a class="code hl_variable" href="test__parallel__for__each_8cpp.html#a539b07c7f86d3a9854ed81da50a4fb7d">sum</a> == 100 + 55);</div>
<div class="ttc" id="abenchmarks_2for__each_2for__each_8hpp_html_ad86cbaae2e3f21959301250e9f7c2701"><div class="ttname"><a href="benchmarks_2for__each_2for__each_8hpp.html#ad86cbaae2e3f21959301250e9f7c2701">vec</a></div><div class="ttdeci">std::vector&lt; double &gt; vec</div><div class="ttdef"><b>定义</b> for_each.hpp:14</div></div>
<div class="ttc" id="aclasstf_1_1_task_html"><div class="ttname"><a href="classtf_1_1_task.html">tf::Task</a></div><div class="ttdoc">class to create a task handle over a node in a taskflow graph</div><div class="ttdef"><b>定义</b> task.hpp:150</div></div>
<div class="ttc" id="aoffscreen_8c_html_a4788d82c901b9367dd5c0daff8a7616b"><div class="ttname"><a href="offscreen_8c.html#a4788d82c901b9367dd5c0daff8a7616b">r</a></div><div class="ttdeci">float r</div><div class="ttdef"><b>定义</b> offscreen.c:42</div></div>
<div class="ttc" id="apoisson_8hpp_html_aa56fe360bb0ae38e0082f49e394ff825"><div class="ttname"><a href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a></div><div class="ttdeci">void taskflow(int nx, int ny, double dx, double dy, double *f, int itold, int itnew, double *u, double *unew, int block_size, unsigned num_threads)</div><div class="ttdef"><b>定义</b> taskflow.cpp:6</div></div>
<div class="ttc" id="atest__parallel__for__each_8cpp_html_a539b07c7f86d3a9854ed81da50a4fb7d"><div class="ttname"><a href="test__parallel__for__each_8cpp.html#a539b07c7f86d3a9854ed81da50a4fb7d">sum</a></div><div class="ttdeci">tbb::atomic&lt; size_t &gt; sum</div><div class="ttdef"><b>定义</b> test_parallel_for_each.cpp:32</div></div>
<div class="ttc" id="atest__partitioner__whitebox_8h_html_a5c4cf3d37a4eee22275de22cb9619863"><div class="ttname"><a href="test__partitioner__whitebox_8h.html#a5c4cf3d37a4eee22275de22cb9619863">task</a></div><div class="ttdeci">#define task</div><div class="ttdef"><b>定义</b> test_partitioner_whitebox.h:76</div></div>
<div class="ttc" id="athread__pool_8cpp_html_a543e564a8407bbeac15cb2d929fec755"><div class="ttname"><a href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a></div><div class="ttdeci">tf::Executor executor</div><div class="ttdef"><b>定义</b> thread_pool.cpp:6</div></div>
</div><!-- fragment --><p>The order in which the binary operator is applied to pairs of elements is <em>unspecified</em>. In other words, the elements of the range may be grouped and rearranged in arbitrary order. The result and the argument types of the binary operator must be consistent with the input data type.</p>
<h1><a class="anchor" id="ParallelReductionCaptureIteratorsByReference"></a>
Capture Iterators by Reference</h1>
<p>You can pass iterators by reference using @std_ref to marshal parameter update between dependent tasks. This is especially useful when the range is unknown at the time of creating a parallel-reduction task, but needs initialization from another task.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code hl_variable" href="test__parallel__for__each_8cpp.html#a539b07c7f86d3a9854ed81da50a4fb7d">sum</a> = 100;</div>
<div class="line">std::vector&lt;int&gt; <a class="code hl_variable" href="benchmarks_2for__each_2for__each_8hpp.html#ad86cbaae2e3f21959301250e9f7c2701">vec</a>;</div>
<div class="line">std::vector&lt;int&gt;::iterator first, last;</div>
<div class="line"> </div>
<div class="line"><a class="code hl_class" href="classtf_1_1_task.html">tf::Task</a> <a class="code hl_struct" href="structinit.html">init</a> = <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.emplace([&amp;](){</div>
<div class="line">  <a class="code hl_variable" href="benchmarks_2for__each_2for__each_8hpp.html#ad86cbaae2e3f21959301250e9f7c2701">vec</a>   = {1, 2, 3, 4, 5, 6, 7, 8, 9, 10};</div>
<div class="line">  first = <a class="code hl_variable" href="benchmarks_2for__each_2for__each_8hpp.html#ad86cbaae2e3f21959301250e9f7c2701">vec</a>.begin();</div>
<div class="line">  last  = <a class="code hl_variable" href="benchmarks_2for__each_2for__each_8hpp.html#ad86cbaae2e3f21959301250e9f7c2701">vec</a>.end();</div>
<div class="line">});</div>
<div class="line"> </div>
<div class="line"><a class="code hl_class" href="classtf_1_1_task.html">tf::Task</a> <a class="code hl_define" href="test__partitioner__whitebox_8h.html#a5c4cf3d37a4eee22275de22cb9619863">task</a> = <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.reduce(std::ref(first), std::ref(last), <a class="code hl_variable" href="test__parallel__for__each_8cpp.html#a539b07c7f86d3a9854ed81da50a4fb7d">sum</a>, </div>
<div class="line">  [] (<span class="keywordtype">int</span> l, <span class="keywordtype">int</span> <a class="code hl_variable" href="offscreen_8c.html#a4788d82c901b9367dd5c0daff8a7616b">r</a>) { <span class="keywordflow">return</span> l + <a class="code hl_variable" href="offscreen_8c.html#a4788d82c901b9367dd5c0daff8a7616b">r</a>; }  <span class="comment">// binary reducer operator</span></div>
<div class="line">);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// wrong! must use std::ref, or first and last are captured by copy</span></div>
<div class="line"><span class="comment">// tf::Task task = taskflow.reduce(first, last, sum, [] (int l, int r) { </span></div>
<div class="line"><span class="comment">//   return l + r;    // binary reducer operator</span></div>
<div class="line"><span class="comment">// });</span></div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="boing_8c.html#a2858154e2009b0e6e616f313177762bc">init</a>.precede(<a class="code hl_define" href="test__partitioner__whitebox_8h.html#a5c4cf3d37a4eee22275de22cb9619863">task</a>);</div>
<div class="line"> </div>
<div class="line"><a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.<a class="code hl_function" href="classtf_1_1_executor.html#a519777f5783981d534e9e53b99712069">run</a>(<a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>).wait();</div>
<div class="line"> </div>
<div class="line">assert(<a class="code hl_variable" href="test__parallel__for__each_8cpp.html#a539b07c7f86d3a9854ed81da50a4fb7d">sum</a> == 100 + 55);</div>
<div class="ttc" id="aboing_8c_html_a2858154e2009b0e6e616f313177762bc"><div class="ttname"><a href="boing_8c.html#a2858154e2009b0e6e616f313177762bc">init</a></div><div class="ttdeci">void init(void)</div><div class="ttdef"><b>定义</b> boing.c:182</div></div>
<div class="ttc" id="aclasstf_1_1_executor_html_a519777f5783981d534e9e53b99712069"><div class="ttname"><a href="classtf_1_1_executor.html#a519777f5783981d534e9e53b99712069">tf::Executor::run</a></div><div class="ttdeci">tf::Future&lt; void &gt; run(Taskflow &amp;taskflow)</div><div class="ttdoc">runs a taskflow once</div><div class="ttdef"><b>定义</b> executor-dl.hpp:2067</div></div>
<div class="ttc" id="astructinit_html"><div class="ttname"><a href="structinit.html">init</a></div><div class="ttdef"><b>定义</b> TutorialInplaceLU.cpp:2</div></div>
</div><!-- fragment --><p>In the above example, when <code>init</code> finishes, <code>vec</code> has been initialized to 10 elements with <code>first</code> and <code>last</code> pointing to the data range of <code>vec</code>. The reduction task will then work on this initialized range as a result of passing iterators by reference.</p>
<h1><a class="anchor" id="A2ParallelTransformationReduction"></a>
Create a Parallel-Transform-Reduction Task</h1>
<p>It is common to transform each element into a new data type and then perform reduction on the transformed elements. Taskflow provides a method, <a class="el" href="classtf_1_1_flow_builder.html#aa62d24438c0860e76153ffd129deba41" title="constructs an STL-styled parallel transform-reduce task">tf::Taskflow::transform_reduce(B first, E last, T&amp; result, BOP bop, UOP uop, P part)</a>, that applies <code>uop</code> to transform each element in the specified range and then perform parallel reduction over <code>result</code> and transformed elements. It represents the parallel execution of the following reduction loop:</p>
<div class="fragment"><div class="line"><span class="keywordflow">for</span>(<span class="keyword">auto</span> itr=first; itr&lt;last; itr++) {</div>
<div class="line">  <a class="code hl_typedef" href="imgui__impl__opengl3__loader_8h.html#aa7f56a70231ed8bc64f97aa7c37fcb19">result</a> = bop(<a class="code hl_typedef" href="imgui__impl__opengl3__loader_8h.html#aa7f56a70231ed8bc64f97aa7c37fcb19">result</a>, uop(*itr));</div>
<div class="line">}</div>
</div><!-- fragment --><p>The example below transforms each digit in a string to an integer number and then sums up all integers in parallel.</p>
<div class="fragment"><div class="line">std::string str = <span class="stringliteral">&quot;12345678&quot;</span>;</div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_variable" href="test__parallel__for__each_8cpp.html#a539b07c7f86d3a9854ed81da50a4fb7d">sum</a> {0};</div>
<div class="line"><a class="code hl_class" href="classtf_1_1_task.html">tf::Task</a> <a class="code hl_define" href="test__partitioner__whitebox_8h.html#a5c4cf3d37a4eee22275de22cb9619863">task</a> = <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.transform_reduce(str.begin(), str.end(), <a class="code hl_variable" href="test__parallel__for__each_8cpp.html#a539b07c7f86d3a9854ed81da50a4fb7d">sum</a>,</div>
<div class="line">  [] (<span class="keywordtype">int</span> <a class="code hl_variable" href="_cwise__product_8cpp.html#ad2cbe4616e813eb9af81732dca777b24">a</a>, <span class="keywordtype">int</span> <a class="code hl_variable" href="offscreen_8c.html#a846c9667e34d56c560bb7f0ac6e173f6">b</a>) {      <span class="comment">// binary reduction operator</span></div>
<div class="line">    return a + b;</div>
<div class="line">  },  </div>
<div class="line">  [] (<span class="keywordtype">char</span> <a class="code hl_variable" href="bench_vec_add_8cpp.html#a41689956983587b085f9da3e48f31d99">c</a>) -&gt; <span class="keywordtype">int</span> {     <span class="comment">// unary transformation operator</span></div>
<div class="line">    return c - <span class="stringliteral">&#39;0&#39;</span>;</div>
<div class="line">  }   </div>
<div class="line">); </div>
<div class="line"><a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.run(<a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>).wait(); </div>
<div class="line">assert(<a class="code hl_variable" href="test__parallel__for__each_8cpp.html#a539b07c7f86d3a9854ed81da50a4fb7d">sum</a> == 1 + 2 + 3 + 4 + 5 + 6 + 7 + 8);  <span class="comment">// sum will be 36 </span></div>
<div class="ttc" id="a_cwise__product_8cpp_html_ad2cbe4616e813eb9af81732dca777b24"><div class="ttname"><a href="_cwise__product_8cpp.html#ad2cbe4616e813eb9af81732dca777b24">a</a></div><div class="ttdeci">Array33i a</div><div class="ttdef"><b>定义</b> Cwise_product.cpp:1</div></div>
<div class="ttc" id="abench_vec_add_8cpp_html_a41689956983587b085f9da3e48f31d99"><div class="ttname"><a href="bench_vec_add_8cpp.html#a41689956983587b085f9da3e48f31d99">c</a></div><div class="ttdeci">Scalar Scalar * c</div><div class="ttdef"><b>定义</b> benchVecAdd.cpp:17</div></div>
<div class="ttc" id="aoffscreen_8c_html_a846c9667e34d56c560bb7f0ac6e173f6"><div class="ttname"><a href="offscreen_8c.html#a846c9667e34d56c560bb7f0ac6e173f6">b</a></div><div class="ttdeci">float b</div><div class="ttdef"><b>定义</b> offscreen.c:42</div></div>
</div><!-- fragment --><p>The order in which we apply the binary operator on the transformed elements is <em>unspecified</em>. It is possible that the binary operator will take <em>r-value</em> in both arguments, for example, <code>bop(uop(*itr1), uop(*itr2))</code>, due to the transformed temporaries. When data passing is expensive, you may define the result type <code>T</code> to be move-constructible.</p>
<h1><a class="anchor" id="ParallelReductionCreateAReduceByIndexTask"></a>
Create a Reduce-by-Index Task</h1>
<p>Unlike <code><a class="el" href="classtf_1_1_flow_builder.html#afb24798ebf46e253a40b01bffb1da6a7" title="constructs an STL-styled parallel-reduction task">tf::Taskflow::reduce</a></code>, the <code><a class="el" href="classtf_1_1_flow_builder.html#a3ea810696c4b29824d1aaef15342c825" title="constructs an index range-based parallel-reduction task">tf::Taskflow::reduce_by_index</a></code> function lets you perform a parallel reduction over an index range, but with more control over how each part of the range is processed. This is useful when you need to customize the reduction process for each subrange or you want to incorporate optimizations like SIMD. The example below performs a sum-reduction over all elements in <code>data</code> with <code>res:</code> <br  />
</p>
<div class="fragment"><div class="line">std::vector&lt;double&gt; <a class="code hl_typedef" href="imgui__impl__opengl3__loader_8h.html#a02796e583e939f923a255e43d2c3b177">data</a>(100000);</div>
<div class="line"><span class="keywordtype">double</span> <a class="code hl_variable" href="_partial_redux__count_8cpp.html#acbe60897559b79afc28b79b0687b5f29">res</a> = 1.0;</div>
<div class="line"><a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.reduce_by_index(</div>
<div class="line">  <span class="comment">// index range</span></div>
<div class="line">  <a class="code hl_class" href="classtf_1_1_index_range.html">tf::IndexRange&lt;size_t&gt;</a>(0, <a class="code hl_define" href="main-override-static_8c.html#a0240ac851181b84ac374872dc5434ee4">N</a>, 1),</div>
<div class="line">  <span class="comment">// final result</span></div>
<div class="line">  <a class="code hl_variable" href="_partial_redux__count_8cpp.html#acbe60897559b79afc28b79b0687b5f29">res</a>,</div>
<div class="line">  <span class="comment">// local reducer</span></div>
<div class="line">  [&amp;](<a class="code hl_class" href="classtf_1_1_index_range.html">tf::IndexRange&lt;size_t&gt;</a> subrange, std::optional&lt;double&gt; running_total) { </div>
<div class="line">    <span class="keywordtype">double</span> residual = running_total ? *running_total : 0.0;</div>
<div class="line">    <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> <a class="code hl_variable" href="_bi_c_g_s_t_a_b__step__by__step_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a>=subrange.<a class="code hl_function" href="classtf_1_1_index_range.html#a2b52381358ab392efa257e185a33d4af">begin</a>(); <a class="code hl_variable" href="_bi_c_g_s_t_a_b__step__by__step_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;subrange.<a class="code hl_function" href="classtf_1_1_index_range.html#a280096cb4056bc19b86da77d019434e4">end</a>(); <a class="code hl_variable" href="_bi_c_g_s_t_a_b__step__by__step_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a>+=subrange.<a class="code hl_function" href="classtf_1_1_index_range.html#aafd4f2d04614e550649cd9b7912e0bf1">step_size</a>()) {</div>
<div class="line">      <a class="code hl_typedef" href="imgui__impl__opengl3__loader_8h.html#a02796e583e939f923a255e43d2c3b177">data</a>[<a class="code hl_variable" href="_bi_c_g_s_t_a_b__step__by__step_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a>] = 1.0;        <span class="comment">// we initialize the data here</span></div>
<div class="line">      residual += <a class="code hl_typedef" href="imgui__impl__opengl3__loader_8h.html#a02796e583e939f923a255e43d2c3b177">data</a>[<a class="code hl_variable" href="_bi_c_g_s_t_a_b__step__by__step_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a>];</div>
<div class="line">    }</div>
<div class="line">    <a class="code hl_function" href="printf_8h.html#aee3ed3a831f25f07e7be3919fff2203a">printf</a>(<span class="stringliteral">&quot;partial sum = %lf\n&quot;</span>, residual);</div>
<div class="line">    <span class="keywordflow">return</span> residual;</div>
<div class="line">  },</div>
<div class="line">  <span class="comment">// global reducer</span></div>
<div class="line">  std::plus&lt;double&gt;()</div>
<div class="line">);</div>
<div class="line"> </div>
<div class="line"><a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.run(<a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>).wait();</div>
<div class="line">assert(<a class="code hl_variable" href="_partial_redux__count_8cpp.html#acbe60897559b79afc28b79b0687b5f29">res</a> == 100001);</div>
<div class="ttc" id="a_bi_c_g_s_t_a_b__step__by__step_8cpp_html_acb559820d9ca11295b4500f179ef6392"><div class="ttname"><a href="_bi_c_g_s_t_a_b__step__by__step_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a></div><div class="ttdeci">int i</div><div class="ttdef"><b>定义</b> BiCGSTAB_step_by_step.cpp:9</div></div>
<div class="ttc" id="a_partial_redux__count_8cpp_html_acbe60897559b79afc28b79b0687b5f29"><div class="ttname"><a href="_partial_redux__count_8cpp.html#acbe60897559b79afc28b79b0687b5f29">res</a></div><div class="ttdeci">cout&lt;&lt; &quot;Here is the matrix m:&quot;&lt;&lt; endl&lt;&lt; m&lt;&lt; endl;Matrix&lt; ptrdiff_t, 3, 1 &gt; res</div><div class="ttdef"><b>定义</b> PartialRedux_count.cpp:3</div></div>
<div class="ttc" id="aclasstf_1_1_index_range_html"><div class="ttname"><a href="classtf_1_1_index_range.html">tf::IndexRange</a></div><div class="ttdoc">class to create an index range of integral indices with a step size</div><div class="ttdef"><b>定义</b> iterator.hpp:98</div></div>
<div class="ttc" id="aclasstf_1_1_index_range_html_a280096cb4056bc19b86da77d019434e4"><div class="ttname"><a href="classtf_1_1_index_range.html#a280096cb4056bc19b86da77d019434e4">tf::IndexRange::end</a></div><div class="ttdeci">T end() const</div><div class="ttdoc">queries the ending index of the range</div><div class="ttdef"><b>定义</b> iterator.hpp:131</div></div>
<div class="ttc" id="aclasstf_1_1_index_range_html_a2b52381358ab392efa257e185a33d4af"><div class="ttname"><a href="classtf_1_1_index_range.html#a2b52381358ab392efa257e185a33d4af">tf::IndexRange::begin</a></div><div class="ttdeci">T begin() const</div><div class="ttdoc">queries the starting index of the range</div><div class="ttdef"><b>定义</b> iterator.hpp:126</div></div>
<div class="ttc" id="aclasstf_1_1_index_range_html_aafd4f2d04614e550649cd9b7912e0bf1"><div class="ttname"><a href="classtf_1_1_index_range.html#aafd4f2d04614e550649cd9b7912e0bf1">tf::IndexRange::step_size</a></div><div class="ttdeci">T step_size() const</div><div class="ttdoc">queries the step size of the range</div><div class="ttdef"><b>定义</b> iterator.hpp:136</div></div>
<div class="ttc" id="aimgui__impl__opengl3__loader_8h_html_a02796e583e939f923a255e43d2c3b177"><div class="ttname"><a href="imgui__impl__opengl3__loader_8h.html#a02796e583e939f923a255e43d2c3b177">data</a></div><div class="ttdeci">GLint * data</div><div class="ttdef"><b>定义</b> imgui_impl_opengl3_loader.h:199</div></div>
<div class="ttc" id="amain-override-static_8c_html_a0240ac851181b84ac374872dc5434ee4"><div class="ttname"><a href="main-override-static_8c.html#a0240ac851181b84ac374872dc5434ee4">N</a></div><div class="ttdeci">#define N</div><div class="ttdef"><b>定义</b> main-override-static.c:141</div></div>
<div class="ttc" id="aprintf_8h_html_aee3ed3a831f25f07e7be3919fff2203a"><div class="ttname"><a href="printf_8h.html#aee3ed3a831f25f07e7be3919fff2203a">printf</a></div><div class="ttdeci">auto printf(string_view fmt, const T &amp;... args) -&gt; int</div><div class="ttdef"><b>定义</b> printf.h:621</div></div>
</div><!-- fragment --><p>The local reducer <code>lop</code> computes a partial sum for each subrange, and the global reducer <code>gop</code> combines the partial results into the final result and store it in <code>res</code>, whose initial value (i.e., <code>1.0</code> here) also participates in the reduction process. The second argument of the local reducer is a @std_optional type, which indicates the current partial sum until this subrange. Apparently, the first subrange does not have any partial sum since there is no running total from previous subranges (i.e., <code>running_total</code> is @std_nullopt).</p>
<h1><a class="anchor" id="ParallelReductionConfigureAPartitioner"></a>
Configure a Partitioner</h1>
<p>You can configure a partitioner for parallel-reduction tasks to run with different scheduling methods, such as guided partitioning, dynamic partitioning, and static partitioning. The following example creates two parallel-reduction tasks using two different partitioners, one with the static partitioning algorithm and another one with the guided partitioning algorithm:</p>
<div class="fragment"><div class="line"><a class="code hl_class" href="classtf_1_1_static_partitioner.html">tf::StaticPartitioner</a> static_partitioner;</div>
<div class="line"><a class="code hl_class" href="classtf_1_1_guided_partitioner.html">tf::GuidedPartitioner</a> guided_partitioner;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> sum1 = 100, sum2 = 100;</div>
<div class="line">std::vector&lt;int&gt; <a class="code hl_variable" href="benchmarks_2for__each_2for__each_8hpp.html#ad86cbaae2e3f21959301250e9f7c2701">vec</a> = {1, 2, 3, 4, 5, 6, 7, 8, 9, 10};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// create a parallel-reduction task with static partitioner</span></div>
<div class="line"><a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.reduce(<a class="code hl_variable" href="benchmarks_2for__each_2for__each_8hpp.html#ad86cbaae2e3f21959301250e9f7c2701">vec</a>.begin(), <a class="code hl_variable" href="benchmarks_2for__each_2for__each_8hpp.html#ad86cbaae2e3f21959301250e9f7c2701">vec</a>.end(), sum1, </div>
<div class="line">  [] (<span class="keywordtype">int</span> l, <span class="keywordtype">int</span> <a class="code hl_variable" href="offscreen_8c.html#a4788d82c901b9367dd5c0daff8a7616b">r</a>) { return l + r; },</div>
<div class="line">  static_partitioner</div>
<div class="line">);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// create a parallel-reduction task with guided partitioner</span></div>
<div class="line"><a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.reduce(<a class="code hl_variable" href="benchmarks_2for__each_2for__each_8hpp.html#ad86cbaae2e3f21959301250e9f7c2701">vec</a>.begin(), <a class="code hl_variable" href="benchmarks_2for__each_2for__each_8hpp.html#ad86cbaae2e3f21959301250e9f7c2701">vec</a>.end(), sum2, </div>
<div class="line">  [] (<span class="keywordtype">int</span> l, <span class="keywordtype">int</span> <a class="code hl_variable" href="offscreen_8c.html#a4788d82c901b9367dd5c0daff8a7616b">r</a>) { return l + r; },</div>
<div class="line">  guided_partitioner</div>
<div class="line">);</div>
<div class="ttc" id="aclasstf_1_1_guided_partitioner_html"><div class="ttname"><a href="classtf_1_1_guided_partitioner.html">tf::GuidedPartitioner</a></div><div class="ttdoc">class to construct a guided partitioner for scheduling parallel algorithms</div><div class="ttdef"><b>定义</b> partitioner.hpp:259</div></div>
<div class="ttc" id="aclasstf_1_1_static_partitioner_html"><div class="ttname"><a href="classtf_1_1_static_partitioner.html">tf::StaticPartitioner</a></div><div class="ttdoc">class to construct a static partitioner for scheduling parallel algorithms</div><div class="ttdef"><b>定义</b> partitioner.hpp:560</div></div>
</div><!-- fragment --><dl class="section attention"><dt>注意</dt><dd>By default, parallel-reduction tasks use <a class="el" href="namespacetf.html#ace2c5adcd5039483eebb6dbdbb6f33e3" title="default partitioner set to tf::GuidedPartitioner">tf::DefaultPartitioner</a> if no partitioner is specified. </dd></dl>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">制作者 <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
