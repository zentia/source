<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>source: runtime/EASTL/packages/mimalloc/bin 目录参考</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">source
   </div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="搜索" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- 制作者 Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('dir_163d6e220634c8ea619389189518aef1.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">载入中...</div>
<div class="SRStatus" id="Searching">搜索中...</div>
<div class="SRStatus" id="NoMatches">未找到</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">bin 目录参考</div></div>
</div><!--header-->
<div class="contents">
<div class="dynheader">
bin 的目录依赖关系图</div>
<div class="dyncontent">
<div class="center"><img src="dir_163d6e220634c8ea619389189518aef1_dep.png" border="0" usemap="#adir__163d6e220634c8ea619389189518aef1__dep" alt="runtime/EASTL/packages/mimalloc/bin"/></div>
<!-- MAP 0 -->
</div>
<a name="details" id="details"></a><h2 class="groupheader">详细描述</h2>
<p><span id="override_on_windows">We use a separate redirection DLL to override mimalloc on Windows</span> such that we redirect all malloc/free calls that go through the (dynamic) C runtime allocator, including those from other DLL's or libraries. As it intercepts all allocation calls on a low level, it can be used on large programs that include other 3rd party components. There are four requirements to make the overriding work well:</p>
<ol type="1">
<li>Use the C-runtime library as a DLL (using the <code>/MD</code> or <code>/MDd</code> switch).</li>
<li>Link your program explicitly with the <code>mimalloc.dll.lib</code> export library for the <code>mimalloc.dll</code> &ndash; which contains all mimalloc functionality. To ensure the <code>mimalloc.dll</code> is actually loaded at run-time it is easiest to insert some call to the mimalloc API in the <code>main</code> function, like <code><a class="el" href="mimalloc_8h.html#a906d3e6d7f3e9cf284134c7d23d965e7">mi_version()</a></code> (or use the <code>/include:mi_version</code> switch on the linker, or similarly, <code>#pragma comment(linker, "/include:mi_version")</code> in some source file). See the <code>mimalloc-test-override</code> project for an example on how to use this.</li>
<li>The <code>mimalloc-redirect.dll</code> must be put in the same folder as the main <code>mimalloc.dll</code> at runtime (as it is a dependency of that DLL). The redirection DLL ensures that all calls to the C runtime malloc API get redirected to mimalloc functions (which reside in <code>mimalloc.dll</code>).</li>
<li>Ensure the <code>mimalloc.dll</code> comes as early as possible in the import list of the final executable (so it can intercept all potential allocations). You can use <code>minject -l &lt;exe&gt;</code> to check this if needed.</li>
</ol>
<div class="fragment"><div class="line">┌──────────────┐                                                    </div>
<div class="line">│ Your Program │                                                    </div>
<div class="line">└────┬─────────┘                                                    </div>
<div class="line">     │                                                              </div>
<div class="line">     │ <a class="code hl_function" href="mimalloc_8h.html#a906d3e6d7f3e9cf284134c7d23d965e7">mi_version</a>()  ┌───────────────┐     ┌───────────────────────┐</div>
<div class="line">     ├──────────────►│ mimalloc.dll  ├────►│ mimalloc-redirect.dll │</div>
<div class="line">     │               └──────┬────────┘     └───────────────────────┘</div>
<div class="line">     │                      ▼                                       </div>
<div class="line">     │ <a class="code hl_define" href="mimalloc-override_8h.html#a99aa8fd9f4831e1b0fa9e1cdcde3e249">malloc</a>() etc. ┌──────────────┐                               </div>
<div class="line">     ├──────────────►│ ucrtbase.dll │                               </div>
<div class="line">     │               └──────────────┘                               </div>
<div class="line">     │                                                              </div>
<div class="line">     │                                                              </div>
<div class="line">     └──────────────► ...                                           </div>
<div class="ttc" id="amimalloc-override_8h_html_a99aa8fd9f4831e1b0fa9e1cdcde3e249"><div class="ttname"><a href="mimalloc-override_8h.html#a99aa8fd9f4831e1b0fa9e1cdcde3e249">malloc</a></div><div class="ttdeci">#define malloc(n)</div><div class="ttdef"><b>定义</b> mimalloc-override.h:21</div></div>
<div class="ttc" id="amimalloc_8h_html_a906d3e6d7f3e9cf284134c7d23d965e7"><div class="ttname"><a href="mimalloc_8h.html#a906d3e6d7f3e9cf284134c7d23d965e7">mi_version</a></div><div class="ttdeci">mi_decl_export int mi_version(void) mi_attr_noexcept</div><div class="ttdef"><b>定义</b> options.c:22</div></div>
</div><!-- fragment --><p>For best performance on Windows with C++, it is also recommended to also override the <code>new</code>/<code>delete</code> operations (by including <a href="../include/mimalloc-new-delete.h"><code>mimalloc-new-delete.h</code></a> a single(!) source file in your project).</p>
<p>The environment variable <code>MIMALLOC_DISABLE_REDIRECT=1</code> can be used to disable dynamic overriding at run-time. Use <code>MIMALLOC_VERBOSE=1</code> to check if mimalloc was successfully redirected.</p>
<h2><a class="anchor" id="autotoc_md14"></a>
Other Platforms</h2>
<p>You always link with <code>mimalloc.dll</code> but for different platforms you may need a specific redirection DLL:</p>
<ul>
<li><b>x64</b>: <code>mimalloc-redirect.dll</code>.</li>
<li><b>x86</b>: <code>mimalloc-redirect32.dll</code>. Use for older 32-bit Windows programs.</li>
<li><b>arm64</b>: <code>mimalloc-redirect-arm64.dll</code>. Use for native Windows arm64 programs.</li>
<li><b>arm64ec</b>: <code>mimalloc-redirect-arm64ec.dll</code>. The <a href="https://learn.microsoft.com/en-us/windows/arm/arm64ec">arm64ec</a> ABI is "emulation compatible" mode on Windows arm64. Unfortunately we cannot run x64 code emulated on Windows arm64 with the x64 mimalloc override directly (since the C runtime always uses <code>arm64ec</code>). Instead:<ol type="1">
<li>Build the program as normal for x64 and link as normal with the x64 <code>mimalloc.dll.lib</code> export library.</li>
<li>Now separately build <code>mimalloc.dll</code> in <code>arm64ec</code> mode and <em>overwrite</em> your previous (x64) <code>mimalloc.dll</code> &ndash; the loader can handle the mix of arm64ec and x64 code. Now use <code>mimalloc-redirect-arm64ec.dll</code> to match your new arm64ec <code>mimalloc.dll</code>. The main program stays as is and can be fully x64 or contain more arm64ec modules. At runtime, the arm64ec <code>mimalloc.dll</code> will run with native arm64 instructions while the rest of the program runs emulated x64.</li>
</ol>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md15"></a>
Minject</h2>
<p>We cannot always re-link an executable with <code>mimalloc.dll</code>, and similarly, we cannot always ensure that the DLL comes first in the import table of the final executable. In many cases though we can patch existing executables without any recompilation if they are linked with the dynamic C runtime (<code>ucrtbase.dll</code>) &ndash; just put the <code>mimalloc.dll</code> into the import table (and put <code>mimalloc-redirect.dll</code> in the same directory) Such patching can be done for example with <a href="https://ntcore.com/?page_id=388">CFF Explorer</a>.</p>
<p>The <code>minject</code> program can also do this from the command line Use <code>minject --help</code> for options:</p>
<div class="fragment"><div class="line">&gt; minject --help</div>
<div class="line"> </div>
<div class="line">minject:</div>
<div class="line">  Injects the mimalloc dll into the import table of a 64-bit executable,</div>
<div class="line">  and/or ensures that it comes first in het import table.</div>
<div class="line"> </div>
<div class="line">usage:</div>
<div class="line">  &gt; minject [options] &lt;exe&gt;</div>
<div class="line"> </div>
<div class="line">options:</div>
<div class="line">  -h   --help        show this help</div>
<div class="line">  -v   --verbose     be verbose</div>
<div class="line">  -l   --list        only list imported modules</div>
<div class="line">  -i   --inplace     update the exe in-place (make sure there is a backup!)</div>
<div class="line">  -f   --force       always overwrite without prompting</div>
<div class="line">       --postfix=&lt;p&gt; use &lt;p&gt; as a postfix to the mimalloc dll.</div>
<div class="line">                     e.g. use --postfix=debug to link with mimalloc-debug.dll</div>
<div class="line"> </div>
<div class="line">notes:</div>
<div class="line">  Without &#39;--inplace&#39; an injected &lt;exe&gt; is generated with the same name ending in &#39;-mi&#39;.</div>
<div class="line">  Ensure &#39;mimalloc-redirect.dll&#39; is in the same folder as the mimalloc dll.</div>
<div class="line"> </div>
<div class="line">examples:</div>
<div class="line">  &gt; minject --list myprogram.exe</div>
<div class="line">  &gt; minject --force --inplace myprogram.exe</div>
</div><!-- fragment --><p>For x86 32-bit binaries, use <code>minject32</code>, and for arm64 binaries use <code>minject-arm64</code>. </p>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_cb031e414f281a658b23dddb30bb9d2c.html">runtime</a></li><li class="navelem"><a class="el" href="dir_46d996951237f3a811adda0775610b84.html">EASTL</a></li><li class="navelem"><a class="el" href="dir_cc5c4d973dd7a361701cc063f2c02cbc.html">packages</a></li><li class="navelem"><a class="el" href="dir_691f6eadf0c45e432f8d026d7affe530.html">mimalloc</a></li><li class="navelem"><a class="el" href="dir_163d6e220634c8ea619389189518aef1.html">bin</a></li>
    <li class="footer">制作者 <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
