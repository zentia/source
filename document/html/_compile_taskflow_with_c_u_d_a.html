<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>source: Compile Taskflow with CUDA</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">source
   </div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="搜索" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- 制作者 Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('_compile_taskflow_with_c_u_d_a.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">载入中...</div>
<div class="SRStatus" id="Searching">搜索中...</div>
<div class="SRStatus" id="NoMatches">未找到</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Compile Taskflow with CUDA</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>目录</h3>
<ul>
  <li class="level1">
    <a href="#InstallCUDACompiler">Install CUDA Compiler</a>
  </li>
  <li class="level1">
    <a href="#CompileTaskflowWithCUDADirectly">Compile Source Code Directly</a>
  </li>
  <li class="level1">
    <a href="#CompileTaskflowWithCUDASeparately">Compile Source Code Separately</a>
    <ul>
      <li class="level2">
        <a href="#CompileTaskflowWithCUDANaiveLinking">Link Objects Using nvcc</a>
      </li>
      <li class="level2">
        <a href="#CompileTaskflowWithCUDADifferentLinkers">Link Objects Using Different Linkers</a>
      </li>
    </ul>
  </li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="InstallCUDACompiler"></a>
Install CUDA Compiler</h1>
<p>To compile Taskflow with CUDA code, you need a <code>nvcc</code> compiler. Please visit the official page of <a href="https://developer.nvidia.com/cuda-downloads">Downloading CUDA Toolkit</a>.</p>
<h1><a class="anchor" id="CompileTaskflowWithCUDADirectly"></a>
Compile Source Code Directly</h1>
<p>Taskflow's GPU programming interface for CUDA is <a class="el" href="classtf_1_1cuda_flow.html" title="class to create a cudaFlow task dependency graph">tf::cudaFlow</a>. Consider the following <code>simple.cu</code> program that launches a single kernel function to output a message:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="taskflow_8hpp.html">taskflow/taskflow.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;taskflow/cudaflow.hpp&gt;</span>  </div>
<div class="line"><span class="preprocessor">#include &lt;taskflow/cuda/for_each.hpp&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="main-override-static_8c.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>(<span class="keywordtype">int</span> argc, <span class="keyword">const</span> <span class="keywordtype">char</span>** argv) {</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_class" href="classtf_1_1_executor.html">tf::Executor</a> <a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>;</div>
<div class="line">  <a class="code hl_class" href="classtf_1_1_taskflow.html">tf::Taskflow</a> <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>;</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_class" href="classtf_1_1_task.html">tf::Task</a> task1 = <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.emplace([](){}).<a class="code hl_typedef" href="imgui__impl__opengl3__loader_8h.html#aab18cfce5ee7c6881ae04f18be70d94a">name</a>(<span class="stringliteral">&quot;cpu task&quot;</span>);</div>
<div class="line">  <a class="code hl_class" href="classtf_1_1_task.html">tf::Task</a> task2 = <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.emplace([](){</div>
<div class="line">    <span class="comment">// create a cudaFlow of a single-threaded task</span></div>
<div class="line">    <a class="code hl_class" href="classtf_1_1cuda_flow.html">tf::cudaFlow</a> cf;</div>
<div class="line">    cf.<a class="code hl_function" href="classtf_1_1cuda_flow.html#ac2906cb0002fc411a983d100a3d58d62">single_task</a>([] __device__ () { <a class="code hl_function" href="printf_8h.html#aee3ed3a831f25f07e7be3919fff2203a">printf</a>(<span class="stringliteral">&quot;hello cudaFlow!\n&quot;</span>); });</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// launch the cudaflow through a stream</span></div>
<div class="line">    <a class="code hl_typedef" href="namespacetf.html#af19c9b301dc0b0fe2a51a960fa427e83">tf::cudaStream</a> stream;</div>
<div class="line">    cf.run(stream);</div>
<div class="line">    stream.<a class="code hl_function" href="classtf_1_1cuda_stream_base.html#a08857ff2874cd5378e578822e2e96dd0">synchronize</a>();</div>
<div class="line">  }).<a class="code hl_typedef" href="imgui__impl__opengl3__loader_8h.html#aab18cfce5ee7c6881ae04f18be70d94a">name</a>(<span class="stringliteral">&quot;gpu task&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  task1.<a class="code hl_function" href="classtf_1_1_task.html#a8c78c453295a553c1c016e4062da8588">precede</a>(task2);</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.<a class="code hl_function" href="classtf_1_1_executor.html#a519777f5783981d534e9e53b99712069">run</a>(<a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>).wait();</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="aclasstf_1_1_executor_html"><div class="ttname"><a href="classtf_1_1_executor.html">tf::Executor</a></div><div class="ttdoc">class to create an executor for running a taskflow graph</div><div class="ttdef"><b>定义</b> executor-dl.hpp:51</div></div>
<div class="ttc" id="aclasstf_1_1_executor_html_a519777f5783981d534e9e53b99712069"><div class="ttname"><a href="classtf_1_1_executor.html#a519777f5783981d534e9e53b99712069">tf::Executor::run</a></div><div class="ttdeci">tf::Future&lt; void &gt; run(Taskflow &amp;taskflow)</div><div class="ttdoc">runs a taskflow once</div><div class="ttdef"><b>定义</b> executor-dl.hpp:2067</div></div>
<div class="ttc" id="aclasstf_1_1_task_html"><div class="ttname"><a href="classtf_1_1_task.html">tf::Task</a></div><div class="ttdoc">class to create a task handle over a node in a taskflow graph</div><div class="ttdef"><b>定义</b> task.hpp:150</div></div>
<div class="ttc" id="aclasstf_1_1_task_html_a8c78c453295a553c1c016e4062da8588"><div class="ttname"><a href="classtf_1_1_task.html#a8c78c453295a553c1c016e4062da8588">tf::Task::precede</a></div><div class="ttdeci">Task &amp; precede(Ts &amp;&amp;... tasks)</div><div class="ttdoc">adds precedence links from this to other tasks</div><div class="ttdef"><b>定义</b> task.hpp:394</div></div>
<div class="ttc" id="aclasstf_1_1_taskflow_html"><div class="ttname"><a href="classtf_1_1_taskflow.html">tf::Taskflow</a></div><div class="ttdoc">class to create a taskflow object</div><div class="ttdef"><b>定义</b> taskflow.hpp:67</div></div>
<div class="ttc" id="aclasstf_1_1cuda_flow_html"><div class="ttname"><a href="classtf_1_1cuda_flow.html">tf::cudaFlow</a></div><div class="ttdoc">class to create a cudaFlow task dependency graph</div><div class="ttdef"><b>定义</b> cudaflow.hpp:51</div></div>
<div class="ttc" id="aclasstf_1_1cuda_flow_html_ac2906cb0002fc411a983d100a3d58d62"><div class="ttname"><a href="classtf_1_1cuda_flow.html#ac2906cb0002fc411a983d100a3d58d62">tf::cudaFlow::single_task</a></div><div class="ttdeci">cudaTask single_task(C c)</div><div class="ttdoc">runs a callable with only a single kernel thread</div><div class="ttdef"><b>定义</b> for_each.hpp:163</div></div>
<div class="ttc" id="aclasstf_1_1cuda_stream_base_html_a08857ff2874cd5378e578822e2e96dd0"><div class="ttname"><a href="classtf_1_1cuda_stream_base.html#a08857ff2874cd5378e578822e2e96dd0">tf::cudaStreamBase::synchronize</a></div><div class="ttdeci">void synchronize() const</div><div class="ttdoc">synchronizes the associated stream</div><div class="ttdef"><b>定义</b> cuda_stream.hpp:212</div></div>
<div class="ttc" id="aimgui__impl__opengl3__loader_8h_html_aab18cfce5ee7c6881ae04f18be70d94a"><div class="ttname"><a href="imgui__impl__opengl3__loader_8h.html#aab18cfce5ee7c6881ae04f18be70d94a">name</a></div><div class="ttdeci">const GLchar * name</div><div class="ttdef"><b>定义</b> imgui_impl_opengl3_loader.h:312</div></div>
<div class="ttc" id="amain-override-static_8c_html_ae66f6b31b5ad750f1fe042a706a4e3d4"><div class="ttname"><a href="main-override-static_8c.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a></div><div class="ttdeci">int main()</div><div class="ttdef"><b>定义</b> main-override-static.c:32</div></div>
<div class="ttc" id="anamespacetf_html_af19c9b301dc0b0fe2a51a960fa427e83"><div class="ttname"><a href="namespacetf.html#af19c9b301dc0b0fe2a51a960fa427e83">tf::cudaStream</a></div><div class="ttdeci">cudaStreamBase&lt; cudaStreamCreator, cudaStreamDeleter &gt; cudaStream</div><div class="ttdoc">default smart pointer type to manage a cudaStream_t object with unique ownership</div><div class="ttdef"><b>定义</b> cuda_stream.hpp:299</div></div>
<div class="ttc" id="apoisson_8hpp_html_aa56fe360bb0ae38e0082f49e394ff825"><div class="ttname"><a href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a></div><div class="ttdeci">void taskflow(int nx, int ny, double dx, double dy, double *f, int itold, int itnew, double *u, double *unew, int block_size, unsigned num_threads)</div><div class="ttdef"><b>定义</b> taskflow.cpp:6</div></div>
<div class="ttc" id="aprintf_8h_html_aee3ed3a831f25f07e7be3919fff2203a"><div class="ttname"><a href="printf_8h.html#aee3ed3a831f25f07e7be3919fff2203a">printf</a></div><div class="ttdeci">auto printf(string_view fmt, const T &amp;... args) -&gt; int</div><div class="ttdef"><b>定义</b> printf.h:621</div></div>
<div class="ttc" id="ataskflow_8hpp_html"><div class="ttname"><a href="taskflow_8hpp.html">taskflow.hpp</a></div><div class="ttdoc">main taskflow include file</div></div>
<div class="ttc" id="athread__pool_8cpp_html_a543e564a8407bbeac15cb2d929fec755"><div class="ttname"><a href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a></div><div class="ttdeci">tf::Executor executor</div><div class="ttdef"><b>定义</b> thread_pool.cpp:6</div></div>
</div><!-- fragment --><p>The easiest way to compile Taskflow with CUDA code (e.g., cudaFlow, kernels) is to use @nvcc:</p>
<div class="fragment"><div class="line">{.shell-session} </div>
<div class="line">~$ nvcc -<a class="code hl_namespace" href="namespacestd.html">std</a>=<a class="code hl_variable" href="bench_vec_add_8cpp.html#a41689956983587b085f9da3e48f31d99">c</a>++17 -I <a class="code hl_variable" href="ittnotify__static_8h.html#a7016119bc831a22d1a351d56128518ed">path</a>/to/<a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>/ --extended-<a class="code hl_define" href="sugar_8h.html#aa2bc5aa57d417f3226228d9058ab9f20">lambda</a> simple.cu -o simple</div>
<div class="line">~$ ./simple</div>
<div class="line">hello cudaFlow!</div>
<div class="ttc" id="abench_vec_add_8cpp_html_a41689956983587b085f9da3e48f31d99"><div class="ttname"><a href="bench_vec_add_8cpp.html#a41689956983587b085f9da3e48f31d99">c</a></div><div class="ttdeci">Scalar Scalar * c</div><div class="ttdef"><b>定义</b> benchVecAdd.cpp:17</div></div>
<div class="ttc" id="aittnotify__static_8h_html_a7016119bc831a22d1a351d56128518ed"><div class="ttname"><a href="ittnotify__static_8h.html#a7016119bc831a22d1a351d56128518ed">path</a></div><div class="ttdeci">void const char const char int ITT_FORMAT __itt_group_sync x void const char ITT_FORMAT __itt_group_sync s void ITT_FORMAT __itt_group_sync p void ITT_FORMAT p void ITT_FORMAT p no args __itt_suppress_mode_t unsigned int void size_t ITT_FORMAT d void ITT_FORMAT p void ITT_FORMAT p __itt_model_site __itt_model_site_instance ITT_FORMAT p __itt_model_task __itt_model_task_instance ITT_FORMAT p void ITT_FORMAT p void ITT_FORMAT p void size_t ITT_FORMAT d void ITT_FORMAT p const wchar_t ITT_FORMAT s const char ITT_FORMAT s const char ITT_FORMAT s const char ITT_FORMAT s no args void ITT_FORMAT p size_t ITT_FORMAT d no args const wchar_t const wchar_t ITT_FORMAT s __itt_heap_function void size_t int ITT_FORMAT d __itt_heap_function void ITT_FORMAT p __itt_heap_function void void size_t int ITT_FORMAT d no args no args unsigned int ITT_FORMAT u const __itt_domain __itt_id ITT_FORMAT lu const __itt_domain __itt_id __itt_id __itt_string_handle ITT_FORMAT p const __itt_domain __itt_id ITT_FORMAT p const __itt_domain __itt_id __itt_timestamp __itt_timestamp ITT_FORMAT lu const __itt_domain __itt_id __itt_id __itt_string_handle ITT_FORMAT p const __itt_domain ITT_FORMAT p const __itt_domain __itt_string_handle unsigned long long ITT_FORMAT lu const __itt_domain __itt_string_handle unsigned long long ITT_FORMAT lu const __itt_domain __itt_id __itt_string_handle __itt_metadata_type size_t void ITT_FORMAT p const __itt_domain __itt_id __itt_string_handle const wchar_t size_t ITT_FORMAT lu const __itt_domain __itt_id __itt_relation __itt_id ITT_FORMAT p const wchar_t int ITT_FORMAT __itt_group_mark d __itt_event ITT_FORMAT __itt_group_mark d void const wchar_t const wchar_t int ITT_FORMAT __itt_group_sync __itt_group_fsync x void const wchar_t int const wchar_t int int ITT_FORMAT __itt_group_sync __itt_group_fsync x void ITT_FORMAT __itt_group_sync __itt_group_fsync p void ITT_FORMAT __itt_group_sync __itt_group_fsync p void size_t ITT_FORMAT lu no args __itt_obj_prop_t __itt_obj_state_t ITT_FORMAT d const char ITT_FORMAT s const char ITT_FORMAT s __itt_frame ITT_FORMAT p __itt_counter ITT_FORMAT p __itt_counter unsigned long long ITT_FORMAT lu __itt_counter unsigned long long ITT_FORMAT lu __itt_counter __itt_clock_domain unsigned long long void ITT_FORMAT p const wchar_t ITT_FORMAT S __itt_mark_type const wchar_t ITT_FORMAT S __itt_mark_type const char ITT_FORMAT s __itt_mark_type ITT_FORMAT d __itt_caller ITT_FORMAT p __itt_caller ITT_FORMAT p no args const __itt_domain __itt_clock_domain unsigned long long __itt_id ITT_FORMAT lu const __itt_domain __itt_clock_domain unsigned long long __itt_id __itt_id void ITT_FORMAT p const __itt_domain __itt_id __itt_id __itt_string_handle ITT_FORMAT p const __itt_domain __itt_id ITT_FORMAT lu const __itt_domain __itt_clock_domain unsigned long long __itt_id __itt_string_handle __itt_scope ITT_FORMAT d const __itt_domain __itt_scope __itt_string_handle const char size_t ITT_FORMAT lu const __itt_domain __itt_clock_domain unsigned long long __itt_relation __itt_id ITT_FORMAT lu __itt_track_group __itt_string_handle __itt_track_group_type ITT_FORMAT d __itt_track ITT_FORMAT p void int const int int const char int ITT_FORMAT d void void const char * path</div><div class="ttdef"><b>定义</b> ittnotify_static.h:346</div></div>
<div class="ttc" id="anamespacestd_html"><div class="ttname"><a href="namespacestd.html">std</a></div><div class="ttdoc">Extensions to the C++ standard library.</div><div class="ttdef"><b>定义</b> array.h:631</div></div>
<div class="ttc" id="asugar_8h_html_aa2bc5aa57d417f3226228d9058ab9f20"><div class="ttname"><a href="sugar_8h.html#aa2bc5aa57d417f3226228d9058ab9f20">lambda</a></div><div class="ttdeci">#define lambda(...)</div><div class="ttdef"><b>定义</b> sugar.h:96</div></div>
</div><!-- fragment --><h1><a class="anchor" id="CompileTaskflowWithCUDASeparately"></a>
Compile Source Code Separately</h1>
<p>Large GPU applications often compile a program into separate objects and link them together to form an executable or a library. You can compile your CPU code and GPU code separately with Taskflow using <code>nvcc</code> and other compilers (such as <code>g++</code> and <code>clang++</code>). Consider the following example that defines two tasks on two different pieces (<code>main.cpp</code> and <code>cudaflow.cpp</code>) of source code:</p>
<div class="fragment"><div class="line"><span class="comment">// main.cpp</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="taskflow_8hpp.html">taskflow/taskflow.hpp</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><a class="code hl_class" href="classtf_1_1_task.html">tf::Task</a> make_cudaflow(<a class="code hl_class" href="classtf_1_1_taskflow.html">tf::Taskflow</a>&amp; <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>);  <span class="comment">// create a cudaFlow task</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="main-override-static_8c.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>() {</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_class" href="classtf_1_1_executor.html">tf::Executor</a> <a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>;</div>
<div class="line">  <a class="code hl_class" href="classtf_1_1_taskflow.html">tf::Taskflow</a> <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>;</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_class" href="classtf_1_1_task.html">tf::Task</a> task1 = <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.emplace([](){ std::cout &lt;&lt; <span class="stringliteral">&quot;main.cpp!\n&quot;</span>; })</div>
<div class="line">                           .<a class="code hl_typedef" href="imgui__impl__opengl3__loader_8h.html#aab18cfce5ee7c6881ae04f18be70d94a">name</a>(<span class="stringliteral">&quot;cpu task&quot;</span>);</div>
<div class="line">  <a class="code hl_class" href="classtf_1_1_task.html">tf::Task</a> task2 = make_cudaflow(<a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>);</div>
<div class="line"> </div>
<div class="line">  task1.<a class="code hl_function" href="classtf_1_1_task.html#a8c78c453295a553c1c016e4062da8588">precede</a>(task2);</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.run(<a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>).wait();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><div class="fragment"><div class="line"><span class="comment">// cudaflow.cpp</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="taskflow_8hpp.html">taskflow/taskflow.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;taskflow/cudaflow.hpp&gt;</span></div>
<div class="line"> </div>
<div class="line"><a class="code hl_class" href="classtf_1_1_task.html">tf::Task</a> make_cudaflow(<a class="code hl_class" href="classtf_1_1_taskflow.html">tf::Taskflow</a>&amp; <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>) {</div>
<div class="line">  <span class="keywordflow">return</span> <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.emplace([](){</div>
<div class="line">    <span class="comment">// create a cudaFlow of a single-threaded task</span></div>
<div class="line">    <a class="code hl_class" href="classtf_1_1cuda_flow.html">tf::cudaFlow</a> cf;</div>
<div class="line">    cf.<a class="code hl_function" href="classtf_1_1cuda_flow.html#ac2906cb0002fc411a983d100a3d58d62">single_task</a>([] __device__ () { <a class="code hl_function" href="printf_8h.html#aee3ed3a831f25f07e7be3919fff2203a">printf</a>(<span class="stringliteral">&quot;cudaflow.cpp!\n&quot;</span>); });</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// launch the cudaflow through a stream</span></div>
<div class="line">    <a class="code hl_typedef" href="namespacetf.html#af19c9b301dc0b0fe2a51a960fa427e83">tf::cudaStream</a> stream;</div>
<div class="line">    cf.run(stream);</div>
<div class="line">    stream.<a class="code hl_function" href="classtf_1_1cuda_stream_base.html#a08857ff2874cd5378e578822e2e96dd0">synchronize</a>();</div>
<div class="line">  }).<a class="code hl_typedef" href="imgui__impl__opengl3__loader_8h.html#aab18cfce5ee7c6881ae04f18be70d94a">name</a>(<span class="stringliteral">&quot;gpu task&quot;</span>);</div>
<div class="line">}</div>
</div><!-- fragment --><p>Compile each source to an object (<code>g++</code> as an example):</p>
<div class="fragment"><div class="line">{.shell-session} </div>
<div class="line">~$ <a class="code hl_variable" href="offscreen_8c.html#a8cf17d727651616de6f2b79ef32170cd">g</a>++ -<a class="code hl_namespace" href="namespacestd.html">std</a>=<a class="code hl_variable" href="bench_vec_add_8cpp.html#a41689956983587b085f9da3e48f31d99">c</a>++17 -I <a class="code hl_variable" href="ittnotify__static_8h.html#a7016119bc831a22d1a351d56128518ed">path</a>/to/<a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a> -<a class="code hl_variable" href="bench_vec_add_8cpp.html#a41689956983587b085f9da3e48f31d99">c</a> <a class="code hl_function" href="main-override-static_8c.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>.cpp -o <a class="code hl_function" href="main-override-static_8c.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>.o</div>
<div class="line">~$ nvcc -<a class="code hl_namespace" href="namespacestd.html">std</a>=<a class="code hl_variable" href="bench_vec_add_8cpp.html#a41689956983587b085f9da3e48f31d99">c</a>++17 --extended-<a class="code hl_define" href="sugar_8h.html#aa2bc5aa57d417f3226228d9058ab9f20">lambda</a> -<a class="code hl_variable" href="offscreen_8c.html#a5fd331c99e778f04762be6d8173eb4d2">x</a> cu -I <a class="code hl_variable" href="ittnotify__static_8h.html#a7016119bc831a22d1a351d56128518ed">path</a>/to/<a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a> \</div>
<div class="line">        -dc cudaflow.cpp -o cudaflow.o</div>
<div class="line">~$ ls</div>
<div class="line"><span class="preprocessor"># now we have the two compiled .o objects, main.o and cudaflow.o</span></div>
<div class="line"><a class="code hl_function" href="main-override-static_8c.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>.o cudaflow.o </div>
<div class="ttc" id="aoffscreen_8c_html_a5fd331c99e778f04762be6d8173eb4d2"><div class="ttname"><a href="offscreen_8c.html#a5fd331c99e778f04762be6d8173eb4d2">x</a></div><div class="ttdeci">float x</div><div class="ttdef"><b>定义</b> offscreen.c:41</div></div>
<div class="ttc" id="aoffscreen_8c_html_a8cf17d727651616de6f2b79ef32170cd"><div class="ttname"><a href="offscreen_8c.html#a8cf17d727651616de6f2b79ef32170cd">g</a></div><div class="ttdeci">float g</div><div class="ttdef"><b>定义</b> offscreen.c:42</div></div>
</div><!-- fragment --><p>The <code>--extended-lambda</code> option tells <code>nvcc</code> to generate GPU code for the lambda defined with <code><b>device</b></code>. The <code>-x cu</code> tells <code>nvcc</code> to treat the input files as <code></code>.cu files containing both CPU and GPU code. By default, <code>nvcc</code> treats <code></code>.cpp files as CPU-only code. This option is required to have <code>nvcc</code> generate device code here, but it is also a handy way to avoid renaming source files in larger projects. The <code>–dc</code> option tells <code>nvcc</code> to generate device code for later linking.</p>
<p>You may also need to specify the target architecture to tell <code>nvcc</code> to target on a compatible SM architecture using the option -arch. For instance, the following command requires device code linking to have compute capability 7.5 or later:</p>
<div class="fragment"><div class="line">{.shell-session} </div>
<div class="line">~$ nvcc -<a class="code hl_namespace" href="namespacestd.html">std</a>=<a class="code hl_variable" href="bench_vec_add_8cpp.html#a41689956983587b085f9da3e48f31d99">c</a>++17 --extended-<a class="code hl_define" href="sugar_8h.html#aa2bc5aa57d417f3226228d9058ab9f20">lambda</a> -<a class="code hl_variable" href="offscreen_8c.html#a5fd331c99e778f04762be6d8173eb4d2">x</a> cu -arch=sm_75 -I <a class="code hl_variable" href="ittnotify__static_8h.html#a7016119bc831a22d1a351d56128518ed">path</a>/to/<a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a> \</div>
<div class="line">        -dc cudaflow.cpp -o cudaflow.o</div>
</div><!-- fragment --><h2><a class="anchor" id="CompileTaskflowWithCUDANaiveLinking"></a>
Link Objects Using nvcc</h2>
<p>Using <code>nvcc</code> to link compiled object code is nothing special but replacing the normal compiler with <code>nvcc</code> and it takes care of all the necessary steps:</p>
<div class="fragment"><div class="line">{.shell-session} </div>
<div class="line">~$ nvcc <a class="code hl_function" href="main-override-static_8c.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>.o cudaflow.o -o <a class="code hl_function" href="main-override-static_8c.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># run the main program </span></div>
<div class="line">~$ ./<a class="code hl_function" href="main-override-static_8c.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a></div>
<div class="line"><a class="code hl_function" href="main-override-static_8c.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>.cpp!</div>
<div class="line">cudaflow.cpp!</div>
</div><!-- fragment --><h2><a class="anchor" id="CompileTaskflowWithCUDADifferentLinkers"></a>
Link Objects Using Different Linkers</h2>
<p>You can choose to use a compiler other than <code>nvcc</code> for the final link step. Since your CPU compiler does not know how to link CUDA device code, you have to add a step in your build to have <code>nvcc</code> link the CUDA device code, using the option <code>-dlink:</code> </p>
<div class="fragment"><div class="line">{.shell-session} </div>
<div class="line">~$ nvcc -o gpuCode.o -dlink <a class="code hl_function" href="main-override-static_8c.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>.o cudaflow.o</div>
</div><!-- fragment --><p>This step links all the <em>device object code</em> and places it into <code>gpuCode.o</code>.</p>
<dl class="section attention"><dt>注意</dt><dd>Note that this step does not link the CPU object code and discards the CPU object code in <code>main.o</code> and <code>cudaflow.o</code>.</dd></dl>
<p>To complete the link to an executable, you can use, for example, <code>ld</code> or <code>g++</code>.</p>
<div class="fragment"><div class="line">{.shell-session} </div>
<div class="line"><span class="preprocessor"># replace /usr/local/cuda/lib64 with your own CUDA library installation path</span></div>
<div class="line">~$ <a class="code hl_variable" href="offscreen_8c.html#a8cf17d727651616de6f2b79ef32170cd">g</a>++ -pthread -<a class="code hl_variable" href="_l_l_t__example_8cpp.html#a2913877890361a28ee108aafe462ee93">L</a> /usr/local/cuda/lib64/ -lcudart \</div>
<div class="line">   gpuCode.o <a class="code hl_function" href="main-override-static_8c.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>.o cudaflow.o -o <a class="code hl_function" href="main-override-static_8c.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># run the main program</span></div>
<div class="line">~$ ./<a class="code hl_function" href="main-override-static_8c.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a></div>
<div class="line"><a class="code hl_function" href="main-override-static_8c.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>.cpp!</div>
<div class="line">cudaflow.cpp!</div>
<div class="ttc" id="a_l_l_t__example_8cpp_html_a2913877890361a28ee108aafe462ee93"><div class="ttname"><a href="_l_l_t__example_8cpp.html#a2913877890361a28ee108aafe462ee93">L</a></div><div class="ttdeci">MatrixXd L</div><div class="ttdef"><b>定义</b> LLT_example.cpp:6</div></div>
</div><!-- fragment --><p>We give <code>g++</code> all of the objects again because it needs the CPU object code, which is not in <code>gpuCode.o</code>. The device code stored in the original objects, <code>main.o</code> and <code>cudaflow.o</code>, does not conflict with the code in <code>gpuCode.o</code>. <code>g++</code> ignores device code because it does not know how to link it, and the device code in <code>gpuCode.o</code> is already linked and ready to go.</p>
<dl class="section attention"><dt>注意</dt><dd>This intentional ignorance is extremely useful in large builds where intermediate objects may have both CPU and GPU code. In this case, we just let the GPU and CPU linkers each do its own job, noting that the CPU linker is always the last one we run. The CUDA <a class="el" href="classtf_1_1_runtime.html" title="class to include a runtime object in a task">Runtime</a> API library is automatically linked when we use <code>nvcc</code> for linking, but we must explicitly link it (<code>-lcudart</code>) when using another linker. </dd></dl>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">制作者 <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
