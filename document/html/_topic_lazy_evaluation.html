<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>source: Lazy Evaluation and Aliasing</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">source
   </div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="搜索" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- 制作者 Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('_topic_lazy_evaluation.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">载入中...</div>
<div class="SRStatus" id="Searching">搜索中...</div>
<div class="SRStatus" id="NoMatches">未找到</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Lazy Evaluation and Aliasing</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Executive summary: <a class="el" href="namespace_eigen.html" title="Namespace containing all symbols from the Eigen library.">Eigen</a> has intelligent compile-time mechanisms to enable lazy evaluation and removing temporaries where appropriate. It will handle aliasing automatically in most cases, for example with matrix products. The automatic behavior can be overridden manually by using the <a class="el" href="class_eigen_1_1_matrix_base.html#a5df64c66228ba75bbc66db2584185527">MatrixBase::eval()</a> and <a class="el" href="class_eigen_1_1_matrix_base.html#a2c1085de7645f23f240876388457da0b">MatrixBase::noalias()</a> methods.</p>
<p>When you write a line of code involving a complex expression such as</p>
<div class="fragment"><div class="line"><a class="code hl_function" href="_tutorial___advanced_initialization___three_ways_8cpp.html#a41fdd9e057fe4da2425ee385b574be93">mat1</a> = mat2 + mat3 * (mat4 + mat5); </div>
<div class="ttc" id="a_tutorial___advanced_initialization___three_ways_8cpp_html_a41fdd9e057fe4da2425ee385b574be93"><div class="ttname"><a href="_tutorial___advanced_initialization___three_ways_8cpp.html#a41fdd9e057fe4da2425ee385b574be93">mat1</a></div><div class="ttdeci">MatrixXd mat1(size, size)</div></div>
</div><!-- fragment --><p><a class="el" href="namespace_eigen.html" title="Namespace containing all symbols from the Eigen library.">Eigen</a> determines automatically, for each sub-expression, whether to evaluate it into a temporary variable. Indeed, in certain cases it is better to evaluate immediately a sub-expression into a temporary variable, while in other cases it is better to avoid that.</p>
<p><a class="el" href="bench__gemm_8cpp.html#addc86e8508f14411ec98f521c520f875">A</a> traditional math library without expression templates always evaluates all sub-expressions into temporaries. So with this code,</p>
<div class="fragment"><div class="line"><a class="code hl_variable" href="benchmarks_2deferred__pipeline_2pthread_8cpp.html#a38a426a3f468937c7f8aa11daeb67ed7">vec1</a> = vec2 + vec3; </div>
<div class="ttc" id="abenchmarks_2deferred__pipeline_2pthread_8cpp_html_a38a426a3f468937c7f8aa11daeb67ed7"><div class="ttname"><a href="benchmarks_2deferred__pipeline_2pthread_8cpp.html#a38a426a3f468937c7f8aa11daeb67ed7">vec1</a></div><div class="ttdeci">std::vector&lt; int &gt; vec1</div><div class="ttdef"><b>定义</b> pthread.cpp:23</div></div>
</div><!-- fragment --><p>a traditional library would evaluate <code>vec2</code> + vec3 into a temporary <code>vec4</code> and then copy <code>vec4</code> into <code>vec1</code>. This is of course inefficient: the arrays are traversed twice, so there are a lot of useless load/store operations.</p>
<p>Expression-templates-based libraries can avoid evaluating sub-expressions into temporaries, which in many cases results in large speed improvements. This is called <em>lazy evaluation</em> as an expression is getting evaluated as late as possible, instead of immediately. However, most other expression-templates-based libraries <em>always</em> choose lazy evaluation. There are two problems with that: first, lazy evaluation is not always a good choice for performance; second, lazy evaluation can be very dangerous, for example with matrix products: doing <code>matrix = matrix*matrix</code> gives a wrong result if the matrix product is lazy-evaluated, because of the way matrix product works.</p>
<p>For these reasons, <a class="el" href="namespace_eigen.html" title="Namespace containing all symbols from the Eigen library.">Eigen</a> has intelligent compile-time mechanisms to determine automatically when to use lazy evaluation, and when on the contrary it should evaluate immediately into a temporary variable.</p>
<p>So in the basic example,</p>
<div class="fragment"><div class="line">matrix1 = matrix2 + matrix3; </div>
</div><!-- fragment --><p><a class="el" href="namespace_eigen.html" title="Namespace containing all symbols from the Eigen library.">Eigen</a> chooses lazy evaluation. Thus the arrays are traversed only once, producing optimized code. If you really want to force immediate evaluation, use <a class="el" href="class_eigen_1_1_matrix_base.html#a5df64c66228ba75bbc66db2584185527">eval()</a>:</p>
<div class="fragment"><div class="line">matrix1 = (matrix2 + matrix3).<a class="code hl_function" href="sparse__permutations_8cpp.html#abf03ad46cd5db5b4eabad69a86a13a6c">eval</a>(); </div>
<div class="ttc" id="asparse__permutations_8cpp_html_abf03ad46cd5db5b4eabad69a86a13a6c"><div class="ttname"><a href="sparse__permutations_8cpp.html#abf03ad46cd5db5b4eabad69a86a13a6c">eval</a></div><div class="ttdeci">internal::nested_eval&lt; T, 1 &gt;::type eval(const T &amp;xpr)</div><div class="ttdef"><b>定义</b> sparse_permutations.cpp:38</div></div>
</div><!-- fragment --><p>Here is now a more involved example:</p>
<div class="fragment"><div class="line">matrix1 = -matrix2 + matrix3 + 5 * matrix4; </div>
</div><!-- fragment --><p><a class="el" href="namespace_eigen.html" title="Namespace containing all symbols from the Eigen library.">Eigen</a> chooses lazy evaluation at every stage in that example, which is clearly the correct choice. In fact, lazy evaluation is the "default choice" and <a class="el" href="namespace_eigen.html" title="Namespace containing all symbols from the Eigen library.">Eigen</a> will choose it except in a few circumstances.</p>
<p><b>The first circumstance</b> in which <a class="el" href="namespace_eigen.html" title="Namespace containing all symbols from the Eigen library.">Eigen</a> chooses immediate evaluation, is when it sees an assignment <code>a = b;</code> and the expression <code>b</code> has the evaluate-before-assigning <a class="el" href="group__flags.html">flag</a>. The most important example of such an expression is the <a class="el" href="class_eigen_1_1_product.html">matrix product expression</a>. For example, when you do</p>
<div class="fragment"><div class="line"><a class="code hl_variable" href="external_2taskflow_2benchmarks_2wavefront_2main_8cpp.html#aed60820750f2ab1bf9dd99bc0a9eaab8">matrix</a> = <a class="code hl_variable" href="external_2taskflow_2benchmarks_2wavefront_2main_8cpp.html#aed60820750f2ab1bf9dd99bc0a9eaab8">matrix</a> * <a class="code hl_variable" href="external_2taskflow_2benchmarks_2wavefront_2main_8cpp.html#aed60820750f2ab1bf9dd99bc0a9eaab8">matrix</a>; </div>
<div class="ttc" id="aexternal_2taskflow_2benchmarks_2wavefront_2main_8cpp_html_aed60820750f2ab1bf9dd99bc0a9eaab8"><div class="ttname"><a href="external_2taskflow_2benchmarks_2wavefront_2main_8cpp.html#aed60820750f2ab1bf9dd99bc0a9eaab8">matrix</a></div><div class="ttdeci">double ** matrix</div><div class="ttdef"><b>定义</b> main.cpp:9</div></div>
</div><!-- fragment --><p><a class="el" href="namespace_eigen.html" title="Namespace containing all symbols from the Eigen library.">Eigen</a> first evaluates <code>matrix * matrix</code> into a temporary matrix, and then copies it into the original <code>matrix</code>. This guarantees a correct result as we saw above that lazy evaluation gives wrong results with matrix products. It also doesn't cost much, as the cost of the matrix product itself is much higher.</p>
<p>What if you know that the result does no alias the operand of the product and want to force lazy evaluation? Then use <a class="el" href="class_eigen_1_1_matrix_base.html#a2c1085de7645f23f240876388457da0b">.noalias()</a> instead. Here is an example:</p>
<div class="fragment"><div class="line">matrix1.noalias() = matrix2 * matrix2; </div>
</div><!-- fragment --><p>Here, since we know that matrix2 is not the same matrix as matrix1, we know that lazy evaluation is not dangerous, so we may force lazy evaluation. Concretely, the effect of noalias() here is to bypass the evaluate-before-assigning <a class="el" href="group__flags.html">flag</a>.</p>
<p><b>The second circumstance</b> in which <a class="el" href="namespace_eigen.html" title="Namespace containing all symbols from the Eigen library.">Eigen</a> chooses immediate evaluation, is when it sees a nested expression such as <code>a + b</code> where <code>b</code> is already an expression having the evaluate-before-nesting <a class="el" href="group__flags.html">flag</a>. Again, the most important example of such an expression is the <a class="el" href="class_eigen_1_1_product.html">matrix product expression</a>. For example, when you do</p>
<div class="fragment"><div class="line">matrix1 = matrix2 + matrix3 * matrix4; </div>
</div><!-- fragment --><p>the product <code>matrix3 * matrix4</code> gets evaluated immediately into a temporary matrix. Indeed, experiments showed that it is often beneficial for performance to evaluate immediately matrix products when they are nested into bigger expressions.</p>
<p><b>The third circumstance</b> in which <a class="el" href="namespace_eigen.html" title="Namespace containing all symbols from the Eigen library.">Eigen</a> chooses immediate evaluation, is when its cost model shows that the total cost of an operation is reduced if a sub-expression gets evaluated into a temporary. Indeed, in certain cases, an intermediate result is sufficiently costly to compute and is reused sufficiently many times, that is worth "caching". Here is an example:</p>
<div class="fragment"><div class="line">matrix1 = matrix2 * (matrix3 + matrix4); </div>
</div><!-- fragment --><p>Here, provided the matrices have at least 2 rows and 2 columns, each coefficienct of the expression <code>matrix3 + matrix4</code> is going to be used several times in the matrix product. Instead of computing the sum everytime, it is much better to compute it once and store it in a temporary variable. <a class="el" href="namespace_eigen.html" title="Namespace containing all symbols from the Eigen library.">Eigen</a> understands this and evaluates <code>matrix3 + matrix4</code> into a temporary variable before evaluating the product. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">制作者 <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
