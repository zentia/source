<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>source: Graph Processing Pipeline</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">source
   </div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="搜索" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- 制作者 Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('_graph_processing_pipeline.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">载入中...</div>
<div class="SRStatus" id="Searching">搜索中...</div>
<div class="SRStatus" id="NoMatches">未找到</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Graph Processing Pipeline</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>目录</h3>
<ul>
  <li class="level1">
    <a href="#FormulateTheGraphProcessingPipelineProblem">Formulate the Graph Processing Pipeline Problem</a>
  </li>
  <li class="level1">
    <a href="#CreateAGraphProcessingPipeline">Create a Graph Processing Pipeline</a>
    <ul>
      <li class="level2">
        <a href="#GraphPipelineFindATopologicalOrderOfTheGraph">Find a Topological Order of the Graph</a>
      </li>
      <li class="level2">
        <a href="#GraphPipelineDefineTheStageFunction">Define the Stage Function</a>
      </li>
      <li class="level2">
        <a href="#GraphPipelineDefineThePipes">Define the Pipes</a>
      </li>
      <li class="level2">
        <a href="#GraphPipelineDefineTheTaskGraph">Define the Task Graph</a>
      </li>
      <li class="level2">
        <a href="#GraphPipelineSubmitTheTaskGraph">Submit the Task Graph</a>
      </li>
    </ul>
  </li>
  <li class="level1">
    <a href="#GraphPipelineReference">Reference</a>
  </li>
</ul>
</div>
<div class="textblock"><p>We study a graph processing pipeline that propagates a sequence of linearly dependent tasks over a dependency graph. In this particular workload, we will learn how to transform task graph parallelism into pipeline parallelism.</p>
<h1><a class="anchor" id="FormulateTheGraphProcessingPipelineProblem"></a>
Formulate the Graph Processing Pipeline Problem</h1>
<p>Given a directed acyclic graph (DAG), where each node encapsulates a sequence of linearly dependent tasks, namely <em>stage tasks</em>, and each edge represents a dependency between two tasks at the same stages of adjacent nodes. For example, assuming <code>fi(u)</code> represents the <code>i</code><sup>th</sup>-stage task of node <code>u</code>, a dependency from <code>u</code> to <code>v</code> requires <code>fi(u)</code> to run before <code>fi(v)</code>. The following figures shows an example of three stage tasks in a DAG of three nodes (<code><a class="el" href="bench__gemm_8cpp.html#addc86e8508f14411ec98f521c520f875">A</a></code>, <code><a class="el" href="bench__gemm_8cpp.html#a37a83060ac796961b44991c836f083f7">B</a></code>, and <code>C</code>) and two dependencies (<code>A-&gt;<a class="el" href="bench__gemm_8cpp.html#a37a83060ac796961b44991c836f083f7">B</a></code> and <code>A-&gt;C</code>):</p>
<p>While we can directly create a taskflow for the DAG (i.e., each task in the taskflow runs <code>f1</code>, <code>f2</code>, and <code>f3</code> sequentially), we can describe the parallelism as a three-stage pipeline that propagates a topological order of the DAG through three stage tasks. Consider a valid topological order of this DAG, <code><a class="el" href="bench__gemm_8cpp.html#addc86e8508f14411ec98f521c520f875">A</a>, <a class="el" href="bench__gemm_8cpp.html#a37a83060ac796961b44991c836f083f7">B</a>, C</code>, its pipeline parallelism can be illustrated in the following figure:</p>
<p>At the beginning, <code>f1(A)</code> runs first. When <code>f1(A)</code> completes, it moves on to <code>f2(A)</code> and, meanwhile, <code>f1(B)</code> can start to run together with <code>f2(A)</code>, and so on so forth. The straight line represents two parallel tasks that can overlap in time in the pipeline. For example, <code>f3(A)</code>, <code>f2(B)</code>, and <code>f1(C)</code> can run simultaneously. The following figures shows the task dependency graph of this pipeline workload:</p>
<p>As we can see, tasks in diagonal lines (lower-left to upper-right) can run in parallel. This type of parallelism is also referred to as <em>wavefront</em> parallelism, which sweeps parallel elements in a diagonal direction.</p>
<dl class="section attention"><dt>注意</dt><dd>Depending on the graph size and the number of stage tasks, task graph parallelism and pipeline parallelism can bring very different performance results. For example, a small graph will a long chain of stage tasks may perform better with pipeline parallelism than task graph parallelism, and vice versa.</dd></dl>
<h1><a class="anchor" id="CreateAGraphProcessingPipeline"></a>
Create a Graph Processing Pipeline</h1>
<p>Using the example from the previous section, we create a three-stage pipeline that encapsulates the three stage tasks (<code>f1, f2, f3</code>) in three pipes. By finding a topological order of the graph, we can transform the node dependency into a sequence of linearly dependent data tokens to feed into the pipeline. The overall implementation is shown below:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="taskflow_8hpp.html">taskflow/taskflow.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="taskflow_2algorithm_2pipeline_8hpp.html">taskflow/algorithm/pipeline.hpp</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// 1st-stage function</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a20ea9116f00e19915f910ca726f7518f">f1</a>(<span class="keyword">const</span> std::string&amp; node) {</div>
<div class="line">  <a class="code hl_function" href="printf_8h.html#aee3ed3a831f25f07e7be3919fff2203a">printf</a>(<span class="stringliteral">&quot;f1(%s)\n&quot;</span>, node.c_str());</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 2nd-stage function</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a894124d17350678007462a79ecc7eb36">f2</a>(<span class="keyword">const</span> std::string&amp; node) {</div>
<div class="line">  <a class="code hl_function" href="printf_8h.html#aee3ed3a831f25f07e7be3919fff2203a">printf</a>(<span class="stringliteral">&quot;f2(%s)\n&quot;</span>, node.c_str());</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 3rd-stage function</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a4e249d464ae215ce0d4d53e0b369ab98">f3</a>(<span class="keyword">const</span> std::string&amp; node) {</div>
<div class="line">  <a class="code hl_function" href="printf_8h.html#aee3ed3a831f25f07e7be3919fff2203a">printf</a>(<span class="stringliteral">&quot;f3(%s)\n&quot;</span>, node.c_str());</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="main-override-static_8c.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>() {</div>
<div class="line"> </div>
<div class="line">  tf::Taskflow <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>(<span class="stringliteral">&quot;graph processing pipeline&quot;</span>);</div>
<div class="line">  tf::Executor <a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">size_t</span> num_lines = 2;</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// a topological order of the graph</span></div>
<div class="line">  <span class="comment">//    |-&gt; B</span></div>
<div class="line">  <span class="comment">// A--|</span></div>
<div class="line">  <span class="comment">//    |-&gt; C</span></div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;std::string&gt; <a class="code hl_variable" href="external_2taskflow_23rd-party_2tbb_2examples_2parallel__do_2parallel__preorder_2main_8cpp.html#a6a5c3f7e9d33dd3ab656f0191f83aa79">nodes</a> = {<span class="stringliteral">&quot;A&quot;</span>, <span class="stringliteral">&quot;B&quot;</span>, <span class="stringliteral">&quot;C&quot;</span>};</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// the pipeline consists of three serial pipes</span></div>
<div class="line">  <span class="comment">// and up to two concurrent scheduling tokens</span></div>
<div class="line">  tf::Pipeline pl(num_lines,</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// first pipe calls f1</span></div>
<div class="line">    tf::Pipe{<a class="code hl_enumvalue" href="namespacetf.html#abb7a11e41fd457f69e7ff45d4c769564a7b804a28d6154ab8007287532037f1d0">tf::PipeType::SERIAL</a>, [&amp;](tf::Pipeflow&amp; pf) {</div>
<div class="line">      <span class="keywordflow">if</span>(pf.token() == <a class="code hl_variable" href="external_2taskflow_23rd-party_2tbb_2examples_2parallel__do_2parallel__preorder_2main_8cpp.html#a6a5c3f7e9d33dd3ab656f0191f83aa79">nodes</a>.size()) {</div>
<div class="line">        pf.stop();</div>
<div class="line">      }</div>
<div class="line">      <span class="keywordflow">else</span> {</div>
<div class="line">        <a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a20ea9116f00e19915f910ca726f7518f">f1</a>(<a class="code hl_variable" href="external_2taskflow_23rd-party_2tbb_2examples_2parallel__do_2parallel__preorder_2main_8cpp.html#a6a5c3f7e9d33dd3ab656f0191f83aa79">nodes</a>[pf.token()]);</div>
<div class="line">      }</div>
<div class="line">    }},</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// second pipe calls f2</span></div>
<div class="line">    tf::Pipe{<a class="code hl_enumvalue" href="namespacetf.html#abb7a11e41fd457f69e7ff45d4c769564a7b804a28d6154ab8007287532037f1d0">tf::PipeType::SERIAL</a>, [&amp;](tf::Pipeflow&amp; pf) {</div>
<div class="line">      <a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a894124d17350678007462a79ecc7eb36">f2</a>(<a class="code hl_variable" href="external_2taskflow_23rd-party_2tbb_2examples_2parallel__do_2parallel__preorder_2main_8cpp.html#a6a5c3f7e9d33dd3ab656f0191f83aa79">nodes</a>[pf.token()]);</div>
<div class="line">    }},</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// third pipe calls f3</span></div>
<div class="line">    tf::Pipe{<a class="code hl_enumvalue" href="namespacetf.html#abb7a11e41fd457f69e7ff45d4c769564a7b804a28d6154ab8007287532037f1d0">tf::PipeType::SERIAL</a>, [&amp;](tf::Pipeflow&amp; pf) {</div>
<div class="line">      <a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a4e249d464ae215ce0d4d53e0b369ab98">f3</a>(<a class="code hl_variable" href="external_2taskflow_23rd-party_2tbb_2examples_2parallel__do_2parallel__preorder_2main_8cpp.html#a6a5c3f7e9d33dd3ab656f0191f83aa79">nodes</a>[pf.token()]);</div>
<div class="line">    }}</div>
<div class="line">  );</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// build the pipeline graph using composition</span></div>
<div class="line">  tf::Task <a class="code hl_function" href="boing_8c.html#a2858154e2009b0e6e616f313177762bc">init</a> = <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.emplace([](){ std::cout &lt;&lt; <span class="stringliteral">&quot;ready\n&quot;</span>; })</div>
<div class="line">                          .<a class="code hl_typedef" href="imgui__impl__opengl3__loader_8h.html#aab18cfce5ee7c6881ae04f18be70d94a">name</a>(<span class="stringliteral">&quot;starting pipeline&quot;</span>);</div>
<div class="line">  tf::Task <a class="code hl_define" href="test__partitioner__whitebox_8h.html#a5c4cf3d37a4eee22275de22cb9619863">task</a> = <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.composed_of(pl)</div>
<div class="line">                          .name(<span class="stringliteral">&quot;pipeline&quot;</span>);</div>
<div class="line">  tf::Task stop = <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.emplace([](){ std::cout &lt;&lt; <span class="stringliteral">&quot;stopped\n&quot;</span>; })</div>
<div class="line">                          .<a class="code hl_typedef" href="imgui__impl__opengl3__loader_8h.html#aab18cfce5ee7c6881ae04f18be70d94a">name</a>(<span class="stringliteral">&quot;pipeline stopped&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// create task dependency</span></div>
<div class="line">  <a class="code hl_function" href="boing_8c.html#a2858154e2009b0e6e616f313177762bc">init</a>.precede(<a class="code hl_define" href="test__partitioner__whitebox_8h.html#a5c4cf3d37a4eee22275de22cb9619863">task</a>);</div>
<div class="line">  <a class="code hl_define" href="test__partitioner__whitebox_8h.html#a5c4cf3d37a4eee22275de22cb9619863">task</a>.precede(stop);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// dump the pipeline graph structure (with composition)</span></div>
<div class="line">  <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.dump(std::cout);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// run the pipeline</span></div>
<div class="line">  <a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.<a class="code hl_function" href="classtf_1_1_executor.html#a519777f5783981d534e9e53b99712069">run</a>(<a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>).wait();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="aboing_8c_html_a2858154e2009b0e6e616f313177762bc"><div class="ttname"><a href="boing_8c.html#a2858154e2009b0e6e616f313177762bc">init</a></div><div class="ttdeci">void init(void)</div><div class="ttdef"><b>定义</b> boing.c:182</div></div>
<div class="ttc" id="aclasstf_1_1_executor_html_a519777f5783981d534e9e53b99712069"><div class="ttname"><a href="classtf_1_1_executor.html#a519777f5783981d534e9e53b99712069">tf::Executor::run</a></div><div class="ttdeci">tf::Future&lt; void &gt; run(Taskflow &amp;taskflow)</div><div class="ttdoc">runs a taskflow once</div><div class="ttdef"><b>定义</b> executor-dl.hpp:2067</div></div>
<div class="ttc" id="aexternal_2taskflow_23rd-party_2tbb_2examples_2parallel__do_2parallel__preorder_2main_8cpp_html_a6a5c3f7e9d33dd3ab656f0191f83aa79"><div class="ttname"><a href="external_2taskflow_23rd-party_2tbb_2examples_2parallel__do_2parallel__preorder_2main_8cpp.html#a6a5c3f7e9d33dd3ab656f0191f83aa79">nodes</a></div><div class="ttdeci">static unsigned nodes</div><div class="ttdef"><b>定义</b> main.cpp:36</div></div>
<div class="ttc" id="aimgui__impl__opengl3__loader_8h_html_aab18cfce5ee7c6881ae04f18be70d94a"><div class="ttname"><a href="imgui__impl__opengl3__loader_8h.html#aab18cfce5ee7c6881ae04f18be70d94a">name</a></div><div class="ttdeci">const GLchar * name</div><div class="ttdef"><b>定义</b> imgui_impl_opengl3_loader.h:312</div></div>
<div class="ttc" id="amain-override-static_8c_html_ae66f6b31b5ad750f1fe042a706a4e3d4"><div class="ttname"><a href="main-override-static_8c.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a></div><div class="ttdeci">int main()</div><div class="ttdef"><b>定义</b> main-override-static.c:32</div></div>
<div class="ttc" id="anamespacetf_html_abb7a11e41fd457f69e7ff45d4c769564a7b804a28d6154ab8007287532037f1d0"><div class="ttname"><a href="namespacetf.html#abb7a11e41fd457f69e7ff45d4c769564a7b804a28d6154ab8007287532037f1d0">tf::PipeType::SERIAL</a></div><div class="ttdeci">@ SERIAL</div><div class="ttdoc">serial type</div><div class="ttdef"><b>定义</b> pipeline.hpp:201</div></div>
<div class="ttc" id="aparallel__graph__pipeline_8cpp_html_a20ea9116f00e19915f910ca726f7518f"><div class="ttname"><a href="parallel__graph__pipeline_8cpp.html#a20ea9116f00e19915f910ca726f7518f">f1</a></div><div class="ttdeci">void f1(const std::string &amp;node)</div><div class="ttdef"><b>定义</b> parallel_graph_pipeline.cpp:8</div></div>
<div class="ttc" id="aparallel__graph__pipeline_8cpp_html_a4e249d464ae215ce0d4d53e0b369ab98"><div class="ttname"><a href="parallel__graph__pipeline_8cpp.html#a4e249d464ae215ce0d4d53e0b369ab98">f3</a></div><div class="ttdeci">void f3(const std::string &amp;node)</div><div class="ttdef"><b>定义</b> parallel_graph_pipeline.cpp:18</div></div>
<div class="ttc" id="aparallel__graph__pipeline_8cpp_html_a894124d17350678007462a79ecc7eb36"><div class="ttname"><a href="parallel__graph__pipeline_8cpp.html#a894124d17350678007462a79ecc7eb36">f2</a></div><div class="ttdeci">void f2(const std::string &amp;node)</div><div class="ttdef"><b>定义</b> parallel_graph_pipeline.cpp:13</div></div>
<div class="ttc" id="apoisson_8hpp_html_aa56fe360bb0ae38e0082f49e394ff825"><div class="ttname"><a href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a></div><div class="ttdeci">void taskflow(int nx, int ny, double dx, double dy, double *f, int itold, int itnew, double *u, double *unew, int block_size, unsigned num_threads)</div><div class="ttdef"><b>定义</b> taskflow.cpp:6</div></div>
<div class="ttc" id="aprintf_8h_html_aee3ed3a831f25f07e7be3919fff2203a"><div class="ttname"><a href="printf_8h.html#aee3ed3a831f25f07e7be3919fff2203a">printf</a></div><div class="ttdeci">auto printf(string_view fmt, const T &amp;... args) -&gt; int</div><div class="ttdef"><b>定义</b> printf.h:621</div></div>
<div class="ttc" id="ataskflow_2algorithm_2pipeline_8hpp_html"><div class="ttname"><a href="taskflow_2algorithm_2pipeline_8hpp.html">pipeline.hpp</a></div><div class="ttdoc">pipeline include file</div></div>
<div class="ttc" id="ataskflow_8hpp_html"><div class="ttname"><a href="taskflow_8hpp.html">taskflow.hpp</a></div><div class="ttdoc">main taskflow include file</div></div>
<div class="ttc" id="atest__partitioner__whitebox_8h_html_a5c4cf3d37a4eee22275de22cb9619863"><div class="ttname"><a href="test__partitioner__whitebox_8h.html#a5c4cf3d37a4eee22275de22cb9619863">task</a></div><div class="ttdeci">#define task</div><div class="ttdef"><b>定义</b> test_partitioner_whitebox.h:76</div></div>
<div class="ttc" id="athread__pool_8cpp_html_a543e564a8407bbeac15cb2d929fec755"><div class="ttname"><a href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a></div><div class="ttdeci">tf::Executor executor</div><div class="ttdef"><b>定义</b> thread_pool.cpp:6</div></div>
</div><!-- fragment --><h2><a class="anchor" id="GraphPipelineFindATopologicalOrderOfTheGraph"></a>
Find a Topological Order of the Graph</h2>
<p>The first step is to find a valid topological order of the graph, such that we can transform the graph dependency into a linear sequence. In this example, we simply hard-code it:</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> std::vector&lt;std::string&gt; <a class="code hl_variable" href="external_2taskflow_23rd-party_2tbb_2examples_2parallel__do_2parallel__preorder_2main_8cpp.html#a6a5c3f7e9d33dd3ab656f0191f83aa79">nodes</a> = {<span class="stringliteral">&quot;A&quot;</span>, <span class="stringliteral">&quot;B&quot;</span>, <span class="stringliteral">&quot;C&quot;</span>};</div>
</div><!-- fragment --><h2><a class="anchor" id="GraphPipelineDefineTheStageFunction"></a>
Define the Stage Function</h2>
<p>This particular workload does not propagate data directly through the pipeline. In most situations, data is directly stored in a custom graph data structure, and the stage function will just need to know which node to process. For demo's sake, we simply output a message to show which stage function is processing which node:</p>
<div class="fragment"><div class="line"><span class="comment">// 1st-stage function</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a20ea9116f00e19915f910ca726f7518f">f1</a>(<span class="keyword">const</span> std::string&amp; node) {</div>
<div class="line">  <a class="code hl_function" href="printf_8h.html#aee3ed3a831f25f07e7be3919fff2203a">printf</a>(<span class="stringliteral">&quot;f1(%s)\n&quot;</span>, node.c_str());</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 2nd-stage function</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a894124d17350678007462a79ecc7eb36">f2</a>(<span class="keyword">const</span> std::string&amp; node) {</div>
<div class="line">  <a class="code hl_function" href="printf_8h.html#aee3ed3a831f25f07e7be3919fff2203a">printf</a>(<span class="stringliteral">&quot;f2(%s)\n&quot;</span>, node.c_str());</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 3rd-stage function</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a4e249d464ae215ce0d4d53e0b369ab98">f3</a>(<span class="keyword">const</span> std::string&amp; node) {</div>
<div class="line">  <a class="code hl_function" href="printf_8h.html#aee3ed3a831f25f07e7be3919fff2203a">printf</a>(<span class="stringliteral">&quot;f3(%s)\n&quot;</span>, node.c_str());</div>
<div class="line">}</div>
</div><!-- fragment --><dl class="section attention"><dt>注意</dt><dd><a class="el" href="bench__gemm_8cpp.html#addc86e8508f14411ec98f521c520f875">A</a> key advantage of Taskflow's pipeline programming model is that we do not provide any data abstraction but give users full control over data management, which is typically application-dependent. In an application like this graph processing pipeline, data is managed in a global custom graph data structure, and any data abstraction provided by the library can become a unnecessary overhead.</dd></dl>
<h2><a class="anchor" id="GraphPipelineDefineThePipes"></a>
Define the Pipes</h2>
<p>The pipe structure is straightforward. Each pipe encapsulates the corresponding stage function and passes the node into the function argument. The first pipe will cease the pipeline scheduling when it has processed all nodes. To identify which node is being processed at a running pipe, we use <a class="el" href="classtf_1_1_pipeflow.html#a295e5d884665c076f4ef5d78139f7c51" title="queries the token identifier">tf::Pipeflow::token</a> to find the index:</p>
<div class="fragment"><div class="line"><span class="comment">// first pipe calls f1</span></div>
<div class="line"><a class="code hl_class" href="classtf_1_1_pipe.html">tf::Pipe</a>{<a class="code hl_enumvalue" href="namespacetf.html#abb7a11e41fd457f69e7ff45d4c769564a7b804a28d6154ab8007287532037f1d0">tf::PipeType::SERIAL</a>, [&amp;](<a class="code hl_class" href="classtf_1_1_pipeflow.html">tf::Pipeflow</a>&amp; pf) {</div>
<div class="line">  <span class="keywordflow">if</span>(pf.token() == <a class="code hl_variable" href="external_2taskflow_23rd-party_2tbb_2examples_2parallel__do_2parallel__preorder_2main_8cpp.html#a6a5c3f7e9d33dd3ab656f0191f83aa79">nodes</a>.size()) {</div>
<div class="line">    pf.stop();</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span> {</div>
<div class="line">    <a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a20ea9116f00e19915f910ca726f7518f">f1</a>(<a class="code hl_variable" href="external_2taskflow_23rd-party_2tbb_2examples_2parallel__do_2parallel__preorder_2main_8cpp.html#a6a5c3f7e9d33dd3ab656f0191f83aa79">nodes</a>[pf.token()]);</div>
<div class="line">  }</div>
<div class="line">}},</div>
<div class="line"> </div>
<div class="line"><span class="comment">// second pipe calls f2</span></div>
<div class="line">tf::Pipe{<a class="code hl_enumvalue" href="namespacetf.html#abb7a11e41fd457f69e7ff45d4c769564a7b804a28d6154ab8007287532037f1d0">tf::PipeType::SERIAL</a>, [&amp;](tf::Pipeflow&amp; pf) {</div>
<div class="line">  <a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a894124d17350678007462a79ecc7eb36">f2</a>(<a class="code hl_variable" href="external_2taskflow_23rd-party_2tbb_2examples_2parallel__do_2parallel__preorder_2main_8cpp.html#a6a5c3f7e9d33dd3ab656f0191f83aa79">nodes</a>[pf.token()]);</div>
<div class="line">}},</div>
<div class="line"> </div>
<div class="line"><span class="comment">// third pipe calls f3</span></div>
<div class="line">tf::Pipe{<a class="code hl_enumvalue" href="namespacetf.html#abb7a11e41fd457f69e7ff45d4c769564a7b804a28d6154ab8007287532037f1d0">tf::PipeType::SERIAL</a>, [&amp;](tf::Pipeflow&amp; pf) {</div>
<div class="line">  <a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a4e249d464ae215ce0d4d53e0b369ab98">f3</a>(<a class="code hl_variable" href="external_2taskflow_23rd-party_2tbb_2examples_2parallel__do_2parallel__preorder_2main_8cpp.html#a6a5c3f7e9d33dd3ab656f0191f83aa79">nodes</a>[pf.token()]);</div>
<div class="line">}}</div>
<div class="ttc" id="aclasstf_1_1_pipe_html"><div class="ttname"><a href="classtf_1_1_pipe.html">tf::Pipe</a></div><div class="ttdoc">class to create a pipe object for a pipeline stage</div><div class="ttdef"><b>定义</b> pipeline.hpp:228</div></div>
<div class="ttc" id="aclasstf_1_1_pipeflow_html"><div class="ttname"><a href="classtf_1_1_pipeflow.html">tf::Pipeflow</a></div><div class="ttdoc">class to create a pipeflow object used by the pipe callable</div><div class="ttdef"><b>定义</b> pipeline.hpp:102</div></div>
</div><!-- fragment --><h2><a class="anchor" id="GraphPipelineDefineTheTaskGraph"></a>
Define the Task Graph</h2>
<p>To build up the taskflow for the pipeline, we create a module task with the defined pipeline structure and connect it with two tasks that output helper messages before and after the pipeline:</p>
<div class="fragment"><div class="line"><a class="code hl_class" href="classtf_1_1_task.html">tf::Task</a> <a class="code hl_struct" href="structinit.html">init</a> = <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.emplace([](){ std::cout &lt;&lt; <span class="stringliteral">&quot;ready\n&quot;</span>; })</div>
<div class="line">                        .<a class="code hl_typedef" href="imgui__impl__opengl3__loader_8h.html#aab18cfce5ee7c6881ae04f18be70d94a">name</a>(<span class="stringliteral">&quot;starting pipeline&quot;</span>);</div>
<div class="line"><a class="code hl_class" href="classtf_1_1_task.html">tf::Task</a> <a class="code hl_define" href="test__partitioner__whitebox_8h.html#a5c4cf3d37a4eee22275de22cb9619863">task</a> = <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.composed_of(pl)</div>
<div class="line">                        .name(<span class="stringliteral">&quot;pipeline&quot;</span>);</div>
<div class="line"><a class="code hl_class" href="classtf_1_1_task.html">tf::Task</a> stop = <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.emplace([](){ std::cout &lt;&lt; <span class="stringliteral">&quot;stopped\n&quot;</span>; })</div>
<div class="line">                        .<a class="code hl_typedef" href="imgui__impl__opengl3__loader_8h.html#aab18cfce5ee7c6881ae04f18be70d94a">name</a>(<span class="stringliteral">&quot;pipeline stopped&quot;</span>);</div>
<div class="line"><a class="code hl_struct" href="structinit.html">init</a>.precede(<a class="code hl_define" href="test__partitioner__whitebox_8h.html#a5c4cf3d37a4eee22275de22cb9619863">task</a>);</div>
<div class="line"><a class="code hl_define" href="test__partitioner__whitebox_8h.html#a5c4cf3d37a4eee22275de22cb9619863">task</a>.precede(stop);</div>
<div class="ttc" id="aclasstf_1_1_task_html"><div class="ttname"><a href="classtf_1_1_task.html">tf::Task</a></div><div class="ttdoc">class to create a task handle over a node in a taskflow graph</div><div class="ttdef"><b>定义</b> task.hpp:150</div></div>
<div class="ttc" id="astructinit_html"><div class="ttname"><a href="structinit.html">init</a></div><div class="ttdef"><b>定义</b> TutorialInplaceLU.cpp:2</div></div>
</div><!-- fragment --><h2><a class="anchor" id="GraphPipelineSubmitTheTaskGraph"></a>
Submit the Task Graph</h2>
<p>Finally, we submit the taskflow to the execution and run it once:</p>
<div class="fragment"><div class="line"><a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.run(<a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>).wait();</div>
</div><!-- fragment --><p>Three possible outputs are shown below:</p>
<div class="fragment"><div class="line">{.shell-session} </div>
<div class="line"><span class="preprocessor"># possible output 1</span></div>
<div class="line">ready</div>
<div class="line"><a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a20ea9116f00e19915f910ca726f7518f">f1</a>(<a class="code hl_typedef" href="bench__gemm_8cpp.html#addc86e8508f14411ec98f521c520f875">A</a>)</div>
<div class="line"><a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a894124d17350678007462a79ecc7eb36">f2</a>(<a class="code hl_typedef" href="bench__gemm_8cpp.html#addc86e8508f14411ec98f521c520f875">A</a>)</div>
<div class="line"><a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a20ea9116f00e19915f910ca726f7518f">f1</a>(<a class="code hl_typedef" href="bench__gemm_8cpp.html#a37a83060ac796961b44991c836f083f7">B</a>)</div>
<div class="line"><a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a894124d17350678007462a79ecc7eb36">f2</a>(<a class="code hl_typedef" href="bench__gemm_8cpp.html#a37a83060ac796961b44991c836f083f7">B</a>)</div>
<div class="line"><a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a4e249d464ae215ce0d4d53e0b369ab98">f3</a>(<a class="code hl_typedef" href="bench__gemm_8cpp.html#addc86e8508f14411ec98f521c520f875">A</a>)</div>
<div class="line"><a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a20ea9116f00e19915f910ca726f7518f">f1</a>(<a class="code hl_define" href="test__buffer__node_8cpp.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>)</div>
<div class="line"><a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a894124d17350678007462a79ecc7eb36">f2</a>(<a class="code hl_define" href="test__buffer__node_8cpp.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>)</div>
<div class="line"><a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a4e249d464ae215ce0d4d53e0b369ab98">f3</a>(<a class="code hl_typedef" href="bench__gemm_8cpp.html#a37a83060ac796961b44991c836f083f7">B</a>)</div>
<div class="line"><a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a4e249d464ae215ce0d4d53e0b369ab98">f3</a>(<a class="code hl_define" href="test__buffer__node_8cpp.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>)</div>
<div class="line">stopped</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># possible output 2</span></div>
<div class="line"><a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a20ea9116f00e19915f910ca726f7518f">f1</a>(<a class="code hl_typedef" href="bench__gemm_8cpp.html#addc86e8508f14411ec98f521c520f875">A</a>)</div>
<div class="line"><a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a894124d17350678007462a79ecc7eb36">f2</a>(<a class="code hl_typedef" href="bench__gemm_8cpp.html#addc86e8508f14411ec98f521c520f875">A</a>)</div>
<div class="line"><a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a4e249d464ae215ce0d4d53e0b369ab98">f3</a>(<a class="code hl_typedef" href="bench__gemm_8cpp.html#addc86e8508f14411ec98f521c520f875">A</a>)</div>
<div class="line"><a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a20ea9116f00e19915f910ca726f7518f">f1</a>(<a class="code hl_typedef" href="bench__gemm_8cpp.html#a37a83060ac796961b44991c836f083f7">B</a>)</div>
<div class="line"><a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a894124d17350678007462a79ecc7eb36">f2</a>(<a class="code hl_typedef" href="bench__gemm_8cpp.html#a37a83060ac796961b44991c836f083f7">B</a>)</div>
<div class="line"><a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a4e249d464ae215ce0d4d53e0b369ab98">f3</a>(<a class="code hl_typedef" href="bench__gemm_8cpp.html#a37a83060ac796961b44991c836f083f7">B</a>)</div>
<div class="line"><a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a20ea9116f00e19915f910ca726f7518f">f1</a>(<a class="code hl_define" href="test__buffer__node_8cpp.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>)</div>
<div class="line"><a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a894124d17350678007462a79ecc7eb36">f2</a>(<a class="code hl_define" href="test__buffer__node_8cpp.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>)</div>
<div class="line"><a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a4e249d464ae215ce0d4d53e0b369ab98">f3</a>(<a class="code hl_define" href="test__buffer__node_8cpp.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>)</div>
<div class="line">stopped</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># possible output 3</span></div>
<div class="line">ready</div>
<div class="line"><a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a20ea9116f00e19915f910ca726f7518f">f1</a>(<a class="code hl_typedef" href="bench__gemm_8cpp.html#addc86e8508f14411ec98f521c520f875">A</a>)</div>
<div class="line"><a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a894124d17350678007462a79ecc7eb36">f2</a>(<a class="code hl_typedef" href="bench__gemm_8cpp.html#addc86e8508f14411ec98f521c520f875">A</a>)</div>
<div class="line"><a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a4e249d464ae215ce0d4d53e0b369ab98">f3</a>(<a class="code hl_typedef" href="bench__gemm_8cpp.html#addc86e8508f14411ec98f521c520f875">A</a>)</div>
<div class="line"><a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a20ea9116f00e19915f910ca726f7518f">f1</a>(<a class="code hl_typedef" href="bench__gemm_8cpp.html#a37a83060ac796961b44991c836f083f7">B</a>)</div>
<div class="line"><a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a894124d17350678007462a79ecc7eb36">f2</a>(<a class="code hl_typedef" href="bench__gemm_8cpp.html#a37a83060ac796961b44991c836f083f7">B</a>)</div>
<div class="line"><a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a20ea9116f00e19915f910ca726f7518f">f1</a>(<a class="code hl_define" href="test__buffer__node_8cpp.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>)</div>
<div class="line"><a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a894124d17350678007462a79ecc7eb36">f2</a>(<a class="code hl_define" href="test__buffer__node_8cpp.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>)</div>
<div class="line"><a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a4e249d464ae215ce0d4d53e0b369ab98">f3</a>(<a class="code hl_typedef" href="bench__gemm_8cpp.html#a37a83060ac796961b44991c836f083f7">B</a>)</div>
<div class="line"><a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a4e249d464ae215ce0d4d53e0b369ab98">f3</a>(<a class="code hl_define" href="test__buffer__node_8cpp.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>)</div>
<div class="line">stopped</div>
<div class="ttc" id="abench__gemm_8cpp_html_a37a83060ac796961b44991c836f083f7"><div class="ttname"><a href="bench__gemm_8cpp.html#a37a83060ac796961b44991c836f083f7">B</a></div><div class="ttdeci">Matrix&lt; SCALARB, Dynamic, Dynamic &gt; B</div><div class="ttdef"><b>定义</b> bench_gemm.cpp:36</div></div>
<div class="ttc" id="abench__gemm_8cpp_html_addc86e8508f14411ec98f521c520f875"><div class="ttname"><a href="bench__gemm_8cpp.html#addc86e8508f14411ec98f521c520f875">A</a></div><div class="ttdeci">Matrix&lt; SCALARA, Dynamic, Dynamic &gt; A</div><div class="ttdef"><b>定义</b> bench_gemm.cpp:35</div></div>
<div class="ttc" id="atest__buffer__node_8cpp_html_ac4cf4b2ab929bd23951a8676eeac086b"><div class="ttname"><a href="test__buffer__node_8cpp.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a></div><div class="ttdeci">#define C</div><div class="ttdef"><b>定义</b> test_buffer_node.cpp:28</div></div>
</div><!-- fragment --><h1><a class="anchor" id="GraphPipelineReference"></a>
Reference</h1>
<p>We have applied the graph processing pipeline technique to speed up a circuit analysis problem. Details can be referred to our publication below:</p>
<ul>
<li>Cheng-Hsiang Chiu and Tsung-Wei Huang, &quot;<a href="https://tsung-wei-huang.github.io/papers/dac2022.pdf">Efficient Timing Propagation with Simultaneous Structural and Pipeline Parallelisms</a>,&quot; <em>ACM/IEEE Design Automation Conference (DAC)</em>, San Francisco, CA, 2022 </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">制作者 <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
