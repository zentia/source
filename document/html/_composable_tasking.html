<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>source: Composable Tasking</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">source
   </div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="搜索" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- 制作者 Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('_composable_tasking.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">载入中...</div>
<div class="SRStatus" id="Searching">搜索中...</div>
<div class="SRStatus" id="NoMatches">未找到</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Composable Tasking</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>目录</h3>
<ul>
  <li class="level1">
    <a href="#ComposeATaskflow">Compose a Taskflow</a>
  </li>
  <li class="level1">
    <a href="#CreateAModuleTaskFromATaskflow">Create a Module Task from a Taskflow</a>
  </li>
  <li class="level1">
    <a href="#CreateACustomComposableGraph">Create a Custom Composable Graph</a>
  </li>
</ul>
</div>
<div class="textblock"><p>Composition is a key to improve the programmability of a complex workflow. This chapter describes how to create a large parallel graph through composition of modular and reusable blocks that are easier to optimize.</p>
<h1><a class="anchor" id="ComposeATaskflow"></a>
Compose a Taskflow</h1>
<p><a class="el" href="bench__gemm_8cpp.html#addc86e8508f14411ec98f521c520f875">A</a> powerful feature of <a class="el" href="classtf_1_1_taskflow.html" title="class to create a taskflow object">tf::Taskflow</a> is its <em>composable</em> interface. You can break down a large parallel workload into smaller pieces each designed to run a specific task dependency graph. This largely facilitates the <em>modularity</em> of writing a parallel task program.</p>
<div class="fragment"><div class="line"> 1: <span class="comment">// f1 has three independent tasks</span></div>
<div class="line"> 2: <a class="code hl_class" href="classtf_1_1_taskflow.html">tf::Taskflow</a> <a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a20ea9116f00e19915f910ca726f7518f">f1</a>;</div>
<div class="line"> 3: <a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a20ea9116f00e19915f910ca726f7518f">f1</a>.name(<span class="stringliteral">&quot;F1&quot;</span>);</div>
<div class="line"> 4: <a class="code hl_class" href="classtf_1_1_task.html">tf::Task</a> f1A = <a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a20ea9116f00e19915f910ca726f7518f">f1</a>.emplace([&amp;](){ std::cout &lt;&lt; <span class="stringliteral">&quot;F1 TaskA\n&quot;</span>; });</div>
<div class="line"> 5: <a class="code hl_class" href="classtf_1_1_task.html">tf::Task</a> f1B = <a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a20ea9116f00e19915f910ca726f7518f">f1</a>.emplace([&amp;](){ std::cout &lt;&lt; <span class="stringliteral">&quot;F1 TaskB\n&quot;</span>; });</div>
<div class="line"> 6: <a class="code hl_class" href="classtf_1_1_task.html">tf::Task</a> f1C = <a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a20ea9116f00e19915f910ca726f7518f">f1</a>.emplace([&amp;](){ std::cout &lt;&lt; <span class="stringliteral">&quot;F1 TaskC\n&quot;</span>; });</div>
<div class="line"> 7: </div>
<div class="line"> 8: f1A.<a class="code hl_function" href="classtf_1_1_task.html#a08ada0425b490997b6ff7f310107e5e3">name</a>(<span class="stringliteral">&quot;f1A&quot;</span>);</div>
<div class="line"> 9: f1B.<a class="code hl_function" href="classtf_1_1_task.html#a08ada0425b490997b6ff7f310107e5e3">name</a>(<span class="stringliteral">&quot;f1B&quot;</span>);</div>
<div class="line">10: f1C.<a class="code hl_function" href="classtf_1_1_task.html#a08ada0425b490997b6ff7f310107e5e3">name</a>(<span class="stringliteral">&quot;f1C&quot;</span>);</div>
<div class="line">11: f1A.<a class="code hl_function" href="classtf_1_1_task.html#a8c78c453295a553c1c016e4062da8588">precede</a>(f1C);</div>
<div class="line">12: f1B.<a class="code hl_function" href="classtf_1_1_task.html#a8c78c453295a553c1c016e4062da8588">precede</a>(f1C);</div>
<div class="line">13:</div>
<div class="line">14: <span class="comment">// f2A ---</span></div>
<div class="line">15: <span class="comment">//        |----&gt; f2C ----&gt; f1_module_task ----&gt; f2D</span></div>
<div class="line">16: <span class="comment">// f2B --- </span></div>
<div class="line">17: tf::Taskflow <a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a894124d17350678007462a79ecc7eb36">f2</a>;</div>
<div class="line">18: <a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a894124d17350678007462a79ecc7eb36">f2</a>.<a class="code hl_function" href="classtf_1_1_task.html#a08ada0425b490997b6ff7f310107e5e3">name</a>(<span class="stringliteral">&quot;F2&quot;</span>);</div>
<div class="line">19: tf::Task f2A = <a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a894124d17350678007462a79ecc7eb36">f2</a>.emplace([&amp;](){ std::cout &lt;&lt; <span class="stringliteral">&quot;  F2 TaskA\n&quot;</span>; });</div>
<div class="line">20: tf::Task f2B = <a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a894124d17350678007462a79ecc7eb36">f2</a>.emplace([&amp;](){ std::cout &lt;&lt; <span class="stringliteral">&quot;  F2 TaskB\n&quot;</span>; });</div>
<div class="line">21: tf::Task f2C = <a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a894124d17350678007462a79ecc7eb36">f2</a>.emplace([&amp;](){ std::cout &lt;&lt; <span class="stringliteral">&quot;  F2 TaskC\n&quot;</span>; });</div>
<div class="line">22: tf::Task f2D = <a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a894124d17350678007462a79ecc7eb36">f2</a>.emplace([&amp;](){ std::cout &lt;&lt; <span class="stringliteral">&quot;  F2 TaskD\n&quot;</span>; });</div>
<div class="line">23: </div>
<div class="line">24: f2A.<a class="code hl_function" href="classtf_1_1_task.html#a08ada0425b490997b6ff7f310107e5e3">name</a>(<span class="stringliteral">&quot;f2A&quot;</span>);</div>
<div class="line">25: f2B.<a class="code hl_function" href="classtf_1_1_task.html#a08ada0425b490997b6ff7f310107e5e3">name</a>(<span class="stringliteral">&quot;f2B&quot;</span>);</div>
<div class="line">26: f2C.<a class="code hl_function" href="classtf_1_1_task.html#a08ada0425b490997b6ff7f310107e5e3">name</a>(<span class="stringliteral">&quot;f2C&quot;</span>);</div>
<div class="line">27: f2D.<a class="code hl_function" href="classtf_1_1_task.html#a08ada0425b490997b6ff7f310107e5e3">name</a>(<span class="stringliteral">&quot;f2D&quot;</span>);</div>
<div class="line">28:</div>
<div class="line">29: f2A.<a class="code hl_function" href="classtf_1_1_task.html#a8c78c453295a553c1c016e4062da8588">precede</a>(f2C);</div>
<div class="line">30: f2B.<a class="code hl_function" href="classtf_1_1_task.html#a8c78c453295a553c1c016e4062da8588">precede</a>(f2C);</div>
<div class="line">31:</div>
<div class="line">32: tf::Task f1_module_task = <a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a894124d17350678007462a79ecc7eb36">f2</a>.<a class="code hl_function" href="classtf_1_1_task.html#ab38be520fe700cb4ca1f312308a95585">composed_of</a>(<a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a20ea9116f00e19915f910ca726f7518f">f1</a>).<a class="code hl_function" href="classtf_1_1_task.html#a08ada0425b490997b6ff7f310107e5e3">name</a>(<span class="stringliteral">&quot;module&quot;</span>);</div>
<div class="line">33: f2C.<a class="code hl_function" href="classtf_1_1_task.html#a8c78c453295a553c1c016e4062da8588">precede</a>(f1_module_task);</div>
<div class="line">34: f1_module_task.<a class="code hl_function" href="classtf_1_1_task.html#a8c78c453295a553c1c016e4062da8588">precede</a>(f2D);</div>
<div class="line">35:</div>
<div class="line">36: <a class="code hl_function" href="parallel__graph__pipeline_8cpp.html#a894124d17350678007462a79ecc7eb36">f2</a>.<a class="code hl_function" href="classtf_1_1_task.html#a3318a49ff9d0a01cd1e8ee675251e3b7">dump</a>(std::cout);</div>
<div class="ttc" id="aclasstf_1_1_task_html"><div class="ttname"><a href="classtf_1_1_task.html">tf::Task</a></div><div class="ttdoc">class to create a task handle over a node in a taskflow graph</div><div class="ttdef"><b>定义</b> task.hpp:150</div></div>
<div class="ttc" id="aclasstf_1_1_task_html_a08ada0425b490997b6ff7f310107e5e3"><div class="ttname"><a href="classtf_1_1_task.html#a08ada0425b490997b6ff7f310107e5e3">tf::Task::name</a></div><div class="ttdeci">const std::string &amp; name() const</div><div class="ttdoc">queries the name of the task</div><div class="ttdef"><b>定义</b> task.hpp:502</div></div>
<div class="ttc" id="aclasstf_1_1_task_html_a3318a49ff9d0a01cd1e8ee675251e3b7"><div class="ttname"><a href="classtf_1_1_task.html#a3318a49ff9d0a01cd1e8ee675251e3b7">tf::Task::dump</a></div><div class="ttdeci">void dump(std::ostream &amp;ostream) const</div><div class="ttdoc">dumps the task through an output stream</div><div class="ttdef"><b>定义</b> task.hpp:581</div></div>
<div class="ttc" id="aclasstf_1_1_task_html_a8c78c453295a553c1c016e4062da8588"><div class="ttname"><a href="classtf_1_1_task.html#a8c78c453295a553c1c016e4062da8588">tf::Task::precede</a></div><div class="ttdeci">Task &amp; precede(Ts &amp;&amp;... tasks)</div><div class="ttdoc">adds precedence links from this to other tasks</div><div class="ttdef"><b>定义</b> task.hpp:394</div></div>
<div class="ttc" id="aclasstf_1_1_task_html_ab38be520fe700cb4ca1f312308a95585"><div class="ttname"><a href="classtf_1_1_task.html#ab38be520fe700cb4ca1f312308a95585">tf::Task::composed_of</a></div><div class="ttdeci">Task &amp; composed_of(T &amp;object)</div><div class="ttdoc">creates a module task from a taskflow</div><div class="ttdef"><b>定义</b> task.hpp:410</div></div>
<div class="ttc" id="aclasstf_1_1_taskflow_html"><div class="ttname"><a href="classtf_1_1_taskflow.html">tf::Taskflow</a></div><div class="ttdoc">class to create a taskflow object</div><div class="ttdef"><b>定义</b> taskflow.hpp:67</div></div>
<div class="ttc" id="aparallel__graph__pipeline_8cpp_html_a20ea9116f00e19915f910ca726f7518f"><div class="ttname"><a href="parallel__graph__pipeline_8cpp.html#a20ea9116f00e19915f910ca726f7518f">f1</a></div><div class="ttdeci">void f1(const std::string &amp;node)</div><div class="ttdef"><b>定义</b> parallel_graph_pipeline.cpp:8</div></div>
<div class="ttc" id="aparallel__graph__pipeline_8cpp_html_a894124d17350678007462a79ecc7eb36"><div class="ttname"><a href="parallel__graph__pipeline_8cpp.html#a894124d17350678007462a79ecc7eb36">f2</a></div><div class="ttdeci">void f2(const std::string &amp;node)</div><div class="ttdef"><b>定义</b> parallel_graph_pipeline.cpp:13</div></div>
</div><!-- fragment --><p>Debrief:</p>
<ul>
<li>Lines 1-12 create a taskflow of three tasks f1A, f1B, and f1C with f1A and f1B preceding f1C </li>
<li>Lines 17-30 create a taskflow of four tasks f2A, f2B, f2C, and f2D </li>
<li>Line 32 creates a module task from taskflow f1 through the method <a class="el" href="classtf_1_1_flow_builder.html#ac6f22228d4c2ea2e643c4b0d42c0e92a" title="creates a module task for the target object">Taskflow::composed_of</a> </li>
<li>Line 33 enforces task f2C to run before the module task </li>
<li>Line 34 enforces the module task to run before task f2D</li>
</ul>
<h1><a class="anchor" id="CreateAModuleTaskFromATaskflow"></a>
Create a Module Task from a Taskflow</h1>
<p>The task created from <a class="el" href="classtf_1_1_flow_builder.html#ac6f22228d4c2ea2e643c4b0d42c0e92a" title="creates a module task for the target object">Taskflow::composed_of</a> is a <em>module</em> task that runs on a pre-defined taskflow. <a class="el" href="bench__gemm_8cpp.html#addc86e8508f14411ec98f521c520f875">A</a> module task does not own the taskflow but maintains a soft mapping to the taskflow. You can create multiple module tasks from the same taskflow but only one module task can run at one time. For example, the following composition is valid. Even though the two module tasks <code>module1</code> and <code>module2</code> refer to the same taskflow <code>F1</code>, the dependency link prevents <code>F1</code> from multiple executions at the same time.</p>
<p>However, the following composition is <em>invalid</em>. Both module tasks refer to the same taskflow. They can not run at the same time because they are associated with the same graph.</p>
<h1><a class="anchor" id="CreateACustomComposableGraph"></a>
Create a Custom Composable Graph</h1>
<p>Taskflow allows you to create a custom graph object that can participate in the scheduling using composition. To become a module task, your class <code>T</code> must define the method <code>T::graph()</code> that returns a reference to the <a class="el" href="classtf_1_1_graph.html" title="class to create a graph object">tf::Graph</a> object managed by <code>T</code>. The following example defines a custom graph object that can be assembled in a taskflow throw composition:</p>
<div class="fragment"><div class="line"> 1: <span class="keyword">struct </span>CustomGraph {</div>
<div class="line"> 2:   <a class="code hl_class" href="classtf_1_1_graph.html">tf::Graph</a> graph;</div>
<div class="line"> 3:   CustomGraph() {</div>
<div class="line"> 4:     <a class="code hl_class" href="classtf_1_1_flow_builder.html">tf::FlowBuilder</a> builder(graph);  <span class="comment">// inherit all task builders in tf::Taskflow</span></div>
<div class="line"> 5:     <a class="code hl_class" href="classtf_1_1_task.html">tf::Task</a> <a class="code hl_define" href="test__partitioner__whitebox_8h.html#a5c4cf3d37a4eee22275de22cb9619863">task</a> = builder.emplace([](){</div>
<div class="line"> 6:       std::cout &lt;&lt; <span class="stringliteral">&quot;a task\n&quot;</span>;  <span class="comment">// static task</span></div>
<div class="line"> 7:     });</div>
<div class="line"> 8:   }</div>
<div class="line"> 9:   <span class="comment">// returns a reference to the graph for taskflow composition</span></div>
<div class="line">10:   <a class="code hl_class" href="class_graph.html">Graph</a>&amp; graph() { <span class="keywordflow">return</span> graph; }</div>
<div class="line">11: };</div>
<div class="line">12:</div>
<div class="line">13: CustomGraph obj;</div>
<div class="line">14: tf::Task <a class="code hl_function" href="external_2taskflow_2sandbox_2jacobi_2main_8cpp.html#aaa178026ff13e667efcb0104a55252e7">comp</a> = <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.composed_of(obj);</div>
<div class="ttc" id="aclass_graph_html"><div class="ttname"><a href="class_graph.html">Graph</a></div><div class="ttdoc">A directed graph where the vertices are Cells.</div><div class="ttdef"><b>定义</b> Graph.h:67</div></div>
<div class="ttc" id="aclasstf_1_1_flow_builder_html"><div class="ttname"><a href="classtf_1_1_flow_builder.html">tf::FlowBuilder</a></div><div class="ttdoc">class to build a task dependency graph</div><div class="ttdef"><b>定义</b> flow_builder.hpp:22</div></div>
<div class="ttc" id="aclasstf_1_1_graph_html"><div class="ttname"><a href="classtf_1_1_graph.html">tf::Graph</a></div><div class="ttdoc">class to create a graph object</div><div class="ttdef"><b>定义</b> graph.hpp:50</div></div>
<div class="ttc" id="aexternal_2taskflow_2sandbox_2jacobi_2main_8cpp_html_aaa178026ff13e667efcb0104a55252e7"><div class="ttname"><a href="external_2taskflow_2sandbox_2jacobi_2main_8cpp.html#aaa178026ff13e667efcb0104a55252e7">comp</a></div><div class="ttdeci">int comp(const void *elem1, const void *elem2)</div><div class="ttdef"><b>定义</b> main.cpp:16</div></div>
<div class="ttc" id="apoisson_8hpp_html_aa56fe360bb0ae38e0082f49e394ff825"><div class="ttname"><a href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a></div><div class="ttdeci">void taskflow(int nx, int ny, double dx, double dy, double *f, int itold, int itnew, double *u, double *unew, int block_size, unsigned num_threads)</div><div class="ttdef"><b>定义</b> taskflow.cpp:6</div></div>
<div class="ttc" id="atest__partitioner__whitebox_8h_html_a5c4cf3d37a4eee22275de22cb9619863"><div class="ttname"><a href="test__partitioner__whitebox_8h.html#a5c4cf3d37a4eee22275de22cb9619863">task</a></div><div class="ttdeci">#define task</div><div class="ttdef"><b>定义</b> test_partitioner_whitebox.h:76</div></div>
</div><!-- fragment --><p>Debrief:</p><ul>
<li>Lines 1-11 define a custom graph interface to participate in taskflow composition</li>
<li>Line 2 defines the graph object using <a class="el" href="classtf_1_1_graph.html" title="class to create a graph object">tf::Graph</a></li>
<li>Lines 3-8 defines the constructor that constructs the task graph using <a class="el" href="classtf_1_1_flow_builder.html" title="class to build a task dependency graph">tf::FlowBuilder</a></li>
<li>Line 10 defines the required method for taskflow composition</li>
<li>Lines 13-14 creates a module task for the declared graph object in the taskflow</li>
</ul>
<p>The composition method <a class="el" href="classtf_1_1_flow_builder.html#ac6f22228d4c2ea2e643c4b0d42c0e92a" title="creates a module task for the target object">tf::Taskflow::composed_of</a> requires the target to define the <code>graph()</code> method that returns a reference to a <a class="el" href="classtf_1_1_graph.html" title="class to create a graph object">tf::Graph</a> object defined by the target. At runtime, the executor will schedule tasks in that graph using the same work-stealing algorithm as other taskflows.</p>
<dl class="section attention"><dt>注意</dt><dd>Users are responsible for ensuring the given target remains valid throughout its execution. The executor does not assume ownership of the target object. </dd></dl>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">制作者 <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
