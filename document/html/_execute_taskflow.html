<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>source: Executor</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">source
   </div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="搜索" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- 制作者 Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('_execute_taskflow.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">载入中...</div>
<div class="SRStatus" id="Searching">搜索中...</div>
<div class="SRStatus" id="NoMatches">未找到</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Executor</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>目录</h3>
<ul>
  <li class="level1">
    <a href="#CreateAnExecutor">Create an Executor</a>
  </li>
  <li class="level1">
    <a href="#ExecuteATaskflow">Execute a Taskflow</a>
  </li>
  <li class="level1">
    <a href="#ExecuteATaskflowWithTransferredOwnership">Execute a Taskflow with Transferred Ownership</a>
  </li>
  <li class="level1">
    <a href="#ExecuteATaskflowFromAnInternalWorker">Execute a Taskflow from an Internal Worker</a>
  </li>
  <li class="level1">
    <a href="#ThreadSafety">Touch an Executor from Multiple Threads</a>
  </li>
  <li class="level1">
    <a href="#QueryTheWorkerID">Query the Worker ID</a>
  </li>
  <li class="level1">
    <a href="#ObserveThreadActivities">Observe Thread Activities</a>
  </li>
  <li class="level1">
    <a href="#ModifyWorkerProperty">Modify Worker Property</a>
  </li>
</ul>
</div>
<div class="textblock"><p>After you create a task dependency graph, you need to submit it to threads for execution. In this chapter, we will show you how to execute a task dependency graph.</p>
<h1><a class="anchor" id="CreateAnExecutor"></a>
Create an Executor</h1>
<p>To execute a taskflow, you need to create an <em>executor</em> of type <a class="el" href="classtf_1_1_executor.html" title="class to create an executor for running a taskflow graph">tf::Executor</a>. An executor is a <em>thread-safe</em> object that manages a set of worker threads and executes tasks through an efficient <em>work-stealing</em> algorithm. Issuing a call to run a taskflow creates a <em>topology</em>, a data structure to keep track of the execution status of a running graph. <a class="el" href="classtf_1_1_executor.html" title="class to create an executor for running a taskflow graph">tf::Executor</a> takes an unsigned integer to construct with <code>N</code> worker threads. The default value is std::thread::hardware_concurrency.</p>
<div class="fragment"><div class="line"><a class="code hl_class" href="classtf_1_1_executor.html">tf::Executor</a> executor1;     <span class="comment">// create an executor with the number of workers</span></div>
<div class="line">                            <span class="comment">// equal to std::thread::hardware_concurrency</span></div>
<div class="line"><a class="code hl_class" href="classtf_1_1_executor.html">tf::Executor</a> executor2(4);  <span class="comment">// create an executor of 4 worker threads</span></div>
<div class="ttc" id="aclasstf_1_1_executor_html"><div class="ttname"><a href="classtf_1_1_executor.html">tf::Executor</a></div><div class="ttdoc">class to create an executor for running a taskflow graph</div><div class="ttdef"><b>定义</b> executor-dl.hpp:51</div></div>
</div><!-- fragment --><p>An executor can be reused to execute multiple taskflows. In most workloads, you may need only one executor to run multiple taskflows where each taskflow represents a part of a parallel decomposition.</p>
<h1><a class="anchor" id="ExecuteATaskflow"></a>
Execute a Taskflow</h1>
<p><a class="el" href="classtf_1_1_executor.html" title="class to create an executor for running a taskflow graph">tf::Executor</a> provides a set of <code>run_*</code> methods, <a class="el" href="classtf_1_1_executor.html#a519777f5783981d534e9e53b99712069" title="runs a taskflow once">tf::Executor::run</a>, <a class="el" href="classtf_1_1_executor.html#a6d0617eebc9421f1ba1f82ce6dd02c00" title="runs a taskflow for N times">tf::Executor::run_n</a>, and <a class="el" href="classtf_1_1_executor.html#a0f52e9dd64b65aba32ca0e13c1ed300a" title="runs a taskflow multiple times until the predicate becomes true">tf::Executor::run_until</a> to run a taskflow for one time, multiple times, or until a given predicate evaluates to true. All methods accept an optional callback to invoke after the execution completes, and return a <a class="el" href="classtf_1_1_future.html" title="class to access the result of an execution">tf::Future</a> for users to access the execution status. The code below shows several ways to run a taskflow.</p>
<div class="fragment"><div class="line"> 1: <span class="comment">// Declare an executor and a taskflow</span></div>
<div class="line"> 2: <a class="code hl_class" href="classtf_1_1_executor.html">tf::Executor</a> <a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>;</div>
<div class="line"> 3: <a class="code hl_class" href="classtf_1_1_taskflow.html">tf::Taskflow</a> <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>;</div>
<div class="line"> 4:</div>
<div class="line"> 5: <span class="comment">// Add three tasks into the taskflow</span></div>
<div class="line"> 6: <a class="code hl_class" href="classtf_1_1_task.html">tf::Task</a> <a class="code hl_typedef" href="bench__gemm_8cpp.html#addc86e8508f14411ec98f521c520f875">A</a> = <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.emplace([] () { std::cout &lt;&lt; <span class="stringliteral">&quot;This is TaskA\n&quot;</span>; });</div>
<div class="line"> 7: <a class="code hl_class" href="classtf_1_1_task.html">tf::Task</a> <a class="code hl_typedef" href="bench__gemm_8cpp.html#a37a83060ac796961b44991c836f083f7">B</a> = <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.emplace([] () { std::cout &lt;&lt; <span class="stringliteral">&quot;This is TaskB\n&quot;</span>; });</div>
<div class="line"> 8: <a class="code hl_class" href="classtf_1_1_task.html">tf::Task</a> <a class="code hl_define" href="test__buffer__node_8cpp.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a> = <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.emplace([] () { std::cout &lt;&lt; <span class="stringliteral">&quot;This is TaskC\n&quot;</span>; });</div>
<div class="line"> 9: </div>
<div class="line">10: <span class="comment">// Build precedence between tasks</span></div>
<div class="line">11: <a class="code hl_typedef" href="bench__gemm_8cpp.html#addc86e8508f14411ec98f521c520f875">A</a>.precede(<a class="code hl_typedef" href="bench__gemm_8cpp.html#a37a83060ac796961b44991c836f083f7">B</a>, <a class="code hl_define" href="test__buffer__node_8cpp.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>); </div>
<div class="line">12: </div>
<div class="line">13: tf::Future&lt;void&gt; fu = <a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.<a class="code hl_function" href="classtf_1_1_executor.html#a519777f5783981d534e9e53b99712069">run</a>(<a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>);</div>
<div class="line">14: fu.wait();                <span class="comment">// block until the execution completes</span></div>
<div class="line">15:</div>
<div class="line">16: <a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.<a class="code hl_function" href="classtf_1_1_executor.html#a519777f5783981d534e9e53b99712069">run</a>(<a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>, [](){ std::cout &lt;&lt; <span class="stringliteral">&quot;end of 1 run&quot;</span>; }).wait();</div>
<div class="line">17: <a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.<a class="code hl_function" href="classtf_1_1_executor.html#a6d0617eebc9421f1ba1f82ce6dd02c00">run_n</a>(<a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>, 4);</div>
<div class="line">18: <a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.<a class="code hl_function" href="classtf_1_1_executor.html#ab9aa252f70e9a40020a1e5a89d485b85">wait_for_all</a>();  <span class="comment">// block until all associated executions finish</span></div>
<div class="line">19: <a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.<a class="code hl_function" href="classtf_1_1_executor.html#a6d0617eebc9421f1ba1f82ce6dd02c00">run_n</a>(<a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>, 4, [](){ std::cout &lt;&lt; <span class="stringliteral">&quot;end of 4 runs&quot;</span>; }).wait();</div>
<div class="line">20: <a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.<a class="code hl_function" href="classtf_1_1_executor.html#a0f52e9dd64b65aba32ca0e13c1ed300a">run_until</a>(<a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>, [cnt=0] () <span class="keyword">mutable</span> { <span class="keywordflow">return</span> ++cnt == 10; });</div>
<div class="ttc" id="abench__gemm_8cpp_html_a37a83060ac796961b44991c836f083f7"><div class="ttname"><a href="bench__gemm_8cpp.html#a37a83060ac796961b44991c836f083f7">B</a></div><div class="ttdeci">Matrix&lt; SCALARB, Dynamic, Dynamic &gt; B</div><div class="ttdef"><b>定义</b> bench_gemm.cpp:36</div></div>
<div class="ttc" id="abench__gemm_8cpp_html_addc86e8508f14411ec98f521c520f875"><div class="ttname"><a href="bench__gemm_8cpp.html#addc86e8508f14411ec98f521c520f875">A</a></div><div class="ttdeci">Matrix&lt; SCALARA, Dynamic, Dynamic &gt; A</div><div class="ttdef"><b>定义</b> bench_gemm.cpp:35</div></div>
<div class="ttc" id="aclasstf_1_1_executor_html_a0f52e9dd64b65aba32ca0e13c1ed300a"><div class="ttname"><a href="classtf_1_1_executor.html#a0f52e9dd64b65aba32ca0e13c1ed300a">tf::Executor::run_until</a></div><div class="ttdeci">tf::Future&lt; void &gt; run_until(Taskflow &amp;taskflow, P &amp;&amp;pred)</div><div class="ttdoc">runs a taskflow multiple times until the predicate becomes true</div><div class="ttdef"><b>定义</b> executor-dl.hpp:2116</div></div>
<div class="ttc" id="aclasstf_1_1_executor_html_a519777f5783981d534e9e53b99712069"><div class="ttname"><a href="classtf_1_1_executor.html#a519777f5783981d534e9e53b99712069">tf::Executor::run</a></div><div class="ttdeci">tf::Future&lt; void &gt; run(Taskflow &amp;taskflow)</div><div class="ttdoc">runs a taskflow once</div><div class="ttdef"><b>定义</b> executor-dl.hpp:2067</div></div>
<div class="ttc" id="aclasstf_1_1_executor_html_a6d0617eebc9421f1ba1f82ce6dd02c00"><div class="ttname"><a href="classtf_1_1_executor.html#a6d0617eebc9421f1ba1f82ce6dd02c00">tf::Executor::run_n</a></div><div class="ttdeci">tf::Future&lt; void &gt; run_n(Taskflow &amp;taskflow, size_t N)</div><div class="ttdoc">runs a taskflow for N times</div><div class="ttdef"><b>定义</b> executor-dl.hpp:2089</div></div>
<div class="ttc" id="aclasstf_1_1_executor_html_ab9aa252f70e9a40020a1e5a89d485b85"><div class="ttname"><a href="classtf_1_1_executor.html#ab9aa252f70e9a40020a1e5a89d485b85">tf::Executor::wait_for_all</a></div><div class="ttdeci">void wait_for_all()</div><div class="ttdoc">waits for all tasks to complete</div><div class="ttdef"><b>定义</b> executor-dl.hpp:2237</div></div>
<div class="ttc" id="aclasstf_1_1_task_html"><div class="ttname"><a href="classtf_1_1_task.html">tf::Task</a></div><div class="ttdoc">class to create a task handle over a node in a taskflow graph</div><div class="ttdef"><b>定义</b> task.hpp:150</div></div>
<div class="ttc" id="aclasstf_1_1_taskflow_html"><div class="ttname"><a href="classtf_1_1_taskflow.html">tf::Taskflow</a></div><div class="ttdoc">class to create a taskflow object</div><div class="ttdef"><b>定义</b> taskflow.hpp:67</div></div>
<div class="ttc" id="apoisson_8hpp_html_aa56fe360bb0ae38e0082f49e394ff825"><div class="ttname"><a href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a></div><div class="ttdeci">void taskflow(int nx, int ny, double dx, double dy, double *f, int itold, int itnew, double *u, double *unew, int block_size, unsigned num_threads)</div><div class="ttdef"><b>定义</b> taskflow.cpp:6</div></div>
<div class="ttc" id="atest__buffer__node_8cpp_html_ac4cf4b2ab929bd23951a8676eeac086b"><div class="ttname"><a href="test__buffer__node_8cpp.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a></div><div class="ttdeci">#define C</div><div class="ttdef"><b>定义</b> test_buffer_node.cpp:28</div></div>
<div class="ttc" id="athread__pool_8cpp_html_a543e564a8407bbeac15cb2d929fec755"><div class="ttname"><a href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a></div><div class="ttdeci">tf::Executor executor</div><div class="ttdef"><b>定义</b> thread_pool.cpp:6</div></div>
</div><!-- fragment --><p>Debrief:</p>
<ul>
<li>Lines 6-8 create a taskflow of three tasks <a class="el" href="bench__gemm_8cpp.html#addc86e8508f14411ec98f521c520f875">A</a>, <a class="el" href="bench__gemm_8cpp.html#a37a83060ac796961b44991c836f083f7">B</a>, and C </li>
<li>Lines 13-14 run the taskflow once and wait for completion </li>
<li>Line 16 runs the taskflow once with a callback to invoke when the execution finishes </li>
<li>Lines 17-18 run the taskflow four times and use <a class="el" href="classtf_1_1_executor.html#ab9aa252f70e9a40020a1e5a89d485b85" title="waits for all tasks to complete">tf::Executor::wait_for_all</a> to wait for completion </li>
<li>Line 19 runs the taskflow four times and invokes a callback at the end of the fourth execution </li>
<li>Line 20 keeps running the taskflow until the predicate returns true</li>
</ul>
<p>Issuing multiple runs on the same taskflow will automatically <em>synchronize</em> to a sequential chain of executions in the order of run calls.</p>
<div class="fragment"><div class="line"><a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.run(<a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>);         <span class="comment">// execution 1</span></div>
<div class="line"><a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.run_n(<a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>, 10);   <span class="comment">// execution 2</span></div>
<div class="line"><a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.run(<a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>);         <span class="comment">// execution 3</span></div>
<div class="line"><a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.wait_for_all();        <span class="comment">// execution 1 -&gt; execution 2 -&gt; execution 3</span></div>
</div><!-- fragment --><dl class="section attention"><dt>注意</dt><dd><a class="el" href="bench__gemm_8cpp.html#addc86e8508f14411ec98f521c520f875">A</a> running taskflow must remain alive during its execution. It is your responsibility to ensure a taskflow not being destructed when it is running. For example, the code below can result undefined behavior.</dd></dl>
<div class="fragment"><div class="line"><a class="code hl_class" href="classtf_1_1_executor.html">tf::Executor</a> <a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>;  <span class="comment">// create an executor</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// create a taskflow whose lifetime is restricted by the scope</span></div>
<div class="line">{</div>
<div class="line">  <a class="code hl_class" href="classtf_1_1_taskflow.html">tf::Taskflow</a> <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>;</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// add tasks to the taskflow</span></div>
<div class="line">  <span class="comment">// ... </span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">// run the taskflow</span></div>
<div class="line">  <a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.run(<a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>);</div>
<div class="line"> </div>
<div class="line">} <span class="comment">// leaving the scope will destroy taskflow while it is running, </span></div>
<div class="line">  <span class="comment">// resulting in undefined behavior</span></div>
</div><!-- fragment --><p>Similarly, you should avoid touching a taskflow while it is running.</p>
<div class="fragment"><div class="line"><a class="code hl_class" href="classtf_1_1_taskflow.html">tf::Taskflow</a> <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Add tasks into the taskflow</span></div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Declare an executor</span></div>
<div class="line"><a class="code hl_class" href="classtf_1_1_executor.html">tf::Executor</a> <a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>;</div>
<div class="line"> </div>
<div class="line"><a class="code hl_class" href="classtf_1_1_future.html">tf::Future&lt;void&gt;</a> future = <a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.run(<a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>);  <span class="comment">// non-blocking return</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// alter the taskflow while running leads to undefined behavior </span></div>
<div class="line"><a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.emplace([](){ std::cout &lt;&lt; <span class="stringliteral">&quot;Add a new task\n&quot;</span>; });</div>
<div class="ttc" id="aclasstf_1_1_future_html"><div class="ttname"><a href="classtf_1_1_future.html">tf::Future</a></div><div class="ttdoc">class to access the result of an execution</div><div class="ttdef"><b>定义</b> taskflow.hpp:573</div></div>
</div><!-- fragment --><p>You must always keep a taskflow alive and must not modify it while it is running on an executor.</p>
<h1><a class="anchor" id="ExecuteATaskflowWithTransferredOwnership"></a>
Execute a Taskflow with Transferred Ownership</h1>
<p>You can transfer the ownership of a taskflow to an executor and run it without wrangling with the lifetime issue of that taskflow. Each <code>run_*</code> method discussed in the previous section comes with an overload that takes a <em>moved</em> taskflow object.</p>
<div class="fragment"><div class="line"><a class="code hl_class" href="classtf_1_1_taskflow.html">tf::Taskflow</a> <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>;</div>
<div class="line"><a class="code hl_class" href="classtf_1_1_executor.html">tf::Executor</a> <a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>;</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.emplace([](){});</div>
<div class="line"> </div>
<div class="line"><span class="comment">// let the executor manage the lifetime of the submitted taskflow</span></div>
<div class="line"><a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.run(std::move(<a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>));</div>
<div class="line"> </div>
<div class="line"><span class="comment">// now taskflow has no tasks</span></div>
<div class="line">assert(<a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.num_tasks() == 0);</div>
</div><!-- fragment --><p>However, you should avoid moving a <em>running</em> taskflow which can result in undefined behavior.</p>
<div class="fragment"><div class="line"><a class="code hl_class" href="classtf_1_1_taskflow.html">tf::Taskflow</a> <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>;</div>
<div class="line"><a class="code hl_class" href="classtf_1_1_executor.html">tf::Executor</a> <a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>;</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.emplace([](){});</div>
<div class="line"> </div>
<div class="line"><span class="comment">// executor does not manage the lifetime of taskflow</span></div>
<div class="line"><a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.run(<a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// error! you cannot move a taskflow while it is running</span></div>
<div class="line"><a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.run(std::move(<a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>));  </div>
</div><!-- fragment --><p>The correct way to submit a taskflow with moved ownership to an executor is to ensure all previous runs have completed. The executor will automatically release the resources of a moved taskflow right <em>after</em> its execution completes.</p>
<div class="fragment"><div class="line"><span class="comment">// submit the taskflow and wait until it completes</span></div>
<div class="line"><a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.run(<a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>).wait();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// now it&#39;s safe to move the taskflow to the executor and run it</span></div>
<div class="line"><a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.run(std::move(<a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>));  </div>
</div><!-- fragment --><p>Likewise, you cannot move a taskflow that is running on an executor. You must wait until all the previous fires of runs on that taskflow complete before calling move.</p>
<div class="fragment"><div class="line"><span class="comment">// submit the taskflow and wait until it completes</span></div>
<div class="line"><a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.run(<a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>).wait();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// now it&#39;s safe to move the taskflow to another</span></div>
<div class="line"><a class="code hl_class" href="classtf_1_1_taskflow.html">tf::Taskflow</a> moved_taskflow(std::move(<a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>));  </div>
</div><!-- fragment --><h1><a class="anchor" id="ExecuteATaskflowFromAnInternalWorker"></a>
Execute a Taskflow from an Internal Worker</h1>
<p>Each run variant of <a class="el" href="classtf_1_1_executor.html" title="class to create an executor for running a taskflow graph">tf::Executor</a> returns a <a class="el" href="classtf_1_1_future.html" title="class to access the result of an execution">tf::Future</a> object which allows you to wait for the result to complete. When calling <code>tf::Future::wait</code>, the caller blocks without doing anything until the associated state is written to be ready. This design, however, can introduce deadlock problem especially when you need to run multiple taskflows from the internal workers of an executor. For example, the code below creates a taskflow of 1000 tasks with each task running a taskflow of 500 tasks in a blocking fashion:</p>
<div class="fragment"><div class="line"><a class="code hl_class" href="classtf_1_1_executor.html">tf::Executor</a> <a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>(2);</div>
<div class="line"><a class="code hl_class" href="classtf_1_1_taskflow.html">tf::Taskflow</a> <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>;</div>
<div class="line">std::array&lt;tf::Taskflow, 1000&gt; others;</div>
<div class="line"> </div>
<div class="line">std::atomic&lt;size_t&gt; <a class="code hl_variable" href="events_8c.html#ac6c464b0a83a481fee26175f6229c5cc">counter</a>{0};</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> <a class="code hl_variable" href="_bi_c_g_s_t_a_b__simple_8cpp.html#a5150192f625f4d7970d61169b9567f39">n</a>=0; <a class="code hl_variable" href="_bi_c_g_s_t_a_b__simple_8cpp.html#a5150192f625f4d7970d61169b9567f39">n</a>&lt;1000; <a class="code hl_variable" href="_bi_c_g_s_t_a_b__simple_8cpp.html#a5150192f625f4d7970d61169b9567f39">n</a>++) {</div>
<div class="line">  <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> <a class="code hl_variable" href="_bi_c_g_s_t_a_b__step__by__step_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a>=0; <a class="code hl_variable" href="_bi_c_g_s_t_a_b__step__by__step_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;500; <a class="code hl_variable" href="_bi_c_g_s_t_a_b__step__by__step_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div>
<div class="line">    others[<a class="code hl_variable" href="_bi_c_g_s_t_a_b__simple_8cpp.html#a5150192f625f4d7970d61169b9567f39">n</a>].emplace([&amp;](){ <a class="code hl_variable" href="events_8c.html#ac6c464b0a83a481fee26175f6229c5cc">counter</a>++; });</div>
<div class="line">  }</div>
<div class="line">  <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.emplace([&amp;<a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>, &amp;tf=others[<a class="code hl_variable" href="_bi_c_g_s_t_a_b__simple_8cpp.html#a5150192f625f4d7970d61169b9567f39">n</a>]](){</div>
<div class="line">    <span class="comment">// blocking the worker can introduce deadlock where</span></div>
<div class="line">    <span class="comment">// all workers are waiting for their taskflows to finish</span></div>
<div class="line">    <a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.<a class="code hl_function" href="classtf_1_1_executor.html#a519777f5783981d534e9e53b99712069">run</a>(tf).wait();</div>
<div class="line">  });</div>
<div class="line">}</div>
<div class="line"><a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.<a class="code hl_function" href="classtf_1_1_executor.html#a519777f5783981d534e9e53b99712069">run</a>(<a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>).wait();</div>
<div class="ttc" id="a_bi_c_g_s_t_a_b__simple_8cpp_html_a5150192f625f4d7970d61169b9567f39"><div class="ttname"><a href="_bi_c_g_s_t_a_b__simple_8cpp.html#a5150192f625f4d7970d61169b9567f39">n</a></div><div class="ttdeci">int n</div><div class="ttdef"><b>定义</b> BiCGSTAB_simple.cpp:1</div></div>
<div class="ttc" id="a_bi_c_g_s_t_a_b__step__by__step_8cpp_html_acb559820d9ca11295b4500f179ef6392"><div class="ttname"><a href="_bi_c_g_s_t_a_b__step__by__step_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a></div><div class="ttdeci">int i</div><div class="ttdef"><b>定义</b> BiCGSTAB_step_by_step.cpp:9</div></div>
<div class="ttc" id="aevents_8c_html_ac6c464b0a83a481fee26175f6229c5cc"><div class="ttname"><a href="events_8c.html#ac6c464b0a83a481fee26175f6229c5cc">counter</a></div><div class="ttdeci">static unsigned int counter</div><div class="ttdef"><b>定义</b> events.c:48</div></div>
</div><!-- fragment --><p>To avoid this problem, the executor has a method, <a class="el" href="classtf_1_1_executor.html#a8fcd9e0557922bb8194999f0cd433ea8" title="runs a target graph and waits until it completes using an internal worker of this executor">tf::Executor::corun</a>, to execute a taskflow from a worker of that executor. The worker will not block but co-run the taskflow with other tasks in its work-stealing loop.</p>
<div class="fragment"><div class="line"><a class="code hl_class" href="classtf_1_1_executor.html">tf::Executor</a> <a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>(2);</div>
<div class="line"><a class="code hl_class" href="classtf_1_1_taskflow.html">tf::Taskflow</a> <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>;</div>
<div class="line">std::array&lt;tf::Taskflow, 1000&gt; others;</div>
<div class="line"> </div>
<div class="line">std::atomic&lt;size_t&gt; <a class="code hl_variable" href="events_8c.html#ac6c464b0a83a481fee26175f6229c5cc">counter</a>{0};</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> <a class="code hl_variable" href="_bi_c_g_s_t_a_b__simple_8cpp.html#a5150192f625f4d7970d61169b9567f39">n</a>=0; <a class="code hl_variable" href="_bi_c_g_s_t_a_b__simple_8cpp.html#a5150192f625f4d7970d61169b9567f39">n</a>&lt;1000; <a class="code hl_variable" href="_bi_c_g_s_t_a_b__simple_8cpp.html#a5150192f625f4d7970d61169b9567f39">n</a>++) {</div>
<div class="line">  <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> <a class="code hl_variable" href="_bi_c_g_s_t_a_b__step__by__step_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a>=0; <a class="code hl_variable" href="_bi_c_g_s_t_a_b__step__by__step_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;500; <a class="code hl_variable" href="_bi_c_g_s_t_a_b__step__by__step_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div>
<div class="line">    others[<a class="code hl_variable" href="_bi_c_g_s_t_a_b__simple_8cpp.html#a5150192f625f4d7970d61169b9567f39">n</a>].emplace([&amp;](){ <a class="code hl_variable" href="events_8c.html#ac6c464b0a83a481fee26175f6229c5cc">counter</a>++; });</div>
<div class="line">  }</div>
<div class="line">  <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.emplace([&amp;<a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>, &amp;tf=others[<a class="code hl_variable" href="_bi_c_g_s_t_a_b__simple_8cpp.html#a5150192f625f4d7970d61169b9567f39">n</a>]](){</div>
<div class="line">    <span class="comment">// the caller worker will not block but corun these</span></div>
<div class="line">    <span class="comment">// taskflows through its work-stealing loop</span></div>
<div class="line">    <a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.<a class="code hl_function" href="classtf_1_1_executor.html#a8fcd9e0557922bb8194999f0cd433ea8">corun</a>(tf);</div>
<div class="line">  });</div>
<div class="line">}</div>
<div class="line"><a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.<a class="code hl_function" href="classtf_1_1_executor.html#a519777f5783981d534e9e53b99712069">run</a>(<a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>).wait();</div>
<div class="ttc" id="aclasstf_1_1_executor_html_a8fcd9e0557922bb8194999f0cd433ea8"><div class="ttname"><a href="classtf_1_1_executor.html#a8fcd9e0557922bb8194999f0cd433ea8">tf::Executor::corun</a></div><div class="ttdeci">void corun(T &amp;target)</div><div class="ttdoc">runs a target graph and waits until it completes using an internal worker of this executor</div><div class="ttdef"><b>定义</b> executor-dl.hpp:2184</div></div>
</div><!-- fragment --><p>Similar to <a class="el" href="classtf_1_1_executor.html#a8fcd9e0557922bb8194999f0cd433ea8" title="runs a target graph and waits until it completes using an internal worker of this executor">tf::Executor::corun</a>, the method <a class="el" href="classtf_1_1_executor.html#a0fc6eb19f168dc4a9cd0a7c6187c1d2d" title="keeps running the work-stealing loop until the predicate becomes true">tf::Executor::corun_until</a> is another variant that keeps the calling worker in the work-stealing loop until the given predicate becomes true. You can use this method to prevent blocking a worker from doing useful things, such as being blocked when submitting an outstanding task (e.g., a GPU operation).</p>
<div class="fragment"><div class="line"><a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.emplace([&amp;](){</div>
<div class="line">  <span class="keyword">auto</span> fu = std::async([](){ std::sleep(100<a class="code hl_variable" href="main-override_8cpp.html#a1384e7608274313a9433fa573868557b">s</a>); });</div>
<div class="line">  <a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.corun_until([](){</div>
<div class="line">    <span class="keywordflow">return</span> fu.wait_for(std::chrono::seconds(0)) == future_status::ready;</div>
<div class="line">  });</div>
<div class="line">});</div>
<div class="ttc" id="amain-override_8cpp_html_a1384e7608274313a9433fa573868557b"><div class="ttname"><a href="main-override_8cpp.html#a1384e7608274313a9433fa573868557b">s</a></div><div class="ttdeci">static Static s</div><div class="ttdef"><b>定义</b> main-override.cpp:135</div></div>
</div><!-- fragment --><dl class="section attention"><dt>注意</dt><dd>You must call <a class="el" href="classtf_1_1_executor.html#a0fc6eb19f168dc4a9cd0a7c6187c1d2d" title="keeps running the work-stealing loop until the predicate becomes true">tf::Executor::corun_until</a> and <a class="el" href="classtf_1_1_executor.html#a8fcd9e0557922bb8194999f0cd433ea8" title="runs a target graph and waits until it completes using an internal worker of this executor">tf::Executor::corun</a> from a worker of the calling executor or an exception will be thrown.</dd></dl>
<h1><a class="anchor" id="ThreadSafety"></a>
Touch an Executor from Multiple Threads</h1>
<p>All <code>run_*</code> methods are <em>thread-safe</em>. You can have multiple threads call these methods from an executor to run different taskflows. However, the order which taskflow runs first is non-deterministic and is up to the runtime.</p>
<div class="fragment"><div class="line"> 1: <a class="code hl_class" href="classtf_1_1_executor.html">tf::Executor</a> <a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>;</div>
<div class="line"> 2:</div>
<div class="line"> 3: <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code hl_variable" href="_bi_c_g_s_t_a_b__step__by__step_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a>=0; <a class="code hl_variable" href="_bi_c_g_s_t_a_b__step__by__step_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;10; ++<a class="code hl_variable" href="_bi_c_g_s_t_a_b__step__by__step_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a>) {</div>
<div class="line"> 4:   std::thread([<a class="code hl_variable" href="_bi_c_g_s_t_a_b__step__by__step_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a>, &amp;](){</div>
<div class="line"> 5:     <span class="comment">// ... modify my taskflow at i</span></div>
<div class="line"> 6:     <a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.run(taskflows[<a class="code hl_variable" href="_bi_c_g_s_t_a_b__step__by__step_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a>]);  <span class="comment">// run my taskflow at i</span></div>
<div class="line"> 7:   }).detach();</div>
<div class="line"> 8: }</div>
<div class="line"> 9:</div>
<div class="line">10: <a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.wait_for_all();</div>
</div><!-- fragment --><h1><a class="anchor" id="QueryTheWorkerID"></a>
Query the Worker ID</h1>
<p>Each worker in an executor has an unique integer identifier in the range <code>[0, N)</code> that can be queried by the caller thread using <a class="el" href="classtf_1_1_executor.html#a6487d589cb1f6b078b69fd3bb1082345" title="queries the id of the caller thread in this executor">tf::Executor::this_worker_id</a>. If the caller thread is not a worker in the executor, <code>-1</code> is returned. This method is convenient for users to maintain a one-to-one mapping between a worker and its application data structure.</p>
<div class="fragment"><div class="line">std::vector&lt;int&gt; worker_vectors[8];       <span class="comment">// one vector per worker</span></div>
<div class="line"> </div>
<div class="line"><a class="code hl_class" href="classtf_1_1_taskflow.html">tf::Taskflow</a> <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>;</div>
<div class="line"><a class="code hl_class" href="classtf_1_1_executor.html">tf::Executor</a> <a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>(8);                 <span class="comment">// an executor of eight workers</span></div>
<div class="line"> </div>
<div class="line">assert(<a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.this_worker_id() == -1);  <span class="comment">// master thread is not a worker</span></div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.emplace([&amp;](){</div>
<div class="line">  <span class="keywordtype">int</span> <span class="keywordtype">id</span> = <a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.this_worker_id();     <span class="comment">// in the range [0, 8)</span></div>
<div class="line">  <span class="keyword">auto</span>&amp; <a class="code hl_variable" href="benchmarks_2for__each_2for__each_8hpp.html#ad86cbaae2e3f21959301250e9f7c2701">vec</a> = worker_vectors[<a class="code hl_function" href="test__basics_8cpp.html#a4199986f3840a82e0749dab4781a5b2f">worker_id</a>];</div>
<div class="line">  <span class="comment">// ...</span></div>
<div class="line">});</div>
<div class="ttc" id="abenchmarks_2for__each_2for__each_8hpp_html_ad86cbaae2e3f21959301250e9f7c2701"><div class="ttname"><a href="benchmarks_2for__each_2for__each_8hpp.html#ad86cbaae2e3f21959301250e9f7c2701">vec</a></div><div class="ttdeci">std::vector&lt; double &gt; vec</div><div class="ttdef"><b>定义</b> for_each.hpp:14</div></div>
<div class="ttc" id="atest__basics_8cpp_html_a4199986f3840a82e0749dab4781a5b2f"><div class="ttname"><a href="test__basics_8cpp.html#a4199986f3840a82e0749dab4781a5b2f">worker_id</a></div><div class="ttdeci">void worker_id(unsigned w)</div><div class="ttdef"><b>定义</b> test_basics.cpp:706</div></div>
</div><!-- fragment --><h1><a class="anchor" id="ObserveThreadActivities"></a>
Observe Thread Activities</h1>
<p>You can observe thread activities in an executor when a worker thread participates in executing a task and leaves the execution using <a class="el" href="classtf_1_1_observer_interface.html" title="class to derive an executor observer">tf::ObserverInterface</a> &ndash; an <em>interface</em> class that provides a set of methods for you to define what to do when a thread enters and leaves the execution context of a task.</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>ObserverInterface {</div>
<div class="line">  <span class="keyword">virtual</span> <a class="code hl_function" href="classtf_1_1_observer_interface.html#adfd71c3af3ae2ea4f41eed26c1b6f604">~ObserverInterface</a>() = <span class="keywordflow">default</span>;</div>
<div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code hl_function" href="classtf_1_1_observer_interface.html#a41e6e62f12bf9d9dc4fa74632f6825d9">set_up</a>(<span class="keywordtype">size_t</span> num_workers) = 0;</div>
<div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code hl_function" href="classtf_1_1_observer_interface.html#a8225fcacb03089677a1efc4b16b734cc">on_entry</a>(<a class="code hl_class" href="classtf_1_1_worker_view.html">tf::WorkerView</a> worker_view, <a class="code hl_class" href="classtf_1_1_task_view.html">tf::TaskView</a> task_view) = 0;</div>
<div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code hl_function" href="classtf_1_1_observer_interface.html#aa22f5378154653f08d9a58326bda4754">on_exit</a>(<a class="code hl_class" href="classtf_1_1_worker_view.html">tf::WorkerView</a> worker_view, <a class="code hl_class" href="classtf_1_1_task_view.html">tf::TaskView</a> task_view) = 0;</div>
<div class="line">};</div>
<div class="ttc" id="aclasstf_1_1_observer_interface_html_a41e6e62f12bf9d9dc4fa74632f6825d9"><div class="ttname"><a href="classtf_1_1_observer_interface.html#a41e6e62f12bf9d9dc4fa74632f6825d9">tf::ObserverInterface::set_up</a></div><div class="ttdeci">virtual void set_up(size_t num_workers)=0</div><div class="ttdoc">constructor-like method to call when the executor observer is fully created</div></div>
<div class="ttc" id="aclasstf_1_1_observer_interface_html_a8225fcacb03089677a1efc4b16b734cc"><div class="ttname"><a href="classtf_1_1_observer_interface.html#a8225fcacb03089677a1efc4b16b734cc">tf::ObserverInterface::on_entry</a></div><div class="ttdeci">virtual void on_entry(WorkerView wv, TaskView task_view)=0</div><div class="ttdoc">method to call before a worker thread executes a closure</div></div>
<div class="ttc" id="aclasstf_1_1_observer_interface_html_aa22f5378154653f08d9a58326bda4754"><div class="ttname"><a href="classtf_1_1_observer_interface.html#aa22f5378154653f08d9a58326bda4754">tf::ObserverInterface::on_exit</a></div><div class="ttdeci">virtual void on_exit(WorkerView wv, TaskView task_view)=0</div><div class="ttdoc">method to call after a worker thread executed a closure</div></div>
<div class="ttc" id="aclasstf_1_1_observer_interface_html_adfd71c3af3ae2ea4f41eed26c1b6f604"><div class="ttname"><a href="classtf_1_1_observer_interface.html#adfd71c3af3ae2ea4f41eed26c1b6f604">tf::ObserverInterface::~ObserverInterface</a></div><div class="ttdeci">virtual ~ObserverInterface()=default</div><div class="ttdoc">virtual destructor</div></div>
<div class="ttc" id="aclasstf_1_1_task_view_html"><div class="ttname"><a href="classtf_1_1_task_view.html">tf::TaskView</a></div><div class="ttdoc">class to access task information from the observer interface</div><div class="ttdef"><b>定义</b> task.hpp:645</div></div>
<div class="ttc" id="aclasstf_1_1_worker_view_html"><div class="ttname"><a href="classtf_1_1_worker_view.html">tf::WorkerView</a></div><div class="ttdoc">class to create an immutable view of a worker</div><div class="ttdef"><b>定义</b> worker.hpp:146</div></div>
</div><!-- fragment --><p>There are three methods you must define in your derived class, <a class="el" href="classtf_1_1_observer_interface.html#a41e6e62f12bf9d9dc4fa74632f6825d9" title="constructor-like method to call when the executor observer is fully created">tf::ObserverInterface::set_up</a>, <a class="el" href="classtf_1_1_observer_interface.html#a8225fcacb03089677a1efc4b16b734cc" title="method to call before a worker thread executes a closure">tf::ObserverInterface::on_entry</a>, and <a class="el" href="classtf_1_1_observer_interface.html#aa22f5378154653f08d9a58326bda4754" title="method to call after a worker thread executed a closure">tf::ObserverInterface::on_exit</a>. The method, <a class="el" href="classtf_1_1_observer_interface.html#a41e6e62f12bf9d9dc4fa74632f6825d9" title="constructor-like method to call when the executor observer is fully created">tf::ObserverInterface::set_up</a>, is a constructor-like method that will be called by the executor when the observer is constructed. It passes an argument of the number of workers to observer in the executor. You may use it to preallocate or initialize data storage, e.g., an independent vector for each worker. The methods, <a class="el" href="classtf_1_1_observer_interface.html#a8225fcacb03089677a1efc4b16b734cc" title="method to call before a worker thread executes a closure">tf::ObserverInterface::on_entry</a> and <a class="el" href="classtf_1_1_observer_interface.html#aa22f5378154653f08d9a58326bda4754" title="method to call after a worker thread executed a closure">tf::ObserverInterface::on_exit</a>, are called by a worker thread before and after the execution context of a task, respectively. Both methods provide immutable access to the underlying worker and the running task using <a class="el" href="classtf_1_1_worker_view.html" title="class to create an immutable view of a worker">tf::WorkerView</a> and <a class="el" href="classtf_1_1_task_view.html" title="class to access task information from the observer interface">tf::TaskView</a>. You may use them to record timepoints and calculate the elapsed time of a task.</p>
<p>You can associate an executor with one or multiple observers (though one is common) using <a class="el" href="classtf_1_1_executor.html#aff77def96ae740d648dd84e571237c83" title="constructs an observer to inspect the activities of worker threads">tf::Executor::make_observer</a>. We use std::shared_ptr to manage the ownership of an observer. The executor loops through each observer and invoke the corresponding methods accordingly.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="taskflow_8hpp.html">taskflow/taskflow.hpp</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span><a class="code hl_struct" href="class_my_observer.html">MyObserver</a> : <span class="keyword">public</span> <a class="code hl_class" href="classtf_1_1_observer_interface.html">tf::ObserverInterface</a> {</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_struct" href="class_my_observer.html">MyObserver</a>(<span class="keyword">const</span> std::string&amp; <a class="code hl_typedef" href="imgui__impl__opengl3__loader_8h.html#aab18cfce5ee7c6881ae04f18be70d94a">name</a>) {</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;constructing observer &quot;</span> &lt;&lt; <a class="code hl_typedef" href="imgui__impl__opengl3__loader_8h.html#aab18cfce5ee7c6881ae04f18be70d94a">name</a> &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> set_up(<span class="keywordtype">size_t</span> num_workers) <span class="keyword">override</span> <span class="keyword">final</span> {</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;setting up observer with &quot;</span> &lt;&lt; num_workers &lt;&lt; <span class="stringliteral">&quot; workers\n&quot;</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> on_entry(<a class="code hl_class" href="classtf_1_1_worker_view.html">tf::WorkerView</a> <a class="code hl_variable" href="_matrix__resize__int_8cpp.html#aab236ce080522c9832217fd5f157541b">w</a>, <a class="code hl_class" href="classtf_1_1_task_view.html">tf::TaskView</a> tv) <span class="keyword">override</span> <span class="keyword">final</span> {</div>
<div class="line">    std::ostringstream oss;</div>
<div class="line">    oss &lt;&lt; <span class="stringliteral">&quot;worker &quot;</span> &lt;&lt; <a class="code hl_variable" href="_matrix__resize__int_8cpp.html#aab236ce080522c9832217fd5f157541b">w</a>.id() &lt;&lt; <span class="stringliteral">&quot; ready to run &quot;</span> &lt;&lt; tv.name() &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;</div>
<div class="line">    std::cout &lt;&lt; oss.str();</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> on_exit(tf::WorkerView <a class="code hl_variable" href="_matrix__resize__int_8cpp.html#aab236ce080522c9832217fd5f157541b">w</a>, tf::TaskView tv) <span class="keyword">override</span> <span class="keyword">final</span> {</div>
<div class="line">    std::ostringstream oss;</div>
<div class="line">    oss &lt;&lt; <span class="stringliteral">&quot;worker &quot;</span> &lt;&lt; <a class="code hl_variable" href="_matrix__resize__int_8cpp.html#aab236ce080522c9832217fd5f157541b">w</a>.id() &lt;&lt; <span class="stringliteral">&quot; finished running &quot;</span> &lt;&lt; tv.name() &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;</div>
<div class="line">    std::cout &lt;&lt; oss.str();</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="main-override-static_8c.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>(){</div>
<div class="line"> </div>
<div class="line">  tf::Executor <a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>(4);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Create a taskflow of eight tasks</span></div>
<div class="line">  tf::Taskflow <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">auto</span> <a class="code hl_typedef" href="bench__gemm_8cpp.html#addc86e8508f14411ec98f521c520f875">A</a> = <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.emplace([] () { std::cout &lt;&lt; <span class="stringliteral">&quot;1\n&quot;</span>; }).<a class="code hl_typedef" href="imgui__impl__opengl3__loader_8h.html#aab18cfce5ee7c6881ae04f18be70d94a">name</a>(<span class="stringliteral">&quot;A&quot;</span>);</div>
<div class="line">  <span class="keyword">auto</span> <a class="code hl_typedef" href="bench__gemm_8cpp.html#a37a83060ac796961b44991c836f083f7">B</a> = <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.emplace([] () { std::cout &lt;&lt; <span class="stringliteral">&quot;2\n&quot;</span>; }).<a class="code hl_typedef" href="imgui__impl__opengl3__loader_8h.html#aab18cfce5ee7c6881ae04f18be70d94a">name</a>(<span class="stringliteral">&quot;B&quot;</span>);</div>
<div class="line">  <span class="keyword">auto</span> <a class="code hl_define" href="test__buffer__node_8cpp.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a> = <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.emplace([] () { std::cout &lt;&lt; <span class="stringliteral">&quot;3\n&quot;</span>; }).<a class="code hl_typedef" href="imgui__impl__opengl3__loader_8h.html#aab18cfce5ee7c6881ae04f18be70d94a">name</a>(<span class="stringliteral">&quot;C&quot;</span>);</div>
<div class="line">  <span class="keyword">auto</span> <a class="code hl_variable" href="_eigen_solver___eigen_solver___matrix_type_8cpp.html#a925331f9b6e4844293d36a8df2256d38">D</a> = <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.emplace([] () { std::cout &lt;&lt; <span class="stringliteral">&quot;4\n&quot;</span>; }).<a class="code hl_typedef" href="imgui__impl__opengl3__loader_8h.html#aab18cfce5ee7c6881ae04f18be70d94a">name</a>(<span class="stringliteral">&quot;D&quot;</span>);</div>
<div class="line">  <span class="keyword">auto</span> <a class="code hl_define" href="sandbox_2strassen_2omp_8cpp.html#a4bfa035cad7c3258704669810cd5de5d">E</a> = <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.emplace([] () { std::cout &lt;&lt; <span class="stringliteral">&quot;5\n&quot;</span>; }).<a class="code hl_typedef" href="imgui__impl__opengl3__loader_8h.html#aab18cfce5ee7c6881ae04f18be70d94a">name</a>(<span class="stringliteral">&quot;E&quot;</span>);</div>
<div class="line">  <span class="keyword">auto</span> <a class="code hl_variable" href="test__flow__graph_8cpp.html#a1c83625ec20fd09ecaf0e5b37c75f6f8">F</a> = <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.emplace([] () { std::cout &lt;&lt; <span class="stringliteral">&quot;6\n&quot;</span>; }).<a class="code hl_typedef" href="imgui__impl__opengl3__loader_8h.html#aab18cfce5ee7c6881ae04f18be70d94a">name</a>(<span class="stringliteral">&quot;F&quot;</span>);</div>
<div class="line">  <span class="keyword">auto</span> <a class="code hl_variable" href="_jacobi__make_givens_8cpp.html#ad2c49539791450cfceedabc09452d977">G</a> = <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.emplace([] () { std::cout &lt;&lt; <span class="stringliteral">&quot;7\n&quot;</span>; }).<a class="code hl_typedef" href="imgui__impl__opengl3__loader_8h.html#aab18cfce5ee7c6881ae04f18be70d94a">name</a>(<span class="stringliteral">&quot;G&quot;</span>);</div>
<div class="line">  <span class="keyword">auto</span> <a class="code hl_variable" href="gnuplot__common__settings_8hh.html#a1312167399d185be316962d53af87c87">H</a> = <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.emplace([] () { std::cout &lt;&lt; <span class="stringliteral">&quot;8\n&quot;</span>; }).<a class="code hl_typedef" href="imgui__impl__opengl3__loader_8h.html#aab18cfce5ee7c6881ae04f18be70d94a">name</a>(<span class="stringliteral">&quot;H&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// create an observer</span></div>
<div class="line">  std::shared_ptr&lt;MyObserver&gt; <a class="code hl_function" href="test__basics_8cpp.html#ae362ef40752341c76d5edd1d99e46918">observer</a> = <a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.<a class="code hl_function" href="classtf_1_1_executor.html#aff77def96ae740d648dd84e571237c83">make_observer</a>&lt;MyObserver&gt;(</div>
<div class="line">    <span class="stringliteral">&quot;MyObserver&quot;</span></div>
<div class="line">  );</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// run the taskflow</span></div>
<div class="line">  <a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.<a class="code hl_function" href="classtf_1_1_executor.html#a519777f5783981d534e9e53b99712069">run</a>(<a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>).get();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// remove the observer (optional)</span></div>
<div class="line">  <a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.<a class="code hl_function" href="classtf_1_1_executor.html#a31081f492c376f7b798de0e430534531">remove_observer</a>(std::move(<a class="code hl_function" href="test__basics_8cpp.html#ae362ef40752341c76d5edd1d99e46918">observer</a>));</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="a_eigen_solver___eigen_solver___matrix_type_8cpp_html_a925331f9b6e4844293d36a8df2256d38"><div class="ttname"><a href="_eigen_solver___eigen_solver___matrix_type_8cpp.html#a925331f9b6e4844293d36a8df2256d38">D</a></div><div class="ttdeci">MatrixXcd D</div><div class="ttdef"><b>定义</b> EigenSolver_EigenSolver_MatrixType.cpp:14</div></div>
<div class="ttc" id="a_jacobi__make_givens_8cpp_html_ad2c49539791450cfceedabc09452d977"><div class="ttname"><a href="_jacobi__make_givens_8cpp.html#ad2c49539791450cfceedabc09452d977">G</a></div><div class="ttdeci">JacobiRotation&lt; float &gt; G</div><div class="ttdef"><b>定义</b> Jacobi_makeGivens.cpp:2</div></div>
<div class="ttc" id="a_matrix__resize__int_8cpp_html_aab236ce080522c9832217fd5f157541b"><div class="ttname"><a href="_matrix__resize__int_8cpp.html#aab236ce080522c9832217fd5f157541b">w</a></div><div class="ttdeci">RowVector3d w</div><div class="ttdef"><b>定义</b> Matrix_resize_int.cpp:3</div></div>
<div class="ttc" id="aclass_my_observer_html"><div class="ttname"><a href="class_my_observer.html">MyObserver</a></div><div class="ttdef"><b>定义</b> test_task_scheduler_observer_v3.cpp:23</div></div>
<div class="ttc" id="aclasstf_1_1_executor_html_a31081f492c376f7b798de0e430534531"><div class="ttname"><a href="classtf_1_1_executor.html#a31081f492c376f7b798de0e430534531">tf::Executor::remove_observer</a></div><div class="ttdeci">void remove_observer(std::shared_ptr&lt; Observer &gt; observer)</div><div class="ttdoc">removes an observer from the executor</div><div class="ttdef"><b>定义</b> executor-dl.hpp:1458</div></div>
<div class="ttc" id="aclasstf_1_1_executor_html_aff77def96ae740d648dd84e571237c83"><div class="ttname"><a href="classtf_1_1_executor.html#aff77def96ae740d648dd84e571237c83">tf::Executor::make_observer</a></div><div class="ttdeci">std::shared_ptr&lt; Observer &gt; make_observer(ArgsT &amp;&amp;... args)</div><div class="ttdoc">constructs an observer to inspect the activities of worker threads</div><div class="ttdef"><b>定义</b> executor-dl.hpp:1439</div></div>
<div class="ttc" id="aclasstf_1_1_observer_interface_html"><div class="ttname"><a href="classtf_1_1_observer_interface.html">tf::ObserverInterface</a></div><div class="ttdoc">class to derive an executor observer</div><div class="ttdef"><b>定义</b> observer.hpp:169</div></div>
<div class="ttc" id="agnuplot__common__settings_8hh_html_a1312167399d185be316962d53af87c87"><div class="ttname"><a href="gnuplot__common__settings_8hh.html#a1312167399d185be316962d53af87c87">H</a></div><div class="ttdeci">set noclip points set clip one set noclip two set bar set border lt lw set xdata set ydata set zdata set x2data set y2data set boxwidth set dummy y set format x g set format y g set format x2 g set format y2 g set format z g set angles radians set nogrid set key title set key left top Right noreverse box linetype linewidth samplen spacing width set nolabel set noarrow set nologscale set logscale x set set pointsize set encoding default set nopolar set noparametric set set set set surface set nocontour set clabel set mapping cartesian set nohidden3d set cntrparam order set cntrparam linear set cntrparam levels auto set cntrparam points set size set set xzeroaxis lt lw set x2zeroaxis lt lw set yzeroaxis lt lw set y2zeroaxis lt lw set tics in set ticslevel set tics set mxtics default set mytics default set mx2tics default set my2tics default set xtics border mirror norotate autofreq set ytics border mirror norotate autofreq set ztics border nomirror norotate autofreq set nox2tics set noy2tics set timestamp bottom norotate set rrange[*:*] noreverse nowriteback set trange[*:*] noreverse nowriteback set urange[*:*] noreverse nowriteback set vrange[*:*] noreverse nowriteback set xlabel matrix size set x2label set timefmt d m y n H</div><div class="ttdef"><b>定义</b> gnuplot_common_settings.hh:74</div></div>
<div class="ttc" id="aimgui__impl__opengl3__loader_8h_html_aab18cfce5ee7c6881ae04f18be70d94a"><div class="ttname"><a href="imgui__impl__opengl3__loader_8h.html#aab18cfce5ee7c6881ae04f18be70d94a">name</a></div><div class="ttdeci">const GLchar * name</div><div class="ttdef"><b>定义</b> imgui_impl_opengl3_loader.h:312</div></div>
<div class="ttc" id="amain-override-static_8c_html_ae66f6b31b5ad750f1fe042a706a4e3d4"><div class="ttname"><a href="main-override-static_8c.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a></div><div class="ttdeci">int main()</div><div class="ttdef"><b>定义</b> main-override-static.c:32</div></div>
<div class="ttc" id="asandbox_2strassen_2omp_8cpp_html_a4bfa035cad7c3258704669810cd5de5d"><div class="ttname"><a href="sandbox_2strassen_2omp_8cpp.html#a4bfa035cad7c3258704669810cd5de5d">E</a></div><div class="ttdeci">#define E(Matrix)</div></div>
<div class="ttc" id="ataskflow_8hpp_html"><div class="ttname"><a href="taskflow_8hpp.html">taskflow.hpp</a></div><div class="ttdoc">main taskflow include file</div></div>
<div class="ttc" id="atest__basics_8cpp_html_ae362ef40752341c76d5edd1d99e46918"><div class="ttname"><a href="test__basics_8cpp.html#ae362ef40752341c76d5edd1d99e46918">observer</a></div><div class="ttdeci">void observer(unsigned w)</div><div class="ttdef"><b>定义</b> test_basics.cpp:973</div></div>
<div class="ttc" id="atest__flow__graph_8cpp_html_a1c83625ec20fd09ecaf0e5b37c75f6f8"><div class="ttname"><a href="test__flow__graph_8cpp.html#a1c83625ec20fd09ecaf0e5b37c75f6f8">F</a></div><div class="ttdeci">const int F</div><div class="ttdef"><b>定义</b> test_flow_graph.cpp:60</div></div>
</div><!-- fragment --><p>The above code produces the following output:</p>
<div class="fragment"><div class="line">constructing observer MyObserver</div>
<div class="line">setting up observer with 4 workers</div>
<div class="line">worker 2 ready to run A</div>
<div class="line">1</div>
<div class="line">worker 2 finished running A</div>
<div class="line">worker 2 ready to run B</div>
<div class="line">2</div>
<div class="line">worker 1 ready to run C</div>
<div class="line">worker 2 finished running B</div>
<div class="line">3</div>
<div class="line">worker 2 ready to run D</div>
<div class="line">worker 3 ready to run E</div>
<div class="line">worker 1 finished running C</div>
<div class="line">4</div>
<div class="line">5</div>
<div class="line">worker 1 ready to run F</div>
<div class="line">worker 2 finished running D</div>
<div class="line">worker 3 finished running E</div>
<div class="line">6</div>
<div class="line">worker 2 ready to run G</div>
<div class="line">worker 3 ready to run H</div>
<div class="line">worker 1 finished running F</div>
<div class="line">7</div>
<div class="line">8</div>
<div class="line">worker 2 finished running G</div>
<div class="line">worker 3 finished running H</div>
</div><!-- fragment --><p>It is expected each line of std::cout interleaves with each other as there are four workers participating in task scheduling. However, the <em>ready</em> message always appears before the corresponding task message (e.g., numbers) and then the <em>finished</em> message.</p>
<h1><a class="anchor" id="ModifyWorkerProperty"></a>
Modify Worker Property</h1>
<p>You can change the property of each worker thread from its executor, such as assigning thread-processor affinity before the worker enters the scheduler loop and post-processing additional information after the worker leaves the scheduler loop, by passing an instance derived from <a class="el" href="classtf_1_1_worker_interface.html" title="class to configure worker behavior in an executor">tf::WorkerInterface</a> to the executor. The example demonstrates the usage of <a class="el" href="classtf_1_1_worker_interface.html" title="class to configure worker behavior in an executor">tf::WorkerInterface</a> to affine a worker to a specific CPU core equal to its id on a linux platform:</p>
<div class="fragment"><div class="line"><span class="comment">// affine the given thread to the given core index (linux-specific)</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code hl_function" href="worker__interface_8cpp.html#ad0c789f976c6b00b0d60964fa21e0c87">affine</a>(std::thread&amp; thread, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> core_id) {</div>
<div class="line">  cpu_set_t cpuset;</div>
<div class="line">  CPU_ZERO(&amp;cpuset);</div>
<div class="line">  CPU_SET(core_id, &amp;cpuset);</div>
<div class="line">  <a class="code hl_typedef" href="pthread__minport__windows_8h.html#ad665cf4bf4a61dd23aab712d9c5e9d81">pthread_t</a> native_handle = thread.native_handle();</div>
<div class="line">  <span class="keywordflow">return</span> pthread_setaffinity_np(native_handle, <span class="keyword">sizeof</span>(cpu_set_t), &amp;cpuset) == 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span><a class="code hl_class" href="class_custom_worker_behavior.html">CustomWorkerBehavior</a> : <span class="keyword">public</span> <a class="code hl_class" href="classtf_1_1_worker_interface.html">tf::WorkerInterface</a> {</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// to call before the worker enters the scheduling loop</span></div>
<div class="line">  <span class="keywordtype">void</span> scheduler_prologue(<a class="code hl_class" href="classtf_1_1_worker.html">tf::Worker</a>&amp; <a class="code hl_variable" href="_matrix__resize__int_8cpp.html#aab236ce080522c9832217fd5f157541b">w</a>)<span class="keyword"> override </span>{</div>
<div class="line">    <a class="code hl_function" href="printf_8h.html#aee3ed3a831f25f07e7be3919fff2203a">printf</a>(<span class="stringliteral">&quot;worker %lu prepares to enter the work-stealing loop\n&quot;</span>, <a class="code hl_variable" href="_matrix__resize__int_8cpp.html#aab236ce080522c9832217fd5f157541b">w</a>.id());</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// now affine the worker to a particular CPU core equal to its id</span></div>
<div class="line">    <span class="keywordflow">if</span>(<a class="code hl_function" href="worker__interface_8cpp.html#ad0c789f976c6b00b0d60964fa21e0c87">affine</a>(<a class="code hl_variable" href="_matrix__resize__int_8cpp.html#aab236ce080522c9832217fd5f157541b">w</a>.thread(), <a class="code hl_variable" href="_matrix__resize__int_8cpp.html#aab236ce080522c9832217fd5f157541b">w</a>.id())) {</div>
<div class="line">      <a class="code hl_function" href="printf_8h.html#aee3ed3a831f25f07e7be3919fff2203a">printf</a>(<span class="stringliteral">&quot;successfully affines worker %lu to CPU core %lu\n&quot;</span>, <a class="code hl_variable" href="_matrix__resize__int_8cpp.html#aab236ce080522c9832217fd5f157541b">w</a>.id(), <a class="code hl_variable" href="_matrix__resize__int_8cpp.html#aab236ce080522c9832217fd5f157541b">w</a>.id());</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">      <a class="code hl_function" href="printf_8h.html#aee3ed3a831f25f07e7be3919fff2203a">printf</a>(<span class="stringliteral">&quot;failed to affine worker %lu to CPU core %lu\n&quot;</span>, <a class="code hl_variable" href="_matrix__resize__int_8cpp.html#aab236ce080522c9832217fd5f157541b">w</a>.id(), <a class="code hl_variable" href="_matrix__resize__int_8cpp.html#aab236ce080522c9832217fd5f157541b">w</a>.id());</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// to call after the worker leaves the scheduling loop</span></div>
<div class="line">  <span class="keywordtype">void</span> scheduler_epilogue(tf::Worker&amp; <a class="code hl_variable" href="_matrix__resize__int_8cpp.html#aab236ce080522c9832217fd5f157541b">w</a>, std::exception_ptr)<span class="keyword"> override </span>{</div>
<div class="line">    <a class="code hl_function" href="printf_8h.html#aee3ed3a831f25f07e7be3919fff2203a">printf</a>(<span class="stringliteral">&quot;worker %lu left the work-stealing loop\n&quot;</span>, <a class="code hl_variable" href="_matrix__resize__int_8cpp.html#aab236ce080522c9832217fd5f157541b">w</a>.id());</div>
<div class="line">  }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="main-override-static_8c.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>() {</div>
<div class="line">  tf::Executor <a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>(4, <a class="code hl_function" href="namespacetf.html#aa10195f7d5f2f1dd32bb852a9aa560f4">tf::make_worker_interface&lt;CustomWorkerBehavior&gt;</a>());</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="aclass_custom_worker_behavior_html"><div class="ttname"><a href="class_custom_worker_behavior.html">CustomWorkerBehavior</a></div><div class="ttdef"><b>定义</b> worker_interface.cpp:44</div></div>
<div class="ttc" id="aclasstf_1_1_worker_html"><div class="ttname"><a href="classtf_1_1_worker.html">tf::Worker</a></div><div class="ttdoc">class to create a worker in an executor</div><div class="ttdef"><b>定义</b> worker.hpp:54</div></div>
<div class="ttc" id="aclasstf_1_1_worker_interface_html"><div class="ttname"><a href="classtf_1_1_worker_interface.html">tf::WorkerInterface</a></div><div class="ttdoc">class to configure worker behavior in an executor</div><div class="ttdef"><b>定义</b> worker.hpp:249</div></div>
<div class="ttc" id="anamespacetf_html_aa10195f7d5f2f1dd32bb852a9aa560f4"><div class="ttname"><a href="namespacetf.html#aa10195f7d5f2f1dd32bb852a9aa560f4">tf::make_worker_interface</a></div><div class="ttdeci">std::unique_ptr&lt; T &gt; make_worker_interface(ArgsT &amp;&amp;... args)</div><div class="ttdoc">helper function to create an instance derived from tf::WorkerInterface</div><div class="ttdef"><b>定义</b> worker.hpp:286</div></div>
<div class="ttc" id="aprintf_8h_html_aee3ed3a831f25f07e7be3919fff2203a"><div class="ttname"><a href="printf_8h.html#aee3ed3a831f25f07e7be3919fff2203a">printf</a></div><div class="ttdeci">auto printf(string_view fmt, const T &amp;... args) -&gt; int</div><div class="ttdef"><b>定义</b> printf.h:621</div></div>
<div class="ttc" id="apthread__minport__windows_8h_html_ad665cf4bf4a61dd23aab712d9c5e9d81"><div class="ttname"><a href="pthread__minport__windows_8h.html#ad665cf4bf4a61dd23aab712d9c5e9d81">pthread_t</a></div><div class="ttdeci">HANDLE pthread_t</div><div class="ttdef"><b>定义</b> pthread_minport_windows.h:58</div></div>
<div class="ttc" id="aworker__interface_8cpp_html_ad0c789f976c6b00b0d60964fa21e0c87"><div class="ttname"><a href="worker__interface_8cpp.html#ad0c789f976c6b00b0d60964fa21e0c87">affine</a></div><div class="ttdeci">bool affine(std::thread &amp;thread, size_t core_id)</div><div class="ttdef"><b>定义</b> worker_interface.cpp:21</div></div>
</div><!-- fragment --><p>When running the program, we see the following one possible output:</p>
<div class="fragment"><div class="line">{.shell-session} </div>
<div class="line">worker 3 prepares to enter the <a class="code hl_function" href="graph__pipeline_2levelgraph_8hpp.html#aa24fdf691a71c708fccdc6e29a805b42">work</a>-stealing <a class="code hl_define" href="sugar_8h.html#a8093cf142de43413a3649101cf95152c">loop</a></div>
<div class="line">successfully affines worker 3 to CPU core 3</div>
<div class="line">worker 3 <a class="code hl_variable" href="blas__interface_8hh.html#af32074257ed1b575dfd1ab2f6e6ba59f">left</a> the <a class="code hl_function" href="graph__pipeline_2levelgraph_8hpp.html#aa24fdf691a71c708fccdc6e29a805b42">work</a>-stealing <a class="code hl_define" href="sugar_8h.html#a8093cf142de43413a3649101cf95152c">loop</a></div>
<div class="line">worker 0 prepares to enter the <a class="code hl_function" href="graph__pipeline_2levelgraph_8hpp.html#aa24fdf691a71c708fccdc6e29a805b42">work</a>-stealing <a class="code hl_define" href="sugar_8h.html#a8093cf142de43413a3649101cf95152c">loop</a></div>
<div class="line">successfully affines worker 0 to CPU core 0</div>
<div class="line">worker 0 <a class="code hl_variable" href="blas__interface_8hh.html#af32074257ed1b575dfd1ab2f6e6ba59f">left</a> the <a class="code hl_function" href="graph__pipeline_2levelgraph_8hpp.html#aa24fdf691a71c708fccdc6e29a805b42">work</a>-stealing <a class="code hl_define" href="sugar_8h.html#a8093cf142de43413a3649101cf95152c">loop</a></div>
<div class="line">worker 1 prepares to enter the <a class="code hl_function" href="graph__pipeline_2levelgraph_8hpp.html#aa24fdf691a71c708fccdc6e29a805b42">work</a>-stealing <a class="code hl_define" href="sugar_8h.html#a8093cf142de43413a3649101cf95152c">loop</a></div>
<div class="line">worker 2 prepares to enter the <a class="code hl_function" href="graph__pipeline_2levelgraph_8hpp.html#aa24fdf691a71c708fccdc6e29a805b42">work</a>-stealing <a class="code hl_define" href="sugar_8h.html#a8093cf142de43413a3649101cf95152c">loop</a></div>
<div class="line">successfully affines worker 1 to CPU core 1</div>
<div class="line">worker 1 <a class="code hl_variable" href="blas__interface_8hh.html#af32074257ed1b575dfd1ab2f6e6ba59f">left</a> the <a class="code hl_function" href="graph__pipeline_2levelgraph_8hpp.html#aa24fdf691a71c708fccdc6e29a805b42">work</a>-stealing <a class="code hl_define" href="sugar_8h.html#a8093cf142de43413a3649101cf95152c">loop</a></div>
<div class="line">successfully affines worker 2 to CPU core 2</div>
<div class="line">worker 2 <a class="code hl_variable" href="blas__interface_8hh.html#af32074257ed1b575dfd1ab2f6e6ba59f">left</a> the <a class="code hl_function" href="graph__pipeline_2levelgraph_8hpp.html#aa24fdf691a71c708fccdc6e29a805b42">work</a>-stealing <a class="code hl_define" href="sugar_8h.html#a8093cf142de43413a3649101cf95152c">loop</a></div>
<div class="ttc" id="ablas__interface_8hh_html_af32074257ed1b575dfd1ab2f6e6ba59f"><div class="ttname"><a href="blas__interface_8hh.html#af32074257ed1b575dfd1ab2f6e6ba59f">left</a></div><div class="ttdeci">static char left</div><div class="ttdef"><b>定义</b> blas_interface.hh:62</div></div>
<div class="ttc" id="agraph__pipeline_2levelgraph_8hpp_html_aa24fdf691a71c708fccdc6e29a805b42"><div class="ttname"><a href="graph__pipeline_2levelgraph_8hpp.html#aa24fdf691a71c708fccdc6e29a805b42">work</a></div><div class="ttdeci">int work(const int seed)</div><div class="ttdef"><b>定义</b> levelgraph.hpp:301</div></div>
<div class="ttc" id="asugar_8h_html_a8093cf142de43413a3649101cf95152c"><div class="ttname"><a href="sugar_8h.html#a8093cf142de43413a3649101cf95152c">loop</a></div><div class="ttdeci">#define loop</div><div class="ttdef"><b>定义</b> sugar.h:115</div></div>
</div><!-- fragment --><p>When you create an executor, it spawns a set of worker threads to run tasks using a work-stealing scheduling algorithm. The execution logic of the scheduler and its interaction with each spawned worker via <a class="el" href="classtf_1_1_worker_interface.html" title="class to configure worker behavior in an executor">tf::WorkerInterface</a> is given below:</p>
<div class="fragment"><div class="line"><span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> <a class="code hl_variable" href="_bi_c_g_s_t_a_b__simple_8cpp.html#a5150192f625f4d7970d61169b9567f39">n</a>=0; <a class="code hl_variable" href="_bi_c_g_s_t_a_b__simple_8cpp.html#a5150192f625f4d7970d61169b9567f39">n</a>&lt;num_workers; <a class="code hl_variable" href="_bi_c_g_s_t_a_b__simple_8cpp.html#a5150192f625f4d7970d61169b9567f39">n</a>++) {</div>
<div class="line">  create_thread([](Worker&amp; worker)</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// pre-processing executor-specific worker information</span></div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// enter the scheduling loop</span></div>
<div class="line">    <span class="comment">// Here, WorkerInterface::scheduler_prologue is invoked, if any</span></div>
<div class="line">    worker_interface-&gt;scheduler_prologue(worker);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">try</span> {</div>
<div class="line">      while(1) {</div>
<div class="line">        perform_work_stealing_algorithm();</div>
<div class="line">        if(stop) {</div>
<div class="line">          break;</div>
<div class="line">        }</div>
<div class="line">      }</div>
<div class="line">    } <span class="keywordflow">catch</span>(...) {</div>
<div class="line">      exception_ptr = std::current_exception();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// leaves the scheduling loop and joins this worker thread</span></div>
<div class="line">    <span class="comment">// Here, WorkerInterface::scheduler_epilogue is invoked, if any</span></div>
<div class="line">    worker_interface-&gt;scheduler_epilogue(worker, exception_ptr);</div>
<div class="line">  );</div>
<div class="line">}</div>
</div><!-- fragment --><dl class="section attention"><dt>注意</dt><dd><a class="el" href="classtf_1_1_worker_interface.html#a41c3b931a36bde8eff4aa8d375e8888a" title="method to call before a worker enters the scheduling loop">tf::WorkerInterface::scheduler_prologue</a> and tf::WorkerInterface::scheduler_eiplogue are invoked by each worker simultaneously. </dd></dl>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">制作者 <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
