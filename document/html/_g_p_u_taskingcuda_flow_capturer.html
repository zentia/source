<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>source: GPU Tasking (cudaFlowCapturer)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">source
   </div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="搜索" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- 制作者 Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('_g_p_u_taskingcuda_flow_capturer.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">载入中...</div>
<div class="SRStatus" id="Searching">搜索中...</div>
<div class="SRStatus" id="NoMatches">未找到</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">GPU Tasking (cudaFlowCapturer)</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>目录</h3>
<ul>
  <li class="level1">
    <a href="#GPUTaskingcudaFlowCapturerIncludeTheHeader">Include the Header</a>
  </li>
  <li class="level1">
    <a href="#Capture_a_cudaFlow">Capture a cudaFlow</a>
  </li>
  <li class="level1">
    <a href="#CommonCaptureMethods">Common Capture Methods</a>
  </li>
  <li class="level1">
    <a href="#CreateACapturerOnASpecificGPU">Create a Capturer on a Specific GPU</a>
  </li>
  <li class="level1">
    <a href="#CreateACapturerWithinAcudaFlow">Create a Capturer from a cudaFlow</a>
  </li>
  <li class="level1">
    <a href="#OffloadAcudaFlowCapturer">Offload a cudaFlow Capturer</a>
  </li>
  <li class="level1">
    <a href="#UpdateAcudaFlowCapturer">Update a cudaFlow Capturer</a>
  </li>
  <li class="level1">
    <a href="#IntegrateCudaFlowCapturerIntoTaskflow">Integrate a cudaFlow Capturer into Taskflow</a>
  </li>
</ul>
</div>
<div class="textblock"><p>You can create a cudaFlow through <em>stream capture</em>, which allows you to implicitly capture a CUDA graph using stream-based interface. Compared to explicit CUDA Graph construction (<a class="el" href="classtf_1_1cuda_flow.html" title="class to create a cudaFlow task dependency graph">tf::cudaFlow</a>), implicit CUDA Graph capturing (<a class="el" href="classtf_1_1cuda_flow_capturer.html" title="class to create a cudaFlow graph using stream capture">tf::cudaFlowCapturer</a>) is more flexible in building GPU task graphs.</p>
<h1><a class="anchor" id="GPUTaskingcudaFlowCapturerIncludeTheHeader"></a>
Include the Header</h1>
<p>You need to include the header file, <code>taskflow/cuda/cudaflow.hpp</code>, for capturing a GPU task graph using <a class="el" href="classtf_1_1cuda_flow_capturer.html" title="class to create a cudaFlow graph using stream capture">tf::cudaFlowCapturer</a>.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cudaflow_8hpp.html">taskflow/cuda/cudaflow.hpp</a>&gt;</span></div>
<div class="ttc" id="acudaflow_8hpp_html"><div class="ttname"><a href="cudaflow_8hpp.html">cudaflow.hpp</a></div><div class="ttdoc">cudaFlow include file</div></div>
</div><!-- fragment --><h1><a class="anchor" id="Capture_a_cudaFlow"></a>
Capture a cudaFlow</h1>
<p>When your program has no access to direct kernel calls but can only invoke them through a stream-based interface (e.g., @cuBLAS and @cuDNN library functions), you can use <a class="el" href="classtf_1_1cuda_flow_capturer.html" title="class to create a cudaFlow graph using stream capture">tf::cudaFlowCapturer</a> to capture the hidden GPU operations into a CUDA graph. <a class="el" href="bench__gemm_8cpp.html#addc86e8508f14411ec98f521c520f875">A</a> cudaFlowCapturer is similar to a cudaFlow except it constructs a GPU task graph through <em>stream capture</em>. You use the method <a class="el" href="classtf_1_1cuda_flow_capturer.html#ad0d937ae0d77239f148b66a77e35db41" title="captures a sequential CUDA operations from the given callable">tf::cudaFlowCapturer::on</a> to capture a sequence of <em>asynchronous</em> GPU operations through the given stream. The following example creates a CUDA graph that captures two kernel tasks, <code>task_1</code> (<code>my_kernel_1</code>) and <code>task_2</code> (<code>my_kernel_2</code>) , where <code>task_1</code> runs before <code>task_2</code>.</p>
<div class="fragment"><div class="line"><span class="comment">// create a cudaFlow capturer to run a CUDA graph using stream capturing</span></div>
<div class="line"><a class="code hl_class" href="classtf_1_1cuda_flow_capturer.html">tf::cudaFlowCapturer</a> capturer;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// capture my_kernel_1 through a stream managed by capturer</span></div>
<div class="line"><a class="code hl_class" href="classtf_1_1cuda_task.html">tf::cudaTask</a> task_1 = capturer.<a class="code hl_function" href="classtf_1_1cuda_flow_capturer.html#ad0d937ae0d77239f148b66a77e35db41">on</a>([&amp;](cudaStream_t stream){ </div>
<div class="line">  my_kernel_1&lt;&lt;&lt;grid_1, block_1, shm_size_1, stream&gt;&gt;&gt;(my_parameters_1);</div>
<div class="line">}).<a class="code hl_typedef" href="imgui__impl__opengl3__loader_8h.html#aab18cfce5ee7c6881ae04f18be70d94a">name</a>(<span class="stringliteral">&quot;my_kernel_1&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// capture my_kernel_2 through a stream managed by capturer</span></div>
<div class="line"><a class="code hl_class" href="classtf_1_1cuda_task.html">tf::cudaTask</a> task_2 = capturer.<a class="code hl_function" href="classtf_1_1cuda_flow_capturer.html#ad0d937ae0d77239f148b66a77e35db41">on</a>([&amp;](cudaStream_t stream){ </div>
<div class="line">  my_kernel_2&lt;&lt;&lt;grid_2, block_2, shm_size_2, stream&gt;&gt;&gt;(my_parameters_2);</div>
<div class="line">}).<a class="code hl_typedef" href="imgui__impl__opengl3__loader_8h.html#aab18cfce5ee7c6881ae04f18be70d94a">name</a>(<span class="stringliteral">&quot;my_kernel_2&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// my_kernel_1 runs before my_kernel_2</span></div>
<div class="line">task_1.<a class="code hl_function" href="classtf_1_1cuda_task.html#abdd68287ec4dff4216af34d1db44d1b4">precede</a>(task_2);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// offload captured GPU tasks using the CUDA Graph execution model</span></div>
<div class="line"><a class="code hl_typedef" href="namespacetf.html#af19c9b301dc0b0fe2a51a960fa427e83">tf::cudaStream</a> stream;</div>
<div class="line">capturer.<a class="code hl_function" href="classtf_1_1cuda_flow_capturer.html#a952596fd7c46acee4c2459d8fe39da28">run</a>(stream);</div>
<div class="line">stream.<a class="code hl_function" href="classtf_1_1cuda_stream_base.html#a08857ff2874cd5378e578822e2e96dd0">synchronize</a>();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// dump the cudaFlow to a DOT format through std::cout</span></div>
<div class="line">capturer.<a class="code hl_function" href="classtf_1_1cuda_flow_capturer.html#a90d1265bcc27647906bed6e6876c9aa7">dump</a>(std::cout)</div>
<div class="ttc" id="aclasstf_1_1cuda_flow_capturer_html"><div class="ttname"><a href="classtf_1_1cuda_flow_capturer.html">tf::cudaFlowCapturer</a></div><div class="ttdoc">class to create a cudaFlow graph using stream capture</div><div class="ttdef"><b>定义</b> cuda_capturer.hpp:57</div></div>
<div class="ttc" id="aclasstf_1_1cuda_flow_capturer_html_a90d1265bcc27647906bed6e6876c9aa7"><div class="ttname"><a href="classtf_1_1cuda_flow_capturer.html#a90d1265bcc27647906bed6e6876c9aa7">tf::cudaFlowCapturer::dump</a></div><div class="ttdeci">void dump(std::ostream &amp;os) const</div><div class="ttdoc">dumps the cudaFlow graph into a DOT format through an output stream</div><div class="ttdef"><b>定义</b> cuda_capturer.hpp:535</div></div>
<div class="ttc" id="aclasstf_1_1cuda_flow_capturer_html_a952596fd7c46acee4c2459d8fe39da28"><div class="ttname"><a href="classtf_1_1cuda_flow_capturer.html#a952596fd7c46acee4c2459d8fe39da28">tf::cudaFlowCapturer::run</a></div><div class="ttdeci">void run(cudaStream_t stream)</div><div class="ttdoc">offloads the cudaFlowCapturer onto a GPU asynchronously via a stream</div></div>
<div class="ttc" id="aclasstf_1_1cuda_flow_capturer_html_ad0d937ae0d77239f148b66a77e35db41"><div class="ttname"><a href="classtf_1_1cuda_flow_capturer.html#ad0d937ae0d77239f148b66a77e35db41">tf::cudaFlowCapturer::on</a></div><div class="ttdeci">cudaTask on(C &amp;&amp;callable)</div><div class="ttdoc">captures a sequential CUDA operations from the given callable</div><div class="ttdef"><b>定义</b> cuda_capturer.hpp:548</div></div>
<div class="ttc" id="aclasstf_1_1cuda_stream_base_html_a08857ff2874cd5378e578822e2e96dd0"><div class="ttname"><a href="classtf_1_1cuda_stream_base.html#a08857ff2874cd5378e578822e2e96dd0">tf::cudaStreamBase::synchronize</a></div><div class="ttdeci">void synchronize() const</div><div class="ttdoc">synchronizes the associated stream</div><div class="ttdef"><b>定义</b> cuda_stream.hpp:212</div></div>
<div class="ttc" id="aclasstf_1_1cuda_task_html"><div class="ttname"><a href="classtf_1_1cuda_task.html">tf::cudaTask</a></div><div class="ttdoc">class to create a task handle of a CUDA Graph node</div><div class="ttdef"><b>定义</b> cuda_graph.hpp:265</div></div>
<div class="ttc" id="aclasstf_1_1cuda_task_html_abdd68287ec4dff4216af34d1db44d1b4"><div class="ttname"><a href="classtf_1_1cuda_task.html#abdd68287ec4dff4216af34d1db44d1b4">tf::cudaTask::precede</a></div><div class="ttdeci">cudaTask &amp; precede(Ts &amp;&amp;... tasks)</div><div class="ttdoc">adds precedence links from this to other tasks</div><div class="ttdef"><b>定义</b> cuda_graph.hpp:357</div></div>
<div class="ttc" id="aimgui__impl__opengl3__loader_8h_html_aab18cfce5ee7c6881ae04f18be70d94a"><div class="ttname"><a href="imgui__impl__opengl3__loader_8h.html#aab18cfce5ee7c6881ae04f18be70d94a">name</a></div><div class="ttdeci">const GLchar * name</div><div class="ttdef"><b>定义</b> imgui_impl_opengl3_loader.h:312</div></div>
<div class="ttc" id="anamespacetf_html_af19c9b301dc0b0fe2a51a960fa427e83"><div class="ttname"><a href="namespacetf.html#af19c9b301dc0b0fe2a51a960fa427e83">tf::cudaStream</a></div><div class="ttdeci">cudaStreamBase&lt; cudaStreamCreator, cudaStreamDeleter &gt; cudaStream</div><div class="ttdoc">default smart pointer type to manage a cudaStream_t object with unique ownership</div><div class="ttdef"><b>定义</b> cuda_stream.hpp:299</div></div>
</div><!-- fragment --><dl class="section warning"><dt>警告</dt><dd>Inside <a class="el" href="classtf_1_1cuda_flow_capturer.html#ad0d937ae0d77239f148b66a77e35db41" title="captures a sequential CUDA operations from the given callable">tf::cudaFlowCapturer::on</a>, you should <em>NOT</em> modify the properties of the stream argument but only use it to capture <em>asynchronous</em> GPU operations (e.g., <code>kernel</code>, <code>cudaMemcpyAsync</code>). The stream argument is internal to the capturer use only.</dd></dl>
<h1><a class="anchor" id="CommonCaptureMethods"></a>
Common Capture Methods</h1>
<p><a class="el" href="classtf_1_1cuda_flow_capturer.html" title="class to create a cudaFlow graph using stream capture">tf::cudaFlowCapturer</a> defines a set of methods for capturing common GPU operations, such as <a class="el" href="classtf_1_1cuda_flow_capturer.html#a6f06c7f6954d8d67ad89f0eddfe285e9" title="captures a kernel">tf::cudaFlowCapturer::kernel</a>, <a class="el" href="classtf_1_1cuda_flow_capturer.html#ae84d097cdae9e2e8ce108dea760483ed" title="copies data between host and device asynchronously through a stream">tf::cudaFlowCapturer::memcpy</a>, <a class="el" href="classtf_1_1cuda_flow_capturer.html#a0d38965b380f940bf6cfc6667a281052" title="initializes or sets GPU memory to the given value byte by byte">tf::cudaFlowCapturer::memset</a>, and so on. For example, the following code snippet uses these pre-defined methods to construct a GPU task graph of one host-to-device copy, kernel, and one device-to-host copy, in this order of their dependencies.</p>
<div class="fragment"><div class="line"><a class="code hl_class" href="classtf_1_1cuda_flow_capturer.html">tf::cudaFlowCapturer</a> capturer;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// copy data from host_data to gpu_data</span></div>
<div class="line"><a class="code hl_class" href="classtf_1_1cuda_task.html">tf::cudaTask</a> h2d = capturer.<a class="code hl_function" href="classtf_1_1cuda_flow_capturer.html#ae84d097cdae9e2e8ce108dea760483ed">memcpy</a>(gpu_data, host_data, <a class="code hl_struct" href="structbytes.html">bytes</a>)</div>
<div class="line">                           .name(<span class="stringliteral">&quot;h2d&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// capture my_kernel to do computation on gpu_data</span></div>
<div class="line"><a class="code hl_class" href="classtf_1_1cuda_task.html">tf::cudaTask</a> kernel = capturer.<a class="code hl_function" href="classtf_1_1cuda_flow_capturer.html#a6f06c7f6954d8d67ad89f0eddfe285e9">kernel</a>(grid, <a class="code hl_typedef" href="mimalloc_8h.html#af7f922b73e3acdb4a430b72f1a1334a5">block</a>, shm_size, kernel, kernel_args);</div>
<div class="line">                              .name(<span class="stringliteral">&quot;my_kernel&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// copy data from gpu_data to host_data</span></div>
<div class="line"><a class="code hl_class" href="classtf_1_1cuda_task.html">tf::cudaTask</a> d2h = capturer.<a class="code hl_function" href="classtf_1_1cuda_flow_capturer.html#ae84d097cdae9e2e8ce108dea760483ed">memcpy</a>(host_data, gpu_data, <a class="code hl_struct" href="structbytes.html">bytes</a>)</div>
<div class="line">                           .name(<span class="stringliteral">&quot;d2h&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// build task dependencies</span></div>
<div class="line">h2d.<a class="code hl_function" href="classtf_1_1cuda_task.html#abdd68287ec4dff4216af34d1db44d1b4">precede</a>(kernel);</div>
<div class="line">kernel.<a class="code hl_function" href="classtf_1_1cuda_task.html#abdd68287ec4dff4216af34d1db44d1b4">precede</a>(d2h);</div>
<div class="ttc" id="aclasstf_1_1cuda_flow_capturer_html_a6f06c7f6954d8d67ad89f0eddfe285e9"><div class="ttname"><a href="classtf_1_1cuda_flow_capturer.html#a6f06c7f6954d8d67ad89f0eddfe285e9">tf::cudaFlowCapturer::kernel</a></div><div class="ttdeci">cudaTask kernel(dim3 g, dim3 b, size_t s, F f, ArgsT &amp;&amp;... args)</div><div class="ttdoc">captures a kernel</div><div class="ttdef"><b>定义</b> cuda_capturer.hpp:595</div></div>
<div class="ttc" id="aclasstf_1_1cuda_flow_capturer_html_ae84d097cdae9e2e8ce108dea760483ed"><div class="ttname"><a href="classtf_1_1cuda_flow_capturer.html#ae84d097cdae9e2e8ce108dea760483ed">tf::cudaFlowCapturer::memcpy</a></div><div class="ttdeci">cudaTask memcpy(void *dst, const void *src, size_t count)</div><div class="ttdoc">copies data between host and device asynchronously through a stream</div><div class="ttdef"><b>定义</b> cuda_capturer.hpp:562</div></div>
<div class="ttc" id="amimalloc_8h_html_af7f922b73e3acdb4a430b72f1a1334a5"><div class="ttname"><a href="mimalloc_8h.html#af7f922b73e3acdb4a430b72f1a1334a5">block</a></div><div class="ttdeci">const mi_heap_area_t void * block</div><div class="ttdoc">This is the const version of block(Index,Index,Index,Index). *‍/</div><div class="ttdef"><b>定义</b> mimalloc.h:265</div></div>
<div class="ttc" id="astructbytes_html"><div class="ttname"><a href="structbytes.html">bytes</a></div><div class="ttdef"><b>定义</b> format.h:3864</div></div>
</div><!-- fragment --><h1><a class="anchor" id="CreateACapturerOnASpecificGPU"></a>
Create a Capturer on a Specific GPU</h1>
<p>You can run a cudaFlow capturer on a specific GPU by switching to the context of that GPU using <a class="el" href="classtf_1_1cuda_scoped_device.html" title="class to create an RAII-styled context switch">tf::cudaScopedDevice</a>, following the CUDA convention of multi-GPU programming. The example below creates a cudaFlow capturer and runs it on GPU <code>2</code>:</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <span class="comment">// create an RAII-styled switcher to the context of GPU 2</span></div>
<div class="line">  <a class="code hl_class" href="classtf_1_1cuda_scoped_device.html">tf::cudaScopedDevice</a> <a class="code hl_class" href="classcontext.html">context</a>(2);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// create a cudaFlow capturer under GPU 2</span></div>
<div class="line">  <a class="code hl_class" href="classtf_1_1cuda_flow_capturer.html">tf::cudaFlowCapturer</a> capturer;</div>
<div class="line">  <span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">// create a stream under GPU 2 and offload the capturer to that GPU</span></div>
<div class="line">  <a class="code hl_typedef" href="namespacetf.html#af19c9b301dc0b0fe2a51a960fa427e83">tf::cudaStream</a> stream;</div>
<div class="line">  capturer.<a class="code hl_function" href="classtf_1_1cuda_flow_capturer.html#a952596fd7c46acee4c2459d8fe39da28">run</a>(stream);</div>
<div class="line">  stream.<a class="code hl_function" href="classtf_1_1cuda_stream_base.html#a08857ff2874cd5378e578822e2e96dd0">synchronize</a>();</div>
<div class="line">}</div>
<div class="ttc" id="aclasscontext_html"><div class="ttname"><a href="classcontext.html">context</a></div><div class="ttdef"><b>定义</b> base.h:2629</div></div>
<div class="ttc" id="aclasstf_1_1cuda_scoped_device_html"><div class="ttname"><a href="classtf_1_1cuda_scoped_device.html">tf::cudaScopedDevice</a></div><div class="ttdoc">class to create an RAII-styled context switch</div><div class="ttdef"><b>定义</b> cuda_device.hpp:293</div></div>
</div><!-- fragment --><p><a class="el" href="classtf_1_1cuda_scoped_device.html" title="class to create an RAII-styled context switch">tf::cudaScopedDevice</a> is an RAII-styled wrapper to perform <em>scoped</em> switch to the given GPU context. When the scope is destroyed, it switches back to the original context.</p>
<dl class="section attention"><dt>注意</dt><dd>By default, a cudaFlow capturer runs on the current GPU associated with the caller, which is typically <code>0</code>.</dd></dl>
<h1><a class="anchor" id="CreateACapturerWithinAcudaFlow"></a>
Create a Capturer from a cudaFlow</h1>
<p>Within a parent cudaFlow, you can capture a cudaFlow to form a subflow that eventually becomes a <em>child</em> node in the underlying CUDA task graph. The following example defines a captured flow <code>task2</code> of two dependent tasks, <code>task2_1</code> and <code>task2_2</code>, and <code>task2</code> runs after <code>task1</code>.</p>
<div class="fragment"><div class="line"><a class="code hl_class" href="classtf_1_1cuda_flow.html">tf::cudaFlow</a> cudaflow;</div>
<div class="line"> </div>
<div class="line"><a class="code hl_class" href="classtf_1_1cuda_task.html">tf::cudaTask</a> task1 = cudaflow.<a class="code hl_function" href="classtf_1_1cuda_graph_base.html#a1473a15a6023fbc25e1f029f2ff84aec">kernel</a>(grid, <a class="code hl_typedef" href="mimalloc_8h.html#af7f922b73e3acdb4a430b72f1a1334a5">block</a>, shm, my_kernel, <a class="code hl_define" href="tbbproxy_8cpp.html#acd08a6295eccfeb30c79985f047e4be5">args</a>...)</div>
<div class="line">                       .name(<span class="stringliteral">&quot;kernel&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// task2 forms a subflow as a child node in the underlying CUDA graph</span></div>
<div class="line"><a class="code hl_class" href="classtf_1_1cuda_task.html">tf::cudaTask</a> task2 = cudaflow.<a class="code hl_function" href="classtf_1_1cuda_flow.html#a89c389fff64a16e5dd8c60875d3b514d">capture</a>([&amp;](<a class="code hl_class" href="classtf_1_1cuda_flow_capturer.html">tf::cudaFlowCapturer</a>&amp; capturer){</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// capture kernel_1 using the given stream</span></div>
<div class="line">  <a class="code hl_class" href="classtf_1_1cuda_task.html">tf::cudaTask</a> task2_1 = capturer.<a class="code hl_function" href="classtf_1_1cuda_flow_capturer.html#ad0d937ae0d77239f148b66a77e35db41">on</a>([&amp;](cudaStream_t stream){  </div>
<div class="line">    kernel_2&lt;&lt;&lt;grid1, block1, shm_size1, stream&gt;&gt;&gt;(args1...);</div>
<div class="line">  }).<a class="code hl_typedef" href="imgui__impl__opengl3__loader_8h.html#aab18cfce5ee7c6881ae04f18be70d94a">name</a>(<span class="stringliteral">&quot;kernel_1&quot;</span>);  </div>
<div class="line">  </div>
<div class="line">  <span class="comment">// capture kernel_2 using the given stream</span></div>
<div class="line">  <a class="code hl_class" href="classtf_1_1cuda_task.html">tf::cudaTask</a> task2_2 = capturer.<a class="code hl_function" href="classtf_1_1cuda_flow_capturer.html#ad0d937ae0d77239f148b66a77e35db41">on</a>([&amp;](cudaStream_t stream){  </div>
<div class="line">    kernel_2&lt;&lt;&lt;grid2, block2, shm_size2, stream&gt;&gt;&gt;(args2...);</div>
<div class="line">  }).<a class="code hl_typedef" href="imgui__impl__opengl3__loader_8h.html#aab18cfce5ee7c6881ae04f18be70d94a">name</a>(<span class="stringliteral">&quot;kernel_2&quot;</span>);   </div>
<div class="line">  </div>
<div class="line">  <span class="comment">// kernel_1 runs before kernel_2</span></div>
<div class="line">  task2_1.<a class="code hl_function" href="classtf_1_1cuda_task.html#abdd68287ec4dff4216af34d1db44d1b4">precede</a>(task2_2);</div>
<div class="line">}).<a class="code hl_typedef" href="imgui__impl__opengl3__loader_8h.html#aab18cfce5ee7c6881ae04f18be70d94a">name</a>(<span class="stringliteral">&quot;capturer&quot;</span>);</div>
<div class="line"> </div>
<div class="line">task1.<a class="code hl_function" href="classtf_1_1cuda_task.html#abdd68287ec4dff4216af34d1db44d1b4">precede</a>(task2);</div>
<div class="ttc" id="aclasstf_1_1cuda_flow_html"><div class="ttname"><a href="classtf_1_1cuda_flow.html">tf::cudaFlow</a></div><div class="ttdoc">class to create a cudaFlow task dependency graph</div><div class="ttdef"><b>定义</b> cudaflow.hpp:51</div></div>
<div class="ttc" id="aclasstf_1_1cuda_flow_html_a89c389fff64a16e5dd8c60875d3b514d"><div class="ttname"><a href="classtf_1_1cuda_flow.html#a89c389fff64a16e5dd8c60875d3b514d">tf::cudaFlow::capture</a></div><div class="ttdeci">cudaTask capture(C &amp;&amp;callable)</div><div class="ttdoc">constructs a subflow graph through tf::cudaFlowCapturer</div></div>
<div class="ttc" id="aclasstf_1_1cuda_graph_base_html_a1473a15a6023fbc25e1f029f2ff84aec"><div class="ttname"><a href="classtf_1_1cuda_graph_base.html#a1473a15a6023fbc25e1f029f2ff84aec">tf::cudaGraphBase::kernel</a></div><div class="ttdeci">cudaTask kernel(dim3 g, dim3 b, size_t s, F f, ArgsT... args)</div><div class="ttdoc">creates a kernel task</div><div class="ttdef"><b>定义</b> cuda_graph.hpp:831</div></div>
<div class="ttc" id="atbbproxy_8cpp_html_acd08a6295eccfeb30c79985f047e4be5"><div class="ttname"><a href="tbbproxy_8cpp.html#acd08a6295eccfeb30c79985f047e4be5">args</a></div><div class="ttdeci">#define args</div></div>
</div><!-- fragment --><h1><a class="anchor" id="OffloadAcudaFlowCapturer"></a>
Offload a cudaFlow Capturer</h1>
<p>When you offload a cudaFlow capturer using <a class="el" href="classtf_1_1cuda_flow_capturer.html#a952596fd7c46acee4c2459d8fe39da28" title="offloads the cudaFlowCapturer onto a GPU asynchronously via a stream">tf::cudaFlowCapturer::run</a>, the runtime transforms that capturer (i.e., application GPU task graph) into a native CUDA graph and an executable instance both optimized for maximum kernel concurrency. Depending on the optimization algorithm, the application GPU task graph may be different from the actual executable graph submitted to the CUDA runtime.</p>
<div class="fragment"><div class="line"><a class="code hl_typedef" href="namespacetf.html#af19c9b301dc0b0fe2a51a960fa427e83">tf::cudaStream</a> stream;</div>
<div class="line"><span class="comment">// launch a cudaflow capturer asynchronously through a stream</span></div>
<div class="line">capturer.<a class="code hl_function" href="classtf_1_1cuda_flow_capturer.html#a952596fd7c46acee4c2459d8fe39da28">run</a>(stream);</div>
<div class="line"><span class="comment">// wait for the cudaflow to finish</span></div>
<div class="line">stream.<a class="code hl_function" href="classtf_1_1cuda_stream_base.html#a08857ff2874cd5378e578822e2e96dd0">synchronize</a>();</div>
</div><!-- fragment --><h1><a class="anchor" id="UpdateAcudaFlowCapturer"></a>
Update a cudaFlow Capturer</h1>
<p>Between successive offloads (i.e., executions of a cudaFlow capturer), you can update the captured task with a different set of parameters. Every task-creation method in <a class="el" href="classtf_1_1cuda_flow_capturer.html" title="class to create a cudaFlow graph using stream capture">tf::cudaFlowCapturer</a> has an overload to update the parameters of a created task by that method. The following example creates a kernel task and updates its parameter between successive runs:</p>
<div class="fragment"><div class="line"><a class="code hl_typedef" href="namespacetf.html#af19c9b301dc0b0fe2a51a960fa427e83">tf::cudaStream</a> stream;</div>
<div class="line"><a class="code hl_class" href="classtf_1_1cuda_flow_capturer.html">tf::cudaFlowCapturer</a> cf;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// create a kernel task</span></div>
<div class="line"><a class="code hl_class" href="classtf_1_1cuda_task.html">tf::cudaTask</a> <a class="code hl_define" href="test__partitioner__whitebox_8h.html#a5c4cf3d37a4eee22275de22cb9619863">task</a> = cf.<a class="code hl_function" href="classtf_1_1cuda_flow_capturer.html#a6f06c7f6954d8d67ad89f0eddfe285e9">kernel</a>(grid1, block1, shm1, kernel, kernel_args_1);</div>
<div class="line">cf.<a class="code hl_function" href="classtf_1_1cuda_flow_capturer.html#a952596fd7c46acee4c2459d8fe39da28">run</a>(stream);</div>
<div class="line">stream.<a class="code hl_function" href="classtf_1_1cuda_stream_base.html#a08857ff2874cd5378e578822e2e96dd0">synchronize</a>();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// update the created kernel task with different parameters</span></div>
<div class="line">cf.<a class="code hl_function" href="classtf_1_1cuda_flow_capturer.html#a6f06c7f6954d8d67ad89f0eddfe285e9">kernel</a>(<a class="code hl_define" href="test__partitioner__whitebox_8h.html#a5c4cf3d37a4eee22275de22cb9619863">task</a>, grid2, block2, shm2, kernel, kernel_args_2);</div>
<div class="line">cf.<a class="code hl_function" href="classtf_1_1cuda_flow_capturer.html#a952596fd7c46acee4c2459d8fe39da28">run</a>(stream);</div>
<div class="line">stream.<a class="code hl_function" href="classtf_1_1cuda_stream_base.html#a08857ff2874cd5378e578822e2e96dd0">synchronize</a>();</div>
<div class="ttc" id="atest__partitioner__whitebox_8h_html_a5c4cf3d37a4eee22275de22cb9619863"><div class="ttname"><a href="test__partitioner__whitebox_8h.html#a5c4cf3d37a4eee22275de22cb9619863">task</a></div><div class="ttdeci">#define task</div><div class="ttdef"><b>定义</b> test_partitioner_whitebox.h:76</div></div>
</div><!-- fragment --><p>When you run a updated cudaFlow capturer, Taskflow will try to update the underlying executable with the newly captured graph first. If that update is unsuccessful, Taskflow will destroy the executable graph and re-instantiate a new one from the newly captured graph.</p>
<h1><a class="anchor" id="IntegrateCudaFlowCapturerIntoTaskflow"></a>
Integrate a cudaFlow Capturer into Taskflow</h1>
<p>You can create a task to enclose a cudaFlow capturer and run it from a worker thread. The usage of the capturer remains the same except that the capturer is run by a worker thread from a taskflow task. The following example runs a cudaFlow capturer from a static task:</p>
<div class="fragment"><div class="line"><a class="code hl_class" href="classtf_1_1_executor.html">tf::Executor</a> <a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>;</div>
<div class="line"><a class="code hl_class" href="classtf_1_1_taskflow.html">tf::Taskflow</a> <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>;</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.emplace([](){</div>
<div class="line">  <span class="comment">// create a cudaFlow capturer inside a static task</span></div>
<div class="line">  <a class="code hl_class" href="classtf_1_1cuda_flow_capturer.html">tf::cudaFlowCapturer</a> capturer;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// ... capture a GPU task graph</span></div>
<div class="line">  capturer.<a class="code hl_function" href="classtf_1_1cuda_flow_capturer.html#a6f06c7f6954d8d67ad89f0eddfe285e9">kernel</a>(...);</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// run the capturer through a stream</span></div>
<div class="line">  <a class="code hl_typedef" href="namespacetf.html#af19c9b301dc0b0fe2a51a960fa427e83">tf::cudaStream</a> stream;</div>
<div class="line">  capturer.<a class="code hl_function" href="classtf_1_1cuda_flow_capturer.html#a952596fd7c46acee4c2459d8fe39da28">run</a>(stream);</div>
<div class="line">  stream.<a class="code hl_function" href="classtf_1_1cuda_stream_base.html#a08857ff2874cd5378e578822e2e96dd0">synchronize</a>();</div>
<div class="line">});</div>
<div class="ttc" id="aclasstf_1_1_executor_html"><div class="ttname"><a href="classtf_1_1_executor.html">tf::Executor</a></div><div class="ttdoc">class to create an executor for running a taskflow graph</div><div class="ttdef"><b>定义</b> executor-dl.hpp:51</div></div>
<div class="ttc" id="aclasstf_1_1_taskflow_html"><div class="ttname"><a href="classtf_1_1_taskflow.html">tf::Taskflow</a></div><div class="ttdoc">class to create a taskflow object</div><div class="ttdef"><b>定义</b> taskflow.hpp:67</div></div>
<div class="ttc" id="apoisson_8hpp_html_aa56fe360bb0ae38e0082f49e394ff825"><div class="ttname"><a href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a></div><div class="ttdeci">void taskflow(int nx, int ny, double dx, double dy, double *f, int itold, int itnew, double *u, double *unew, int block_size, unsigned num_threads)</div><div class="ttdef"><b>定义</b> taskflow.cpp:6</div></div>
<div class="ttc" id="athread__pool_8cpp_html_a543e564a8407bbeac15cb2d929fec755"><div class="ttname"><a href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a></div><div class="ttdeci">tf::Executor executor</div><div class="ttdef"><b>定义</b> thread_pool.cpp:6</div></div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">制作者 <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
