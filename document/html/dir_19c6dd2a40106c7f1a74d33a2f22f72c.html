<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>source: external/reflect-cpp/vcpkg/scripts/azure-pipelines/osx 目录参考</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">source
   </div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="搜索" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- 制作者 Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('dir_19c6dd2a40106c7f1a74d33a2f22f72c.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">载入中...</div>
<div class="SRStatus" id="Searching">搜索中...</div>
<div class="SRStatus" id="NoMatches">未找到</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">osx 目录参考</div></div>
</div><!--header-->
<div class="contents">
<div class="dynheader">
osx 的目录依赖关系图</div>
<div class="dyncontent">
<div class="center"><img src="dir_19c6dd2a40106c7f1a74d33a2f22f72c_dep.png" border="0" usemap="#adir__19c6dd2a40106c7f1a74d33a2f22f72c__dep" alt="external/reflect-cpp/vcpkg/scripts/azure-pipelines/osx"/></div>
<!-- MAP 0 -->
</div>
<a name="details" id="details"></a><h2 class="groupheader">详细描述</h2>
<p>This is the checklist for what the vcpkg team does when updating the macOS machines in the pool.</p>
<h1><a class="anchor" id="autotoc_md776"></a>
Creating new base images</h1>
<h2><a class="anchor" id="autotoc_md777"></a>
Prerequisites</h2>
<ul class="check">
<li class="unchecked"><a class="el" href="bench__gemm_8cpp.html#addc86e8508f14411ec98f521c520f875">A</a> Parallels license for amd64 or <a href="https://github.com/s-u/macosvm">macosvm</a> allow-listed by macOS for arm64. Note that the directory 'Parallels' is still used when using <code>macosvm</code> just so that scripts know where to find the VM and friends.</li>
</ul>
<ul class="check">
<li class="unchecked">An Xcode installer - you can get this from Apple's developer website, although you'll need to sign in first: <a href="https://developer.apple.com/downloads">https://developer.apple.com/downloads</a> <br  />
 If you are doing this from a local macos box, you can skip to the "update the macos host" step. <br  />
</li>
</ul>
<h2><a class="anchor" id="autotoc_md778"></a>
Instructions (AMD64)</h2>
<ul class="check">
<li class="unchecked">Go to <a href="https://dev.azure.com/vcpkg/public/_settings/agentqueues">https://dev.azure.com/vcpkg/public/_settings/agentqueues</a> , pick the current osx queue, and delete one of the agents that are idle.</li>
</ul>
<ul class="check">
<li class="unchecked">Go to that machine in the KVM. (Passwords are stored as secrets in the CPP_GITHUB\vcpkg\vcpkgmm-passwords key vault)</li>
</ul>
<ul class="check">
<li class="unchecked">Open the Parallels Control Center, and delete the active VM.</li>
</ul>
<ul class="check">
<li class="unchecked">Update the macos host</li>
</ul>
<ul class="check">
<li class="unchecked">Update or install parallels</li>
</ul>
<ul class="check">
<li class="unchecked">Download the macOS installer from the app store. See <a href="https://support.apple.com/en-us/102662">https://support.apple.com/en-us/102662</a> <br  />
 Note: This portion of the instructions is that which breaks most often depending on what Parallels and macOS are doing. You might need to use <code>softwareupdate --fetch-full-installer --full-installer-version 14.5</code> and point Parallels at that resulting installer in 'Applications' instead.</li>
</ul>
<ul class="check">
<li class="unchecked"><a class="el" href="struct_run.html">Run</a> parallels, and select that installer you just downloaded. Name the VM "vcpkg-osx-&lt;DATE&gt;-amd64", for example "vcpkg-osx-2024-07-12-amd64".</li>
</ul>
<ul class="check">
<li class="unchecked">When creating the VM, customize the hardware to the following:<ul>
<li>12 processors</li>
<li>24000 MB of memory</li>
<li>350 GB disk</li>
<li>Do not share mac camera</li>
</ul>
</li>
</ul>
<ul class="check">
<li class="unchecked">Install MacOS like you would on real hardware.<ul>
<li>Apple ID: 'Set Up Later' / Skip</li>
<li>Account name: vcpkg</li>
<li><a class="el" href="bench__gemm_8cpp.html#addc86e8508f14411ec98f521c520f875">A</a> very similar password :)</li>
<li>Don't enable Ask Siri</li>
</ul>
</li>
</ul>
<ul class="check">
<li class="unchecked">Install Parallels Tools</li>
</ul>
<ul class="check">
<li class="unchecked">Restart the VM</li>
</ul>
<ul class="check">
<li class="unchecked">Change the desktop background to a solid color</li>
</ul>
<ul class="check">
<li class="unchecked">Enable remote login in System Settings -&gt; General -&gt; Sharing -&gt; Remote Login</li>
</ul>
<ul class="check">
<li class="unchecked">Update the Azure Agent URI in setup-box.sh to the current version. You can find this by going to the agent pool, selecting "New agent", picking macOS, and copying the link. For example <a href="https://vstsagentpackage.azureedge.net/agent/3.241.0/vsts-agent-osx-x64-3.241.0.tar.gz">https://vstsagentpackage.azureedge.net/agent/3.241.0/vsts-agent-osx-x64-3.241.0.tar.gz</a></li>
</ul>
<ul class="check">
<li class="unchecked">Start the VM. Change the screen resolution to not be teeny weeny eyestrain o vision.</li>
</ul>
<ul class="check">
<li class="unchecked">In the guest, set the vcpkg user to be able to use sudo without a password: <div class="fragment"><div class="line">printf &#39;vcpkg\tALL=(ALL)\tNOPASSWD:\tALL\n&#39; | sudo tee -a &#39;/etc/sudoers.d/vcpkg&#39;</div>
<div class="line">sudo chmod 0440 &#39;/etc/sudoers.d/vcpkg&#39;</div>
</div><!-- fragment --></li>
</ul>
<ul class="check">
<li class="unchecked">Copy setup-guest, setup-box.sh, and the xcode installer renamed to 'clt.dmg' to the host, and run setup-guest.sh. For example: <div class="fragment"><div class="line">scp ./setup-guest.sh vcpkg@MACHINE:/Users/vcpkg</div>
<div class="line">scp ./setup-box.sh vcpkg@MACHINE:/Users/vcpkg</div>
<div class="line">scp path/to/console/tools.dmg vcpkg@MACHINE:/Users/vcpkg/clt.dmg</div>
<div class="line">ssh vcpkg@MACHINE</div>
<div class="line">rm ~/.ssh/known_hosts</div>
<div class="line">chmod +x setup-guest.sh</div>
<div class="line">./setup-guest.sh</div>
<div class="line">rm setup-guest.sh</div>
<div class="line">rm setup-box.sh</div>
<div class="line">rm clt.dmg</div>
</div><!-- fragment --></li>
</ul>
<ul class="check">
<li class="unchecked">In the guest, check that 'm4' works in the terminal. If it tries to reinstall the command line tools, let it do that. You might need to manually run this workaround from <a href="https://developer.apple.com/documentation/xcode-release-notes/xcode-15-release-notes#Known-Issues">https://developer.apple.com/documentation/xcode-release-notes/xcode-15-release-notes#Known-Issues</a> <div class="fragment"><div class="line">sudo mkdir -p /Library/Developer/CommandLineTools</div>
<div class="line">sudo touch /Library/Developer/CommandLineTools/.beta</div>
</div><!-- fragment --></li>
</ul>
<ul class="check">
<li class="unchecked">Shut down the VM cleanly</li>
</ul>
<ul class="check">
<li class="unchecked">Set the VM 'Isolated'</li>
</ul>
<ul class="check">
<li class="unchecked">In Parallels control center, right click the VM and select "Prepare for Transfer"</li>
</ul>
<ul class="check">
<li class="unchecked">In Parallels control center, right click the VM and remove it, but "Keep Files"</li>
</ul>
<ul class="check">
<li class="unchecked">Copy the packaged VM to Azure <a class="el" href="struct_storage.html">Storage</a>, with something like: <div class="fragment"><div class="line">ssh vcpkg@MACHINE</div>
<div class="line">brew install azcopy</div>
<div class="line">azcopy copy ~/Parallels/vcpkg-osx-2024-07-12-amd64.pvmp &quot;https://vcpkgimageminting...../pvms?&lt;SAS&gt;&quot;</div>
<div class="line">azcopy copy ~/Parallels/vcpkg-osx-2024-07-12-amd64.sha256.txt &quot;https://vcpkgimageminting...../pvms?&lt;SAS&gt;&quot;</div>
</div><!-- fragment --></li>
</ul>
<ul class="check">
<li class="unchecked">Go to <a href="https://dev.azure.com/vcpkg/public/_settings/agentqueues">https://dev.azure.com/vcpkg/public/_settings/agentqueues</a> and create a new self hosted Agent pool named <code>PrOsx-YYYY-MM-DD</code> based on the current date. <a class="el" href="struct_check.html">Check</a> 'Grant access permission to all pipelines.'</li>
</ul>
<ul class="check">
<li class="unchecked">Remove the macOS installer from Applications</li>
</ul>
<ul class="check">
<li class="unchecked">Follow the "Deploying images" steps below for each machine in the fleet.</li>
</ul>
<h2><a class="anchor" id="autotoc_md779"></a>
Instructions (ARM64)</h2>
<ul class="check">
<li class="unchecked">Go to <a href="https://dev.azure.com/vcpkg/public/_settings/agentqueues">https://dev.azure.com/vcpkg/public/_settings/agentqueues</a> , pick the current osx queue, and delete one of the agents that are idle.</li>
</ul>
<ul class="check">
<li class="unchecked">Go to that machine in the KVM. (Passwords are stored as secrets in the CPP_GITHUB\vcpkg\vcpkgmm-passwords key vault)</li>
</ul>
<ul class="check">
<li class="unchecked">Update the macos host</li>
</ul>
<ul class="check">
<li class="unchecked">(Once only) install <code>macosvm</code> to <code>~</code> (this tarball is also backed up in our <code>vcpkg-image-minting</code> storage account): <div class="fragment"><div class="line">curl -L -o macosvm-0.2-1-arm64-darwin21.tar.gz https://github.com/s-u/macosvm/releases/download/0.2-1/macosvm-0.2-1-arm64-darwin21.tar.gz</div>
<div class="line">tar xvf macosvm-0.2-1-arm64-darwin21.tar.gz</div>
<div class="line">rm macosvm-0.2-1-arm64-darwin21.tar.gz</div>
</div><!-- fragment --></li>
</ul>
<ul class="check">
<li class="unchecked">Download the matching <code>.ipsw</code> for the macOS copy to install. See <a href="https://mrmacintosh.com/apple-silicon-m1-full-macos-restore-ipsw-firmware-files-database/">https://mrmacintosh.com/apple-silicon-m1-full-macos-restore-ipsw-firmware-files-database/</a> ; links there to find the .ipsw. Example: <a href="https://updates.cdn-apple.com/2024SpringFCS/fullrestores/062-01897/C874907B-9F82-4109-87EB-6B3C9BF1507D/UniversalMac_14.5_23F79_Restore.ipsw">https://updates.cdn-apple.com/2024SpringFCS/fullrestores/062-01897/C874907B-9F82-4109-87EB-6B3C9BF1507D/UniversalMac_14.5_23F79_Restore.ipsw</a></li>
</ul>
<ul class="check">
<li class="unchecked">Determine the VM name using the form "vcpkg-osx-&lt;date&gt;-arm64", for example "vcpkg-osx-2024-07-12-arm64".</li>
</ul>
<ul class="check">
<li class="unchecked">Open a terminal and run the following commands to create the VM with vcpkg-osx-2024-07-12-arm64 and UniversalMac_14.5_23F79_Restore.ipsw replaced as appropriate. <div class="fragment"><div class="line">mkdir -p ~/Parallels/vcpkg-osx-2024-07-12-arm64</div>
<div class="line">cd ~/Parallels/vcpkg-osx-2024-07-12-arm64</div>
<div class="line">~/macosvm --disk disk.img,size=500g --aux aux.img -c 8 -r 12g --restore ~/UniversalMac_14.5_23F79_Restore.ipsw ./vm.json</div>
<div class="line">~/macosvm -g ./vm.json</div>
</div><!-- fragment --></li>
</ul>
<ul class="check">
<li class="unchecked">Follow prompts as you would on real hardware.<ul>
<li>Apple ID: 'Set Up Later' / Skip</li>
<li>Account name: vcpkg</li>
<li><a class="el" href="bench__gemm_8cpp.html#addc86e8508f14411ec98f521c520f875">A</a> very similar password</li>
<li>No location services</li>
<li>Yes send crash reports</li>
</ul>
</li>
</ul>
<ul class="check">
<li class="unchecked">Set the desktop wallpaper to a fixed color from Settings -&gt; Wallpaper . (This makes the KVM a lot easier to use :) )</li>
</ul>
<ul class="check">
<li class="unchecked">Enable remote login in the VM: Settings -&gt; General -&gt; Sharing -&gt; Remote Login</li>
</ul>
<ul class="check">
<li class="unchecked">Set the vcpkg user to be able to use sudo without a password: <div class="fragment"><div class="line">ssh vcpkg@vcpkgs-Virtual-Machine.local</div>
<div class="line">printf &#39;vcpkg\tALL=(ALL)\tNOPASSWD:\tALL\n&#39; | sudo tee -a &#39;/etc/sudoers.d/vcpkg&#39;</div>
<div class="line">sudo chmod 0440 &#39;/etc/sudoers.d/vcpkg&#39;</div>
<div class="line">exit</div>
</div><!-- fragment --></li>
</ul>
<ul class="check">
<li class="unchecked">Update the Azure Agent URI in setup-box.sh to the current version. You can find this by going to the agent pool, selecting "New agent", picking macOS, and copying the link. For example <a href="https://vstsagentpackage.azureedge.net/agent/3.241.0/vsts-agent-osx-arm64-3.241.0.tar.gz">https://vstsagentpackage.azureedge.net/agent/3.241.0/vsts-agent-osx-arm64-3.241.0.tar.gz</a></li>
</ul>
<ul class="check">
<li class="unchecked">Copy setup-box.sh and the xcode installer renamed to 'clt.dmg' to the host. For example from a dev workstation: <div class="fragment"><div class="line">scp ./setup-guest.sh vcpkg@MACHINE:/Users/vcpkg</div>
<div class="line">scp ./setup-box.sh vcpkg@MACHINE:/Users/vcpkg</div>
<div class="line">scp path/to/console/tools.dmg vcpkg@MACHINE:/Users/vcpkg/clt.dmg</div>
<div class="line">ssh vcpkg@MACHINE</div>
<div class="line">chmod +x setup-guest.sh</div>
<div class="line">rm ~/.ssh/known_hosts</div>
<div class="line">./setup-guest.sh</div>
<div class="line">rm setup-guest.sh</div>
<div class="line">rm setup-box.sh</div>
<div class="line">rm clt.dmg</div>
</div><!-- fragment --></li>
</ul>
<ul class="check">
<li class="unchecked">In the guest, check that 'm4' works in the terminal. If it tries to reinstall the command line tools, let it do that. You might need to manually run this workaround from <a href="https://developer.apple.com/documentation/xcode-release-notes/xcode-15-release-notes#Known-Issues">https://developer.apple.com/documentation/xcode-release-notes/xcode-15-release-notes#Known-Issues</a> <div class="fragment"><div class="line">sudo mkdir -p /Library/Developer/CommandLineTools</div>
<div class="line">sudo touch /Library/Developer/CommandLineTools/.beta</div>
</div><!-- fragment --></li>
</ul>
<ul class="check">
<li class="unchecked">Shut down the VM cleanly.</li>
</ul>
<ul class="check">
<li class="unchecked">Mint a SAS token to vcpkgimageminting/pvms with read, add, create, write, and list permissions.</li>
</ul>
<ul class="check">
<li class="unchecked">Open a terminal on the host and package the VM into a tarball: <div class="fragment"><div class="line">cd ~/Parallels</div>
<div class="line">aa archive -d vcpkg-osx-&lt;date&gt;-arm64 -o vcpkg-osx-&lt;date&gt;-arm64.aar -enable-holes</div>
<div class="line">brew install azcopy</div>
<div class="line">azcopy copy vcpkg-osx-&lt;date&gt;-arm64.aar &quot;https://vcpkgimageminting.blob.core.windows.net/pvms?&lt;SAS&gt;&quot;</div>
<div class="line">rm *.aar</div>
</div><!-- fragment --></li>
</ul>
<ul class="check">
<li class="unchecked">Go to <a href="https://dev.azure.com/vcpkg/public/_settings/agentqueues">https://dev.azure.com/vcpkg/public/_settings/agentqueues</a> and create a new self hosted Agent pool named <code>PrOsx-YYYY-MM-DD-arm64</code> based on the current date. <a class="el" href="struct_check.html">Check</a> 'Grant access permission to all pipelines.'</li>
</ul>
<ul class="check">
<li class="unchecked">Follow the "Deploying images" steps below for each machine in the fleet.</li>
</ul>
<h1><a class="anchor" id="autotoc_md780"></a>
Deploying images</h1>
<h2><a class="anchor" id="autotoc_md781"></a>
Running the VM (AMD64)</h2>
<p><a class="el" href="struct_run.html">Run</a> these steps on each machine to add to the fleet. Skip steps that were done implicitly above if this machine was used to build a box.</p>
<ul class="check">
<li class="unchecked">If this machine was used before, delete it from the pool of which it is a member from <a href="https://dev.azure.com/vcpkg/public/_settings/agentqueues">https://dev.azure.com/vcpkg/public/_settings/agentqueues</a></li>
</ul>
<ul class="check">
<li class="unchecked">Log in to the machine using the KVM.</li>
</ul>
<ul class="check">
<li class="unchecked"><a class="el" href="struct_check.html">Check</a> for software updates in macOS system settings</li>
</ul>
<ul class="check">
<li class="unchecked"><a class="el" href="struct_check.html">Check</a> for software updates in Parallels' UI</li>
</ul>
<ul class="check">
<li class="unchecked">Mint a SAS token URI to the box to use from the Azure portal if you don't already have one, and download the VM. (Recommend running this via SSH from domain joined machine due to containing SAS tokens) <div class="fragment"><div class="line">brew install azcopy</div>
<div class="line">cd ~/Parallels</div>
<div class="line">azcopy copy &quot;https://vcpkgimageminting.blob.core.windows.net/pvms/vcpkg-osx-&lt;DATE&gt;-amd64.pvmp?&lt;SAS&gt;&quot; .</div>
<div class="line">azcopy copy &quot;https://vcpkgimageminting.blob.core.windows.net/pvms/vcpkg-osx-&lt;DATE&gt;-amd64.sha256.txt?&lt;SAS&gt;&quot; .</div>
</div><!-- fragment --></li>
</ul>
<ul class="check">
<li class="unchecked">Open the .pvmp in Parallels, and unpack it.</li>
</ul>
<ul class="check">
<li class="unchecked">Start the VM</li>
</ul>
<ul class="check">
<li class="unchecked">grab a PAT if you don't already have one</li>
</ul>
<ul class="check">
<li class="unchecked">Copy the guest deploy script to the host, and run it with a first parameter of your PAT <div class="fragment"><div class="line">scp ./register-guest.sh vcpkg@MACHINE:/Users/vcpkg</div>
<div class="line">ssh vcpkg@MACHINE</div>
<div class="line">rm ~/.ssh/known_hosts</div>
<div class="line">chmod +x /Users/vcpkg/register-guest.sh</div>
<div class="line">/Users/vcpkg/register-guest.sh &lt;PAT&gt;</div>
</div><!-- fragment --></li>
</ul>
<ul class="check">
<li class="unchecked">Open a terminal window on the host and run the agent <div class="fragment"><div class="line">ssh -i ~/Parallels/*/id_guest vcpkg@`prlctl list --full | sed -nr &#39;s/^.*running *([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}).*/\1/p&#39;`</div>
<div class="line">~/myagent/run.sh</div>
</div><!-- fragment --></li>
</ul>
<ul class="check">
<li class="unchecked"><a class="el" href="struct_check.html">Check</a> that the machine shows up in the pool, and lock the vcpkg user on the host.</li>
</ul>
<ul class="check">
<li class="unchecked">Lock the screen on the host.</li>
</ul>
<ul class="check">
<li class="unchecked">Update the "vcpkg Macs" spreadsheet line for the machine with the new pool.</li>
</ul>
<h2><a class="anchor" id="autotoc_md782"></a>
Running the VM (ARM64)</h2>
<p><a class="el" href="struct_run.html">Run</a> these steps on each machine to add to the fleet. Skip steps that were done implicitly above if this machine was used to build a box.</p>
<ul class="check">
<li class="unchecked">If this machine was used before, delete it from the pool of which it is a member from <a href="https://dev.azure.com/vcpkg/public/_settings/agentqueues">https://dev.azure.com/vcpkg/public/_settings/agentqueues</a></li>
</ul>
<ul class="check">
<li class="unchecked">Log in to the machine using the KVM.</li>
</ul>
<ul class="check">
<li class="unchecked"><a class="el" href="struct_check.html">Check</a> for software updates in macOS system settings</li>
</ul>
<ul class="check">
<li class="unchecked">(Once only) install <code>macosvm</code> to <code>~</code> (this tarball is also backed up in our <code>vcpkg-image-minting</code> storage account): <div class="fragment"><div class="line">curl -L -o macosvm-0.2-1-arm64-darwin21.tar.gz https://github.com/s-u/macosvm/releases/download/0.2-1/macosvm-0.2-1-arm64-darwin21.tar.gz</div>
<div class="line">tar xvf macosvm-0.2-1-arm64-darwin21.tar.gz</div>
<div class="line">rm macosvm-0.2-1-arm64-darwin21.tar.gz</div>
</div><!-- fragment --></li>
</ul>
<ul class="check">
<li class="unchecked">Skip if this is the image building machine. Mint a SAS token URI to the box to use from the Azure portal if you don't already have one, and download the VM. (Recommend running this via SSH from domain joined machine due to containing SAS tokens) <div class="fragment"><div class="line">mkdir -p ~/Parallels</div>
<div class="line">cd ~/Parallels</div>
<div class="line">azcopy copy &quot;https://vcpkgimageminting.blob.core.windows.net/pvms/vcpkg-osx-&lt;DATE&gt;-arm64.aar?&lt;SAS&gt;&quot; vcpkg-osx-&lt;DATE&gt;-arm64.aar</div>
<div class="line">aa extract -d vcpkg-osx-&lt;DATE&gt;-arm64 -i ./vcpkg-osx-&lt;DATE&gt;-arm64.aar -enable-holes</div>
</div><!-- fragment --></li>
</ul>
<ul class="check">
<li class="unchecked">Open a separate terminal window on the host and start the VM by running: <div class="fragment"><div class="line">cd ~/Parallels/vcpkg-osx-&lt;DATE&gt;-arm64</div>
<div class="line">~/macosvm ./vm.json</div>
</div><!-- fragment --></li>
</ul>
<ul class="check">
<li class="unchecked">grab a PAT if you don't already have one</li>
</ul>
<ul class="check">
<li class="unchecked">Copy the guest deploy script to the host, and run it with a first parameter of your PAT. From a developer machine: <div class="fragment"><div class="line">scp ./register-guest.sh vcpkg@MACHINE:/Users/vcpkg</div>
<div class="line">ssh vcpkg@MACHINE</div>
<div class="line">rm ~/.ssh/known_hosts</div>
<div class="line">chmod +x register-guest.sh</div>
<div class="line">./register-guest.sh &lt;PAT&gt;</div>
<div class="line">rm register-guest.sh</div>
<div class="line">exit</div>
</div><!-- fragment --></li>
</ul>
<ul class="check">
<li class="unchecked">In the KVM's terminal, relaunch the VM in ephemeral mode with: <div class="fragment"><div class="line">~/macosvm --ephemeral ./vm.json</div>
</div><!-- fragment --></li>
</ul>
<ul class="check">
<li class="unchecked">Open a terminal window on the host and run the agent <div class="fragment"><div class="line">ssh -i ~/Parallels/*/id_guest vcpkg@vcpkgs-Virtual-Machine.local</div>
<div class="line">~/myagent/run.sh</div>
</div><!-- fragment --></li>
</ul>
<ul class="check">
<li class="unchecked"><a class="el" href="struct_check.html">Check</a> that the machine shows up in the pool, and lock the vcpkg user on the host.</li>
</ul>
<ul class="check">
<li class="unchecked">Lock the screen on the host.</li>
</ul>
<ul class="check">
<li class="unchecked">Update the "vcpkg Macs" spreadsheet line for the machine with the new pool.</li>
</ul>
<h1><a class="anchor" id="autotoc_md783"></a>
Getting an Azure Pipelines PAT</h1>
<p>Personal Access Tokens are an important part of this process, and they are fairly easy to generate. On ADO, under the correct project (in vcpkg's case, "vcpkg"), click on the "User Settings" icon, then go to "Personal access tokens". It is the icon to the left of your user icon, in the top right corner.</p>
<p>Then, create a new token, give it a name, make sure it expires quickly, and give it a custom defined scope that includes the "Agent pools: Read &amp; manage" permission (you'll need to "Show all scopes" to access this). You can now copy this token and use it to allow machines to join. </p>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_397d9aeee4af8edecac90968d93b57df.html">external</a></li><li class="navelem"><a class="el" href="dir_ec22af54b9d0dc12688f514bfd105c6b.html">reflect-cpp</a></li><li class="navelem"><a class="el" href="dir_fe763c7555057702fe8e67941795fb0a.html">vcpkg</a></li><li class="navelem"><a class="el" href="dir_a7873c6a8ed610d3c329ce8a3fc839a9.html">scripts</a></li><li class="navelem"><a class="el" href="dir_06b8c09f794672536533b44b75734e66.html">azure-pipelines</a></li><li class="navelem"><a class="el" href="dir_19c6dd2a40106c7f1a74d33a2f22f72c.html">osx</a></li>
    <li class="footer">制作者 <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
