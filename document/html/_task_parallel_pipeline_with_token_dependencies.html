<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>source: Task-parallel Pipeline with Token Dependencies</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">source
   </div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="搜索" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- 制作者 Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('_task_parallel_pipeline_with_token_dependencies.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">载入中...</div>
<div class="SRStatus" id="Searching">搜索中...</div>
<div class="SRStatus" id="NoMatches">未找到</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Task-parallel Pipeline with Token Dependencies</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>目录</h3>
<ul>
  <li class="level1">
    <a href="#DeferredPipelineTokenDependencies">Understand Token Dependencies</a>
  </li>
  <li class="level1">
    <a href="#DeferredPipelineResolveTokenDependencies">Resolve Token Dependencies</a>
  </li>
  <li class="level1">
    <a href="#DeferredPipelineIncludeHeaderFile">Include the Header</a>
  </li>
  <li class="level1">
    <a href="#CreateADeferredPipelineModuleTask">Create a Deferred Pipeline Module Task</a>
  </li>
  <li class="level1">
    <a href="#CreateADeferredScalablePipelineModuleTask">Create a Deferred Scalable Pipeline Module Task</a>
  </li>
  <li class="level1">
    <a href="#ParalleliDeferredScalablePipelineLearnMore">Learn More about Taskflow Pipeline</a>
  </li>
</ul>
</div>
<div class="textblock"><p>Taskflow pipeline allows you to defer the execution of a token to future tokens. This deferral introduces a dependency from a future token to the current token, particularly suitable for many video encoding applications. We recommend reading <a class="el" href="_task_parallel_pipeline.html">Task-parallel Pipeline</a> first before learning this interface.</p>
<h1><a class="anchor" id="DeferredPipelineTokenDependencies"></a>
Understand Token Dependencies</h1>
<p>Token dependencies establish the order in which data tokens should execute in a task-parallel pipeline. When token <code>t1</code> completes before <code>t2</code> starts, there is a dependency from <code>t1</code> to <code>t2</code>. We categorize token dependencies into two types:</p><ul>
<li>forward token dependencies (FTD): dependencies from earlier to future tokens</li>
<li>backward token dependencies (BTD): dependencies from future to earlier tokens The following figure illustrates a sample token dependency diagram and its token execution sequence. Edge pointing from token 2 to 5 is FTD, and those from 8 to 2 and 5 and 9 to 5 are BTDs. Based on the dependencies, the tokens execute in the corresponding execution sequence.</li>
</ul>
<div class="image">
<img src="images/token_dependencies.png" alt="" width="60%"/>
</div>
<h1><a class="anchor" id="DeferredPipelineResolveTokenDependencies"></a>
Resolve Token Dependencies</h1>
<p>To resolve the token dependencies, the basic idea is to defer the execution of a token with unresolved dependencies and save the token in a data structure until its dependencies are resolved. To implement the idea, we leverage three data structures, deferred_tokens (DT), token_dependencies (TD), and ready_tokens (RT). DT and TD are associative containers and RT is a queue. DT stores deferred tokens and their dependents by which the deferred tokens are deferred. TD stores a dependent and its related deferred tokens. RT stores the tokens that were deferred tokens and now are ready because their dependencies are resolved. The following image illustrates the usages of the three data structures to resolve the token dependencies and get the corresponding serial execution sequence exemplified in <a class="el" href="#DeferredPipelineTokenDependencies">Understand Token Dependencies</a>.</p>
<div class="image">
<img src="images/deferred_three_data_structures.png" alt="" width="90%"/>
</div>
<p>The whole process has the following steps:</p>
<ol type="1">
<li>Token 1 is not a deferred token and then 1 is finished. Now the execution sequence is {1}.</li>
<li>Token 2 defers to 8. We insert DT[2]={8} and TD[8]={2}. The black circle 2 in the above image illustrates this step.</li>
<li>Token 3 is not a deferred token and then 3 is finished. Now the execution sequence is {1,3}.</li>
<li>Token 4 is not a deferred token and then 4 is finished. Now the execution sequence is {1,3,4}.</li>
<li>Token 5 defers to 2 and 7. We insert DT[5]={2,7}, TD[2]={5}, and TD[7]={5}. The black circle 5 in the above image illustrates this step.</li>
<li>Token 6 is not a deferred token and then 6 is finished. Now the execution sequence is {1,3,4,6}.</li>
<li>Token 7 is not a deferred token and then 7 is finished. Now the execution sequence is {1,3,4,6,7}. Since TD[7]={5}, we directly remove 7 from DT[5]. The black circle 7 in the above image illustrates this step.</li>
<li>Token 8 is not a deferred token and then 8 is finished. Now the execution sequence is {1,3,4,6,7,8}. Since TD[8]={2}, we directly remove 8 from DT[2] and find out DT[2] is empty. Now token 2 is no longer a deferred token and we move 2 to RT. The black circle 8 in the above image illustrates this step.</li>
<li>RT is not empty and has a token 2. Then we finish running 2. Now the execution sequence is {1,3,4,6,7,8,2}. Since TD[2]={5}, we directly remove 2 from DT[5] and find out DT[5] is empty. Now token 5 is no longer a deferred token and we move 5 to RT. The black circle 9 in the above image illustrates this step.</li>
<li>RT is not empty and has a token 5. Then we run 5 and find out token 5 defers the second time, defers to 9. We insert DT[5]={9} and TD[9]={5}. The black circle 20 in the above image illustrates this step.</li>
<li>Token 9 is not a deferred token and then 9 is finished. Now the execution sequence is {1,3,4,6,7,8,2,9}. Since TD[9]={5}, we directly remove 9 from DT[5] and find out DT[5] is empty. Now token 5 is no longer a deferred token and we move 5 to RT. The black circle 11 in the above image illustrates this step.</li>
<li>RT is not empty and has a token 5. Then we finish running 5. Now the execution sequence is {1,3,4,6,7,8,2,9,5}. The black circle 12 in the above image illustrates this step.</li>
<li>Token 10 is not a deferred token and then 10 is finished. Now the execution sequence is {1,3,4,6,7,8,2,9,5,10}.</li>
</ol>
<h1><a class="anchor" id="DeferredPipelineIncludeHeaderFile"></a>
Include the Header</h1>
<p>You need to include the header file, <code>taskflow/algorithm/pipeline.hpp</code>, for implementing deferred pipeline algorithms.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="taskflow_2algorithm_2pipeline_8hpp.html">taskflow/algorithm/pipeline.hpp</a>&gt;</span></div>
<div class="ttc" id="ataskflow_2algorithm_2pipeline_8hpp_html"><div class="ttname"><a href="taskflow_2algorithm_2pipeline_8hpp.html">pipeline.hpp</a></div><div class="ttdoc">pipeline include file</div></div>
</div><!-- fragment --><h1><a class="anchor" id="CreateADeferredPipelineModuleTask"></a>
Create a Deferred Pipeline Module Task</h1>
<p>To create a deferred pipeline application, there are four steps, one more step than creating a task-parallel pipeline (<a class="el" href="classtf_1_1_pipeline.html" title="class to create a pipeline scheduling framework">tf::Pipeline</a>):</p>
<ol type="1">
<li>Define the pipeline structure (e.g., pipe type, pipe callable, stopping rule, line count)</li>
<li>Define the token dependencies <b>at the first pipe</b></li>
<li>Define the data storage and layout, if needed for the application</li>
<li>Define the pipeline taskflow graph using composition</li>
</ol>
<p>The following example demonstrates the creation of a deferred pipeline application exemplified in the dependency diagram in <a class="el" href="#DeferredPipelineTokenDependencies">Understand Token Dependencies</a>. The example creates a deferred pipeline that generates a total of 10 data tokens. The pipeline structure consists of four lines and three stages (all serial types).</p>
<div class="fragment"><div class="line"> 1: <a class="code hl_class" href="classtf_1_1_taskflow.html">tf::Taskflow</a> <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>(<span class="stringliteral">&quot;deferred_pipeline&quot;</span>);</div>
<div class="line"> 2: <a class="code hl_class" href="classtf_1_1_executor.html">tf::Executor</a> <a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>;</div>
<div class="line"> 3:</div>
<div class="line"> 4: <span class="keyword">const</span> <span class="keywordtype">size_t</span> num_lines = 4;</div>
<div class="line"> 5:</div>
<div class="line"> 6: <span class="comment">// the pipeline consists of three pipes (serial-serial-serial)</span></div>
<div class="line"> 7: <span class="comment">// and up to four concurrent scheduling tokens</span></div>
<div class="line"> 8: <a class="code hl_class" href="classtf_1_1_pipeline.html">tf::Pipeline</a> pl(num_lines,</div>
<div class="line"> 9:   <a class="code hl_class" href="classtf_1_1_pipe.html">tf::Pipe</a>{<a class="code hl_enumvalue" href="namespacetf.html#abb7a11e41fd457f69e7ff45d4c769564a7b804a28d6154ab8007287532037f1d0">tf::PipeType::SERIAL</a>, [](<a class="code hl_class" href="classtf_1_1_pipeflow.html">tf::Pipeflow</a>&amp; pf) {</div>
<div class="line">10:      <span class="comment">// stop at 11 scheduling tokens</span></div>
<div class="line">11:      <span class="keywordflow">if</span>(pf.token() == 11) {</div>
<div class="line">12:        pf.stop();</div>
<div class="line">13:      }</div>
<div class="line">14:      <span class="keywordflow">else</span> {</div>
<div class="line">15:        <span class="comment">// Token 5 is deferred</span></div>
<div class="line">16:        <span class="keywordflow">if</span> (pf.token() == 5) {</div>
<div class="line">17:          <span class="keywordflow">switch</span>(pf.num_deferrals()) {</div>
<div class="line">18:            <span class="keywordflow">case</span> 0:</div>
<div class="line">19:              pf.defer(2);</div>
<div class="line">20:              <a class="code hl_function" href="printf_8h.html#aee3ed3a831f25f07e7be3919fff2203a">printf</a>(<span class="stringliteral">&quot;1st-time: Token %zu is deferred by 2\n&quot;</span>, pf.token());</div>
<div class="line">21:              pf.defer(7);</div>
<div class="line">22:              <a class="code hl_function" href="printf_8h.html#aee3ed3a831f25f07e7be3919fff2203a">printf</a>(<span class="stringliteral">&quot;1st-time: Token %zu is deferred by 7\n&quot;</span>, pf.token());</div>
<div class="line">23:              <span class="keywordflow">return</span>;  </div>
<div class="line">24:            <span class="keywordflow">break</span>;</div>
<div class="line">25:</div>
<div class="line">26:            <span class="keywordflow">case</span> 1:</div>
<div class="line">27:              pf.defer(9);</div>
<div class="line">28:              <a class="code hl_function" href="printf_8h.html#aee3ed3a831f25f07e7be3919fff2203a">printf</a>(<span class="stringliteral">&quot;2nd-time: Token %zu is deferred by 9\n&quot;</span>, pf.token());</div>
<div class="line">29:              <span class="keywordflow">return</span>;</div>
<div class="line">30:            <span class="keywordflow">break</span>;</div>
<div class="line">31:</div>
<div class="line">32:            <span class="keywordflow">case</span> 2:</div>
<div class="line">33:              <a class="code hl_function" href="printf_8h.html#aee3ed3a831f25f07e7be3919fff2203a">printf</a>(<span class="stringliteral">&quot;3rd-time: Tokens 2, 7 and 9 resolved dependencies \</span></div>
<div class="line"><span class="stringliteral">                        for token %zu\n&quot;</span>, pf.token());</div>
<div class="line">34:            <span class="keywordflow">break</span>;</div>
<div class="line">35:          }</div>
<div class="line">36:        }</div>
<div class="line">37:        <span class="comment">// token 2 is deferred</span></div>
<div class="line">38:        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pf.token() == 2) {</div>
<div class="line">39:          <span class="keywordflow">switch</span>(pf.num_deferrals()) {</div>
<div class="line">40:            <span class="keywordflow">case</span> 0:</div>
<div class="line">41:              pf.defer(8);</div>
<div class="line">42:              <a class="code hl_function" href="printf_8h.html#aee3ed3a831f25f07e7be3919fff2203a">printf</a>(<span class="stringliteral">&quot;1st-time: Token %zu is deferred by 8\n&quot;</span>, pf.token());</div>
<div class="line">43:            <span class="keywordflow">break</span>;</div>
<div class="line">44:            <span class="keywordflow">case</span> 1:</div>
<div class="line">45:              <a class="code hl_function" href="printf_8h.html#aee3ed3a831f25f07e7be3919fff2203a">printf</a>(<span class="stringliteral">&quot;2nd-time: Token 8 resolved dependencies for token %zu\n&quot;</span>,</div>
<div class="line">                        pf.token());</div>
<div class="line">46:            <span class="keywordflow">break</span>;</div>
<div class="line">47:          }</div>
<div class="line">48:        }</div>
<div class="line">49:        <span class="keywordflow">else</span> {</div>
<div class="line">50:          <a class="code hl_function" href="printf_8h.html#aee3ed3a831f25f07e7be3919fff2203a">printf</a>(<span class="stringliteral">&quot;stage 1: Non-deferred token %zu\n&quot;</span>, pf.token());</div>
<div class="line">51:        }</div>
<div class="line">52:      }</div>
<div class="line">53:    }},</div>
<div class="line">54:</div>
<div class="line">55:    tf::Pipe{<a class="code hl_enumvalue" href="namespacetf.html#abb7a11e41fd457f69e7ff45d4c769564a7b804a28d6154ab8007287532037f1d0">tf::PipeType::SERIAL</a>, [](tf::Pipeflow&amp; pf) {</div>
<div class="line">56:      <a class="code hl_function" href="printf_8h.html#aee3ed3a831f25f07e7be3919fff2203a">printf</a>(<span class="stringliteral">&quot;stage 2: input token %zu (deferrals=%zu)\n&quot;</span>,</div>
<div class="line">                 pf.token(), pf.num_deferrals());</div>
<div class="line">57:    }},</div>
<div class="line">58:</div>
<div class="line">59:    tf::Pipe{<a class="code hl_enumvalue" href="namespacetf.html#abb7a11e41fd457f69e7ff45d4c769564a7b804a28d6154ab8007287532037f1d0">tf::PipeType::SERIAL</a>, [](tf::Pipeflow&amp; pf) {</div>
<div class="line">60:      <a class="code hl_function" href="printf_8h.html#aee3ed3a831f25f07e7be3919fff2203a">printf</a>(<span class="stringliteral">&quot;stage 3: input token %zu\n&quot;</span>, pf.token());</div>
<div class="line">61:    }}</div>
<div class="line">62:  );</div>
<div class="line">63:  </div>
<div class="line">64:  tf::Task <a class="code hl_define" href="test__partitioner__whitebox_8h.html#a5c4cf3d37a4eee22275de22cb9619863">task</a> = <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.composed_of(pl);</div>
<div class="line">65:</div>
<div class="line">66:  <span class="comment">// run the pipeline</span></div>
<div class="line">67:  <a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.<a class="code hl_function" href="classtf_1_1_executor.html#a519777f5783981d534e9e53b99712069">run</a>(<a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>).wait();</div>
<div class="ttc" id="aclasstf_1_1_executor_html"><div class="ttname"><a href="classtf_1_1_executor.html">tf::Executor</a></div><div class="ttdoc">class to create an executor for running a taskflow graph</div><div class="ttdef"><b>定义</b> executor-dl.hpp:51</div></div>
<div class="ttc" id="aclasstf_1_1_executor_html_a519777f5783981d534e9e53b99712069"><div class="ttname"><a href="classtf_1_1_executor.html#a519777f5783981d534e9e53b99712069">tf::Executor::run</a></div><div class="ttdeci">tf::Future&lt; void &gt; run(Taskflow &amp;taskflow)</div><div class="ttdoc">runs a taskflow once</div><div class="ttdef"><b>定义</b> executor-dl.hpp:2067</div></div>
<div class="ttc" id="aclasstf_1_1_pipe_html"><div class="ttname"><a href="classtf_1_1_pipe.html">tf::Pipe</a></div><div class="ttdoc">class to create a pipe object for a pipeline stage</div><div class="ttdef"><b>定义</b> pipeline.hpp:228</div></div>
<div class="ttc" id="aclasstf_1_1_pipeflow_html"><div class="ttname"><a href="classtf_1_1_pipeflow.html">tf::Pipeflow</a></div><div class="ttdoc">class to create a pipeflow object used by the pipe callable</div><div class="ttdef"><b>定义</b> pipeline.hpp:102</div></div>
<div class="ttc" id="aclasstf_1_1_pipeline_html"><div class="ttname"><a href="classtf_1_1_pipeline.html">tf::Pipeline</a></div><div class="ttdoc">class to create a pipeline scheduling framework</div><div class="ttdef"><b>定义</b> pipeline.hpp:404</div></div>
<div class="ttc" id="aclasstf_1_1_taskflow_html"><div class="ttname"><a href="classtf_1_1_taskflow.html">tf::Taskflow</a></div><div class="ttdoc">class to create a taskflow object</div><div class="ttdef"><b>定义</b> taskflow.hpp:67</div></div>
<div class="ttc" id="anamespacetf_html_abb7a11e41fd457f69e7ff45d4c769564a7b804a28d6154ab8007287532037f1d0"><div class="ttname"><a href="namespacetf.html#abb7a11e41fd457f69e7ff45d4c769564a7b804a28d6154ab8007287532037f1d0">tf::PipeType::SERIAL</a></div><div class="ttdeci">@ SERIAL</div><div class="ttdoc">serial type</div><div class="ttdef"><b>定义</b> pipeline.hpp:201</div></div>
<div class="ttc" id="apoisson_8hpp_html_aa56fe360bb0ae38e0082f49e394ff825"><div class="ttname"><a href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a></div><div class="ttdeci">void taskflow(int nx, int ny, double dx, double dy, double *f, int itold, int itnew, double *u, double *unew, int block_size, unsigned num_threads)</div><div class="ttdef"><b>定义</b> taskflow.cpp:6</div></div>
<div class="ttc" id="aprintf_8h_html_aee3ed3a831f25f07e7be3919fff2203a"><div class="ttname"><a href="printf_8h.html#aee3ed3a831f25f07e7be3919fff2203a">printf</a></div><div class="ttdeci">auto printf(string_view fmt, const T &amp;... args) -&gt; int</div><div class="ttdef"><b>定义</b> printf.h:621</div></div>
<div class="ttc" id="atest__partitioner__whitebox_8h_html_a5c4cf3d37a4eee22275de22cb9619863"><div class="ttname"><a href="test__partitioner__whitebox_8h.html#a5c4cf3d37a4eee22275de22cb9619863">task</a></div><div class="ttdeci">#define task</div><div class="ttdef"><b>定义</b> test_partitioner_whitebox.h:76</div></div>
<div class="ttc" id="athread__pool_8cpp_html_a543e564a8407bbeac15cb2d929fec755"><div class="ttname"><a href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a></div><div class="ttdeci">tf::Executor executor</div><div class="ttdef"><b>定义</b> thread_pool.cpp:6</div></div>
</div><!-- fragment --><p>Debrief:</p>
<ul>
<li>Line 8 defines the number of lines in the pipeline </li>
<li>Lines 9-52 define the first serial pipe, which will stop the pipeline scheduling at the 11th token </li>
<li>Lines 15-30 define the token dependencies for token 5 </li>
<li>Lines 37-48 define the token dependencies for token 2 </li>
<li>Lines 55-57 define the second serial pipe </li>
<li>Lines 59-61 define the third serial pipe </li>
<li>Line 64 defines the pipeline taskflow graph using composition </li>
<li>Line 67 executes the taskflow</li>
</ul>
<p>The following is one of the possible outcomes of the example.</p>
<div class="fragment"><div class="line">stage 1: Non-deferred token 0</div>
<div class="line">stage 2: input token 0 (deferrals=0)</div>
<div class="line">stage 3: input token 0</div>
<div class="line">stage 1: Non-deferred token 1</div>
<div class="line">stage 2: input token 1 (deferrals=0)</div>
<div class="line">stage 3: input token 1</div>
<div class="line">1st-time: Token 2 is deferred by 8</div>
<div class="line">stage 1: Non-deferred token 3</div>
<div class="line">stage 2: input token 3 (deferrals=0)</div>
<div class="line">stage 3: input token 3</div>
<div class="line">stage 1: Non-deferred token 4</div>
<div class="line">stage 2: input token 4 (deferrals=0)</div>
<div class="line">stage 3: input token 4</div>
<div class="line">1st-time: Token 5 is deferred by 2</div>
<div class="line">1st-time: Token 5 is deferred by 7</div>
<div class="line">stage 1: Non-deferred token 6</div>
<div class="line">stage 2: input token 6 (deferrals=0)</div>
<div class="line">stage 1: Non-deferred token 7</div>
<div class="line">stage 2: input token 7 (deferrals=0)</div>
<div class="line">stage 1: Non-deferred token 8</div>
<div class="line">stage 3: input token 6</div>
<div class="line">stage 3: input token 7</div>
<div class="line">stage 2: input token 8 (deferrals=0)</div>
<div class="line">stage 3: input token 8</div>
<div class="line">2nd-time: Token 8 resolved dependencies for token 2</div>
<div class="line">stage 2: input token 2 (deferrals=1)</div>
<div class="line">stage 3: input token 2</div>
<div class="line">2nd-time: Token 5 is deferred by 9</div>
<div class="line">stage 1: Non-deferred token 9</div>
<div class="line">stage 2: input token 9 (deferrals=0)</div>
<div class="line">stage 3: input token 9</div>
<div class="line">3rd-time: Tokens 2, 7 and 9 resolved dependencies for token 5</div>
<div class="line">stage 2: input token 5 (deferrals=2)</div>
<div class="line">stage 3: input token 5</div>
<div class="line">stage 1: Non-deferred token 10</div>
<div class="line">stage 2: input token 10 (deferrals=0)</div>
<div class="line">stage 3: input token 10</div>
</div><!-- fragment --><dl class="section attention"><dt>注意</dt><dd>You can only specify the token dependencies at the first pipe to get the serial execution of tokens.</dd></dl>
<h1><a class="anchor" id="CreateADeferredScalablePipelineModuleTask"></a>
Create a Deferred Scalable Pipeline Module Task</h1>
<p>In addition to task-parallel pipeline (<a class="el" href="classtf_1_1_pipeline.html" title="class to create a pipeline scheduling framework">tf::Pipeline</a>), you can specify token dependencies on top of a task-parallel scalable pipeline (<a class="el" href="classtf_1_1_scalable_pipeline.html" title="class to create a scalable pipeline object">tf::ScalablePipeline</a>). We recommend reading <a class="el" href="_task_parallel_scalable_pipeline.html">Task-parallel Scalable Pipeline</a> first before learning this interface.</p>
<p>To create a deferred scalable pipeline application, there are four steps, which are identical to the steps described in <a class="el" href="#CreateADeferredPipelineModuleTask">Create a Deferred Pipeline Module Task</a>. They are:</p>
<ol type="1">
<li>Define the pipeline structure (e.g., pipe type, pipe callable, stopping rule, line count)</li>
<li>Define the token dependencies <b>at the first pipe</b></li>
<li>Define the data storage and layout, if needed for the application</li>
<li>Define the pipeline taskflow graph using composition</li>
</ol>
<p>The following code creates a deferred scalable pipeline that uses four parallel lines to schedule tokens through two serial pipes in the given vector, then resetting that pipeline to three serial pipes. The three pipe callables are identical to the pipe callables demonstrated in the code snippet in <a class="el" href="#CreateADeferredPipelineModuleTask">Create a Deferred Pipeline Module Task</a>. The token dependencies are exemplified in <a class="el" href="#DeferredPipelineTokenDependencies">Understand Token Dependencies</a>.</p>
<div class="fragment"><div class="line"> 1: <span class="comment">// create a vector of three pipes</span></div>
<div class="line"> 2: std::vector&lt; <a class="code hl_class" href="classtf_1_1_pipe.html">tf::Pipe</a>&lt;std::function&lt;<a class="code hl_variable" href="ittnotify__static_8h.html#a61af67d9d838a9497ca5b188dabc1aa0">void</a>(<a class="code hl_class" href="classtf_1_1_pipeflow.html">tf::Pipeflow</a>&amp;)&gt;&gt; &gt; pipes;</div>
<div class="line"> 3: </div>
<div class="line"> 4: <span class="comment">// define pipe callables</span></div>
<div class="line"> 5: <span class="comment">// first_pipe_callable is same as lines 15-53 in the above code snippet </span></div>
<div class="line"> 6: <span class="keyword">auto</span> first_pipe_callable = [](<a class="code hl_class" href="classtf_1_1_pipeflow.html">tf::Pipeflow</a>&amp; pf) {</div>
<div class="line"> 7:   <span class="comment">// stop at 11 scheduling tokens</span></div>
<div class="line"> 8:   <span class="keywordflow">if</span>(pf.token() == 11) {</div>
<div class="line"> 9:     pf.stop();</div>
<div class="line">10:   }</div>
<div class="line">11:   <span class="keywordflow">else</span> {</div>
<div class="line">12:     <span class="comment">// Token 5 is deferred</span></div>
<div class="line">13:     <span class="keywordflow">if</span> (pf.token() == 5) {</div>
<div class="line">14:       <span class="keywordflow">switch</span>(pf.num_deferrals()) {</div>
<div class="line">15:        <span class="keywordflow">case</span> 0:</div>
<div class="line">16:          pf.defer(2);</div>
<div class="line">17:          <a class="code hl_function" href="printf_8h.html#aee3ed3a831f25f07e7be3919fff2203a">printf</a>(<span class="stringliteral">&quot;1st-time: Token %zu is deferred by 2\n&quot;</span>, pf.token());</div>
<div class="line">18:          pf.defer(7);</div>
<div class="line">19:          <a class="code hl_function" href="printf_8h.html#aee3ed3a831f25f07e7be3919fff2203a">printf</a>(<span class="stringliteral">&quot;1st-time: Token %zu is deferred by 7\n&quot;</span>, pf.token());</div>
<div class="line">20:          <span class="keywordflow">return</span>;  </div>
<div class="line">21:        <span class="keywordflow">break</span>;</div>
<div class="line">22:</div>
<div class="line">23:        <span class="keywordflow">case</span> 1:</div>
<div class="line">24:          pf.defer(9);</div>
<div class="line">25:          <a class="code hl_function" href="printf_8h.html#aee3ed3a831f25f07e7be3919fff2203a">printf</a>(<span class="stringliteral">&quot;2nd-time: Token %zu is deferred by 9\n&quot;</span>, pf.token());</div>
<div class="line">26:          <span class="keywordflow">return</span>;</div>
<div class="line">27:        <span class="keywordflow">break</span>;</div>
<div class="line">28:</div>
<div class="line">29:        <span class="keywordflow">case</span> 2:</div>
<div class="line">30:          <a class="code hl_function" href="printf_8h.html#aee3ed3a831f25f07e7be3919fff2203a">printf</a>(<span class="stringliteral">&quot;3rd-time: Tokens 2, 7 and 9 resolved dependencies for token %zu\n&quot;</span>,</div>
<div class="line">                    pf.token());</div>
<div class="line">31:        <span class="keywordflow">break</span>;</div>
<div class="line">32:      }</div>
<div class="line">33:    }</div>
<div class="line">34:    <span class="comment">// token 2 is deferred</span></div>
<div class="line">35:    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pf.token() == 2) {</div>
<div class="line">36:      <span class="keywordflow">switch</span>(pf.num_deferrals()) {</div>
<div class="line">37:        <span class="keywordflow">case</span> 0:</div>
<div class="line">38:          pf.defer(8);</div>
<div class="line">39:          <a class="code hl_function" href="printf_8h.html#aee3ed3a831f25f07e7be3919fff2203a">printf</a>(<span class="stringliteral">&quot;1st-time: Token %zu is deferred by 8\n&quot;</span>, pf.token());</div>
<div class="line">40:        <span class="keywordflow">break</span>;</div>
<div class="line">41:        <span class="keywordflow">case</span> 1:</div>
<div class="line">42:          <a class="code hl_function" href="printf_8h.html#aee3ed3a831f25f07e7be3919fff2203a">printf</a>(<span class="stringliteral">&quot;2nd-time: Token 8 resolved dependencies for token %zu\n&quot;</span>,</div>
<div class="line">                    pf.token());</div>
<div class="line">43:        <span class="keywordflow">break</span>;</div>
<div class="line">44:      }</div>
<div class="line">45:    }</div>
<div class="line">46:    <span class="keywordflow">else</span> {</div>
<div class="line">47:      <a class="code hl_function" href="printf_8h.html#aee3ed3a831f25f07e7be3919fff2203a">printf</a>(<span class="stringliteral">&quot;stage 1: Non-deferred token %zu\n&quot;</span>, pf.token());</div>
<div class="line">48:    }</div>
<div class="line">49: };</div>
<div class="line">50:</div>
<div class="line">51: <span class="comment">// second_pipe_callable is same as lines 55-57 in the above code snippet</span></div>
<div class="line">52: <span class="keyword">auto</span> second_pipe_callable = [](tf::Pipeflow&amp; pf){</div>
<div class="line">53:   <a class="code hl_function" href="printf_8h.html#aee3ed3a831f25f07e7be3919fff2203a">printf</a>(<span class="stringliteral">&quot;stage 2: input token %zu (deferrals=%zu)\n&quot;</span>,</div>
<div class="line">              pf.token(), pf.num_deferrals());</div>
<div class="line">54: };</div>
<div class="line">55:</div>
<div class="line">56: <span class="comment">// third_pipe_callable is same as lines 59-61 in the above code snippet</span></div>
<div class="line">57: <span class="keyword">auto</span> third_pipe_callable = [](tf::Pipeflow&amp; pf){</div>
<div class="line">58:   <a class="code hl_function" href="printf_8h.html#aee3ed3a831f25f07e7be3919fff2203a">printf</a>(<span class="stringliteral">&quot;stage 3: input token %zu\n&quot;</span>, pf.token());</div>
<div class="line">59: };</div>
<div class="line">60:</div>
<div class="line">61: pipes.emplace_back(<a class="code hl_enumvalue" href="namespacetf.html#abb7a11e41fd457f69e7ff45d4c769564a7b804a28d6154ab8007287532037f1d0">tf::PipeType::SERIAL</a>, first_pipe_callable);</div>
<div class="line">62: pipes.emplace_back(<a class="code hl_enumvalue" href="namespacetf.html#abb7a11e41fd457f69e7ff45d4c769564a7b804a28d6154ab8007287532037f1d0">tf::PipeType::SERIAL</a>, second_pipe_callable); </div>
<div class="line">63:</div>
<div class="line">64: <span class="comment">// create a pipeline of four parallel lines based on the given vector of pipes</span></div>
<div class="line">65: tf::ScalablePipeline pl(4, pipes.begin(), pipes.end());</div>
<div class="line">66:</div>
<div class="line">67: tf::Task <a class="code hl_define" href="test__partitioner__whitebox_8h.html#a5c4cf3d37a4eee22275de22cb9619863">task</a> = <a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>.composed_of(pl);</div>
<div class="line">68: </div>
<div class="line">69: <span class="comment">// run the pipeline</span></div>
<div class="line">70: <a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.<a class="code hl_function" href="classtf_1_1_executor.html#a519777f5783981d534e9e53b99712069">run</a>(<a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>).wait();</div>
<div class="line">71:</div>
<div class="line">72: <span class="comment">// reset the pipeline to a new range of three pipes and starts from</span></div>
<div class="line">73: <span class="comment">// the initial state (i.e., token counts from zero)</span></div>
<div class="line">74: pipes.emplace_back(<a class="code hl_enumvalue" href="namespacetf.html#abb7a11e41fd457f69e7ff45d4c769564a7b804a28d6154ab8007287532037f1d0">tf::PipeType::SERIAL</a>, third_pipe_callable);</div>
<div class="line">75: pl.reset(pipes.begin(), pipes.end());</div>
<div class="line">76:</div>
<div class="line">77: <a class="code hl_variable" href="thread__pool_8cpp.html#a543e564a8407bbeac15cb2d929fec755">executor</a>.<a class="code hl_function" href="classtf_1_1_executor.html#a519777f5783981d534e9e53b99712069">run</a>(<a class="code hl_function" href="poisson_8hpp.html#aa56fe360bb0ae38e0082f49e394ff825">taskflow</a>).wait();</div>
<div class="ttc" id="aittnotify__static_8h_html_a61af67d9d838a9497ca5b188dabc1aa0"><div class="ttname"><a href="ittnotify__static_8h.html#a61af67d9d838a9497ca5b188dabc1aa0">void</a></div><div class="ttdeci">void</div><div class="ttdef"><b>定义</b> ittnotify_static.h:91</div></div>
</div><!-- fragment --><p>Debrief:</p>
<ul>
<li>Lines 2 defines the vector of <a class="el" href="classtf_1_1_pipe.html" title="class to create a pipe object for a pipeline stage">tf::Pipe</a> type </li>
<li>Lines 6-49 define the first pipe callable </li>
<li>Lines 52-54 define the second pipe callable </li>
<li>Lines 57-59 define the third pipe callable </li>
<li>Lines 61-62 define the vector of two pipe callables </li>
<li>Line 65 defines the scalable pipeline </li>
<li>Line 67 defines the pipeline taskflow graph using composition </li>
<li>Line 70 executes the taskflow for the first run </li>
<li>Line 74 inserts the third pipe callable in the vector </li>
<li>Line 75 resets the pipes to three pipe callables </li>
<li>Line 77 executes the taskflow for the second run</li>
</ul>
<h1><a class="anchor" id="ParalleliDeferredScalablePipelineLearnMore"></a>
Learn More about Taskflow Pipeline</h1>
<p>Visit the following pages to learn more about pipeline:</p>
<ul>
<li><a class="el" href="_task_parallel_pipeline.html">Task-parallel Pipeline</a></li>
<li><a class="el" href="_data_parallel_pipeline.html">Data-parallel Pipeline</a></li>
<li><a class="el" href="_task_parallel_scalable_pipeline.html">Task-parallel Scalable Pipeline</a></li>
<li><a class="el" href="_text_processing_pipeline.html">Text Processing Pipeline</a></li>
<li><a class="el" href="_graph_processing_pipeline.html">Graph Processing Pipeline</a></li>
<li><a class="el" href="_taskflow_processing_pipeline.html">Taskflow Processing Pipeline</a> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">制作者 <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
